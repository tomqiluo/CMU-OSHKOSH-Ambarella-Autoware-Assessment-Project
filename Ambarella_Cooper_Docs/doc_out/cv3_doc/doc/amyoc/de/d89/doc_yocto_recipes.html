<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Build System: Yocto Recipe</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Build System"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Build System<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/d89/doc_yocto_recipes.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Yocto Recipe </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="doc_yocto_rec_sec_class"></a>
1. Class Files</h1>
<p >Environment variables can be defined in the class file <code>meta-xxx/classes/xxx.bbclass</code> and inherited by the package recipe file (inherit xxx); for example, <code>ambaenv.bbclass</code>. </p><div class="fragment"><div class="line">export ENV_TOP_DIR</div>
<div class="line">export CONF_PATH = <span class="stringliteral">&quot;${STAGING_BINDIR_NATIVE}&quot;</span></div>
<div class="line">export OUT_PATH = <span class="stringliteral">&quot;${WORKDIR}/build&quot;</span></div>
<div class="line">export ENV_INS_ROOT = <span class="stringliteral">&quot;${WORKDIR}/image&quot;</span></div>
<div class="line">export ENV_DEP_ROOT = <span class="stringliteral">&quot;${WORKDIR}/recipe-sysroot&quot;</span></div>
<div class="line">export ENV_CFG_ROOT = <span class="stringliteral">&quot;${TOPDIR}/config&quot;</span></div>
<div class="line">export ENV_BUILD_MODE</div>
<div class="line"> </div>
<div class="line">export AMBA_BOARD</div>
<div class="line">export AMBA_SOC</div>
<div class="line">export AMBA_CPU_ARCH</div>
<div class="line">export AMBA_DSP_ARCH</div>
<div class="line">export AMBA_CAVALRY_ARCH</div>
</div><!-- fragment --><p >Some common functions and tasks can also be placed in class files, such as <code>kconfig.bbclass</code>. </p><div class="fragment"><div class="line">inherit terminal</div>
<div class="line"> </div>
<div class="line">KCONFIG_CONFIG_COMMAND ??= <span class="stringliteral">&quot;menuconfig&quot;</span></div>
<div class="line">KCONFIG_CONFIG_PATH ??= <span class="stringliteral">&quot;${B}/.config&quot;</span></div>
<div class="line"> </div>
<div class="line">python do_setrecompile () {</div>
<div class="line">    <span class="keywordflow">if</span> hasattr(bb.build, <span class="stringliteral">&#39;write_taint&#39;</span>):</div>
<div class="line">        bb.build.write_taint(<span class="stringliteral">&#39;do_compile&#39;</span>, d)</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_setrecompile[nostamp] = <span class="stringliteral">&quot;1&quot;</span></div>
<div class="line">addtask setrecompile</div>
<div class="line"> </div>
<div class="line">python do_menuconfig() {</div>
<div class="line">    config = d.getVar(<span class="stringliteral">&#39;KCONFIG_CONFIG_PATH&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span>:</div>
<div class="line">        mtime = os.path.getmtime(config)</div>
<div class="line">    except OSError:</div>
<div class="line">        mtime = 0</div>
<div class="line"> </div>
<div class="line">    oe_terminal(<span class="stringliteral">&quot;sh -c \&quot;make %s; if [ \\$? -ne 0 ]; then echo &#39;Command failed.&#39;; printf &#39;Press any key to continue... &#39;; read r; fi\&quot;&quot;</span> % d.getVar(<span class="stringliteral">&#39;KCONFIG_CONFIG_COMMAND&#39;</span>),</div>
<div class="line">        d.getVar(<span class="stringliteral">&#39;PN&#39;</span>) + <span class="stringliteral">&#39; Configuration&#39;</span>, d)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> hasattr(bb.build, <span class="stringliteral">&#39;write_taint&#39;</span>):</div>
<div class="line">        try:</div>
<div class="line">            newmtime = os.path.getmtime(config)</div>
<div class="line">        except OSError:</div>
<div class="line">            newmtime = 0</div>
<div class="line"> </div>
<div class="line">        if newmtime != mtime:</div>
<div class="line">            bb.build.write_taint(<span class="stringliteral">&#39;do_compile&#39;</span>, d)</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_menuconfig[depends] += <span class="stringliteral">&quot;kconfig-native:do_populate_sysroot&quot;</span></div>
<div class="line">do_menuconfig[nostamp] = <span class="stringliteral">&quot;1&quot;</span></div>
<div class="line">do_menuconfig[dirs] = <span class="stringliteral">&quot;${B}&quot;</span></div>
<div class="line">addtask menuconfig after do_configure</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>If the <b>do_setrecompile</b> function is not used, the target package will not be recompiled after modifying the configuration file.</dd></dl>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_recipes"></a>
2. Recipe Files</h1>
<p >Create a basic recipe: <b>recipetool create -o &lt;xxx.bb&gt; &lt;package_src_dir&gt;</b>. The content that the user must add manually is shown below.</p>
<h2><a class="anchor" id="sub_yocto_rec_pa"></a>
2.1 Add Package Dependencies</h2>
<p >If a package depends on other packages, add <b>DEPENDS</b> to the recipes. For example, <b>DEPENDS += "package1 package2"</b></p>
<p >If a package links other packages (<b>LDFLAGS += -lname1 -lname2</b>), add <b>RDEPENDS</b> to the recipes. For example, <b>RDEPENDS:${PN} += "package1 package2"</b></p>
<h2><a class="anchor" id="sub_yocto_rec_in"></a>
2.2 Add Inherited Classes</h2>
<p >The following table lists the main inherited classes and their functions. </p><a class="anchor" id="yocto_recipe_class"></a>
<table class="doxtable">
<caption>Table 2-1. Inherited Classes.</caption>
<tr>
<th>Inherited classes </th><th>Function </th></tr>
<tr>
<td>inherit ambaenv </td><td>Use Ambarella environment variables </td></tr>
<tr>
<td>inherit kconfig </td><td>Use menuconfig </td></tr>
<tr>
<td>inherit sanity </td><td>Compile the application with Makefile </td></tr>
<tr>
<td>inherit cmake </td><td>Compile the application with cmake </td></tr>
<tr>
<td>inherit module </td><td>Compile external kernel module </td></tr>
<tr>
<td>inherit native </td><td>Compile host native tool </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>If menuconfig is compiled by <code>make -f wrapper.mk menuconfig</code>, users are required to set <b>KCONFIG_CONFIG_COMMAND = "-f wrapper.mk menuconfig"</b> in the recipes.</li>
<li>If the directory where .config is stored is also the output directory of the Yocto Build, users are required to set <b>KCONFIG_CONFIG_PATH = "${OUT_PATH}/.config"</b> in the recipes.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sub_yocto_rec_and"></a>
2.3 Installation and Packaging</h2>
<p >Variables set for packaging:</p><ul>
<li><b>FILES:${PN} = "${base_libdir} ${libdir} ${bindir} ${datadir}"</b>: specifies the list of directories or files that are required to be included in the release package</li>
<li><b>FILES:${PN}-dev = "${includedir}"</b>: specifies the list of directories or files that must be included in the development package; for example, header files and static libraries</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><code>includedir</code> points to <code>xxx/usr/include</code> and <code>base_libdir</code> points to <code>xxx/lib</code>. For more information about the Yocto directory, refer to <code>meta/conf/bitbake.conf</code> in the poky project.<br  />
 It may be necessary to specify properly which files to package rather than which directories, in order to avoid overlap between packages (for example, attaching recipes from official packages).</dd></dl>
<p>Inherit sanity or inherit cmake:</p><ul>
<li>When using "inherit sanity" or "inherit cmake", users must appropriately specify the package directory. Otherwise, the do_package task will result in an error</li>
</ul>
<p >Inherit module:</p><ul>
<li>When using the inherit module, users are not required to to set the package directory of header and module files. If users install other files, they should specify the package path of other files</li>
</ul>
<p >Ignore certain warnings and errors:</p><ul>
<li><b>ALLOW_EMPTY:${PN} = "1"</b>：ignore "do_rootfs" errors caused by package installation files that are empty, or are only header files</li>
<li><b>INSANE_SKIP:${PN} += "dev-so"</b>: ignore the error that the installed file is only a symbolic link</li>
<li>For more information, refer to <a href="https://docs.yoctoproject.org/ref-manual/classes.html?highlight=sanity#insane-bbclass">https://docs.yoctoproject.org/ref-manual/classes.html?highlight=sanity#insane-bbclass</a></li>
</ul>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;LGPL-2.0-or-later&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># No information for SRC_URI yet (only an external source tree was specified)</span></div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;package1 package2&quot;</span></div>
<div class="line">RDEPENDS:${PN} += <span class="stringliteral">&quot;package1 package2&quot;</span></div>
<div class="line"> </div>
<div class="line">inherit ambaenv</div>
<div class="line"><span class="preprocessor">#KCONFIG_CONFIG_COMMAND = &quot;-f wrapper.mk menuconfig&quot;</span></div>
<div class="line"><span class="preprocessor">#KCONFIG_CONFIG_PATH = &quot;${OUT_PATH}/.config&quot;</span></div>
<div class="line"><span class="preprocessor">#inherit kconfig</span></div>
<div class="line">inherit sanity</div>
<div class="line"><span class="preprocessor">#inherit cmake</span></div>
<div class="line"><span class="preprocessor">#inherit module</span></div>
<div class="line"><span class="preprocessor">#inherit native</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># NOTE: this is a Makefile-only piece of software, so we cannot generate much of the</span></div>
<div class="line"><span class="preprocessor"># recipe automatically - you will need to examine the Makefile yourself and ensure</span></div>
<div class="line"><span class="preprocessor"># that the appropriate arguments are passed in.</span></div>
<div class="line"> </div>
<div class="line">do_configure () {</div>
<div class="line"><span class="preprocessor"> # Specify any needed configure commands here</span></div>
<div class="line"> :</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_compile () {</div>
<div class="line"><span class="preprocessor"> # You will almost certainly need to add additional arguments here</span></div>
<div class="line"> oe_runmake</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_install () {</div>
<div class="line"><span class="preprocessor"> # NOTE: unable to determine what to put here - there is a Makefile but no</span></div>
<div class="line"><span class="preprocessor"> # target named &quot;install&quot;</span>, so you will need to define this yourself</div>
<div class="line"> oe_runmake install</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">ALLOW_EMPTY:${PN} = <span class="stringliteral">&quot;1&quot;</span></div>
<div class="line">INSANE_SKIP:${PN} += <span class="stringliteral">&quot;dev-so&quot;</span></div>
<div class="line">FILES:${PN}-dev = <span class="stringliteral">&quot;${includedir}&quot;</span></div>
<div class="line">FILES:${PN} = <span class="stringliteral">&quot;${base_libdir} ${libdir} ${bindir} ${datadir}&quot;</span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Starting from version 3.4, the override style syntax for variables has changed from underline(_) to colon(:). <a href="https://docs.yoctoproject.org/migration-guides/migration-3.4.html#override-syntax-changes">https://docs.yoctoproject.org/migration-guides/migration-3.4.html#override-syntax-changes</a></dd></dl>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_append"></a>
3. Recipe Append Files</h1>
<p >The main role of the recipe append files is to indicate the package source code directory and the Makefile directory, which are usually the same.</p>
<p ><b>EXTERNALSRC</b>: the package source code directory. The YOCTO build system checks this directory to see if it must be recompiled.</p><ul>
<li>If only part of the source code exists in the <code>EXTERNALSRC</code> directory, then users must append files or directories for verification and append the <b>file-checksums</b> flag of the task; otherwise, the source code will not be recompiled after modification</li>
<li>Users can inherit the class <code>extrasrc.bbclass</code> to perform the appending<ul>
<li><code>EXTRASRC_CONFIGURE</code>: appends the file or directory for the do_configure task</li>
<li><code>EXTRASRC_COMPILE</code>: appends the file or directory that performs the do_compile task</li>
<li><code>EXTRASRC_INSTALL</code>: appends the file or directory that performs the do_install task</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">python () {</div>
<div class="line">    tasks = [<span class="stringliteral">&#39;configure&#39;</span>, <span class="stringliteral">&#39;compile&#39;</span>, <span class="stringliteral">&#39;install&#39;</span>]</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> task in tasks:</div>
<div class="line">        task_name = <span class="stringliteral">&#39;do_%s&#39;</span> % (task)</div>
<div class="line">        src_name = <span class="stringliteral">&#39;EXTRASRC_%s&#39;</span> % (task.upper())</div>
<div class="line">        src_str = d.getVar(src_name)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> src_str:</div>
<div class="line">            srcs = src_str.split()</div>
<div class="line">            <span class="keywordflow">for</span> src in srcs:</div>
<div class="line">                <span class="keywordflow">if</span> os.path.exists(src):</div>
<div class="line">                    <span class="keywordflow">if</span> os.path.isdir(src):</div>
<div class="line">                        d.appendVarFlag(task_name, <span class="stringliteral">&#39;file-checksums&#39;</span>, <span class="stringliteral">&#39; %s/*:True&#39;</span> % (src))</div>
<div class="line">                    <span class="keywordflow">else</span>:</div>
<div class="line">                        d.appendVarFlag(task_name, <span class="stringliteral">&#39;file-checksums&#39;</span>, <span class="stringliteral">&#39; %s:True&#39;</span> % (src))</div>
<div class="line">                    #bb.warn(<span class="stringliteral">&#39;%s is appended in %s of %s\n&#39;</span> % (d.getVarFlag(task_name, <span class="stringliteral">&#39;file-checksums&#39;</span>), task_name, d.getVar(<span class="stringliteral">&#39;PN&#39;</span>)))</div>
<div class="line">                <span class="keywordflow">else</span>:</div>
<div class="line">                    bb.warn(<span class="stringliteral">&#39;%s is not existed in %s of %s\n&#39;</span> % (src, task_name, d.getVar(<span class="stringliteral">&#39;PN&#39;</span>)))</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li><p class="startli">For example, append recipes (<code>ambarella/metadata/meta-ambalib/recipes-video/libiav-efm/libiav-efm.bbappend</code>) </p><div class="fragment"><div class="line">inherit externalsrc</div>
<div class="line">EXTERNALSRC = <span class="stringliteral">&quot;${ENV_TOP_DIR}/packages/iav_utils/dsp_${AMBA_DSP_ARCH}/efm&quot;</span></div>
<div class="line">EXTERNALSRC_BUILD = <span class="stringliteral">&quot;${ENV_TOP_DIR}/packages/iav_utils/dsp_${AMBA_DSP_ARCH}/efm&quot;</span></div>
<div class="line"> </div>
<div class="line">EXTRASRC_COMPILE := <span class="stringliteral">&quot;${EXTERNALSRC}/../util&quot;</span></div>
<div class="line">inherit extrasrc</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>In the append recipe file, <b>inherit extrasrc</b> must be placed after <b>inherit externalsrc</b> because the <code>externalsrc class</code> overrides <b>file-checksums</b>.</dd></dl>
<p><b>EXTERNALSRC_BUILD</b>: <code>EXTERNALSRC_BUILD</code> specifies the directory where the make command runs, which may be different from <code>EXTERNALSRC</code>.</p>
</li>
</ul>
<div class="fragment"><div class="line">inherit externalsrc</div>
<div class="line">EXTERNALSRC = <span class="stringliteral">&quot;${ENV_TOP_DIR}/&lt;package_src&gt;&quot;</span></div>
<div class="line">EXTERNALSRC_BUILD = <span class="stringliteral">&quot;${ENV_TOP_DIR}/&lt;make_path&gt;&quot;</span></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_patch"></a>
4. Patch Hotfix</h1>
<h2><a class="anchor" id="sub_amyoc_hot_off"></a>
4.1 Typical Method of Yocto Patching</h2>
<h2><a class="anchor" id="autotoc_md0"></a>
Method</h2>
<ul>
<li>Create a new folder named <code>recipe name</code> or <code>files</code> in the current directory of the recipe file and place the patch in this folder <dl class="section note"><dt>Note</dt><dd>There are more file folders than those listed above used for patch searching, but Ambarella commonly uses a folder named <code>recipe name</code>.</dd></dl>
</li>
<li>The recipe simply adds the patch filename declaration without adding the folder path <code>SRC_URI += "file://0001-xxx.patch"</code></li>
<li>If the recipe inherits from the externalsrc class, users must also set <code>RCTREECOVEREDTASKS = "do_unpack do_fetch"</code> <dl class="section note"><dt>Note</dt><dd>The externalsrc class removes the <b>do_patch task</b> by default, so users must set <b>RCTREECOVEREDTASKS</b>.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md1"></a>
Advantages</h2>
<ul>
<li>Easy to implement</li>
</ul>
<h2><a class="anchor" id="autotoc_md2"></a>
Disadvantages</h2>
<ul>
<li>There is no way to determine if the patch is effective</li>
<li>By default, patching is performed only once. If the patch is removed in some special way, the patch will not be applied after recompilation</li>
<li>This patching method generates a temporary folder in the source directory and applies the patch directly to source code, such as through the generation of <code>.pc/</code> or <code>patches/</code></li>
</ul>
<h2><a class="anchor" id="sub_amyoc_hot_cus"></a>
4.2 Customized Patching Method</h2>
<h2><a class="anchor" id="autotoc_md3"></a>
Method</h2>
<ul>
<li>Create two packages per patch: a patching package and a depatching package. The recipe names must be in the format of <code>xxx-patch-xxx</code> and <code>xxx-unpatch-xxx</code></li>
<li>The source package weakly depends on these two packages; add <b>EXTRADEPS = "xxx-patch-xxx|xxx-unpatch-xxx"</b> and <b>inherit weakdep</b></li>
<li>Create a virtual dependency rule <b>#VDEPS(choice) xxx-patch-xxx-choice(xxx-unpatch-xxx xxx-patch-xxx):</b></li>
<li>Patch packages write recipes according to the normal rules. Note that the recipes depend on the patch host toolkit and inherit the patch status check class <b>inherit externalpatch</b> <dl class="section note"><dt>Note</dt><dd>The role of the externalpatch class is to verify that the patch is applied, and thus decide whether or not to patch or force depatch.</dd></dl>
<div class="fragment"><div class="line">EXTERNALPATCH_SRC = <span class="stringliteral">&quot;patch filename with path&quot;</span></div>
<div class="line">EXTERNALPATCH_DST = <span class="stringliteral">&quot;patchtarget code directory&quot;</span></div>
<div class="line">EXTERNALPATCH_OPT = <span class="stringliteral">&quot;patch or unpatch&quot;</span></div>
<div class="line">inherit externalpatch</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Advantages</h2>
<ul>
<li>Supports both patching and un-patching</li>
<li>Patching and un-patching are guaranteed to function correctly, regardless of where the patching / un-patching is performed</li>
<li>Only the corresponding patch files are modified in the source directory; no additional temporary files or folders are generated</li>
<li>Patch files can be placed in any directory, and can also share a Makefile with other compilation methods</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Disadvantages</h2>
<ul>
<li>Slightly complicated to implement</li>
<li>Because the recipe is dynamically modified, it must be re-compiled twice when the patch option is changed</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Example</h2>
<ul>
<li>Reference Linux patching <code>ambarella/metadata/meta-ambabsp/recipes-kernel/linux-patch</code> and <code>ambarella/kernel/linux-patch</code>.</li>
</ul>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_example"></a>
5. Examples of Recipe Files</h1>
<h2><a class="anchor" id="append_rec_exa_1"></a>
Example 1. Build library</h2>
<p ><code>ambarella/metadata/meta-ambalib/recipes-video/libmcl/libmcl.bb</code></p>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;LGPL-2.0-or-later&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;ambvideo-header&quot;</span>          # dependencies</div>
<div class="line">EXTRADEPS = <span class="stringliteral">&quot;liblua||prebuild-liblua&quot;</span> # Ambarella extensions, two weak dependencies must be selected</div>
<div class="line"> </div>
<div class="line">inherit ambaenv # Ambarella environment variable</div>
<div class="line">inherit weakdep # Use weak dependencies to set DEPENDS and RDEPENDS by analyzing whether the .config is <a class="code hl_variableRef" target="_blank" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a></div>
<div class="line">inherit sanity # Inherit <span class="keyword">this</span> <span class="keyword">class </span>using the Makefile compilation lib</div>
<div class="line"> </div>
<div class="line">do_configure () {</div>
<div class="line">    :                                   # configure command, doesn<span class="stringliteral">&#39;t manage configuration itself so it&#39;</span>s an empty command</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_compile () {</div>
<div class="line">    oe_runmake -f amba.mk               # Compile, oe_runmake is equivalent to make</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_install () {</div>
<div class="line">    oe_runmake -f amba.mk install      # install</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">INSANE_SKIP:${PN} += <span class="stringliteral">&quot;dev-so&quot;</span>       # Ignore symbolic link errors</div>
<div class="line">FILES:${PN}-dev = <span class="stringliteral">&quot;${includedir}&quot;</span>   # Development <span class="keyword">package </span>packaged files</div>
<div class="line">FILES:${PN} = &quot;${libdir}&quot; # Files packaged by the release package</div>
<div class="ttc" id="agroup__IAV_html_ga11e444dd61d48abbdd34eed23186cb4b"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a></div><div class="ttdeci">u32 y</div></div>
</div><!-- fragment --><h2><a class="anchor" id="append_rec_exa_2"></a>
Example 2. Build application</h2>
<p ><code>ambarella/metadata/meta-ambaapp/recipes-test/iav-test/iav-test.bb</code></p>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;AMBARELLA-3-Clause&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;file://LICENSE-AMBARELLA-3-Clause;md5=ae926a6983bc3425ac85f7ad9379b793&quot;</span></div>
<div class="line">NO_GENERIC_LICENSE[AMBARELLA-3-Clause] = <span class="stringliteral">&quot;LICENSE-AMBARELLA-3-Clause&quot;</span></div>
<div class="line"> </div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;ambvideo-header libmcl libiav-pm libiav-blur libiav-efm libdatatx&quot;</span></div>
<div class="line">RDEPENDS:${PN} += <span class="stringliteral">&quot;libmcl libiav-pm libiav-blur libiav-efm&quot;</span>    # with dynamic library dependencies</div>
<div class="line">EXTRADEPS = <span class="stringliteral">&quot;liblua||prebuild-liblua ? ? libtextinsert&quot;</span>        # Special dependencies <span class="keywordflow">for</span> Ambarella extensions</div>
<div class="line"> </div>
<div class="line">inherit ambaenv                                                # Ambarella environment variables</div>
<div class="line">inherit weakdep                                                # Use weak dependency inheritance to set DEPENDS and RDEPENDS by analyzing whether the .config is <a class="code hl_variableRef" target="_blank" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a></div>
<div class="line">inherit sanity                                                 # use Makefile to compile the app to inherit <span class="keyword">this</span> <span class="keyword">class</span></div>
<div class="line"> </div>
<div class="line">do_configure () {</div>
<div class="line">    :</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_compile () {</div>
<div class="line">    oe_runmake -f amba.mk</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_install () {</div>
<div class="line">    oe_runmake -f amba.mk install</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">FILES:${PN} += <span class="stringliteral">&quot;${bindir} ${datadir}&quot;</span></div>
</div><!-- fragment --><h2><a class="anchor" id="append_rec_exa_3"></a>
Example 3. Install prebuild libraries</h2>
<p ><code>ambarella/metadata/meta-ambalib/recipes-prebuild/prebuild-dewarp/prebuild-dewarp.bb</code></p>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;AMBARELLA-2-Clause&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;file://LICENSE-AMBARELLA-2-Clause;md5=5bc624162af1ddf55df69fe0c4552811&quot;</span></div>
<div class="line">NO_GENERIC_LICENSE[AMBARELLA-2-Clause] = <span class="stringliteral">&quot;LICENSE-AMBARELLA-2-Clause&quot;</span></div>
<div class="line"> </div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;libutils libdewarp-lua&quot;</span></div>
<div class="line">RDEPENDS:${PN} += <span class="stringliteral">&quot;libutils libdewarp-lua&quot;</span></div>
<div class="line"> </div>
<div class="line">inherit ambaenv</div>
<div class="line">inherit sanity</div>
<div class="line"> </div>
<div class="line">do_configure () {</div>
<div class="line"><span class="preprocessor">    # Specify any needed configure commands here</span></div>
<div class="line">    :</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_compile () {</div>
<div class="line">    oe_runmake -f amba.mk</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_install () {</div>
<div class="line">    oe_runmake -f amba.mk install</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">INSANE_SKIP:${PN} += <span class="stringliteral">&quot;dev-so already-stripped&quot;</span>  # already-stripped ,to ignore errors caused by dynamic libraries that have been strip</div>
<div class="line">FILES:${PN}-dev = <span class="stringliteral">&quot;${includedir}&quot;</span></div>
<div class="line">FILES:${PN} = <span class="stringliteral">&quot;${libdir}&quot;</span></div>
</div><!-- fragment --><h2><a class="anchor" id="append_rec_exa_4"></a>
Example 4. Compile cJSON by adding the wrapper for cmake</h2>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;LGPL-2.0-or-later&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;cmake-native&quot;</span>               # Yocto does not use the host<span class="stringliteral">&#39;s cmake utility, but relies on its own compiled cmake</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">inherit ambaenv</span></div>
<div class="line"><span class="stringliteral">inherit sanity</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">do_configure () {</span></div>
<div class="line"><span class="stringliteral">    :</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">do_compile () {</span></div>
<div class="line"><span class="stringliteral">    oe_runmake -f amba.mk</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">do_install () {</span></div>
<div class="line"><span class="stringliteral">    oe_runmake -f amba.mk install</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">INSANE_SKIP:${PN} += &quot;dev-so&quot;</span></div>
<div class="line"><span class="stringliteral">FILES:${PN}-dev = &quot;${includedir}&quot;</span></div>
<div class="line"><span class="stringliteral">FILES:${PN} = &quot;${libdir}&quot;</span></div>
</div><!-- fragment --><h2><a class="anchor" id="append_rec_exa_5"></a>
Example 5. Build kernel modules</h2>
<p ><code>ambarella/metadata/meta-ambabsp/recipes-sensor/kernel-module-imx274-mipi/kernel-module-imx274-mipi.bb</code></p>
<div class="fragment"><div class="line">LICENSE = <span class="stringliteral">&quot;GPL-2.0-or-later&quot;</span></div>
<div class="line">LIC_FILES_CHKSUM = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">SRC_URI = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">DEPENDS += <span class="stringliteral">&quot;kernel-module-ambvideo&quot;</span></div>
<div class="line">EXTRADEPS = <span class="stringliteral">&quot;unselect&quot;</span>                  # Special dependencies <span class="keywordflow">for</span> Ambarella extensions, unselect means <span class="keyword">this</span> <span class="keyword">package </span>is configured as `default n` in the script parsing Kconfig</div>
<div class="line">inherit ambaenv</div>
<div class="line">inherit module                          # Use Makefile to build the mod to inherit this class</div>
<div class="line"> </div>
<div class="line">do_configure () {</div>
<div class="line">    :</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_compile () {</div>
<div class="line">    oe_runmake -f amba.mk</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">do_install () {</div>
<div class="line">    oe_runmake -f amba.mk install</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="yocto_meta_layers"></a>
6. Yocto Meta Layers</h1>
<h2><a class="anchor" id="ambarella_meta_layers"></a>
6.1 Ambarella Meta Layers</h2>
<p >The following table lists all the Meta Layers provided by Ambarella. </p><a class="anchor" id="table_amba_meta_layers"></a>
<table class="doxtable">
<caption>Table 6-1. Amba Meta Layers.</caption>
<tr>
<th>Meta-Layers Location </th><th>Layer Name </th><th>More information </th></tr>
<tr>
<td rowspan="7">metadata </td><td>meta-ambabsp </td><td>boot, board, kernel, amba private drivers(video, sensors, VP...) </td></tr>
<tr>
<td>meta-ambalib </td><td>amba private libraries, middleware and amba tools(load_ucode, dsplog_cap) </td></tr>
<tr>
<td>meta-ambaapp </td><td>amba unit test apps, demo apps and debug tools </td></tr>
<tr>
<td>meta-ambasecurity </td><td>software packages and tools about security </td></tr>
<tr>
<td>meta-amrtos </td><td>software packages of AMRTOS supported by ambarella </td></tr>
<tr>
<td>meta-external </td><td>external software packages provided by other vendors </td></tr>
<tr>
<td>meta-thirdparty </td><td>OSS libraries &amp; tools and other 3rd-party prebuild libraries &amp; tools </td></tr>
</table>
<h2><a class="anchor" id="oss_meta_layers"></a>
6.2 OSS Meta Layers</h2>
<p >The following table lists all the OSS Meta Layers used in the SDK. </p><a class="anchor" id="table_oss_meta_layers"></a>
<table class="doxtable">
<caption>Table 6-2. Oss Meta Layers.</caption>
<tr>
<th>Meta-Layers Location </th><th>Layer Name </th><th>More information </th></tr>
<tr>
<td>build </td><td>poky </td><td><a href="https://git.yoctoproject.org/poky">https://git.yoctoproject.org/poky</a> </td></tr>
<tr>
<td rowspan="3">oss_yocto </td><td>meta-openembedded </td><td><a href="https://git.openembedded.org/meta-openembedded">https://git.openembedded.org/meta-openembedded</a> </td></tr>
<tr>
<td>meta-ros </td><td><a href="https://github.com/ros/meta-ros">https://github.com/ros/meta-ros</a> </td></tr>
<tr>
<td>meta-selinux </td><td><a href="https://github.com/ni/meta-selinux">https://github.com/ni/meta-selinux</a> </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>Amba won’t change/maintain the source code of Third-Party Meta Layers, but only sync the latest update periodically.</dd></dl>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_commerial_3rd_party"></a>
7. Commerial Third-Party Libraries</h1>
<p >The following table lists the commerial third-party libraries used by some Yocto Build software packages. If users have deep concern on the license of these libraries and do not use them in real products, they can directly remove the software packages and recipes of these libraries.</p>
<a class="anchor" id="commerial_3rd_party"></a>
<table class="doxtable">
<caption>Table 7-1. Commerial Third-Party Libraries.</caption>
<tr>
<th>Library </th><th>Software Packages that Depends </th></tr>
<tr>
<td>FFmpeg </td><td>gstreamer </td></tr>
<tr>
<td>x265 </td><td>TBD </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_sec_single_multi_sub"></a>
8. Single Package with Multiple Sub-Packages</h1>
<h2><a class="anchor" id="doc_yocto_sub_single_introduction"></a>
8.1 Introduction</h2>
<p >When using open source software (OSS) packages supported by the Yocto Community, there will be cases where a single OSS package contains multiple separated sub-packages.</p>
<p >The following table lists some common source packages and their sub-packages: </p><a class="anchor" id="package_mutil_sub_package"></a>
<table class="doxtable">
<caption>Table 8-1. Single Package with Multiple Sub-Packages.</caption>
<tr>
<th><div style="width:320px" align="left"><b>Source Package</b></div> </th><th><div style="width:320px" align="left"><b>Sub-Packages</b></div> </th></tr>
<tr>
<td rowspan="3">PulseAudio </td><td>pulseaudio-pa-info </td></tr>
<tr>
<td>pulseaudio-server </td></tr>
<tr>
<td>pulseaudio-misc </td></tr>
</table>
<h2><a class="anchor" id="doc_yocto_sub_single_guide"></a>
8.2 Add Sub-Packages to Source Package Installation</h2>
<p >The current software development kit (SDK) provides convenience for users to easily select the OSS packages through "make menuconfig", while it can only retrieve the OSS packages that have the same name as its recipe file. Once finished with menuconfig, an ipcam-image.bb will be generated automatically to add all selected software packages into the build and install queue. If a target OSS package has multiple sub-packages, its sub-packages that have a different name from the recipe file will not be selected. To resolve this issue, users can follow the steps to add these sub-packages specifically. PulseAudio is used as an example:</p>
<p ><b>#1</b>. Add the subpackage name to the <code>IMAGE_INSTALL</code> variable in the <code>ipcam-image.bbappend</code> file. </p><div class="fragment"><div class="line">ambarella/metadata/meta-ambabsp/recipes-core/images/ipcam-image.bbappend</div>
<div class="line"> </div>
<div class="line">IMAGE_INSTALL:append = <span class="stringliteral">&quot; \</span></div>
<div class="line"><span class="stringliteral">          pulseaudio-pa-info \</span></div>
<div class="line"><span class="stringliteral">          pulseaudio-server \</span></div>
<div class="line"><span class="stringliteral">          pulseaudio-misc \</span></div>
<div class="line"><span class="stringliteral">          &quot;</span></div>
</div><!-- fragment --><p ><b>#2</b>. Add the OSS package name to the <code>DEPENDS</code> variable and add the sub-package name to the <code>RDEPENDS:${PN}</code> variable in any recipe file. If a target package depends on PulseAudio's subpackages, the user can modify the &lsquo;DEPENDS&rsquo; and 'RDEPENDS:${PN}' variable in the target package's recipe file.</p>
<div class="fragment"><div class="line">DEPENDS += <span class="stringliteral">&quot;pulseaudio&quot;</span></div>
<div class="line">RDEPENDS:${PN} += <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">             libpulse \</span></div>
<div class="line"><span class="stringliteral">             libpulse-mainloop-glib \</span></div>
<div class="line"><span class="stringliteral">             libpulse-simple \</span></div>
<div class="line"><span class="stringliteral">             libpulsecommon \</span></div>
<div class="line"><span class="stringliteral">             libpulsecore \</span></div>
<div class="line"><span class="stringliteral">             pulseaudio-pa-info \</span></div>
<div class="line"><span class="stringliteral">             pulseaudio-server \</span></div>
<div class="line"><span class="stringliteral">             pulseaudio-misc \</span></div>
<div class="line"><span class="stringliteral">             &quot;</span></div>
</div><!-- fragment --><p >Users can also use this method to add other software packages into the current compilation target.</p>
<hr  />
<h1><a class="anchor" id="doc_yocto_rec_difference_3rd_party"></a>
9. The Difference of Big OSS Modules</h1>
<p >The following table lists the difference of the BIG OSS modules between Amba Build and Yocto Build.</p>
<a class="anchor" id="difference_3rd_party"></a>
<table class="doxtable">
<caption>Table 9-1. Difference Of Big OSS Modules</caption>
<tr>
<th>OSS </th><th>Amba Build </th><th>Yocto Build </th></tr>
<tr>
<td>Busybox </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/busybox </td><td>ambarella/build/poky/meta/recipes-core/busybox </td></tr>
<tr>
<td>Systemd </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/systemd </td><td>ambarella/build/poky/meta/recipes-core/systemd </td></tr>
<tr>
<td>ROS2 </td><td>Not supported </td><td>ambarella/oss_yocto/meta-ros/meta-ros2-galactic </td></tr>
<tr>
<td>iceoryx </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/iceoryx-* </td><td>ambarella/oss_yocto/meta-ros/meta-ros2-galactic/generated-recipes/iceoryx </td></tr>
<tr>
<td>CycloneDDS </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/cyclonedds* </td><td>ambarella/oss_yocto/meta-ros/meta-ros2-galactic/generated-recipes/cyclonedds </td></tr>
<tr>
<td>OpenCV4 </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/opencv </td><td>ambarella/oss_yocto/meta-openembedded/meta-oe/recipes-support/opencv </td></tr>
<tr>
<td>FFmpeg </td><td>Not supported </td><td>ambarella/build/poky/meta/recipes-multimedia/ffmpeg </td></tr>
<tr>
<td>GStreamer </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/gstreamer1* </td><td>ambarella/build/poky/meta/recipes-multimedia/gstreamer </td></tr>
<tr>
<td>PulseAudio </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/pulseaudio </td><td>ambarella/build/poky/meta/recipes-multimedia/pulseaudio </td></tr>
<tr>
<td>ALSA </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/alsa-* </td><td>ambarella/build/poky/meta/recipes-multimedia/alsa </td></tr>
<tr>
<td>Python3 </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/python3 </td><td>ambarella/build/poky/meta/recipes-devtools/python </td></tr>
<tr>
<td>Flask </td><td>Not supported </td><td>ambarella/oss_yocto/meta-openembedded/meta-python/recipes-devtools/python </td></tr>
<tr>
<td>SElinux </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/libselinux </td><td>ambarella/oss_yocto/meta-selinux/recipes-security </td></tr>
<tr>
<td>SQLite3 </td><td>ambarella/prebuild/oss/&lt;CPU_ARCH&gt;/sqlite </td><td>ambarella/build/poky/meta/recipes-support/sqlite </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>For Amba Build: it uses the prebuild OSSs compiled by Ambarella.</li>
<li>For Yocto Build: it uses the OSSs provided by OSS community.</li>
</ul>
</dd></dl>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
