<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Build System: ROS2 Image by Yocto Build</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Build System"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Build System<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/d7c/doc_amyoc_ros2.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">ROS2 Image by Yocto Build </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >ROS2 image is supported by the Yocto build only. Because the size of the ROS2 image is very big, the eMMC are usually used to store it.</p>
<dl class="section user"><dt>Example 1: Build ROS2 Image for CV22 Walnut EVK</dt><dd></dd></dl>
<div class="fragment"><div class="line">ambarella$ <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> build/env/yocto-ros2-build.env cv22_walnut</div>
<div class="line">ambarella/out/yocto_out/cv22_walnut$ make ipcam_emmc_config</div>
<div class="line">ambarella/out/yocto_out/cv22_walnut$ make ros-image</div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div></div>
</div><!-- fragment --><dl class="section user"><dt>Example 2: Build ROS2 Image for CV3 Dk_mini EVK</dt><dd></dd></dl>
<p>CV3 Dk_mini board's storage media is a SPI NOR flash. Due to its size limitation, the user must prepare a TF card for it to store the ROS2 Image's Rootfs.<br  />
 To set up the ROS2 Image, perform the following steps:</p>
<ol type="1">
<li>Modify the CV3 Dk_mini's device trees (DTS) file. <div class="fragment"><div class="line">ambarella$ vim ambarella/boards/cv3_dk_mini/bsp/cv3_dk_mini.dts</div>
<div class="line">...</div>
<div class="line"><span class="comment">//bootargs = &quot;console=ttyS0 root=/dev/mtdblock5 rw rootfstype=jffs2 earlycon pci=nomsi&quot;;</span></div>
<div class="line">bootargs = <span class="stringliteral">&quot;console=ttyS0 noinitrd root=/dev/mmcblk0p1 rw rootfstype=ext4 rootwait&quot;</span>;</div>
<div class="line">...</div>
</div><!-- fragment --></li>
<li>Create a profile for the firmware to be programed to the SPI NOR flash. <div class="fragment"><div class="line">ambarella$ vim ambarella/boards/cv3_dk_mini/bsp/profile.ros2</div>
<div class="line">IMAGE_FWPROG    := $(BIN_DIR)/fwp.bin</div>
<div class="line"> </div>
<div class="line">IMAGE_0_NAME    := bst</div>
<div class="line">IMAGE_0_FILE    := $(BIN_DIR)/bst.bin</div>
<div class="line">IMAGE_0_ADDR    := -1</div>
<div class="line">IMAGE_0_FLAG    := force <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div>
<div class="line"> </div>
<div class="line">IMAGE_1_NAME    := bld</div>
<div class="line">IMAGE_1_FILE    := $(BIN_DIR)/bld.bin</div>
<div class="line">IMAGE_1_ADDR    := -1</div>
<div class="line">IMAGE_1_FLAG    := force <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div>
<div class="line"> </div>
<div class="line">IMAGE_2_NAME    := env</div>
<div class="line">IMAGE_2_FILE    := $(BIN_DIR)/env.bin</div>
<div class="line">IMAGE_2_ADDR    := -1</div>
<div class="line">IMAGE_2_FLAG    := force</div>
<div class="line"> </div>
<div class="line">IMAGE_3_NAME    := dtb</div>
<div class="line">IMAGE_3_FILE    := $(BIN_DIR)/dtb.bin</div>
<div class="line">IMAGE_3_ADDR    := -1</div>
<div class="line">IMAGE_3_FLAG    := force</div>
<div class="line"> </div>
<div class="line">IMAGE_4_NAME    := kernel</div>
<div class="line">IMAGE_4_FILE    := $(BIN_DIR)/kernel.bin</div>
<div class="line">IMAGE_4_ADDR    := $(KERNEL_RAM_START)</div>
<div class="line">IMAGE_4_FLAG    := verify compressed</div>
<div class="ttc" id="acJSON_8h_html_a788db922597cf2fb6389e278f822e59f"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div><div class="ttdeci">const char *const const char *const raw</div></div>
</div><!-- fragment --></li>
<li>Select the profile above . <div class="fragment"><div class="line">ambarella$ make ipcam_config</div>
<div class="line">ambarella$ make menuconfig</div>
<div class="line">meta-ambabsp  ---&gt;</div>
<div class="line">  recipes-bsp  ---&gt;</div>
<div class="line">    [*] ambfw (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">      AMBFW Configuration  ---&gt;</div>
<div class="line">        [*] Build AMBFW</div>
<div class="line">        (profile.ros2) Firmware Profile</div>
</div><!-- fragment --></li>
<li>Set the CV3 Dk_mini's Rootfs type to 'EXT4'. <div class="fragment"><div class="line">ambarella$ make menuconfig</div>
<div class="line">meta-ambabsp  ---&gt;</div>
<div class="line">  recipes-bsp  ---&gt;</div>
<div class="line">    [*] amrootfs (meta-ambabsp/recipes-bsp/amrootfs)  ---&gt;</div>
<div class="line">      Linux Root File System (EXT4)  ---&gt;</div>
<div class="line"> </div>
<div class="line">make linux_menuconfig   <span class="comment">//Enable EXT4 support in kernel</span></div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    &lt;*&gt; MMC/SD/SDIO card support  ---&gt;   <span class="comment">//&lt;*&gt; to build into kernel, not &lt;M&gt;</span></div>
<div class="line">      &lt;*&gt;   MMC block device driver</div>
<div class="line">      &lt;*&gt;   Ambarella Media Processor SD/MMC Host Controller driver</div>
<div class="line">      &lt;*&gt;   Secure Digital Host Controller Interface support</div>
<div class="line">      &lt;*&gt;     SDHCI platform and OF driver helper</div>
<div class="line">      &lt;*&gt;       SDHCI support <span class="keywordflow">for</span> Ambarella DWC MSHC</div>
<div class="line">  File systems  ---&gt;</div>
<div class="line">    &lt;*&gt; The Extended 4 (ext4) filesystem   <span class="comment">//&lt;*&gt; to build into kernel, not &lt;M&gt;</span></div>
<div class="line">    [*]   Use ext4 <span class="keywordflow">for</span> ext2 file systems</div>
<div class="line">    [*]   Ext4 POSIX Access Control Lists</div>
<div class="line">    [*]   Ext4 Security Labels</div>
</div><!-- fragment --></li>
<li>Build the ROS2 image. <div class="fragment"><div class="line">ambarella$ make ros-image</div>
</div><!-- fragment --> The generated firmware path: <code>ambarella/out/yocto_out/cv3_dk_mini/firmware/bst_bld_env_dtb_kernel.elf</code><br  />
 The generated Rootfs path: <code>ambarella/out/yocto_out/cv3_dk_mini/images/ros-image-galactic-cv3x-XXXXXX.rootfs.ext4</code></li>
<li>Prepared a TF card to format it to <code>EXT4</code>. <div class="fragment"><div class="line">board# fdisk -l   <span class="comment">// Note: Use a CV72 board as an example to formate the TF card.</span></div>
<div class="line">board# umount /sdcard/mmcblk1p1   <span class="comment">// The device name will be effected by the hardware slot. Here is in slot 1.</span></div>
<div class="line">board# mkfs.ext4 /dev/mmcblk1</div>
</div><!-- fragment --></li>
<li>Create partitions on the TF card. <div class="fragment"><div class="line">board# fdisk /dev/mmcblk1</div>
<div class="line">Welcome to fdisk (util-linux 2.35.1).</div>
<div class="line">Changes will remain in memory only, until you decide to write them.</div>
<div class="line">Be careful before <span class="keyword">using</span> the write command.</div>
<div class="line"> </div>
<div class="line">The device contains <span class="stringliteral">&#39;ext4&#39;</span> signature and it will be removed by a write command. See fdisk(8) man page and --wipe option for more details.</div>
<div class="line"> </div>
<div class="line">Device does not contain a recognized partition table.</div>
<div class="line">Created a new DOS disklabel with disk identifier 0x55843850.</div>
<div class="line"> </div>
<div class="line">Command (m for help): p</div>
<div class="line">Disk /dev/mmcblk1: 59.7 GiB, 64088965120 bytes, 125173760 sectors</div>
<div class="line">Units: sectors of 1 * 512 = 512 bytes</div>
<div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div>
<div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div>
<div class="line">Disklabel type: dos</div>
<div class="line">Disk identifier: 0x55843850</div>
<div class="line"> </div>
<div class="line">Command (m for help): n</div>
<div class="line">Partition type</div>
<div class="line">   p   primary (0 primary, 0 extended, 4 free)</div>
<div class="line">   e   extended (container for logical partitions)</div>
<div class="line">Select (default p): p</div>
<div class="line">Partition number (1-4, default 1): 1</div>
<div class="line">First sector (2048-125173759, default 2048):</div>
<div class="line">Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-125173759, <span class="keywordflow">default</span> 125173759): +5G</div>
<div class="line"> </div>
<div class="line">Created a <span class="keyword">new</span> partition 1 of type <span class="stringliteral">&#39;Linux&#39;</span> and of size 5 GiB.</div>
<div class="line"> </div>
<div class="line">Command (m <span class="keywordflow">for</span> help): n</div>
<div class="line">Partition type</div>
<div class="line">   p   primary (1 primary, 0 extended, 3 free)</div>
<div class="line">   e   extended (container <span class="keywordflow">for</span> logical partitions)</div>
<div class="line">Select (<span class="keywordflow">default</span> p): p</div>
<div class="line">Partition <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> (2-4, default 2):</div>
<div class="line">First sector (10487808-125173759, default 10487808):</div>
<div class="line">Last sector, +/-sectors or +/-size{K,M,G,T,P} (10487808-125173759, default 125173759):</div>
<div class="line"> </div>
<div class="line">Created a new partition 2 of type <span class="stringliteral">&#39;Linux&#39;</span> and of size 54.7 GiB.</div>
<div class="line"> </div>
<div class="line">Command (m for help): w</div>
<div class="line">The partition table has been altered.</div>
<div class="line">Calling ioctl() to re-read partition table.</div>
<div class="line">[ 4587.885399]  mmcblk1: p1 p2</div>
<div class="line">Syncing disks.</div>
<div class="ttc" id="acJSON_8h_html_a01b4671c6b7cc8f831c951c000a37735"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a></div><div class="ttdeci">const char *const const double number</div></div>
</div><!-- fragment --></li>
<li>Reboot the board used to format the TF card to ensure that the settings above take effect. <div class="fragment"><div class="line">board# reboot</div>
<div class="line">board# fdisk -l</div>
<div class="line">......</div>
<div class="line">Disk /dev/mmcblk1: 59.7 GiB, 64088965120 bytes, 125173760 sectors</div>
<div class="line">Units: sectors of 1 * 512 = 512 bytes</div>
<div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div>
<div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div>
<div class="line">Disklabel type: dos</div>
<div class="line">Disk identifier: 0x55843850</div>
<div class="line"> </div>
<div class="line">Device         Boot    Start       End   Sectors  Size Id Type</div>
<div class="line">/dev/mmcblk1p1          2048  10487807  10485760    5G 83 Linux</div>
<div class="line">/dev/mmcblk1p2      10487808 125173759 114685952 54.7G 83 Linux</div>
</div><!-- fragment --></li>
<li>Store the ROS2 image's Rootfs to the TF card.<br  />
 Put <code>ambarella/out/yocto_out/cv3_dk_mini/images/ros-image-galactic-cv3x-XXXXXX.rootfs.ext4</code> under CV72 board's <code>/tmp/</code> folder. <div class="fragment"><div class="line">board# dd <span class="keywordflow">if</span>=/tmp/ros-image-galactic-cv3x-XXXXXX.rootfs.ext4 of=/dev/mmcblk1p1</div>
</div><!-- fragment --></li>
<li>Insert the TF card into cv3_dk_mini board.</li>
<li>Flash the generated firmware in step 5 to CV3 DK MINI board using the AmbaUSB program tool. <div class="fragment"><div class="line">------ Report ------</div>
<div class="line">bst:    success</div>
<div class="line">bld:    success</div>
<div class="line">env:    success</div>
<div class="line">dtb:    success</div>
<div class="line">kernel: success</div>
</div><!-- fragment --></li>
<li>Reboot and the Rootfs in TF card will be recognized in device <code>/dev/mmcblk0p1</code>. <div class="fragment"><div class="line">[    1.181415] Waiting <span class="keywordflow">for</span> root device /dev/mmcblk0p1...</div>
<div class="line">[    1.254990] mmc0: <span class="keyword">new</span> ultra high speed SDR104 SDXC card at address 59b4</div>
<div class="line">[    1.261784] mmcblk0: mmc0:59b4 JC1S5 59.7 GiB</div>
<div class="line">[    1.267337]  mmcblk0: p1 p2</div>
<div class="line">[    1.281551] EXT4-fs (mmcblk0p1): mounted filesystem with ordered data mode. Opts: (null). Quota mode: disabled.</div>
<div class="line">[    1.291695] VFS: Mounted root (ext4 filesystem) on device 179:1</div>
</div><!-- fragment --></li>
</ol>
<dl class="section user"><dt>Check ROS2</dt><dd></dd></dl>
<div class="fragment"><div class="line">board # ping 10.0.0.1</div>
<div class="line">board # <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> /usr/bin/ros_setup.sh</div>
<div class="line">board # ros2 pkg list</div>
<div class="line">action_msgs</div>
<div class="line">actionlib_msgs</div>
<div class="line">ament_index_cpp</div>
<div class="line">ament_index_python</div>
<div class="line">builtin_interfaces</div>
<div class="line">...</div>
</div><!-- fragment --><hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
