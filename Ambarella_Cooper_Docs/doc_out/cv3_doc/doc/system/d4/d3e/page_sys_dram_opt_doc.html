<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>System: DESIGN - Memory Layout &amp; Optimization</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="System"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">System<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d4/d3e/page_sys_dram_opt_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">DESIGN - Memory Layout &amp; Optimization </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="dram_opt_history"></a>
0. Revision History</h1>
<a class="anchor" id="sys_dram_opt_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>SDK Version </th><th>Updated Date </th><th>Modification </th></tr>
<tr>
<td>CV5x SDK 0.5 </td><td>20211021 </td><td>Initial Version </td></tr>
<tr>
<td rowspan="6">CV5x SDK 0.5 </td><td rowspan="6">20220114 </td><td>Added Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_mem_intr">1.1 Memory Layout Introduction</a>. </td></tr>
<tr>
<td>Updated Section sec_dram_linux. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_iav">2.2 IAV Partition</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_user">2.2.2 User Data Buffer</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_comp">2.3.1 Composition</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv52">4.2 CV52 Bandwidth Limitation</a>. </td></tr>
<tr>
<td rowspan="6">CV5x SDK 1.5 </td><td rowspan="6">20220721 </td><td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_iav">2.2 IAV Partition</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_can">2.2.11 CANVAS_POOL</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_blur">2.2.14 Blur</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_arblur">2.2.15 Arbitrary Blur</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv5">4.1 CV5 Bandwidth Limitation</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv52">4.2 CV52 Bandwidth Limitation</a>. </td></tr>
<tr>
<td>CV5x SDK 2.0 </td><td>20220801 </td><td>Migrate this DRAM Optimization document from Word form into Doxygen form. </td></tr>
<tr>
<td>Cooper SDK 1.5 </td><td>20230928 </td><td>Update Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#dram_opt_example"><ol type="1">
<li>Examples of Memory Allocation</li>
</ol>
</a>. </td></tr>
<tr>
<td>Cooper SDK 1.6 </td><td>20240110 </td><td>Update Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#dram_opt_example"><ol type="1">
<li>Examples of Memory Allocation</li>
</ol>
</a>. </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="dram_opt_introduction"></a>
1. Introduction</h1>
<p >The DRAM system consists of four partitions: Linux, image audio video (IAV), image digital signal processing (DSP), and computer vision (CV). The Linux partition operates the Linux system; the IAV partition is shared by the IAV driver and DSP; the DSP partition is used by DSP; and the CV partition is used by the vector processor (VP).</p>
<p >The base addresses and total sizes of the IAV, DSP, and CV-related partitions can be configured using "menuconfig" and the "iav_config.h" file. If desired, users can change the system to ensure that it fits customized designs, provided that any changes meet the DSP and VP minimum requirements for DRAM size.</p>
<p >The continuous memory allocator (CMA) is supported by the Linux kernel and enables the allocation of large physically continuous memory blocks at runtime. The CMA also allocates and maintains the IAV, DSP, and CV partitions on CV2x. The IAV and DSP partitions share the same CMA memory pool, while CV has its own. When Linux boots up, the free memory left in the memory pools is reused by the Linux system.</p>
<p >The base addresses and sizes of the CMA memory pools for the IAV, DSP, and CV partitionsare specified in the compile configuration using the default configuration (build $ make cv2x_ipcam_config) for the CV series of chips.</p>
<h2><a class="anchor" id="sec_dram_mem_intr"></a>
1.1 Memory Layout Introduction</h2>
<p >The Ambarella CV5x platform supports DRAM sizes of 4 GB, 8 GB, 16 GB, and greater. The chip series targets 8KP30+ encoding, therefore requiring a large DRAM size and bandwidth, as well as high-resolution image signal processing (ISP) and encoding processing.</p>
<p >Ambarella divides system memory into the following three categories through the CMA:</p><ul>
<li>DSP private memory partition<ul>
<li>"DSP + Arm®" access only, CV cannot read or write the memory in this partition.</li>
</ul>
</li>
<li>CV private memory partition<ul>
<li>"Arm + CV" access only, DSP cannot read or write the memory in this partition.</li>
</ul>
</li>
<li>DSP and CV shared memory partition<ul>
<li>The memory in this partition can be accessed by "DSP + CV + Arm", Which means DSP, CV, and Arm have accessed to the memory in this partition.</li>
</ul>
</li>
</ul>
<p >For the CV5x platform, Arm has been upgraded to access DRAM with a 40-bit address bitwidth, which exceeds the minimum required to access the entire DRAM. However, the DRAM access address bitwidth of DSP and CV remains 32 bits; as a result, both can access only 4 GB memory space. To address this, different memory layouts will be made for the 4 GB and 8 GB (or &gt; 8 GB) DRAM accordingly.</p>
<h3><a class="anchor" id="sub_sec_4g_layout"></a>
1.1.1 4 GB Memory Layout</h3>
<p >The total 4GB DRAM size can be accessed by <b>"Arm + CV + DSP"</b>. The figure below shows the system memory layout for 4 GB DRAM size, which is applied to <b>"CV52 Zr"</b> platform.</p>
<div class="image">
<img src="../../cv5_sys_dram_opt_total_4g.png" alt=""/>
<div class="caption">
4 GB DRAM System Memory Layout.</div></div>
<p >For 4 GB DRAM size on the "CV52 Zr" platform:</p><ul>
<li>DSP private memory pool size = 2816 MB</li>
<li>DSP shared memory size = 16 MB</li>
<li>CV private memory pool size = 512 MB</li>
<li>CV shared memory size = 0 MB</li>
<li>Linux memory size = 4096 - 2816 - 512 - 16 = 0x2F400000 = 756 MB</li>
</ul>
<div class="fragment"><div class="line">Memory  ---&gt;</div>
<div class="line"> (2816) DSP Private Memory size in MB</div>
<div class="line"> (16) DSP Shared Memory size in <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line"> (512) CV Private Memory size in MB</div>
<div class="line"> (0) CV Shared Memory size in MB</div>
<div class="ttc" id="aiav__utils_8h_html_aa6b38d492364d98453284934ed7caee9"><div class="ttname"><a href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div><div class="ttdeci">#define MB</div></div>
</div><!-- fragment --><h3><a class="anchor" id="sub_sec_8g_layout"></a>
1.1.2 8 GB (or &gt; 8 GB) Memory Layout</h3>
<p >Because the DRAM access address bitwidth of both DSP and CV is 32 bits, they are unable to directly access the memory beyond the 4G boundary. To provide them with their own 4 GB memory space, the CV5x platform utilizes the address translation table (ATT) mapping for the "DSP Memory Space" (both "DSP Private Pool" and "DSP &amp; VP Shared Pool"), while CV, "CV Private Pool", and "DSP &amp; VP Shared Pool" continue using the default DRAM memory space, as they are both within 4 GB.</p>
<p >The process of ATT mapping for "DSP Memory Space" is separated into the following two steps:</p>
<p >1.When performing ATT mapping, "DSP Private Pool" is mapped from 0, which means that its offset in the ATT memory space will be the same with the lower u32 of its DRAM physical address. For example, if the DRAM physical address is 0x1, 0010, 0000, the offset in the ATT memory space will be 0x0010, 0000.</p>
<p >2.Map "DSP &amp; VP Shared Pool" to the end of the 4 GB ATT memory space. Its offset in the ATT memory space will be the same as its DRAM physical address. For example, if the DRAM physical address is 0xFF10, 0000, then its offset in the ATT memory space will also be 0xFF10, 0000.</p>
<p >Consequently, the memory layout of the 8G DRAM size is designed as shown in the following diagram.</p>
<div class="image">
<img src="../../cv5_sys_dram_opt_total_8g.png" alt=""/>
<div class="caption">
8 GB DRAM System Memory Layout.</div></div>
<p >The following table shows the DRAM access limitation for Arm, CV, and DSP. </p><dl class="section user"><dt>8 GB DRAM Access Limitation for Arm, CV, and DSP</dt><dd><a class="anchor" id="dram_table_8g_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Element </th><th>DRAM Access Limitation </th></tr>
<tr>
<td>Arm </td><td>0~8 GB </td></tr>
<tr>
<td>CV </td><td>0~4 GB </td></tr>
<tr>
<td>DSP </td><td>DSP memory space </td></tr>
</table>
</dd></dl>
<p>For 8 GB DRAM size on the "CV52 Zr" platform:</p><ul>
<li>DSP private memory pool size = 2816 MB</li>
<li>DSP shared memory size = 16 MB</li>
<li>CV private memory pool size = 512 MB</li>
<li>CV shared memory size = 0 MB</li>
<li>Linux memory size = 8192 - 2816 – 512 - 16 = 0x12F400000 = 4852 MB</li>
</ul>
<div class="fragment"><div class="line">Memory  ---&gt;</div>
<div class="line"> (2816) DSP Private Memory size in MB</div>
<div class="line"> (16) DSP Shared Memory size in <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line"> (512) CV Private Memory size in MB</div>
<div class="line"> (0) CV Shared Memory size in MB</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="dram_opt"></a>
2. DRAM Optimization</h1>
<p >This chapter describes each partition in detail while providing guidelines on how user applications can optimize DRAM usage for their corresponding system. The DRAM utilization can be changed manually for user applications with different requirements. This chapter includes the following sections:</p>
<ul>
<li>
sec_dram_linux </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_iav">2.2 IAV Partition</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_dsp">2.3 Digital Signal Processor Partition</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv">2.4 CV Partition</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_res">2.5 Resource Memory Layout Configuration</a> </li>
</ul>
<p >When the system boots up, customers can dump the start addresses and sizes of the IAV / DSP / CV sub-partitions using the following commands.</p>
<p >Dump the IAV / DSP sub-partitions: </p><div class="fragment"><div class="line">board # cat /proc/ambarella/cma</div>
</div><!-- fragment --><p >Dump the CV sub-partitions: </p><div class="fragment"><div class="line">board # cat /proc/ambarella/cavalry_cma</div>
</div><!-- fragment --><p >When the system is in preview or encoding state, customers can check the DSP DRAM usage information using the following commands: </p><div class="fragment"><div class="line">board # cat /proc/ambarella/iav_mem</div>
<div class="line">@encode</div>
<div class="line"> </div>
<div class="line">@subsection sec_dram_linux 2.1 Linux Partition</div>
<div class="line"> </div>
<div class="line">As shown in picture @ref sub_sec_4g_layout <span class="stringliteral">&quot;4 GB DRAM System Memory Layout&quot;</span></div>
<div class="line">and @ref sub_sec_8g_layout <span class="stringliteral">&quot;8 GB DRAM System Memory Layout&quot;</span>,</div>
<div class="line">users must ensure that there is sufficient DRAM <span class="keywordflow">for</span> the Linux</div>
<div class="line">system by setting the start addresses of the CMA memory pools <span class="keywordflow">for</span> the IAV, DSP, and CV</div>
<div class="line">partitions. The following configured options are <span class="keywordflow">for</span> the CV5x board. The size must be a</div>
<div class="line">multiple of 4 <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, as required by the CMA.</div>
<div class="line">@code {.c}</div>
<div class="line">build $ make menuconfig</div>
<div class="line">     -*- board (boards)  ---&gt;</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">     (2816) DSP Private Memory size in MB</div>
<div class="line">     (16) DSP Shared Memory size in <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">     (512) CV Private Memory size in MB</div>
<div class="line">     (0) CV Shared Memory size in MB</div>
</div><!-- fragment --><h2><a class="anchor" id="sec_dram_iav"></a>
2.2 IAV Partition</h2>
<p >The following figure illustrates the IAV sub-partition.</p>
<div class="image">
<img src="../../cv5_sys_dram_opt_iav_partion.png" alt=""/>
<div class="caption">
Detailed IAV Sub-Partitions.</div></div>
<p >The following table shows the details of the IAV sub-partitions. All DRAM sizes will be aligned to page sizes (4 KB) in the actual DRAM map.</p>
<dl class="section user"><dt>IAV Partition Usage Instructions</dt><dd><a class="anchor" id="dram_iav_partition_usage"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Name </th><th>Instruction and Usage </th><th>Resiz-able </th><th>Default Size </th><th>Necessity </th></tr>
<tr>
<td>BSB </td><td>Bitstream buffer stores the encoding data (such as H.265, H.264, and MJPEG).<br  />
 The size depends on the total stream bitrate and bitstream data cache time </td><td>Yes </td><td>32 MB </td><td>Compulsory </td></tr>
<tr>
<td>USR </td><td>User data buffer is used to encode from the raw data (both YUV and RGB).<br  />
 Its size depends on raw data size and number. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>MV </td><td>Motion vector buffer. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>OVERLAY </td><td>Overlay buffer is used for on screen display (OSD).<br  />
 Its size depends on the overlay area size and number. </td><td>Yes </td><td>16 MB </td><td>Optional </td></tr>
<tr>
<td>QPMATRIX QPMATRIX_RAW </td><td>QP ROI matrix buffer.<br  />
 QP matrix raw buffer. </td><td>Yes </td><td>10 MB </td><td>Optional </td></tr>
<tr>
<td>WARP </td><td>The warp buffer is used for multi-region dewarp and LDC. </td><td>Yes </td><td>1 MB x N(N: channel number) </td><td>Optional </td></tr>
<tr>
<td>QUANT </td><td>JPEG quant matrix table is used to improve the MJPEG quality. </td><td>No </td><td>8 KB </td><td>Compulsory </td></tr>
<tr>
<td>IMG </td><td>Image buffer used for 3A. </td><td>Yes </td><td>(5 x N + 1) <a class="elRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB(N: channel number)</a> </td><td>Compulsory </td></tr>
<tr>
<td>MASK </td><td>Single-color / multi-color privacy mask buffer.<br  />
 The size depends on the maximum supported VIN resolution.<br  />
 Single-color: (maximum VIN resolution / 8) x N.<br  />
 Multi-color: maximum VIN resolution x N(N: channel number) </td><td>Yes </td><td>Single-color: 40 MB x N.<br  />
 Multi-color: 0 <a class="elRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB(N: channel number)</a> </td><td>Optional </td></tr>
<tr>
<td>PYRAMID_POOL </td><td>Pyramid buffer pool for the pyramid manual-feed mode.<br  />
 The size depends on the pyramid buffer size and number. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>CANVAS_POOL </td><td>Canvas buffer pool for the canvas manual-feed mode.<br  />
 The size depends on the canvas buffer size and number. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>BLEND_ALPHA </td><td>Alpha blend buffer for the cross-channel stitching.<br  />
 The size depends on the stitching area size and number. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>BLUR </td><td>Blur buffer for the stream privacy protection.<br  />
 The size depends on the maximum blur area size. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
<tr>
<td>ARB_BLUR </td><td>Arbitrary blur buffer for the stream privacy protection.<br  />
 The size depends on the maximum blur area size and maximum stream number. </td><td>Yes </td><td>0 MB </td><td>Optional </td></tr>
</table>
</dd></dl>
<p>The following stages specify the size of the IAV sub-partitions for different use cases:<br  />
</p><ul>
<li>Compilation stage (for reserved memory management or CMA)<br  />
<ul>
<li>The compilation stage configures the partition size through "menuconfig", and then compiles it into the firmware.</li>
</ul>
</li>
<li>Driver installation stage (only for CMA)<br  />
<ul>
<li>The driver installation stage sets the driver module parameters to load different options for the partition size.</li>
</ul>
</li>
<li>Run-time stage (only for CMA)<br  />
<ul>
<li>The run-time stage configures and resizes the partition size through IAV IOCTL on-the-fly while the system runs.</li>
</ul>
</li>
</ul>
<p >The following guidelines provide details to optimize the DRAM size of IAV sub-partitions. </p><dl class="section user"><dt>Details of IAV sub-partitions</dt><dd><a class="anchor" id="dram_iav_part_usage"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Sub partition </th><th>Usage </th></tr>
<tr>
<td><b>BSB</b> </td><td>Adjusts the size of the bitstream buffer according to the total stream bitrate and bitstream data cache time. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_bsb">2.2.1 Bitstream Buffer</a>. </td></tr>
<tr>
<td><b>Overlay</b> </td><td>Adjusts the size of the overlay buffer according to the total overlay area size and number. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_over">2.2.4 Overlay</a>. </td></tr>
<tr>
<td><b>QPM</b> </td><td>Adjusts the single QP matrix memory size according to the maximum stream resolution and number. The default value is 128 KB for a 4K resolution. The QPM size can be reduced by more than half for resolutions smaller than 4 MP. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_qp">2.2.5 QP Matrix</a>. </td></tr>
<tr>
<td><b>WARP</b> </td><td>If LDC or dewarp functions are not required, set the warp buffer size to zero. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_warp">2.2.6 Warp</a>. </td></tr>
<tr>
<td><b>PM</b> </td><td>Adjusts the single-color / multi-color privacy mask matrix memoryaccording to the maximum VIN resolution. The default value is 10 MB set for 4K, but it can be reduced when the VIN resolution is smaller in size. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_mask">2.2.9 Mask</a>. </td></tr>
<tr>
<td><b>IMG</b> </td><td>Adjusts the IMG buffer size according to the requirements of the 3A application. Different encode modes, EIS delay settings, and back pressure margin settings may need a different IMG buffer size. For more details, refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_img">2.2.7 Image</a>. </td></tr>
</table>
</dd></dl>
<h3><a class="anchor" id="sub_sec_bsb"></a>
2.2.1 Bitstream Buffer</h3>
<p >CV5x supports up to 16 streams. The BSB is used to store the bitstream data generated by all streams encoded by the DSP, which functions as a ring buffer. If the BSB size is too small, the time remaining for Arm to read out the bitstream data will be insufficient, and the data may be overwritten. By default, the BSB size is 10 MB. If there are four streams with a total 20 Mbps (8M + 4M + 4M + 4M) bit rate, then the buffer can cache the bitstream data for 10 (MB) x 8 / 20 (Mbps) = 4s. Typically, 4s of cache time is adequate for Arm to read out the bitstream data.</p>
<p >Users should adjust the BSB buffer size according to the number and bitrate of the streams in use.</p>
<p >BSB size = SUM (stream_bitrate x cache_time)<br  />
 (This example uses cache_time as &gt;= 4s.)</p>
<p >The BSB size can be configured in three stages:</p><ul>
<li>Compile stage: Sets the BSB buffer size through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x0A00000) DSP Bit Stream Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">              (0x0A00000) DSP Bit Stream Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Driver installation stage: Configures the BSB buffer size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma bsb_buf_size=0x0A00000</div>
</div><!-- fragment --></li>
<li>Run-time stage: Dynamically resizes the BSB buffer through IAV IOCTL (<b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b>) when the system is running.</li>
</ul>
<h3><a class="anchor" id="sub_sec_user"></a>
2.2.2 User Data Buffer</h3>
<p >The user data buffer (USR) is used for cases of encoding from raw data and encoding from memory (EFM).</p>
<p >For the case of encoding from raw data, the memory partition size depends on the resolution and raw type (RGB / YUV422). For example, in the case of a 1080p RGB raw encode, the buffer size is (1920 x 2 + 1920 / 2) x 1080 x 5 (5 cycle buffers) = ~25 MB. In the case of a 1080p YUV raw encode, the buffer size is (1920 x 2 + 1920) x 1080 x 5 (5 cycle buffers) = ~30 MB.</p>
<p >In EFM cases, the USR partition size depends on the resolution and number of EFM buffers. For example, if the EFM buffer resolution is 1080p and the buffer number is 6, then the USR partition size is (1920 x 1.5) x 1088 x 6 = ~18 MB.</p>
<p >The USR size is configured in three stages:</p><ul>
<li>Compile stage: Sets the internal BSB buffer size through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x4000000) IAV Usr Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             (0x4000000) IAV Usr Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>The driver installation stage, which configures the USR size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma usr_buf_size=0x4000000</div>
</div><!-- fragment --></li>
<li>Run-time stage: Dynamically resizes the internal BSB buffer through IAV IOCTL (<b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b>) when the system is running.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If the system does not require encoding from raw data or encoding from memory , the USR size must be set to zero through "menuconfig" or via the driver module parameter, to reduce the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_mv"></a>
2.2.3 Motion Vector Buffer</h3>
<p >CV5x supports dumping the motion vector (MV) for up to five streams. The MV dump is available only for AVC streams.</p>
<p >The basic unit for the MV is a macroblock with 16x16 pixels (MB). Each MV unit occupies 4 bytes, including the motion information in the x and y directions. If the maximum stream size is 3840x2160, the single MV buffer frame size will be (3840 x 2160) / (16 x16) x 4 ~= 128 KB. Usually, a ring buffer with several MV buffer frames is required to cache between the DSP and Arm. This ensures that there is enough time for Arm to read out the MV data before being overwritten by the DSP. If eight frames are used, the total MV buffer size for each stream will be 128 KB x 8 = 1 MB.</p>
<p >The MV buffer size of a single stream is configured through "menuconfig": </p><dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x0100000) IAV Motion Vector Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             (0x0100000) IAV Motion Vector Buffer Size</div>
</div><!-- fragment --></dd></dl>
<p>The maximum stream number that needs MV dump is configured through "menuconfig": </p><dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (2) IAV Max Stream Num with MV statistics</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             (2) IAV Max Stream Num with MV statistics</div>
</div><!-- fragment --></dd></dl>
<p>The total DRAM size needed for the MV buffer should be the maximum stream number multiplied by the MV buffer size. With the above settings, it will be 1 MB x 2 = 2 MB.</p>
<p >The total MV buffer size can also be specified at the driver installation stage, which configures the total MV buffer size through the driver module parameters. </p><div class="fragment"><div class="line">board # modprobe ambcma mv_buf_size=0x200000</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>If the system does not use the MV feature, users can set the MV buffer size to zero through "menuconfig" ,or the driver module parameter to reduce the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_over"></a>
2.2.4 Overlay</h3>
<p >The CV2x supports 16 independent color look-up tables (CLUT). Each CLUT requires 1 KB of memory. Only CLUT8 is supported.</p>
<p >With CLUT8, each look-up table is an array of 256 entries. The entry is defined for four individual color channels: Y, U, V, and alpha (transparency). Alpha 0 is the transparent value, 255 is non-transparent.</p>
<p >The default configuration for overlay is 8 MB for CV2x chips. Users can change the overlay size to meet their application requirements.</p>
<p >The overlay buffer size can be specified in three stages:</p><ul>
<li>The compile stage configures the overlay buffer size through "menuconfig", and then compiles it to the image. <div class="fragment"><div class="line">@par For Cooper Amba build</div>
<div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x0800000) IAV Overlay Buffer Size</div>
</div><!-- fragment --> <dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             (0x0800000) IAV Overlay Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>The driver installation stage configures the overlay buffer size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma overlay_buf_size=0x800000</div>
</div><!-- fragment --></li>
<li>The run-time stage configures / resizes the overlay buffer through IAV IOCTL (<b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b>) simultaneously while the system is running.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the stream overlay feature, users can set the overlay buffer size to zero through menuconfig or the driver module parameter in order to reduce the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_qp"></a>
2.2.5 QP Matrix</h3>
<p >The two configurations below are provided to ensure the effectiveness of the QP matrix buffer.</p>
<p >The first configuration is <b>IAV_ROI_NUM_FOR_IPB_FRAMES</b>, which is used to configure the QP matrix number for each stream. The valid matrix numbers for H26X streams range from one to three inclusive.</p>
<p >The default QP matrix value is one, which means there only is one QP matrix. It is shared by the I / P frames. B frame is not enabled.</p>
<p >When the QP matrix number is two, there are three different application cases: (1) I / P frames share the same QP matrix. The B frame uses the other QP matrix; (2) I / P frames use different QP matrixes. The B frame is not enabled. (3) I / P frames share the same QP matrix. The P2 frame uses the other QP matrix.</p>
<p >When the QP matrix number is three, there are three different application cases: (1) I / P / B frames use different QP matrixes separately; (2) I / P / P2 frames use different QP matrixes separately. The B frame is not enabled. (3) I / P frames share the same QP matrix. The B / P2 frames use the other two QP matrixes separately.</p>
<p >The QPMATRIX number is configured through "menuconfig". </p><dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          [2] IAV ROI Matrix numbers <span class="keywordflow">for</span> I/P/B/P2 frames</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             [2] IAV ROI Matrix numbers <span class="keywordflow">for</span> I/P/B/P2 frames</div>
</div><!-- fragment --></dd></dl>
<p>The second configuration is <b>IAV_MEM_QPM_SIZE</b>. This is used to establish the single QP matrix size. By default, the size is 128 KB to support 4K encoding. This can be used either as an AVC or HEVC QP matrix.</p>
<p >To support 4K AVC encoding, the required QP matrix size is (4096 x 2048) / (16 x16) x 4 = 128 KB where 16 x 16 is the MB size, and 4 indicates 4 bytes QP matrix item size per MB.</p>
<p >To support the 4K HEVC encoding, the required QP matrix size is (4096 x 2048) / (32 x 32) x 12 = 96 KB where 32 x 32 is the CTU size, and 12 indicates 12 bytes QP matrix item size per CTU. In this configuration, 128 KB is enough to support both AVC and HEVC 4K encoding.</p>
<p >Based on the above formula, users can customize the QP matrix size according to the encoding type and the maximum stream size that is required.</p>
<p >The QPMATRIX size is configured through "menuconfig". </p><dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">         [0x0020000] IAV QP MATRIX Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             [0x0020000] IAV QP MATRIX Buffer Size</div>
</div><!-- fragment --></dd></dl>
<p>In order to support the frame or the stream synchronization mechanism, there is one active buffer for the user configuration and four internally-used buffers for each stream. Suppose that there are 13 streams, each stream’s QP matrix number is one and size is 128 KB. Thus, the total size is 128 KB x 1 x (1 + 4) x 13 = 8320 KB. If the QP matrix number is three (the maximum value), the total size will be 128 KB x 3 x (1 + 4) x 13 = 24960 KB.</p>
<p >The total QP matrix buffer size can also be specified at the driver installation stage, which configures the total QP matrix buffer size through the driver module parameters. </p><div class="fragment"><div class="line">board # modprobe ambcma qpm_buf_size=0x1800000</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>If the system does not use the QPMATRIX feature, the QP matrix size can be set to zero through menuconfig or through the driver module parameter in order to reduce DRAM utilization.</dd></dl>
<h3><a class="anchor" id="sub_sec_warp"></a>
2.2.6 Warp</h3>
<p >The warp buffer is reserved to store all warp vectors for fisheye lens or lens distortion correction (LDC). The buffer size is approximately 126 KB per channel; changing this size is unnecessary. Warp can be configured through "menuconfig". </p><dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          [*] Open warp memory <span class="keywordflow">for</span> dewarp</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">             [*] Open warp memory <span class="keywordflow">for</span> dewarp</div>
</div><!-- fragment --></dd></dl>
<dl class="section note"><dt>Note</dt><dd>If the system does not support or use the fisheye correction and LDC, the user can disable it through "menuconfig" to reduce DRAM utilization.</dd></dl>
<h3><a class="anchor" id="sub_sec_img"></a>
2.2.7 Image</h3>
<p >This buffer is reserved for 3A to store all image signal processor (ISP) configuration parameters. IMG consists of two sub-partitions: (1) The image kernel (IK) buffer, which stores IK configuration parameters. (2) The static bad pixel (SBP) buffer for SBP correction. By default, the SBP buffer is not allocated. Only the IK buffer is allocated, and its buffer size depends on the channel number. IMG size = 5 x channel_number + 1(MB). For example, if the channel number is two, the IMG size required is 5 x 2 + 1 = 11 MB. Therefore, when one channel is added, an extra 5 MB will be added accordingly. The number of channels is configured by <b>CONFIG_AMBARELLA_MAX_CHANNEL_NUM</b> in "menuconfig", as shown below:</p>
<dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    drv_modules  ---&gt;</div>
<div class="line">         <span class="keyword">private</span>  ---&gt;</div>
<div class="line">          -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">              (4)   Max VIN Channel Number</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">    meta-ambabsp ---&gt;</div>
<div class="line">        recipes-video ---&gt;</div>
<div class="line">          -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">                (4)   Max VIN Channel Number</div>
</div><!-- fragment --></dd></dl>
<p>In a real use case, users may be required to specify their own IK buffer and SBP buffer sizes. These sizes can be specified in the following two stages. Once specified, they will be merged into the IMG buffer.</p><ul>
<li>The compile stage configures the IK buffer and SBP buffer sizes through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0xC00000) IAV IMG IK CFG Buffer Size</div>
<div class="line">          (0x400000) IAV IMG SBP Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">            (0xC00000) IAV IMG IK CFG Buffer Size</div>
<div class="line">            (0x400000) IAV IMG SBP Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>The driver installation stage configures the IK buffer and SBP buffer sizes through the driver module parameters. <div class="fragment"><div class="line">board # modprobe ambcma ik_buf_size=0xC00000 sbp_buf_size=0x400000</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="sub_sec_quant"></a>
2.2.8 QUANT</h3>
<p >The QUANT buffer size is 4 KB. Usually, there is no need to change this buffer size.</p>
<h3><a class="anchor" id="sub_sec_mask"></a>
2.2.9 Mask</h3>
<p >The privacy mask (PM) can protect sensitive regions from being leaked by covering them with arbitrarily-shaped areas. Once the PM areas are inserted, they will appear in both the VOUT preview and the encoded streams.</p>
<p >Details for privacy mask include the following:</p><ul>
<li>Privacy mask takes effect on the VIN domain.</li>
<li>Single-color privacy mask only supports one kind of color at a time. Its granularity can be pixel level. The corresponding memory partition name is <b>IAV_PART_MASK</b>.</li>
</ul>
<p >For the single-color PM, the default supported maximum resolution is 12 MP (4096 x 3072). Therfore, the maximum size of a single PM buffer is (4096 &gt;&gt; 3) x 3072 = 1.5 MB. There are four internally-used cache buffers, as well as an extra buffer for user application to fill PM data. As a result, the total PM size required for one channel is 1.5 MB x (1 + 4) = 7.5 MB. For multi-channel, the size will be 7.5 MB x N. N can be found using the <b>CONFIG_AMBARELLA_MAX_CHANNEL_NUM</b>. Users can refer to Section <a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sub_sec_img">2.2.7 Image</a> for more details.</p>
<p >The size of the single-color PM buffer can be specified in the driver installation stage, which configures the MASK buffer size through the driver module parameter. </p><div class="fragment"><div class="line">board # modprobe ambcma multi_color_mask_buf_size=0x780000</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>If the system does not use the MASK feature, then the MASK buffer size can be set to zero through the driver module parameter, in order to reduce the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_py"></a>
2.2.10 PYRAMID_POOL</h3>
<p >This buffer is allocated and maintained by the IAV driver only in the pyramid manual-feed mode. Its size depends on the number and size of the pyramid buffer. Because the buffer size can be calculated automatically in the IAV driver, users do not need to change it in the user application.</p>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the feature of the pyramid manual-feed, users can disable the pyramid manual-feed mode (when entering preview), in order to save the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_can"></a>
2.2.11 CANVAS_POOL</h3>
<p >This buffer is allocated and maintained by the IAV driver only in the canvas manual-feed mode. Its size depends on the number and size of the canvas buffer. Because the buffer size can be calculated automatically in the IAV driver, users do not need to change it in the user application.</p>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the canvas manual-feed feature, users can disable the canvas manual-feed mode when entering the preview state to reduce DRAM utilization.</dd></dl>
<h3><a class="anchor" id="sub_sec_raw"></a>
2.2.12 RAW_POOL</h3>
<p >This buffer is allocated and maintained by the IAV driver only in the raw manual-feed mode. Its size depends on the number and size of the raw buffer. Because the buffer size can be automatically calculated in the IAV driver, there is no need for users to change it in the user application.</p>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the raw manual-feed feature, users can disable the raw manual-feed mode when entering the preview state to reduce DRAM utilization.</dd></dl>
<h3><a class="anchor" id="sub_sec_blend"></a>
2.2.13 BLEND_ALPHA</h3>
<p >This buffer is allocated and maintained by the IAV driver for the alpha blending feature. It is dedicated for multi-channel stitching application cases. Its size depends on the number of the stitched channels and the size of overlapped areas. Because the buffer size can be automatically calculated in the IAV driver, there is no need for users to change it in the user application.</p>
<dl class="section note"><dt>Note</dt><dd>If the alpha blending feature is not enabled, this buffer will not be allocated.</dd></dl>
<h3><a class="anchor" id="sub_sec_blur"></a>
2.2.14 Blur</h3>
<p >Blur is mainly used for video stream privacy protection. Users can insert multiple blur areas into a video stream to protect the privacy areas. Once blur areas are inserted, the covered areas in the video stream will be severely blurred.</p>
<p >The default configuration for blur is 0 MB for CV2x chips (blur is disabled, by default). Users can change the blur size to meet their application requirements.</p>
<p >The blur size consists of two parts: <b>BLUR_CONTENT_SIZE</b> and <b>BLUR_RSV_SIZE</b>. The <b>BLUR_RSV_SIZE</b> is used to store the blur color table and blur commands. Its size is fixed at 50k. The <b>BLUR_CONTENT_SIZE</b> is based on the largest blur area size. The largest blur area size can be described as width x height. <b>BLUR_CONTENT_SIZE</b> = ROUND_UP ((width / 8), 64) x (height / 8).</p>
<p >The size of the blur buffer can be specified in three stages:</p><ul>
<li>Compile stage: Configures the multi-color buffer size through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x0100000) IAV Blur Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">                (0x0100000) IAV Blur Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Driver installation stage: Configures the blur buffer size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma blur_buf_size=0x100000</div>
</div><!-- fragment --></li>
<li>Run-time stage: Configures / resizes the blur buffer through IAV IOCTL (<b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b>) simultaneously while the system is running.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the stream blur feature, users can disable it through "menuconfig" or the driver module parameter, in order to reduce the DRAM size.</dd></dl>
<h3><a class="anchor" id="sub_sec_arblur"></a>
2.2.15 Arbitrary Blur</h3>
<p >Arbitrary blur is used mainly for video stream privacy protection. Users can insert multiple blur areas into a video stream to protect the privacy areas. Once blur areas are inserted, the covered areas in the video stream will be blurred severely. Compared with blur, arbitrary blur offers users more flexibility. Arbitrary blur also allows users to customize their blur area shapes through changing specified blur area memory.</p>
<p >The default configuration for arbitrary blur is 0 MB for CV2x chips, which means arbitrary blur is disabled by default. Users can change the arbitrary blur size to meet their application requirements.</p>
<p >The single largest arbitrary blur area size can be described as:</p><ul>
<li>Single_arbitrary_blur_size_x = ROUND_UP ((width / 8), 64) * (height / 8) * ring_buffer_num (x = 0, 1, 2...)</li>
<li>stream_y _arbitrary_blur_size = ∑ Single_arbitrary_blur_size_x (x = 0, 1, 2...)</li>
<li>total_arbitrary_blur_size = ∑ stream_y _arbitrary_blur_size (y = 0, 1, 2...)</li>
<li>"x" is the serial number of arbitrary blue area and "y" is the serial number of stream.</li>
<li>Single_arbitrary_blur_size_x: The arbitrary blur size for the single area which the serial number is x.</li>
<li>stream_y _arbitrary_blur_size: The arbitrary blur size for the single stream which the serial number is y.</li>
<li>total_arbitrary_blur_size: The totally needed arbitrary blur size.</li>
</ul>
<p >The size of the blur buffer can be specified in three stages:</p><ul>
<li>Compile stage: Configures the multi-color buffer size through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x0100000) IAV Blur Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">                (0x0100000) IAV Blur Buffer Size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Driver installation stage: Configures the blur buffer size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma abr_blur_buf_size=0x100000</div>
</div><!-- fragment --></li>
<li>Run-time stage: Configures / resizes the blur buffer through IAV IOCTL (<b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b>) simultaneously, while the system is running.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If the system does not use the stream blur feature with arbitrary shape, users can disable it through "menuconfig" or the driver module parameter, in order to reduce the DRAM size.</dd></dl>
<h2><a class="anchor" id="sec_dram_dsp"></a>
2.3 Digital Signal Processor Partition</h2>
<p >Digital signal processor (DSP) partition includes the DSP Buffer, DEF_CMD, UCODE, DSP_LOG, DSP_RSV, and more, as shown in the following figure.</p>
<div class="image">
<img src="../../cv5_sys_dram_opt_dsp_alloc.png" alt=""/>
<div class="caption">
Detailed DSP Partition Allocation.</div></div>
<h3><a class="anchor" id="sub_sec_comp"></a>
2.3.1 Composition</h3>
<p >The DSP partition is composed of the DSP buffer and other fixed-size sub-partitions, including the DEF_CMD (16 KB), ucode firmware (10 MB), the DSP log buffer (512 KB), the DSP reserved buffer (~500 KB), and more. The DSP buffer can be resized, depending on the VIN resolution, channel number, encode mode, stream number, stream resolution, and other required values. On the CV5x EVK board, the size of the DSP buffer has been set to 2816 MB to accommodate most use cases. </p><pre class="fragment">&lt;b&gt;DSP partition = DSP buffer + 12 MB (DEF_CMD + UCODE + DSP_LOG + DSP_RSV …)&lt;/b&gt;
</pre><p> After entering the preview / encoding state, users can input command "dmesg | grep MB" to check the actual DSP buffer size used by DSP. This is also the minimum DSP buffer size to run the current case. See the following result:<br  />
 <b>handle_dsp_cfg_msg(131): DSP DRAM Used: 393 MB</b><br  />
 (Limited size is defined as the total DSP buffer size.)</p>
<p >With the minimum required DSP buffer size (393 MB) reported by DSP, users can accommodate the current DSP buffer size (2816 MB) to meet the minimum requirements of their use cases.</p>
<p >The minimum required DSP buffer size depends on various DSP configurations such as encode mode, VIN resolution and HDR / linear mode, EIS delay count, VIN back pressure margin, canvas size and number, and maximum stream size and number. For each canvas, the buffer pool is maintained by the DSP. The buffer number of the buffer pool depends on the canvas extra buffer and the encode dummy latency. By default, with no extra buffer or encode dummy latency, each canvas buffer pool has a minimum of 4 canvas buffer items, costing 4x the canvas size memory. As each canvas and stream costs considerable DRAM space, disabling unnecessary canvases and streams is highly recommended to reduce DRAM utilization.</p>
<p >The following table shows the extra DRAM consumption for different options. </p><dl class="section user"><dt>Details of the DSP Buffer Size-Related Options</dt><dd><a class="anchor" id="dram_detail_dsp_option"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Option </th><th>DRAM Size </th></tr>
<tr>
<td>Canvas extra buffer </td><td>Canvas size </td></tr>
<tr>
<td>Encode dummy latency </td><td>Canvas size </td></tr>
<tr>
<td>EIS delay count </td><td>VIN frame size </td></tr>
</table>
</dd></dl>
<p>The size of the DSP buffer can be specified in two stages:</p><ul>
<li>Compile stage: Sets the extra raw buffer size through "menuconfig", then compiles it into the image. <dl class="section user"><dt>For Cooper Amba build</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0xB0000000) DSP buffer size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambabsp ---&gt;</div>
<div class="line">     recipes-video ---&gt;</div>
<div class="line">         -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt;</div>
<div class="line">               (0xB0000000) DSP buffer size</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Driver installation stage: Configures the DSP buffer size through the driver module parameter. <div class="fragment"><div class="line">board # modprobe ambcma dsp_buf_size=0xB0000000</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="sub_sec_exampl_23"></a>
2.3.2 Examples</h3>
<p >The following examples show the total DSP DRAM usage for typical use cases. </p>
<h3><a class="anchor" id="dram_example_1"></a>
Example 1 IMX274_mipi / Mode 5 / 4Kp H.265 + 1080p H.265 + 4Kp MJPEG.</h3>
<div class="fragment"><div class="line">board # init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_aaa_service -a&amp;</div>
<div class="line">board # test_encode --resource-cfg cv5_vin0_4k_linear.lua</div>
<div class="line">board # test_encode -A -H 3840x2160 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e -B -H 1920x1080 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -e -C -m 3840x2160 –b 3 -e</div>
<div class="line">DRAM:  512 <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --><h2><a class="anchor" id="sec_dram_cv"></a>
2.4 CV Partition</h2>
<p >The sub-partitions of CV partition can be divided into two categories: CMD, MSG, LOG, and ucode, which are reserved for internal use; and, the remaining USR sub-partitions, which are allocated and maintained by user applications. The sizes of the USR sub-partitions depend on the type of neural network (NN) deployed by the user applications.</p>
<div class="image">
<img src="../../cv5_sys_dram_opt_cv_alloc.png" alt=""/>
<div class="caption">
Detailed CV Partition Allocation.</div></div>
<h3><a class="anchor" id="sub_sec_exampl_24"></a>
2.4.1 Examples</h3>
<p >The following examples show the total CV DRAM usage for various neural networks. </p>
<h3><a class="anchor" id="dram_example_2"></a>
Example 2 MTCNN on the Timn (CV5) Board.</h3>
<div class="fragment"><div class="line">board # modprobe cavalry; cavalry_load -f /lib/firmware/cavalry.bin –r</div>
<div class="line">board # test_nnctrl -w -t 5000 &amp;</div>
<div class="line">Iteration <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> [5000]</div>
<div class="line">board # cat /proc/ambarella/cavalry_cma</div>
<div class="line">mmb   phys[start-end]        size        kern-virt[start-end]                   ref_cnt  cache  recycle  pid    src_type</div>
<div class="line">0000  0x30000000-0x30400000  0x00400000  0x00000000731e466f-0x000000006e9f230f</div>
<div class="line">----</div>
<div class="line">0001  0x30400000-0x34401000  0x04001000  0x000000005b9b7810-0x000000005b0f8884  1        0      1    284(Alive)  User</div>
<div class="ttc" id="acJSON_8h_html_a01b4671c6b7cc8f831c951c000a37735"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a></div><div class="ttdeci">const char *const const double number</div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>"&lt;b&gt;0000&lt;/b&gt;" is the self-used memory, which is about <b>4 MB</b>.</li>
<li>"&lt;b&gt;0001&lt;/b&gt;" is used by "test_nnctrl -w -t 5000 &amp;", which is about <b>64 MB</b>.<br  />
 For details, please refer to <em>LIBRARY</em> <em>-</em> <em>Cavalry_Mem</em> <em>Library</em> <em>API</em> in Doxygen.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_dram_res"></a>
2.5 Resource Memory Layout Configuration</h2>
<p >For mask, multi-color mask, warp, and QP matrix (QPM) partitions, the memory layout can be configured according to actual use cases for different customers. The memory size of these partitions can be customized gradually, according to the memory-related parameters.</p>
<p >The memory must be configured at the boot stage, before the DSP enters the preview state.</p>
<p >The example below shows how to configure the resource memory layout in the Lua file: </p><div class="fragment"><div class="line">resource_mem_cfg = {</div>
<div class="line">    max_chan_num = 2,</div>
<div class="line">    max_stream_num = 3,</div>
<div class="line">    channels_mem = {</div>
<div class="line">        {</div>
<div class="line">            mask_possible = 1,</div>
<div class="line">            warp_possible = 0,</div>
<div class="line">            mask_buf_max_num = 5,</div>
<div class="line">            warp_buf_max_num = 0,</div>
<div class="line">            warp_area_max_num = 0,</div>
<div class="line">            max_vin = {3840, 2160},</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            mask_possible = 1,</div>
<div class="line">            warp_possible = 0,</div>
<div class="line">            mask_buf_max_num = 5,</div>
<div class="line">            warp_buf_max_num = 0,</div>
<div class="line">            warp_area_max_num = 0,</div>
<div class="line">            max_vin = {1920, 1080},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">    streams_mem = {</div>
<div class="line">        {</div>
<div class="line">            qpm_possible = 1,</div>
<div class="line">            qpm_max_matrix_num = 2,</div>
<div class="line">            qpm_buf_max_num = 7,</div>
<div class="line">            max_stream = {3840, 2160},</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            qpm_possible = 1,</div>
<div class="line">            qpm_max_matrix_num = 3,</div>
<div class="line">            qpm_buf_max_num = 6,</div>
<div class="line">            max_stream = {1920, 1080},</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            qpm_possible = 1,</div>
<div class="line">            qpm_max_matrix_num = 1,</div>
<div class="line">            qpm_buf_max_num = 5,</div>
<div class="line">            max_stream = {1280, 720},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section user"><dt>Usage</dt><dd><a class="anchor" id="dram_para_usage"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Sub partition </th><th>Usage </th></tr>
<tr>
<td>max_chan_num </td><td>specify the maximum channel number for the PM and WARP memory layout configuration. </td></tr>
<tr>
<td>max_stream_num </td><td>specify the maximum stream number for the QPM memory layout configuration. </td></tr>
<tr>
<td>warp_possible </td><td>specify whether the warp memory needs to be allocated in each channel. </td></tr>
<tr>
<td>mask_possible </td><td>specify whether the privacy mask (PM) memory needs to be allocated in each channel. </td></tr>
<tr>
<td>mask_buf_max_num </td><td>specify the maximum allocation of PM buffers in each channel. 1 is used for user application configuration, and the others are used to toggle between IAV and DSP. </td></tr>
<tr>
<td>warp_buf_max_num </td><td>specify the maximum allocated warp buffer number in each channel. 1 is used for user application configuration, and the others are used to toggle between IAV and DSP. </td></tr>
<tr>
<td>warp_area_max_num </td><td>specify the maximum allocated warp area number in each channel. For LDC / EIS use cases, the maximum number should be one. For the dewarp use cases, the maximum number of configurations is up to twelve. </td></tr>
<tr>
<td>max_vin {width, height} </td><td>specify the maximum possible VIN input width and height for PM / WARP memory allocation. </td></tr>
<tr>
<td>qpm_possible </td><td>specify whether QPM (QP matrix) memory is needed to allocate in each encode stream. </td></tr>
<tr>
<td>qpm_buf_max_num </td><td>specify the maximum allocated QPM buffer number in each encode stream. One is used for user application configuration, and the others are used to toggle between IAV and DSP. </td></tr>
<tr>
<td>qpm_max_matrix_num </td><td>specify the maximum allocated QPM matrix number in each encode stream. The maximum number can be up to three. When the number is one, it may mean I / P shares the same QP matrix. When the number is two, it may mean different QP matrixes for I / P frames, or I / P frames share one matrix and B frames use the other one. When the number is three, it may mean different QP matrixes for I / P / B frames. </td></tr>
<tr>
<td>max_stream {width, height} </td><td>specify the maximum possible stream width and height for QP matrix memory allocation. </td></tr>
</table>
</dd></dl>
<h3><a class="anchor" id="sub_sec_exampl_25"></a>
2.5.1 Examples</h3>
<p >This section provides common examples of configuring memory layout resource through Lua, including warp, single-color PM, multi-color PM, and QPM.</p><ul>
<li>Unit test commands to configure memory layout resource. </li>
</ul>
<h3><a class="anchor" id="dram_example_3"></a>
Example 3 Enables the Memory Layout Resource Configuration.</h3>
<div class="fragment"><div class="line">board # init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3 lane=2</div>
<div class="line">board # test_tuning -a&amp;</div>
<div class="line">board # test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_4k_linear_mem_cfg.lua –resource-mem-cfg-enable 1</div>
</div><!-- fragment --><ul>
<li>Typical Lua examples to configure warp, single-color PM, multi-color PM, or QPM memory layout resource.</li>
</ul>
<p >The following example shows a warp memory layout resource, including three warp buffers (one for user app, two for IAV / DSP usage). Each warp buffer supports up to two warp areas. </p>
<h3><a class="anchor" id="dram_example_4"></a>
Example 4 Set Warp Memory Layout through Lua.</h3>
<div class="fragment"><div class="line">resource_mem_cfg = {</div>
<div class="line">    max_chan_num = 1,</div>
<div class="line">    max_stream_num = 1,</div>
<div class="line">    channels_mem = {</div>
<div class="line">       {</div>
<div class="line">            warp_possible = 1,</div>
<div class="line">            warp_buf_max_num = 3,</div>
<div class="line">            warp_area_max_num = 2,</div>
<div class="line">            mask_possible = 0,</div>
<div class="line">            mask_buf_max_num = 0,</div>
<div class="line">            max_vin = {3840, 2160},</div>
<div class="line">       },</div>
<div class="line">    },</div>
<div class="line">    streams_mem = {</div>
<div class="line">       {</div>
<div class="line">            qpm_possible = 0,</div>
<div class="line">            qpm_max_matrix_num = 0,</div>
<div class="line">            qpm_buf_max_num = 0,</div>
<div class="line">            max_stream = {3840, 2160},</div>
<div class="line">       },</div>
<div class="line">    },</div>
<div class="line">},</div>
</div><!-- fragment --><p >The following example shows single-color PM resource memory layout, including three single-color PM buffers (one for user app, two for IAV / DSP usage). The maximum VIN size is {3840, 2160}. </p>
<h3><a class="anchor" id="dram_example_5"></a>
Example 5 Set Single-Color Privacy Mask Memory Layout through Lua.</h3>
<div class="fragment"><div class="line">resource_mem_cfg = {</div>
<div class="line">    max_chan_num = 1,</div>
<div class="line">    max_stream_num = 1,</div>
<div class="line">    channels_mem = {</div>
<div class="line">        {</div>
<div class="line">            warp_possible = 0,</div>
<div class="line">            warp_buf_max_num = 0,</div>
<div class="line">            warp_area_max_num = 0,</div>
<div class="line">            mask_possible = 1,</div>
<div class="line">            mask_buf_max_num = 3,</div>
<div class="line">            max_vin = {3840, 2160},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">    streams_mem = {</div>
<div class="line">        {</div>
<div class="line">            qpm_possible = 0,</div>
<div class="line">            qpm_max_matrix_num = 0,</div>
<div class="line">            qpm_buf_max_num = 0,</div>
<div class="line">            max_stream = {3840, 2160},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">},</div>
</div><!-- fragment --><p >The following example shows QPM resource memory layout, including three QP matrix buffers (one for user app, two for IAV / DSP usage) for each stream. Each buffer has three QP matrixes for I / P / B frames, respectively. </p>
<h3><a class="anchor" id="dram_example_6"></a>
Example 6 Set QP Matrix Memory Layout through Lua.</h3>
<div class="fragment"><div class="line">resource_mem_cfg = {</div>
<div class="line">     max_chan_num = 1,</div>
<div class="line">     max_stream_num = 1,</div>
<div class="line">     channels_mem = {</div>
<div class="line">         {</div>
<div class="line">             warp_possible = 0,</div>
<div class="line">             warp_buf_max_num = 0,</div>
<div class="line">             warp_area_max_num = 0,</div>
<div class="line">             mask_possible = 0,</div>
<div class="line">             mask_buf_max_num = 0,</div>
<div class="line">             max_vin = {3840, 2160},</div>
<div class="line">         },</div>
<div class="line">     },</div>
<div class="line">     streams_mem = {</div>
<div class="line">         {</div>
<div class="line">             qpm_possible = 1,</div>
<div class="line">             qpm_buf_max_num = 3,</div>
<div class="line">             qpm_max_matrix_num = 3,</div>
<div class="line">             max_stream = {3840, 2160},</div>
<div class="line">         },</div>
<div class="line">     },</div>
<div class="line">},</div>
</div><!-- fragment --><p >The following example shows the typical user case of disabling warp, single-color PM, multi-color PM, and QPM memory layout through Lua. </p>
<h3><a class="anchor" id="dram_example_7"></a>
Example 7 Reset Memory Layout through Lua.</h3>
<div class="fragment"><div class="line"> resource_mem_cfg = {</div>
<div class="line">     max_chan_num = 1,</div>
<div class="line">     max_stream_num = 1,</div>
<div class="line">     channels_mem = {</div>
<div class="line">         {</div>
<div class="line">             warp_possible = 0,</div>
<div class="line">             warp_buf_max_num = 0,</div>
<div class="line">             warp_area_max_num = 0,</div>
<div class="line">             mask_possible = 0,</div>
<div class="line">             mask_buf_max_num = 0,</div>
<div class="line">             max_vin = {3840, 2160},</div>
<div class="line">         },</div>
<div class="line">     },</div>
<div class="line">     streams_mem = {</div>
<div class="line">         {</div>
<div class="line">             qpm_possible = 0,</div>
<div class="line">             qpm_max_matrix_num = 0,</div>
<div class="line">             qpm_buf_max_num = 0,</div>
<div class="line">             max_stream = {3840, 2160},</div>
<div class="line">         },</div>
<div class="line">     },</div>
<div class="line">},</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="dram_opt_example"></a>
3. Examples of Memory Allocation</h1>
<p >This chapter includes the following sections:</p>
<ul>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_s5mp">3.1 Single 5MP VIN</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_s4k">3.2 Single 4K VIN</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_s8k">3.3 Single 8K VIN</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_q5mp">3.4 Quad 5 MP VIN</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_q4k">3.5 Quad 4K VIN</a> </li>
</ul>
<h2><a class="anchor" id="sec_dram_s5mp"></a>
3.1 Single 5MP VIN</h2>
<h3><a class="anchor" id="dram_example_8"></a>
Example 8 Single VIN 5MP with Stream Overlay and Single-Color PM.</h3>
<p >This case has a single 5MP30 linear VIN input and 5MP30 AVC + 1080p30 AVC+ 5MP1 MJPEG streams on encode mode 5. The largest overlay area is full screen (2592 x 1944) and the single-color privacy mask covers the full VIN (2592 x 1944).</p>
<p >Both CV5 and CV72 are used single core for IDSP and encoder. If CV5 uses dual core for IDSP and encoder, CV5 may take more DRAM size than CV72.</p>
<p >The Lua script can be found <a href="../../script/single_5mp_vin.lua" target="_blank"><b>here</b></a>.</p>
<dl class="section user"><dt>Single 5MP VIN Case Memory Allocation for IAV and DSP</dt><dd></dd></dl>
<a class="anchor" id="single_5mp_case_allocation"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Major </th><th>Sub1 </th><th>Sub2 </th><th>CV5 </th><th>CV72 </th></tr>
<tr>
<td rowspan="14"><b>IAV / DSP</b> </td><td></td><td><b>Total Size</b> </td><td><b>418 MB</b> </td><td><b>418 MB</b> </td></tr>
<tr>
<td><b>DSP</b> </td><td><b>DSP_BUFFER</b> </td><td><b>268 MB</b> </td><td><b>287 MB</b> </td></tr>
<tr>
<td>DSP </td><td>DSP_DEF_CMD </td><td>16 KB </td><td>32 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_LOG </td><td>4 MB </td><td>4 MB </td></tr>
<tr>
<td>IAV </td><td>Quant </td><td>12 KB </td><td>12 KB </td></tr>
<tr>
<td>DSP </td><td>DSP Reserved </td><td>1204 KB </td><td>2148 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_UCODE </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>IMG </td><td>65 MB </td><td>65 MB </td></tr>
<tr>
<td>IAV </td><td>BSH </td><td>16 KB </td><td>16 KB </td></tr>
<tr>
<td>IAV </td><td>IAV Reserved </td><td>3160 KB </td><td>5 MB </td></tr>
<tr>
<td>IAV </td><td>BSB </td><td>32 MB </td><td>10 MB </td></tr>
<tr>
<td>IAV </td><td>Overlay </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>QP matrix </td><td>13 MB </td><td>13 MB </td></tr>
<tr>
<td>IAV </td><td>Privacy Mask </td><td>10 MB </td><td>8 MB </td></tr>
</table>
<h2><a class="anchor" id="sec_dram_s4k"></a>
3.2 Single 4K VIN</h2>
<h3><a class="anchor" id="dram_example_9"></a>
Example 9 Single VIN 4K with Stream Overlay and Single-color PM.</h3>
<p >This case uses a single 4Kp30 linear VIN input and 4Kp30 AVC + 1080p30 AVC + 4Kp1 MJPEG streams on encode mode 5. The largest overlay area is full screen (3840 x 2160) and the single-color privacy mask covers the full VIN (3840 x 2160).</p>
<p >Both CV5 and CV72 are used single core for IDSP and encoder. If CV5 uses dual core for IDSP and encoder, CV5 may take more DRAM size than CV72.</p>
<p >The Lua script can be found <a href="../../script/single_4k_vin.lua" target="_blank"><b>here</b></a>.</p>
<p >The following table lists the case for IAV / DSP DRAM layout: </p><dl class="section user"><dt>Single 4K VIN Case Memory Allocation for IAV and DSP</dt><dd><a class="anchor" id="single_4k_case_allocation"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Major </th><th>Sub1 </th><th>Sub2 </th><th>CV5 </th><th>CV72 </th></tr>
<tr>
<td rowspan="15"><b>IAV / DSP</b> </td><td></td><td><b>Total Size</b> </td><td><b>521 MB</b> </td><td><b>508 MB</b> </td></tr>
<tr>
<td><b>DSP</b> </td><td><b>DSP_BUFFER</b> </td><td><b>353 MB</b> </td><td><b>367 MB</b> </td></tr>
<tr>
<td>DSP </td><td>DSP_DEF_CMD </td><td>16 KB </td><td>32 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_LOG </td><td>4 MB </td><td>4 MB </td></tr>
<tr>
<td>IAV </td><td>Quant </td><td>12 KB </td><td>12 KB </td></tr>
<tr>
<td>DSP </td><td>DSP Reserved </td><td>1204 KB </td><td>2148 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_UCODE </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>IMG </td><td>65 MB </td><td>65 MB </td></tr>
<tr>
<td>IAV </td><td>BSH </td><td>16 KB </td><td>16 KB </td></tr>
<tr>
<td>IAV </td><td>IAV Reserved </td><td>3160 KB </td><td>5 MB </td></tr>
<tr>
<td>DSP </td><td>DSP_FIFO </td><td>60 KB </td><td>76 KB </td></tr>
<tr>
<td>IAV </td><td>BSB </td><td>32 MB </td><td>10 MB </td></tr>
<tr>
<td>IAV </td><td>Overlay </td><td>17 MB </td><td>17 MB </td></tr>
<tr>
<td>IAV </td><td>QP matrix </td><td>13 MB </td><td>13 MB </td></tr>
<tr>
<td>IAV </td><td>Privacy Mask </td><td>21 MB </td><td>12 MB </td></tr>
</table>
</dd></dl>
<h2><a class="anchor" id="sec_dram_s8k"></a>
3.3 Single 8K VIN</h2>
<h3><a class="anchor" id="dram_example_10"></a>
Example 10 Single VIN 8K with Stream Overlay and a Single-color PM.</h3>
<p >This case uses a single 8KP30 linear VIN and 8KP30 AVC stream on encode mode 0. The largest overlay area is full screen (7680 x 4320) and the single-color privacy mask covers the full VIN (7680 x 4320). Due to the HW limitation, CV72 can only support 8KP AVC and 8KP MJPEG encode at low frame rate, it <b>cannot</b> support 8KP HEVC encode.</p>
<p >Both CV5 and CV72 are used single core for IDSP and encoder. If CV5 uses dual core for IDSP and encoder, CV5 may take more DRAM size than CV72.</p>
<p >The Lua script can be found <a href="../../script/single_8k_vin.lua" target="_blank"><b>here</b></a>.</p>
<p >The following table lists the case for IAV / DSP DRAM layout:</p>
<dl class="section user"><dt>Single 8K VIN Case Memory Allocation for the IAV and DSP.</dt><dd><a class="anchor" id="single_8k_case_allocation"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Major </th><th>Sub1 </th><th>Sub2 </th><th>CV5 </th><th>CV72 </th></tr>
<tr>
<td rowspan="14"><b>IAV / DSP</b> </td><td></td><td><b>Total Size</b> </td><td><b>956 MB</b> </td><td><b>924 MB</b> </td></tr>
<tr>
<td><b>DSP</b> </td><td><b>DSP_BUFFER</b> </td><td><b>715 MB</b> </td><td><b>732 MB</b> </td></tr>
<tr>
<td>DSP </td><td>DSP_DEF_CMD </td><td>16 KB </td><td>32 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_LOG </td><td>4 MB </td><td>4 MB </td></tr>
<tr>
<td>IAV </td><td>Quant </td><td>12 KB </td><td>12 KB </td></tr>
<tr>
<td>DSP </td><td>DSP Reserved </td><td>1204 KB </td><td>2148 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_UCODE </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>IMG </td><td>65 MB </td><td>65 MB </td></tr>
<tr>
<td>IAV </td><td>BSH </td><td>16 KB </td><td>16 KB </td></tr>
<tr>
<td>IAV </td><td>IAV Reserved </td><td>3160 KB </td><td>5 MB </td></tr>
<tr>
<td>IAV </td><td>BSB </td><td>32 MB </td><td>10 MB </td></tr>
<tr>
<td>IAV </td><td>Overlay </td><td>32 MB </td><td>32 MB </td></tr>
<tr>
<td>IAV </td><td>QP matrix </td><td>13 MB </td><td>13 MB </td></tr>
<tr>
<td>IAV </td><td>Privacy Mask </td><td>79 MB </td><td>48 MB </td></tr>
</table>
</dd></dl>
<h2><a class="anchor" id="sec_dram_q5mp"></a>
3.4 Quad 5 MP VIN</h2>
<h3><a class="anchor" id="dram_example_11"></a>
Example 11 Quad VIN 5MP with Stream Overlay and a Single-color PM.</h3>
<p >This case has dual 5MP30 linear VIN and dual 5MP30 AVC streams on encode mode 5. If four streams need overlay and single-color PM, the largest overlay area must be full screen (2592 x 1944) and the single-color privacy mask covers the full VIN (2592 x 1944).</p>
<p >Both CV5 and CV72 are used single core for IDSP and encoder. If CV5 uses dual core for IDSP and encoder, CV5 may take more DRAM size than CV72.</p>
<p >The Lua script can be found <a href="../../script/quad_5m_vin.lua" target="_blank"><b>here</b></a>.</p>
<p >The following details show the memory allocation of the IAV / DSP sub-partitions. Note that the memory sizes listed in the following table are 4 KB-aligned.</p>
<p ><b>IMG</b> calculation: <br  />
 8 x 4 + 1 = 21 MB</p>
<p ><b>QPMATRIX</b> calculation: <br  />
 (128 x 20) x (1 + 4) = 10 MB</p>
<p ><b>Overlay</b> calculation:<br  />
 <a class="elRef" target="_blank" href="../../../library/d3/d5a/group__iav-common-helper.html#gad1b352de3b0722699205a3021bdbb615">ROUND_UP(2592, 64)</a> x 1944 x 2 + <a class="elRef" target="_blank" href="../../../library/d3/d5a/group__iav-common-helper.html#gad1b352de3b0722699205a3021bdbb615">ROUND_UP(1920, 64)</a> x 1080 = 19 MB</p>
<p ><b>Mask</b> calculation:<br  />
 ROUND_UP ((2592 / 8), 64) x 1944 x (1 + 4) x 4 = 10 MB.</p>
<p >The following table lists the IAV / DSP DRAM layout: </p><dl class="section user"><dt>Quad 5MP VIN Case Memory Allocation for the IAV and DSP.</dt><dd><a class="anchor" id="quad_5mp_case_allocation"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Major </th><th>Sub1 </th><th>Sub2 </th><th>CV5 </th><th>CV72 </th></tr>
<tr>
<td rowspan="14"><b>IAV / DSP</b> </td><td></td><td><b>Total Size</b> </td><td><b>734 MB</b> </td><td><b>744 MB</b> </td></tr>
<tr>
<td><b>DSP</b> </td><td><b>DSP_BUFFER</b> </td><td><b>576 MB</b> </td><td><b>599 MB</b> </td></tr>
<tr>
<td>DSP </td><td>DSP_DEF_CMD </td><td>16 KB </td><td>32 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_LOG </td><td>4 MB </td><td>4 MB </td></tr>
<tr>
<td>IAV </td><td>Quant </td><td>12 KB </td><td>12 KB </td></tr>
<tr>
<td>DSP </td><td>DSP Reserved </td><td>1204 KB </td><td>2148 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_UCODE </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>IMG </td><td>65 MB </td><td>65 MB </td></tr>
<tr>
<td>IAV </td><td>BSH </td><td>16 KB </td><td>16 KB </td></tr>
<tr>
<td>IAV </td><td>IAV Reserved </td><td>3160 KB </td><td>5 MB </td></tr>
<tr>
<td>IAV </td><td>BSB </td><td>32 MB </td><td>10 MB </td></tr>
<tr>
<td>IAV </td><td>Overlay </td><td>19 MB </td><td>20 MB </td></tr>
<tr>
<td>IAV </td><td>QP matrix </td><td>13 MB </td><td>13 MB </td></tr>
<tr>
<td>IAV </td><td>Privacy Mask </td><td>10 MB </td><td>15 MB </td></tr>
</table>
</dd></dl>
<h2><a class="anchor" id="sec_dram_q4k"></a>
3.5 Quad 4K VIN</h2>
<h3><a class="anchor" id="dram_example_12"></a>
Example 12 Quad VIN 4K with Stream Overlay and Single-color PM.</h3>
<p >This case uses the quad 4KP30 linear VIN and quad groups "4KP30 HEVC" streams on encode mode 5. If 12x streams must use the overlay and a single-color PM, the largest overlay area must be full screen (3840 x 2160) and the single-color privacy mask must cover the full VIN (3840 x 2160). Due to the HW limitation, CV72 can only support quad 4K HEVC encode at lower frame rate but not 30fps.</p>
<p >Both CV5 and CV72 are used single core for IDSP and encoder. If CV5 uses dual core for IDSP and encoder, CV5 may take more DRAM size than CV72.</p>
<p >The Lua script can be found <a href="../../script/quad_4k_vin.lua" target="_blank"><b>here</b></a>.</p>
<p >The following table lists the IAV / DSP DRAM layout: </p><dl class="section user"><dt>Quad 4K VIN Case Memory Allocation for the IAV and DSP</dt><dd><a class="anchor" id="quad_4k_case_allocation"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Major </th><th>Sub1 </th><th>Sub2 </th><th>CV5 </th><th>CV72 </th></tr>
<tr>
<td rowspan="14"><b>IAV / DSP</b> </td><td></td><td><b>Total Size</b> </td><td><b>1015 MB</b> </td><td><b>1035 MB</b> </td></tr>
<tr>
<td><b>DSP</b> </td><td><b>DSP_BUFFER</b> </td><td><b>833 MB</b> </td><td><b>845 MB</b> </td></tr>
<tr>
<td>DSP </td><td>DSP_DEF_CMD </td><td>16 KB </td><td>32 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_LOG </td><td>4 MB </td><td>4 MB </td></tr>
<tr>
<td>IAV </td><td>Quant </td><td>12 KB </td><td>12 KB </td></tr>
<tr>
<td>DSP </td><td>DSP Reserved </td><td>1024 KB </td><td>2148 KB </td></tr>
<tr>
<td>DSP </td><td>DSP_UCODE </td><td>11 MB </td><td>11 MB </td></tr>
<tr>
<td>IAV </td><td>IMG </td><td>65 MB </td><td>65 MB </td></tr>
<tr>
<td>IAV </td><td>BSH </td><td>16 KB </td><td>16 KB </td></tr>
<tr>
<td>IAV </td><td>IAV Reserved </td><td>3160 KB </td><td>5 MB </td></tr>
<tr>
<td>IAV </td><td>BSB </td><td>32 MB </td><td>10 MB </td></tr>
<tr>
<td>IAV </td><td>Overlay </td><td>31 MB </td><td>32 MB </td></tr>
<tr>
<td>IAV </td><td>QP matrix </td><td>13 MB </td><td>13 MB </td></tr>
<tr>
<td>IAV </td><td>Privacy Mask </td><td>21 MB </td><td>48 MB </td></tr>
</table>
</dd></dl>
<hr  />
<h1><a class="anchor" id="dram_opt_bandwidth"></a>
4. Bandwidth</h1>
<p >As bandwidth is an important data parameter, it is important to note bandwidth limitations. The following sections list the bandwidth limitations for the CV chip line.</p>
<ul>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv5">4.1 CV5 Bandwidth Limitation</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_cv52">4.2 CV52 Bandwidth Limitation</a> </li>
<li>
<a class="el" href="../../d4/d3e/page_sys_dram_opt_doc.html#sec_dram_band_opt">4.3 Bandwidth Optimization</a> </li>
</ul>
<h2><a class="anchor" id="sec_dram_cv5"></a>
4.1 CV5 Bandwidth Limitation</h2>
<dl class="section user"><dt>List of the Ambarella CV5 Bandwidth Limitations with LPDDR5</dt><dd><a class="anchor" id="dram_table_cv5_ddr5_bandwidth_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Chip ID </th><th>CV5S66 </th><th>CV5S88 </th></tr>
<tr>
<td>DDR frequency </td><td>2640 MHz </td><td>2808 MHz </td></tr>
<tr>
<td>Bitwidth </td><td>64 bits </td><td>64 bits </td></tr>
<tr>
<td>DDR efficiency </td><td>40% </td><td>40% </td></tr>
<tr>
<td>Bandwidth </td><td>16113 MB/s </td><td>17138 MB/s </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>List of the Ambarella CV5 Bandwidth Limitations with LPDDR4x</dt><dd><a class="anchor" id="dram_table_cv5_ddr4_bandwidth_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Chip ID </th><th>CV5S66 </th><th>CV5S88 </th></tr>
<tr>
<td>DDR frequency </td><td>1800 MHz </td><td>1800 MHz </td></tr>
<tr>
<td>Bitwidth </td><td>64 bits </td><td>64 bits </td></tr>
<tr>
<td>DDR efficiency </td><td>40% </td><td>40% </td></tr>
<tr>
<td>Bandwidth </td><td>10986 MB/s </td><td>10986 MB/s </td></tr>
</table>
</dd></dl>
<p>Refer to the computational formula provided below.</p>
<p ><b>Bandwidth</b> = <b>DDR Frequency x Bitwidth</b> / 8 x 2 x <b>DDR Efficiency</b> / 100 / 1.024 / 1.024</p>
<p >Using the CV2 Chestnut board as an example, the following shows the total DSP DRAM bandwidth for some of the typical use cases.</p>
<h3><a class="anchor" id="dram_example_13"></a>
Example 13 IMX274_mipi / Mode 5 / 4Kp H.265 + 1080p H.265 + 4Kp MJPEG (CV5_Timn).</h3>
<div class="fragment"><div class="line">board # init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_aaa_service -a&amp;</div>
<div class="line">board # test_encode --resource-cfg cv5_vin0_4k_linear.lua</div>
<div class="line">board # test_encode -A -H 3840x2160 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e -B -H 1920x1080 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -e -C -m 3840x2160 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 3 -e</div>
<div class="line">board # modprobe ambdram_statis</div>
<div class="line">board # echo duration=5000 interval=2500 verbose=1 &gt; /proc/ambarella/dram_statistics</div>
<div class="line">board # cat /proc/ambarella/dram_statistics</div>
<div class="line">[DRAM Info]</div>
<div class="line">  LPDDR5 with 64-<a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> @ 2808MHz, Burst Size: 64, theory BW: 42846 <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>/s</div>
<div class="line">[Average BW]</div>
<div class="line">  Module                Bandwidth(In MB/s)              Percent</div>
<div class="line">  -----------</div>
<div class="line">  Cortex                         7.572                   0.017</div>
<div class="line">  DSP                         4547.825                  10.614</div>
<div class="line">  VP                             0.000                   0.000</div>
<div class="line">  GDMA                           0.000                   0.000</div>
<div class="line">  ENET                           0.000                   0.000</div>
<div class="line">  Other                          0.000                   0.000</div>
<div class="line">  All                         4555.374                  10.631</div>
<div class="ttc" id="avin__init_8c_html_ad1e28a1a66a25529b0b61b9ca4e66d44"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a></div><div class="ttdeci">int bits</div></div>
</div><!-- fragment --><h2><a class="anchor" id="sec_dram_cv52"></a>
4.2 CV52 Bandwidth Limitation</h2>
<dl class="section user"><dt>List of the Ambarella CV52 Bandwidth Limitations with LPDDR5.</dt><dd><a class="anchor" id="dram_table_cv5_ddr5_bandwidth_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Chip ID </th><th>CV52S66 </th><th>CV52S33 </th></tr>
<tr>
<td>DDR frequency </td><td>2640 MHz </td><td>2640 MHz </td></tr>
<tr>
<td>Bitwidth </td><td>32 bits </td><td>32 bits </td></tr>
<tr>
<td>DDR efficiency </td><td>40% </td><td>40% </td></tr>
<tr>
<td>Bandwidth </td><td>8056 MB/s </td><td>8056 MB/s </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>List of the Ambarella CV52 Bandwidth Limitations with LPDDR4x</dt><dd><a class="anchor" id="dram_table_cv5_ddr4_bandwidth_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Chip ID </th><th>CV52S66 </th><th>CV52S33 </th></tr>
<tr>
<td>DDR frequency </td><td>1800 MHz </td><td>1800 MHz </td></tr>
<tr>
<td>Bitwidth </td><td>32 bits </td><td>32 bits </td></tr>
<tr>
<td>DDR efficiency </td><td>40% </td><td>40% </td></tr>
<tr>
<td>Bandwidth </td><td>5492 MB/s </td><td>5492 MB/s </td></tr>
</table>
</dd></dl>
<p>Refer to the computational formula provided below.</p>
<p ><b>Bandwidth</b> = <b>DDR Frequency x Bitwidth</b> / 8 x 2 x <b>DDR Efficiency</b> / 100 / 1.024 / 1.024</p>
<p >Using the CV52 Zr board as an example, the following shows the total DSP DRAM bandwidth for typical use cases.</p>
<h3><a class="anchor" id="dram_example_14"></a>
Example 14 IMX274_mipi / Mode 5 / 4Kp H.265 + 1080p H.265 + 4Kp MJPEG (CV52_zr).</h3>
<div class="fragment"><div class="line">board # init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_aaa_service -a&amp;</div>
<div class="line">board # test_encode --resource-cfg cv5_vin0_4k_linear.lua</div>
<div class="line">board # test_encode -A -H 3840x2160 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e -B -H 1920x1080 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -e -C -m 3840x2160 -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 3 -e</div>
<div class="line">board # modprobe ambdram_statis</div>
<div class="line">board # echo duration=5000 interval=2500 verbose=1 &gt; /proc/ambarella/dram_statistics</div>
<div class="line">board # cat /proc/ambarella/dram_statistics</div>
<div class="line">[DRAM Info]</div>
<div class="line">  LPDDR5 with 64-<a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> @ 2640MHz, Burst Size: 64, theory BW: 20141  <a class="code hl_defineRef" target="_blank" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>/s</div>
<div class="line">[Average BW]</div>
<div class="line">  Module                Bandwidth(In MB/s)              Percent</div>
<div class="line">  -----------</div>
<div class="line">  Cortex                        12.982                   0.064</div>
<div class="line">  DSP                         4475.721                  22.221</div>
<div class="line">  VP                             0.000                   0.000</div>
<div class="line">  GDMA                           0.000                   0.000</div>
<div class="line">  ENET                           0.000                   0.000</div>
<div class="line">  Other                          0.000                   0.000</div>
<div class="line">  All                         4488.680                  22.285</div>
</div><!-- fragment --><h2><a class="anchor" id="sec_dram_band_opt"></a>
4.3 Bandwidth Optimization</h2>
<p >The following guidelines provide users with details to optimize the DRAM bandwidth:</p><ul>
<li><b>Canvas</b>: Larger canvas size costs more DRAM bandwidth. Users should choose the suitable canvas size and disable unused canvases to save the DRAM bandwidth.</li>
<li><b>Pyramid</b>: The pyramid buffer usually is used by the CV algorithm. It supports up to 6x layers with various resolutions, and each layer can be independently enabled or disabled. Users can disable the unnecessary layers to save the DRAM bandwidth. In addition, using the pyramid manual-feed mode is recommended whenever the user application can control the feeding frame rate of the pyramid. If the processing frame rate of CV algorithm is lower than the VIN frame rate, the user application can lower this rate to reduce the DRAM bandwidth.</li>
<li><b>MCTF compression</b>: This option can be enabled through setting "mctf_cmpr" to 1 in the "chan_x" section of the Lua script. It is enabled by default to reduce the DRAM bandwidth.</li>
<li><b>Raw compression</b>: This option can be enabled through setting the "raw-capture" to 0 in the "chan_x" section of the Lua script. By default, raw compression is enabled to reduce the DRAM bandwidth. Users can disable it to dump the sensor raw data for debugging purposes.</li>
<li><b>Raw pack mode</b>: This option can be enabled through setting "packing_mode_enable" to 1 in the "chan_x" section of the Lua script. Users can enable this option to generate the packed raw image, which uses a lower DRAM bandwidth than the uncompressed raw image. Note that the raw pack mode and raw compression cannot be enabled simultaneously.</li>
</ul>
<hr  />
<h1><a class="anchor" id="dram_opt_license"></a>
5. License</h1>
<p >Copyright (C) 2024 Ambarella International LP</p>
<p >This file and its contents ("Software") are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP。</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
