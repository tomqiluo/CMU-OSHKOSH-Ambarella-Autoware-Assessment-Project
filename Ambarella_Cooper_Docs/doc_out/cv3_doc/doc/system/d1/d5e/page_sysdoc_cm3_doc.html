<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>System: BASE - CM3</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="System"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">System<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d1/d5e/page_sysdoc_cm3_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BASE - CM3 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cm3_history"></a>
0. Revision History</h1>
<a class="anchor" id="cm3_history_table"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Updated Date </th><th>Modification </th></tr>
<tr>
<td>20231115 </td><td>Initial Version </td></tr>
<tr>
<td>20231226 </td><td>Updated Section <a class="el" href="../../d1/d5e/page_sysdoc_cm3_doc.html#cm3_driver_rpmsg_board_config">4.1.1 Board Configuration</a> </td></tr>
</table>
<hr  />
 <h1><a class="anchor" id="cm3_overview"></a>
1. Overview</h1>
<p >The Cortex-M3 (CM3) processor is specifically developed for high-performance and low-cost platforms. This document provides an introduction on CM3 implementation.</p>
<hr  />
 <h1><a class="anchor" id="cm3_freertos"></a>
2. FreeRTOS</h1>
<p >CM3 runs on <code>FreeRTOS 202210 LTS</code>. Users can download it from <code><a href="https://github.com/FreeRTOS/FreeRTOS-LTS/tree/202210-LTS">https://github.com/FreeRTOS/FreeRTOS-LTS/tree/202210-LTS</a></code>.</p>
<hr  />
 <h1><a class="anchor" id="cm3_configuration"></a>
3. Configuration</h1>
<p >CM3 codes are located in <code>SDK/ambarella/boot/cm3</code> and <code>SDK/ambarella/boards/${board_name}/bsp/bsp_cm3.c</code>.</p>
<div class="fragment"><div class="line">build $ tree -L 1 ambarella/boot/cm3</div>
<div class="line">ambarella/boot/cm3</div>
<div class="line">├── AmbaConfig</div>
<div class="line">├── cv3ad685</div>
<div class="line">├── cv72</div>
<div class="line">├── doc</div>
<div class="line">├── FreeRTOS</div>
<div class="line">├── include</div>
<div class="line">├── license</div>
<div class="line">├── Makefile</div>
<div class="line">├── rpmsg-lite-master</div>
<div class="line">└── <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div></div>
</div><!-- fragment --><h2><a class="anchor" id="cm3_toolchain"></a>
3.1 Toolchain</h2>
<p >The toolchain <code>gcc-arm-none-eabi-10.3-2021.10</code> is used to build CM3. Users can download it from <code><a href="https://developer.arm.com/downloads/-/gnu-rm">https://developer.arm.com/downloads/-/gnu-rm</a></code>.</p>
<div class="fragment"><div class="line">build $ sudo tar -C /usr/local -xjvf gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar.bz2</div>
</div><!-- fragment --><h2><a class="anchor" id="cm3_board_config"></a>
3.2 Board Configuration</h2>
<div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    boot  ---&gt;</div>
<div class="line">        [*] cm3 (boot/ambamk)  ---&gt;</div>
<div class="line">            Cortex-M3 Configuration  ---&gt;</div>
<div class="line">                [*] BOOT Cortex-M3</div>
<div class="line">                (1) Cortex-M3 Log Console</div>
</div><!-- fragment --><p >The CM3 firmware is included in AMBoot.</p>
<hr  />
 <h1><a class="anchor" id="cm3_driver"></a>
4. Driver</h1>
<h2><a class="anchor" id="cm3_driver_rpmsg"></a>
4.1 Remote Processor Messaging Framework</h2>
<p >There are several remote processor messaging (RPMsg) frameworks available. Currently, only RPMsg-Lite is ported. Users can download it from <code><a href="https://github.com/nxp-mcuxpresso/rpmsg-lite">https://github.com/nxp-mcuxpresso/rpmsg-lite</a></code>.</p>
<p >The remote processor (RPROC) framework manages the resources required by the RPMsg framework.</p>
<h3><a class="anchor" id="cm3_driver_rpmsg_board_config"></a>
4.1.1 Board Configuration</h3>
<ol type="1">
<li><p class="startli">Boot option</p>
<p class="startli">If <code>Boot with TrustZone</code> is selected, secure boot should be enabled and power-on configuration (POC) pin 6 should be pulled up.</p>
<div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    boot  ---&gt;</div>
<div class="line">        [*] amboot (boot/ambamk)  ---&gt;</div>
<div class="line">            Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">                AMBoot Options  ---&gt;</div>
<div class="line">                    [*] Boot with TrustZone  ---&gt;</div>
<div class="line">                        [*]   Secure Boot with Signature</div>
<div class="line">                        [*]   Secure DTB with Signature (SOC Firmware Config)</div>
</div><!-- fragment --></li>
<li><p class="startli">Shared memory</p>
<div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    boot  ---&gt;</div>
<div class="line">        [*] cm3 (boot/ambamk)  ---&gt;</div>
<div class="line">            Drivers  ---&gt;</div>
<div class="line">                [*] RPMsg Driver  ---&gt;</div>
<div class="line">                    (0x60000000) Cortex-M3 Shared Memory Address</div>
<div class="line">                    (0xC0000000) Cortex-M3 Shared Memory Remap Address</div>
<div class="line">                    (0x100000) Cortex-M3 Shared Memory Remap Size</div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="cm3_driver_rpmsg_kernel_config"></a>
4.1.2 Kernel Configuration</h3>
<div class="fragment"><div class="line">build $ make linux_menuconfig</div>
<div class="line">    Device Drivers  ---&gt;</div>
<div class="line">        Remoteproc drivers  ---&gt;</div>
<div class="line">            [*] Support <span class="keywordflow">for</span> Remote Processor subsystem</div>
<div class="line">            &lt;M&gt;   Ambarella remoteproc support</div>
<div class="line">        Rpmsg drivers  ---&gt;</div>
<div class="line">            &lt;M&gt; RPMSG device interface</div>
<div class="line">            -*- RPMSG <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a> service announcement</div>
<div class="line">            &lt;*&gt; Virtio RPMSG bus driver</div>
<div class="ttc" id="acJSON_8h_html_a25d22ecc7e656d2c59332072684e8766"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a></div><div class="ttdeci">const char *const name</div></div>
</div><!-- fragment --><h3><a class="anchor" id="cm3_driver_rpmsg_device_tree"></a>
4.1.3 Device Tree</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#define VDEV0_VRING0_ADDRESS        (CONFIG_CORTEX_M3_REMAP_ADDRESS)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_VRING0_SIZE           (0x8000)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_VRING1_ADDRESS        (VDEV0_VRING0_ADDRESS + VDEV0_VRING0_SIZE)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_VRING1_SIZE           (0x8000)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_BUFFER_ADDRESS        (VDEV0_VRING1_ADDRESS + VDEV0_VRING1_SIZE)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_BUFFER_SIZE           (0x10000)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_RSC_TABLE_SIZE        (0x1000)</span></div>
<div class="line"><span class="preprocessor">#define VDEV0_RSC_TABLE_ADDRESS     (CONFIG_CORTEX_M3_REMAP_ADDRESS + \</span></div>
<div class="line"><span class="preprocessor">                                     CONFIG_CORTEX_M3_REMAP_SIZE - VDEV0_RSC_TABLE_SIZE)</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_variableRef" target="_blank" href="../../../driver/df/dc0/group__IAV.html#ga60ef8bae6f4bb3dc7582a4ff861f2d36">reserved</a>-memory {</div>
<div class="line">    vdev0vring0: vdev0vring0 {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">        reg = &lt;(VDEV0_VRING0_ADDRESS &gt;&gt; 32) (VDEV0_VRING0_ADDRESS &amp; 0xffffffff)</div>
<div class="line">               (VDEV0_VRING0_SIZE &gt;&gt; 32) (VDEV0_VRING0_SIZE &amp; 0xffffffff)&gt;;</div>
<div class="line">        no-map;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    vdev0vring1: vdev0vring1 {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">        reg = &lt;(VDEV0_VRING1_ADDRESS &gt;&gt; 32) (VDEV0_VRING1_ADDRESS &amp; 0xffffffff)</div>
<div class="line">               (VDEV0_VRING1_SIZE &gt;&gt; 32) (VDEV0_VRING1_SIZE &amp; 0xffffffff)&gt;;</div>
<div class="line">        no-map;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    vdev0buffer: vdev0buffer {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">        reg = &lt;(VDEV0_BUFFER_ADDRESS &gt;&gt; 32) (VDEV0_BUFFER_ADDRESS &amp; 0xffffffff)</div>
<div class="line">               (VDEV0_BUFFER_SIZE &gt;&gt; 32) (VDEV0_BUFFER_SIZE &amp; 0xffffffff)&gt;;</div>
<div class="line">        no-map;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    rsc_table: rsc-table {</div>
<div class="line">        reg = &lt;(VDEV0_RSC_TABLE_ADDRESS &gt;&gt; 32) (VDEV0_RSC_TABLE_ADDRESS &amp; 0xffffffff)</div>
<div class="line">               (VDEV0_RSC_TABLE_SIZE &gt;&gt; 32) (VDEV0_RSC_TABLE_SIZE &amp; 0xffffffff)&gt;;</div>
<div class="line">        no-map;</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="ttc" id="agroup__IAV_html_ga60ef8bae6f4bb3dc7582a4ff861f2d36"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga60ef8bae6f4bb3dc7582a4ff861f2d36">reserved</a></div><div class="ttdeci">u16 reserved</div></div>
</div><!-- fragment --><div class="fragment"><div class="line"> cv72-cm3 {</div>
<div class="line">     compatible = <span class="stringliteral">&quot;ambarella,cv72-cm3&quot;</span>;</div>
<div class="line">     interrupts = &lt;0 23 0x1&gt;, &lt;0 24 0x1&gt;;</div>
<div class="line">     interrupt-names = <span class="stringliteral">&quot;vq0&quot;</span>, <span class="stringliteral">&quot;vq1&quot;</span>;</div>
<div class="line">     clocks = &lt;&amp;gclk_axi&gt;;</div>
<div class="line">     amb,scr-regmap = &lt;&amp;ca76_scratchpad_syscon&gt;;</div>
<div class="line">     amb,axi-regmap = &lt;&amp;s_axi_private</div>
<div class="line">                       (CONFIG_CORTEX_M3_SHMEM_ADDRESS)</div>
<div class="line">                       (CONFIG_CORTEX_M3_REMAP_ADDRESS &gt;&gt; 32)</div>
<div class="line">                       (CONFIG_CORTEX_M3_REMAP_ADDRESS &amp; 0xffffffff)</div>
<div class="line">                       (CONFIG_CORTEX_M3_REMAP_SIZE)&gt;;</div>
<div class="line">     amb,nscr-regmap = &lt;&amp;n_scratchpad_syscon 0x2000&gt;;</div>
<div class="line">     memory-region = &lt;&amp;vdev0buffer&gt;, &lt;&amp;vdev0vring0&gt;, &lt;&amp;vdev0vring1&gt;, &lt;&amp;rsc_table&gt;;</div>
<div class="line">     amb,<span class="keyword">auto</span>-boot = &lt;1&gt;;</div>
<div class="line">     status = <span class="stringliteral">&quot;okay&quot;</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="cm3_driver_rpmsg_unit_test"></a>
4.1.4 Unit Test</h3>
<p >The unit test code is located in <code>SDK/ambarella/unit_test/linux/misc/test_cm3_rpmsg.c</code>.</p>
<div class="fragment"><div class="line">ca76 # modprobe ambarella_remoteproc</div>
<div class="line">ca76 # test_cm3_rpmsg create /dev/rpmsg_ctrl0 rpmsg-client-sample 1024 1</div>
<div class="line">create endpoints</div>
<div class="line">endpoint created</div>
<div class="line">ca76 # test_cm3_rpmsg test /dev/rpmsg0 -l 1000 -d 20 -s 492</div>
<div class="line">test mode <span class="keyword">using</span> endpoints</div>
<div class="line">devpath=/dev/rpmsg0, loop=1000,send_dly=20, payload_sz=492</div>
<div class="line">Results:</div>
<div class="line">roundtrip: 8 bytes, costs 178 us</div>
<div class="line">send only: 1000 messages payload size 492, costs 76562 us</div>
<div class="line">receive only: 1000 messages payload size 492, costs 140996 us</div>
</div><!-- fragment --><h2><a class="anchor" id="cm3_driver_spi"></a>
4.2 Serial Peripheral Interface</h2>
<p >CM3 implements a slave serial peripheral interface (SPI) device to communicate with a master SPI device, such as microcontroller unit (MCU).</p>
<h3><a class="anchor" id="cm3_driver_spi_device_tree"></a>
4.2.1 Device Tree</h3>
<div class="fragment"><div class="line">&amp;slavespi {</div>
<div class="line">    status = <span class="stringliteral">&quot;disabled&quot;</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="cm3_driver_spi_unit_test"></a>
4.2.2 Unit Test</h3>
<p >CM3 waits for data from the MCU.</p>
<div class="fragment"><div class="line">cm3=&gt; spi -l 128 sspi</div>
<div class="line">fill data [128] cheksum: 0x1f41</div>
</div><!-- fragment --><p >The MCU sends 128-bit data to CM3.</p>
<div class="fragment"><div class="line">Shell&gt; spi 0</div>
</div><!-- fragment --><hr  />
 <h1><a class="anchor" id="cm3_license"></a>
5. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
