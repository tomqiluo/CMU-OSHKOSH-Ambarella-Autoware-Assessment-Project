<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Library: Cavalry_Mem Library API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Library"/>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="../../../library/mathjax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Library<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d42/page_lib_cavalry_mem_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Cavalry_Mem Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cavalry_mem_history"></a>
0. Revision History</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Library Version   </th><th class="markdownTableHeadLeft">Updated Date   </th><th class="markdownTableHeadLeft">Modification    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">0.0.4   </td><td class="markdownTableBodyLeft">20190829   </td><td class="markdownTableBodyLeft">Initial Version    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">0.0.5   </td><td class="markdownTableBodyLeft">20190417   </td><td class="markdownTableBodyLeft">Support auto recycle leak cavalry memory    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">0.0.5   </td><td class="markdownTableBodyLeft">20190417   </td><td class="markdownTableBodyLeft">Add API <a class="el" href="../../d3/dbf/group__cavalry__mem-api-details.html#ga1100f66c7e1c13806eac1ff6e1c993cc">cavalry_mem_alloc_persist()</a> to turn off auto recycle memory in some case    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">0.0.6   </td><td class="markdownTableBodyLeft">20190426   </td><td class="markdownTableBodyLeft">Support dma-buf:fd for cavalry memory    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">0.0.7   </td><td class="markdownTableBodyLeft">20190607   </td><td class="markdownTableBodyLeft">Add API <a class="el" href="../../d3/dbf/group__cavalry__mem-api-details.html#ga172c026d2b7fd5fd55ce42ec0e39968b">cavalry_mem_get_fd()</a>   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="cavalry_mem_introduction"></a>
1. Introduction</h1>
<p >Cavalry_Mem is used for users to allocate physical continuous memory in CV region. Because CVflow™ Hardware only recognizes physical memory. User application should map this physical memory to user space as virtual memory, then can write and read this memory. It supports mapping as cached memory in user space, then boost Arm® process on it. Make sure to sync (clean / invalid) cached memory when VP and Arm cross access it.</p>
<hr  />
<h1><a class="anchor" id="cavalry_mem_example"></a>
2. Example Usage</h1>
<p >It will show how to allocate and free memory, and get the benefit of Arm process when enabling cache. Since Cavalry_Mem is based on the Cavalry driver, users should enable the Cavalry driver firstly, then enable cavalry memory library. Follow these commands to build the library:</p>
<ul>
<li>For CV2x SDK 3.0 Amba build <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Package Configuration  ---&gt;</div>
<div class="line">             [*]   Build Ambarella cavalry memory library</div>
</div><!-- fragment --></li>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         packages  ---&gt;</div>
<div class="line">             [*] libcavalrymem (packages/cavalry_mem)</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         meta-ambalib  ---&gt;</div>
<div class="line">             recipes-cavalry  ---&gt;</div>
<div class="line">                 [*] libcavalrymem (meta-ambalib/recipes-cavalry/libcavalrymem)</div>
</div><!-- fragment --> </li>
</ul>
<h2><a class="anchor" id="cavalry_mem_usage"></a>
2.1 Debug Information</h2>
<ul>
<li>Get the usage of the CV user memory.<br  />
 There is <code>/proc/ambarella/cavalry_cma</code> proc file can show the current used memory block. The MMB ID 0000 is internal memory (6 MB) which users do not need to take care of. <div class="fragment"><div class="line">board # test_cavalry_mem -g</div>
<div class="line">Usage mem: used size: 0x0, free size: 0x1fa00000</div>
<div class="line">board # cat /proc/ambarella/cavalry_cma</div>
<div class="line">mmb   phys[start-end]        size        kern-virt[start-end]                   ref_cnt  cache  recycle  pid</div>
<div class="line">0000  0x60000000-0x60400000  0x00400000  0x0000000059215c4e-0x0000000065950971</div>
<div class="line">----</div>
<div class="line"> </div>
<div class="line">Free list <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>: 1, max contiguous free size: 0x1fc00000</div>
<div class="line">Total Cavalry memory size: 0x20000000 (about 512MB), used size: 0x400000 (about 4MB)</div>
<div class="line"> </div>
<div class="line">Cavalry Status: Started</div>
<div class="ttc" id="acJSON_8h_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="../../d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div><div class="ttdeci">int count</div><div class="ttdef"><b>Definition:</b> cJSON.h:216</div></div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="cavalry_mem_alloc"></a>
2.2 Allocate Memory</h2>
<ul>
<li>Allocates a specified size memory.<br  />
 The driver will return a PAGE (4 KB) aligned size of memory. <div class="fragment"><div class="line">board # test_cavalry_mem -s 0x100000</div>
<div class="line">Alloc cv_mem addr: 0x60400000, size: 0x100000, cache: 0, auto_recycle: 0</div>
<div class="line">board # cat /proc/ambarella/cavalry_cma</div>
<div class="line">mmb   phys[start-end]        size        kern-virt[start-end]                   ref_cnt  cache  recycle  pid</div>
<div class="line">0000  0x60000000-0x60400000  0x00400000  0x0000000059215c4e-0x0000000065950971</div>
<div class="line">----</div>
<div class="line">0001  0x60400000-0x60500000  0x00100000  0x00000000821c3d7b-0x0000000081b84e31  0        0      0    727588(Dead)</div>
<div class="line"> </div>
<div class="line">Free list <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>: 1, max contiguous free size: 0x1fb00000</div>
<div class="line">Total Cavalry memory size: 0x20000000 (about 512MB), used size: 0x500000 (about 5MB)</div>
<div class="line"> </div>
<div class="line">Cavalry Status: Started</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="cavalry_mem_free"></a>
2.3 Free Memory</h2>
<ul>
<li>Frees up a specified physical address memory block.<br  />
 Physical address is used as memory block ID. It frees the whole size of the memory block at once. <div class="fragment"><div class="line">board # test_cavalry_mem -d 0x60400000</div>
<div class="line">Free cv_mem addr: 0x60400000</div>
<div class="line">board # cat /proc/ambarella/cavalry_cma</div>
<div class="line">mmb   phys[start-end]        size        kern-virt[start-end]                   ref_cnt  cache  recycle  pid</div>
<div class="line">0000  0x60000000-0x60400000  0x00400000  0x0000000059215c4e-0x0000000065950971</div>
<div class="line">----</div>
<div class="line"> </div>
<div class="line">Free list <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>: 1, max contiguous free size: 0x1fc00000</div>
<div class="line">Total Cavalry memory size: 0x20000000 (about 512MB), used size: 0x400000 (about 4MB)</div>
<div class="line"> </div>
<div class="line">Cavalry Status: Started</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="cavalry_mem_sync_cache"></a>
2.4 Sync Cached Memory</h2>
<p >It can improve the memory access performance in user space applications. The user needs to clean or invalidate cache memory while it is enabled. The following example shows that cached memory gets a better performance than non-cached memory. A larger memory gets better results. The example below uses 32 MB DRAM, and it shows cached access is seven times faster than non-cached access. </p><div class="fragment"><div class="line">board # test_cavalry_mem -m 0x2000000</div>
<div class="line">[non-cache], memory size: 0x2000000</div>
<div class="line">ARM Write : 13395 us</div>
<div class="line">ARM Read  : 293028 us</div>
<div class="line">board # test_cavalry_mem -m 0x2000000 -c</div>
<div class="line">[cache], memory size: 0x2000000</div>
<div class="line">ARM Write : 16403 us</div>
<div class="line">ARM Read  : 26088 us</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="sec_cavalry_mem_api"></a>
3. Cavalry_Mem API</h1>
<p >Visit the following link to see details of the API function.</p><ul>
<li><a class="el" href="../../d3/dbf/group__cavalry__mem-api-details.html">Cavalry_Mem Library API details</a> shows API lists.</li>
<li><a class="el" href="../../d2/d60/group__cavalry__mem-helper.html">Cavalry_Mem Library API helper</a> shows related macros enumerations and structures.</li>
</ul>
<hr  />
<h1><a class="anchor" id="sec_cavalry_mem_lic"></a>
4. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
