<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Library: Image Flow Library API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Library"/>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="../../../library/mathjax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Library<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d4f/page_lib_img_flow_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Image Flow Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="img_flow_history"></a>
0. Revision History</h1>
<a class="anchor" id="img_flow_rev_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Version</th><th>Updated Date</th><th align="left">Modification </th></tr>
<tr>
<td>0.0.1</td><td>20240124</td><td>Initial Version </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="img_flow_introduction"></a>
1. Introduction</h1>
<p >The img_flow library is a AE / AWB / ADJ (3A) middleware that is responsible for connecting image signal processor (ISP) library and 3A related upper level applications (apps). To address the increasingly strong demand for the requests below, Ambarella brings up this new method to run AAA flow:</p><ul>
<li>No need to port the 3A flow source code from the sample code</li>
<li>No need to refactor users' own 3A flow after the 3A algorithm is upgraded</li>
<li>To support multiple video input (multi-VIN) cases better for different VIN types</li>
<li>Assemble all functions and testing / tuning tools into one test application</li>
</ul>
<p >In the diagram as shown below, the Level 3 is the middle layer that sits between the kernel layer and the application layer. The img_flow library and ISP library are at the same level. The ISP libraries include img_algo and img_dsp, which provide low / high level interfaces to img_flow library. </p><div class="image">
<img src="../../ambarella_system_diagram_1202x491.png" alt=""/>
<div class="caption">
Figure 1-1. System Diagram.</div></div>
<p >To make it easier to use the img_flow library, Ambarella provides an application named <em>test_aaa_service</em> that calls the library to run 3A flow. Together with the application <em>test_aaa_service</em>, the image library can do these things listed below:</p><ul>
<li>Contain basic 3A flow</li>
<li>Start / stop the 3A flow with Netlink</li>
<li>Load image quality (IQ) parameters adaptively for multi-VIN case</li>
<li>Start / stop Amage server</li>
<li>Control 3A with interactive menu by calling image flow APIs</li>
<li>Load calibration data, including automatic white balance (AWB) / lens shading / BPC / CA</li>
<li>Load product_config lua for a particular product</li>
<li>Support smooth IQ transition from Ambarella real-time operating system (AMRTOS) fastboot to Linux 3A</li>
<li>Support infrared (IR) process</li>
<li>Support slow shutter process</li>
<li>Embody automatic exposure（AE）timing tool</li>
<li>Embody sample code of calling 3A application programming interfaces (APIs)</li>
</ul>
<p >From now on, users can use ISP library conveniently and easily to maintain or upgrade their own code. There is no need to port the AAA flow source code from the sample code.</p>
<p >What users are required to do is to call two APIs: <a class="el" href="../../df/d39/group__img__flow-api-details.html#ga36d4ee0838cca3a63043a472ba5abbb2">create_img_flow()</a> and <a class="el" href="../../df/d39/group__img__flow-api-details.html#ga5d8f3a8fe6de709aa0bd5951e053662e">destroy_img_flow()</a> that listed in the <code><a class="el" href="../../d3/d95/img__flow__api_8h.html" title="This file defines basic Image Flow Library APIs.">img_flow_api.h</a></code> file.</p>
<p >At the same time, img_flow library is released by the source code as a whole module, which is built as <em>libimg_aaa_flow_v6.so</em> for applications.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Image flow Library can only be used by one app at the same time. That means only one app can control 3A at the same time.</li>
</ul>
</dd></dl>
<hr  />
<h1><a class="anchor" id="img_flow_usage"></a>
2. Image Flow Usage</h1>
<p >The usage of img_flow library and <em>test_aaa_service</em> application program is provided as shown below:</p><ul>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_enable">2.1 How to Enable Image Flow Library</a></li>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_run_app">2.2 How to Run test_aaa_service Application</a></li>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_advanced_func">2.3 How to Use Image Flow Library Better</a></li>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_lua_file">2.4 How to Make Lua Files for Multi-channel Cases</a></li>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_add_new_app_type">2.5 How to Add a New Sensor or an Application Type</a><ul>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_add_type">2.5.1 How to Add a New Application Type</a></li>
<li>Section <a class="el" href="../../d5/d4f/page_lib_img_flow_doc.html#img_flow_lib_usage_add_sensor">2.5.2 How to Add a New Sensor</a></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="img_flow_lib_usage_enable"></a>
2.1 How to Enable Image Flow Library</h2>
<p >There are two steps to enable the img_flow library: configuring menuconfig and running sample application.</p>
<p ><b>Step 1: Configure menuconfig</b></p>
<ol type="1">
<li>Enable the Img_aaa_flow library</li>
</ol>
<ul>
<li>For Cooper Amba build <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    packages  ---&gt;</div>
<div class="line">        idsp  ---&gt;</div>
<div class="line">            [*] libimgflow (packages/idsp/img_flow)</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    meta-ambalib ---&gt;</div>
<div class="line">        recipes-video ---&gt;</div>
<div class="line">            [*] libimgflow (meta-ambalib/recipes-video/libimgflow)</div>
</div><!-- fragment --></li>
</ul>
<ol type="1">
<li>Select IPC / DVR / DMS / ADAS / BWC / ITS / OMC / STEREO type needed</li>
</ol>
<ul>
<li>For Cooper Amba build <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    meta-ambalib  ---&gt;</div>
<div class="line">     [*] sensor-datas@<span class="keyword">virtual</span> (meta-ambalib/recipes-sensor) ---&gt;</div>
<div class="line">           [*]   ipc-sensor-datas@<span class="keyword">virtual</span> (meta-ambalib/recipes-sensor/IPC) ---&gt;</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   packages ---&gt;</div>
<div class="line">      idsp ---&gt;</div>
<div class="line">         [*] sensor-datas@<span class="keyword">virtual</span> (packages/idsp/data/img_cv5x)  ---&gt;</div>
<div class="line">              [*]   ipc-sensor-datas@<span class="keyword">virtual</span> (packages/idsp/data/img_cv5x/IPC)  ---&gt;</div>
</div><!-- fragment --></li>
</ul>
<p ><b>Step 2: Run the sample test application</b></p>
<p >In order to demonstrate the usage of the img_flow library, a sample application that can be executed directly is provided. The <em>test_aaa_service</em> is the sample test application that can be executed by running the commands below: </p><div class="fragment"><div class="line">board # init.sh --na; modprobe &lt;sensor_name&gt; vinc_id=8 bus_id=3</div>
<div class="line">board # test_aaa_service -a&amp;</div>
<div class="line">board # test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua</div>
<div class="line">                    --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua --app-img-profile 4</div>
</div><!-- fragment --><p >Note: The option <code>app-img-profile</code> specifies the application type with an enumerated value </p><a class="anchor" id="the app-img-profile enumeration"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Option Value</th><th>Abbreviation</th><th align="left">Details </th></tr>
<tr>
<td>0</td><td>IPC</td><td>Internet protocol camera </td></tr>
<tr>
<td>1</td><td>BWC</td><td>Body wearing camera </td></tr>
<tr>
<td>2</td><td>ITS</td><td>Intelligent transportation system </td></tr>
<tr>
<td>3</td><td>DVR</td><td>Digital video recorder </td></tr>
<tr>
<td>4</td><td>DMS</td><td>Driver monitoring system </td></tr>
<tr>
<td>5</td><td>ADAS</td><td>Advanced driver assistance system </td></tr>
<tr>
<td>6</td><td>OMC</td><td>Occupant monitoring camera </td></tr>
<tr>
<td>8</td><td>STEREO</td><td>Stereoscopic vision </td></tr>
<tr>
<td>10</td><td>ROBOT</td><td>Robot vision </td></tr>
</table>
<h2><a class="anchor" id="img_flow_lib_usage_run_app"></a>
2.2 How to Run test_aaa_service Application</h2>
<p >The application <em>test_aaa_service</em> is an upper layer application for img_flow library. In order to use img_flow library more efficiently and conveniently, the <em>test_aaa_service</em> provides the sample code for calling the associated APIs. The application executes different actions depending on the input parameters.</p>
<p >The available options of <em>test_aaa_service</em> are listed as follows: </p><pre class="fragment">  -a Auto configuration
  -c Calibration mode
  -d Debug IK for internal
  -i Interactive mode
  -p Load product configuration
  -s String display on screen</pre><table class="doxtable">
<caption></caption>
<tr>
<th>test_aaa_service options</th><th>Comment </th></tr>
<tr>
<td>test_aaa_service -a</td><td>Run 3A flow with default configuration parameters </td></tr>
<tr>
<td>test_aaa_service -c</td><td>Calibration mode. The functions supported in this mode are as follows:<ul>
<li>Calculate 3A timing</li>
<li>Calculate vignette calibration</li>
<li>Calculate AWB calibration</li>
<li>Calculate bad pixel calibration</li>
<li>Calculate CA calibration </li>
</ul>
</td></tr>
<tr>
<td>test_aaa_service -d</td><td>Debug mode for internal use. </td></tr>
<tr>
<td>test_aaa_service -i</td><td><p class="starttd">Interactive mode. The operations supported in this mode are as follows:</p><ul>
<li>Global settings</li>
<li>Exposure control settings</li>
<li>White balance settings</li>
<li>Image adjustment settings</li>
</ul>
<p class="endtd">Detailed options information has been provided, and users can follow the prompts for relevant actions. </p>
</td></tr>
<tr>
<td>test_aaa_service -p</td><td><p class="starttd">Load product configuration from specified lua file, such as:</p>
<p class="endtd"><code>test_aaa_service -p /usr/share/ambarella/idsp/product_config.lua</code> </p>
</td></tr>
<tr>
<td>test_aaa_service -s</td><td>Display some 3A parameters on the image stream </td></tr>
</table>
<h2><a class="anchor" id="img_flow_lib_usage_advanced_func"></a>
2.3 How to Use Image Flow Library Better</h2>
<p >There is a configuration lua file for 3A in the image flow library. The lua file is named as <em>aaa_iq_config.lua</em>, which is at the path <code>/usr/share/ambarella/idsp/</code> on the EVK board.</p>
<ul>
<li>For CV3, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv3/</code>.</li>
<li>For CV5, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv5x/</code>.</li>
<li>For CV72, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv72/</code>.</li>
</ul>
<p >The main configuration options supported in <em>aaa_ia_config.lua</em> are as below: </p><a class="anchor" id="aaa_iq_config.lua options"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>aaa_iq_config.lua options</th><th>Comment </th></tr>
<tr>
<td>use_amba_default_aaa_config</td><td><p class="starttd">0: use 3A configuration in this lua;</p>
<p class="endtd">1: bypass this lua and use default 3A configuration. </p>
</td></tr>
<tr>
<td>preload_enable</td><td><p class="starttd">0: disable preload and save;</p>
<p class="endtd">1: enable preload and save </p>
</td></tr>
<tr>
<td>load_adj_data_mode</td><td><p class="starttd">0: load default binary;</p>
<p class="endtd">1: load customer aeb binary: <code>adj_param_binary_file_name = "/usr/share/ambarella/idsp/adj_param.bin"</code> </p>
</td></tr>
<tr>
<td>load_aeb_data_mode</td><td><p class="starttd">0: load default binary;</p>
<p class="endtd">1: load customer aeb binary: <code>aeb_param_binary_file_name = "/usr/share/ambarella/idsp/aeb_param.bin"</code> </p>
</td></tr>
<tr>
<td>load_sbp_calibration_load_mode</td><td><p class="starttd">-1: do not load;</p>
<p class="intertd">0: load default binary;</p>
<p class="endtd">1: load customer binary: <code>sbp_calibration_binary_file_name = "/usr/share/ambarella/idsp/cali/bad_pixel.bin"</code> </p>
</td></tr>
<tr>
<td>load_vignette_calibration_load_mode</td><td><p class="starttd">-1: do not load;</p>
<p class="intertd">0: load default binary;</p>
<p class="endtd">1: load customer binary: <code>vignette_calibration_binary_file_name = "/usr/share/ambarella/idsp/cali/lens_shading.bin"</code> </p>
</td></tr>
</table>
<p >The source code for img_flow library and application <em>test_aaa_service</em> may be modified during using or debugging. Just recompiling and replacing the related binaries would be fine for test and no need to reload the whole firmware:</p><ul>
<li>The latest application <em>test_aaa_service</em> shall be replaced at <code>/usr/local/bin/</code> if the test_aaa_service is modified;</li>
<li>The latest library <em>libimg_aaa_flow_v6.so</em> shall be replaced at <code>/usr/lib/</code> if source code for img_aaa_flow or img_algo is modified;</li>
<li>The latest bin files of <em>AEB / ADJ /CC</em> shall be replaced at <code>/usr/share/ambarella/idsp/&lt;app_name&gt;/</code> if AEB / ADJ / CC files are modified.</li>
</ul>
<h2><a class="anchor" id="img_flow_lib_usage_lua_file"></a>
2.4 How to Make Lua Files for Multi-channel Cases</h2>
<p >Users will need a corresponding lua configuration for multi-channel cases. In this case, two (or three) single-channel lua files can be assembled into one to make it work.</p>
<p >Take OV2775-OV2778-OV9284 three-channel case as an example:</p>
<p ><b>Step 1: Clarify the correspondence between channels and sensors</b> In this case: </p><pre class="fragment">  channel_0: ov2775 --&gt; DVR
  channel_1: ov2778 --&gt; OMS
  channel_2: ov9284 --&gt; DMS</pre><p ><b>Step 2: Get the configuration file for each sensor in a single channel case</b></p>
<ul>
<li>For CV3, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv3/config/</code>.</li>
<li>For CV5, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv5x/config/</code>.</li>
<li>For CV72, the file <em>aaa_iq_config.lua</em> is at the path: <code>ambarella/packages/idsp/img_flow/img_cv72/config/</code>.</li>
</ul>
<p >The active channel would be 'channel_0' by default for single-channel cases, thus the configuration parameters are in section 'channel_0'.</p><ul>
<li>Single-channel <em>aaa_iq_config.lua</em> for OV2775 <div class="fragment"><div class="line">global = {</div>
<div class="line">   version = 0xffff, --the version of config file(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   mod = 0x202009011, --the modified date(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   amage_server_enable = 1, --1:enable Amage server; 0:disable Amage server</div>
<div class="line">   preload_enable = 0, --0:disable preload and save; 1:enable preload and save</div>
<div class="line">}</div>
<div class="line">channel_0 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV2775</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
<div class="ttc" id="acJSON_8h_html_adb411a44855a4c49231d72a0fc9a3b3b"><div class="ttname"><a href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a></div><div class="ttdeci">char const int const cJSON_bool format</div><div class="ttdef"><b>Definition:</b> cJSON.h:163</div></div>
</div><!-- fragment --></li>
<li>Single-channel <em>aaa_iq_config.lua</em> for OV2778 <div class="fragment"><div class="line">global = {</div>
<div class="line">   version = 0xffff, --the version of config file(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   mod = 0x202009011, --the modified date(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   amage_server_enable = 1, --1:enable Amage server; 0:disable Amage server</div>
<div class="line">   preload_enable = 0, --0:disable preload and save; 1:enable preload and save</div>
<div class="line">}</div>
<div class="line">channel_0 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV2778</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Single-channel <em>aaa_iq_config.lua</em> for OV9284 <div class="fragment"><div class="line">global = {</div>
<div class="line">   version = 0xffff, --the version of config file(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   mod = 0x202009011, --the modified date(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   amage_server_enable = 1, --1:enable Amage server; 0:disable Amage server</div>
<div class="line">   preload_enable = 0, --0:disable preload and save; 1:enable preload and save</div>
<div class="line">}</div>
<div class="line">channel_0 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV9284</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
<p ><b>Step 3: Integrate single channel configuration parameters into multi-channel configuration files</b></p>
<p >According to the corresponding relationship and the configuration file above, fill the configuration parameters of each single-channel into the multi-channel <em>aaa_iq_config.lua</em> file.</p>
<p >Final multi_channel <em>aaa_iq_config.lua</em> for OV2775-OV2778-OV9284 case </p><div class="fragment"><div class="line">global = {</div>
<div class="line">   version = 0xffff, --the version of config file(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   mod = 0x202009011, --the modified date(hex <a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>)</div>
<div class="line">   amage_server_enable = 1, --1:enable Amage server; 0:disable Amage server</div>
<div class="line">   preload_enable = 0, --0:disable preload and save; 1:enable preload and save</div>
<div class="line">}</div>
<div class="line">channel_0 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV2775</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
<div class="line">channel_1 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV2778</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
<div class="line">channel_2 ={</div>
<div class="line">   <span class="comment">// configuration parameters for OV9284</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="img_flow_lib_usage_add_new_app_type"></a>
2.5 How to Add a New Sensor or an Application Type</h2>
<h3><a class="anchor" id="img_flow_lib_usage_add_type"></a>
2.5.1 How to Add a New Application Type</h3>
<p >The applicable types include IPC, BWC, ITS, DVR, DMS, ADAS, OMC, STEREO, and ROBOT. Users may need to add a new application type.</p>
<p >Here is an example of adding DMS type on CV72:</p>
<p ><b>Step 1: Add a new recipe folder for this application type</b></p>
<p >Add the configuration below into the file <em>amba.vdeps</em> at the path <code>ambarella/metadata/meta-ambalib/recipes-sensor/</code>: </p><div class="fragment"><div class="line"><span class="preprocessor">#VDEPS(menuconfig) dms-sensor-datas(/DMS): libimgalgo||prebuild-libimgalgo</span></div>
</div><!-- fragment --><p> Create a new type folder: </p><div class="fragment"><div class="line">build # cd ambarella/metadata/meta-ambalib/recipes-sensor/</div>
<div class="line">build # mkdir DMS</div>
</div><!-- fragment --><p ><b>Step 2: Add a new data folder for this application type</b></p>
<p >Add the configuration below into the file <em>amba.vdeps</em> at the path <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/</code>: In this case, it is <code>ambarella/packages/idsp/data/img_cv72/</code> </p><div class="fragment"><div class="line"><span class="preprocessor">#VDEPS(menuconfig) dms-sensor-datas(/DMS): &amp;&amp;ambaimg-header</span></div>
</div><!-- fragment --><p> There are sensor data folders in the application type folder: </p><div class="fragment"><div class="line">build # ls ambarella/packages/idsp/data/img_cv72/DMS -l</div>
<div class="line">drwxr-xr-x 4 cn-sw ar0135</div>
<div class="line">drwxr-xr-x 4 cn-sw ar0144</div>
</div><!-- fragment --><p> There shall be a makefile <em>amba.mk</em> of this sensor for the IQ binaries to be built, and several subfolders to put the source files and binaries. Set ar0135 as an example: </p><div class="fragment"><div class="line">build # ls ambarella/packages/idsp/data/img_cv72/DMS/ar0135 -l</div>
<div class="line">total 23</div>
<div class="line">drwxr-xr-x 2 cn-sw  adj_params     <span class="comment">//to put AEB/ADJ files</span></div>
<div class="line">drwxr-xr-x 2 cn-sw  calib_param    <span class="comment">//to put calibration configuration files</span></div>
<div class="line">drwxr-xr-x 2 cn-sw  lens_params    <span class="comment">//to put PIRIS configuration files</span></div>
<div class="line">-rw-r--r-- 1 cn-sw  amba.mk        <span class="comment">//makefile for dms-ar0135</span></div>
<div class="line">drwxr-xr-x 2 cn-sw  cc_bins        <span class="comment">//to put CC binaries</span></div>
<div class="line">-rw-r--r-- 1 cn-sw  LICENSE-AMBARELLA-2-Clause  <span class="comment">//license of ambarella</span></div>
</div><!-- fragment --><h3><a class="anchor" id="img_flow_lib_usage_add_sensor"></a>
2.5.2 How to Add a New Sensor</h3>
<p >Many sensors have been supported by default, yet users may add new sensors by themselves.</p>
<p >Take AR0144 for DMS on CV72 as an example:</p>
<p ><b>Step 1: Get sensor ID from sensor_list</b></p>
<p >The sensor_id can be found in structure <code>sensor_list</code> of header file <em><a class="el" href="../../d9/d65/iav__vin__common_8h.html" title="This file defines IAV Video Input Configuration structures.">iav_vin_common.h</a></em> at the path <code>ambarella/drv_modules/private/video/dsp_v6/include/uapi/</code>: </p><div class="fragment"><div class="line"><span class="keyword">enum</span> <a class="code hl_enumeration" href="../../d8/d8c/group__iav-ioctl-vin-helper.html#gabe47c58eecc0d607bd1f67835c9bc18a">sensor_list</a> {</div>
<div class="line">  ...</div>
<div class="line">  <a class="code hl_enumvalue" href="../../d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7fa046f174018ec4c9b3f831ef9eca5e">SENSOR_AR0144</a>               = 0x0000000C,</div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-ioctl-vin-helper_html_gabe47c58eecc0d607bd1f67835c9bc18a"><div class="ttname"><a href="../../d8/d8c/group__iav-ioctl-vin-helper.html#gabe47c58eecc0d607bd1f67835c9bc18a">sensor_list</a></div><div class="ttdeci">sensor_list</div><div class="ttdef"><b>Definition:</b> iav_vin_common.h:135</div></div>
<div class="ttc" id="agroup__iav-ioctl-vin-helper_html_ggabe47c58eecc0d607bd1f67835c9bc18aa7fa046f174018ec4c9b3f831ef9eca5e"><div class="ttname"><a href="../../d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7fa046f174018ec4c9b3f831ef9eca5e">SENSOR_AR0144</a></div><div class="ttdeci">@ SENSOR_AR0144</div><div class="ttdef"><b>Definition:</b> iav_vin_common.h:149</div></div>
</div><!-- fragment --><p ><b>Step 2: Map the sensor ID to sensor name</b></p>
<p >Map the sensor_id to sensor name for img_flow library in the source file <code>ambarella/packages/idsp/img_flow/img_&lt;chip_name&gt;/src/img_flow_sensor_list.c</code>. In this case, it is <code>ambarella/packages/idsp/img_flow/img_cv72/src/img_flow_sensor_list.c</code>. </p><div class="fragment"><div class="line"><span class="keyword">const</span> sensor_t amba_3a_supported_sensors[] = {</div>
<div class="line">  ...</div>
<div class="line">  {<a class="code hl_enumvalue" href="../../d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7fa046f174018ec4c9b3f831ef9eca5e">SENSOR_AR0144</a>, <span class="stringliteral">&quot;ar0144&quot;</span>},<span class="comment">//dms</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
</div><!-- fragment --><p ><b>Step 3: Prepare the predefined parameter files</b></p><ul>
<li>AEB file: The AEB filename format is: <code>&lt;sensor_name&gt;_aeb_param_&lt;app_type&gt;.c</code>. In this case: <pre class="fragment">   ar0144_aeb_param_dms.c</pre></li>
<li>Auto adjust (ADJ) file: The ADJ filename format is: <code>&lt;sensor_name&gt;_&lt;vin_type&gt;_&lt;flow_type&gt;_&lt;isp_pipeline&gt;_adj_param_&lt;app_type&gt;.c</code>. In this case: <pre class="fragment">   ar0144_mono_linear_liso_adj_param.c</pre></li>
<li>CC files: The CC binaries name format is: <code>&lt;sensor_name&gt;_&lt;vin_type&gt;_01/02/03/04_3D_&lt;app_type&gt;.bin</code>. In this case: <pre class="fragment">   ar0144_mono_01_3D_dms.bin
   ar0144_mono_02_3D_dms.bin
   ar0144_mono_03_3D_dms.bin
   ar0144_mono_04_3D_dms.bin</pre></li>
</ul>
<p ><b>Step 4: Create the foler for new sensor and move parameter files to the specified folder</b></p>
<ol type="1">
<li>Create a new foler named ar0144 at the path <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/&lt;app_type&gt;/</code>. In this case,it is <code>ambarella/packages/idsp/data/img_cv72/DMS/</code>.</li>
<li>Copy <code>amba.mk</code> and <code>LICENSE-AMBARELLA-2-Clause</code> from <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/GENERIC/def_iq_data/</code> to this new folder.</li>
</ol>
<p >In this case, it is <code>ambarella/packages/idsp/data/img_cv72/GENERIC/def_iq_data/</code>.</p><ol type="1">
<li>Create subfolders for IQ parameters.</li>
</ol>
<div class="fragment"><div class="line">build # ls ambarella/packages/idsp/data/img_cv72/DMS/ar0144/ -l</div>
<div class="line">drwxr-xr-x 2 cn-sw adj_params</div>
<div class="line">-rw-r--r-- 1 cn-sw amba.mk</div>
<div class="line">drwxr-xr-x 2 cn-sw cc_bins</div>
<div class="line">-rw-r--r-- 1 cn-sw LICENSE-AMBARELLA-2-Clause</div>
</div><!-- fragment --><ul>
<li>AEB / ADJ files shall be at the path <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/&lt;app_type&gt;/&lt;sensor&gt;/adj_params</code>.</li>
</ul>
<p >In this case, it is <code>ambarella/packages/idsp/data/img_cv72/DMS/ar0144/adj_params</code> </p><div class="fragment"><div class="line">build # ls ambarella/packages/idsp/data/img_cv72/DMS/ar0144/adj_params -l</div>
<div class="line">-rw-r--r-- 1 cn-sw   9234 ar0144_mono_aeb_param_dms.c</div>
<div class="line">-rw-r--r-- 1 cn-sw 193121 ar0144_mono_linear_liso_adj_param_dms.c</div>
</div><!-- fragment --><ul>
<li>CC binaries shall be at the path <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/&lt;app_type&gt;/&lt;sensor&gt;/cc_bins</code>.</li>
</ul>
<p >In this case, it is <code>ambarella/packages/idsp/data/img_cv72/DMS/ar0144/cc_bins/</code> </p><div class="fragment"><div class="line">build # ls ambarella/packages/idsp/data/img_cv72/DMS/ar0144/cc_bins -l</div>
<div class="line">-rw-r--r-- 1 cn-sw 17536  ar0144_mono_01_3D_dms.bin</div>
<div class="line">-rw-r--r-- 1 cn-sw 17536  ar0144_mono_02_3D_dms.bin</div>
<div class="line">-rw-r--r-- 1 cn-sw 17536  ar0144_mono_03_3D_dms.bin</div>
<div class="line">-rw-r--r-- 1 cn-sw 17536  ar0144_mono_04_3D_dms.bin</div>
</div><!-- fragment --><p ><b>Step 5: Modify makefile to support new sensors</b></p>
<p >Modify the <code>amba.mk</code> in the path <code>ambarella/packages/idsp/data/img_&lt;chip_name&gt;/&lt;app_type&gt;/&lt;sensor&gt;/</code> In this case, it is <code>ambarella/packages/idsp/data/img_cv72/DMS/ar0144/</code></p>
<p >Check the code below in the <code>amba.mk</code> for information consistency. Here, the information contains app_type, sensor, and path. In this case, the app_type is DMS, the sensor is ar0144. </p><pre class="fragment">  #DEPS(amba.mk) dms-ar0144-datas(jobserver): &amp;&amp;??generic-header \
   &amp;&amp;??ambvideo-header &amp;&amp;??ambaimg-header &amp;kernel-module-ar0144-mipi \
   &amp;kernel-module-ar0144-mipi-brg &amp;kernel-module-ar0144-parallel \
   &amp;kernel-module-ar0144-parallel-brg

  PARAMS_TYPE = dms
  PACKAGE_NAME = $(PARAMS_TYPE)-ar0144-datas
  PACKAGE_DEPS = generic-header ambvideo-header ambaimg-header

  SRC_PATH = adj_params
  IDSP_PARAM_PATH = /ambarella/idsp/$(PARAMS_TYPE)
  INSTALL_DATAS_adj_params = $(ALL_BINS) $(IDSP_PARAM_PATH)/adj_params
  INSTALL_DATAS_cc_bins = cc_bins/*.bin $(IDSP_PARAM_PATH)/cc_bins
* </pre><p ><b>Step 6: Add recipes for preloading files</b></p>
<p >Create the folder <code>&lt;app_type&gt;-&lt;sensor&gt;-datas</code> at the path <code>ambarella/metadata/meta-ambalib/recipes-sensor/&lt;app_type&gt;</code>.</p>
<p >In this case, it is <code>ambarella/metadata/meta-ambalib/recipes-sensor/DMS/dms-ar0144-datas</code>.</p>
<ol type="1">
<li>Copy an existing recipe folder such as <code>ipc-imx274-datas</code> then rename it and sub-files.</li>
<li>Modify the code as below in “dms-ar0144-datas_1.0.0.bb”: <pre class="fragment">  EXTRADEPS = "&amp;kernel-module-ar0144-mipi &amp;kernel-module-ar0144-mipi-brg &amp;kernel-module-ar0144-parallel &amp;kernel-module-ar0144-parallel-brg"</pre> The libraries such as &amp;kernel-module-XXXX are saved in <code>metadata/meta-ambabsp/recipes-sensor</code>.</li>
<li>Modify the code as below in “dms-ar0144-datas_1.0.0.bbappend”: <pre class="fragment">  EXTERNALSRC = "${ENV_TOP_DIR}/packages/idsp/data/img_${AMBA_IMG_ARCH}/DMS/ar0144"
  EXTERNALSRC_BUILD = "${ENV_TOP_DIR}/packages/idsp/data/img_${AMBA_IMG_ARCH}/DMS/ar0144"</pre></li>
</ol>
<p ><b>Step 7: Check the sensor option in menuconfig and rebuild</b></p><ul>
<li>For Cooper Amba build <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    drv_modules  ---&gt;</div>
<div class="line">        platform  ---&gt;</div>
<div class="line">             vin  ---&gt;</div>
<div class="line">                sensors  ---&gt;</div>
<div class="line">                  [*] kernel-module-ar0144-mipi (drv_modules/platform/vin/sensors/onsemi_ar0144_mipi)</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    meta-ambabsp  ---&gt;</div>
<div class="line">        recipes-sensor  ---&gt;</div>
<div class="line">             [*] kernel-module-ar0144-mipi (meta-ambabsp/recipes-sensor/kernel-module-ar0144-mipi)</div>
</div><!-- fragment --></li>
</ul>
<hr  />
<h1><a class="anchor" id="img_flow_api"></a>
3. Image Flow API</h1>
<p >Visit the following link to find details of the image flow API functions</p><ul>
<li><a class="el" href="../../df/d39/group__img__flow-api-details.html">Image Flow Library API details</a> shows image flow API lists.</li>
<li><a class="el" href="../../dd/d16/group__img__flow-api__struct.html">Image Flow Library API structure</a> shows image flow structures.</li>
<li><a class="el" href="../../d4/de3/group__img__flow-api__helper.html">Image Flow Library API helper</a> shows related macros enumerations and macros.</li>
</ul>
<hr  />
<h1><a class="anchor" id="img_flow_lic"></a>
4. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
