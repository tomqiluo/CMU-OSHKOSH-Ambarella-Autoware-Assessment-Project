<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Library: EIS Library API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Library"/>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="../../../library/mathjax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Library<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d6/db6/page_lib_eis_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">EIS Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="eis_history"></a>
0. Revision History</h1>
<a class="anchor" id="lib_eis_rev_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Library Version </th><th>Updated Date </th><th align="left">Modification </th></tr>
<tr>
<td>2.0.0 </td><td>20220718 </td><td>Initial Version </td></tr>
<tr>
<td>2.0.0 </td><td>20220808 </td><td>Support ICM42670 from Invensense <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_imu">3.2 IMU Selection</a> </td></tr>
<tr>
<td>3.0.0 </td><td>20220823 </td><td>Reserve enough space for EIS external structure </td></tr>
<tr>
<td rowspan="3">4.0.0 </td><td rowspan="3">20221123 </td><td>1. Remove EFR logic from test_eis_warp.c </td></tr>
<tr>
<td>2. Refine the initialization API </td></tr>
<tr>
<td>3. Add user context support </td></tr>
<tr>
<td>4.0.1 </td><td>20230206 </td><td>Round up vertical warp out width 64 for MCTF restriction </td></tr>
<tr>
<td rowspan="2">4.1.0 </td><td rowspan="2">20230421 </td><td>1. Added support to real time update filter scale for stationary mode <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_rt_change">3.7 Real Time Update</a> </td></tr>
<tr>
<td>2. Added <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_qa_q12">Question 12. What are the steps to configure the main buffer size of the EIS source channel and the EIS effective channel?</a> </td></tr>
<tr>
<td>4.1.1 </td><td>20230427 </td><td>Align horizontal warp output width with 64 for c2y restriction under encode mode 0 </td></tr>
<tr>
<td>4.2.0 </td><td>20230626 </td><td>The data structure amba_eis_stat_t upgrade to have mono_pts </td></tr>
<tr>
<td rowspan="2">4.2.0 </td><td rowspan="2">20230717 </td><td>1. Added section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_pm">2.7 EIS with Privacy Mask</a> </td></tr>
<tr>
<td>2. Unified the EIS module in this chapter for CV5 / CV52 / CV72 <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_intro">1.1. EIS Introduction</a> </td></tr>
<tr>
<td>4.2.1 </td><td>20231110 </td><td>Refined stationary mode rt scale configuration <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_filter_mode">3.5 EIS Filter Mode</a> </td></tr>
<tr>
<td>4.3.0 </td><td>20231123 </td><td>Added option for configuring EIS warp table density <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_warp_vector">2.5 Warp Vector</a> </td></tr>
<tr>
<td>4.3.0 </td><td>20231201 </td><td>Refined the description for EIS window <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_res_eis">3.4.2 EIS Window</a> </td></tr>
<tr>
<td rowspan="3">4.3.0 </td><td rowspan="3">20231212 </td><td>1. Added eis_v6_framework for section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_overview">1. Overview</a> </td></tr>
<tr>
<td>2. Added <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_qa_q14">Question 14. Why does EIS cache a certain number of frames in external memory?</a> </td></tr>
<tr>
<td>3. Moved Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#gyro_dev_tree">3.1 Device Tree Configuration</a> to chapter 3 </td></tr>
<tr>
<td>4.3.1 </td><td>20231214 </td><td>Fix the issue for updating EFL in real time. <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_rt_change">3.7 Real Time Update</a> </td></tr>
<tr>
<td rowspan="3">4.4.0 </td><td rowspan="3">20231222 </td><td>1. Enable EIS on rotation pipeline <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_enc">2.4 Encode Mode</a> </td></tr>
<tr>
<td>2. Enable the customized filter <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_filter_mode">3.5 EIS Filter Mode</a> </td></tr>
<tr>
<td>3. Add one example <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_ex_4">3.8.4 IMX274 + EIS + Rotation</a> </td></tr>
<tr>
<td>4.4.0 </td><td>20240122 </td><td>Adjusted chapter <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_design"><ol type="1">
<li>Design</li>
</ol>
</a> and added description in <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_sensor">3.3 CMOS Sensor</a> </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="eis_overview"></a>
1. Overview</h1>
<p >Electronic image stabilization (EIS) is a process where image stability is controlled through electronic processing procedures. Another motion sensor, "IMU", is mounted to detect camera vibration in the pitch / yaw / roll directions. EIS responds by moving the image cropping offset and applying warp operations so that the output content can remain in a position that is as close as possible to the original position.</p>
<h2><a class="anchor" id="eis_intro"></a>
1.1. EIS Introduction</h2>
<p >In this chapter, the EIS module introduced is in the software development kits (SDKs) for the <b>CV5, CV52, and CV72</b> systems on chip (SoCs). <br  />
From the system perspective, the EIS module is implemented differently from previous chips, such as CV2x and S5L. In order to receive one channel output's stablized result, another auxiliary channel is configured to malloc external memory and generate the 3A (auto white balance (AWB) / auto exposure (AE) / auto focus (AF)) statistics as soon as possible in order for AE control to function without delay. The channels are called the <b>EIS source channel</b> and the <b>EIS effective channel</b>.</p>
<div class="image">
<img src="../../eis_v6_framework.png" alt=""/>
<div class="caption">
Figure 1-1. EIS Framework.</div></div>
<p> The figure above shows the CV5x EIS framework. The connection between both channels (the EIS source channel and the EIS effective channel) are reflected by "raw_src_chan" in channel configuration. For the EIS source channel, the EIS framework prepares necessary data for further computation inside the EIS library and frame synchronization inside of the IAV driver.</p><ul>
<li>Image raw data: there is one external memory attached with the EIS source channel for caching full size raw image and 1/12 size CE (contrast enhance) image. The memory size depends on the "raw_feed_frame_num" from channel configuration, which indicates the capacity of the external memory in frame units while "raw_cached_items" sets the active cached frame number. Ambarella does NOT suggest setting "raw_cached_items" equal to the raw_feed_frame_num value.</li>
<li>3A statistics: generated without delay and cached in the IAV driver, which is already sychronized with image raw. To ensure that the 3A statistics are synchronized with image raw when taking the raw cache number into consideration, set "eis-delay-count" the same as (raw_cached_items - 1) for the <b>EIS effective channel</b>.</li>
<li>Warp table: the EIS application fetches gyro raw data and real-time CMOS timing information and forwards them to the EIS library to compute the warp table. The warp table has been synchronized with image raw before it is generated. The EIS library could obtain the gyro data and CMOS timing information for the latest frame in external memory, but always keeps the whole frame gyro / CMOS information in external memory. Meanwhile, the warp table being computed is not for the latest frame but the oldest frame; this mechanism makes it possible to enable the EIS algorithm to forsee future frame gyro data in order to help refine the warp table for the oldest frames.</li>
</ul>
<p >All information (image raw, 3A, and warp table) is combined into one batch of encode from raw (EFR) commands and sent to the EIS effective channel to obtain the stablized result. There are some hard restrictions for both channels if they are configured to perform EIS, such the same packing mode flag and the raw capture flag. Refer to <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_des_example">3.8 Example</a> for an intuitive understanding.</p>
<h2><a class="anchor" id="eis_spec"></a>
1.2. EIS Specification</h2>
<a class="anchor" id="eis_spec_table"></a>
<table class="doxtable">
<caption>Table 1-1. EIS Specification.</caption>
<tr>
<th>Related Sector </th><th>Item </th><th align="left">Specification Detail </th></tr>
<tr>
<td>Gyro </td><td>Data sample rate </td><td>Up to 2000 Hz </td></tr>
<tr>
<td rowspan="4">Algorithm </td><td>X/Y/Z axis correction frequency </td><td>Up to 10 Hz </td></tr>
<tr>
<td>X/Y axis correction coverage in percentage </td><td>Up to sensor coverage </td></tr>
<tr>
<td rowspan="2">Z axis correction coverage in degrees <br  />
(Highly depends on the EFL and margin from sensor) </td><td>1. The larger margin with same EFL, the larger degree can correct. </td></tr>
<tr>
<td>2. The larger EFL with same margin, the smaller degree can correct. </td></tr>
<tr>
<td>Lens </td><td>Effective focal length (EFL) correction coverage in um </td><td>2000 um &lt;= EFL &lt;=15000 um </td></tr>
<tr>
<td rowspan="3">VIN </td><td>Resolution </td><td>720p30 to 4KP60 </td></tr>
<tr>
<td rowspan="2">VIN mode </td><td>Supports rolling shutter sensor in <br  />
1. Linear mode<br  />
2. Fake linear mode<br  />
3. DCG HDR<br  />
4. Clear HDR (Sony sensor) </td></tr>
<tr>
<td>Supports global shutter sensor in linear mode </td></tr>
<tr>
<td rowspan="3">IDSP </td><td>EIS delay count </td><td>[3, 30] </td></tr>
<tr>
<td>Encode mode supported </td><td>0, 5 </td></tr>
<tr>
<td>Supports multi-channel EIS </td><td>Both library and driver </td></tr>
<tr>
<td rowspan="2">Advanced features </td><td>Lens geometric distortion correction </td><td>Rectilinear </td></tr>
<tr>
<td>Rolling shutter compensation </td><td>Caused by rolling shaking <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_rolling_shaking">2.1 Rolling Shaking</a> </td></tr>
<tr>
<td>CPU </td><td>Occupation </td><td>TBD </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="eis_implementation"></a>
2. Implementation</h1>
<p ><br  />
This chapter provides important information on EIS.</p><ul>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_rolling_shaking">2.1 Rolling Shaking</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_pry_def">2.2 Definition of Pitch / Roll / Yaw</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_va_map">2.3 Virtual Axis Mapping</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_enc">2.4 Encode Mode</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_warp_vector">2.5 Warp Vector</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_build">2.6 Building</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_pm">2.7 EIS with Privacy Mask</a></li>
</ul>
<h2><a class="anchor" id="eis_rolling_shaking"></a>
2.1 Rolling Shaking</h2>
<p >Ambarella EIS supports rolling shaking in the pitch / yaw / rotate directions (refer to <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_pry_def">2.2 Definition of Pitch / Roll / Yaw</a>), which is type of an irregular rolling shaking around the three axises of the camera coordinate system. The gyro sensor is used to detect angular velocity but not linear velocity, <b>so if the shaking direction is parallel to the horizontal axis (pitch axis) or vertical axis (yaw axis) of the camera coordinate system (refer to the figure in Section 2.2 Definition of Pitch / Roll / Yaw), Ambarella will not support it.</b> </p><div class="image">
<img src="../../eis_shaking_type.png" alt=""/>
<div class="caption">
Figure 2-1. Shaking Type.</div></div>
<h2><a class="anchor" id="eis_pry_def"></a>
2.2 Definition of Pitch / Roll / Yaw</h2>
<p >Before starting, ensure that there is a three-axis gyro sensor mounted on the main board. Currently, the SDK supports Invensense MPU6000 / MPU6500 / MPU9250 sensors. For any questions about gyro implementation, contact the Ambarella support team. </p><div class="image">
<img src="../../eis_pry_def.png" alt=""/>
<div class="caption">
Figure 2-2. Pitch / Roll / Yaw Definition.</div></div>
<p >The rotation and axis follow the right-hand screw rule. As the CMOS sensor uses a rolling shutter, an X-direction move on the sensor plane causes the sensor output image to skew. If the skew is not corrected, the vertical lines will not be vertical. If the camera moves up and down, the image will be stretched in the vertical direction.</p>
<p >The gyro-based EIS algorithm can compensate for the stretch effect from the rolling shutter.</p>
<p >Currently, the EIS module supports <b>Pitch</b>, <b>Roll</b>, and <b>Yaw</b> corrections all together. Further updates and improvements will be added in the future.</p>
<h2><a class="anchor" id="eis_va_map"></a>
2.3 Virtual Axis Mapping</h2>
<p >By default, Ambarella's EIS algorithm assumes that the gyro axis is mounted as shown below. </p><div class="image">
<img src="../../eis_gyro_axis.png" alt=""/>
<div class="caption">
Figure 2-3. Default Gyro Axis EIS.</div></div>
<p >However, if the gyro axis is not mounted as shown in the diagram above, gyro virtual mapping can be set according to different mounting positions. </p><div class="image">
<img src="../../eis_mount_pos.png" alt=""/>
<div class="caption">
Figure 2-4. Custom Gyro Mounting Position.</div></div>
<p> In this case: <br  />
X_mapped = +Y_Gyro <br  />
Y_mapped = -X_Gyro <br  />
Z_mapped = +Z_Gyro <br  />
Users are expected to provide the details of the mapping information in the device trees (DTS) in the folder <code>./ambarealla/board/cv22_walnut/bsp/cv22_walnut.dts</code>. For any other platform, there is always a DTS file under <code>./bsp/</code>, which has the same name as the board. <br  />
(Axis direction definition - 0:-X, 1:+X, 2:-Y, 3:+Y, 4:-Z, 5:+Z) </p><div class="fragment"><div class="line"> gyro@0 {</div>
<div class="line"> .....</div>
<div class="line"> x_axis = &lt;1&gt;;</div>
<div class="line"> y_axis = &lt;3&gt;;</div>
<div class="line"> z_axis = &lt;5&gt;;</div>
<div class="line"> .....</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="eis_enc"></a>
2.4 Encode Mode</h2>
<p >As described in <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_intro">1.1. EIS Introduction</a>, there are two channels (EIS effective channel and EIS source channel) that serve in the current implementation. The EIS source channel is restricted to be image pipeline only mode (mode 8) only, while the EIS effective channel can be configured to both high dynamic range (HDR) line-interleaved mode (mode 5) and normal ISO mode (mode 0). The EIS effective channel can set channel rotate clockwise and horizontal/vertical flip at the same time, which could work together with EIS. <br  />
<b>Mode 0 example:</b> </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">board # modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">            [Vsrc information]:</div>
<div class="line">             VIN Controller[8]:</div>
<div class="line">                  vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=1 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">board # modprobe gyro_icm20648_mc</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --enc-mode 0 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_4k_linear_eis.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_eis_warp --ch 1 -c 1000 -F 7200 -e 1920x1080</div>
<div class="ttc" id="acJSON_8h_html_a788db922597cf2fb6389e278f822e59f"><div class="ttname"><a href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div><div class="ttdeci">const char *const const char *const raw</div><div class="ttdef"><b>Definition:</b> cJSON.h:270</div></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>The <b>"sensor_id, agc_db_step, video_bits"</b> must read out from the master sensor channel.</dd></dl>
<p><b>Mode 5 example:</b> </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">board # modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">            [Vsrc information]:</div>
<div class="line">             VIN Controller[8]:</div>
<div class="line">                  vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=1 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">board # modprobe gyro_icm20648_mc</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --chan-vcap-mode-enable 1 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_4k_linear_eis_mode5.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_eis_warp --ch 1 -c 1000 -F 7200 -e 1920x1080</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>The <b>"sensor_id", "agc_db_step", and "video_bits"</b> must read out from the master sensor channel.</dd></dl>
<h2><a class="anchor" id="eis_warp_vector"></a>
2.5 Warp Vector</h2>
<p >EIS correction is based on the warp engine, which is hardware that uses the warp vector to perform real-time dewarp operations. The warp pipeline requires one horizontal vector and one vertical vector. These horizontal and vertical warp vectors are calculated by the Ambarella EIS library. <br  />
There are some limitations for the warp vector. In the horizontal or vertical warp stage, the digital signal processor (DSP) divides the input of the vector map into grids and relocates the vertices of each grid based on the vector. The DSP performs interpolation for the pixels that are not vertices of the grids. <br  />
<b>Maximum density</b></p><ul>
<li>The default maximum density of the horizontal and vertical map is 128 (H) by 96 (V). Users can also set them by an option "warp-table-density" of <code>test_eis_warp.c</code>. Smaller dimension requires larger grid spacing but lower CPU loading for warp table computation.</li>
</ul>
<p ><br  />
<b>Grid</b></p><ul>
<li>The grid size can be different in the horizontal and vertical map.</li>
<li>The grid width and height for the horizontal vector map must be 8 / 16 / 32 / 64 / 128 / 256 / 512.</li>
<li>The grid width for the vertical vector map must be 8 / 16 / 32 / 64 / 128 / 256 / 512.</li>
<li>The grid height for the vertical vector map must be 8 / 16 / 32 / 64 / 128 / 256 / 512. <br  />
<b>The vector map height can be greater than the main buffer height.</b> <br  />
The redundant rows will be discarded. The advantage is that the user can see when warping is performed on the main buffer, which does not have an appropriate grid division. <br  />
For example, 1080 is not a multiple of 16 / 32 / 64 / 128. It is possible to set the main buffer to 1920x1080 and the vector map to 1920x1088. The eight lines at the bottom of the grid will not be included in the main buffer after warping.</li>
</ul>
<p ><br  />
<b>Vector</b> <br  />
The vector is in the format signed 12.4. <br  />
For the horizontal map, negative vectors point to the right and positive vectors point to the left. <br  />
For the vertical map, negative vectors point downwards and positive vectors point upwards. </p><div class="image">
<img src="../../eis_vertical_vector.png" alt=""/>
<div class="caption">
Figure 2-5. EIS Vertical Vector.</div></div>
 <div class="image">
<img src="../../eis_horizontal_vector.png" alt=""/>
<div class="caption">
Figure 2-6. EIS Horizontal Vector.</div></div>
<h2><a class="anchor" id="eis_build"></a>
2.6 Building</h2>
<p >Use the following steps to build the EIS as well as the gyro drivers. Proceed with the unit test <em>test_eis_warp</em>.</p>
<h3><a class="anchor" id="eis_build_board"></a>
2.6.1 Board</h3>
<p >Turn <b>SW1 (1-4)</b> off on the CV5 Timn or CV52 Crco evaluation kit (EVK) board. Enable the serial peripheral interface (SPI) with the steps below in order for gyro INT and SPI 1 to function. <a class="elRef" target="_blank" href="../../../hardware/da/d9e/page_cv5_timn.html#cv5_timn_imu_switch">4.2.40 IMU Switch</a></p><ul>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">[*] bootmenu@<span class="keyword">virtual</span> (boot)  ---&gt;</div>
<div class="line">     [*]   boot (boot)  ---&gt;</div>
<div class="line">          Bootloader  ---&gt;</div>
<div class="line">             Ambarella Firmware Configuration  ---&gt;</div>
<div class="line">                SPI1 and GPIO(69-71) Selection (SPI1)  ---&gt;</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line"> meta-ambabsp ---&gt;</div>
<div class="line">    recipes-bsp ---&gt;</div>
<div class="line">       boot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">          Bootloader  ---&gt;</div>
<div class="line">             Ambarella Firmware Configuration  ---&gt;</div>
<div class="line">                SPI1 and GPIO(69-71) Selection (SPI1)  ---&gt;</div>
</div><!-- fragment --> For the switch and jumper information on the CV72 GA EVK board, refer to <a class="elRef" target="_blank" href="../../../hardware/dd/d4e/page_cv72_gage.html#cv72_ga_imu_switch">4.2.35 IMU Switch</a>.</li>
</ul>
<h3><a class="anchor" id="eis_build_drv"></a>
2.6.2 Driver</h3>
<p >EIS functions with the image audio video (IAV) driver, as well as EIS and gyro. Currently, InvenSense's gyro sensor ICM20648 is welded on the CV5x EVK and ICM42670 is welded on the CV72 GAGE EVK.</p><ul>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      platform  ---&gt;</div>
<div class="line">         [*] kernel-module-eis-mc (drv_modules/platform/eis)</div>
<div class="line">         [*] ambeis-header (drv_modules/platform/eis)</div>
<div class="line">             gyro  ---&gt;</div>
<div class="line">               [*] kernel-module-icm20648 (drv_modules/platform/gyro/icm20648)</div>
<div class="line">               [*] kernel-module-icm42670 (drv_modules/platform/gyro/icm42670)</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line"> meta-ambabsp ---&gt;</div>
<div class="line">    recipes-gyro ---&gt;</div>
<div class="line">       [*] kernel-module-icm20648 (drv_modules/platform/gyro/icm20648)</div>
<div class="line">       [*] kernel-module-icm42670 (drv_modules/platform/gyro/icm42670)</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="eis_build_test"></a>
2.6.3 Unit test</h3>
<p >Enable "Configure Ambarella EIS library" while compiling EIS.</p><ul>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">    prebuild  ---&gt;</div>
<div class="line">       library  ---&gt;</div>
<div class="line">          [*] prebuild-eis (prebuild/library/eis/dsp_v6)</div>
<div class="line">          [*]   eis-test (prebuild/library/eis/dsp_v6)</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">  meta-ambalib  ---&gt;</div>
<div class="line">     recipes-prebuild  ---&gt;</div>
<div class="line">        [*] prebuild-eis (meta-ambalib/recipes-prebuild/prebuild-eis)</div>
<div class="line">  meta-ambaapp  ---&gt;</div>
<div class="line">     recipes-test  ---&gt;</div>
<div class="line">        [*] eis-test (meta-ambaapp/recipes-test/eis-test)</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="eis_build_iav_mem"></a>
2.6.4 IAV Memory â€” IK Buffer Size</h3>
<ul>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">          (0x1000000) IAV IMG IK CFG Buffer Size</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">  meta-ambabsp  ---&gt;</div>
<div class="line">     recipes-video  ---&gt;</div>
<div class="line">        -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header)  ---&gt;</div>
<div class="line">            (0x1000000) IAV IMG IK CFG Buffer Size</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="eis_pm"></a>
2.7 EIS with Privacy Mask</h2>
<p >For the CV72 platform, the new parameter "is_post_warp_pm" in channel configuration is designed to enable or disable privacy masks at the post-warp stage for EIS effect channels. This means that privacy mask operations can be performed immediately after the EIS warp table takes effect. Note that this feature is only available for CV72, and is not supported CV5, CV52, or any other platform.</p>
<hr  />
<h1><a class="anchor" id="eis_design"></a>
3. Design</h1>
<p >This chapter provides information on EIS design. <b>If users require any help with EIS case design or evaluation on the CV5 / CV52 / CV72 platform, contact the Ambarella SDK support team.</b> EIS is a real-time task, which requires a high priority to run. When the user enables EIS, the priority of the process must be maximized.</p><ul>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#gyro_dev_tree">3.1 Device Tree Configuration</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_imu">3.2 IMU Selection</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_sensor">3.3 CMOS Sensor</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_window">3.4 Window</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_filter_mode">3.5 EIS Filter Mode</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_des_lens">3.6 Lens</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_rt_change">3.7 Real Time Update</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_des_example">3.8 Example</a></li>
</ul>
<h2><a class="anchor" id="gyro_dev_tree"></a>
3.1 Device Tree Configuration</h2>
<p ><br  />
The figure below shows what type of multi-VIN cases that the current EIS module supports. Note that one IMU device can only serve one VIN source at most. </p><div class="image">
<img src="../../multi_chan_eis_typical_cases.png" alt=""/>
<div class="caption">
Figure 3-1. Typical Cases.</div></div>
<p> Clarify the relationship between the gyro device and the <b>channel map</b>. Then, fill it in the DTS, together with the <b>VIN source ID</b> and the <b>VIN controller ID</b>. Refer to the example below. The EIS driver possesses all registered information and manages data flow to ensure the pass of the corresponding group of gyro raw data to the application for warp table computation. </p><div class="fragment"><div class="line">gyro@0 {</div>
<div class="line">compatible = <span class="stringliteral">&quot;ambarella,gyro&quot;</span>;</div>
<div class="line">reg = &lt;0&gt;;</div>
<div class="line">spi-max-frequency = &lt;20000000&gt;;</div>
<div class="line">spi-cpha;</div>
<div class="line">spi-cpol;</div>
<div class="line">x_axis = &lt;1&gt;;</div>
<div class="line">y_axis = &lt;3&gt;;</div>
<div class="line">z_axis = &lt;5&gt;;</div>
<div class="line">vinc_id = &lt;0&gt;;</div>
<div class="line">vsrc_id = &lt;0&gt;;</div>
<div class="line">bus_id = &lt;1&gt;;</div>
<div class="line">cs_id = &lt;0&gt;;</div>
<div class="line">channel_map = &lt;1&gt;;</div>
<div class="line">irq-gpio = &lt;&amp;gpio 31 0&gt;;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="eis_imu"></a>
3.2 IMU Selection</h2>
<p >Currently, the SDK supports the following IMU sensors. </p><a class="anchor" id="gyro_list"></a>
<table class="doxtable">
<caption>Table 3-1. Supported IMU Part Number.</caption>
<tr>
<th>IMU Part Number </th><th>Vendor </th><th align="left">Last Modified </th></tr>
<tr>
<td>MPU9250 </td><td>InvenSense </td><td>20161122 </td></tr>
<tr>
<td>MPU6000 </td><td>InvenSense </td><td>20161122 </td></tr>
<tr>
<td>MPU6500 </td><td>InvenSense </td><td>20161122 </td></tr>
<tr>
<td>ICM20600 </td><td>InvenSense </td><td>20201130 </td></tr>
<tr>
<td>ICM20648 </td><td>InvenSense </td><td>20210701 </td></tr>
<tr>
<td>ICM40608 </td><td>InvenSense </td><td>20210726 </td></tr>
<tr>
<td>ICM42605 </td><td>InvenSense </td><td>20210427 </td></tr>
<tr>
<td>ICM42670 </td><td>InvenSense </td><td>20221027 </td></tr>
<tr>
<td>ICG20660 </td><td>InvenSense </td><td>20161122 </td></tr>
<tr>
<td>BMI270 </td><td>Bosch </td><td>20210422 </td></tr>
<tr>
<td>BMI160 </td><td>Bosch </td><td>20210429 </td></tr>
<tr>
<td>LSMD6SR </td><td>STMicroelectronics </td><td>20220520 </td></tr>
</table>
<p >The supported IMU sensor list is supposed to be kept updating, Ambarella SDK team removes the ones out of stock and adds newly lauched IMU selectively. Feel free to contact Ambarella and share the sensor list for further cooperation.</p>
<h2><a class="anchor" id="eis_sensor"></a>
3.3 CMOS Sensor</h2>
<p >Ambarella Cooper SDK now supports most of the CMOS sensor with EIS. Typically, Ambarella SDK team collects customer feedbacks and requests from the market, and then make own decision of plan and schedule to support the new CMOS sensors gradually. To confirm whether a specific sensor is capable of working for EIS, either an RGB sensor or a thermal sensor, the following information needs to be accurately addressed:</p><ul>
<li>Video blank time</li>
<li>Line time</li>
<li>Pixel unit size</li>
<li>Rolling shutter or global shutter</li>
<li>Whether there is latency costed by DSP inside sensor before generate the frame to SoC</li>
<li>Thermal sensor (time constant); sampling of the temperature</li>
</ul>
<p ><b>HDR Mode</b> <br  />
 Currently, the EIS algorithm does NOT function with DOL-HDR mode, <b>but it does function with DCG-HDR mode (such as ov2775 DCG-HDR mode)</b>. In theory, DOL-HDR sets different exposure configurations for long and short frames before blending. DCG-HDR sets the same exposure configuration but different AE gains for two frames. Different exposure times may cause some trailing smears when EIS is functioning for quick vibration. Users must develop their own EIS algorithm for DOL-HDR input. <br  />
Supported HDR modes are listed as below, and the option "hdr-mode" of test_eis_warp_sc / test_eis_warp_mc is designed for the selection.</p><ul>
<li>Rolling shutter sensor in linear mode</li>
<li>Rolling shutter sensor in (2x HDR) faking linear mode</li>
<li>Global shutter sensor in linear mode</li>
</ul>
<p ><b>Shutter time</b> <br  />
Ambarella recommends setting a maximum shutter time of less than 1/60 s (refer to <em>test_aaa_service</em>). However, this is a suggestion and is not required for a good EIS correction effect. Different conditions may be set with different values to obtain better correction results.</p>
<h2><a class="anchor" id="eis_window"></a>
3.4 Window</h2>
<h3><a class="anchor" id="eis_res_vin"></a>
3.4.1 VIN Window</h3>
<p >Ambarella Cooper SDK now has most of the CMOS sensor with EIS support. Typically, Ambarella SDK team collect customer feedbacks and requests from the market, and then make own decision of plan and schedule to support the new CMOS sensors gradually. No hard restriction to VIN window size from EIS requirements. </p><a class="anchor" id="gyro_list"></a>
<table class="doxtable">
<caption>Table 3-2. Typical Resolution.</caption>
<tr>
<th>CMOS Sensor </th><th>Resolution </th></tr>
<tr>
<td>OS05A10 </td><td>2592x1944 </td></tr>
<tr>
<td>OS08A10 </td><td>3840x2160 </td></tr>
<tr>
<td>IMX335 </td><td>2592x1944 </td></tr>
<tr>
<td>IMX274 </td><td>3840x2160 </td></tr>
<tr>
<td>IMX334 </td><td>3840x2160 </td></tr>
<tr>
<td>IMX678 </td><td>3840x2160 </td></tr>
<tr>
<td>IMX178 </td><td>3072x2048 </td></tr>
</table>
<h3><a class="anchor" id="eis_res_eis"></a>
3.4.2 EIS Window</h3>
<p >The EIS window is the actual output of the EIS correction algorithm. It can be set with the option <b>"eis-output"</b> (see <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_ex_4">3.8.4 IMX274 + EIS + Rotation</a> in <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_des_example">3.8 Example</a>). In the default setting, the EIS window size is equal to the main buffer size. </p><div class="image">
<img src="../../eis_eis_window.png" alt=""/>
<div class="caption">
Figure 3-2. VIN Margin for EIS without Option <em>'eis-output'</em>.</div></div>
<p> In order for EIS to function well, users must ensure there is sufficient margin between the EIS window and the VIN window. For example, if VIN window size is 2304x1536 and the EIS window size is 1920x1080, the vertical margin = (1536-1080) / 2 /1080 = 21%. There is no mandatory requirement for the margin, but the larger margin is, the larger vibration angle can be corrected. It is possible to roughly convert the margin size to the angle value in radian: </p><p class="formulaDsp">
\[ focal_length = \frac{EFL(mm)}{pixel_cell_unit_size(mm)} angle (radian) = \frac{V_margin(pixel)}{focal_length} \]
</p>
<p ><br  />
This EIS window size can be smaller than the main buffer size. Therefore, there is no limitation that the main buffer size should be smaller than the VIN size. The EIS warp table is capable of taking the upscale into the computation.</p><ul>
<li>Pitch correction requires a vertical margin only</li>
<li>Yaw correction requires a horizontal margin only</li>
<li>Roll correction requires both horizontal and vertical margins <div class="image">
<img src="../../eis_vin_margin.png" alt=""/>
<div class="caption">
Figure 3-3. VIN Margin for EIS with Option <em>'eis-output'</em>.</div></div>
 <b>ROI Center Control</b> <br  />
By default, the EIS output window is located in the center position of the VIN domain. This means that the V-margin at the top and bottom are the same, and the H-margin at the left and right are the same. Using the center point of the EIS output window as a parameter specified in the VIN domain, users can manually change the left / right and top / bottom margins. See the figure below. <div class="image">
<img src="../../eis_roi_center.png" alt=""/>
<div class="caption">
Figure 3-4. EIS Region of Interest Center Control.</div></div>
</li>
</ul>
<h2><a class="anchor" id="eis_filter_mode"></a>
3.5 EIS Filter Mode</h2>
<p >From the perspective of image stabilization applications, EIS is now a basic feature for camera products, such as body-worn cameras and internet protocol cameras (IPCs)). Meanwhile, Ambarella EIS made some changes according to the classified market demands. A new developed option "filter-mode" is added to ensure EIS correction can output the best result under different situations. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Filter Mode   </th><th class="markdownTableHeadCenter">Application    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Action mode   </td><td class="markdownTableBodyCenter">Body-worn camera    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Stationary mode   </td><td class="markdownTableBodyCenter">IPC    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Customized Mode   </td><td class="markdownTableBodyCenter">Customized filter design, bypass Amba EIS filter.   </td></tr>
</table>
<p>Below are detailed introductions for the above filter modes.</p><ul>
<li>Action mode: covers body-worn cameras with large amplitudes and small vibration frequencies. The final stabilized video is not required to remain stationary, but must have a smooth effect for all types of motion (walking, running, and skating).</li>
<li>Stationary mode: covers most IPC products, which are mounted to a fixed location without any movement. Generally, stationary mode functions for vibrations that are smaller in amplitude but have larger vibration frequency.</li>
<li>Customized filter mode. Customers designed their own filter and bypassed the EIS library internal filters, please set filter mode as EIS_FILTER_MODE_CUSTOMIZED in <em>test_eis_warp_sc/test_eis_warp_mc</em>.</li>
</ul>
<h2><a class="anchor" id="eis_des_lens"></a>
3.6 Lens</h2>
<p >Currently, the EIS library only supports prime lenses. Even if a distorted lens is in use, the jelly effect in both the vertical and horizontal directions will be removed.<br  />
For zoom lenses, users are required to know the exact EFL and configure EFL to the library in real time.<br  />
For TELE lens which EFL is <b>larger than 15 mm</b>, Ambarella does not recommend enabling EIS, as the requirement for the margin or field of view (FoV) loss is much larger than what users may expect.</p>
<p ><b>EIS with Lens Distortion Correction (LDC)</b> <br  />
When implementing EIS with a distorted lens, Ambarella supports enabling the feature "EIS + LDC", which simultaneously performs EIS and removes distortion. In terms of LDC, users can also convert the distortion table to a lens data file in binary format for more-accurate distortion correction. The tool "lens_data_tool" is used to convert the lens distortion table into an EIS library readable configuration binary. It is located in the SDK folder <code>./ambarella/prebuild/ambarella/library/lens</code>.</p>
<h2><a class="anchor" id="eis_rt_change"></a>
3.7 Real Time Update</h2>
<p >EIS functions for different vibration conditions, and there are no intelligent processes to change key parameters for the stablization algorithm. However, the EIS library is designed with an interface that enables EIS applications to change their EIS parameters in real time. <br  />
Refer to the definition of the structure "eis_rt_info_t", which is designed for real-time communication between the library and the application. The EIS application registers one callback function, <b>get_eis_stat_rt</b>, which recieves gyro raw data from the EIS driver and incorporates the changed EIS parameters wrapped in "eis_rt_update_t" into the algorithm. The parameters "shutter_in_ms", "shutter_short_in_ms", and "sync_hw_pts" are read directly from the IAV driver. Users can change <b>efl_in_um</b> for zoom lenses, <b>filter_scale</b> for different vibration frequencies, <b>ldc_enable</b> to remove distortion, <b>res_fov_vin</b> to hange FoV function when EIS is off, <b>VIN frame rate</b> in high precision, and other parameters from the structure "debug_param_rt". </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> channel_id;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> update_efl_flag : 1;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> update_fps_flag : 1;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> reserved1 : 6;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> reserved0[2];</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> sync_hw_pts;</div>
<div class="line">   <span class="keywordtype">float</span> shutter_in_ms;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> efl_in_um;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> fps_hp;</div>
<div class="line">   <span class="keywordtype">float</span> vb_in_ms;</div>
<div class="line">   <span class="keywordtype">void</span> *filter_param;</div>
<div class="line">   <a class="code hl_typedef" href="../../d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> reserved2[6];</div>
<div class="line">} eis_rt_info_t;</div>
<div class="ttc" id="aasf__structure_8h_html_a92c50087ca0e64fa93fc59402c55f8ca"><div class="ttname"><a href="../../d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a></div><div class="ttdeci">uint8_t u8</div><div class="ttdef"><b>Definition:</b> asf_structure.h:44</div></div>
<div class="ttc" id="aasf__structure_8h_html_afaa62991928fb9fb18ff0db62a040aba"><div class="ttname"><a href="../../d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a></div><div class="ttdeci">uint32_t u32</div><div class="ttdef"><b>Definition:</b> asf_structure.h:46</div></div>
</div><!-- fragment --><h2><a class="anchor" id="eis_des_example"></a>
3.8 Example</h2>
<p >When EIS is enabled, pitch / yaw / roll correction can be performed simultaneously. </p><dl class="section note"><dt>Note</dt><dd>The parameters below must be set properly. <br  />
EIS source channel: <br  />
<b>"raw_feed_frame_num"</b> The capacity of the caching frame in external memory <br  />
<b>"raw_cached_items"</b> Active cached frame number <br  />
<b>"chan_input_src"</b> Set to 1 to save IDSP performance <br  />
EIS effective channel: <br  />
<b>"lens-warp"</b> Set to 1 <br  />
<b>"max_padding_width"</b> Specify the maximum padding width for stitched cases <br  />
<b>"raw_feed_frame_num"</b> Set to the same as that in the EIS source channel <br  />
<b>"eis_delay_count"</b> Set &gt;= 3; only required in the EIS effective channel</dd></dl>
<h3><a class="anchor" id="eis_ex_1"></a>
3.8.1 IMX274 + EVK + Enable "--eis-output"</h3>
<p >If users require both a larger stream resolution and a larger correction range, the parameter "--eis-output" can be used to set the EIS output size with a 16-pixel aligned width and an 8-pixel aligned height; the resolution must be smaller than the main buffer size. The EIS algorithm can upscale the correction content from the "--eis-output" size to the main buffer, which may result in resolution loss due to upscaling. <br  />
Example 4: Enable "--eis-output" Option </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">cv5x   # modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">cv7x   # modprobe imx274_mipi vinc_id=8</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">            [Vsrc information]:</div>
<div class="line">             VIN Controller[8]:</div>
<div class="line">                  vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=1 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">cv5x   # modprobe gyro_icm20648_mc</div>
<div class="line">cv7x   # modprobe gyro_icm42670_mc</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --enc-mode 0 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_4k_linear_eis.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_eis_warp --ch 1 -c 1000 -F 7200 -e 1920x1080</div>
<div class="line">     --&gt; enable (1), disable (0):</div>
<div class="line">     --&gt; Type 2 to enable EIS correction for <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> 1</div>
<div class="ttc" id="avin__init_8c_html_adf7dff2c57c0da9a4a2b70e3e815be31"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a></div><div class="ttdeci">int channel</div></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>The <b>"sensor_id", "agc_db_step", and "video_bits"</b> must read out from the master sensor channel.</dd></dl>
<h3><a class="anchor" id="eis_ex_2"></a>
3.8.2 IMX274 + EVK + Dual VIN EIS</h3>
<p ><br  />
Example 5: Multi-VIN EIS Currently, the CV5 / CV52 / CV72 EVKs cannot verify this feature, as there is only one IMU mounted, which cannot serve multiple video sources. Another video source demands an IMU hardware registered in the device tree. The IMU and video source must match one-to-one. </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">board # modprobe imx274_mipi vinc_id=0xf08</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">[Vsrc information]:</div>
<div class="line">VIN Controller[0]:</div>
<div class="line">      vsrc[1]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">VIN Controller[8]:</div>
<div class="line">      vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line"> </div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=2 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">cv5x   # modprobe gyro_icm20648_mc chan_map_active=0x5</div>
<div class="line">cv7x   # modprobe gyro_icm42670_mc chan_map_active=0x5</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --enc-mode 0 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_dual_vin_eis.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_efm -t 5 -i 1 -V 15</div>
<div class="line">board # test_eis_warp -c 1000 --ch 1 -F 7200 -e 1920x1080 --ch 3 -F 3400 -e 1920x1080</div>
<div class="line">     --&gt; enable (1), disable (0):</div>
<div class="line">     --&gt; Type 2 to enable EIS correction for <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> 1</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd><ul>
<li>The <b>"sensor_id, agc_db_step, video_bits"</b> must read out from the master sensor channel.</li>
</ul>
</dd></dl>
<h3><a class="anchor" id="eis_ex_3"></a>
3.8.3 IMX274 + EVK + Enable EIS and LDC</h3>
<p >If users design a case with a distorted lens, and require a result combining LDC and EIS, enable the flag "ldc". <br  />
Example 6: Enable EIS + LDC </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">cv5x   # modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">cv7x   # modprobe imx274_mipi vinc_id=8</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">            [Vsrc information]:</div>
<div class="line">             VIN Controller[8]:</div>
<div class="line">                  vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=1 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">cv5x   # modprobe gyro_icm20648_mc</div>
<div class="line">cv7x   # modprobe gyro_icm42670_mc</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --enc-mode 5 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_4k_linear_eis.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_eis_warp --ch 1 -c 1000 -F 7200 -e 1920x1080 --gdc 1</div>
<div class="line">     --&gt; enable (1), disable (0):</div>
<div class="line">     --&gt; Type 2 to enable EIS correction for <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> 1</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>The <b>"sensor_id", "agc_db_step", and "video_bits"</b> must read out from the master sensor channel.</dd></dl>
<h3><a class="anchor" id="eis_ex_4"></a>
3.8.4 IMX274 + EIS + Rotation</h3>
<p ><br  />
Example 7: Enable EIS + Rotation </p><div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">cv5x   # modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">cv7x   # modprobe imx274_mipi vinc_id=8</div>
<div class="line">board # test_encode --show-vsrc-info</div>
<div class="line">            [Vsrc information]:</div>
<div class="line">             VIN Controller[8]:</div>
<div class="line">                  vsrc[0]: imx274 (sensor_id: 0x3014, status: active, agc_db_step: 0x180000)</div>
<div class="line">board # modprobe ambds vin_virtual_flag=1 virtual_vsrc_num=1 custom_format_enable=1</div>
<div class="line">board # modprobe eis_mc</div>
<div class="line">cv5x   # modprobe gyro_icm20648_mc</div>
<div class="line">cv7x   # modprobe gyro_icm42670_mc</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode --enc-mode 5 --resource-cfg /usr/share/ambarella/lua_scripts/cv5_4k_linear_eis_rotate.lua --<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-capture 1 --enc-<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a>-rgb 1 --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">board # test_efm -t 5 -i 0 -V 14</div>
<div class="line">board # test_eis_warp --ch 1 -c 1000 -F 7200 -e 1920x1080</div>
<div class="line">     --&gt; enable (1), disable (0):</div>
<div class="line">     --&gt; Type 2 to enable EIS correction for <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> 1</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="eis_development"></a>
4. EIS Development</h1>
<p >Refer to <a class="el" href="../../d0/db2/test_eis_warp_8c-example.html">test_eis_warp.c</a> to learn how to develop user applications.</p><ul>
<li>Confirm the EIS effective channel and the EIS source channel at the system level</li>
<li>Configure warp parameters for EIS: lens focal length in um; <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_res_eis">eis output window</a>; <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_des_lens">enable rectilinear</a>; restore to the VIN FoV when EIS is disabled</li>
<li>Set the log level for the EIS library.</li>
<li>Initialize the EIS library with filter setup, callback function, gyro, and CMOS sensor configuration for the EIS effective channel</li>
<li>Compute the initial location of gyro raw data</li>
<li>If users are required to update parameters from "eis_rt_info_t" in real time, refer to the function "get_eis_stat_rt"</li>
<li>Enable or disable EIS by calling "eis_open()" or "eis_close()"</li>
<li>Ensure that the EIS process is alive at all times</li>
</ul>
<hr  />
<h1><a class="anchor" id="eis_tuning"></a>
5. Tuning</h1>
<p >In the EIS fine-tuning stage, users must pay attention to items below and check them one by one.</p><ul>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#gyro_tuning">5.1 Gyro</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#lens_tuning">5.2 Lens</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#timing_tuning">5.3 Timing</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#margin_tuning">5.4 Margin</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#filter_mode_tuning">5.5 Filter Mode</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#filter_scale_tuning">5.6 Filter Scale</a></li>
<li>Section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#debug_method">5.7 Debug Method</a></li>
</ul>
<h2><a class="anchor" id="gyro_tuning"></a>
5.1 Gyro</h2>
<ul>
<li><b>The location must be as close as possible to the CMOS image sensor.</b></li>
<li><b>Virtual axis mapping:</b> <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_va_map">2.3 Virtual Axis Mapping</a></li>
<li><b>Keep the camera stationary for 1~2 seconds to remove white noise data.</b></li>
<li><b>A larger ODR requires longer calculation time.</b></li>
</ul>
<h2><a class="anchor" id="lens_tuning"></a>
5.2 Lens</h2>
<ul>
<li><b>EFL range [2000um, 15000um]</b> <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_spec">1.2. EIS Specification</a> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 2000</div>
</div><!-- fragment --></li>
<li><b>Real-time update EFL for zoom lens:</b> Performed through the function "get_eis_stat_rt" (amba_eis_stat_t* eis_stat, void *rt_info), (similar to the shutter time update).</li>
<li><b>Fisheye lens</b> <br  />
Users must specify the full FoV to better remove the jelly effect. <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 2000 --fov 180</div>
</div><!-- fragment --> Users must specify the lookup table (LUT) table for more-accurate care of the distortion information. <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 2000 --fov 180 --lut-bin lens_file</div>
</div><!-- fragment --></li>
<li><b>Enable rectilinear:</b> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 3000 --ldc 1</div>
</div><!-- fragment --></li>
<li><b>Set the optical center:</b> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 3000 --optical-center axb</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="timing_tuning"></a>
5.3 Timing</h2>
<ul>
<li><b>Shutter:</b> eis_des_shutter</li>
<li><b>EIS delay count:</b> eis_delay_count</li>
</ul>
<h2><a class="anchor" id="margin_tuning"></a>
5.4 Margin</h2>
<ul>
<li><b>EIS output window:</b> <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_res_eis">3.4.2 EIS Window</a> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 3000 -e 1280x720</div>
</div><!-- fragment --></li>
<li><b>Region of interest (ROI) center:</b> <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_res_eis">3.4.2 EIS Window</a> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 3000 -e 1280x720 --roi-center 1024x864</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="filter_mode_tuning"></a>
5.5 Filter Mode</h2>
<ul>
<li><b>Action mode and stationary mode.</b> <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_filter_mode">3.5 EIS Filter Mode</a> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 1000 -F 3000 --filter-mode 1</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="filter_scale_tuning"></a>
5.6 Filter Scale</h2>
<ul>
<li><b>Frequency</b></li>
<li><b>EFL</b></li>
<li><b>Artifacts, abnormal shift</b></li>
<li><b>Avoid significant change in a real-time update</b></li>
</ul>
<h2><a class="anchor" id="debug_method"></a>
5.7 Debug Method</h2>
<ul>
<li><b>Dump the dmesg log to check if a EIS sync failure occurred.</b> <br  />
Ex: [123.456] #iav_error# Fail to update eis sync cmd!</li>
<li><b>See the library log via option "-d 2".</b> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 3000 -F 8000 -e 1280x720 -d 2</div>
</div><!-- fragment --></li>
<li><b>Dump gyro raw data via option "-s".</b> <div class="fragment"><div class="line">board# test_eis_warp --ch 1 -c 3000 -F 8000 -e 1280x720 -s /tmp/gyro_raw</div>
</div><!-- fragment --></li>
</ul>
<hr  />
<h1><a class="anchor" id="eis_qa"></a>
6. FAQ</h1>
<p >This chapter provides frequently asked questions (FAQs) and answers that are specific to EIS tuning. More information will be added in the future.</p>
<h2><a class="anchor" id="eis_qa_q1"></a>
Question 1. How can users ensure that the gyro is functioning as per the design?</h2>
<p ><b>Answer:</b> Ensure that the EIS library obtains the correct group of pitch / yaw / roll angular velocities. The three gyro axes should be vertically or horizontally aligned with the optical axis in the lens and the sensor plane. Further, virtual axis mapping (<a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_va_map">2.3 Virtual Axis Mapping</a>) should be configured in the DTS file. More checking points mentioned will be added in future.</p>
<h2><a class="anchor" id="eis_qa_q2"></a>
Question 2. Why is the EIS effect not as good as the EVK reference design solution?</h2>
<p ><b>Answer:</b> The EIS result may be affected by many factors, including the lens focal length, gyro data output frequency, gyro data filter design, and more. Different platforms may encounter slightly different EIS results. Below are some key points:</p><ul>
<li>Refer to the specific lens datasheet as the lens focal length parameter is very important.</li>
<li>The EIS algorithm functions with frequencies larger than 500Hz for 30fps and 1000HZ for 60fps. Ensure that the gyro raw data number of one frame is larger than 16.</li>
<li>The gyro sensor should be mounted as close as possible to the image sensor.</li>
<li>One gyro interrupt PIN must be used to export gyro data periodically in the circular buffer.</li>
<li>The gyro interrupt is configured as <b>falling-trigger</b> or <b>rising-trigger</b> in the driver.</li>
<li>Shutter time must be tuned correctly, as mentioned in eis_des_shutter</li>
</ul>
<h2><a class="anchor" id="eis_qa_q3"></a>
Question 3. Does EIS function with the LDC feature?</h2>
<p ><b>Answer:</b> Yes, Ambarella supports performing image stablization simultaneously with removing the distortion from the lens. Users can refer to example <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_ex_2">3.8.2 IMX274 + EVK + Dual VIN EIS</a>.</p>
<h2><a class="anchor" id="eis_qa_q4"></a>
Question 4. Does EIS function with the HDR feature?</h2>
<p ><b>Answer:</b> Currently, the EIS algorithm does NOT function with DOL-HDR mode, <b>but it does function with DCG-HDR mode (such as ov2775 DCG-HDR mode)</b>. In theory, DOL-HDR sets different exposure configurations for long and short frames before blending. DCG-HDR sets the same exposure configuration but different AE gains for two frames. Different exposure times may cause some trailing smears when EIS is functioning for quick vibration. Users must develop their own EIS algorithm for DOL-HDR input.</p>
<h2><a class="anchor" id="eis_qa_q5"></a>
Question 5. Does EIS function with the fisheye dewarp feature?</h2>
<p ><b>Answer:</b> No. EIS is only supported in encode modes 0 and 5 (refer to <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_enc">2.4 Encode Mode</a>), while fisheye dewarp is only supported in encode mode 1. From the IDSP perspective, different pipelines and different DSP commands are implemented in different encode modes.</p>
<h2><a class="anchor" id="eis_qa_q6"></a>
Question 6. Which gyro sensor is supported? If there is a new gyro sensor not included in the list, can it be supported ?</h2>
<p ><b>Answer:</b> The IMU sensor supported by Ambarella SDK is mainly from InvenSense; users can refer to <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_imu">3.2 IMU Selection</a>. If users require support for another IMU sensor, they can contact the Ambarella SDK team.</p>
<h2><a class="anchor" id="eis_qa_q7"></a>
Question 7. How do users define the size of the margin between the VIN window and the EIS output window?</h2>
<p ><b>Answer:</b> In order for EIS to function well, users must ensure that the VIN size has a sufficient margin between the EIS output window and the VIN window. The larger the amount of margin is left, the larger the range EIS can correct. The size of the margin depends on the active cases and therefore, the margin will differ. For products such as body-worn cameras that have large shaking amplitude, EIS requires 40% to 60%. For IPC products with small shaking amplitude, 30% to 40% is sufficient.</p>
<h2><a class="anchor" id="eis_qa_q8"></a>
Question 8. What is the process to re-configure the EIS library when the VIN resolution or frame rate changes?</h2>
<p ><b>Answer:</b> Follow the steps below for EIS to run as expected when there are changes to the VIN resolution or fps.</p><ol type="1">
<li><b>Disable</b> the EIS function.</li>
<li>Prepare new values for the corresponding parameters, then call <b>eis_setup(...)</b> to configure the parameters for the EIS library.</li>
<li><b>Re-enable</b> the EIS function.</li>
</ol>
<h2><a class="anchor" id="eis_qa_q9"></a>
Question 9. When EIS is enabled, why does DPTZ type I fail?</h2>
<p ><b>Answer:</b> DPTZ I performs crop / scale functions from VIN to the main buffer. Those parameters are not effective because the EIS library computation outputs related warp tables. The dummy window determines the active area from VIN, which is exactly the DPTZ I parameter.</p>
<h2><a class="anchor" id="eis_qa_q10"></a>
Question 10. Does Ambarella support IMU sensors that are not in included in the standard SDK?</h2>
<p ><b>Answer:</b> Ambarella recommends using the IMU sensors that are already supported in the SDK, as new IMU sensors would require extra support for drivers and verification. Further, new IMU sensor may entail extra support costs.</p>
<h2><a class="anchor" id="eis_qa_q11"></a>
Question 11. Does EIS require calibration?</h2>
<p ><b>Answer:</b> EIS does not currently require calibration.</p>
<h2><a class="anchor" id="eis_qa_q12"></a>
Question 12. What are the steps to configure the main buffer size of the EIS source channel and the EIS effective channel?</h2>
<p ><b>Answer:</b> To obtain lower bandwidths and better performance for the EIS source channel with no impact on the real-time 3A statistics, the main buffer width of the EIS source channel must be as a quarter of the VIN width (1/4). Users must configure the option <code>chan_input_src = 1</code> and set the main buffer size of the EIS effective channel to be the same as the VIN size. In the Lua file for the resource-cfg of test_encode, leave the input window as 0 for both channels, which permits the IAV driver to take the default operation.</p>
<h2><a class="anchor" id="eis_qa_q13"></a>
Question 13. How do you know the maximum correction angles with specific EIS output window size?</h2>
<p ><b>Answer:</b> Please refer to the section <a class="el" href="../../d6/db6/page_lib_eis_doc.html#eis_res_eis">3.4.2 EIS Window</a>.</p>
<h2><a class="anchor" id="eis_qa_q14"></a>
Question 14. Why does EIS cache a certain number of frames in external memory?</h2>
<p ><b>Answer:</b> The EIS algorithm can fetch gyro samples in the future frames starting from the current frame, which allows the algorithm to adjust warp table and input window location in advance to make it smoothly pass the large amplitude vibration.</p>
<hr  />
<h1><a class="anchor" id="sec_eis_api"></a>
7. EIS Application Programming Interface</h1>
<p >Visit the following link to get details of the application programming interface (API) functions.</p><ul>
<li><a class="el" href="../../db/dc1/group__eis-api-api.html">EIS Library API Details</a> explains API functions.</li>
<li><a class="el" href="../../d9/d62/group__eis-helper.html">EIS Library API Helper</a> shows related macros and enumerations.</li>
<li><a class="el" href="../../d7/d04/group__eis-struct.html">EIS Library Struct Helper</a> shows related structures.</li>
</ul>
<hr  />
<h1><a class="anchor" id="sec_eis_lic"></a>
8. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ("Software") are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
