<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Library: VFUNC Library API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Library"/>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="../../../library/mathjax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Library<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d36/page_lib_vfunc_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">VFUNC Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="vfunc_history"></a>
0. Revision History</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Library Version   </th><th class="markdownTableHeadLeft">Updated Date   </th><th class="markdownTableHeadLeft">Modification    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">0.0.1   </td><td class="markdownTableBodyLeft">20230503   </td><td class="markdownTableBodyLeft">Initial Version, Support 1) FEX, FMA, (Feature Points Extraction and Matching); 2) FFPYDLK (Fast Feature points Pyramid LK Tracking)   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="vfunc_introduction"></a>
1. Introduction</h1>
<p >VFunc is a library of visual algorithms based on VProc and algorithmic logic. The performance is boosted by utilizing Ambarella CVflow® chips and Arm® thread. <br  />
Currently, the VFunc supports CV2, CV22, CV25, CV5, and CV52 CVflow chips. <br  />
 </p><div class="image">
<img src="../../vfunc_arch.png" alt=""/>
<div class="caption">
Figure 3-1. Hierarchy of Libraries.</div></div>
<p> <br  />
 The VFunc functions are provided to the user as a prebuild library. Follow the below commands to enable the library:</p><ul>
<li>For CV2x SDK 3.0 Amba build <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Prebuild  ---&gt;</div>
<div class="line">             [*]   Configure Ambarella Vfunc library</div>
</div><!-- fragment --> To verify the functions of the VFunc library, follow the commands below to build the unit tests. The VFunc library is enabled when the unit tests are configured. <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">             [*]   Ambarella Private Linux Unit test configs  ---&gt;</div>
<div class="line">                [*]   Build CV unit tests  ---&gt;</div>
<div class="line">                   [*]   Build vfunc algorithm unit test</div>
</div><!-- fragment --></li>
<li>For Cooper Amba build <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   unit_test ---&gt;</div>
<div class="line">       <span class="keyword">private</span> ---&gt;</div>
<div class="line">           cv-test (unit_test/<span class="keyword">private</span>/cv_test/cavalry_v2) ---&gt;</div>
<div class="line">               [*]   Build vproc algorithm unit tests</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">   meta-ambaapp ---&gt;</div>
<div class="line">       recipes-test ---&gt;</div>
<div class="line">           cv-test (meta-ambaapp/recipes-test/cv-test) ---&gt;</div>
<div class="line">               [*]   Build vproc algorithm unit tests</div>
</div><!-- fragment --></li>
</ul>
<hr  />
<h1><a class="anchor" id="vfunc_library_example_usage"></a>
2. Example Usage</h1>
<h2><a class="anchor" id="vfunc_library_test_vfunc"></a>
2.1 VFunc Unit Test Application</h2>
<p >Dozens of unit test applications are provided for VFunc library verificaiton. Users can reference them as the sample code when writing applications. Enable the Cavalry driver before running a VFunc unit test with the command below.</p>
<div class="fragment"><div class="line">board # modprobe cavalry</div>
<div class="line">board # cavalry_load -f /lib/firmware/cavalry.bin -r</div>
</div><!-- fragment --><h3><a class="anchor" id="vfunc_library_test_vfunc_fma"></a>
2.1.1 test_vfunc_fma</h3>
<p >This function consists of two sub-modules: feature extraction (FEX) and feature matching (FMA). The sub-modules cowork together for the whole function.<br  />
 The following chart shows the process of FEX and FMA: <br  />
 </p><div class="image">
<img src="../../Process_of_FEX_and_FMA.jpg" alt=""/>
<div class="caption">
Figure 3-2. FEX and FMA Process.</div></div>
<p> <br  />
 FMA is based on hamming distance calculation; the size of the feature description is 256 binary bits, which is equal to 32 bytes. The FEX outputs the feature point positions and descriptions. For each point in image #0, FMA outputs the corresponding point index in image #1 with the nearest distance. The maximum feature points from FEX is 1024. FMA supports a maximum of 1024 matching pairs, which means 1024 points to 1024 points. The table below shows the invariance features of FEX. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Invariance   </th><th class="markdownTableHeadNone">Status    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Rotation / angle invariance   </td><td class="markdownTableBodyNone">Supported    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Luma invariance   </td><td class="markdownTableBodyNone">Supported    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Scale invariance   </td><td class="markdownTableBodyNone">Slightly supported when the image scales in the range from ~80% to ~120%.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Deformation invariance   </td><td class="markdownTableBodyNone">Slightly supported    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Blurred invariance   </td><td class="markdownTableBodyNone">Unsupported   </td></tr>
</table>
<p >test_vfunc_fma uses FEX to extract the feature points from two images, and then FMA performs feature point matching. The available options of test_vfunc_fma are as follows: </p><pre class="fragment"> -l --left_input            Path to the left input image. For example, -l left.jpg
 -r --right_input           Path to the right input image. For example, -r right.jpg
 -O --output                Path to output folder
 -s --resolution            Input resize resolution WxH.(Note: different width / height scale ratios will deform the rotated image; this will affect the matching result)
 -t --harris-threshold      Harris response threshold. For example, -t 0.001
 -n --max-harris_num        Maximum Harris point number. Maximum number of feature points is 1024
 -w --harris-nms-size       Set non-maximum suppression (NMS) window size; range is [7,64]
 -d --fma-dist-thresh       Matching distance threshold. Range is [0,256]; suggested range is [20,40]
 -o --angle-invariance      0: Angle variance. 1: Angle invariance
</pre><p >One example is provided using the command below: </p><div class="fragment"><div class="line">board # test_vfunc_fma -l left.jpg -r right.jpg -s 1280x720 -t 0.001 -n 1024 -w 25 -d 30 -o 1 -O /tmp</div>
</div><!-- fragment --><p> The following picture shows the test result of FEX and FMA </p><div class="image">
<img src="../../vfunc_fma_result.jpg" alt=""/>
<div class="caption">
Figure 3-3. FEX and FMA Results.</div></div>
<p> <br  />
 </p>
<h3><a class="anchor" id="vfunc_library_test_vfunc_fma_live"></a>
2.1.2 test_vfunc_fma_live</h3>
<p >The test_vfunc_fma_live application matches feature points and displays the matching result via livestream. It fetches the first frame as the reference frame, then extracts the reference feature points from the frame. By continually extracting the new feature points from the new frames, this test matches the new points to the reference points. The available test_vfunc_fma_live options are listed below: </p><pre class="fragment"> -s --resolution            Input resize resolution WxH
 -t --harris-threshold      Harris response threshold. For example, -t 0.001
 -n --max-harris-num        Maximum Harris point number. Maximum number of feature points is 1024
 -w --harris-nms-size       Set NMS window size, range is [7,64]
 -d --fma-dist-thresh       Matching distance threshold. Range is [0,256]; suggested range is [20,40]
 -m --run-mode              Run mode. 0: Continue mode. 1: Run-stop mode
 -o --angle-invariance      0: Angle variance. 1: Angle invariance
 -O --overlay-stream        Output stream ID. For example,  -O 0
</pre><p >Below is an example to run FEX and FMA in live mode. </p><div class="fragment"><div class="line">board # test_vfunc_fma_live -s 1280x720 -t 0.001 -n 1024 -w 25 -d 30 -o 1 -m 0</div>
</div><!-- fragment --><p> The following image shows a stereo slam demo, which primarily uses FEX, FMA from VFunc, and FBM from VProc.<br  />
 </p><div class="image">
<img src="../../fma_in_slam.gif" alt=""/>
<div class="caption">
Figure 3-4. Using FMA in Stereo Slam.</div></div>
<p> <br  />
 </p>
<h3><a class="anchor" id="vfunc_library_test_vfunc_ffpydlk_tracking"></a>
2.1.3 test_vfunc_ffpydlk_tracking</h3>
<p >The test_vfunc_ffpydlk_tracking application tracks the feature points from image0 to image1, and the tracking trajectory will be drawn to a result file. The available options of test_vfunc_ffpydlk_tracking are as follows: </p><pre class="fragment"> -s --resolution                    Input resize resolution WxH. For example, -s 720x640
 -l --left-input                    Path to left input image. For example, -l left.jpg
 -r --right-input                   Path to right input image. For example, -r right.jpg
 -t --opt-response-threshold        Threshold of LK response. For example, -t 0.01
 -w --lk-win-size                   LK window size. For example, set -w 11 for window size 11x11
 -p --opt-pyramid-number            Pyramid level number; pyramid number = level_num + 1. For example, -p 3
 -c --opt-pyramid-scale-factor      Pyramid down-scale factor; range is [0.5,0.9]. For example, -c 0.6
 -A --new-points-roi                Detection region of interest (ROI) of new Harris points (X#Y#W#H). For example, -A 320#180#320#320
 -d --harris-response-threshold     Harris response threshold. For example, -d 0.01
 -n --harris-nms-size               Set NMS window size, range is [7,64]
</pre><p >Follow the example to perform pyramid LK tracking in file mode. </p><div class="fragment"><div class="line">board # test_vfunc_ffpydlk_tracking -l 10.png  -r 11.png -s 1280x720 -t 0.005 -w 11 -p 4  -d 0.001 -n 13  -c 0.6 -A 0#0#1280#720</div>
</div><!-- fragment --><p >The following image shows the test result of ffpydlk. </p><div class="image">
<img src="../../ffpydlk_in.jpg" alt=""/>
<div class="caption">
Figure 3-5. The ffpydlk Input (the Right Image Shifts Right / Down from the Left Image).</div></div>
<p> <br  />
 </p><div class="image">
<img src="../../ffpydlk_out.png" alt=""/>
<div class="caption">
Figure 3-6. The ffpydlk Output.</div></div>
<p> <br  />
 </p>
<h3><a class="anchor" id="vfunc_library_test_vfunc_ffpydlk_tracking_live"></a>
2.1.4 test_vfunc_ffpydlk_tracking_live</h3>
<p >The test_vfunc_ffpydlk_tracking_live performs pyramid LK tracking in live mode; the tracking trajectory will be drawn to the canvas in output stream. The available test_vfunc_ffpydlk_tracking_live options are as follows: </p><pre class="fragment"> -s --resolution                Input resize resolution WxH. For example, -s 720x640
 -O --overlay-stream            output stream ID; for example, -O 0
 -t --opt-response-threshold    LK response threshold. For example, -t 0.01
 -w --lk-win-size               LK window size. For example, set -w 11 for window size 11x11
 -p --opt-pyramid-number        Pyramid level number; pyramid number = level_num + 1. For example, -p 3
 -c --opt-pyramid-scale-factor  Pyramid down-scale factor; range is [0.5,0.9]. For example, -c 0.6
 -f --opt-run-per-frames        Run tracking per N frames; for example, -f 2
 -A --new-points-roi            Detection ROI of new Harris points (X#Y#W#H). For example, -A 320#180#320#320
 -d --harris-response-threshold Harris response threshold. For example, -d 0.01
 -n --harris-nms-size           Set NMS window size, range is [7,64]
 -o --tracking-min-num          Minimum tracking points; -o 20
</pre><p >Use the command below to run test_vfunc_ffpydlk_tracking_live. </p><div class="fragment"><div class="line">board # test_vfunc_ffpydlk_tracking_live -s 1280x720 -t 0.0001 -w 11 -p 3  -f 1 -d 0.01 -n 48 -o 80 -c 0.6 -A 850#100#240#520 -O 0</div>
</div><!-- fragment --><p> <br  />
 </p><div class="image">
<img src="../../ffpydlk_live.jpg" alt=""/>
<div class="caption">
Figure 3-7. The ffpydlk Live Demo.</div></div>
<p> <br  />
</p>
<hr  />
<h1><a class="anchor" id="sec_vfunc"></a>
3. VFunc Performance</h1>
<p >The table below shows the VFunc performance on CV2x and CV5x chips. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">VFunc   </th><th class="markdownTableHeadNone">CV2   </th><th class="markdownTableHeadNone">CV22   </th><th class="markdownTableHeadNone">CV5    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">FEX (extract 200 points in 720p image <br  />
with / without rotation invariance)   </td><td class="markdownTableBodyNone">~9 ms / ~7 ms   </td><td class="markdownTableBodyNone">~10 ms / ~8 ms   </td><td class="markdownTableBodyNone">~6 ms / ~5 ms    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">FMA (300-point pair matching)   </td><td class="markdownTableBodyNone">~6 ms   </td><td class="markdownTableBodyNone">~6 ms   </td><td class="markdownTableBodyNone">~6 ms    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">FFPYDLK (track 200 points in 720p)   </td><td class="markdownTableBodyNone">~7 ms   </td><td class="markdownTableBodyNone">~7.5 ms   </td><td class="markdownTableBodyNone">~5.5 ms   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="sec_vfunc_api"></a>
4. VFunc API</h1>
<p >Visit the following link for details on application programming interface (API) functions.</p><ul>
<li><a class="el" href="../../d7/d6d/group__vfunc-api-details.html">VFunc Library API details</a> shows API lists.</li>
<li><a class="el" href="../../d4/d71/group__vfunc-helper.html">VFunc Library API helper</a> shows related macros, enumerations, and structures.</li>
</ul>
<hr  />
<h1><a class="anchor" id="sec_vfunc_lic"></a>
5. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
