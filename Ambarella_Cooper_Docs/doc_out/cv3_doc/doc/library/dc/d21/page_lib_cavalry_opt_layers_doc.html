<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Library: Cavalry Opt Layers Library API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Library"/>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="../../../library/mathjax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Library<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/d21/page_lib_cavalry_opt_layers_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Cavalry Opt Layers Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cavalry_opt_layers_history"></a>
0. Revision History</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Library Version   </th><th class="markdownTableHeadLeft">Updated Date   </th><th class="markdownTableHeadLeft">Modification    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">1.0.2   </td><td class="markdownTableBodyLeft">20200630   </td><td class="markdownTableBodyLeft">Initial Version    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">1.1.3   </td><td class="markdownTableBodyLeft">20231103   </td><td class="markdownTableBodyLeft">Added float dtcvt   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="cavalry_opt_layers_introduction"></a>
1. Introduction</h1>
<p >CVflow® can support most of layers for neural network, but some layers such as NMS, region of interest (ROI) pooling and ROI align layer cannot run on CVflow. So those layers have to run on Arm® processor. Library cavalry_opt_layers can support those layers and boost some of them by NEON code, like NMS, ROI pooling, ROI align and PS ROI pooling layers, and more.</p>
<p >Library cavalry_opt_layers is pure Arm code, which does not depend on CVflow hardware.</p>
<p >Follow these commands to build the library. And select some unit test for library special function.</p>
<ul>
<li>For CV2x SDK 3.0 Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Prebuild  ---&gt;</div>
<div class="line">             [*]   Configure Ambarella cavalry opt layers library</div>
<div class="line"> </div>
<div class="line">         [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">             [*]   Ambarella Private Linux Unit test configs  ---&gt;</div>
<div class="line">                [*]   Build CV unit tests  ---&gt;</div>
<div class="line">                   [*]   Build PVANet unit tests</div>
<div class="line">                   [*]   Build ROI Align unit tests with ARM implement</div>
<div class="line">                   [*]   Build PS ROI Pooling unit tests with ARM implement</div>
<div class="line">                   [*]   Build <span class="keywordtype">float</span> data conversion unit tests</div>
</div><!-- fragment --></li>
<li>For Cooper Amba build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         prebuild  ---&gt;</div>
<div class="line">             library  ---&gt;</div>
<div class="line">                 [*] prebuild-cavalry-opt-layers (prebuild/library/cavalry_opt_layers)</div>
<div class="line">         unit_test  ---&gt;</div>
<div class="line">             <span class="keyword">private</span>  ---&gt;</div>
<div class="line">                 [*] cv-test (unit_test/<span class="keyword">private</span>/cv_test/cavalry_v2)  ---&gt;</div>
<div class="line">         app  ---&gt;</div>
<div class="line">             ai_cam  ---&gt;</div>
<div class="line">                 [*] cvflow-test (app/ai_cam/cvflow)  ---&gt;</div>
<div class="line">                     [*]   Build PVANet unit tests</div>
<div class="line">                     [*]   Build <span class="keywordtype">float</span> data conversion unit tests</div>
</div><!-- fragment --></li>
<li>For Cooper Yocto build: <div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         meta-ambalib  ---&gt;</div>
<div class="line">             recipes-prebuild  ---&gt;</div>
<div class="line">                 [*] prebuild-cavalry-opt-layers (meta-ambalib/recipes-prebuild/prebuild-cavalry-opt-layers)</div>
<div class="line"> </div>
<div class="line">         meta-ambaapp  ---&gt;</div>
<div class="line">             recipes-test  ---&gt;</div>
<div class="line">                 [*] cv-test (meta-ambaapp/recipes-test/cv-test)  ---&gt;</div>
<div class="line">                 [*] cvflow-test (meta-ambaapp/recipes-test/cvflow-test)  ---&gt;</div>
<div class="line">                     [*]   Build PVANet unit tests</div>
<div class="line">                     [*]   Build <span class="keywordtype">float</span> data conversion unit tests</div>
</div><!-- fragment --> <hr  />
</li>
</ul>
<h1><a class="anchor" id="cavalry_opt_layers_example"></a>
2. Example Usage</h1>
<h2><a class="anchor" id="cavalry_opt_layers_test_pvanet"></a>
2.1 test_pvanet</h2>
<p >PVANet uses a two-step structure to perform an object detection, which reduces computational costs and improves the detection accuracy for most practical usages. Most of Layers can be run on CVflow harware, but some layers such as NMS, ROI pooling, and post processing are implemented in libcavalry_opt_layers. The unit test test_pvanet is an example to connect them together and print the object detection result in the end. The libcavalry_opt_layers can only be run on Ambarella platform, ensuring that digital signal processor (DSP) is in either of idle / preview / encoding state.</p>
<div class="fragment"><div class="line">build $ cd &lt;SDK&gt;/ambarella/unit_test/<span class="keyword">private</span>/cv_test/pvanet/arch_cv22</div>
<div class="line">build $ cavalry_gen -d rpn/vas_ouput -f pvanet_rpn_cavalry.bin</div>
<div class="line">build $ cavalry_gen -d rcnn_compress/vas_ouput -f pvanet_rcnn_compress_cavalry.bin</div>
<div class="line">board # test_encode --idle --nopreview</div>
<div class="line">board # test_pvanet -c -<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> arch_cv22/pvanet_rpn_cavalry.bin --in data=input.bin --out rpn_cls_prob_reshape --no --out rpn_bbox_pred --no --out concat_convf_permute --no  -<a class="code hl_variable" href="../../d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> arch_cv22/pvanet_rcnn_compress_cavalry.bin --in roi_pool_conv5 --no --out cls_prob --no --out bbox_pred --no</div>
<div class="line">=================== BBox Result =====================</div>
<div class="line">Class [7] [car] keep [1] bboxes</div>
<div class="line">  BBOX[0]: x1 = 0.898438, y1 = 130.125000, x2 = 171.125000, y2 = 260.750000, scores = 0.952637</div>
<div class="line">Class [12] [dog] keep [1] bboxes</div>
<div class="line">  BBOX[0]: x1 = 178.500000, y1 = 255.000000, x2 = 255.000000, y2 = 442.000000, scores = 0.999512</div>
<div class="line">Class [13] [horse] keep [1] bboxes</div>
<div class="line">  BBOX[0]: x1 = 261.750000, y1 = 104.750000, x2 = 543.500000, y2 = 464.500000, scores = 0.852051</div>
<div class="line">Class [15] [person] keep [2] bboxes</div>
<div class="line">  BBOX[0]: x1 = 344.500000, y1 = 7.937500, x2 = 452.250000, y2 = 302.000000, scores = 0.996094</div>
<div class="line">  BBOX[1]: x1 = 547.500000, y1 = 161.125000, x2 = 574.000000, y2 = 229.875000, scores = 0.878906</div>
<div class="line">================================================</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div><div class="ttdef"><b>Definition:</b> cJSON.h:255</div></div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_opt_layers_test_roi_align_arm"></a>
2.2 test_roi_align_arm</h2>
<p >ROI align is a technique based on bilinear interpolation to smoothly crop a patch from a full-image feature map based on a region proposal, and then resize the cropped patch to a desired spatial size. It was introduced in Mask R-CNN model.</p>
<ol type="1">
<li>ROI align is on one feature map. The image resolution is (H, W) (480, 640), and the scale is 16. The original feature map dimension is (C, H, W) [512, 30, 40], users should reshape and permute it to (H, W, C) [30, 40, 512] before feeding to roi_align. RoIs number is 50. The output dimension is (H, W, C) [7, 7, 512]. <div class="fragment"><div class="line">board # test_encode --idle --nopreview</div>
<div class="line">board # test_roi_align_arm -r rois_bbox_N50_fp32.bin -f fmap_30x40x512_s16.bin -n 50 -d 16 -F 40x30x512 -P 7x7 -o out_pooled_1_7x7x512.bin -t 2 -v</div>
<div class="line">RoI_Align:       5972 us</div>
</div><!-- fragment --></li>
<li>ROI align is on three feature maps. The image resolution is (H, W) (608, 1088), and three scales are 8, 16, and 32. Three feature maps dimensions are (C, H, W) [64, 76, 136], [64, 38, 68] and [64, 19, 34]. Users should reshape and permute these to (H, W, C) [76, 136, 64], [38, 68, 64] and [64, 19, 34] before feeding to roi_align. RoIs number is 100. The output dimension is (H, W, C) [14, 14, 64]. <div class="fragment"><div class="line">board # test_encode --idle --nopreview</div>
<div class="line">board # test_roi_align_arm -r rois_bbox_N100_fp32.bin -f fmap_76x136x64_s16.bin -f fmap_38x68x64_s16.bin -f fmap_19x34x64_s16.bin -n 100 -d 8 -F 136x76x64 -P 14x14 -o out_pooled_4_14x14x512.bin -t 2 -v</div>
<div class="line">RoI_Align:       3862 us</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="cavalry_opt_layers_test_psroipooling"></a>
2.3 test_psroipooling</h2>
<p >The position-sensitive RoI pooling (PS-RoI Pooling) layer in Light-Head R-CNN introduces spatial information during pooling. The image resolution is (H, W) (384, 512), and the scale is 16. The feature map dimension is (P, C, H, W) [21, 49, 24, 32], users should reshape and permute it to (C, H, W, P) [49, 24, 32, 21] before feeding to ps_roi_pooling. RoIs number is 300. The output dimension is (H, W, C) [7, 7, 21].</p>
<div class="fragment"><div class="line">board # test_encode --idle --nopreview</div>
<div class="line">board # test_psroipooling -r rois_300_fp32.bin -f fmap_49x24x32x21_fp32.bin -n 300 -d 16 -F 32x24x49x21 -P 7x7 -o out_pooled_7x7x21.bin -t 2 -v</div>
<div class="line">PS_RoI_Pooling:       9859 us</div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_opt_layers_test_float_dtcvt"></a>
2.3 test_float_dtcvt</h2>
<p >This is a NEON version implementation of data format conversion when an input or output is IEEE float32 data.</p>
<div class="fragment"><div class="line">board # test_encode --idle --nopreview</div>
<div class="line">board # test_float_dtcvt -i in.bin -o out.bin -s 1000x1000x1 -I 0,0,5,0 -O 1,2,0,7 -t</div>
<div class="line">board # test_float_scale -i in.bin -o out.bin -s 1000x1000x1 -I 0,0,5,0 -O 1,2,0,7 -r 1.00217 -t</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="sec_cavalry_opt_layers_api"></a>
3. Cavalry Opt Layers API</h1>
<p >Visit the following link for details on API functions.</p><ul>
<li><a class="el" href="../../da/dae/group__cavalry__opt__layers-api-details.html">Cavalry Opt Layers Library API details</a> shows API lists.</li>
<li><a class="el" href="../../d8/dc9/group__cavalry__opt__layers-helper.html">Cavalry Opt Layers Library API helper</a> shows related macros enumerations and structures.</li>
</ul>
<hr  />
<h1><a class="anchor" id="sec_cavalry_opt_layers_lic"></a>
4. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
