<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Driver: IAV Driver API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Driver"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Driver<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d3f/page_drv_iav_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">IAV Driver API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="iav_history"></a>
0. Revision History</h1>
<a class="anchor" id="drv_iav_rev_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Updated Date </th><th align="left">Modification </th></tr>
<tr>
<td>20210924 </td><td>Initial draft </td></tr>
<tr>
<td>20220415 </td><td>Update for SDK 1.0 </td></tr>
<tr>
<td>20230308 </td><td>Update for Cooper SDK 0.5 </td></tr>
<tr>
<td>20230821 </td><td>Update for Cooper SDK 1.0 </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="iav_intro"></a>
1. Introduction</h1>
<p >The Ambarella Cooper family systems on chip (SoCs) are ideal for multi-video input (VIN) camera applications. The platforms are driven by a Linux 64-bit operating system (OS) that runs on Arm® Dual-Cortex®-A76 cores of the Cv5x / CV7x processors. The Linux kernel is based on a standard 5.15.0+ GNU release with Ambarella modifications offered as a kernel patch. Device drivers are needed to make the device work properly and provide a user-friendly interface for applications.</p>
<p >The Cooper platform device driver is called the <em>Image</em> Audio Video (IAV) <em>Device</em> <em>Driver</em>. It includes a set of Linux device drivers that encapsulate the lower-level complexities of the Cooper platform digital signal processor (DSP) core functionalities. The drivers conform to the standard Linux driver model, exposing a series of application programming interfaces (APIs) that can be invoked using <b>ioctl()</b> system calls. These APIs are used by applications to configure and control the Cooper platform SoC in details, including the control of image, audio, and video. (Audio control is new in this version.)</p>
<p >Prototypes for the APIs and structures can be found in iav_ioctl.h. The image audio video (IAV) driver provides mechanisms to control some of the lower level hardware devices, such as the VIN module (sensor), video output (VOUT) module, and DSP cores.</p>
<p >In addition to providing user interfaces, the IAV driver also allows for coordination of the system to read the input image stream, process it, and encode it to an H.264, H.265 and/or Motion-JPEG bit stream. The figure below shows the work flow of the data process. </p><div class="image">
<img src="../../iav_hardware_flow.png" alt=""/>
<div class="caption">
Figure 1-1. Illustration of Hardware Work Flow.</div></div>
<hr  />
<h1><a class="anchor" id="iav_key_feature"></a>
2. Key Features of the APIs</h1>
<p >The IAV driver provides several groups of APIs that enable the application-level software to control the entire data processing flow. The APIs allow to control the following functionality:</p><ul>
<li>VIN control unit</li>
<li>Video output (VOUT) control unit</li>
<li>Image processing</li>
<li>H.265 / H.264 / motion-JPEG encode</li>
<li>RAW image / YUV image / ME1 image / ME0 image capture</li>
</ul>
<p >The key features of the API package are as follows:</p><ul>
<li>Supports video output with various resolutions and frame rates.</li>
<li>Supports frame buffer display on the VOUT preview.</li>
<li>Supports various image processing pipeline with different feature sets.</li>
<li>Supports VOUT preview with / without encoding.</li>
<li>Supports encoding to H.265 only, H.264 only, MJPEG only, and H.265/H.264 plus MJPEG multi-streaming, and other types of multi-streaming (up to 20 streams with different encoding sources).</li>
<li>Supports digital pan / tilt / zoom (DPTZ) of the encoded video bit stream and video output.</li>
</ul>
<hr  />
<h1><a class="anchor" id="iav_state_model"></a>
3. IAV Driver State Model</h1>
<h2><a class="anchor" id="iav_driver_state_machine"></a>
3.1 IAV Driver State Machine</h2>
<p >The IAV driver includes a state machine to protect the application from exercising the lower-level hardware in an unsupported manner. </p><div class="image">
<img src="../../iav_state_model_v6.png" alt=""/>
<div class="caption">
Figure 3-1. Driver State Model.</div></div>
<p >The following is a description of IAV state. </p><a class="anchor" id="table_iav_state"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>State </th><th>Description </th></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_init"></a>Init</b> </td><td>The IAV driver is loaded to kernel with empty configuration. And the DSP is not booted yet. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_idle"></a>Idle</b> </td><td>In this state, the hardware is idle and the user can issue commands to set up the VIN, VOUT, IDSP, and encoder modules, and reconfigure the system source buffers, or change to special settings that require the system to go idle in advance and so on. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_preview"></a>Preview</b> </td><td>The hardware processes incoming image data from the VIN module. Video output (VOUT) preview can be enabled/disabled and the VOUT resolution can be also changed. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_encoding"></a>Encoding</b> </td><td>The hardware encodes video data in this state. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_decoding"></a>Decoding</b> </td><td>The hardware decodes video data in this state. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_state_duplex"></a>Duplex</b> </td><td>The hardware is in preview / encoding and decoding state at the same time. </td></tr>
</table>
<h2><a class="anchor" id="iav_driver_boot_param"></a>
3.2 IAV driver boot param</h2>
<p >The IAV Driver initializes dsp module with <em><a class="elRef" target="_blank" href="../../../library/dd/dd8/structiav__dsp__boot__params.html">iav_dsp_boot_params</a></em> at the first time entering Preview state. And the boot parameters can't be modified after initialization.</p>
<p >The following is a description of dsp boot parameters. </p><a class="anchor" id="table_dsp_boot_params"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>param </th><th>Description </th></tr>
<tr>
<td><b><a class="anchor" id="anchor_boot_param_debug_chip_id"></a>debug_chip_id</b> </td><td>This section include "debug_chip_id_flag" and "debug_chip_id".<br  />
 If "debug_chip_id_flag" is set true, Dsp will use "debug_chip_id" instead of the real chip id. It's used to do different chip simulation in the one same chip. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_boot_param_vout_osd_rescale_disable"></a>vout_osd_rescale_disable</b> </td><td>This section include "vout_osd_rescale_flag" and "vout_osd_rescale_disable".<br  />
 If "vout_osd_rescale_flag" is set true, Dsp will determine whether OSD rescale ise enabled or disabled based on the value of "vout_osd_rescale_disable" for vout0 / vout 1. </td></tr>
<tr>
<td><b><a class="anchor" id="anchor_boot_param_vout_possible_map"></a>vout_possible_map</b> </td><td>This section include "vout_possible_map_flag" and "vout_possible_map".<br  />
 If "vout_possible_map_flag" is set true, Dsp will decide whether it is possile to support vout 0 or vout 1 based on the value of "vout_possible_map". It's used to allocate vout related resources inside Dsp. </td></tr>
</table>
<p><br  />
</p>
<hr  />
<h1><a class="anchor" id="iav_interrupts"></a>
4. IAV Interrrupts</h1>
<p >There are 3 interrupts generated as a group for each VIN controller.</p><ul>
<li><b>vin_idsp</b> - This interrupt is generated by DSP. It is signaled to Arm, when DSP finishes 1 frame capture.<ul>
<li>CV5 / CV52 has 14 VIN controllers (vin0 ~ vin13); it has 14 groups of VIN related interrupts.</li>
<li>CV72 has 10 VIN controllers (vin0 ~ vin3, vin8 ~ vin13); it has 10 groups of VIN-related interrupts.</li>
<li>Users can check this interrupt for VIN 0 using the command below: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vin0_idsp</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>vin_idsp_sof</b> - This interrupt is generated by VIN hardware. It is signaled to Arm, when VIN hardware receives the SOF (Start Of Frame) signal from the sensor.<ul>
<li>Users can check this interrupt for VIN 0 using: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vin0_idsp_sof</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>vin_idsp_last_pixel</b> - This interrupt is generated by VIN hardware. It is signaled to Arm, when VIN hardware receives the EOF (End Of Frame) signal from the sensor.<ul>
<li>Users can check this interrupt for VIN 0 using: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vin0_idsp_last_pixel</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
<p >There are 7 interrupts generated for DSP.</p><ul>
<li><b>vdsp</b> - This interrupt is a generic interrupt used for general cmd/msg exchange between Arm and DSP.<ul>
<li>It is a periodical interrupt with a default frequency of <b> 60 Hz </b>.</li>
<li>It is used by Arm to issue generic / encode DSP commands.</li>
<li>DSP will report generic system related information from messages.</li>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vdsp</div>
</div><!-- fragment --></li>
<li>IAV create the vdsp proc file for vdsp interrupt. User operations can sync to this interrupt use the proc file. example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#poll_irq_sync_usage_drv">11.13.2 Usage of Interrupt Synchronization</a></li>
</ul>
</li>
<li><b>vcap</b> - This interrupt is signaled to Arm, when DSP finishes processing one image digital signal processing (IDSP) stage of a single slice for one frame in IDSP stage.<ul>
<li>There are two IDSP stages, one is Raw to YUV stage, and the other one is YUV processing stage.</li>
<li>All the channels share the same vcap interrupt handler.</li>
<li>It is not a periodical interrupt. The frequency is the sum of IDSP stage number multiplied by frame slice number. For example, two channels like channel 0 IDSP out is 10fps with 4 slices, while channel 1 DSP output is 30fps with 2 slices, then the total <b>vcap</b> interrupt number is <b>100</b> (10 x 4 + 30 x 2) per second.</li>
<li>DSP will report canvas YUV data, when DSP finishes processing one frame's last stage of the last slice.</li>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vcap</div>
</div><!-- fragment --></li>
<li>IAV create the vcap proc file for vcap interrupt. User operations can sync to this interrupt use the proc file. example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#poll_irq_sync_usage_drv">11.13.2 Usage of Interrupt Synchronization</a></li>
</ul>
</li>
<li><b>venc</b> - This interrupt is generated by VDSP encoder. It is signaled to Arm, when DSP finishes encoding 1 frame or 1 slice of bit stream data.<ul>
<li>It is shared by all the encoded streams.</li>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep venc</div>
</div><!-- fragment --></li>
<li>IAV create the venc proc file for venc interrupt. User operations can sync to this interrupt use the proc file. example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#poll_irq_sync_usage_drv">11.13.2 Usage of Interrupt Synchronization</a></li>
</ul>
</li>
<li><b>async</b> - This interrupt is an asynchronization interrupt between Arm and DSP. It is a new mechnism for Arm and DSP to exchang cmd / msg instantly.<ul>
<li>It is used by Arm to issue IDSP / VIN / VDSP related commands.</li>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep async</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>vin</b> - This interrupt is signaled to Arm from DSP to report VIN relates messages, such as RAW data status msg.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vin</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>vpostp</b> - This interrupt is signaled to Arm, when DSP finishes processing one custom scalar job, which is in YUV processing stage.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vpostp</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>vcodec</b> - This interrupt is signaled to Arm from DSP to report codec relates messages.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep vcodec</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
<p >There are 3 interrupts generated for each VOUT controller.</p><ul>
<li><b>voutc0</b> - This interrupt is signaled to Arm, when DSP finishes sending 1 frame to VOUT A.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep voutc0</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>voutc1</b> - This interrupt is signaled to Arm, when DSP finishes sending 1 frame to VOUT B.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep voutc1</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><b>voutc2</b> - This interrupt is signaled to Arm, when DSP finishes sending 1 frame to VOUT C.<ul>
<li>Users can check this interrupt via: <div class="fragment"><div class="line">board # cat /proc/interrupts | grep voutc2</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="iav_encode_flow"></a>
5. Encoding Data Flow</h1>
<ul>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#sec_encode_concepts">5.1 Concepts</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#sec_encode_relation">5.2 Relationships and Data Flow</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#sec_encode_states">5.3 Encoding States</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#sec_encode_stream">5.4 Stream States</a> </li>
</ul>
<h2><a class="anchor" id="sec_encode_concepts"></a>
5.1 Concepts</h2>
<h3><a class="anchor" id="autotoc_md1"></a>
Encode Mode</h3>
<p >Currently, Cooper platforms support the following encoding modes:</p><ul>
<li>(Mode 0) Advanced ISO mode</li>
<li>(Mode 1) Multi-region dewarp mode</li>
<li>(Mode 5) HDR line interleaved mode</li>
<li>(Mode 8) Image pipeline only mode (Only for EIS source channel)</li>
</ul>
<p >Each mode works for a typical case or specific product type. Among these modes, there are many differences in image quality, encode performance, and the system resource configuration. Refer to <a class="elRef" target="_blank" href="../../../video/df/d92/fs_adv_enc_mode.html">ADVANCED - Encode Mode</a> to learn more details about the configuration and limitation of the encode mode.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
Channel</h3>
<p >The channel (demonstrated in the figure below) enables the system to support multiple sensors on one Cooper SoC. A channel is an independent unit that captures and processes raw data from an arbitrary sensor connected to Cooper SoC. Each channel has a separate 3A control process, which can include multiple source buffers (up to six for single-pass IDSP scalers). Since Cooper SoCs supports multiple VIN controllers natively, they can support multiple independent (four-lane) sensors into separate VIN controllers as multi-channel inputs.</p>
<p >For VIN controller, each one supports either one sensor or multiple sensors by bridge SERDES. Different VIN controllers can connect with different setting of sensors (different resolutions, sensor mode and sensor frame rate).</p>
<p >Each channel supports only one sensor. Different channels can connect from either different sensor, or from the same sensor as "IDSP virtual channels". Users can find more multi-channel information from the document <a class="elRef" target="_blank" href="../../../video/d3/dc4/fd_adv_multi_vin.html">ADVANCED - Multi-VIN &amp; Multi-Channel</a>.</p>
<div class="image">
<img src="../../iav_channel.jpg" alt=""/>
<div class="caption">
Figure 5-1. Channel.</div></div>
<h3><a class="anchor" id="autotoc_md3"></a>
Source Buffer</h3>
<p >Each channel has up to five source buffers: the main, the second, the third, the fourth, and the fifth. These five buffers are filled with YUV data from sensor / decoder / other output devices in real time. They have the same content with their channel's source VIN device. If the channel's pyramid buffers are disabled, it can be used to generate sixth source buffer.</p>
<p >See <a class="elRef" target="_blank" href="../../../video/d0/ded/fs_basic_source_buffer.html">Source Buffer</a>.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Canvas Buffer</h3>
<p >The canvas buffers are referred to as encode source buffers. They are also the containers of all channels' source buffers. In the multi-channel design, every channel's source buffer (from the main to the 6th buffer) can output the data with different resolutions independently. The application can put the final outputs of source buffers together into one canvas so that the stream encoded from this canvas can cover several field of views (FoVs) from different VIN channels. Alternatively, the application can encode several streams cropped from different areas of one canvas separately. Currently, CV5x / CV7x can support up to 20 canvases.</p>
<p >In <b>Case A</b>, a stream is encoded with the same size and FoV as its source canvas.</p>
<p >In <b>Case B</b>, a stream is encoded with a cut-out area and smaller FoV than its source canvas.</p>
<p >The above cases are two possible ways for a stream encoded from a source canvas. Since the source canvas contains the source buffers that have already been cropped and scaled from its channel's VIN, the streams can neither be in higher resolution than their source canvases, nor can they be scaled down from the source canvases. For example, if VIN is 1080p and the size of source canvas is 720p (has only one source buffer which is downscaled and has the same FoV with VIN), all streams encoded from this source canvas can only be up to 720p. If one stream is smaller than 720p in size, it must be cut out from the source canvas which sacrifices its FoV. As to one channel with single sensor, each canvas has only one source buffer. </p><div class="image">
<img src="../../iav_source_canvas.jpg" alt=""/>
<div class="caption">
Figure 5-2. Source Canvas.</div></div>
<p >See <a class="elRef" target="_blank" href="../../../video/d6/d71/fs_basic_canvas.html">Canvas</a>.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Encode Stream</h3>
<p >The encode stream is a stream during the state of encoding or preparing for encoding. It can be in H.265, H.264 or MJPEG format, with various resolution, GOP configuration, frame rate, and other properties.</p>
<p >Currently, CV5x / CV7x can support up to <b>20 encode streams</b>.</p>
<p >In the Cooper Linux SDK design, streams are independent of each other. The application can start / stop encoding one stream independently without affecting other running streams.</p>
<p >Additionally, each encoding stream format (H.265, H.264 or MJPEG) reconfiguration does not affect other encode streams, as long as the total resource is within the system limit.</p>
<h2><a class="anchor" id="sec_encode_relation"></a>
5.2 Relationships and Data Flow</h2>
<h3><a class="anchor" id="autotoc_md6"></a>
A. Source Canvas and Encode Stream Relationship</h3>
<p >The maximum number of streams supported by one source canvas is the same as the maximum number of streams that can be encoded at the same time. (e.g., if a system can support 8 streams, all streams can be encoded from the same source canvas.) </p><div class="image">
<img src="../../iav_canvas_relation.jpg" alt=""/>
<div class="caption">
Figure 5-3. Source Canvas and Encoded Stream Relationship.</div></div>
<p ><b>Currently, each channel can support up to five source buffers. The size of the sub-source buffer must be no larger than the size of the main source buffer.</b></p>
<p >The size of the main source buffer can be up to 8K (7680x4320) for CV5x, and up to 4K (3840x2160) for CV72.</p>
<p >All source buffers have a default resolution in IAV driver and can be reconfigured. However, since the encode stream depends on the source canvas which contains the final output of source buffers, the source buffer can be only configured when there is no active encode stream running on its source canvas.</p>
<p >Similarly, reconfiguring the main source buffer will also affect the other sub source buffer within same channel. Thus, it is necessary to go to the idle state before reconfiguring the main source buffer. In other words, in current Cooper IAV implementation, if the application must reconfigure the main source buffer format, it must first enter into the idle state.</p>
<p >The upper figure shows one example of the relationship between the source canvases and encoded streams. There are no restrictions on which source canvases can be used to encode a stream. The source canvas can be configured so that all streams are encoded from one canvas, or each stream is encoded from an independent source canvas.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
B. Multiple Source Buffer Relationship</h3>
<div class="image">
<img src="../../iav_source_relation.jpg" alt=""/>
<div class="caption">
Multiple Source Buffers Relation.</div></div>
<p >Within a channel, the second, third, fourth, fifth and sixth source buffers are re-scaled (scaled up or scaled down) from the main buffer. They can do digital PTZ (DPTZ type II) on the fly. Also, the main buffer can do digital PTZ (DPTZ type I) on the fly.</p>
<p >DPTZ type I will affect all its sub buffers within a channel, since the main buffer is their source. However, it will not affect the sub buffers of other channels. Because of the source buffer relationship, in order to have several streams with different resolutions, which are all scaled down with full FoV, it is necessary that each stream has an independent source canvas which contains only one scaled source buffer. This also affects overlay blending.</p>
<h3><a class="anchor" id="autotoc_md8"></a>
C. Synonyms/Exchangeable Terms</h3>
<a class="anchor" id="source_buffer"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV/DSP Driver Domain </th><th>Unit Test Application Domain </th><th>Comments </th></tr>
<tr>
<td>Capture buffer / Source buffer / Cap source </td><td>Source buffer </td><td>Buffers comprises canvas that is encoding/preview source. </td></tr>
<tr>
<td rowspan="2">Main source / capture Buffer </td><td rowspan="2">Main source buffer </td><td>Always exists, same or smaller than VIN. </td></tr>
<tr>
<td>Buffer size up to 8192x8192 for CV5x, up to 4096x4096 for CV7x. </td></tr>
<tr>
<td rowspan="2">Preview C buffer </td><td rowspan="2">Second source buffer </td><td>Encode source buffer, can be turn off. It is usually configured to be 480p or less. </td></tr>
<tr>
<td>Buffer size up to 3840x4096 for CV5x and CV7x. </td></tr>
<tr>
<td rowspan="2">Preview B buffer </td><td rowspan="2">Third source buffer </td><td>Can be configured as a source buffer for encode, or for VOUT B, or to turn off. It is usually configured to be 1080p or less. </td></tr>
<tr>
<td>Buffer size up to 7680x8192 for CV5x, up to 3840x4096 for CV7x. </td></tr>
<tr>
<td rowspan="2">Preview A buffer </td><td rowspan="2">Fourth source buffer </td><td>Can be configured as a source buffer for encode, or for VOUT A, or to turn off. It is usually configured to be 720p or less. </td></tr>
<tr>
<td>Buffer size up to 7680x8192 for CV5x, up to 3840x4096 for CV7x. </td></tr>
<tr>
<td rowspan="2">Preview D buffer </td><td rowspan="2">Fifth source buffer </td><td>Can be configured as a source buffer for encode, or for VOUT B, or to turn off. It is usually configured to be 1080p or less. </td></tr>
<tr>
<td>Buffer size up to 7680x8192 for CV5x, up to 3840x4096 for CV7x. </td></tr>
<tr>
<td rowspan="2">(Only available in second pass) </td><td rowspan="2">Sixth source buffer </td><td>Encode source buffer, can be turn off, up to 7680x8192 for CV5x, and up to 3840x4096 for CV7x. </td></tr>
<tr>
<td>Only available for CV2x, not for S6LM. </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Those buffer size follow: <b>VIN &gt;= Main Buffer &gt;= Sub Prev Buffer</b>.</li>
<li>Regarding CV2 8K user case, please contact the Ambarella support team.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="sec_encode_states"></a>
5.3 Encoding States</h2>
<p >There are several different states that correspond to different concepts in encoding. IAV encoding state: At least one of the streams is in encoding. Stream encoding state: The encoding state is independent for each stream. <br  />
 IAV encoding = "stream 1 in encoding" OR <br  />
 \t "stream 2 in encoding" OR <br  />
 \t "stream 3 in encoding" OR ... <br  />
 The source buffer has two states, <em>IDLE</em> or <em>BUSY</em>. If there is at least one stream encoding on the current buffer, then it is in <em>BUSY</em> state; otherwise, it is in <em>IDLE</em> state.</p>
<h2><a class="anchor" id="sec_encode_stream"></a>
5.4 Stream States</h2>
<ol type="1">
<li><em><b>Unknown:</b></em> The stream is un-initialized or un-configured.</li>
<li><em><b>Ready for encoding:</b></em> The stream is configured and ready for encoding, but has not started yet.</li>
<li><em><b>Starting:</b></em> The stream start command is issued to DSP, while DSP does not generate the first encode frame yet.</li>
<li><em><b>Encoding:</b></em> The stream has already started to encode.</li>
<li><em><b>Stopping:</b></em> The stream stop command is issued to DSP, while DSP does not generate the "stream end" NULL frame yet.</li>
</ol>
<hr  />
<h1><a class="anchor" id="iav_decode"></a>
6. Decoding Data Flow</h1>
<p >When preparing decoding data in decode mode, Arm and DSP share the same ring-buffer, known as bitstream buffer. IAV allocates and maintains this bitstream buffer for user application. User application accesses it via mmap (<a class="elRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#a6e160acba2472e919b41321d8fbe72faa2f3d77052a82568957924f8fd93495c4">IAV_PART_DEC_BSB</a>). When preparing data into the bitstream buffer, user application should do as follows:</p>
<p >a) Wait for the bitstream buffer to have enough free space which is released by DSP. This is to prevent data from being overwritten. The space can be checked via <a class="elRef" target="_blank" href="../../../library/dc/d2b/group__iav-ioctl-dec-api.html#gafd75b680e733fc0b998e4df6343ddfe5">IAV_IOC_WAIT_DECODE_BSB</a>.</p>
<p >b) The fed data should be continuous in memory and there should be no gap between the current and the next data chunk. Also, user application should take care of the ring buffer wrapper around case. The data chunk sent to the DSP begins with the start_pointer (include this byte) and ends with the end_pointer (not include this byte).</p>
<hr  />
<h1><a class="anchor" id="iav_sysfs_info"></a>
7. IAV Sysfs Info</h1>
<p >IAV driver supports to report IAV related state info via sysfs in CV2x / S6LM SDK. There are 3 sysfs files named <b>iav_info</b>, <b>iav_state</b>, and <b>iav_error</b>. Their location is under "/sys/devices/platform/iav/monitor/". Because the data format which sysfs files provided is binary, so user application should not use "cat" cmd to read these files. The data structures used in these sysfs files are defined as below. This module is mainly used for function safety, which means the application could use epoll to monitor these files. When some error happens, the application would receive the error report and get the error information. So it can help the application to do error handling and increase system stability at the same time.</p>
<h2><a class="anchor" id="iav_sysfs_file"></a>
7.1 IAV sysfs files</h2>
<ul>
<li><b>iav_info</b> - This file provides current IAV information. The application can read them out at anytime. The data structure used by iav_info file is defined as below. <dl class="section see"><dt>See also</dt><dd>iav_sysfs_info_msg</dd></dl>
</li>
<li><b>iav_state</b> - This file can be monitored by epoll in the user space. When the IAV state is changed, epoll would return and application can read the state changing information from it. The data structure used by iav_state file is defined as below. <dl class="section see"><dt>See also</dt><dd>iav_sysfs_state_msg</dd></dl>
</li>
<li><b>iav_error</b> - This file can also be monitored by epoll like iav_state file. When error happens in IAV, epoll would return and application can read the error information from it. The data structure used by iav_error file is defined as below. <dl class="section see"><dt>See also</dt><dd>amba_sysfs_error_msg</dd></dl>
example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_sysfs">11.12 Sysfs Usage</a></li>
</ul>
<hr  />
<h1><a class="anchor" id="iav_proc_info"></a>
8. IAV Procfs Info</h1>
<p >IAV driver uses procfs to expose some IAV related debug information in Cooper SDK.</p>
<h2><a class="anchor" id="iav_state_info"></a>
8.1 IAV State Info</h2>
<p >User can use proc file to show the current IAV status. The debug option proc file is <b>"/proc/ambarella/iav_state"</b>.</p>
<p >Here is the example shown the IAV state print, when IAV is in encoding state. </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/iav_state</span></div>
<div class="line">AMBARELLA_CHIP=CV5</div>
<div class="line">dsp_op_mode: 2</div>
<div class="line">dsp_encode_state: 1</div>
<div class="line">dsp_encode_mode: 5</div>
<div class="line">DSP DRAM: used 318 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, total 2304 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">DSP_CV DRAM: used 0 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, total 1 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="ttc" id="aiav__utils_8h_html_aa6b38d492364d98453284934ed7caee9"><div class="ttname"><a href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div><div class="ttdeci">#define MB</div><div class="ttdef"><b>Definition:</b> iav_utils.h:38</div></div>
</div><!-- fragment --><p >Below describes the information for each line:</p><ul>
<li>AMBARELLA_CHIP: This shows the current chip name for the Cooper family.</li>
<li>dsp_op_mode: This shows the current DSP operation mode, 0: Init; 1: Idle; 2: Encode; 3: Decode</li>
<li>dsp_encode_state: This shows the current DSP state for encode pipeline, 0: Idle; 1: Running</li>
<li>dsp_encode_mode: This shows the IDSP pipeline, also named encoding mode. See <a class="el" href="../../df/d3f/page_drv_iav_doc.html#sec_encode_concepts">5.1 Concepts</a>.</li>
<li>DSP DRAM: This shows the used and total DSP DRAM size.</li>
<li>DSP_CV DSP DRAM: This shows the used and total DRAM size shared by DSP and CV, for encode mode 9.</li>
</ul>
<h2><a class="anchor" id="iav_memory_info"></a>
8.2 IAV Memory Info</h2>
<p >User can use proc file to check the current IAV/DSP memory usage. The debug option proc file is <b>"/proc/ambarella/iav_mem"</b>.</p>
<p >Here is the example shown the IAV/DSP memory usage, when IAV is in encoding state. </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/iav_mem</span></div>
<div class="line">DSP Dram:</div>
<div class="line">DSP DRAM Used: 318 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, Limited: 2304 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>.</div>
<div class="line">Shared DSP CV DRAM Used: 0 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, Limited: 1 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>.</div>
<div class="line">Dram Bandwidth:</div>
<div class="line">Chip ID [0]: DSP memory bandwidth limit [23565 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>/s].</div>
</div><!-- fragment --><p >Below describes the information for each line:</p><ul>
<li>The current DSP DRAM size used by DSP is 318 MB, and the total DSP memory size is 2304 MB.</li>
<li>The current DSP CV shared DRAM size is 0 MB, and the total memory size is 1 MB.</li>
<li>The current used DRAM memory bandwidth limit is 23565 MB/s.</li>
</ul>
<h2><a class="anchor" id="iav_feature_debug"></a>
8.3 IAV Feature Debug</h2>
<p >If users encounter some problems with some features such as EFM or manual feed, there is a debug option which can be switched on to output more kernel messages related to those features. The debug option proc file is <b>"/proc/ambarella/iav_feature_print"</b>.</p>
<p >The configuration below is required to enable this feature. </p><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">       [*] drv_modules  ---&gt;</div>
<div class="line">           [*]   <span class="keyword">private</span>  ---&gt;</div>
<div class="line">               -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">                   [*]   Enable iav feature debug</div>
</div><!-- fragment --><p >The default IAV feature print setting is provided as shown below. </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/iav_feature_print</span></div>
<div class="line">The current feature print bitmap: 0xffffff80</div>
<div class="line">The last feature print bitmap: 0xffffffff</div>
<div class="line">EFM:                    bit[0]: disable</div>
<div class="line">RAW Encode:             bit[1]: disable</div>
<div class="line">RAW Manual Feed:        bit[2]: disable</div>
<div class="line">Pyramid Manual Feed:    bit[3]: disable</div>
<div class="line">Canvas Manual Feed:     bit[4]: disable</div>
<div class="line">IMG Scaler:             bit[5]: disable</div>
<div class="line">VOUT Msg:               bit[6]: disable</div>
</div><!-- fragment --><p >Users can set the corresponding bit(s) to enable EFM and canvas manual feed printing. </p><div class="fragment"><div class="line"><span class="preprocessor"># echo 0xffffff91 &gt; /proc/ambarella/iav_feature_print</span></div>
<div class="line"><span class="preprocessor"># cat /proc/ambarella/iav_feature_print</span></div>
<div class="line">The current feature print bitmap: 0xffffff91</div>
<div class="line">The last feature print bitmap: 0xffffff80</div>
<div class="line">EFM:                    bit[0]: enable</div>
<div class="line">RAW Encode:             bit[1]: disable</div>
<div class="line">RAW Manual Feed:        bit[2]: disable</div>
<div class="line">Pyramid Manual Feed:    bit[3]: disable</div>
<div class="line">Canvas Manual Feed:     bit[4]: enable</div>
<div class="line">IMG Scaler:             bit[5]: disable</div>
<div class="line">VOUT Msg:               bit[6]: disable</div>
</div><!-- fragment --><h2><a class="anchor" id="iav_ioctl_arg_print_function"></a>
8.4 IAV IOCTL Arguments Print</h2>
<p >This function is used to print the arguments of IAV IOCTL APIs at runtime. Through it, users can check whether the input parameters of each IAV IOCTL API are prepared correctly by user app or not. The total number of IAV IOCTL APIs is nearly 130. They are classified into 16 categories for the arguments print. Each category uses one bit to enable/disable printing their arguments.</p>
<p >Example 1: IAV IOCTL Categories and Corresponding Bitmap. </p><div class="fragment"><div class="line">board# cat /proc/ambarella/iav_ioc_arg_print</div>
<div class="line">The current IOCTL category bitmap: 0x0</div>
<div class="line">The last IOCTL category bitmap: 0x0</div>
<div class="line">System:                 bit[0]: disable</div>
<div class="line">VIN:                    bit[1]: disable</div>
<div class="line">VOUT:                   bit[2]: disable</div>
<div class="line">Pyramid:                bit[3]: disable</div>
<div class="line">EFM:                    bit[4]: disable</div>
<div class="line">EFR:                    bit[5]: disable</div>
<div class="line">Memory Management:      bit[6]: disable</div>
<div class="line">Stream:                 bit[7]: disable</div>
<div class="line">Overlay Blur:           bit[8]: disable</div>
<div class="line">Vcap:                   bit[9]: disable</div>
<div class="line">Warp:                   bit[10]: disable</div>
<div class="line">VProc:                  bit[11]: disable</div>
<div class="line">VIN IDSP:               bit[12]: disable</div>
<div class="line">Debug:                  bit[13]: disable</div>
<div class="line">Decoder:                bit[14]: disable</div>
<div class="line">Image Scaler:           bit[15]: disable</div>
</div><!-- fragment --><p >Example 2: Turn on IAV IOCTL Arg print and Check Dmesg Log. </p><div class="fragment"><div class="line">board# echo 0x00000001 &gt; /proc/ambarella/iav_ioc_arg_print</div>
<div class="line">board# cat /proc/ambarella/iav_ioc_arg_print</div>
<div class="line">The current IOCTL category bitmap: 0x1</div>
<div class="line">The last IOCTL category bitmap: 0x0</div>
<div class="line">System:                 bit[0]: enable</div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line">.</div>
<div class="line">&lt;--Run an app <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#aa2a4dae2a14de4093826005f9bdfd3bb">which</a> uses IAV IOCTLs to output the dmesg log. Like: test_encode--&gt;</div>
<div class="line">.</div>
<div class="line">board# dmesg</div>
<div class="line">&lt;--Below is the iav ioctl arg print log. Example: IOCTL---<a class="code hl_define" href="../../dummy.html">IAV_IOC_GET_PYRAMID_CFG</a>--&gt;</div>
<div class="line">[ 6747.968267] IOCTL BEGIN: <a class="code hl_define" href="../../dummy.html">IAV_IOC_GET_PYRAMID_CFG</a></div>
<div class="line">[ 6747.968270] <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html">iav_pyramid_cfg</a></div>
<div class="line">[ 6747.968273]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a85599fa0eac7165aaca13aa21f0e6b38">chan_id</a> = 0</div>
<div class="line">[ 6747.968278]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a> = 0</div>
<div class="line">[ 6747.968280]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ae454fecbfa8025ee2d1d616262a0c80b">input_buf_id</a> = 4</div>
<div class="line">[ 6747.968283]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a4bf896a774a444c0f6a58cae0b309b4a">layers_map</a> = 0x0</div>
<div class="line">[ 6747.968285]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a2a5e13ebe9170301f0a0cba40ad35108">manual_feed</a> = 0</div>
<div class="line">[ 6747.968288]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a9db36da7f77c042da881925e0b1ddbdb">set_min_unlocked_buf_num</a> = 0</div>
<div class="line">[ 6747.968290]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a5865d4c940c5e813d45f7fd89c1c0b69">item_num</a> = 4</div>
<div class="line">[ 6747.968293]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a40c53ec8fd00797523bcab66e735a923">scale_type</a> = 0</div>
<div class="line">[ 6747.968298]     buf_addr = 0</div>
<div class="line">[ 6747.968300]     buf_size = 0</div>
<div class="line">[ 6747.968302]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a934dbe6cdccbcd99aab0420a975f36c6">frame_rate</a> = 0</div>
<div class="line">[ 6747.968304]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a218b77347c923f82b98e7c094408be0f">min_unlocked_buf_num</a> = 0</div>
<div class="line">[ 6747.968307]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#aa9f2da3332deb454ae3cad18620ebada">max_layers_map</a> = 0x0</div>
<div class="line">[ 6747.968309]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a6ff06540fb1270e9f6e41ac3bc972068">enable_frame_tag</a> = 0</div>
<div class="line">[ 6747.968312]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a1f1c2a0258bc91d30b16c17e1c4011c0">cached_items</a> = 1</div>
<div class="line">[ 6747.968317]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ac0cfe9bd3f347e62fd0bd3bceab31284">rescale_size</a>.<a class="code hl_variable" href="../../df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> = 0</div>
<div class="line">[ 6747.968319]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ac0cfe9bd3f347e62fd0bd3bceab31284">rescale_size</a>.<a class="code hl_variable" href="../../df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a> = 0</div>
<div class="line">[ 6747.968322]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ae5857c195e100440d1105b33053713de">max_rescale_size</a>.<a class="code hl_variable" href="../../df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> = 0</div>
<div class="line">[ 6747.968324]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ae5857c195e100440d1105b33053713de">max_rescale_size</a>.<a class="code hl_variable" href="../../df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a> = 0</div>
<div class="line">[ 6747.968327]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a421a77673ea0cf3022c92fda8037314b">frame_tag</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/d6/db0/structiav__frame__tag.html#ad21d3c023f49c2da4c77f84340fd6b26">value</a> = 0</div>
<div class="line">[ 6747.968329]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a421a77673ea0cf3022c92fda8037314b">frame_tag</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/d6/db0/structiav__frame__tag.html#abef421db8c3f55f9fa7c05727c4ab3e4">mask</a> = 0x0</div>
<div class="line">[ 6747.968334]     <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#aae39e0f2db3b263395416c4ade3a2a30">frame_rate_hp</a> = 0x0</div>
<div class="line">[ 6747.968336] IOCTL END: <a class="code hl_define" href="../../dummy.html">IAV_IOC_GET_PYRAMID_CFG</a></div>
<div class="ttc" id="acJSON_8h_html_aa2a4dae2a14de4093826005f9bdfd3bb"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aa2a4dae2a14de4093826005f9bdfd3bb">which</a></div><div class="ttdeci">int which</div></div>
<div class="ttc" id="adummy_html"><div class="ttname"><a href="../../dummy.html">IAV_IOC_GET_PYRAMID_CFG</a></div><div class="ttdeci">#define IAV_IOC_GET_PYRAMID_CFG</div></div>
<div class="ttc" id="agroup__IAV_html_ga85db88ffee2944ecd35c616393976289"><div class="ttname"><a href="../../df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">iav_window::width</a></div><div class="ttdeci">u32 width</div><div class="ttdoc">Window width.</div><div class="ttdef"><b>Definition:</b> basetypes.h:96</div></div>
<div class="ttc" id="agroup__IAV_html_gadd40f8a56ae8cc650f92a3aa4d2bac99"><div class="ttname"><a href="../../df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">iav_window::height</a></div><div class="ttdeci">u32 height</div><div class="ttdoc">Window height.</div><div class="ttdef"><b>Definition:</b> basetypes.h:97</div></div>
<div class="ttc" id="astructiav__frame__tag_html_abef421db8c3f55f9fa7c05727c4ab3e4"><div class="ttname"><a href="../../../library/d6/db0/structiav__frame__tag.html#abef421db8c3f55f9fa7c05727c4ab3e4">iav_frame_tag::mask</a></div><div class="ttdeci">u32 mask</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1466</div></div>
<div class="ttc" id="astructiav__frame__tag_html_ad21d3c023f49c2da4c77f84340fd6b26"><div class="ttname"><a href="../../../library/d6/db0/structiav__frame__tag.html#ad21d3c023f49c2da4c77f84340fd6b26">iav_frame_tag::value</a></div><div class="ttdeci">u32 value</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1465</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html">iav_pyramid_cfg</a></div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a1f1c2a0258bc91d30b16c17e1c4011c0"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a1f1c2a0258bc91d30b16c17e1c4011c0">iav_pyramid_cfg::cached_items</a></div><div class="ttdeci">u16 cached_items</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1553</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a218b77347c923f82b98e7c094408be0f"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a218b77347c923f82b98e7c094408be0f">iav_pyramid_cfg::min_unlocked_buf_num</a></div><div class="ttdeci">u8 min_unlocked_buf_num</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1548</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a2a5e13ebe9170301f0a0cba40ad35108"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a2a5e13ebe9170301f0a0cba40ad35108">iav_pyramid_cfg::manual_feed</a></div><div class="ttdeci">u32 manual_feed</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1538</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a40c53ec8fd00797523bcab66e735a923"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a40c53ec8fd00797523bcab66e735a923">iav_pyramid_cfg::scale_type</a></div><div class="ttdeci">enum iav_pyramid_scale scale_type</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1546</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a421a77673ea0cf3022c92fda8037314b"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a421a77673ea0cf3022c92fda8037314b">iav_pyramid_cfg::frame_tag</a></div><div class="ttdeci">struct iav_frame_tag frame_tag</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1563</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a4bf896a774a444c0f6a58cae0b309b4a"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a4bf896a774a444c0f6a58cae0b309b4a">iav_pyramid_cfg::layers_map</a></div><div class="ttdeci">u32 layers_map</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1537</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a5865d4c940c5e813d45f7fd89c1c0b69"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a5865d4c940c5e813d45f7fd89c1c0b69">iav_pyramid_cfg::item_num</a></div><div class="ttdeci">u32 item_num</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1542</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a6ff06540fb1270e9f6e41ac3bc972068"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a6ff06540fb1270e9f6e41ac3bc972068">iav_pyramid_cfg::enable_frame_tag</a></div><div class="ttdeci">u32 enable_frame_tag</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1543</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a85599fa0eac7165aaca13aa21f0e6b38"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a85599fa0eac7165aaca13aa21f0e6b38">iav_pyramid_cfg::chan_id</a></div><div class="ttdeci">u32 chan_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1534</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a934dbe6cdccbcd99aab0420a975f36c6"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a934dbe6cdccbcd99aab0420a975f36c6">iav_pyramid_cfg::frame_rate</a></div><div class="ttdeci">u8 frame_rate</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1547</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_a9db36da7f77c042da881925e0b1ddbdb"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#a9db36da7f77c042da881925e0b1ddbdb">iav_pyramid_cfg::set_min_unlocked_buf_num</a></div><div class="ttdeci">u32 set_min_unlocked_buf_num</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1540</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_aa9f2da3332deb454ae3cad18620ebada"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#aa9f2da3332deb454ae3cad18620ebada">iav_pyramid_cfg::max_layers_map</a></div><div class="ttdeci">u16 max_layers_map</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1551</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_aae39e0f2db3b263395416c4ade3a2a30"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#aae39e0f2db3b263395416c4ade3a2a30">iav_pyramid_cfg::frame_rate_hp</a></div><div class="ttdeci">u32 frame_rate_hp</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1566</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_ab4b3cc0eb8d6dbd703f05e219194af8e"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">iav_pyramid_cfg::enable</a></div><div class="ttdeci">u32 enable</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1535</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_ac0cfe9bd3f347e62fd0bd3bceab31284"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ac0cfe9bd3f347e62fd0bd3bceab31284">iav_pyramid_cfg::rescale_size</a></div><div class="ttdeci">struct iav_window rescale_size</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1557</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_ae454fecbfa8025ee2d1d616262a0c80b"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ae454fecbfa8025ee2d1d616262a0c80b">iav_pyramid_cfg::input_buf_id</a></div><div class="ttdeci">u32 input_buf_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1536</div></div>
<div class="ttc" id="astructiav__pyramid__cfg_html_ae5857c195e100440d1105b33053713de"><div class="ttname"><a href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ae5857c195e100440d1105b33053713de">iav_pyramid_cfg::max_rescale_size</a></div><div class="ttdeci">struct iav_window max_rescale_size</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1561</div></div>
</div><!-- fragment --><p> <br  />
</p>
<hr  />
<h1><a class="anchor" id="dsp_proc_info"></a>
9. DSP Procfs Info</h1>
<h2><a class="anchor" id="iav_optional_dsp_cmd_print"></a>
9.1 Optional DSP command printing</h2>
<p >In Cooper SDK, a switch to enable and disable some commands printing dynamically is implemented. To switch off certain kind of command for better debug is supported. The switch is implemented by reading and writing <b>"/proc/ambarella/dsp_print"</b>.</p>
<p >Show the default DSP printing setting: </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/dsp_print</span></div>
<div class="line">The current dsp print bitmap: 0xbfffff3f</div>
<div class="line">The last dsp print bitmap: 0xffffffff</div>
<div class="line">DSP_CMD_PRINT_GEN:      bit[0]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VPROC:    bit[1]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VIN:      bit[2]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VOUT:     bit[3]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VENC:     bit[4]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VDEC:     bit[5]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_IMG:      bit[6]: disable</div>
<div class="line">DSP_CMD_PRINT_VDEC_MORE bit[7]: disable</div>
<div class="line">UNUSED: bit[8]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[9]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[10]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">...</div>
<div class="line">UNUSED: bit[28]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[29]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_RAW:      bit[30]: disable</div>
<div class="line">DSP_CMD_PRINT_MORE:     bit[31]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
</div><!-- fragment --><p >Reset the default DSP printing setting to enable IMG 3A related printing: </p><div class="fragment"><div class="line"><span class="preprocessor"># echo 0xbffff836 &gt; /proc/ambarella/dsp_print</span></div>
<div class="line"><span class="preprocessor"># cat /proc/ambarella/dsp_print</span></div>
<div class="line">The current dsp print bitmap: 0xbfffff7f</div>
<div class="line">The last dsp print bitmap: 0xbfffff3f</div>
<div class="line">DSP_CMD_PRINT_GEN:      bit[0]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VPROC:    bit[1]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VIN:      bit[2]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VOUT:     bit[3]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VENC:     bit[4]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VDEC:     bit[5]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_IMG:      bit[6]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">DSP_CMD_PRINT_VDEC_MORE bit[7]: disable</div>
<div class="line">UNUSED: bit[8]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[9]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[10]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">...</div>
<div class="line">UNUSED: bit[28]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
<div class="line">UNUSED: bit[29]: <a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a></div>
</div><!-- fragment --><p ><br  />
</p>
<h2><a class="anchor" id="iav_dsp_state_proc_file"></a>
9.2 DSP state</h2>
<p >Users need to pay attention to two states of DSP when the system is running:</p><ol type="1">
<li>Assertion state. When some behaviors unsupported by DSP occur, DSP will enter assertion state and stop running, and Linux will lose communication with DSP. Users must reboot to recover it.</li>
<li>Abnormal state. When DSP detects abnormal clock information or lose it for a long time, it will enter abnormal state. Users can re-enter PREVIEW with right clock information to recover it.</li>
</ol>
<p >Users can get DSP state by reading <b>"/proc/ambarella/dsp_state"</b> as below. This file is read-only.</p>
<p >Show the default DSP state: </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/dsp_state</span></div>
<div class="line">The current dsp state bitmap:  0x0</div>
<div class="line">[bit0] DSP_STATE_ASSERT  : not assert</div>
<div class="line">[bit1] DSP_STATE_ABNORMAL: normal</div>
</div><!-- fragment --><p >If something unexpected happened, users will get messages as below: </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/dsp_state</span></div>
<div class="line">The current dsp state bitmap:  0x1</div>
<div class="line">[bit0] DSP_STATE_ASSERT  : assert!</div>
<div class="line">[bit1] DSP_STATE_ABNORMAL: normal</div>
</div><!-- fragment --><p> or </p><div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/dsp_state</span></div>
<div class="line">The current dsp state bitmap:  0x2</div>
<div class="line">[bit0] DSP_STATE_ASSERT  : not assert</div>
<div class="line">[bit1] DSP_STATE_ABNORMAL: abnormal!</div>
</div><!-- fragment --><p ><br  />
 </p><hr  />
<h1><a class="anchor" id="iav_poll"></a>
10. Poll interface</h1>
<h2><a class="anchor" id="drv_query_iav_data"></a>
10.1 Poll interface to query IAV data</h2>
<p >IAV driver supports poll interface to query the iav data. It waits for one of a set of events to become ready to perform I/O. These events include the <b>IAV_DESC_FRAME</b>, <b>IAV_DESC_STATIS</b>, <b>IAV_DESC_RAW</b>, <b>IAV_DESC_CANVAS</b>, <b>IAV_DESC_PYRAMID</b>, <b>IAV_DESC_SLICE</b>, <b>IAV_DESC_PRE_COUNT</b> and so on. The caller should specify the events of interested before the poll. And then using the poll API wait the events ready. This feature supports the multiple users and can poll multiple events at one time.</p>
<p >example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#poll_iav_data_usage_drv">11.13.1 Usage of Querying IAV Data</a></p>
<h2><a class="anchor" id="drv_irq_sync"></a>
10.2 Poll interface to sync irq</h2>
<p >IAV driver supports to use standard poll mechanism to synchronize with different DSP interrupts. With this feature users can synchronize their operations to the interrupt. IAV driver supports the vcap, vdsp, and venc interrupt sync now. IAV driver creates vcap, vdsp, and venc proc file for interrupt sync. Vcap proc file is created for per channel and venc proc file is created for per stream. Users can use the proc file to synchronize the certain interrupt, please check unit_test/private/iav_test/arch_v5/test_irq_sync.c</p>
<p >example: <a class="el" href="../../df/d3f/page_drv_iav_doc.html#poll_irq_sync_usage_drv">11.13.2 Usage of Interrupt Synchronization</a></p>
<hr  />
<h1><a class="anchor" id="iav_example"></a>
11. Example Usage of APIs</h1>
<p >In order to encode a stream, the general work flow of IAV driver is as follows.</p>
<ol>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_open">Open the Device</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_mem">Map Bitstream Memory</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_vin">Init VIN Controller</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_vout_config">Init VOUT Controller</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_go_to_idle">Go to Idle from Init</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_dsp_configuration">Configure DSP Resource</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_enter_preview">Enter Preview State</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_stream_configuration">Configure Stream Parameters</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_start_encode">Start Encode</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_bsb">Query Bitstream Data</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_stop_encode">Stop Encode</a> </li>
</ol>
<p >Some other features examples are listed below: </p><ul>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_sysfs">Sysfs Usage</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_poll_interface_drv">Poll Interface</a> </li>
<li>
<a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_return_value">IOCTL Return Values</a> </li>
</ul>
<p >The following code fragment is an example which shows the flow of the user application.<br  />
</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_functionRef" target="_blank" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a> = open(<span class="stringliteral">&quot;/dev/iav&quot;</span>, O_RDWR, 0);  <span class="comment">// open iav device</span></div>
<div class="line">  ...</div>
<div class="line">  map_bsb();</div>
<div class="line">  <a class="code hl_functionRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a919b1d8600db83ad0b0cecba9ba694e6">init_vin</a>(fd_iav, 0);</div>
<div class="line">  <a class="code hl_functionRef" target="_blank" href="../../../video/d4/de8/vout__init_8c.html#ae6be74972aaf0d99d40cc04b3dae29c7">vout_init</a>(fd_iav);</div>
<div class="line"> </div>
<div class="line">  goto_idle();                      <span class="comment">// go to &quot;idle state&quot;, system resources are configurable only in idle state</span></div>
<div class="line"> </div>
<div class="line">  set_system_resource();            <span class="comment">// set the system resources limit</span></div>
<div class="line">  set_dptz_buffer();                <span class="comment">// configure the dptz for source buffer</span></div>
<div class="line">  set_pyramid();                    <span class="comment">// set the pyramid if needed.</span></div>
<div class="line"> </div>
<div class="line">  enable_preview();</div>
<div class="line"> </div>
<div class="line">  set_encode_format(stream_0);      <span class="comment">// set encode format of stream 0</span></div>
<div class="line">  start_encode(0x01);               <span class="comment">// start encode for stream 0</span></div>
<div class="line"> </div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">// do something for a period</span></div>
<div class="line">  ...</div>
<div class="line"> </div>
<div class="line">  stop_encode();</div>
<div class="line">  goto_idle();</div>
<div class="line">  ...</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="atest__vout__cfg_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div></div>
<div class="ttc" id="avin__init_8c_html_a5294002f7dca0cd9bcc0009a27895ef7"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a></div><div class="ttdeci">int fd_iav</div></div>
<div class="ttc" id="avin__init_8c_html_a919b1d8600db83ad0b0cecba9ba694e6"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a919b1d8600db83ad0b0cecba9ba694e6">init_vin</a></div><div class="ttdeci">int init_vin(int vsrc_id, enum amba_video_mode video_mode, int hdr_mode, u32 max_fps_hp, const char *calib_cfg)</div></div>
<div class="ttc" id="avout__init_8c_html_ae6be74972aaf0d99d40cc04b3dae29c7"><div class="ttname"><a href="../../../video/d4/de8/vout__init_8c.html#ae6be74972aaf0d99d40cc04b3dae29c7">vout_init</a></div><div class="ttdeci">int vout_init(int fd)</div></div>
</div><!-- fragment --><p >In the main function, it shows the general sequence of encoding control. For more details, please check the source code of <a class="el" href="../../dd/d1d/test_encode_8c-example.html">test_encode.c</a>.</p>
<p >The following is a detailed description of the related functions.</p>
<h2><a class="anchor" id="usage_open"></a>
11.1 Open the Device</h2>
<p >The main device node of the IAV driver is <code>/dev/iav</code>. The user program needs to call <code>open()</code> to open the device and get its file handler. Other APIs are called by <code>ioctl()</code> system calls, which need the file handler, command code, and the corresponding parameters.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> ((fd_iav = open(<span class="stringliteral">&quot;/dev/iav&quot;</span>, O_RDWR, 0)) &lt; 0) {</div>
<div class="line">    <span class="comment">//open fails</span></div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="line">close(fd_iav);</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_mem"></a>
11.2 Memory Management</h2>
<p >When the encoding is initiated, the DSP will generate a bit stream to an internal buffer, which is allocated by the driver. For any user space program to access the buffer efficiently, the buffer needs to be mapped to the user space, then the program can have the direct access to it.</p>
<p >The <b>Bit Stream Buffer (BSB)</b> information can be queried by calling the ioctl <a class="elRef" target="_blank" href="../../../library/da/d9a/group__iav-ioc-enc-use-mem.html#gaddba723007d70362b6b7e434e6345493">IAV_IOC_QUERY_MEMBLOCK</a> with the Partition ID <a class="elRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#a6e160acba2472e919b41321d8fbe72faa09de9a53727022c18429db179a1d1ead">IAV_PART_BSB</a>. The BSB physical address and length are returned in the information data structure.</p>
<p >The user space program can get the virtual address via mmap system call. Since BSB is a ring buffer, when the frame's start address plus frame size exceed the BSB length, DSP will wrap around the data and write from the beginning of BSB again. So, usually <b>double mmap (double the BSB buffer size)</b> will be used to avoid special handling for the warp around issue.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/de/dc3/structiav__querymem.html">iav_querymem</a> query_mem;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html">iav_mem_part_info</a> *part_info;</div>
<div class="line"> </div>
<div class="line">memset(&amp;query_mem, 0, <span class="keyword">sizeof</span>(query_mem));</div>
<div class="line">query_mem.mid = <a class="code hl_variableRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#aa4ef4a9add627e30f58595a1e8a78225ad6cd45b3e12fec076b535370ba973524">IAV_MEM_PARTITION</a>;</div>
<div class="line">part_info = &amp;query_mem.arg.partition;</div>
<div class="line">part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a189394c6bbc0d36422df8c5bc2ee1962">pid</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#a6e160acba2472e919b41321d8fbe72faa09de9a53727022c18429db179a1d1ead">IAV_PART_BSB</a>;</div>
<div class="line"><span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_QUERY_MEMBLOCK, &amp;query_mem) &lt; 0) {</div>
<div class="line">   perror(<span class="stringliteral">&quot;IAV_IOC_QUERY_MEMBLOCK&quot;</span>);</div>
<div class="line">   <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">bsb_size = part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a3bc6cd5f612ef6d8254970d363348350">mem</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/da/dae/structiav__mem__info.html#a9ee64c7b918513891b3834b93ad0e501">length</a>;</div>
<div class="line">bsb_mem = mmap(NULL, bsb_size * 2, PROT_READ, MAP_SHARED, fd_iav,</div>
<div class="line">           part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a3bc6cd5f612ef6d8254970d363348350">mem</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/da/dae/structiav__mem__info.html#afde02ab53128286716345a7e3da30a7e">addr</a>);</div>
<div class="line"><span class="keywordflow">if</span> (bsb_mem == MAP_FAILED) {</div>
<div class="line">   perror(<span class="stringliteral">&quot;mmap IAV_PART_BSB failed\n&quot;</span>);</div>
<div class="line">   <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="ttc" id="aiav__ioctl_8h_html_a6e160acba2472e919b41321d8fbe72faa09de9a53727022c18429db179a1d1ead"><div class="ttname"><a href="../../../library/de/d89/iav__ioctl_8h.html#a6e160acba2472e919b41321d8fbe72faa09de9a53727022c18429db179a1d1ead">IAV_PART_BSB</a></div><div class="ttdeci">IAV_PART_BSB</div></div>
<div class="ttc" id="aiav__ioctl_8h_html_aa4ef4a9add627e30f58595a1e8a78225ad6cd45b3e12fec076b535370ba973524"><div class="ttname"><a href="../../../library/de/d89/iav__ioctl_8h.html#aa4ef4a9add627e30f58595a1e8a78225ad6cd45b3e12fec076b535370ba973524">IAV_MEM_PARTITION</a></div><div class="ttdeci">IAV_MEM_PARTITION</div></div>
<div class="ttc" id="astructiav__mem__info_html_a9ee64c7b918513891b3834b93ad0e501"><div class="ttname"><a href="../../../library/da/dae/structiav__mem__info.html#a9ee64c7b918513891b3834b93ad0e501">iav_mem_info::length</a></div><div class="ttdeci">unsigned long length</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1842</div></div>
<div class="ttc" id="astructiav__mem__info_html_afde02ab53128286716345a7e3da30a7e"><div class="ttname"><a href="../../../library/da/dae/structiav__mem__info.html#afde02ab53128286716345a7e3da30a7e">iav_mem_info::addr</a></div><div class="ttdeci">unsigned long addr</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1841</div></div>
<div class="ttc" id="astructiav__mem__part__info_html"><div class="ttname"><a href="../../../library/d1/d73/structiav__mem__part__info.html">iav_mem_part_info</a></div></div>
<div class="ttc" id="astructiav__mem__part__info_html_a189394c6bbc0d36422df8c5bc2ee1962"><div class="ttname"><a href="../../../library/d1/d73/structiav__mem__part__info.html#a189394c6bbc0d36422df8c5bc2ee1962">iav_mem_part_info::pid</a></div><div class="ttdeci">u32 pid</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1847</div></div>
<div class="ttc" id="astructiav__mem__part__info_html_a3bc6cd5f612ef6d8254970d363348350"><div class="ttname"><a href="../../../library/d1/d73/structiav__mem__part__info.html#a3bc6cd5f612ef6d8254970d363348350">iav_mem_part_info::mem</a></div><div class="ttdeci">struct iav_mem_info mem</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1848</div></div>
<div class="ttc" id="astructiav__querymem_html"><div class="ttname"><a href="../../../library/de/dc3/structiav__querymem.html">iav_querymem</a></div></div>
</div><!-- fragment --><p >When encoding is started, the user space program can call another ioctl command <a class="elRef" target="_blank" href="../../../library/da/d9a/group__iav-ioc-enc-use-mem.html#ga9087cb6f84796c640fcf100cea43be09">IAV_IOC_QUERY_DESC</a> with the ID <a class="el" href="../../d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a05a4e65f2c13698887b00b1c3ecc78f9">IAV_DESC_FRAME</a>, to fetch the encoded frames from the bit stream buffer.</p>
<h2><a class="anchor" id="usage_vin"></a>
11.3 Configure VIN</h2>
<p >The following code checks the total VIN source and sets the specified VIN as the active source.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_functionRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a919b1d8600db83ad0b0cecba9ba694e6">init_vin</a>(<span class="keywordtype">int</span> vsrc_id, <span class="keywordtype">int</span> hdr_mode)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/da/d3f/structvindev__mode.html">vindev_mode</a> src_mode = {0};</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d8/d5f/structvindev__fps.html">vindev_fps</a> vsrc_fps = {0};</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d6/dfd/structvindev__video__info.html">vindev_video_info</a> video_info;</div>
<div class="line"> </div>
<div class="line">  vsrc_mode.<a class="code hl_variableRef" target="_blank" href="../../../library/d6/dfd/structvindev__video__info.html#aa1ecb62f419c3b454f5a2d4fd18d4818">vsrc_id</a> = 0;                            <span class="comment">// choose vsrc 0</span></div>
<div class="line">  vsrc_mode.video_mode = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82caf3de158a9ba2d0c6b7512a47aa8d2179">AMBA_VIDEO_MODE_1920_1080</a>; <span class="comment">// sensor resolution: 1920x1080</span></div>
<div class="line">  vsrc_mode.hdr_mode = 0;                           <span class="comment">// liner input mode</span></div>
<div class="line">  vsrc_mode.bits = 12;                              <span class="comment">// set the pixel depth to 12</span></div>
<div class="line">  ...</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_VIN_SET_MODE, &amp;vsrc_mode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set sensor input frame rate to 30</span></div>
<div class="line">  vsrc_fps.<a class="code hl_variableRef" target="_blank" href="../../../library/d8/d5f/structvindev__fps.html#aa1ecb62f419c3b454f5a2d4fd18d4818">vsrc_id</a> = 0;</div>
<div class="line">  vsrc_fps.<a class="code hl_variableRef" target="_blank" href="../../../library/d8/d5f/structvindev__fps.html#a0256d25b86a9f6d108e63e630fd20cf2">fps</a> = 30;</div>
<div class="line">  ...</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_VIN_SET_FPS, &amp;vsrc_fps);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// do something, such as set the aaa parameters for rgb sensor</span></div>
<div class="line">  ...</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// also, user can get current video info by ioc</span></div>
<div class="line">  memset(&amp;video_info, 0, sizoef(<span class="keyword">struct</span> <a class="code hl_structRef" target="_blank" href="../../../library/d6/dfd/structvindev__video__info.html">vindev_video_info</a>));</div>
<div class="line">  video_info.vsrc_id = 0;</div>
<div class="line">  video_info.info.mode = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82caa98875c6cdf536325911de20a4307343">AMBA_VIDEO_MODE_CURRENT</a>;</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_VIN_GET_VIDEOINFO, &amp;video_info);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-common-helper_html_ggae1713c20e46dd967b9d34e7f8343f82caa98875c6cdf536325911de20a4307343"><div class="ttname"><a href="../../../library/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82caa98875c6cdf536325911de20a4307343">AMBA_VIDEO_MODE_CURRENT</a></div><div class="ttdeci">AMBA_VIDEO_MODE_CURRENT</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggae1713c20e46dd967b9d34e7f8343f82caf3de158a9ba2d0c6b7512a47aa8d2179"><div class="ttname"><a href="../../../library/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82caf3de158a9ba2d0c6b7512a47aa8d2179">AMBA_VIDEO_MODE_1920_1080</a></div><div class="ttdeci">AMBA_VIDEO_MODE_1920_1080</div></div>
<div class="ttc" id="astructvindev__fps_html"><div class="ttname"><a href="../../../library/d8/d5f/structvindev__fps.html">vindev_fps</a></div></div>
<div class="ttc" id="astructvindev__fps_html_a0256d25b86a9f6d108e63e630fd20cf2"><div class="ttname"><a href="../../../library/d8/d5f/structvindev__fps.html#a0256d25b86a9f6d108e63e630fd20cf2">vindev_fps::fps</a></div><div class="ttdeci">unsigned int fps</div><div class="ttdef"><b>Definition:</b> iav_vin_common.h:525</div></div>
<div class="ttc" id="astructvindev__fps_html_aa1ecb62f419c3b454f5a2d4fd18d4818"><div class="ttname"><a href="../../../library/d8/d5f/structvindev__fps.html#aa1ecb62f419c3b454f5a2d4fd18d4818">vindev_fps::vsrc_id</a></div><div class="ttdeci">unsigned int vsrc_id</div><div class="ttdef"><b>Definition:</b> iav_vin_common.h:524</div></div>
<div class="ttc" id="astructvindev__mode_html"><div class="ttname"><a href="../../../library/da/d3f/structvindev__mode.html">vindev_mode</a></div></div>
<div class="ttc" id="astructvindev__video__info_html"><div class="ttname"><a href="../../../library/d6/dfd/structvindev__video__info.html">vindev_video_info</a></div></div>
<div class="ttc" id="astructvindev__video__info_html_aa1ecb62f419c3b454f5a2d4fd18d4818"><div class="ttname"><a href="../../../library/d6/dfd/structvindev__video__info.html#aa1ecb62f419c3b454f5a2d4fd18d4818">vindev_video_info::vsrc_id</a></div><div class="ttdeci">unsigned int vsrc_id</div><div class="ttdef"><b>Definition:</b> iav_vin_common.h:531</div></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_vout_config"></a>
11.4 Configure VOUT</h2>
<p >CV5x / CV7x supports HDMI (digital) VOUT, the composite (analog) VOUT, and MIPI DSI / CSI VOUT.</p>
<p >HDMI VOUT can support up to 8K resolution. More details can be found in the unit test sample codes.</p>
<p >The following is an example on how to use ioctl <a class="elRef" target="_blank" href="../../../library/d1/d1a/group__iav-ioctl-vout-api.html#ga150e8cba071a97539c79ba0b99151b2d">IAV_IOC_VOUT_SET_MODE</a> to configure the VOUT parameters.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_functionRef" target="_blank" href="../../../video/d4/de8/vout__init_8c.html#ae6be74972aaf0d99d40cc04b3dae29c7">vout_init</a>(<span class="keywordtype">int</span> fd)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d6/d82/structvoutdev__format.html">voutdev_format</a> <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>.id = 2;                             <span class="comment">// use vout2 controller</span></div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>.type = <a class="code hl_variableRef" target="_blank" href="../../../library/d6/da8/group__iav-ioctl-vout-helper.html#gga0944a4353780132eeab7b06e3e42291da74f14a6c19eea3428c6c795ff22875bf">VOUT_TYPE_HDMI</a>;              <span class="comment">// use HDMI output</span></div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>.mode = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82caf3de158a9ba2d0c6b7512a47aa8d2179">AMBA_VIDEO_MODE_1920_1080</a>;   <span class="comment">// resolution 1920x1080</span></div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>.fps = 60 * 1000;                    <span class="comment">// fps is 60</span></div>
<div class="line">  ...</div>
<div class="line"> </div>
<div class="line">  ioctl(fd, IAV_IOC_VOUT_SET_MODE, &amp;format);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="acJSON_8h_html_adb411a44855a4c49231d72a0fc9a3b3b"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a></div><div class="ttdeci">char const int const cJSON_bool format</div></div>
<div class="ttc" id="agroup__iav-ioctl-vout-helper_html_gga0944a4353780132eeab7b06e3e42291da74f14a6c19eea3428c6c795ff22875bf"><div class="ttname"><a href="../../../library/d6/da8/group__iav-ioctl-vout-helper.html#gga0944a4353780132eeab7b06e3e42291da74f14a6c19eea3428c6c795ff22875bf">VOUT_TYPE_HDMI</a></div><div class="ttdeci">VOUT_TYPE_HDMI</div></div>
<div class="ttc" id="astructvoutdev__format_html"><div class="ttname"><a href="../../../library/d6/d82/structvoutdev__format.html">voutdev_format</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_go_to_idle"></a>
11.5 Go To Idle State</h2>
<p >Set the IAV to <a class="el" href="../../df/d3f/page_drv_iav_doc.html#anchor_state_idle">Idle State</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> goto_idle(<span class="keywordtype">int</span> vin_off)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d7/d46/structiav__idle__params.html">iav_idle_params</a> idle_params = {0};</div>
<div class="line">  <a class="code hl_typedefRef" target="_blank" href="../../../library/d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> state;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// set the vout profile</span></div>
<div class="line">     <a class="code hl_defineRef" target="_blank" href="../../../video/de/ddf/vout__init__cfg_8c.html#a88a5b93883c34229851d6a7a93254850">AM_IOCTL</a>(fd_iav, IAV_IOC_GET_IAV_STATE, &amp;state);</div>
<div class="line">     <span class="keywordflow">if</span> (dsp_boot_param.vout_profile_flag &amp;&amp; state != <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggafc7fb94a411b7cedcb91492097fdb928af8ceed871027b348c6161c40ce6f5b10">IAV_STATE_INIT</a>) {</div>
<div class="line">             printf(<span class="stringliteral">&quot;Error! vout profile should be set when first entering preview.\n&quot;</span>);</div>
<div class="line">             <span class="keywordflow">return</span> -1;</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// maybe power off the vin controller is needed</span></div>
<div class="line">  idle_params.<a class="code hl_variableRef" target="_blank" href="../../../library/d7/d46/structiav__idle__params.html#a7966f805ac53ccbe241ec65f1c7db303">poweroff_vin</a> = vin_off;</div>
<div class="line">  <span class="comment">// call ioctl to enter preview</span></div>
<div class="line">  ioctl(fd_iav, IAV_IOC_ENTER_IDLE, &amp;idle_params);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aasf__structure_8h_html_afaa62991928fb9fb18ff0db62a040aba"><div class="ttname"><a href="../../../library/d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a></div><div class="ttdeci">uint32_t u32</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggafc7fb94a411b7cedcb91492097fdb928af8ceed871027b348c6161c40ce6f5b10"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggafc7fb94a411b7cedcb91492097fdb928af8ceed871027b348c6161c40ce6f5b10">IAV_STATE_INIT</a></div><div class="ttdeci">IAV_STATE_INIT</div></div>
<div class="ttc" id="astructiav__idle__params_html"><div class="ttname"><a href="../../../library/d7/d46/structiav__idle__params.html">iav_idle_params</a></div></div>
<div class="ttc" id="astructiav__idle__params_html_a7966f805ac53ccbe241ec65f1c7db303"><div class="ttname"><a href="../../../library/d7/d46/structiav__idle__params.html#a7966f805ac53ccbe241ec65f1c7db303">iav_idle_params::poweroff_vin</a></div><div class="ttdeci">u8 poweroff_vin</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:596</div></div>
<div class="ttc" id="avout__init__cfg_8c_html_a88a5b93883c34229851d6a7a93254850"><div class="ttname"><a href="../../../video/de/ddf/vout__init__cfg_8c.html#a88a5b93883c34229851d6a7a93254850">AM_IOCTL</a></div><div class="ttdeci">#define AM_IOCTL(_filp, _cmd, _arg)</div></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_dsp_configuration"></a>
11.6 Configure DSP Resources</h2>
<p >Users can set the parameters of multi-channel configuration during <a class="el" href="../../df/d3f/page_drv_iav_doc.html#anchor_state_idle">Idle State</a>. Include <b>System Resources</b>, ut_source_buffer and ut_pryamid ...</p>
<h3><a class="anchor" id="ioc_configure_resource"></a>
11.6.1 Set System Resources Limitations</h3>
<p >The system resources contain the following aspects: </p><ul>
<li>
Global Parameters </li>
<li>
Channel Configuration </li>
<li>
Canvas Configuration </li>
<li>
Stream Configuration </li>
</ul>
<p>Following is an example about how to configure DSP system resources. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> set_system_resource(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/df/d3a/structiav__system__resource.html">iav_system_resource</a> resource;          <span class="comment">// for system resource ioc</span></div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d9/db4/structiav__chan__cfg.html">iav_chan_cfg</a> chan_cfgs[<a class="code hl_define" href="../../dummy.html">IAV_MAX_CHANNEL_NUM</a>];</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/dd/d01/structiav__canvas__cfg.html">iav_canvas_cfg</a> canvas_cfgs[<a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaf767d9abd72a417ac6b271d3e7f1943ca6c9c87fa59e4fcc0aa3204f61fddef26">IAV_MAX_CANVAS_BUF_NUM</a>];</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d0/d9e/structiav__stream__resource.html">iav_stream_resource</a> stream_resources[<a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaf767d9abd72a417ac6b271d3e7f1943ca0f0009ba1f12a42842067ca8676e201e">IAV_STREAM_MAX_NUM_ALL</a>];</div>
<div class="line">  <span class="keyword">struct </span>mcl_multi_chan_cfg resource_cfg;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Here you can get your buffer configuration from a Lua file, or directly hard code in</span></div>
<div class="line">  <span class="comment">// a C resource file. For example, here we get configuration from Lua script.</span></div>
<div class="line">  get_multi_chan_cfg(<span class="stringliteral">&quot;example.lua&quot;</span>, &amp;resource_cfg);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set up some global parameters</span></div>
<div class="line">  resource.encode_mode = 5;                     <span class="comment">// use enc-mode 5</span></div>
<div class="line">  resource.raw_capture_enable = 0;              <span class="comment">// enable capture date from sensor</span></div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">// rise a ioc to set up system resource</span></div>
<div class="line">  ioctl(fd_iav, IAV_IOC_SET_SYSTEM_RESOURCE, &amp;resource);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set up channel resource</span></div>
<div class="line">  resource-&gt;chan_num = resource_cfg.chan_num;</div>
<div class="line">  resource-&gt;chan_map = (1 &lt;&lt; resource_cfg.chan_num) - 1;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; resource-&gt;chan_num; i++) {</div>
<div class="line">     <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = chan_cfgs[i];</div>
<div class="line">     <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>-&gt;vsrc_id = resource_cfg.channels[i].vsrc.vsrc_id;</div>
<div class="line">     <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>-&gt;pass_num = resource_cfg.channels[i].scale_pass_num;</div>
<div class="line">     chan_cfg-&gt;raw_capture = resource_cfg.channels[i].raw_capture;</div>
<div class="line">     ...</div>
<div class="line">     <span class="keywordflow">for</span> (j = 0; j &lt; resource_cfg.channels[i].pass_num; j++) {</div>
<div class="line">        <span class="comment">//set up the pass resource</span></div>
<div class="line">        ...</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">// rise a ioc to set up channel resource</span></div>
<div class="line">     ioctl(fd_iav, IAV_IOC_SET_CHAN_CONFIG, &amp;chan_cfgs[i]);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set up canvas resource</span></div>
<div class="line">  resource-&gt;canvas_num = resource_cfg.canvas_num;</div>
<div class="line">  resource-&gt;canvas_map = (1 &lt;&lt; resource_cfg.canvas_map) - 1;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; resource_cfg.canvas_num; i++) {</div>
<div class="line">        canvas = &amp;canvas_cfgs[i];</div>
<div class="line">        canvas-&gt;max.width = resource_cfg.canvas[i].width;</div>
<div class="line">        canvas-&gt;max.height = resource_cfg.canvas[i].height;</div>
<div class="line">        canvas-&gt;type = resource_cfg.canvas[i].type;</div>
<div class="line">        ...</div>
<div class="line">      <span class="comment">// rise a ioc to set up canvas resource</span></div>
<div class="line">      ioctl(fd_iav, IAV_IOC_SET_CANVAS_CONFIG, &amp;canvas_cfgs[i]);</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set up stream resource</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; resource_cfg.stream_num; ++i) {</div>
<div class="line">        stream = &amp;stream_resources[i];</div>
<div class="line">        stream-&gt;max_size.width = resource_cfg.streams[i].max_size.width;</div>
<div class="line">        stream-&gt;max_size.height = resource_cfg.streams[i].max_size.height;</div>
<div class="line">        stream-&gt;max_M = resource_cfg.streams[i].max_M;</div>
<div class="line">      ...</div>
<div class="line">      <span class="comment">// rise a ioc to set up stream resource</span></div>
<div class="line">      ioctl(fd_iav, IAV_IOC_SET_STREAM_RESOURCE, &amp;stream_resources[i]);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggaf767d9abd72a417ac6b271d3e7f1943ca0f0009ba1f12a42842067ca8676e201e"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaf767d9abd72a417ac6b271d3e7f1943ca0f0009ba1f12a42842067ca8676e201e">IAV_STREAM_MAX_NUM_ALL</a></div><div class="ttdeci">IAV_STREAM_MAX_NUM_ALL</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggaf767d9abd72a417ac6b271d3e7f1943ca6c9c87fa59e4fcc0aa3204f61fddef26"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaf767d9abd72a417ac6b271d3e7f1943ca6c9c87fa59e4fcc0aa3204f61fddef26">IAV_MAX_CANVAS_BUF_NUM</a></div><div class="ttdeci">IAV_MAX_CANVAS_BUF_NUM</div></div>
<div class="ttc" id="astructiav__canvas__cfg_html"><div class="ttname"><a href="../../../library/dd/d01/structiav__canvas__cfg.html">iav_canvas_cfg</a></div></div>
<div class="ttc" id="astructiav__chan__cfg_html"><div class="ttname"><a href="../../../library/d9/db4/structiav__chan__cfg.html">iav_chan_cfg</a></div></div>
<div class="ttc" id="astructiav__stream__resource_html"><div class="ttname"><a href="../../../library/d0/d9e/structiav__stream__resource.html">iav_stream_resource</a></div></div>
<div class="ttc" id="astructiav__system__resource_html"><div class="ttname"><a href="../../../library/df/d3a/structiav__system__resource.html">iav_system_resource</a></div></div>
<div class="ttc" id="avin__init_8c_html_adf7dff2c57c0da9a4a2b70e3e815be31"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a></div><div class="ttdeci">int channel</div></div>
</div><!-- fragment --><h3><a class="anchor" id="ioc_configure_dptz"></a>
11.6.2 Configure DPTZ for Source Buffer</h3>
<p >Digital Pan/Tilt/Zoom for <a class="elRef" target="_blank" href="../../../video/d0/ded/fs_basic_source_buffer.html#main_buffer_dptz">Main Buffer</a> and <a class="elRef" target="_blank" href="../../../video/d0/ded/fs_basic_source_buffer.html#sub_buffer_dptz">Sub-Buffer</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> set_dptz_buffer()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d2/d92/structiav__video__proc.html">iav_video_proc</a> vproc;                             <span class="comment">// for source buffer ioc</span></div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/dd/d0b/structiav__dptz.html">iav_dptz</a> *dptz = &amp;vproc.arg.dptz;</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d6/da9/structiav__buf__cfg.html">iav_buf_cfg</a> *buf_cfg = &amp;vproc.arg.dptz.buf_cfg;</div>
<div class="line">  <span class="keyword">struct </span>mcl_multi_chan_cfg resource_cfg;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// set up source buffer each channel</span></div>
<div class="line">  vproc.cid = <a class="code hl_variableRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#a1d909756ef49647a3774e92f15bb700ba88a06432843f05f62e45051f847363c3">IAV_VIDEO_PROC_DPTZ</a>;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; resource_cfg.chan_num; i++) {</div>
<div class="line">     <span class="comment">//configure buffer for each pass</span></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; resource_cfg.channels[i].scale_pass_num; j++) {</div>
<div class="line">           <span class="keywordflow">for</span> (k = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaa1e977b4c4203d0b91b2d3533275e193afca3200d598aaa4faa22157c8b079ddb">IAV_SRCBUF_FIRST</a>; k &lt; <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaa1e977b4c4203d0b91b2d3533275e193afaea8ddd4412a5ae2b4b0296fc02182b">IAV_SRCBUF_LAST</a>; k++) {</div>
<div class="line">            <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a> = &amp;resource_cfg.channels[i].source_buffer[j][k];</div>
<div class="line">            dptz-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/dd/d0b/structiav__dptz.html#a7f0c82e1f055e95da8a702634c3e56b0">channel_id</a> = i;</div>
<div class="line">            dptz-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/dd/d0b/structiav__dptz.html#a4eb5390353fb0508442db61e89ed786b">pass_id</a> = j;</div>
<div class="line">            dptz-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/dd/d0b/structiav__dptz.html#a2830ebfe6ef0797f46e9fcc1945f4c01">buf_id</a> = k;</div>
<div class="line">            buf_cfg-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d6/da9/structiav__buf__cfg.html#ac2eab39ce1829256fbb1f813d5048b11">input</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>-&gt;input;</div>
<div class="line">            buf_cfg-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d6/da9/structiav__buf__cfg.html#a96d70b1736d2a18327af31d6b00c958b">output</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>-&gt;output;</div>
<div class="line">            buf_cfg-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d6/da9/structiav__buf__cfg.html#a2f1e22f38f7be358c963bc2a979fbf4d">canvas_id</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>-&gt;canvas_id;</div>
<div class="line">            ioctl(fd_iav, IAV_IOC_CFG_VIDEO_PROC, &amp;vproc);</div>
<div class="line">        }</div>
<div class="line">     }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="acJSON_8h_html_aff2566f4c366b48d73479bef43ee4d2e"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a></div><div class="ttdeci">char * buffer</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggaa1e977b4c4203d0b91b2d3533275e193afaea8ddd4412a5ae2b4b0296fc02182b"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaa1e977b4c4203d0b91b2d3533275e193afaea8ddd4412a5ae2b4b0296fc02182b">IAV_SRCBUF_LAST</a></div><div class="ttdeci">IAV_SRCBUF_LAST</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggaa1e977b4c4203d0b91b2d3533275e193afca3200d598aaa4faa22157c8b079ddb"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaa1e977b4c4203d0b91b2d3533275e193afca3200d598aaa4faa22157c8b079ddb">IAV_SRCBUF_FIRST</a></div><div class="ttdeci">IAV_SRCBUF_FIRST</div></div>
<div class="ttc" id="aiav__ioctl_8h_html_a1d909756ef49647a3774e92f15bb700ba88a06432843f05f62e45051f847363c3"><div class="ttname"><a href="../../../library/de/d89/iav__ioctl_8h.html#a1d909756ef49647a3774e92f15bb700ba88a06432843f05f62e45051f847363c3">IAV_VIDEO_PROC_DPTZ</a></div><div class="ttdeci">IAV_VIDEO_PROC_DPTZ</div></div>
<div class="ttc" id="astructiav__buf__cfg_html"><div class="ttname"><a href="../../../library/d6/da9/structiav__buf__cfg.html">iav_buf_cfg</a></div></div>
<div class="ttc" id="astructiav__buf__cfg_html_a2f1e22f38f7be358c963bc2a979fbf4d"><div class="ttname"><a href="../../../library/d6/da9/structiav__buf__cfg.html#a2f1e22f38f7be358c963bc2a979fbf4d">iav_buf_cfg::canvas_id</a></div><div class="ttdeci">u32 canvas_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1611</div></div>
<div class="ttc" id="astructiav__buf__cfg_html_a96d70b1736d2a18327af31d6b00c958b"><div class="ttname"><a href="../../../library/d6/da9/structiav__buf__cfg.html#a96d70b1736d2a18327af31d6b00c958b">iav_buf_cfg::output</a></div><div class="ttdeci">struct iav_rect output</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1610</div></div>
<div class="ttc" id="astructiav__buf__cfg_html_ac2eab39ce1829256fbb1f813d5048b11"><div class="ttname"><a href="../../../library/d6/da9/structiav__buf__cfg.html#ac2eab39ce1829256fbb1f813d5048b11">iav_buf_cfg::input</a></div><div class="ttdeci">struct iav_rect input</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1609</div></div>
<div class="ttc" id="astructiav__dptz_html"><div class="ttname"><a href="../../../library/dd/d0b/structiav__dptz.html">iav_dptz</a></div></div>
<div class="ttc" id="astructiav__dptz_html_a2830ebfe6ef0797f46e9fcc1945f4c01"><div class="ttname"><a href="../../../library/dd/d0b/structiav__dptz.html#a2830ebfe6ef0797f46e9fcc1945f4c01">iav_dptz::buf_id</a></div><div class="ttdeci">u8 buf_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1618</div></div>
<div class="ttc" id="astructiav__dptz_html_a4eb5390353fb0508442db61e89ed786b"><div class="ttname"><a href="../../../library/dd/d0b/structiav__dptz.html#a4eb5390353fb0508442db61e89ed786b">iav_dptz::pass_id</a></div><div class="ttdeci">u8 pass_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1617</div></div>
<div class="ttc" id="astructiav__dptz_html_a7f0c82e1f055e95da8a702634c3e56b0"><div class="ttname"><a href="../../../library/dd/d0b/structiav__dptz.html#a7f0c82e1f055e95da8a702634c3e56b0">iav_dptz::channel_id</a></div><div class="ttdeci">u8 channel_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1616</div></div>
<div class="ttc" id="astructiav__video__proc_html"><div class="ttname"><a href="../../../library/d2/d92/structiav__video__proc.html">iav_video_proc</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="ioc_configure_pyramid"></a>
11.6.3 Configure Pyramid</h3>
<p >Pyramid is available on Amba CV family chips. The pyramid can be configured if it is needed in application. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> set_pyramid()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html">iav_pyramid_cfg</a> pyramid_cfg;                     <span class="comment">// for pyramid ioc</span></div>
<div class="line">  <span class="keyword">struct </span>mcl_multi_chan_cfg resource_cfg;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; resource_cfg.chan_num; i++) {</div>
<div class="line">     <span class="comment">// configure pyramid for each channel</span></div>
<div class="line">     pyramid = &amp;resource_cfg.channels[i].pyramid;</div>
<div class="line">     pyramid_cfg.<a class="code hl_variableRef" target="_blank" href="../../../library/dc/d8b/structiav__pyramid__cfg.html#ab4b3cc0eb8d6dbd703f05e219194af8e">enable</a> = (pyramid-&gt;layers_map != 0);     <span class="comment">// enable pyramid</span></div>
<div class="line">     pyramid_cfg.input_buf_id = pyramid-&gt;input_buf_id;    <span class="comment">// set the input buffer</span></div>
<div class="line">     pyramid_cfg.layers_map = pyramid-&gt;layers_map;        <span class="comment">// set the layers_map mask</span></div>
<div class="line">     pyramid_cfg.scale_type = pyramid-&gt;scale_type;        <span class="comment">// set dawn-sample rate</span></div>
<div class="line">     pyramid_cfg.manual_feed = pyramid-&gt;manual_feed;      <span class="comment">// if enable manual feed</span></div>
<div class="line">     ...</div>
<div class="line"> </div>
<div class="line">     ioctl(fd_iav, IAV_IOC_SET_PYRAMID_CFG, &amp;pyramid_cfg);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_enter_preview"></a>
11.7 Enter Preview State</h2>
<p >The following is a sample code fragment to put the IAV to <a class="el" href="../../df/d3f/page_drv_iav_doc.html#anchor_state_preview">Preview State</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> enable_preview(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_ENABLE_PREVIEW, 0);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_stream_configuration"></a>
11.8 Configure Stream</h2>
<p >The following is a sample code fragment to set the stream parameters, such as encoding format, resolution, source canvas... </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> set_encode_format(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d1/df3/structiav__stream__cfg.html">iav_stream_cfg</a> stream_cfg;</div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/dd/d8d/structiav__stream__format.html">iav_stream_format</a> *<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a> = &amp;stream_cfg.arg.format;</div>
<div class="line"> </div>
<div class="line">  stream_cfg.id = id;</div>
<div class="line">  stream_cfg.cid = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga428a08cf3c46e0bd3847533c8a58e108a91dc482c7b74b55bd2448e7a6c191e48">IAV_STMCFG_FORMAT</a>;</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_GET_STREAM_CONFIG, &amp;stream_cfg);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>-&gt;type = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaedee632d62ec29c16717d808e9bd406ea7e4ce314afad3eff36d815c5a95df277">IAV_STREAM_TYPE_H264</a>;   <span class="comment">// encode as h264 format</span></div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>-&gt;enc_win.width = 1920;          <span class="comment">// set resolution as 1920x1080</span></div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>-&gt;enc_win.height = 1080;</div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a>-&gt;enc_src_id = 0;                <span class="comment">// set the source canvas</span></div>
<div class="line">  ...</div>
<div class="line"> </div>
<div class="line">  ioctl(fd_iav, IAV_IOC_SET_STREAM_CONFIG, &amp;stream_cfg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga428a08cf3c46e0bd3847533c8a58e108a91dc482c7b74b55bd2448e7a6c191e48"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga428a08cf3c46e0bd3847533c8a58e108a91dc482c7b74b55bd2448e7a6c191e48">IAV_STMCFG_FORMAT</a></div><div class="ttdeci">IAV_STMCFG_FORMAT</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_ggaedee632d62ec29c16717d808e9bd406ea7e4ce314afad3eff36d815c5a95df277"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#ggaedee632d62ec29c16717d808e9bd406ea7e4ce314afad3eff36d815c5a95df277">IAV_STREAM_TYPE_H264</a></div><div class="ttdeci">IAV_STREAM_TYPE_H264</div></div>
<div class="ttc" id="astructiav__stream__cfg_html"><div class="ttname"><a href="../../../library/d1/df3/structiav__stream__cfg.html">iav_stream_cfg</a></div></div>
<div class="ttc" id="astructiav__stream__format_html"><div class="ttname"><a href="../../../library/dd/d8d/structiav__stream__format.html">iav_stream_format</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_start_encode"></a>
11.9 Start Encoding</h2>
<p >Once the stream has been configured properly, users should call ioctl <a class="elRef" target="_blank" href="../../../library/d8/dc4/group__iav-ioc-enc-use-sys.html#gaaafff500b08109dcdf637605c0e83c09">IAV_IOC_START_ENCODE</a> to start encoding the specified stream. The parameters is a bitmap for the specified stream(s). </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> start_encode(<a class="code hl_typedefRef" target="_blank" href="../../../library/d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> stream_mask)</div>
<div class="line">{</div>
<div class="line">  ioctl(fd_iav, IAV_IOC_START_ENCODE, stream_mask);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_stop_encode"></a>
11.10 Stop Encoding</h2>
<p >Also, users can stop the streams as needed. The mask bit of specified stream can be cleared, and issued through ioctl <a class="elRef" target="_blank" href="../../../library/d8/dc4/group__iav-ioc-enc-use-sys.html#gac06d8af78a1831faeff9c8c8deb861fc">IAV_IOC_STOP_ENCODE</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> stop_encode(<a class="code hl_typedefRef" target="_blank" href="../../../library/d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> stream_mask)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// stop the encoding stream</span></div>
<div class="line">  ioctl(fd_iav, IAV_IOC_STOP_ENCODE, stream_mask);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_bsb"></a>
11.11 Query Bit Stream Information</h2>
<p >The following code fragment shows the minimal steps required to query encoded bit stream information.</p>
<ol type="1">
<li>The system needs to be in the encoding state, that is to say at least one stream is encoding with the specified stream type (H.264 / H.265 / MJPEG).</li>
<li>As described in <a class="el" href="../../df/d3f/page_drv_iav_doc.html#usage_mem">11.2 Memory Management</a>, the BSB buffer should be <b>double mapped</b> for the application to read out the bit stream information.</li>
<li><a class="elRef" target="_blank" href="../../../library/da/d9a/group__iav-ioc-enc-use-mem.html#ga9087cb6f84796c640fcf100cea43be09">IAV_IOC_QUERY_DESC</a> starts to read out the bit stream information.</li>
</ol>
<p >For more details, please check the source code of "test_stream.c".</p>
<div class="fragment"><div class="line"><a class="code hl_typedefRef" target="_blank" href="../../../library/d2/d47/asf__structure_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> bsb_size = 0;</div>
<div class="line"><a class="code hl_typedefRef" target="_blank" href="../../../library/d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> *bsb_mem = NULL;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/de/dc3/structiav__querymem.html">iav_querymem</a> query_mem;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html">iav_mem_part_info</a> *part_info;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a> query_desc;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a> *frame_desc = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Map BSB buffer for querying bit stream descriptor</span></div>
<div class="line">memset(&amp;query_mem, 0, <span class="keyword">sizeof</span>(query_mem));</div>
<div class="line">query_mem.mid = <a class="code hl_variableRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#aa4ef4a9add627e30f58595a1e8a78225ad6cd45b3e12fec076b535370ba973524">IAV_MEM_PARTITION</a>;</div>
<div class="line">part_info = &amp;query_mem.arg.partition;</div>
<div class="line">part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a189394c6bbc0d36422df8c5bc2ee1962">pid</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/de/d89/iav__ioctl_8h.html#a6e160acba2472e919b41321d8fbe72faa09de9a53727022c18429db179a1d1ead">IAV_PART_BSB</a>;</div>
<div class="line"><span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_QUERY_MEMBLOCK, &amp;query_mem) &lt; 0) {</div>
<div class="line">   perror(<span class="stringliteral">&quot;IAV_IOC_QUERY_MEMBLOCK&quot;</span>);</div>
<div class="line">   <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">bsb_size = part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a3bc6cd5f612ef6d8254970d363348350">mem</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/da/dae/structiav__mem__info.html#a9ee64c7b918513891b3834b93ad0e501">length</a>;</div>
<div class="line">bsb_mem = mmap(NULL, bsb_size * 2, PROT_READ, MAP_SHARED, fd_iav,</div>
<div class="line">       part_info-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d73/structiav__mem__part__info.html#a3bc6cd5f612ef6d8254970d363348350">mem</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/da/dae/structiav__mem__info.html#afde02ab53128286716345a7e3da30a7e">addr</a>);</div>
<div class="line"><span class="keywordflow">if</span> (bsb_mem == MAP_FAILED) {</div>
<div class="line">   perror(<span class="stringliteral">&quot;mmap IAV_PART_BSB failed\n&quot;</span>);</div>
<div class="line">   <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Query frame descriptor from IAV</span></div>
<div class="line">memset(&amp;query_desc, 0, <span class="keyword">sizeof</span>(query_desc));</div>
<div class="line">frame_desc = &amp;query_desc.arg.frame;</div>
<div class="line">query_desc.qid = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a05a4e65f2c13698887b00b1c3ecc78f9">IAV_DESC_FRAME</a>;</div>
<div class="line">frame_desc-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d9/d2b/structiav__framedesc.html#a76f8ba65ce8f902c0657233adee58698">id</a> = -1;</div>
<div class="line"><span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_QUERY_DESC, &amp;query_desc) &lt; 0) {</div>
<div class="line">   <span class="comment">// fail</span></div>
<div class="line">   <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="ttc" id="aasf__structure_8h_html_a92c50087ca0e64fa93fc59402c55f8ca"><div class="ttname"><a href="../../../library/d2/d47/asf__structure_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a></div><div class="ttdeci">uint8_t u8</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172a05a4e65f2c13698887b00b1c3ecc78f9"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a05a4e65f2c13698887b00b1c3ecc78f9">IAV_DESC_FRAME</a></div><div class="ttdeci">IAV_DESC_FRAME</div></div>
<div class="ttc" id="astructiav__framedesc_html"><div class="ttname"><a href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a></div></div>
<div class="ttc" id="astructiav__framedesc_html_a76f8ba65ce8f902c0657233adee58698"><div class="ttname"><a href="../../../library/d9/d2b/structiav__framedesc.html#a76f8ba65ce8f902c0657233adee58698">iav_framedesc::id</a></div><div class="ttdeci">u32 id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:1982</div></div>
<div class="ttc" id="astructiav__querydesc_html"><div class="ttname"><a href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_sysfs"></a>
11.12 Sysfs Usage</h2>
<p >The following code shows how to use sysfs file. </p><div class="fragment"><div class="line"><span class="preprocessor">#define SYSFS_IAV_INFO &quot;/sys/devices/platform/iav/monitor/iav_info&quot;</span></div>
<div class="line"><span class="preprocessor">#define SYSFS_IAV_STATE &quot;/sys/devices/platform/iav/monitor/iav_state&quot;</span></div>
<div class="line"><span class="preprocessor">#define SYSFS_IAV_ERROR &quot;/sys/devices/platform/iav/monitor/iav_error&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> test_sysfs()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">int</span> read_num = 0;</div>
<div class="line"> <span class="keywordtype">int</span> epoll_fd = -1;</div>
<div class="line"> <span class="keywordtype">int</span> iav_info_fd = -1;</div>
<div class="line"> <span class="keywordtype">int</span> iav_error_fd = -1;</div>
<div class="line"> <span class="keywordtype">int</span> iav_state_fd = -1;</div>
<div class="line"> <span class="keywordtype">char</span> buf[4096] = {0};</div>
<div class="line"> <span class="keyword">struct </span>iav_sysfs_info_msg *info_msg = NULL;</div>
<div class="line"> <span class="keyword">struct </span>iav_sysfs_state_msg *state_msg = NULL;</div>
<div class="line"> <span class="keyword">struct </span>amba_sysfs_error_msg *error_msg = NULL;</div>
<div class="line"> epoll_event add_event;</div>
<div class="line"> epoll_event event_list[2];</div>
<div class="line"> <span class="keywordflow">do</span> {</div>
<div class="line">   <span class="keywordflow">if</span> ((iav_info_fd = ::open(SYSFS_IAV_INFO, O_RDONLY)) &lt; 0) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;Failed to open iav_info file.&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">if</span> ((iav_state_fd = ::open(SYSFS_IAV_STATE, O_RDONLY)) &lt; 0) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;Failed to open iav_state file.&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">if</span> ((iav_error_fd = ::open(SYSFS_IAV_ERROR, O_RDONLY)) &lt; 0) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;Failed to open iav_error file.&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">if</span> (!(epoll_fd = ::epoll_create1(EPOLL_CLOEXEC))) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;Failed to create epoll!&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   <span class="comment">//Read iav info msg from iav_info file</span></div>
<div class="line">   read_num = ::read(iav_info_fd, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">   <span class="keywordflow">if</span> (read_num &gt;= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iav_sysfs_info_msg)) {</div>
<div class="line">      info_msg = (<span class="keyword">struct </span>iav_sysfs_info_msg*)buf;</div>
<div class="line">      printf(<span class="stringliteral">&quot;iav info msg pts is %llu\n&quot;</span>, info_msg-&gt;pts);</div>
<div class="line">   } <span class="keywordflow">else</span> {</div>
<div class="line">     printf(<span class="stringliteral">&quot;Read iav_info file data size error.\n&quot;</span>);</div>
<div class="line">   }</div>
<div class="line">   <span class="comment">//We need to read all the data out before using select to monitor the fd.</span></div>
<div class="line">   read_num = ::read(iav_state_fd, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">   ::lseek(iav_state_fd, 0, SEEK_SET);</div>
<div class="line">   read_num = ::read(iav_error_fd, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">   ::lseek(iav_error_fd, 0, SEEK_SET);</div>
<div class="line">   add_event.events = EPOLLPRI;<span class="comment">//Should not use EPOLLIN</span></div>
<div class="line">   add_event.data.fd = iav_state_fd;</div>
<div class="line">   <span class="keywordflow">if</span> (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, iav_state_fd, &amp;add_event) &lt; 0) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;epoll ctl error.&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   add_event.data.fd = iav_error_fd;</div>
<div class="line">   <span class="keywordflow">if</span> (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, iav_error_fd, &amp;add_event) &lt; 0) {</div>
<div class="line">     perror(<span class="stringliteral">&quot;epoll ctl error.&quot;</span>);</div>
<div class="line">     <span class="keywordflow">break</span>;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">while</span>(1) {</div>
<div class="line">      <span class="keywordtype">int</span> ready = epoll_wait(epollfd, event_list, 2, -1);</div>
<div class="line">     <span class="keywordflow">if</span> (ready &lt; 0) {</div>
<div class="line">       perror(<span class="stringliteral">&quot;epoll error&quot;</span>);</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">     }</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ready; ++ i) {</div>
<div class="line">       <span class="keywordflow">if</span> (event_list[i].events &amp; EPOLLPRI) {</div>
<div class="line">         <span class="keywordflow">if</span> (event_list[i].data.fd == iav_state_fd) {</div>
<div class="line">           printf(<span class="stringliteral">&quot;Iav state Change happened.\n&quot;</span>);</div>
<div class="line">           <span class="comment">//Read iav state msg from iav_state file</span></div>
<div class="line">           memset(buf, 0, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">           read_num = ::read(iav_state_fd, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">           ::lseek(iav_state_fd, 0, SEEK_SET);</div>
<div class="line">           <span class="keywordflow">if</span> (read_num &gt;= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iav_sysfs_state_msg)) {</div>
<div class="line">             state_msg = (<span class="keyword">struct </span>iav_sysfs_state_msg*)buf;</div>
<div class="line">             printf(<span class="stringliteral">&quot;iav state msg pts is %llu\n&quot;</span>, state_msg-&gt;pts);</div>
<div class="line">           } <span class="keywordflow">else</span> {</div>
<div class="line">             printf(<span class="stringliteral">&quot;Read iav_state file data size error.\n&quot;</span>);</div>
<div class="line">           }</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">if</span> (event_list[i].data.fd == iav_error_fd) {</div>
<div class="line">           printf(<span class="stringliteral">&quot;Iav error happened.\n&quot;</span>);</div>
<div class="line">           <span class="comment">//Read iav error msg from iav_error file</span></div>
<div class="line">           memset(buf, 0, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">           read_num = ::read(iav_error_fd, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">           ::lseek(iav_error_fd, 0, SEEK_SET);</div>
<div class="line">           <span class="keywordflow">if</span> (read_num &gt;= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> amba_sysfs_error_msg)) {</div>
<div class="line">             state_msg = (<span class="keyword">struct </span>amba_sysfs_error_msg*)buf;</div>
<div class="line">             printf(<span class="stringliteral">&quot;iav error msg pts is %llu\n&quot;</span>, state_msg-&gt;pts);</div>
<div class="line">           } <span class="keywordflow">else</span> {</div>
<div class="line">             printf(<span class="stringliteral">&quot;Read iav_error file data size error.\n&quot;</span>);</div>
<div class="line">           }</div>
<div class="line">         }</div>
<div class="line">       }</div>
<div class="line">     }</div>
<div class="line">   }</div>
<div class="line"> } <span class="keywordflow">while</span> (<span class="keyword">false</span>);</div>
<div class="line"> <span class="keywordflow">if</span> (iav_info_fd &gt;= 0) {</div>
<div class="line">   ::close(iav_info_fd);</div>
<div class="line"> }</div>
<div class="line"> <span class="keywordflow">if</span> (iav_state_fd &gt;= 0) {</div>
<div class="line">   ::close(iav_state_fd);</div>
<div class="line"> }</div>
<div class="line"> <span class="keywordflow">if</span> (iav_error_fd &gt;= 0) {</div>
<div class="line">   ::close(iav_error_fd);</div>
<div class="line"> }</div>
<div class="line"> <span class="keywordflow">if</span> (epoll_fd &gt;= 0) {</div>
<div class="line">   ::close(epoll_fd);</div>
<div class="line"> }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_poll_interface_drv"></a>
11.13 Poll Interface Usage.</h2>
<h3><a class="anchor" id="poll_iav_data_usage_drv"></a>
11.13.1 Usage of Querying IAV Data</h3>
<p >Set the events to monitor: </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d6/ddf/structiav__poll__event__config.html">iav_poll_event_config</a> poll_configs;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html">iav_querydesc_event</a> *desc_event;</div>
<div class="line"> </div>
<div class="line">desc_event = &amp;poll_configs.desc_event[0];</div>
<div class="line">desc_event-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#aa73b12ace6ac7df824707a89ac4f91ff">qid</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a94a321e201e898d629d61d2f6b625543">IAV_DESC_PYRAMID</a>;</div>
<div class="line">desc_event-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#a23c17b01e4aa1994c60d1c07375029fd">arg</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#aee4f58e874fb61fded3827dd6edf80b5">pyramid</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/de/d03/structiav__pyramiddesc__event.html#a39de1e60caa4197c587bedef84d1eee7">chan_id</a> = 0;</div>
<div class="line">desc_event = &amp;poll_configs.desc_event[1];</div>
<div class="line">desc_event-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#aa73b12ace6ac7df824707a89ac4f91ff">qid</a> = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172ad1eb61f9c66c08ad24169d01d4d0ee9e">IAV_DESC_CANVAS</a>;</div>
<div class="line">desc_event-&gt;<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#a23c17b01e4aa1994c60d1c07375029fd">arg</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/d3/d28/structiav__querydesc__event.html#a57c75efef8946cb49513ebb667a88c8b">canvas</a>.<a class="code hl_variableRef" target="_blank" href="../../../library/d1/daf/structiav__canvasdesc__event.html#ae8cabdc5c24b46705eb7ad5e0fc54660">canvas_id</a> = 0;</div>
<div class="line">poll_configs.valid_num = 2;</div>
<div class="line"><span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_SET_POLL_EVENT_CFG, &amp;poll_configs) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;IAV_IOC_SET_POLL_EVENT_CFG error\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172a94a321e201e898d629d61d2f6b625543"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a94a321e201e898d629d61d2f6b625543">IAV_DESC_PYRAMID</a></div><div class="ttdeci">IAV_DESC_PYRAMID</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172ad1eb61f9c66c08ad24169d01d4d0ee9e"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172ad1eb61f9c66c08ad24169d01d4d0ee9e">IAV_DESC_CANVAS</a></div><div class="ttdeci">IAV_DESC_CANVAS</div></div>
<div class="ttc" id="astructiav__canvasdesc__event_html_ae8cabdc5c24b46705eb7ad5e0fc54660"><div class="ttname"><a href="../../../library/d1/daf/structiav__canvasdesc__event.html#ae8cabdc5c24b46705eb7ad5e0fc54660">iav_canvasdesc_event::canvas_id</a></div><div class="ttdeci">u8 canvas_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:2374</div></div>
<div class="ttc" id="astructiav__poll__event__config_html"><div class="ttname"><a href="../../../library/d6/ddf/structiav__poll__event__config.html">iav_poll_event_config</a></div></div>
<div class="ttc" id="astructiav__pyramiddesc__event_html_a39de1e60caa4197c587bedef84d1eee7"><div class="ttname"><a href="../../../library/de/d03/structiav__pyramiddesc__event.html#a39de1e60caa4197c587bedef84d1eee7">iav_pyramiddesc_event::chan_id</a></div><div class="ttdeci">u8 chan_id</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:2384</div></div>
<div class="ttc" id="astructiav__querydesc__event_html"><div class="ttname"><a href="../../../library/d3/d28/structiav__querydesc__event.html">iav_querydesc_event</a></div></div>
<div class="ttc" id="astructiav__querydesc__event_html_a23c17b01e4aa1994c60d1c07375029fd"><div class="ttname"><a href="../../../library/d3/d28/structiav__querydesc__event.html#a23c17b01e4aa1994c60d1c07375029fd">iav_querydesc_event::arg</a></div><div class="ttdeci">union iav_querydesc_event::@70 arg</div></div>
<div class="ttc" id="astructiav__querydesc__event_html_a57c75efef8946cb49513ebb667a88c8b"><div class="ttname"><a href="../../../library/d3/d28/structiav__querydesc__event.html#a57c75efef8946cb49513ebb667a88c8b">iav_querydesc_event::canvas</a></div><div class="ttdeci">struct iav_canvasdesc_event canvas</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:2400</div></div>
<div class="ttc" id="astructiav__querydesc__event_html_aa73b12ace6ac7df824707a89ac4f91ff"><div class="ttname"><a href="../../../library/d3/d28/structiav__querydesc__event.html#aa73b12ace6ac7df824707a89ac4f91ff">iav_querydesc_event::qid</a></div><div class="ttdeci">enum iav_desc_id qid</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:2393</div></div>
<div class="ttc" id="astructiav__querydesc__event_html_aee4f58e874fb61fded3827dd6edf80b5"><div class="ttname"><a href="../../../library/d3/d28/structiav__querydesc__event.html#aee4f58e874fb61fded3827dd6edf80b5">iav_querydesc_event::pyramid</a></div><div class="ttdeci">struct iav_pyramiddesc_event pyramid</div><div class="ttdef"><b>Definition:</b> iav_ioctl.h:2401</div></div>
</div><!-- fragment --><p >Wait for the events ready and process it: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>pollfd fds;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a> query_desc;</div>
<div class="line"> </div>
<div class="line">fds.fd = <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a>;</div>
<div class="line">fds.events = POLLIN | POLLERR;</div>
<div class="line"><span class="keywordflow">if</span> (poll(&amp;fds, 1, -1) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;poll error\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> -1;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  printf(<span class="stringliteral">&quot;poll success revents=%x\n&quot;</span>, fds.revents);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">if</span> (fds.revents &amp; POLLERR) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;poll get POLLERR\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">if</span> (fds.revents &amp; POLLIN) {</div>
<div class="line">  memset(&amp;query_desc, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_structRef" target="_blank" href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a>));</div>
<div class="line">  query_desc.qid = <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172aa5015605752ce8aa4ada041436022b50">IAV_DESC_POLL</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_QUERY_DESC, &amp;query_desc) &lt; 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;IAV_IOC_QUERY_DESC error\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">switch</span> (query_desc.qid) {</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a94a321e201e898d629d61d2f6b625543">IAV_DESC_PYRAMID</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172ad1eb61f9c66c08ad24169d01d4d0ee9e">IAV_DESC_CANVAS</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a613e1aa4924d1c0f8367b06cd6322116">IAV_DESC_RAW</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a05a4e65f2c13698887b00b1c3ecc78f9">IAV_DESC_FRAME</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a9db6861f7e2f95821346bb4f9da4c4c3">IAV_DESC_STATIS</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172ab3398b978d51349610903adcb8d5cd43">IAV_DESC_SLICE</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">case</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a3784fa76ec935f974d8c9b198b191626">IAV_DESC_PRE_COUNT</a>:</div>
<div class="line">  <span class="comment">// Process data</span></div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"><span class="keywordflow">default</span>:</div>
<div class="line">  printf(<span class="stringliteral">&quot;unknown poll type\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172a3784fa76ec935f974d8c9b198b191626"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a3784fa76ec935f974d8c9b198b191626">IAV_DESC_PRE_COUNT</a></div><div class="ttdeci">IAV_DESC_PRE_COUNT</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172a613e1aa4924d1c0f8367b06cd6322116"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a613e1aa4924d1c0f8367b06cd6322116">IAV_DESC_RAW</a></div><div class="ttdeci">IAV_DESC_RAW</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172a9db6861f7e2f95821346bb4f9da4c4c3"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172a9db6861f7e2f95821346bb4f9da4c4c3">IAV_DESC_STATIS</a></div><div class="ttdeci">IAV_DESC_STATIS</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172aa5015605752ce8aa4ada041436022b50"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172aa5015605752ce8aa4ada041436022b50">IAV_DESC_POLL</a></div><div class="ttdeci">IAV_DESC_POLL</div></div>
<div class="ttc" id="agroup__iav-ioctl-general-helper_html_gga3606b35b652dca594dc455dfb0b9f172ab3398b978d51349610903adcb8d5cd43"><div class="ttname"><a href="../../../library/d3/de3/group__iav-ioctl-general-helper.html#gga3606b35b652dca594dc455dfb0b9f172ab3398b978d51349610903adcb8d5cd43">IAV_DESC_SLICE</a></div><div class="ttdeci">IAV_DESC_SLICE</div></div>
</div><!-- fragment --><p >Clear the setting: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (ioctl(fd_iav, IAV_IOC_CLEAR_POLL_EVENT_CFG, NULL) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;IAV_IOC_CLEAR_POLL_EVENT_CFG error\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="poll_irq_sync_usage_drv"></a>
11.13.2 Usage of Interrupt Synchronization</h3>
<p >The following is the sample code for IAV vdsp synchronization usage.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> fd;</div>
<div class="line"><span class="keyword">struct </span>pollfd fds = {0};</div>
<div class="line"><span class="keywordflow">if</span> ((fd = open(<span class="stringliteral">&quot;/proc/ambarella/vdsp_sync&quot;</span>, O_RDWR, 0)) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Open %s error!\n&quot;</span>, name);</div>
<div class="line">  return ;</div>
<div class="line">}</div>
<div class="line">fds.fd = fd;</div>
<div class="line">fds.events = POLLIN | POLLERR;</div>
<div class="line"><span class="comment">// clear the old data</span></div>
<div class="line">poll(&amp;fds, 1, 0);</div>
<div class="line"><span class="keywordflow">while</span> (!quit_loop) {</div>
<div class="line">  rval = poll(&amp;fds, 1, WAIT_2S);</div>
<div class="line">  <span class="keywordflow">if</span>(rval &lt; 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll error!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rval == 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll timeout!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll success!\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLERR) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;vdsp irq sync get POLLERR\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLIN) {</div>
<div class="line">    <span class="comment">//Doing user operations here.</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p >The following is the sample code for IAV vcap sync usage. Vcap proc file is created for per channel. The code for channel 0 is as below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> fd;</div>
<div class="line"><span class="keyword">struct </span>pollfd fds = {0};</div>
<div class="line"><span class="keywordflow">if</span> ((fd = open(<span class="stringliteral">&quot;/proc/ambarella/vcap_0_sync&quot;</span>, O_RDWR, 0)) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Open %s error!\n&quot;</span>, name);</div>
<div class="line">  return ;</div>
<div class="line">}</div>
<div class="line">fds.fd = fd;</div>
<div class="line">fds.events = POLLIN | POLLERR;</div>
<div class="line"><span class="comment">// clear the old data</span></div>
<div class="line">poll(&amp;fds, 1, 0);</div>
<div class="line"><span class="keywordflow">while</span> (!quit_loop) {</div>
<div class="line">  rval = poll(&amp;fds, 1, WAIT_2S);</div>
<div class="line">  <span class="keywordflow">if</span>(rval &lt; 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll error!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rval == 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll timeout!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll success!\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLERR) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;vdsp irq sync get POLLERR\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLIN) {</div>
<div class="line">    <span class="comment">//Doing user operations here.</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p >The following is the sample code for IAV venc sync usage. Venc proc file is created for per stream. The code for stream 0 is as below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> fd;</div>
<div class="line"><span class="keyword">struct </span>pollfd fds = {0};</div>
<div class="line"><span class="keywordflow">if</span> ((fd = open(<span class="stringliteral">&quot;/proc/ambarella/venc_0_sync&quot;</span>, O_RDWR, 0)) &lt; 0) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Open %s error!\n&quot;</span>, name);</div>
<div class="line">  return ;</div>
<div class="line">}</div>
<div class="line">fds.fd = fd;</div>
<div class="line">fds.events = POLLIN | POLLERR;</div>
<div class="line"><span class="comment">// clear the old data</span></div>
<div class="line">poll(&amp;fds, 1, 0);</div>
<div class="line"><span class="keywordflow">while</span> (!quit_loop) {</div>
<div class="line">  rval = poll(&amp;fds, 1, WAIT_2S);</div>
<div class="line">  <span class="keywordflow">if</span>(rval &lt; 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll error!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rval == 0) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll timeout!\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    printf(<span class="stringliteral">&quot;poll success!\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLERR) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;vdsp irq sync get POLLERR\n&quot;</span>);</div>
<div class="line">    return ;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (fds.revents &amp; POLLIN) {</div>
<div class="line">    <span class="comment">//Doing user operations here.</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_return_value"></a>
11.14 Return Value of APIs</h2>
<p >All return values of IOCTL APIs are defined in /ambarella/kernel/linux/include/uapi/asm-generic/errno-base.h. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Error number   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">EPERM   </td><td class="markdownTableBodyLeft">Operation not permitted    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">EIO   </td><td class="markdownTableBodyLeft">I/O error    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">EAGAIN   </td><td class="markdownTableBodyLeft">Try again    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">ENOMEM   </td><td class="markdownTableBodyLeft">Out of memory    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">EACCES   </td><td class="markdownTableBodyLeft">Permission denied    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">EFAULT   </td><td class="markdownTableBodyLeft">Bad address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">EBUSY   </td><td class="markdownTableBodyLeft">Device or resource busy    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">EINVAL   </td><td class="markdownTableBodyLeft">Invalid argument   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="sec_iav_api"></a>
12. IAV API</h1>
<p >In <a class="el" href="../../d5/d1d/group__iav-api.html">IAV IOCTL API</a>, Ambarella has put APIs in groups as below:</p>
<h2><a class="anchor" id="sec_iav_api_vin"></a>
12.1 IAV IOCTL API: VIN</h2>
<p >Each source represents one real video input device. In a working system, there should be at least one input source. The application can query the total source number, the active source ID, and set the active source ID. <b>IAV_IOC_VIN_*</b> operations will be applied on the active source, so the application must take care to select an active source ID before sending any <b>IAV_IOC_VIN_*</b> IO control commands.</p>
<p ><a class="el" href="../../d1/d4e/group__iav-ioctl-vin-api.html">IAV IOCTL API: Vin</a> will show more details about the API details.</p>
<h2><a class="anchor" id="sec_iav_api_vout"></a>
12.2 IAV IOCTL API: VOUT</h2>
<p ><a class="el" href="../../d1/d1a/group__iav-ioctl-vout-api.html">IAV IOCTL API: Vout</a> will show more details about vout related ioctl, located in file iav_vin_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_ucode"></a>
12.3 IAV IOCTL API: Load Ucode</h2>
<p ><a class="el" href="../../d8/d37/group__iav-ioctl-ucode-api.html">IAV IOCTL API: Load Ucode</a> will show more details about ucode loading related ioctl, located in file iav_ucode_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_drv"></a>
12.4 IAV IOCTL API: DSP &amp; Driver Control</h2>
<p ><a class="el" href="../../df/d17/group__iav-ioc-enc-use-drv.html">IAV IOCTL API: DSP &amp; driver Control</a> will show more details about DSP &amp; Driver related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_enc"></a>
12.5 IAV IOCTL API: Encode Pyramid Control</h2>
<p ><a class="el" href="../../d7/d79/group__iav-ioc-enc-use-pyra.html">IAV IOCTL API: Encode Pyramid Control</a> will show more details about Encode Pyramid related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_sys"></a>
12.6 IAV IOCTL API: System Control</h2>
<p ><a class="el" href="../../d8/dc4/group__iav-ioc-enc-use-sys.html">IAV IOCTL API: System Control</a> will show more details about System Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_efm"></a>
12.7 IAV IOCTL API: EFM</h2>
<p ><a class="el" href="../../dc/dce/group__iav-ioc-enc-use-efm.html">IAV IOCTL API: EFM Control</a> will show more details about EFM related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_efr"></a>
12.8 IAV IOCTL API: EFR</h2>
<p ><a class="el" href="../../d6/d5d/group__iav-ioc-enc-use-efr.html">IAV IOCTL API: EFR Control</a> will show more details about EFR related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_mem"></a>
12.9 IAV IOCTL API: Memory Management Control</h2>
<p >The most efficient way to share data with IAV, user space application and DSP, is to use the share memory between Arm and DSP, then memory mapping from Arm kernel space to Arm user space.</p>
<p >The shared buffers include DSP memory partition, bit stream buffer partition, user buffer partition, overlay buffer partition, QP ROI matrix buffer partition, warp buffer partition, JPEG quant matrix table buffer partition, image buffer partition, privacy mask buffer partition, and bad pixel correction buffer partition as shown below. All partition sizes are configurable in the "iav_config.h" file. </p><div class="image">
<img src="../../iav_memory_layout.jpg" alt=""/>
<div class="caption">
IAV Related Memory Layout.</div></div>
<p >These partitions are pre-allocated and already pre-mapped at kernel space. User space applications query the physical address / length of each partition from IAV and map it into the user space address themselves.</p>
<p >The base address and total size of IAV related partitions can be configured through menuconfig, allowing customers to make changes for the customized design; however, the dynamic random access memory (DRAM) size must meet DSP minimum requirement.</p>
<p >By default, all partitions are mapped as "non-cached" memory in the IAV driver. If customers want to change any partition map type from "non-cached" to "cached" to get a faster read or write speed from cache benefits, it is suggested to contact the SDK support team for assistance.</p>
<p >User partition is used to store large data and export to the application to call GDMA to speed up the memory access operations.</p>
<p >go to <a class="el" href="../../da/d9a/group__iav-ioc-enc-use-mem.html">IAV IOCTL API: Memory Management Control</a> to see more details about the APIs.</p>
<h2><a class="anchor" id="sec_iav_api_stm"></a>
12.10 IAV IOCTL API: Stream Control</h2>
<p ><a class="el" href="../../da/dd7/group__iav-ioc-enc-use-stm.html">IAV IOCTL API: Stream Control</a> will show more details about Stream Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_ovl"></a>
12.11 IAV IOCTL API: Overlay Control</h2>
<p ><a class="el" href="../../d9/dcc/group__iav-ioc-enc-use-ovl.html">IAV IOCTL API: Overlay/Blur Control</a> will show more details about Overlay Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_vcap"></a>
12.12 IAV IOCTL API: Vcap Control</h2>
<p ><a class="el" href="../../de/ddc/group__iav-ioc-enc-use-vcap.html">IAV IOCTL API: Vcap Control</a> will show more details about Vcap Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_vproc"></a>
12.13 IAV IOCTL API: VProc Control</h2>
<p ><a class="el" href="../../d6/d04/group__iav-ioc-enc-use-vproc.html">IAV IOCTL API: Vproc Control</a> will show more details about VProc Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_vind"></a>
12.14 IAV IOCTL API: VIN &amp; IDSP Control</h2>
<p ><a class="el" href="../../d1/df5/group__iav-ioc-enc-use-vin.html">IAV IOCTL API: Vin &amp; IDSP Control</a> will show more details about VIN &amp; IDSP Control related ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_dbg"></a>
12.15 IAV IOCTL API: Debug IOCTL</h2>
<p ><a class="el" href="../../d5/d7d/group__iav-ioc-enc-use-dbg.html">IAV IOCTL API: Debug IOCTL</a> will show more details about Debug ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_dec"></a>
12.16 IAV IOCTL API: Decoder Control</h2>
<p ><a class="el" href="../../dc/d2b/group__iav-ioctl-dec-api.html">IAV IOCTL API: Decoder</a> will show more details about decode ioctl, located in file iav_ioctl.h</p>
<h2><a class="anchor" id="sec_iav_api_img_scale"></a>
12.17 IAV IOCTL API: Arbitrary Image Scaler Control</h2>
<p ><a class="el" href="../../db/d4b/group__iav-ioc-enc-img-scale.html">IAV IOCTL API: Arbitrary Image Scaler</a> will show more details about arbitrary image scale ioctl, located in file iav_ioctl.h </p><hr  />
<h1><a class="anchor" id="iav_license"></a>
13. License</h1>
<p >Copyright (c) 2024 Ambarella International LP</p>
<p >This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p>
<p >This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p >You should have received a copy of the GNU General Public License along with this program; if not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
