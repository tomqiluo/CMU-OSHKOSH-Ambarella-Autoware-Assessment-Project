<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Driver: CMA Driver API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Driver"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Driver<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/d84/page_drv_cma_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">CMA Driver API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cma_driver_history"></a>
0. Revision History</h1>
<a class="anchor" id="drv_cma_rev_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>SDK Version </th><th>Updated Date </th><th>Modification </th></tr>
<tr>
<td>0.2 </td><td>20211021 </td><td>Initial Version </td></tr>
<tr>
<td rowspan="7">0.5 </td><td rowspan="7">20220114 </td><td>Added Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#cma_layout_intr">1. Memory Layout Introduction</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_specify_cma_partion">3.2 Specifying CMA Partitions through Device Trees</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sub_sec_enable">3.3.3 Enabling and Synchronizing the Cache for MMBs</a>. </td></tr>
<tr>
<td>Added Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_driver_private_share">3.5 IAV / DSP Private and Shared MMBs</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_dump_mmb_info">3.7 Dump MMB Information</a>. </td></tr>
<tr>
<td>Updated Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sub_sec_mod_conf">4.1.2 Module Parameters Configuration</a>. </td></tr>
<tr>
<td>Updated Chapter <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sub_sec_conf_mod_para">4.3.1 Configuring Module Parameters</a>. </td></tr>
<tr>
<td>1.0 </td><td>20220718 </td><td>Migrated this CMA driver document from WORD form into Doxygen form. </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="cma_layout_intr"></a>
1. Memory Layout Introduction</h1>
<p >The Ambarella Cooper platforms support 4-GB, 8-GB, 16-GB, and larger dynamic random-access memory (DRAM) sizes. The chip series targets 8Kp30+ or 4x4K processing, requiring large DRAM bandwidth as well as high resolution Image signal processor (ISP) and encoding processing.</p>
<p >According to real-case usage requirements, Ambarella divides the system memory into the following three categories through the continuous memory allocator (CMA).</p><ul>
<li>DSP private memory partition<ul>
<li><b>"DSP + Arm®"</b> access only: computer vision (CV) cannot read or write the memory in this partition.</li>
</ul>
</li>
<li>CV private memory partition<ul>
<li><b>"Arm + CV"</b> access only: DSP cannot read or write the memory in this partition.</li>
</ul>
</li>
<li>DSP and CV shared memory partition<ul>
<li>The memory in this partition can be accessed by <b>"DSP + CV + Arm"</b>, which means DSP, CV, and Arm can access the memory in this partition. Currently, the DSP and CV shared memory partition is not yet supported for use.</li>
</ul>
</li>
</ul>
<p >For the Cooper platforms, Arm has been upgraded in order to access DRAM with a 40-bit address bitwidth, which exceeds the minimum to access the entire DRAM. However, for CV5x, the DRAM access address bitwidth DSP and CV remains 32 bits; as a result, of the both can only access 4-GB of memory space. To address this, different memory layouts will be made for 4-GB and 8-GB DRAM accordingly. For CV72, CV can access the entire DRAM, while DSP still can only access 32-bit DRAM. Currently, the memory layout for CV72 shares the same as CV5x. However, it is possible to put CV private memory partition in any address inside the whole DRAM.</p>
<h2><a class="anchor" id="cma_4g_layout"></a>
1.1 4-GB Memory Layout</h2>
<p >The total 4-GB DRAM size can be accessed by <b>"Arm + CV + DSP"</b>. The figure below shows the system memory layout for 4-GB DRAM size, which is applied to the <b>"CV52 Zr"</b> platform.</p>
<div class="image">
<img src="../../4g_layout.jpg" alt=""/>
<div class="caption">
Figure 1-1. 4-GB DRAM System Memory Layout.</div></div>
<hr  />
<h2><a class="anchor" id="cma_8g_layout"></a>
1.2 8-GB Memory Layout</h2>
<p >Because the DRAM access address bitwidth of both DSP and CV are 32 bits, they are unable to directly access the memory beyond the 4G boundary. To enable them to have their own 4 GB memory space, the CV5x / CV7x platform utilizes the address translation table (ATT) mapping for "DSP Memory Space" (both "DSP Private Pool" and "DSP &amp; VP Shared Pool"), while CV, "CV Private Pool", and "DSP &amp; VP Shared Pool" continue using the default DRAM memory space (as they are both within 4 GB).</p>
<p >The ATT process for "DSP Memory Space" is separated into the following two steps.</p><ol type="1">
<li>While performing ATT mapping, "DSP Private Pool" is mapped from 0, which means its offset in the ATT memory space will be the same with the lower u32 of its DRAM physical address. For example, if the DRAM physical address is 0x1, 0010, 0000, then the offset in the ATT memory space will be 0x0010, 0000.</li>
<li>Map "DSP &amp; VP Shared Pool" to the end of the 4-GB ATT memory space, which means that its offset in the ATT memory space will be the same as its DRAM physical address. For example, if the DRAM physical address is 0xFF10, 0000, then its offset in the ATT memory space will also be 0xFF10, 0000.</li>
</ol>
<p >Consequently, the memory layout of the 8-GB DRAM size is designed as shown below.</p>
<div class="image">
<img src="../../8g_layout.jpg" alt=""/>
<div class="caption">
Figure 1-2. 8-GB DRAM System Memory Layout.</div></div>
<p >The table below shows the DRAM access limitation for Arm, CV, and DSP respectively.</p>
<dl class="section user"><dt>8-GB DRAM Access Limitation for Arm, CV, and DSP</dt><dd><a class="anchor" id="cma_table_8g_limit"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Element </th><th>DRAM Access Limitation </th></tr>
<tr>
<td>Arm </td><td>0~8 GB </td></tr>
<tr>
<td>CV </td><td>0~4 GB </td></tr>
<tr>
<td>DSP </td><td>DSP memory space </td></tr>
</table>
</dd></dl>
<hr  />
<h1><a class="anchor" id="cma_memory"></a>
2. Memory Management of IAV / DSP Partitions</h1>
<p >This chapter provides an introduction of memory management for the IAV / DSP partitions: CMA memory management.</p>
<p >According to the <em>Flexible</em> <em>Linux</em> <em>SDK</em> <em>Design</em> <em>Guide</em> <em>-</em> <em>DRAM</em> <em>Optimization</em> document, the DRAM system consists of four partitions: Linux, image audio video (IAV), DSP, and CV partitions. The CMA Linux kernel feature supports allocating large, physically contiguous memory blocks at runtime. This feature is used for the allocation of the IAV, DSP, and CV partitions, enabling the partition sizes to be resized during runtime. Once the CMA method is applied, the DRAM can be separated into two partitions, the Linux and CMA partitions (see below), from which the IAV, DSP, and CV partitions are allocated. This method is called CMA memory management.</p>
<div class="image">
<img src="../../CMA_memory_management.jpg" alt=""/>
<div class="caption">
Figure 2-1. CMA Memory Management.</div></div>
<h2><a class="anchor" id="reserved_memory_management"></a>
2.1 Reserved Memory Management</h2>
<p >Using the CMA memory management method, IAV / DSP / CV partitions can be allocated / freed from the CMA partition during runtime. Ambarella recommends that users closely specify the size of the CMA partition according to their requirements, and allocate more of the available memory resources to the Linux partition.</p>
<dl class="section note"><dt>Note</dt><dd>Although the Linux system can reuse the remaining memory in the CMA partition, be aware that it can potentially trigger the out of memory (OOM)-killer, which is the result of a CMA limitation. For more information on the CMA limitations, refer to Chapter <a class="el" href="../../d8/d84/page_drv_cma_doc.html#cma_faq">5. FAQ</a>.</dd></dl>
<p>Choose CMA memory management through menuconfig, as follows. </p><dl class="section user"><dt>For CV2x SDK 3.0 Amba build</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">        IAV/DSP Memory (Linux CMA)  ---&gt;</div>
<div class="line">        [ ] CV memory from Reserved memory</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     -*- board (boards)  ---&gt;</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">         IAV/DSP Memory (Linux CMA)  ---&gt;</div>
<div class="line">         [ ] CV memory from Reserved memory</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-bsp ---&gt;</div>
<div class="line">      -*- board (meta-ambabsp/recipes-bsp/board)  ---&gt;</div>
<div class="line">          Memory  ---&gt;</div>
<div class="line">                IAV/DSP Memory (Linux CMA)  ---&gt;</div>
<div class="line">                [ ] CV memory from Reserved memory</div>
</div><!-- fragment --></dd></dl>
<p>The CMA partition consists of two separate CMA memory pools: one for the IAV and DSP partitions; the other for the CV partition only. The start address of each CMA memory pool is configured through menuconfig.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>As a Linux system requirement of the CMA, the start address and size must be <b>4 MB aligned</b>.</li>
</ul>
</dd></dl>
<p>For example, on the CV5 Timn board, users can issue the following commands to set the size of the CMA memory pool for the IAV and DSP partitions to 2816 MB and to set the size of CMA memory pool for the CV partition to 512 MB: </p><dl class="section user"><dt>For CV2x SDK 3.0 Amba build</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     Memory  ---&gt;</div>
<div class="line">         (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">         (16) DSP Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">         (512) CV Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="ttc" id="aiav__utils_8h_html_aa6b38d492364d98453284934ed7caee9"><div class="ttname"><a href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div><div class="ttdeci">#define MB</div><div class="ttdef"><b>Definition:</b> iav_utils.h:38</div></div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     -*- board (boards)  ---&gt;</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">               (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">               (16) DSP Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">               (512) CV Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">@par For Cooper Yocto build:</div>
<div class="line">@code {.c}</div>
<div class="line">build $ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-bsp ---&gt;</div>
<div class="line">      -*- board (meta-ambabsp/recipes-bsp/board)  ---&gt;</div>
<div class="line">          Memory  ---&gt;</div>
<div class="line">               (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">               (16) DSP Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">               (512) CV Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
</div><!-- fragment --></dd></dl>
<p>Within the CMA memory pool for the IAV and DSP partitions, users can subdivide the DSP partition through menuconfig as shown below. The remainder of the partition is for IAV. For this configuration, the size of the DSP partition is 2560 MB and the size of the IAV partition is 256 MB. </p><dl class="section user"><dt>For CV2x SDK 3.0 Amba build</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line"> [*] Ambarella Linux Configuration -&gt;</div>
<div class="line">       [*]   Ambarella Private Drivers Configuration  ---&gt;</div>
<div class="line">         [*]   Build Ambarella <span class="keyword">private</span> IAV module  ---&gt;</div>
<div class="line">                 IAV memory options  ---&gt;</div>
<div class="line">                  (0xA0000000) DSP buffer size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">                  (0xA0000000) DSP buffer size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-video  ---&gt;</div>
<div class="line">      -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header)  ---&gt;</div>
<div class="line">                  (0xA0000000) DSP buffer size</div>
</div><!-- fragment --></dd></dl>
<p>The configuration options are the same for CV5x and CV7x.</p>
<hr  />
<h1><a class="anchor" id="cma_driver"></a>
3. CMA Driver</h1>
<p >This chapter describes the operations and functions of the CMA driver in Cooper platform.</p>
<p >This chapter includes the following sections:</p>
<ul>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_ambarella_cma_driver">3.1 Ambarella CMA Driver</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_specify_cma_partion">3.2 Specifying CMA Partitions through Device Trees</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_memory_mangement_block">3.3 Memory Management Block</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_pre_allocate_mmbs">3.4 Pre-Allocated MMBs</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_driver_module_parameters">3.6 Driver Module Parameters</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_dump_mmb_info">3.7 Dump MMB Information</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sec_private_mem_allocator">3.8 Private Memory Allocator AMA</a> </li>
</ul>
<h2><a class="anchor" id="sec_ambarella_cma_driver"></a>
3.1 Ambarella CMA Driver</h2>
<p >In order to effectively manage the entire CMA partition while also serving various types of module drivers (such as IAV, DSP, and imgproc), the kernel CMA’s application programming interfaces (APIs) are wrapped into Ambarella’s CMA driver, then exported to a group of APIs for the module drivers.</p>
<p >These APIs cover general functions, such as memory block allocation / free, memory block information queries, memory block mapping, and more.</p>
<div class="image">
<img src="../../CMA_diagram.jpg" alt=""/>
<div class="caption">
Figure 3-1. Diagram of Ambarella CMA Driver and Other Module Drivers.</div></div>
<dl class="section note"><dt>Note</dt><dd>Currently, only the CMA memory pool for IAV / DSP partitions is managed by the Ambarella CMA driver. While the CMA memory pool is used for CV partitions, it is managed by the Ambarella Cavalry driver. For more details, refer to the <em>Flexible</em> <em>Linux</em> <em>SDK</em> <em>Design</em> <em>Guide</em> <em>Cavalry</em> <em>Driver</em> document.</dd></dl>
<hr  />
<h2><a class="anchor" id="sec_specify_cma_partion"></a>
3.2 Specifying CMA Partitions through Device Trees</h2>
<p >As Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#cma_layout_intr">1. Memory Layout Introduction</a> described, Ambarella divides the system memory into "DSP Private Memory Pool", "CV
Private Memory Pool", and "DSP &amp; CV Shared Memory Pool" through CMA.</p>
<p >Users can configure the size for the CMA pools listed above through menuconfig. </p><dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">     -*- board (boards)  ---&gt;</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">     (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">     (16) DSP Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">     (512) CV Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">     (0) CV Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-bsp ---&gt;</div>
<div class="line">      -*- board (meta-ambabsp/recipes-bsp/board)  ---&gt;</div>
<div class="line">          Memory  ---&gt;</div>
<div class="line">             (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">             (16) DSP Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">             (512) CV Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">             (0) CV Shared Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line">After menuconfig is done, it will finally be applied to the device tree (DTS) automatically,</div>
<div class="line">which decides the size of the CMA pools. So users do not have to modify the DTS manually.</div>
<div class="line">For user&#39;s reference, the CMA pool related parts in the DTS are listed below, which uses the</div>
<div class="line">CV5 Timn board as an example,</div>
<div class="line"> </div>
<div class="line">@par CMA Memory Partition Related DTS Nodes</div>
<div class="line">&lt;table&gt;</div>
<div class="line">&lt;caption <span class="keywordtype">id</span>=&quot;cma_table_dts_node&quot;&gt;&lt;/caption&gt;</div>
<div class="line">&lt;tr&gt;&lt;th&gt; DTS Nodes      &lt;th&gt; Description</div>
<div class="line">&lt;tr&gt;&lt;td&gt; iav_reserved: iav@0          &lt;td&gt; &quot;Arm + DSP&quot; access only memory partition</div>
<div class="line">&lt;tr&gt;&lt;td&gt; iav_shared: iav@1            &lt;td&gt; &quot;DSP + CV + Arm&quot; shared memory partition</div>
<div class="line">&lt;tr&gt;&lt;td&gt; cavalry_reserved: cavalry@0  &lt;td&gt; &quot;Arm + CV&quot; access only memory partition</div>
<div class="line">&lt;tr&gt;&lt;td&gt; cavalry_shared: cavalry@1    &lt;td&gt; &quot;DSP + CV + Arm&quot; shared memory partition</div>
<div class="line">&lt;/table&gt;</div>
<div class="line"> </div>
<div class="line">@code {.c}</div>
<div class="line">a/bsp/CV5_timn_private.dtsi</div>
<div class="line"><span class="preprocessor">#include &lt;arch_v6/plat_memory.h&gt;</span></div>
<div class="line"> </div>
<div class="line">/ {</div>
<div class="line">    reserved-memory {</div>
<div class="line"><span class="preprocessor">        #address-cells = &lt;2&gt;;</span></div>
<div class="line"><span class="preprocessor">        #size-cells = &lt;2&gt;;</span></div>
<div class="line">        ranges;</div>
<div class="line"> </div>
<div class="line">        linux,cma {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">            reusable;</div>
<div class="line">            size = &lt;0 0x04000000&gt;;</div>
<div class="line">            linux,cma-<span class="keywordflow">default</span>;</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        iav_reserved: iav@0 {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">            no-map;</div>
<div class="line">            reg = &lt;(IDSP_RAM_START &gt;&gt; 32) (IDSP_RAM_START&amp;0xFFFFFFFF) 0x0 IDSP_PRIVATE_SIZE&gt;;</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        iav_shared: iav@1 {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">            no-map;</div>
<div class="line"><span class="preprocessor">#if (IDSP_SHARED_SIZE &gt; 0)</span></div>
<div class="line">            reg = &lt;(IDSP_SHARED_START &gt;&gt; 32) (IDSP_SHARED_START&amp;0xFFFFFFFF) 0x0 IDSP_SHARED_SIZE&gt;;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        cavalry_reserved: cavalry@0 {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">            no-map;</div>
<div class="line">            reg = &lt;(CV_RAM_START &gt;&gt; 32) (CV_RAM_START&amp;0xFFFFFFFF) 0x0 CV_PRIVATE_SIZE&gt;;</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        cavalry_shared: cavalry@1 {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;shared-dma-pool&quot;</span>;</div>
<div class="line">            no-map;</div>
<div class="line"><span class="preprocessor">#if (CV_SHARED_SIZE &gt; 0)</span></div>
<div class="line">            reg = &lt;(CV_SHARED_START &gt;&gt; 32) (CV_SHARED_START&amp;0xFFFFFFFF) 0x0 CV_SHARED_SIZE&gt;;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    iav {</div>
<div class="line">        <span class="comment">// node for hwtimer controller</span></div>
<div class="line">        hwtimer {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;ambarella,hwtimer&quot;</span>;</div>
<div class="line">            interrupts = &lt;0 25 0x1&gt;;</div>
<div class="line">            interrupt-names = <span class="stringliteral">&quot;hwtimer&quot;</span>;</div>
<div class="line">        };</div>
<div class="line"> </div>
<div class="line">        ambcma {</div>
<div class="line">            compatible = <span class="stringliteral">&quot;ambarella,cma&quot;</span>;</div>
<div class="line">            memory-region = &lt;&amp;iav_reserved&gt;;</div>
<div class="line">            shared-region = &lt;&amp;iav_shared&gt;;</div>
<div class="line">            dsp_buf_size = &lt;0x20000000&gt;;</div>
<div class="line">        };</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    sub_scheduler: sub_scheduler0 {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;ambarella,sub-scheduler&quot;</span>;</div>
<div class="line">        interrupts = &lt;0 169 0x4&gt;, &lt;0 170 0x4&gt;, &lt;0 171 0x4&gt;, &lt;0 172 0x4&gt;, &lt;0 173 0x4&gt;;</div>
<div class="line">        memory-region = &lt;&amp;cavalry_reserved&gt;;</div>
<div class="line">        shared-region = &lt;&amp;cavalry_shared&gt;;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (DRAM_SIZE &gt; (4 * SIZE_GB))</span></div>
<div class="line">    att-regmap {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;ambarella,att-regmap&quot;</span>;</div>
<div class="line">        amb,att-debug;</div>
<div class="line">        dram-size = &lt;(DRAM_SIZE &gt;&gt; 32) (DRAM_SIZE&amp;0xFFFFFFFF)&gt;;</div>
<div class="line">        client-bitmap = &lt;0x006F8000&gt;;</div>
<div class="line">        <span class="comment">// &lt;virt-addr phys-addr size&gt;</span></div>
<div class="line">        segment-regmap =</div>
<div class="line"><span class="preprocessor">#if (CV_SHARED_START &lt; (4 * SIZE_GB))</span></div>
<div class="line">            &lt;0 CV_SHARED_START 0 CV_SHARED_START 0 (CV_SHARED_SIZE + IDSP_SHARED_SIZE)&gt;,</div>
<div class="line">#endif</div>
<div class="line">            &lt;0 0 (IDSP_RAM_START &gt;&gt; 32) (IDSP_RAM_START&amp;0xFFFFFFFF) 0 IDSP_PRIVATE_SIZE&gt;;</div>
<div class="line">    };</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">};</div>
</div><!-- fragment --></dd></dl>
<hr  />
<h2><a class="anchor" id="sec_memory_mangement_block"></a>
3.3 Memory Management Block</h2>
<p >Each IAV / DSP sub-partition in the CMA driver, such as the bitstream buffer (BSB) partition, user buffer partition, overlay buffer partition, and others are abstracted into a memory management block (MMB). Additionally, each IAV / DSP sub-partition corresponds to only one MMB. All MMBs are created and maintained in the CMA driver. Other module drivers perform MMB allocation / free, memory mapping, and MMB information queries through the APIs exported by Ambarella’s CMA driver.</p>
<h3><a class="anchor" id="sub_sec_anon"></a>
3.3.1 Anonymous MMB</h3>
<p >In addition to the specified IAV / DSP sub-partitions, users may require their own continuous memory partitions.</p>
<p >To meet these requirements, the CMA driver utilizes an anonymous MMB. After an anonymous MMB is allocated, the CMA driver assigns it a random memory partition ID instead of a fixed memory partition ID (such as IAV_PART_BSB for the BSB).</p>
<p >Additionally, user applications can perform data analysis on the anonymous MMBs. In order to shorten the analysis time, the Arm data cache can be enabled for the anonymous MMBs when they are mapped to the user memory space.</p>
<h3><a class="anchor" id="sub_sec_custom"></a>
3.3.2 User-Customized MMB</h3>
<p >For certain use cases, users may be required to create a continuous memory partition with a customized and fixed partition ID. The CMA driver enables a user-customized MMB. When using customized MMBs, applications or other module drivers can specify the custom partition IDs when allocating these MMBs. Currently, the selected range of user-customized partition IDs ranges from 192 to 254 (inclusive).</p>
<dl class="section note"><dt>Note</dt><dd>User applications can also enable the Arm data cache for customized MMBs that are mapped from the user memory space.</dd></dl>
<h3><a class="anchor" id="sub_sec_enable"></a>
3.3.3 Enabling and Synchronizing the Cache for MMBs</h3>
<p >Cache is a high-speed buffer between the CPU and DRAM to address the condition of data read / write speed mismatch in the system. Ambarella CMA framework supports enabling the cache for specified MMBs. For more details on cached MMBs, refer to <a class="el" href="../../d8/d84/page_drv_cma_doc.html#specify_cache_mmbs">4.3 Specifying Cached MMBs</a>.</p>
<p >In a multi-core system, the following two factors may cause the cache inconsistency issue that leads the CPU or input / output (I/O) devices to read the wrong data.</p><ul>
<li>As the CPU writes data to the cache, the contents change. However, as DRAM is not written immediately, the DRAM data is not changed.</li>
<li>The I/O processor or I/O device writes data to the main memory. The contents of DRAM are modified, but the contents of cache are not.</li>
</ul>
<p >To solve the condition of incorrect data reading caused by a cache inconsistency, Ambarella provides two APIs, as seen below.</p><ul>
<li><b>ambarella_cma_clean_cache</b>: checks the dirty bit of the memory cache line. If the dirty bit is 1, write the contents of the cache line back to the next-level storage and set the dirty bit to 0.</li>
<li><b>ambarella_cma_invalidate_cache</b>: checks the valid bit of the memory cache line. If the valid bit is 1, set it to 0 to discard the cached contents</li>
</ul>
<p >The combination of <b>"clean cache"</b> and <b>"invalidate cache"</b> operations above is called the <b>"flush cache"</b> process. Users can decide which operation should be executed according to the direction of data access. The detailed usages are listed below:</p><ul>
<li>If the CPU writes data to DRAM first, and then DMA or other devices access DRAM, users must execute <b>clean cache</b> first to ensure that the DMA or other devices access DRAM accurately.</li>
<li>If the CPU reads DRAM first, DMA or other devices are not required to execute <b>clean cache</b> before accessing it. Once DMA or other devices re-write the DRAM, users must execute <b>invalidate cache</b>. This enables the CPU to read the data from DRAM directly, rather than the data in the cache.</li>
<li>If both CPU and DMA access a block of DRAM concurrently, Ambarella recommends that users execute a <b>"flush cache"</b> before reading / writing such a block of DRAM to avoid cache inconsistency issues.</li>
</ul>
<hr  />
<h2><a class="anchor" id="sec_pre_allocate_mmbs"></a>
3.4 Pre-Allocated MMBs</h2>
<p >The sizes of most IAV / DSP sub-partitions do not require modification after they are specified through the compiled configuration or module parameters of the Ambarella CMA driver. Users should merge them into a large contiguous area, referred to as the pre-allocated MMB, as this will be the first sub-partition allocated at the beginning of the partition.</p>
<p >Only the IAV / DSP sub-partitions whose sizes will be modified during runtime are allocated in the left CMA partition, resulting in less memory fragmentation. The first table provided below illustrates the list of IAV / DSP sub-partitions that can be placed into the pre-allocated MMB.</p>
<p >Because the size of the IAV / DSP sub-partitions placed into the pre-allocated MMB cannot be changed on the fly, particular sub-partitions (such as the DSP FIFO buffer and the blend alpha buffer) cannot be placed into the pre-allocated MMB. This is because their sizes will be dynamically changed in the IAV / DSP driver. The second table in this section provides the list of IAV / DSP sub-partitions that cannot be added into the pre-allocated MMB. The following figure illustrates the pre-allocated and resizable MMBs.</p>
<div class="image">
<img src="../../pre_allocated_MMBS.jpg" alt=""/>
<div class="caption">
Figure 3-2. Diagram of Pre-Allocated MMB and Resizable MMBs.</div></div>
<dl class="section user"><dt>Diagram of Pre-Allocated MMB and Resizable MMBs</dt><dd><a class="anchor" id="sub_partitions_supported_mmbs"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV / DSP Sub-partition </th><th>State </th></tr>
<tr>
<td>IAV_PART_DSP </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_DSP_DEF_CMD </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_DSP_LOG </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_IMG </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_BSH </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_DSP_UCODE </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_DSP_RSV </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_IAV_RSV </td><td><b>Compulsory</b> </td></tr>
<tr>
<td>IAV_PART_BSB </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_USR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MV </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_OVERLAY </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QPMATRIX </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_WARP </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QUANT </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MASK </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_FB_DATA </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_FB_AUDIO </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_INTRA_PB </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_STAT </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_PREALLOC </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_PREALLOC2 </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_BLUR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_HEVC_SCALELIST </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MULTI_COLOR_MASK </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_INT_BSB </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_ARB_BLUR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_EXTRA_RAW </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_TFC </td><td>Selective </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>IAV / DSP Sub-Partitions that Cannot be Supported in Pre-Allocated MMBs</dt><dd><a class="anchor" id="cannot_supported_pre-allocated_mmbs"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV / DSP Sub-partition </th><th>State </th></tr>
<tr>
<td>AV_PART_BLEND_ALPHA </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_DSP_FIFO </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_PYRAMID_POOL </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_DSP_FIFO </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_VOUT0_FB </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_VOUT1_FB </td><td>Not Permitted </td></tr>
<tr>
<td>IAV_PART_VOUT2_FB </td><td>Not Permitted </td></tr>
</table>
</dd></dl>
<hr  />
<h2><a class="anchor" id="sec_driver_private_share"></a>
3.5 IAV / DSP Private and Shared MMBs</h2>
<p >As chapter <a class="el" href="../../d8/d84/page_drv_cma_doc.html#cma_layout_intr">1. Memory Layout Introduction</a> described, Ambarella divides the system memory into "DSP private memory pool", "CV private
memory pool", and "DSP &amp; CV shared memory pool" through the CMA.</p>
<p >The combination of "DSP private memory pool" and "DSP &amp; CV shared memory pool" is called "DSP memory space". Table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sub_partitions_supported_mmbs">IAV / DSP Sub-partitions private MMBs</a> lists the IAV / DSP private MMBs which can only be accessed by "Arm + DSP", while the Table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#sub_partitions_share_mmbs">IAV / DSP Sub-partitions shared MMBs</a> lists the IAV / DSP shared MMBs which can be access by "Arm + DSP + CV".</p>
<div class="image">
<img src="../../CMA_constituent_pool.jpg" alt=""/>
<div class="caption">
Figure 3-3. The Constituent Pool of DSP Memory Space.</div></div>
<dl class="section user"><dt>IAV / DSP Sub-partitions Private MMBs</dt><dd><a class="anchor" id="sub_partitions_supported_mmbs"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV / DSP Sub-partition </th><th>Attribute </th></tr>
<tr>
<td>IAV_PART_DSP </td><td>Private </td></tr>
<tr>
<td>IAV_PART_DSP_DEF_CMD </td><td>Private </td></tr>
<tr>
<td>IAV_PART_DSP_LOG </td><td>Private </td></tr>
<tr>
<td>IAV_PART_IMG </td><td>Private </td></tr>
<tr>
<td>IAV_PART_BSH </td><td>Private </td></tr>
<tr>
<td>IAV_PART_DSP_UCODE </td><td>Private </td></tr>
<tr>
<td>IAV_PART_DSP_RSV </td><td>Private </td></tr>
<tr>
<td>IAV_PART_IAV_RSV </td><td>Private </td></tr>
<tr>
<td>IAV_PART_BSB </td><td>Private </td></tr>
<tr>
<td>IAV_PART_USR </td><td>Private </td></tr>
<tr>
<td>IAV_PART_MV </td><td>Private </td></tr>
<tr>
<td>IAV_PART_OVERLAY </td><td>Private </td></tr>
<tr>
<td>IAV_PART_QPMATRIX </td><td>Private </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW </td><td>Private </td></tr>
<tr>
<td>IAV_PART_WARP </td><td>Private </td></tr>
<tr>
<td>IAV_PART_QUANT </td><td>Private </td></tr>
<tr>
<td>IAV_PART_MASK </td><td>Private </td></tr>
<tr>
<td>IAV_PART_FB_DATA </td><td>Private </td></tr>
<tr>
<td>IAV_PART_FB_AUDIO </td><td>Private </td></tr>
<tr>
<td>IAV_PART_INTRA_PB </td><td>Private </td></tr>
<tr>
<td>IAV_PART_STAT </td><td>Private </td></tr>
<tr>
<td>IAV_PART_PREALLOC </td><td>Private </td></tr>
<tr>
<td>IAV_PART_PREALLOC2 </td><td>Private </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW </td><td>Private </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL </td><td>Private </td></tr>
<tr>
<td>IAV_PART_BLUR </td><td>Private </td></tr>
<tr>
<td>IAV_PART_HEVC_SCALELIST </td><td>Private </td></tr>
<tr>
<td>IAV_PART_MULTI_COLOR_MASK </td><td>Private </td></tr>
<tr>
<td>IAV_PART_INT_BSB </td><td>Private </td></tr>
<tr>
<td>IAV_PART_ARB_BLUR </td><td>Private </td></tr>
<tr>
<td>IAV_PART_EXTRA_RAW </td><td>Private </td></tr>
<tr>
<td>IAV_PART_TFC </td><td>Private </td></tr>
<tr>
<td>IAV_PART_AISP </td><td>Private </td></tr>
<tr>
<td>IAV_PART_DEC_BSB </td><td>Private </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>IAV / DSP Sub-partitions Shared MMBs</dt><dd><a class="anchor" id="sub_partitions_share_mmbs"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV / DSP Sub-partition </th><th>Attribute </th></tr>
<tr>
<td>IAV_PART_PYRAMID_POOL </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_RAW_POOL </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_VOUT0_FB </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_VOUT1_FB </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_VOUT2_FB </td><td>Shared </td></tr>
<tr>
<td>IAV_PART_DSP_CV </td><td>Shared </td></tr>
</table>
</dd></dl>
<hr  />
<h2><a class="anchor" id="sec_driver_module_parameters"></a>
3.6 Driver Module Parameters</h2>
<p >Ambarella’s CMA driver exports various driver module parameters to specify the sizes of the IAV / DSP sub-partitions, and places the fixed sub-partitions into the pre-allocated MMBs. The table below provides detailed descriptions of the module parameters in the Ambarella CMA driver.</p>
<dl class="section note"><dt>Note</dt><dd>The CMA driver divides the memory into several partitions and maintains several banks to better manage them. Each bank maintains 32 memory partitions, <b>BANK0</b> for partition 0 ~ 31, <b>BANK1</b> for partition 32~63, and so on. Drivers maintain several module parameters for each bank.</dd></dl>
<p><b>BANK0</b>: prealloc_buf_map, cached_buf_map <br  />
 <b>BANK1</b>: prealloc_buf_map1, cached_buf_map1</p>
<dl class="section user"><dt>Illustration of Module Parameters of the Ambarella CMA Driver</dt><dd><a class="anchor" id="illustration_of_module_parameters"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Parameters </th><th>Description </th></tr>
<tr>
<td>buf_size_from_dts </td><td>Specifies if the DSP partition size from the device tree can be retrieved </td></tr>
<tr>
<td>dsp_buf_size </td><td>Specifies the size of the DSP partition (IAV_PART_DSP) </td></tr>
<tr>
<td>int_bsb_buf_size </td><td>Specifies the size of the internal bitstream partition (IAV_PART_INT_BSB) </td></tr>
<tr>
<td>bsb_buf_size </td><td>Specifies the size of the bitstream partition (IAV_PART_BSB) </td></tr>
<tr>
<td>usr_buf_size </td><td>Specifies the size of the user data partition (IAV_PART_USR) </td></tr>
<tr>
<td>mv_stat_size_per_stream </td><td>Specifies the motion vector (MV) stats buffer size for each stream. Determines the size of motion vector partition (IAV_PART_MV) with another module parameter "mv_stream_num" </td></tr>
<tr>
<td>mv_stream_num </td><td>Specifies the maximum MV stream number Determines the size of the motion vector partition (IAV_PART_MV) with another module parameter "mv_stat_size_per_stream". Meanwhile, it decides the maximum stream number for the MV statistics </td></tr>
<tr>
<td>overlay_buf_size </td><td>Specifies the size of the overlay partition (IAV_PART_OVERLAY) </td></tr>
<tr>
<td>blur_buf_size </td><td>Specifies the size of the blur partition (IAV_PART_BLUR) </td></tr>
<tr>
<td>qpm_buf_size </td><td>Specifies the size of the quantization parameter (QP) region of interest (ROI) matrix partition (IAV_PART_QPMATRIX) or the QPMATRIX_RAW partition (IAV_PART_QPMATRIX_RAW). IAV_PART_QPMATRIX and IAV_PART_QPMATRIX_RAW share the same memory partition </td></tr>
<tr>
<td>hevc_scalelist_buf_size </td><td>Specifies the size of the HEVC scale list partition (IAV_PART_HEVC_SCALELIST) </td></tr>
<tr>
<td>warp_buf_size </td><td>Specifies the size of the warp partition (IAV_PART_WARP) </td></tr>
<tr>
<td>quant_buf_size </td><td>Specifies the size of the JPEG quant matrix table (IAV_PART_QUANT) </td></tr>
<tr>
<td>pm_buf_size </td><td>Specifies the size of the MASK partition (IAV_PART_MASK) </td></tr>
<tr>
<td>pb_buf_size </td><td>Specifies the size of the intra playback partition (IAV_PART_INTRA_PB) </td></tr>
<tr>
<td>stat_buf_size </td><td>Specifies the size of the picture statistics partition (IAV_PART_STAT) </td></tr>
<tr>
<td>sbp_buf_size </td><td>Specifies the size of static bad pixel correction buffer, which is merged into (IAV_PART_IMG) </td></tr>
<tr>
<td>ik_buf_size </td><td>Specifies the size of IK configuration buffer, which is merged into (IAV_PART_IMG) </td></tr>
<tr>
<td>max_vin_width </td><td>Specifies the maximum supported video input (VIN) width, and should be aligned to 32. Determine the size of the single color privacy mask partition (IAV_PART_MASK) with another variable "max_vin_height". Meanwhile, it decides the maximum width of pyramid, warp, raw, encode from memory (EFM), and image scale </td></tr>
<tr>
<td>max_vin_height </td><td>Specifies the maximum-supported VIN height, and should be aligned to 16. Determine the size of the single color privacy mask partition (IAV_PART_MASK) with another module parameter "max_vin_width". Meanwhile, it decides the maximum height of pyramid, warp, raw, EFM, and image scale </td></tr>
<tr>
<td>mc_mask_buf_pitch </td><td>Specifies the multi-color mask buffer pitch, and should be aligned to 64. Determine the size of multi-color privacy mask partition (IAV_PART_MULTI_COLOR_MASK) and memory layout with another module parameter "mc_mask_buf_height" </td></tr>
<tr>
<td>mc_mask_buf_height </td><td>Specifies the multi-color mask buffer height. Determine the size of multi-color privacy mask partition (IAV_PART_MULTI_COLOR_MASK) and memory layout with another module parameter "mc_mask_buf_pitch" </td></tr>
<tr>
<td>extra_raw_buf_size </td><td>Specifies the size of the extra raw partition IAV_PART_EXTRA_RAW </td></tr>
<tr>
<td>tfc_buf_size </td><td>Specifies the size of the thermal fusion CLUT partition IAV_PART_TFC </td></tr>
<tr>
<td>prealloc_buf_map </td><td>Specifies the bit map (BANK0) of the IAV / DSP sub-partitions that are allocated from the pre-allocated MMB. For bit definition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0</a> </td></tr>
<tr>
<td>prealloc_buf_map1 </td><td>Specifies the bit map (BANK1) of the IAV / DSP sub-partitions that are allocated from the pre-allocated MMB. For bit definition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0</a> </td></tr>
<tr>
<td>cached_buf_map </td><td>Specifies the bit map (BANK0) of IAV / DSP sub-partitions that are mapped with cache enabled from user applications. For bit definition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0</a> </td></tr>
<tr>
<td>cached_buf_map1 </td><td>Specifies the bit map (BANK1) of IAV / DSP sub-partitions that are mapped with cache enabled from user applications. For bit definition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0</a> </td></tr>
<tr>
<td>ama_enable </td><td>Enables private memory allocator AMA to manage IAV / DSP related CMA memory. By default, AMA is disabled </td></tr>
<tr>
<td>ama_alignment </td><td>Specifies the maximum alignment of the start address of the memory partitions allocated by AMA. It is only valid when <b> ama_enable = 1 </b>. For example, when it is 8, it means if the allocated memory partition size &gt;= 1 MB, the allocated memory partition start address will be aligned to 1MB (4KB * 1 &lt;&lt; 8). When the allocated memory partition size is &lt; 1MB, the allocated memory partition start address will be aligned to 2^round_up(log2(size)). The valid range for this parameter is [4, 12]. The default is 8 </td></tr>
<tr>
<td>ama_crc_enable </td><td>Enables cyclic redundancy check (CRC) check for AMA internal bitmap. It is only valid when <b>ama_enable = 1</b>. By default, it is disabled </td></tr>
</table>
</dd></dl>
<hr  />
<h2><a class="anchor" id="sec_dump_mmb_info"></a>
3.7 Dump MMB Information</h2>
<p >After the Linux system boots, users can dump the MMB information, including the physical start address, size, kernel space virtual address, user mode reference count through the memory map, the corresponding IAV / DSP sub-partition, and other MMB parameters.</p>
<p >Users can also dump the user application information that allocates or memory maps anonymous MMBs, including user application process ID and name, user mode reference count through the memory map, and other select forms of user application information.</p>
<p >In the following CV5 Timn board example for dumping the MMB information, the information is shown in the ascending order of the physical address. The MMB4 and MMB6, which have the symbol "|-" before their MMB IDs, are located in the pre-allocated MMBs. The total size of all MMBs is provided at the end of the dumped information. In this example, private MMBs used about 2575 MB, shared MMBs used about 4 MB, and the total used MMB are 2579 MB.</p>
<h3><a class="anchor" id="cmd_example_1"></a>
Example 1. Dumping the MMB information of a CV5 Timn board.</h3>
<div class="fragment"><div class="line"><span class="preprocessor"># cat /proc/ambarella/cma</span></div>
<div class="line">CV5x Ambarella CMA Driver : 2.0.0 (Last updated: 20221020)</div>
<div class="line"> </div>
<div class="line"> DSP PRIVATE MEM REGION:</div>
<div class="line">mmb   phys[start-end]          size        virt[start-end]                        attr    buf_id      ref_cnt  dma_buf  usage</div>
<div class="line">0     0x100000000-0x100404000  0x00404000  0xffffffc040000000-0xffffffc040404000  0x0003  21          0        0        IAV_PART_PREALLOC</div>
<div class="line">|-4   0x100000000-0x100004000  0x00004000  0xffffffc040000000-0xffffffc040004000  0x0003  15          0        0        IAV_PART_DSP_DEF_CMD</div>
<div class="line">|-6   0x100004000-0x100404000  0x00400000  0xffffffc040004000-0xffffffc040404000  0x0001  17          0        0        IAV_PART_DSP_LOG</div>
<div class="line">11    0x100404000-0x100406000  0x00002000  0xffffffc040404000-0xffffffc040406000  0x0000  7           0        0        IAV_PART_QUANT</div>
<div class="line">1     0x100500000-0x1025A6000  0x020A6000  0xffffffc040500000-0xffffffc0425a6000  0x0003  22          0        0        IAV_PART_PREALLOC2</div>
<div class="line">|-2   0x100500000-0x1005BD000  0x000BD000  0xffffffc040500000-0xffffffc0405bd000  0x0003  19          0        0        IAV_PART_DSP_RSV</div>
<div class="line">|-5   0x1005BD000-0x100FBD000  0x00A00000  0xffffffc0405bd000-0xffffffc040fbd000  0x0001  16          0        0        IAV_PART_DSP_UCODE</div>
<div class="line">|-12  0x100FBD000-0x1024BD000  0x01500000  0xffffffc040fbd000-0xffffffc0424bd000  0x0001  8           0        0        IAV_PART_IMG</div>
<div class="line">|-14  0x1024BD000-0x1024C1000  0x00004000  0xffffffc0424bd000-0xffffffc0424c1000  0x0003  14          0        0        IAV_PART_BSH</div>
<div class="line">|-15  0x1024C1000-0x1025A6000  0x000E5000  0xffffffc0424c1000-0xffffffc0425a6000  0x0003  20          0        0        IAV_PART_IAV_RSV</div>
<div class="line">3     0x102600000-0x192600000  0x90000000  0xffffffc042600000-0xffffffc0d2600000  0x0005  0           0        0        IAV_PART_DSP</div>
<div class="line">7     0x192600000-0x194600000  0x02000000  0xffffffc0d2600000-0xffffffc0d4600000  0x0008  1           0        0        IAV_PART_BSB</div>
<div class="line">8     0x194600000-0x195614000  0x01014000  0xffffffc0d4600000-0xffffffc0d5614000  0x0008  4           0        0        IAV_PART_OVERLAY</div>
<div class="line">9     0x195700000-0x196100000  0x00A00000  0xffffffc0d5700000-0xffffffc0d6100000  0x0008  5           0        0        IAV_PART_QPMATRIX</div>
<div class="line">10    0x196100000-0x1970C0000  0x00FC0000  0xffffffc0d6100000-0xffffffc0d70c0000  0x0008  6           0        0        IAV_PART_WARP</div>
<div class="line">13    0x197100000-0x1A1100000  0x0A000000  0xffffffc0d7100000-0xffffffc0e1100000  0x0008  9           0        0        IAV_PART_MASK</div>
<div class="line"> </div>
<div class="line">Total mmb size: 0xa0e80000, about 2575<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, total 2816<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
<div class="line"> </div>
<div class="line"> DSP SHARED MEM REGION:</div>
<div class="line">mmb   phys[start-end]          size        virt[start-end]                        attr    buf_id      ref_cnt  dma_buf  usage</div>
<div class="line">0     0x0FF000000-0x0FF152000  0x00152000  0xffffffc012000000-0xffffffc012152000  0x0044  35          0        0        IAV_PART_VOUT0_FB</div>
<div class="line">1     0x0FF200000-0x0FF352000  0x00152000  0xffffffc012200000-0xffffffc012352000  0x0044  36          0        0        IAV_PART_VOUT1_FB</div>
<div class="line">2     0x0FF400000-0x0FF552000  0x00152000  0xffffffc012400000-0xffffffc012552000  0x0044  37          0        0        IAV_PART_VOUT2_FB</div>
<div class="line"> </div>
<div class="line">Total mmb size: 0x3f6000, about 4<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, total 16<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
</div><!-- fragment --><dl class="section user"><dt>MMB Information</dt><dd><a class="anchor" id="illustration_of_mm_info"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Parameters </th><th>Description </th></tr>
<tr>
<td>mmb </td><td>MMB ID for internal reference </td></tr>
<tr>
<td>phys[start-end] </td><td>Physical address illustrated from beginning to end </td></tr>
<tr>
<td>size </td><td>MMB size </td></tr>
<tr>
<td>virt[start-end] </td><td>Kernel space virtual address illustrated from beginning to end </td></tr>
<tr>
<td>attr </td><td>MMB attributes, for bit definition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_mmb_attribute">MMB attributes</a> </td></tr>
<tr>
<td>buf_id </td><td>IAV / DSP / sub-partition ID and ANONYMOUS_MMB ID, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0,</a> <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank1">IAV / DSP Sub-partitions bank1.</a> </td></tr>
<tr>
<td>ref_cnt </td><td>Reference count by user applications through mmap </td></tr>
<tr>
<td>usage </td><td>Corresponding sub-partition name </td></tr>
<tr>
<td>pid </td><td>The process ID of user application which allocates or maps anonymous MMB </td></tr>
<tr>
<td>user_name </td><td>The user name of user application which allocates or maps anonymous MMB </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>IAV / DSP Sub-partitions bank0</dt><dd><a class="anchor" id="illustration_bank0"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Enumeration </th><th>Description </th></tr>
<tr>
<td>IAV_PART_DSP = 0 </td><td>DSP partition </td></tr>
<tr>
<td>IAV_PART_BSB = 1 </td><td>Bitstream partition </td></tr>
<tr>
<td>IAV_PART_USR = 2 </td><td>User data partition </td></tr>
<tr>
<td>IAV_PART_MV = 3 </td><td>Motion vector partition </td></tr>
<tr>
<td>IAV_PART_OVERLAY = 4 </td><td>Overlay partition </td></tr>
<tr>
<td>IAV_PART_QPMATRIX = 5 </td><td>QP ROI matrix partition </td></tr>
<tr>
<td>IAV_PART_WARP = 6 </td><td>Warp partition </td></tr>
<tr>
<td>IAV_PART_QUANT = 7 </td><td>JPEG quant matrix table partition </td></tr>
<tr>
<td>IAV_PART_IMG = 8 </td><td>IDSP image partition </td></tr>
<tr>
<td>IAV_PART_MASK = 9 </td><td>MASK partition </td></tr>
<tr>
<td>IAV_PART_FB_DATA = 10 </td><td>Fastboot data partition </td></tr>
<tr>
<td>IAV_PART_FB_AUDIO = 11 </td><td>Fastboot audio partition </td></tr>
<tr>
<td>IAV_PART_INTRA_PB = 12 </td><td>Intra playback partition </td></tr>
<tr>
<td>IAV_PART_STAT = 13 </td><td>Picture statistics partition </td></tr>
<tr>
<td>IAV_PART_BSH = 14 </td><td>Bitstream header buffer for internal use </td></tr>
<tr>
<td>IAV_PART_DSP_DEF_CMD = 15 </td><td>DSP default command buffer for internal use </td></tr>
<tr>
<td>IAV_PART_DSP_UCODE = 16 </td><td>Ucode partition </td></tr>
<tr>
<td>IAV_PART_DSP_LOG = 17 </td><td>DSP log buffer for internal use </td></tr>
<tr>
<td>IAV_PART_DSP_FIFO = 18 </td><td>DSP FIFO buffer for internal use </td></tr>
<tr>
<td>IAV_PART_DSP_RSV = 19 </td><td>DSP driver reserved partition for internal use </td></tr>
<tr>
<td>IAV_PART_IAV_RSV = 20 </td><td>IAV driver reserved partition for internal use </td></tr>
<tr>
<td>IAV_PART_PREALLOC = 21 </td><td>Pre-allocated CMA partition for internal use </td></tr>
<tr>
<td>IAV_PART_PREALLOC2 = 22 </td><td>Pre-allocated CMA partition2 for internal use </td></tr>
<tr>
<td>IAV_PART_PYRAMID_POOL = 23 </td><td>Pyramid buffer pool for pyramid manual-feed mode </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW = 24 </td><td>QPMATRIX_RAW buffer </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL = 25 </td><td>Canvas buffer pool for manual-feed mode </td></tr>
<tr>
<td>IAV_PART_INT_BSB = 26 </td><td>Internal use bitstream partition </td></tr>
<tr>
<td>IAV_PART_EXTRA_RAW = 27 </td><td>Extra raw partition </td></tr>
<tr>
<td>IAV_PART_RAW_POOL = 28 </td><td>Raw buffer pool for the raw manual-feed mode </td></tr>
<tr>
<td>IAV_PART_HEVC_SCALELIST = 29 </td><td>HEVC scale list partition </td></tr>
<tr>
<td>IAV_PART_BLUR = 30 </td><td>Blur partition </td></tr>
<tr>
<td>IAV_PART_ARB_BLUR = 31 </td><td>Customized blur partition </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>IAV / DSP Sub-partitions bank1</dt><dd><a class="anchor" id="illustration_bank1"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Enumeration </th><th>Description </th></tr>
<tr>
<td>IAV_PART_BLEND_ALPHA = 32 </td><td>Blend Alpha partition </td></tr>
<tr>
<td>IAV_PART_MULTI_COLOR_MASK = 33 </td><td>Multi-color mask partition </td></tr>
<tr>
<td>IAV_PART_TFC = 34 </td><td>TML fusion color lookup table (CLUT) partition </td></tr>
<tr>
<td>IAV_PART_VOUT0_FB = 35 </td><td>VOUT frame buffer partition </td></tr>
<tr>
<td>IAV_PART_VOUT1_FB = 36 </td><td>VOUT frame buffer partition </td></tr>
<tr>
<td>IAV_PART_VOUT2_FB = 37 </td><td>VOUT frame buffer partition </td></tr>
<tr>
<td>IAV_PART_AISP = 38 </td><td>Ambarella AISP partition </td></tr>
<tr>
<td>IAV_PART_DEC_BSB = 39 </td><td>Decoder BSB buffer partition </td></tr>
<tr>
<td>IAV_PART_DSP_CV = 40 </td><td>DSP CV shared buffer partition </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>Illustration of MMB Attributes</dt><dd><a class="anchor" id="illustration_mmb_attribute"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Enumeration </th><th>Description </th></tr>
<tr>
<td>Bit0 </td><td>1: Cannot be freed once allocated <br  />
 0: Can be freed </td></tr>
<tr>
<td>Bit1 </td><td>1: Cannot be mapped and accessed from user applications <br  />
 0: Can be mapped and accessed from user applications </td></tr>
<tr>
<td>Bit2 </td><td>1: Cannot be put to IAV_PART_PREALLOC <br  />
 0: Can be put to IAV_PART_PREALLOC </td></tr>
<tr>
<td>Bit3 </td><td>1: Cache enabled when mapped from user mode <br  />
 0: Cache disabled when mapped from user mode </td></tr>
</table>
</dd></dl>
<hr  />
<h2><a class="anchor" id="sec_private_mem_allocator"></a>
3.8 Private Memory Allocator AMA</h2>
<p >When using the CMA memory management method, the CMA driver is based on the Linux CMA to allocate physically contiguous memory for the IAV / DSP partitions. However, the Linux CMA includes an out of memory (OOM), which can be triggered when the Linux system tries to "borrow" memory from the free memory of the CMA pool. For the detailed root cause of OOM, refer to Chapter <a class="el" href="../../d8/d84/page_drv_cma_doc.html#cma_faq">5.FAQ</a>. When OOM is triggered, it typcially becomes a serious problem as OOM might kill key user applications that have been run by the user.</p>
<p >In order to deal with OOM problems, the CMA driver introduces AMA, which is its own private memory allocator. Once the AMA is enabled, it is responsible for allocating and freeing the IAV / DSP memory partitions instead of using the Linux CMA. Additionally, it prevents the above OOM issue by not allowing the Linux system to "borrow" memory from its free / unused memory. AMA achieves this by requesting all available memory from the IAV / DSP CMA pool at the driver initializing stage and managing this memory pool by itself.</p>
<h3><a class="anchor" id="sub_sec_ama"></a>
3.8.1 Enable AMA</h3>
<p >The CMA driver provides several module parameters for users to configure AMA.</p>
<p >Module parameter <b>ama_enable</b> is used to enable / disable AMA. It is disabled by default, meaning that Linux CMA will be used to allocate or free IAV / DSP memory partitions. When it is enabled, AMA will replace Linux CMA to allocate or free these memory partitions.</p>
<p >Module parameter <b>ama_alignment</b> is used to specify the maximum alignment of the start address of memory partitions allocated by AMA. It is only valid when <b>ama_enable = 1</b>. For example, when it is equal to eight, it means if the allocated memory partition size is ±1MB, the allocated memory partition start address will be aligned to 1MB (4KB * (1 &lt;&lt; 8)). When the allocated memory partition size &lt; 1MB, the allocated memory partition start address will be aligned to 2^round_up(log2(size)). The valid range of this parameter is [4, 12]; the default is 8.</p>
<h3><a class="anchor" id="cmd_example_2"></a>
Example 2. Enabling AMA through the module parameter "ama_enable" of Ambarella CMA driver.</h3>
<div class="fragment"><div class="line">board # modprobe ambcma ama_enable=1 ama_alignment=8</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="cma_example"></a>
4. Examples</h1>
<p >This chapter includes the following sections: </p><ul>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#specify_sub_partion_size">4.1 Specifying the IAV / DSP Sub-partition Size</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#specify_pre_allocate_mmbs">4.2 Specifying the Pre-allocated MMBs</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#specify_cache_mmbs">4.3 Specifying Cached MMBs</a> </li>
<li>
Section <a class="el" href="../../d8/d84/page_drv_cma_doc.html#mange_memory_partition">4.4 Allocating/Freeing Anonymous Memory Partitions</a> </li>
</ul>
<h2><a class="anchor" id="specify_sub_partion_size"></a>
4.1 Specifying the IAV / DSP Sub-partition Size</h2>
<p >The following lists three stages for specifying the size of each IAV / DSP sub-partition for different use cases:</p><ul>
<li>Compile stage<ul>
<li>Configures the partition size through menuconfig then compiles it into the image</li>
</ul>
</li>
<li>Driver installation stage<ul>
<li>Configures the driver module parameters to load different options for the partition size</li>
</ul>
</li>
<li>Run-time stage<ul>
<li>Configures and resizes partition size through IAV IOCTL on-the-fly when the system is running</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="sub_sec_compile"></a>
4.1.1 Compile Configuration</h3>
<p >For the reserved memory management method, the default size of some IAV / DSP sub-partitions can be configured at the compile stage through make menuconfig. For more details, refer to the <em>Flexible</em> <em>Linux</em> <em>SDK</em> <em>Design</em> <em>Guide</em> <em>-</em> <em>DRAM</em> <em>Optimization</em> document.</p>
<p >Using the user data buffer (IAV_PART_USR) as an example, users can specify its default size through make menuconfig as follows. </p><dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">           (0x04000000) IAV Usr Buffer Size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-video  ---&gt;</div>
<div class="line">      -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header)  ---&gt;</div>
<div class="line">           (0x04000000) IAV Usr Buffer Size</div>
</div><!-- fragment --></dd></dl>
<p>In addition, users can specify the default size of the DSP buffer (IAV_PART_DSP) through make menuconfig, but only for the CMA memory management method (see below). </p><dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">   drv_modules  ---&gt;</div>
<div class="line">      <span class="keyword">private</span>  ---&gt;</div>
<div class="line">         -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)  ---&gt;</div>
<div class="line">           (0x90000000) DSP buffer size</div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-video  ---&gt;</div>
<div class="line">      -*- ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header)  ---&gt;</div>
<div class="line">           (0x90000000) DSP buffer size</div>
</div><!-- fragment --></dd></dl>
<h3><a class="anchor" id="sub_sec_mod_conf"></a>
4.1.2 Module Parameters Configuration</h3>
<p >The size of the IAV / DSP sub-partitions can also be configured through the driver module parameters of the Ambarella CMA driver.</p>
<p >This method provides more flexibility in specifying the DRAM size for different partitions without re-compiling the entire image, thereby allowing users to verify different cases.</p>
<p >The following is an example showing how to specify the sizes of the DSP buffer, the bitstream buffer, and the user data buffer through the module parameters.</p>
<h3><a class="anchor" id="cmd_example_3"></a>
Example 3. Specifying the size of the IAV / DSP sub-partitions through the module parameters of Ambarella CMA driver.</h3>
<div class="fragment"><div class="line">board # modprobe ambcma dsp_buf_size= 0x90000000 bsb_buf_size=0x0A00000 usr_buf_size=0x4000000</div>
</div><!-- fragment --><h3><a class="anchor" id="sub_sec_ioctl"></a>
4.1.3 IOCTL Configuration</h3>
<p >Some of the IAV / DSP sub-partitions (such as the bitstream buffer, user data buffer, overlay buffer, and other sub-partitions) will need to be resized at runtime. In order to meet these requirements, the IAV driver exports two input output control (IOTCL) APIs: <b>IAV_IOC_ALLOC_MEM_PART</b> and <b>IAV_IOC_FREE_MEM_PART</b> to the user applications.</p><ul>
<li><b>IAV_IOC_ALLOC_MEM_PART</b> allocates the IAV / DSP sub-partitions.</li>
<li><b>IAV_IOC_FREE_MEM_PART</b> frees the IAV / DSP sub-partitions.</li>
</ul>
<p >Refer to the unit test, test_mempart, for more detailed instructions.</p>
<p ><b>Implementation:</b></p><ul>
<li>Before resizing an existing IAV / DSP sub-partition, users must first free the sub-partition, and unmap it from all user applications. Also, confirm that no potential applications can access it.</li>
<li>The IAV / DSP sub-partitions that have been put in the pre-allocated MMB cannot be resized.</li>
</ul>
<dl class="section user"><dt>Illustration of the Resizable IAV / DSP Sub-partitions</dt><dd><a class="anchor" id="cam_table_illuatrate_partitions"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Resizable IAV / DSP Sub-partition </th><th>State </th></tr>
<tr>
<td>IAV_PART_BSB </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_USR </td><td>Any </td></tr>
<tr>
<td>IAV_PART_MV </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_OVERLAY </td><td>Idle/Preview </td></tr>
<tr>
<td>IAV_PART_QPMATRIX </td><td>Idle/Preview </td></tr>
<tr>
<td>IAV_PART_QPMATRIX _raw </td><td>Idle/Preview </td></tr>
<tr>
<td>IAV_PART_WARP </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_QUANT </td><td>Idle/Preview </td></tr>
<tr>
<td>IAV_PART_MASK </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_INTRA_PB </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_EXTRA_RAW </td><td>Idle </td></tr>
<tr>
<td>IAV_PART_STAT </td><td>Idle </td></tr>
</table>
</dd></dl>
<p>The following example shows how to resize a bitstream buffer with the unit test test_mempart. </p>
<h3><a class="anchor" id="cmd_example_4"></a>
Example 4. Resizing the bitstream buffer (IAV_PART_BSB) through test_mempart.</h3>
<div class="fragment"><div class="line">board # test_mempart -m 1               <span class="comment">// show current size</span></div>
<div class="line">[BSB 1] Base Address: [0x31600000], Size [   10240 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a1841fd1a462d245d8c73dce55e2f45da">KB</a>]</div>
<div class="line"> </div>
<div class="line">board # test_mempart -m 1 –f                <span class="comment">// free current partition</span></div>
<div class="line">board # test_mempart -m 1</div>
<div class="line">[BSB 1] Base Address: [0x00000000], Size [       0 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a1841fd1a462d245d8c73dce55e2f45da">KB</a>]</div>
<div class="line"> </div>
<div class="line">board # test_mempart -m 1 –s 0x1000000  <span class="comment">// reallocate</span></div>
<div class="line">[BSB 1] has been allocated successfully.</div>
<div class="line">          Base Address: [0x33C00000], Size [   16384 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a1841fd1a462d245d8c73dce55e2f45da">KB</a>]</div>
<div class="ttc" id="aiav__utils_8h_html_a1841fd1a462d245d8c73dce55e2f45da"><div class="ttname"><a href="../../d6/d56/iav__utils_8h.html#a1841fd1a462d245d8c73dce55e2f45da">KB</a></div><div class="ttdeci">#define KB</div><div class="ttdef"><b>Definition:</b> iav_utils.h:37</div></div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="specify_pre_allocate_mmbs"></a>
4.2 Specifying the Pre-allocated MMBs</h2>
<p >This section describes two methods to configure the IAV / DSP sub-partitions as pre-allocated MMBs.</p>
<h3><a class="anchor" id="sub_sec_compile_configuration"></a>
4.2.1 Compile Configuration</h3>
<p >The default bitmap of the IAV / DSP sub-partitions that will be placed into pre-allocated MMBs, along with the sub-bitmap of these partitions, can be configured through "make menuconfig".</p>
<p >For detailed bit definitions of each partition, refer to table <a class="el" href="../../d8/d84/page_drv_cma_doc.html#illustration_bank0">IAV / DSP Sub-partitions bank0.</a> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  [*] Ambarella Linux Configuration -&gt;</div>
<div class="line">    [*] Ambarella Private Drivers Configuration -&gt;</div>
<div class="line">      (0x378101) The <span class="keywordflow">default</span> map of buffers from prealloc MMB</div>
</div><!-- fragment --><h3><a class="anchor" id="sub_sec_conf_mod"></a>
4.2.2 Configuring the Module Parameters</h3>
<p >The bitmap of the IAV / DSP sub-partitions that will be placed into the pre-allocated MMBs can be configured through the module parameter "prealloc_buf_map" in the Ambarella CMA driver.</p>
<p >The following example demonstrates how to specify the bitmap of the IAV / DSP sub-partitions through the module parameters "prealloc_buf_map" and "nofree_prealloc_buf_map".</p>
<h3><a class="anchor" id="cmd_example_5"></a>
Example 5. Specifying the bitmap of the IAV / DSP sub-partitions through the module parameters "prealloc_buf_map" and "nofree_prealloc_buf_map" of the Ambarella CMA driver.</h3>
<div class="fragment"><div class="line">board # modprobe ambcma prealloc_buf_map=0x378101 nofree_prealloc_buf_map=0x328100</div>
</div><!-- fragment --><h2><a class="anchor" id="specify_cache_mmbs"></a>
4.3 Specifying Cached MMBs</h2>
<p >This section describes how to enable the Arm data cache for IAV / DSP sub-partitions mapped from the user mode. The following table lists the IAV / DSP sub-partitions for which the Arm data cache can be enabled.</p>
<dl class="section user"><dt>Illustration of the IAV / DSP Sub-partitions that can Enable the Data Cache</dt><dd><a class="anchor" id="cam_table_partitions_can_enable_cache"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>IAV / DSP Sub-partitions for Caching </th><th>State </th></tr>
<tr>
<td>IAV_PART_BSB </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_DSP </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_USR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MV </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_OVERLAY </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QPMATRIX </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_QPMATRIX_RAW </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_WARP </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MASK </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_BLEND_ALPHA </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_EXTRA_RAW </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_ARB_BLUR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_STAT </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_PYRAMID_POOL </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_CANVAS_POOL </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_INT_BSB </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_RAW_POOL </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_HEVC_SCALELIST </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_BLUR </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_MULTI_COLOR_MASK </td><td>Selective </td></tr>
<tr>
<td>IAV_PART_TFC </td><td>Selective </td></tr>
</table>
</dd></dl>
<h3><a class="anchor" id="sub_sec_conf_mod_para"></a>
4.3.1 Configuring Module Parameters</h3>
<p >The bitmap of the IAV / DSP sub-partitions that can utilize the Arm data cache is configured through the module parameter "cached_buf_map" in the Ambarella CMA driver.</p>
<p >The following example shows how to specify the bitmap of the IAV / DSP sub-partitions through the module parameter "cached_buf_map".</p>
<h3><a class="anchor" id="cmd_Example_6"></a>
Example 6. Specifying the bitmap of the IAV / DSP sub-partitions through the module parameters "cached_buf_map" of the Ambarella CMA driver.</h3>
<div class="fragment"><div class="line">board # modprobe ambcma cached_buf_map=0x7e</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="mange_memory_partition"></a>
4.4 Allocating/Freeing Anonymous Memory Partitions</h2>
<p >Anonymous memory partitions can only be allocated or freed during the run-time stage. The IAV driver exports the IOCTL API <b>IAV_IOC_ALLOC_ANON_MEM_PART</b> to user applications in order to allocate anonymous memory partitions. Alternatively, the API <b>IAV_IOC_ALLOC_MEM_PART</b> is exported to allocate the IAV / DSP sub-partitions. To free anonymous memory partitions, applications can use the API <b>IAV_IOC_FREE_MEM_PART</b>.</p>
<dl class="section note"><dt>Note</dt><dd><b>IAV_IOC_ALLOC_ANON_MEM_PART</b> should only be used for allocating anonymous memory partitions. For detailed usage, refer to the unit test: test_mempart.</dd></dl>
<h3><a class="anchor" id="cmd_example_7"></a>
Example 7. Allocating or freeing the anonymous memory partition through test_mempart.</h3>
<div class="fragment"><div class="line">board # test_mempart -a -s 0x1000000 -c</div>
<div class="line">anonymous mem_part[4517] has been allocated successfully.</div>
<div class="line">    Base Address: [0x43700000], Size [   16384 <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a1841fd1a462d245d8c73dce55e2f45da">KB</a>].</div>
<div class="line"><span class="comment">// 4517 is the memory partition ID of allocated memory partition</span></div>
<div class="line"><span class="comment">// -c: enable ARM data cache for anonymous MMB</span></div>
<div class="line"> </div>
<div class="line">board # test_mempart -m 4517 -f         <span class="comment">// free this partition</span></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="cma_faq"></a>
5. FAQ</h1>
<p ><b>Question 1</b>: If the system fails to allocate the physically contiguous memory through <b>IAV_IOC_ALLOC_ANON_MEM_PART</b> due to an insufficient CMA pool size, what should the user do?</p>
<p ><b>Example: IAV_IOC_ALLOC_ANON_MEM_PART</b>: bad address </p><div class="fragment"><div class="line">[  462.309301] #<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a54a1e0fb8065b28e9621c311d3e18b06">iav_error</a># cma_alloc(226): dma_alloc_writecombine error[0x00FD2000], no memory</div>
<div class="line">[  462.309310] #<a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#a54a1e0fb8065b28e9621c311d3e18b06">iav_error</a># iav_ioc_s_alloc_anon_mem_part (1400): fail to allocated anonymous part.</div>
<div class="ttc" id="aiav__utils_8h_html_a54a1e0fb8065b28e9621c311d3e18b06"><div class="ttname"><a href="../../d6/d56/iav__utils_8h.html#a54a1e0fb8065b28e9621c311d3e18b06">iav_error</a></div><div class="ttdeci">#define iav_error(str, arg...)</div><div class="ttdef"><b>Definition:</b> iav_utils.h:327</div></div>
</div><!-- fragment --><p ><b>Cause</b>: On the CV5x / CV7x platforms, the physically contiguous memory is allocated from the CMA pool through <b>IAV_IOC_ALLOC_ANON_MEM_PART</b>. When the CMA pool cannot meet the demand for allocating a large number of contiguous memory blocks, the CMA pool size must be enlarged.</p>
<p ><b>Solution:</b> Enlarge the size of the CMA pool for the IAV and DSP partitions through menuconfig. </p><dl class="section user"><dt>For Cooper Amba build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     -*- board (boards)  ---&gt;</div>
<div class="line">    Memory  ---&gt;</div>
<div class="line">        (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
</div><!-- fragment --> </dd></dl>
<dl class="section user"><dt>For Cooper Yocto build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">     meta-ambabsp ---&gt;</div>
<div class="line">    recipes-bsp ---&gt;</div>
<div class="line">      -*- board (meta-ambabsp/recipes-bsp/board)  ---&gt;</div>
<div class="line">          Memory  ---&gt;</div>
<div class="line">             (2816) DSP Private Memory size in <a class="code hl_define" href="../../d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div>
</div><!-- fragment --></dd></dl>
<p>Check the kernel log during system boot up to verify that the modification is functioning correctly. The following message example is from CV5x. </p><div class="fragment"><div class="line">[    0.000000] Booting Linux on physical CPU 0x0000000000 [0x414fd0b1]</div>
<div class="line">[    0.000000] Linux version 5.15.93 (mwen@shbuild3) (aarch64-linux-gnu-gcc (GCC) 12.1.1 20220803 [ revision 3df2f035871e913b94a35d4b5c12d37828f313f7], GNU ld (Binutils-2.38-20220721) 2.38.20220708) #3 SMP PREEMPT Wed Sep 22 10:30:59 CST 2021</div>
<div class="line">[    0.000000] Machine model: Ambarella CV5 TIMN Board</div>
<div class="line">[    0.000000] Reserved memory: created CMA memory pool at 0x000000002c000000, size 64 MiB</div>
<div class="line">[    0.000000] OF: reserved mem: initialized node linux,cma, compatible <span class="keywordtype">id</span> shared-dma-pool</div>
<div class="line">[    0.000000] Reserved memory: created CMA memory pool at 0x0000000030000000, size 512 MiB</div>
<div class="line">[    0.000000] OF: reserved mem: initialized node cavalry@0, compatible <span class="keywordtype">id</span> shared-dma-pool</div>
<div class="line">[    0.000000] Reserved memory: created DMA memory pool at 0x0000000100000000, size 2816 MiB</div>
<div class="line">[    0.000000] OF: reserved mem: initialized node iav@0, compatible <span class="keywordtype">id</span> shared-dma-pool</div>
</div><!-- fragment --><p ><b>Question 2</b>: The CMA partition includes unused memory. However, when the Linux system attempts to reuse this memory, an OOM-killer results. Why does this happen?</p>
<p ><b>Cause</b>: Although the Linux system can reuse the free memory in the CMA partition to obtain a higher DRAM-use ratio, there are conditions. For example, CMA memory used by the Linux system must be (migratable) when the Linux kernel attempts to allocate physically contiguous memory blocks (but the remaining size is not sufficient).</p>
<p >The following lists information about the Linux system’s use of the free memory in the CMA pool:</p><ul>
<li>Not all Linux system memory is migratable. User-space allocated memory and file system cache memory are migratable, while Linux-kernel allocated memory and page table memory are not.</li>
<li>Migrated memory is returned to the Linux partition. However, when the Linux system attempts to allocate memory from the CMA partition, its memory has now been depleted, and finding additional memory to save the migrated data may not be possible.</li>
</ul>
<p >Based on its design, the Linux "Buddy System" (system memory allocator) prefers to allocate system memory directly from the Linux partition instead of the CMA partition. Once all memory from the Linux partition is allocated, the Linux system "borrows"from the CMA partition. However, when there is a request to allocate the system memory that cannot be migrated or swapped from the CMA partition, the system must allocate from the Linux partition—which no longer has the necessary remaining memory. As a result, an OOM-killer is triggered to reclaim more system memory.</p>
<p ><b>Solution</b>: Although an ideal solution does not currently exist, a possible solution is as follows:</p>
<p >Specify the size of the CMA partition according to real user requirements, and allocate a portion of the available memory resources to the Linux partition.</p>
<hr  />
<h1><a class="anchor" id="cma_license"></a>
6. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p>
<p >This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p >You should have received a copy of the GNU General Public License along with this program; if not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
