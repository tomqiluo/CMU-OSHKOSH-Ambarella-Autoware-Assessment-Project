<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Driver: Cavalry V3 (CV72) Driver API</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Driver"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Driver<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d4/d86/page_drv_cavalry_doc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Cavalry V3 (CV72) Driver API </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cavalry_history"></a>
0. Revision History</h1>
<a class="anchor" id="drv_cavalry_rev_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Updated Date </th><th align="left">Modification </th></tr>
<tr>
<td>20230424 </td><td>Initial Version for CV72 </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="cavalry_intro"></a>
1. Introduction</h1>
<p >The Cavalry device driver for the CV7x vector processor (VP) includes a set of Linux device drivers that encapsulate the lower-level complexities of the CV7x's VP functionalities. The drivers conform to the standard Linux driver model, exposing a series of APIs that can be invoked by IOCTL() system calls. These APIs are used by applications to configure and control the CV7x's VP in detail. Prototypes for the APIs and structures can be found in <a class="el" href="../../d3/dbc/cavalry__ioctl_8h.html" title="This file defines cavalry driver ioctl api.">cavalry_ioctl.h</a> in each SDK package. However, if there are any conflicts between the header files and this document, refer to the source code.</p>
<hr  />
<h1><a class="anchor" id="cavalry_usage"></a>
2. Cavalry Usage</h1>
<p >Follow these commands to build the Cavalry driver and Cavalry related unit test: </p><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Linux Configuration  ---&gt;</div>
<div class="line">             [*]   Build Ambarella nerual network control library  ---&gt;</div>
<div class="line">                [*]   Build Ambarella Cavalry Driver</div>
<div class="line"> </div>
<div class="line">         [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">             [*]     Ambarella Private Linux Unit test configs  ---&gt;</div>
<div class="line">                [*]   Build CV unit tests</div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_usage_load_ucode"></a>
2.1 cavalry_load</h2>
<p >Before running directed acyclic graph (DAGs) on the Cavalry driver, the VP microcode must be properly loaded. To facilitate this task, cavalry_load should be called after the system boots up. The CV7x VP microcode file name is cavalry.bin. The following example assumes that the VP ucode files are located under the directory <code>/lib/firmware</code>. The full path of the VP microcode is an argument of the cavalry_load program. After loading, the ucode version message will display on the standard output. </p><div class="fragment"><div class="line">board # modprobe cavalry</div>
<div class="line">board # ls -l /dev/cavalry</div>
<div class="line">crw-rw-rw-    1 root     root      249,   0 Aug 19 23:28 /dev/cavalry</div>
<div class="line">board # cavalry_load -f /lib/firmware/cavalry.bin</div>
<div class="line">Cavalry Ucode Version = CV72-Ver.126-20230419-ef006a44-hl_fw.00000001</div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_usage_clock"></a>
2.2 cavalry_clock</h2>
<ul>
<li>After system boots up, VP clock is set as the max value according to chip specifications. The following command will use insightface network as reference. <div class="fragment"><div class="line">board # cat /proc/ambarella/clock | grep gclk_nvp</div>
<div class="line">      gclk_nvp:    1008000000 Hz</div>
<div class="line">board # test_nnctrl -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> insightface_cavalry.bin --in data -e</div>
<div class="line">Net_id: 0, Dags: 21 / 21, vp_ticks: 301073, vp_time: 24501 us, arm_time: 24585 us</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --></li>
<li>Users can lower the VP clock to save power when the VP performance is sufficient. cavalry_load enables user to slower down VP clock by providing percentage of maximum value. For Example, slower down VP clock to 50% of maximum value. <div class="fragment"><div class="line">board # cavalry_load --vp-clk 1/2</div>
<div class="line">  Configure VP Clock Percentage: 504/1008</div>
<div class="line">board # cat /proc/ambarella/clock | grep gclk_nvp</div>
<div class="line">      gclk_nvp:    504000000 Hz</div>
<div class="line">board # test_nnctrl -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> insightface_cavalry.bin --in data -e</div>
<div class="line">Net_id: 0, Dags: 21 / 21, vp_ticks: 589749, vp_time: 47993 us, arm_time: 48089 us</div>
</div><!-- fragment --></li>
<li>Recover VP clock to the maximum value. <div class="fragment"><div class="line">board # cavalry_load --vp-clk 1/1</div>
<div class="line">Configure VP Clock Percentage: 1008/1008</div>
<div class="line">board # cat /proc/ambarella/clock | grep gclk_nvp</div>
<div class="line">      gclk_nvp:    1008000000 Hz</div>
</div><!-- fragment --></li>
<li>Stop Cavalry and VP clock will stop all VP resource. <div class="fragment"><div class="line">board # cavalry_load --stop-vp</div>
<div class="line">Configure VP Clock Percentage: 1008/1008</div>
<div class="line">board # cat /proc/ambarella/clock | grep gclk_nvp</div>
<div class="line">      gclk_nvp:    0 Hz</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="cavalry_usage_ucode_log"></a>
2.3 cavalry_log</h2>
<p >If an error occurs, use cavalry_log to debug. It supports a live show log when the ucode is running. Because it generates many messages, it is recommended to run on Telnet console for this command. </p><div class="fragment"><div class="line">board # cavalry_log -u /lib/firmware/cavalry.bin -l -d 4</div>
<div class="line">Cavalry Ucode Version = CV72-Ver.126-20230419-ef006a44-hl_fw.00000001</div>
<div class="line">[T 4 C 0 t 0   :1] Cavalry ucode is started.</div>
<div class="line">[T 4 C 0 t 0   :2] ARM CMD Q Addr 0x00000000|58200000, size 0x8000.</div>
<div class="line">[T 4 C 0 t 0   :3] ARM MSG Q Addr 0x00000000|58208000, size 0x8000.</div>
<div class="line">[T 4 C 0 t 0   :4] IDSP CMD Q Addr 0x00000000|58210000, size 0x8000.</div>
<div class="line">[T 4 C 0 t 0   :5] IDSP MSG Q Addr 0x00000000|58218000, size 0x8000.</div>
<div class="line">[T 4 C 0 t 0   :6] LOG Q Addr 0x00000000|58220000, size 0x20000, Log Level 2.</div>
<div class="line">[T 4 C 0 t 0   :7] PROFILE Q Addr 0x00000000|58240000, size 0x20000.</div>
<div class="line">[T 4 C 0 t 0   :8] STATS INFO Addr 0x00000000|58260000, size 0x20.</div>
<div class="line">[T 4 C 0 t 0   :9] Receive <a class="code hl_typedefRef" target="_blank" href="../../../video/db/dec/b6__cal_8h.html#ae5275e848e7ce7204e4ef11bc4523ced">INT</a> from ARM.</div>
<div class="line">[T 5 C 0 t 1   :10] Processing SET_LOG_LEVEL_CMD.</div>
<div class="line">[T 5 C 0 t 1   :11] Changed log level from [2] to [4].</div>
<div class="ttc" id="ab6__cal_8h_html_ae5275e848e7ce7204e4ef11bc4523ced"><div class="ttname"><a href="../../../video/db/dec/b6__cal_8h.html#ae5275e848e7ce7204e4ef11bc4523ced">INT</a></div><div class="ttdeci">signed int INT</div></div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_usage_top"></a>
2.4 cavalry_top</h2>
<p >Users can use the Cavalry top tool to check the VP usage statistics. It is like tool top in Linux to summary system resource information as well as a list of processes and CPU usage. </p><div class="fragment"><div class="line">board # cavalry_top</div>
<div class="line">-------------</div>
<div class="line">PID    NID    NVP0</div>
<div class="line">527    0     097.1   test_nnctrl -<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> insightface_cavalry.bin --in data --out fc1_scale -e -t 1000</div>
<div class="line">-------------</div>
<div class="line">0: NVP0  IDLE 002.7%</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="cavalry_debug"></a>
3. Cavalry Debug</h1>
<p >The software development kit (SDK) supplies several tools to address problems when the error occurs.</p>
<h2><a class="anchor" id="cavalry_debug_core_dump"></a>
3.1 cavalry_core_dump</h2>
<p ><a class="el" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a> is used to dump cavalry related context into one binary when encountering VP hang, and users can reproduce the VP hang issue by this dumped binary. </p><div class="fragment"><div class="line">1. Kernel dmesg will report the following message when encountering VP hang. After that, users can use</div>
<div class="line">tool to dump binary.</div>
<div class="line"> </div>
<div class="line">kthread_vp_core_dump_monitor(64): VP Seems Hang</div>
<div class="line">board # <a class="code hl_struct" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a> -d /tmp/<a class="code hl_struct" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a>.bin</div>
<div class="line">VP hang detected.</div>
<div class="line">VP Core dump saved.</div>
<div class="line"> </div>
<div class="line">2. Users have to reload cavalry driver after VP hang.</div>
<div class="line">board # rmmod cavalry; modprobe cavalry; cavalry_load -f /lib/firmware/cavalry.bin</div>
<div class="line"> </div>
<div class="line">3. Reproduce VP hang by dumped bianry.</div>
<div class="line">board # <a class="code hl_struct" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a> -r /tmp/<a class="code hl_struct" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a>.bin</div>
<div class="line">kthread_vp_core_dump_monitor(64): VP Seems Hang</div>
<div class="ttc" id="astructcavalry__core__dump_html"><div class="ttname"><a href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a></div><div class="ttdef"><b>Definition:</b> cavalry_ioctl.h:948</div></div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_debug_vpstatus"></a>
3.2 vpstatus</h2>
<p >vpstatus is used to dump VP register releated context into an binary when encountering a VP hang. Follow these commands to build the vpstatus tool. </p><div class="fragment"><div class="line">build # make menuconfig</div>
<div class="line">         [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">             [*]     Ambarella Private Linux Unit test configs  ---&gt;</div>
<div class="line">                [*]   Build CV unit tests   ---&gt;</div>
<div class="line">                   [*]   Build VPUtils unit tests</div>
</div><!-- fragment --><p >Same as <a class="el" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a>, users can dump one binary when encountering a VP hang.</p>
<dl class="section note"><dt>Note</dt><dd>Only execute vpstatus dump binary once, the second command is invalid after dumped already.</dd></dl>
<div class="fragment"><div class="line">board # vpstatus -d /tmp/vpstatus_dump.bin</div>
<div class="line">cycles = 0xffffffff</div>
<div class="line">VP hang detected!</div>
</div><!-- fragment --><h2><a class="anchor" id="cavalry_debug_monitor"></a>
3.3 cavalry_monitor</h2>
<p >cavalry_monitor tool can receive error event that Cavalry driver reported, and use <a class="el" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a> and vpstatus tools to dump the corresponding binary automatically. So it is easy for user to dump the information without to execute <a class="el" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a> and vpstatus by manually.</p>
<p >Users can send these two binaries (such as "cavalry_core_dump.bin" and "vpstatus_dump.bin" in the following command) to the Ambarella support team for assistance. </p><div class="fragment"><div class="line">board # cavalry_monitor -c /tmp/<a class="code hl_struct" href="../../dc/d97/structcavalry__core__dump.html">cavalry_core_dump</a>.bin -v /tmp/vpstatus_dump.bin</div>
<div class="line">No INFO MSG</div>
<div class="line">No ERR MSG</div>
<div class="line">Polled ERR</div>
<div class="line">[2020-08-20 22:31:59 185.158] Receive ERR: VP_Hang, at func: kthread_vp_core_dump_monitor:(127)</div>
<div class="line">VP hang detected.</div>
<div class="line">VP Core dump saved.</div>
<div class="line">cycles = 0xffffffff</div>
<div class="line">VP hang detected!</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="sec_cavalry_api"></a>
4. Cavalry API</h1>
<p >Visit the following link to see details of the API functions</p><ul>
<li><a class="el" href="../../d9/d15/group__cavalry-ioctl-api.html">Cavalry IOCTL API details</a> shows API lists</li>
<li><a class="el" href="../../d6/d9f/group__cavalry-ioctl-helper.html">Cavalry IOCTL Helper</a> shows related macros enumerations and structures</li>
</ul>
<hr  />
<h1><a class="anchor" id="cavalry_license"></a>
5. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p>
<p >This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p >You should have received a copy of the GNU General Public License along with this program; if not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
