<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: ADVANCED - Pipeline Latency</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/d27/fs_adv_pl_latency.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">ADVANCED - Pipeline Latency </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="idsp_latency"></a>
1. Image Digital Signal Processing (IDSP) Latency</h1>
<p >This chapter illustrates the IDSP latency of different video input (VIN) mode cases, which are measured under the following two circumstances.</p>
<h2><a class="anchor" id="idsp_latency_live"></a>
1.1 Latency between VIN Capture Complete and IDSP YUV Output</h2>
<p >The table below records the latency between when VIN capture is completed and the IDSP YUV is output under different VIN modes. It is measured with sensor input. </p><dl class="section note"><dt>Note</dt><dd><ul>
<li>The latency here does not include the latency between the sensor beginning exposure and the frame being captured completed by VIN.</li>
<li>"low_delay_vin_vout" can be supported in only encode mode 0.</li>
</ul>
</dd></dl>
<table class="doxtable">
<caption>VIN Capture Done to IDSP YUV Output Latency (CV5s88)</caption>
<tr>
<th rowspan="2">NO.</th><th rowspan="2">Encode Mode</th><th colspan="2">VIN: 1080p60</th><th colspan="2">VIN: 4kp30 </th><th colspan="2">VIN: 4Kp60</th></tr>
<tr>
<th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames)</th><th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames)</th><th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th></tr>
<tr>
<td>1</td><td>0</td><td>10.48</td><td>0.63</td><td>19.56</td><td>0.59</td><td>19.81</td><td>1.19 </td></tr>
</table>
<h2><a class="anchor" id="idsp_latency_raw"></a>
1.2 Latency Between Feeding Raw Images and IDSP YUV Output</h2>
<p >The table below records the latency between feeding a raw image and the IDSP YUV output. It is measured with encode from raw (EFR).</p>
<table class="doxtable">
<caption>Feed Raw Data to IDSP YUV Output Latency</caption>
<tr>
<th>NO.</th><th>Encode Mode</th><th>VIN<br  />
(ms)</th><th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th></tr>
<tr>
<td>0</td><td>0</td><td>4Kp30</td><td>15.6</td><td>0.46 </td></tr>
</table>
<h2><a class="anchor" id="capture_display_latency"></a>
1.3 Latency Between VIN Capture and VOUT Display</h2>
<p >To increase the latency reliability between VIN capture and VOUT display, use a high refresh-rate LCD screen as an input.</p>
<p >The table below records the latency between VIN capture and VOUT display under different VIN modes.</p>
<table class="doxtable">
<caption>VIN Capture to VOUT Display Latency</caption>
<tr>
<th rowspan="2">NO.</th><th rowspan="2">Encode Mode</th><th colspan="2">1080p60VIN--&gt;1080p60VOUT<br  />
(CV5S88) </th><th colspan="2">4Kp60VIN--&gt;4Kp60VOUT<br  />
(CV5S88)</th></tr>
<tr>
<th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th><th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th></tr>
<tr>
<td>1</td><td>0</td><td>62</td><td>3.72</td><td>77</td><td>4.62 </td></tr>
</table>
<p >The measurement method is shown as below. It uses case "NO. 1" as an example. The PC monitor (1080p@144Hz) runs a timer on the left. Its image will be captured and processed by the CV5S88 evaluation kit (EVK) and output to the right monitor through the high-definition multimedia interface (HDMI®) VOUT. If using another camera to take the photo of these two monitors, the latency between VIN capture and VOUT display will be the time difference of the timers in these two monitors of the same photo. </p><div class="image">
<img src="../../CV5_capture_display_latency.jpg" alt=""/>
<div class="caption">
Figure 1-1. Latency Between VIN Capture and VOUT Display.</div></div>
<p >Each test result is as shown below:</p>
<ul>
<li>[Encode Mode 0], 1080P60 VIN &mdash;&gt; 1080p60 VOUT <div class="image">
<img src="../../CV5_1080P60VIN_1080P60VOUT_mode0.jpg" alt=""/>
<div class="caption">
Figure 1-2. Latency Between 1080p60VIN Capture and 1080p60VOUT Display, enc-mode = 0.</div></div>
</li>
<li>[Encode Mode 0] 4KP60 VIN &mdash;&gt; 4KP60 VOUT <div class="image">
<img src="../../CV5_4Kp60VIN_4kP60VOUT_mode0.jpg" alt=""/>
<div class="caption">
Figure 1-3. Latency Between 4KP60VIN Capture and 4KP60VOUT Display, enc-mode = 0.</div></div>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="enc_latency"></a>
2. Encode Latency</h1>
<p >This chapter describes the usage of measuring encode latency.</p>
<p >Users can measure the encode latency via the following command after starting the stream. As shown in the log below, monotonic_pts represents the frame presentation time stamp (PTS) before encoding and enc_done_pts represents the frame PTS after encoding. The difference between enc_done_pts and monotonic_pts is the frame encoding time, which is recorded as enc_pipe_time in units of ticks. As there are 90,000 ticks in one second, users can convert the ticks to normal time with the equation Ticks / 90 = Millisecond. For example, if the enc_pipe_time is 4500, the normal time should be 4500 / 90 = 50 ms.</p>
<dl class="section note"><dt>Note</dt><dd>The latency mentioned here is measured from the time of VIN capture completion to completion of frame encoding. It does not include the latency between the sensor beginning exposure and this frame being captured completed by VIN.</dd></dl>
<div class="fragment"><div class="line">board# test_stream -v --nofile</div>
<div class="line">type=3, is_skipped 0, size=43110, addr=0x31826560, strm_id=0, sesn_id=1615867172, frame_num=1122, monotonic_pts=5840788, mono_diff=3011, enc_done_pts = 5845196, enc_pipe_time = 4408, reso=1920x1080, slice_header_offset = 18</div>
<div class="line">type=3, is_skipped 0, size=3801, addr=0x31869696, strm_id=0, sesn_id=1615867172, frame_num=1123, monotonic_pts=5843799, mono_diff=3011, enc_done_pts = 5850953, enc_pipe_time = 7154, reso=1920x1080, slice_header_offset = 18</div>
<div class="line">type=3, is_skipped 0, size=43380, addr=0x31873536, strm_id=0, sesn_id=1615867172, frame_num=1124, monotonic_pts=5846816, mono_diff=3017, enc_done_pts = 5851223, enc_pipe_time = 4407, reso=1920x1080, slice_header_offset = 18</div>
<div class="line">type=3, is_skipped 0, size=3715, addr=0x31916928, strm_id=0, sesn_id=1615867172, frame_num=1125, monotonic_pts=5849827, mono_diff=3011, enc_done_pts = 5856929, enc_pipe_time = 7102, reso=1920x1080, slice_header_offset = 18</div>
<div class="line">type=3, is_skipped 0, size=42154, addr=0x31920768, strm_id=0, sesn_id=1615867172, frame_num=1126, monotonic_pts=5852793, mono_diff=2966, enc_done_pts = 5857199, enc_pipe_time = 4406, reso=1920x1080, slice_header_offset = 18</div>
</div><!-- fragment --><h2><a class="anchor" id="latency_vin_cap_to_encoding_done"></a>
2.1 Latency Between VIN Capture Completed and Encoding Completed</h2>
<p >The table below records the latency between "VIN capture done" and “Frame encode done“. It is measured with sensor input.</p>
<table class="doxtable">
<caption>Encoding Latency (CV5)</caption>
<tr>
<th rowspan="2">NO.</th><th rowspan="2">Format</th><th rowspan="2">Slice Num</th><th rowspan="2">VDSP Mode</th><th colspan="2">VIN: 4Kp30<br  />
(CV5S88) </th><th colspan="2">VIN: 4Kp60<br  />
(CV5S88)</th></tr>
<tr>
<th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th><th>Latency<br  />
(ms)</th><th>Latency<br  />
(frames) </th></tr>
<tr>
<td>1</td><td>AVC</td><td>2</td><td>Single core</td><td>16.588</td><td>0.498</td><td>16.772</td><td>1.003 </td></tr>
<tr>
<td>2</td><td>AVC</td><td>1</td><td>Dual core(temporal)</td><td>52.122</td><td>1.564</td><td>52.466</td><td>3.165 </td></tr>
<tr>
<td>3</td><td>HEVC</td><td>2</td><td>Single core</td><td>16.561</td><td>0.497</td><td>16.783</td><td>1.007 </td></tr>
<tr>
<td>4</td><td>HEVC</td><td>1</td><td>Dual core(temporal)</td><td>52.088</td><td>1.563</td><td>52.3</td><td>3.13 </td></tr>
<tr>
<td>5</td><td>HEVC</td><td>1</td><td>Dual core(spatial)</td><td>15.755</td><td>0.473</td><td>15.955</td><td>0.957 </td></tr>
</table>
<p><br  />
</p>
<hr  />
<h1><a class="anchor" id="video_info_audit"></a>
3. Video Pipeline Info Audit</h1>
<p >Ambarella integrated the image audio video (IAV) audit tool into the Linux proc file to enable real-time monitoring of video pipeline information. The audit tool currently supports the following: DSP interrupt processing duration, DSP interrupt interval, IDSP latency, encode latency, IDSP frame drop, encode frame drop, vout frame drop, frame sync(osd, overlay and blur), VIN-VOUT synchronization latency, IDSP and encode clock.</p>
<p >Users can use the "echo" function in the shell to pass two arguments, separated by a space " ". The first parameter is the bitmap to enable auditing, and the second parameter is the duration of the audit. </p><div class="fragment"><div class="line">board# echo 0x1f3 3 &gt; /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="ttc" id="astructiav__audit_html"><div class="ttname"><a href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div></div>
</div><!-- fragment --><p >When the parameter is set successfully, users can use "cat" to retrieve the audit results for the next few seconds (determined by the second parameter, in units /s). </p><div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">The current audit print bitmap: 0x1f3</div>
<div class="line">The last audit print bitmap: 0x0</div>
<div class="line">The current audit time interval: 3s</div>
<div class="line"> </div>
<div class="line"> bit[ 0]: enable     isr duration</div>
<div class="line"> bit[ 1]: enable     isr interval</div>
<div class="line"> bit[ 2]: disable    iav ioctl</div>
<div class="line"> bit[ 3]: disable    imgproc ioctl</div>
<div class="line"> bit[ 4]: enable     idsp delay</div>
<div class="line"> bit[ 5]: enable     encode delay</div>
<div class="line"> bit[ 6]: enable     VOUT-VIN delay</div>
<div class="line"> bit[ 7]: enable     IAV IDSP frame drop audit</div>
<div class="line"> bit[ 8]: enable     IAV encode frame drop audit</div>
<div class="line"> bit[ 9]: disable    IAV vout underflow audit</div>
<div class="line"> bit[10]: disable    ENC sync fail audit</div>
<div class="line"> bit[11]: disable    EIS sync fail audit</div>
<div class="line"> bit[12]: disable    Img scaler audit to check IDSP clock</div>
<div class="line"> bit[13]: disable    Encode clock audit</div>
<div class="line"> bit[14]: enable     Frame sync(ovrelay and blur) audit</div>
<div class="line"> </div>
<div class="line">======= Audit video info within 3s ========</div>
<div class="line">         ...(different audit info)</div>
</div><!-- fragment --><h2><a class="anchor" id="isr_latency_aud"></a>
3.1 DSP ISR Latency Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [Audit - ISR Duration Info]</div>
<div class="line"> IRQ_NAME       status     ISR_cnt    ISR_FREQ (Hz)   Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> vdsp           Enable     181        60              0          4          0          4</div>
<div class="line"> venc           Disable    0          0               0          0          0          0</div>
<div class="line"> vcap           Enable     724        241             0          0          0          0</div>
<div class="line"> vin            Enable     90         30              0          0          0          0</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [Audit - ISR Interval Info]</div>
<div class="line"> IRQ_NAME       status     ISR_cnt    Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> vdsp_intvl     Enable     181        16666      16684      16649      35</div>
<div class="line"> venc_intvl     Disable    0          0          0          0          0</div>
<div class="line"> vcap_intvl     Enable     724        4182       29786      28         29758</div>
<div class="line"> vin_intvl      Enable     90         33321      33797      32851      946</div>
</div><!-- fragment --><p >The printout details the four main pieces of DSP interrupt audit information (<b>vdsp</b>, <b>venc</b>, <b>vcap</b>, and <b>vin</b>). "ISR Duration info" shows the processing and scheduling time of each interrupt on the Arm® side, and "ISR Interval Info" shows the interval time information of two adjacent interrupts for each interrupt type.</p>
<h2><a class="anchor" id="idsp_latency_aud"></a>
3.2 IDSP Latency Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [IDSP Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;IDSP YUV output&quot;</span></div>
<div class="line"> Canvas  Src             Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 0       chan0_main      10598      10632      10574      58</div>
<div class="line"> 1       chan0_2nd       10611      10644      10589      55</div>
<div class="line"> 2       chan0_3rd       10607      10640      10585      55</div>
<div class="line"> 3       chan0_4th       10603      10637      10581      56</div>
</div><!-- fragment --><p >The printout details the average latency (<b>Avg</b>), maximum latency (<b>Max</b>), minimum latency (<b>Min</b>), and the difference between the maximum and minimum latency (<b>Delta</b>) over one second for each canvas.</p>
<h2><a class="anchor" id="encode_latency_aud"></a>
3.3 Encode Latency Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [Encode Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;encode done&quot;</span> :</div>
<div class="line"> Stream  Canvas     Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 0       0          35174      51922      18422      33500</div>
<div class="line"> 1       3          36824      57011      19900      37111</div>
<div class="line"> 2       1          37596      57400      20611      36789</div>
</div><!-- fragment --><p >Encode latency statistics are for streams that are in the encoding state. Note that when obtaining encode latency statistics, ensure that the system is in the encoding state; otherwise, there will be no valid statistics. </p><div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [Encode Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;encode done&quot;</span> :</div>
<div class="line"> Dsp has not started encoding!!!</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>In the example, the <b>Delta</b> in <b>Encode Delay Info</b> is very large. The main reason for this phenomenon is that the <b>I-frame</b> in the stream processing time is long, while the <b>P-frame</b> processing time is short, so the difference between the two (<b>Delta</b>) is large.</dd></dl>
<h2><a class="anchor" id="vout_vin_latency_aud"></a>
3.4 VOUT-VIN Latency Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [VOUT-VIN Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;vout display start&quot;</span></div>
<div class="line"> Vout        Canvas     Sync Cnt   Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 2           2          181        36191      44920      27249      17671</div>
</div><!-- fragment --><p >"VOUT-VIN latency info" shows the latency between VIN capture completed and VOUT display, and can also help users to verify if the VIN-VOUT precise sync feature takes effect. See <a class="el" href="../../d2/d61/fs_basic_vin.html#example_vin_vout_precise_sync">VIN-VOUT Precise sync</a>.</p>
<h2><a class="anchor" id="frame_drop_aud"></a>
3.5 IDSP and Encode Frame Drop Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [IDSP Frame Drop Info] :</div>
<div class="line"> Channel  Drop Count      Drop Rate (fps)     IDSP FPS     Status</div>
<div class="line"> 0        5               1.7                 30           Frame Dropped</div>
</div><!-- fragment --><p> "IDSP Frame Drop Info" is used to audit the IDSP frame drop count; "Drop Rate (fps)" and "IDSP FPS" can help users obtain the actual IDSP frame per second (fps) when there is IDSP frame drop. <b>Status</b> reflects the current IDSP state. When <b>Drop Count</b> is greater than 0, it means that the current IDSP is in the frame-dropped state (<b>Frame dropped</b>). Otherwise, it is in the normal (<b>OK</b>) state.</p>
<div class="fragment"><div class="line">=== [IDSP Group Channel Frame Discard Info] :</div>
<div class="line">Group   Channel  Discard Count   Discard Rate (fps)  IDSP FPS     Status</div>
<div class="line">0     0          0               0.0                 30           <a class="code hl_define" href="../../db/dec/b6__cal_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a></div>
<div class="line">0     1          0               0.0                 30           <a class="code hl_define" href="../../db/dec/b6__cal_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a></div>
<div class="ttc" id="ab6__cal_8h_html_aba51915c87d64af47fb1cc59348961c9"><div class="ttname"><a href="../../db/dec/b6__cal_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a></div><div class="ttdeci">#define OK</div><div class="ttdef"><b>Definition:</b> b6_cal.h:39</div></div>
</div><!-- fragment --><p> "IDSP Group Channel Frame Discard Info" is used to audit the raw cuont being discard by IDSP proactively for the cases like the raw is not within the channel grouping tolerance. If frame discard is reported in the audit info, users can use “test_encode &ndash;debug-chan-group-tolerance” to adjust the chan group sync tolerance value to adapt RAW capture done time drift between different sensors within one group.</p>
<div class="fragment"><div class="line">=== [Encode Frame Drop Info] :</div>
<div class="line"> Stream  Canvas     Drop Count</div>
<div class="line"> 0       0          152</div>
<div class="line"> 1       3          185</div>
<div class="line"> 2       1          185</div>
</div><!-- fragment --><p> "Encode Frame Drop Info" is used to audit the encode ( advanced video coding (AVC) / high-efficiency video coding (HEVC) / MJPEG ) frame drop count.</p>
<h2><a class="anchor" id="enc_clk_aud"></a>
3.6 Encode Clock Audit</h2>
<p >Encode clock audit is used to audit the actual encode clock and compare whether the clock is configured correctly.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3  <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)      <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_4k_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_4k_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua) <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -b0 -H3840x2144 -e</div>
<div class="line">board# echo 0x2000 3 &gt; /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">For cv5/cv52:</div>
<div class="line"> === [Encode Clock Info] : gclk_core (khz) : 1140000</div>
<div class="line"> Stream  Avg (khz)  Max (khz)  Min (khz)  Delta (khz)  Clk_Diff</div>
<div class="line"> 0       1137965    1138727    1137114    1613         1 ‰</div>
<div class="line"> </div>
<div class="line">For cv72:</div>
<div class="line"> === [Encode Clock Info] : gclk_vdsp (khz) : 960000</div>
<div class="line"> Stream  Avg (khz)  Max (khz)  Min (khz)  Delta (khz)  Clk_Diff</div>
<div class="line"> 0       955570     957964     953517     4447         4 ‰</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>In order to make audit clock accurate, it only supports run the specific use case of 4K ("3840x2144" is for height alignment) HEVC encode with "N = 1" on stream 0. The error shown by "clk_diff" is reasonable within 1%.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="vout_aud"></a>
3.7 VOUT Drop and Osd Sync Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">=== [VOUT Underflow and Osd Sync Info] :</div>
<div class="line">Vout      Canvas     Vout Drop Cnt     Osd Sync Fail Cnt</div>
<div class="line">2         4          0                 0</div>
</div><!-- fragment --><p> "VOUT Drop and Osd Sync Audit" is use to audit vout frame dorp and osd frame sync fail info. When the vout fps is lower than the canvas fps, vout will not be able to display all frames in time, which will cause vout to drop frames and sync osd to frame fail.</p>
<h2><a class="anchor" id="frame_sync_aud"></a>
3.8 Frame Sync (overaly and blur) Audit</h2>
<div class="fragment"><div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line"> </div>
<div class="line">==== [Audit - Frame Sync Audit to Check Overlay and Blur Sync Info] ====</div>
<div class="line">Type        Fail Count</div>
<div class="line">Overlay  0</div>
<div class="line">Blur        0</div>
</div><!-- fragment --><p> "Frame Sync Audit" is used to audit stream overlay and blur sync fail info. At present, ARM side can only audit the fail count of all streams from DSP and can't distinguish them for each stream.</p>
<h2><a class="anchor" id="example_iav_audit_proc"></a>
Example 1: Full Report of IAV Audit Proc</h2>
<div class="fragment"><div class="line">board# echo 0x43f3 3 &gt; /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line">board#</div>
<div class="line">board# cat /proc/ambarella/<a class="code hl_structRef" href="../../../library/da/d27/structiav__audit.html">iav_audit</a></div>
<div class="line">The current audit print bitmap: 0x1f3</div>
<div class="line">The last audit print bitmap: 0x0</div>
<div class="line">The current audit time interval: 3s</div>
<div class="line"> </div>
<div class="line"> bit[ 0]: enable     isr duration</div>
<div class="line"> bit[ 1]: enable     isr interval</div>
<div class="line"> bit[ 2]: disable    iav ioctl</div>
<div class="line"> bit[ 3]: disable    imgproc ioctl</div>
<div class="line"> bit[ 4]: enable     idsp delay</div>
<div class="line"> bit[ 5]: enable     encode delay</div>
<div class="line"> bit[ 6]: enable     VOUT-VIN delay</div>
<div class="line"> bit[ 7]: enable     IAV IDSP frame drop audit</div>
<div class="line"> bit[ 8]: enable     IAV encode frame drop audit</div>
<div class="line"> bit[ 9]: enable     IAV vout drop and osd sync audit</div>
<div class="line"> bit[10]: disable    ENC sync fail audit</div>
<div class="line"> bit[11]: disable    EIS sync fail audit</div>
<div class="line"> bit[12]: disable    Img scaler audit to check IDSP clock</div>
<div class="line"> bit[13]: disable    Encode clock audit</div>
<div class="line"> bit[14]: enable     Frame sync(ovrelay and blur) audit</div>
<div class="line"> </div>
<div class="line">======= Audit video info within 3s ========</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [Audit - ISR Duration Info]</div>
<div class="line"> IRQ_NAME       status     ISR_cnt    ISR_FREQ (Hz)   Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> vdsp           Enable     181        60              0          2          0          2</div>
<div class="line"> venc           Enable     273        91              0          0          0          0</div>
<div class="line"> vcap           Enable     728        242             0          0          0          0</div>
<div class="line"> vin            Enable     91         30              0          0          0          0</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [Audit - ISR Interval Info]</div>
<div class="line"> IRQ_NAME       status     ISR_cnt    Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> vdsp_intvl     Enable     181        16666      16684      16650      34</div>
<div class="line"> venc_intvl     Enable     273        11143      39491      224        39267</div>
<div class="line"> vcap_intvl     Enable     728        4165       29801      28         29773</div>
<div class="line"> vin_intvl      Enable     91         33327      33814      32851      963</div>
<div class="line"> </div>
<div class="line">=== [IDSP Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;IDSP YUV output&quot;</span></div>
<div class="line"> Canvas  Src             Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 0       chan0_main      10598      10624      10573      51</div>
<div class="line"> 1       chan0_2nd       10612      10637      10589      48</div>
<div class="line"> 2       chan0_3rd       10608      10633      10584      49</div>
<div class="line"> 3       chan0_4th       10604      10629      10580      49</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [Encode Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;encode done&quot;</span> :</div>
<div class="line"> Stream  Canvas     Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 0       0          35187      51933      18555      33378</div>
<div class="line"> 1       3          36899      55466      19911      35555</div>
<div class="line"> 2       1          29011      45600      12411      33189</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [VOUT-VIN Latency Info] : From <span class="stringliteral">&quot;raw capture done&quot;</span> to <span class="stringliteral">&quot;vout display start&quot;</span></div>
<div class="line"> Vout        Canvas     Sync Cnt   Avg (us)   Max (us)   Min (us)   Delta (us)</div>
<div class="line"> 2           2          181        36191      44920      27249      17671</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [IDSP Frame Drop Info] :</div>
<div class="line"> Channel  Drop Count      Drop Rate (fps)     IDSP FPS     Status</div>
<div class="line"> 0        5               1.7                 30           Frame Dropped</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [IDSP Group Channel Frame Discard Info] :</div>
<div class="line">Group   Channel  Discard Count   Discard Rate (fps)  IDSP FPS     Status</div>
<div class="line">There are no group channels!!!</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [Encode Frame Drop Info] :</div>
<div class="line"> Stream  Canvas     Drop Count</div>
<div class="line"> 0       0          0</div>
<div class="line"> 1       3          0</div>
<div class="line"> 2       1          0</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">=== [VOUT Drop and Osd Sync Info] :</div>
<div class="line">Vout      Canvas     Vout Drop Cnt     Osd Sync Fail Cnt</div>
<div class="line">2         4          0                 0</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">==== [Audit - Frame Sync Audit to Check Overlay and Blur Sync Info] ====</div>
<div class="line">Type        Fail Count</div>
<div class="line">Overlay     0</div>
<div class="line">Blur        0</div>
</div><!-- fragment --><h2><a class="anchor" id="example_show_video_audit_info"></a>
Example 2: Application for Video Pipeline Information Audit</h2>
<p >Ambarella has opened the input / output control (IOCTL) interface to implement video pipeline information auditing. The <code>show_video_audit_info</code> application is available for users to easily obtain the same statistics info as the IAV audit proc. </p><div class="fragment"><div class="line">board# show_video_audit_info -t 5 -i -I -d -D -f -F -v</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
