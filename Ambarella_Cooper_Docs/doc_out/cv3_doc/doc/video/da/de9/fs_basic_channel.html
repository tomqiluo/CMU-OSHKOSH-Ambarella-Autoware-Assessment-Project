<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: BASIC - Channel</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('da/de9/fs_basic_channel.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BASIC - Channel </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="channel_features"></a>
1. Channel and IDSP Pipeline</h1>
<p >Channel is the software concept of the image digital signal processing (IDSP) pipeline. For each channel, CV5x chips process the input frames captured from a RGB sensor or YUV device, and generate different YUV buffers for further processing. The supported channels are up to eight.</p>
<p >In the IDSP pipeline, there are two major stages, RAW processing stage and YUV processing stage. In the RAW processing stage, IDSP has high dynamic range (HDR) blending module to blend multiple exposures into a single frame, various filters for noise reduction and color enhancement, and finally color convertion module to convert RGB format to YUV format. In the YUV processing stage, IDSP has filters for color noise reduction and enhancement, the module for warp and scale functions, the motion-compensated temporal filtering (MCTF) module for 3D noise reduction, and the module for final sharpen processing.</p>
<p >For each channel, the RGB or YUV RAW frames will go through the entire IDSP pipeline to generate source buffers. So when there are some features turned off in the IDSP pipeline, the RAW frames still go through the entire pipeline, but the data will pass through some filters or modules without any processing. For example, YUV RAW data will still go through the RAW processing pipeline, but it may pass through these modules inside the RAW processing stage with the data unchanged in this stage.</p>
<div class="image">
<img src="../../idsp_pipeline.jpg" alt=""/>
<div class="caption">
Channel IDSP Pipeline</div></div>
<h2><a class="anchor" id="channel_rotation"></a>
1.1 Channel IDSP Rotation / Flip</h2>
<p >For CV2x chips, there is a dedicated encode mode 3 for IDSP rotation and flip operations. However for CV5x / CV7x chips, the rotation and flip operations can be supported in different encode modes, such as encode mode 0 and encode mode 5. Therefore, this dedicated encode mode 3 is no longer needed for CV5x / CV7x chips.</p>
<p >There is a dedicated parameter rotate_cw in channel configurations to achieve 90 degree clockwise rotation. The parameter hflip in channel configurations is to achieve horizontal flip, and the paramter vflip in channel configurations is to achieve vertical flip.</p>
<p >The following is the resource configuration. </p><a class="anchor" id="table_channel_rotation"></a>
<table class="doxtable">
<caption>Channel Rotation Configurations</caption>
<tr>
<th>Configurations </th><th><b>Description</b> </th></tr>
<tr>
<td>rotate_cw = 1 </td><td>90 degree clockwise rotation </td></tr>
<tr>
<td>hflip = 1 &amp;&amp; vflip = 1 </td><td>180 degree clockwise rotation </td></tr>
<tr>
<td>rotate_cw = 1 &amp;&amp; hflip = 1 &amp;&amp; vflip = 1 </td><td>270 degree clockwise rotation </td></tr>
</table>
<div class="image">
<img src="../../cv5_channel_rotation.jpg" alt=""/>
<div class="caption">
Channel Rotation / Flip</div></div>
<dl class="section note"><dt>Note</dt><dd>Limitations for channel rotation / flip are as follows:<ul>
<li>For rotation, Main Buffer must be 16 aligned for width and 32 aligned for height.</li>
<li>For flip, there is no special alignment requirement. It is the same as no flip cases.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="channel_idso_dual_cores"></a>
1.2 IDSP Dual Cores</h2>
<p >For CV5x chips, there are two indepenndet IDSP cores to process RAW frames from input RAW frames. For these two IDSP cores, users can be able to configure different Core modes for different channels.</p>
<p >There are three IDSP core modes for users to configure for each channel.</p><ul>
<li>The first is to enable IDSP core 0 only for the channel.</li>
<li>The second is to enable IDSP core 1 only for the channel.</li>
<li>The last one is to enable both IDSP cores for the channel.</li>
</ul>
<p >By default, all channels are configured with IDSP dual cores. But this is not most efficient way for all use cases. For the single VIN with 8K senor input, it is highly recommended to enable both IDSP cores to the channel, in order to achieve the best performance by fully utilizing both cores. For the multiple VIN use cases, it is more recommended to use single core for each channel, when the use cases are symmetric. For example, there are four sensor inputs, and each is with 4Kp30 IDSP performance. For such use case, it is highly recommended to use independent IDSP cores for each channel, which means two channels with IDSP core 0 and other two channels with IDSP core 1. This is more efficient than IDSP dual cores, because IDSP dual cores may have performance overhead caused by dual core performance balancing.</p>
<dl class="section note"><dt>Note</dt><dd>For CV72, there is only one IDSP core.</dd></dl>
<h2><a class="anchor" id="channel_mctf_compression"></a>
1.3 MCTF Compression</h2>
<p >MCTF compression is used to compress MCTF reference frames, to achieve better dynamic random access memory (DRAM) performance. There is a param "mctf_cmpr" in <a class="elRef" href="../../../library/d9/db4/structiav__chan__cfg.html">iav_chan_cfg</a> to configure this. By default, it is enabled. And users may need to tune MCTF compression bitrate related parameters to achieve best image quality. When it is turned off, more DRAM bandwidth is needed for IDSP processing, so it may be expected the overall performance may be slightly lower than the same case when it is turned on.</p>
<h2><a class="anchor" id="channel_reuse_src_chan"></a>
1.4 IDSP Virtual Channel Frame-Synchronized</h2>
<p >For the IDSP virtual channel use case, IDSP virtual channels send 3A configurations to IDSP separately from its master channel. Due to the excution latency of 3A application, sometimes the virtual channels might not be frame-synchronized with the sensor shutter/gain settings. As a result, there will be artifacts on IDSP virtual channels. Therefore, Ambarella provides the <code>reuse_src_chan_iso_cfg</code> parameter in lua scripts to do the frame synchronization. When this option <code>reuse_src_chan_iso_cfg</code> is enabled, the current IDSP virtual channel will use duplicated 3A configuration of master channel to achieve same and frame-synchronized settings as the master channel. This option is only valid when current channel is IDSP virtual channel and sensor control is disabled.</p>
<hr  />
<h1><a class="anchor" id="section_channel_example"></a>
2. Channel Examples</h1>
<h2><a class="anchor" id="example_channel_rotate"></a>
Example 1: Channel Rotation</h2>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A process if the following command was not executed previously.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Next, in this lua script case, modify the channel related configurations.<br  />
 Enable the rotate_cw flag, to enable 90 degree clockwise rotation.<br  />
 Set the Main Buffer width corresponding to the VIN height and align to 16. Set the Main Buffer height corresponding to the VIN width and align to 32. Adjust other canvas / buffer sizes if needed, due to the rotation on Main Buffer.</p>
<div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">     ...</div>
<div class="line">     rotate_cw = 1,</div>
<div class="line">     <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> = {</div>
<div class="line">             max_output = {0, 0}, -- output <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">             input      = {0, 0, 0, 0}, -- full <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div>
<div class="line">             output     = {0, 0, 1088, 1920},</div>
<div class="line">     },</div>
<div class="line">     third = {</div>
<div class="line">             max_output = {0, 0}, -- output <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">             input      = {0, 0, 0, 0}, -- full <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div>
<div class="line">             output     = {0, 0, 720, 1280},</div>
<div class="line">     },</div>
<div class="line">...</div>
<div class="ttc" id="agroup__IAV_html_ga85db88ffee2944ecd35c616393976289"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div><div class="ttdeci">u32 width</div></div>
<div class="ttc" id="atest__vout__cfg_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> test_vout_cfg.c:85</div></div>
</div><!-- fragment --><p >Use video output (VOUT) rotate / flip to view the image data before rotation.</p>
<div class="fragment"><div class="line">vout_2 = {</div>
<div class="line">     ...</div>
<div class="line">     <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#a2a6bf30514e846e0156bc3e92e471100">video_rotate</a> = <span class="stringliteral">&quot;yes&quot;</span>,</div>
<div class="line">     video_flip_mode = <span class="stringliteral">&quot;hv&quot;</span>,</div>
<div class="line">     ...</div>
<div class="line">}</div>
<div class="ttc" id="avout__init_8c_html_a2a6bf30514e846e0156bc3e92e471100"><div class="ttname"><a href="../../d4/de8/vout__init_8c.html#a2a6bf30514e846e0156bc3e92e471100">video_rotate</a></div><div class="ttdeci">static u32 video_rotate[VOUT_NUM]</div><div class="ttdef"><b>Definition:</b> vout_init.c:96</div></div>
</div><!-- fragment --><div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua\       <span class="comment">// For CV5 or CV52</span></div>
<div class="line">                   --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi_720p.lua</div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua\  <span class="comment">// For CV72</span></div>
<div class="line">                   --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi_720p.lua)</div>
</div><!-- fragment --><h2><a class="anchor" id="example_channel_flip"></a>
Example 2: Channel IDSP Flip</h2>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A process if the following command was not executed previously.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Modify the lua file for Channel IDSP horizontal and vertical flip: </p><div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">     ...</div>
<div class="line">     hflip = <span class="stringliteral">&quot;1&quot;</span>,</div>
<div class="line">     vflip = <span class="stringliteral">&quot;1&quot;</span>,</div>
<div class="line">     ...</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua\       <span class="comment">// For CV5 or CV52</span></div>
<div class="line">                   --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua\  <span class="comment">// For CV72</span></div>
<div class="line">                   --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)</div>
</div><!-- fragment --><h2><a class="anchor" id="example_channel_idsp_cores"></a>
Example 3: IDSP Dual Cores for CV5x</h2>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A process if the following command was not executed previously.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Modify the lua file to enable IDSP dual core configuration, and enable core 0 here: </p><div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">     ...</div>
<div class="line">     idsp_core_cfg_enable = <span class="stringliteral">&quot;1&quot;</span>,</div>
<div class="line">     idsp_core_mode = <span class="stringliteral">&quot;0&quot;</span>,          -- 0: core 0, 1: core 1, 2: dual cores</div>
<div class="line">     ...</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua\</div>
<div class="line">                   --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
</div><!-- fragment --><h2><a class="anchor" id="example_channel_vir_dup"></a>
Example 4: Virtual Channel Duplicated 3A Configuration of Master Channel.</h2>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A process if the following command was not executed previously.</p>
<div class="fragment"><div class="line">board# init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3</div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Modify the lua file for reuse_src_chan_iso_cfg. </p><div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">...</div>
<div class="line">img_stats_src_chan = <span class="stringliteral">&quot;chan_0&quot;</span>,</div>
<div class="line">sensor_ctrl = 1,</div>
<div class="line">reuse_src_chan_iso_cfg = 0,</div>
<div class="line">...</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">chan_1 = {</div>
<div class="line">...</div>
<div class="line">img_stats_src_chan = <span class="stringliteral">&quot;chan_0&quot;</span>,</div>
<div class="line">sensor_ctrl = 0,</div>
<div class="line">reuse_src_chan_iso_cfg = 1,</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>For idsp virtual channel with <code>sensor_ctrl</code> disabled and <code>reuse_src_chan_iso_cfg enabled</code>, not suggested to specify <code>img_stats_src_chan</code> to itself. It is only for IDSP processing with different IDSP config based on each channel's own 3A statistics.</dd></dl>
<p><a href="../..//script/cv5_virtual_channel_duplicate_3A.lua" target="_blank"><b>virtual_channel_duplicate_3A.lua</b></a></p>
<div class="fragment"><div class="line">board# test_encode --enc-mode 0 --resource-cfg /etc/cv5_virtual_channel_duplicate_3A.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>This feature also applies to CV72 in the same way. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
