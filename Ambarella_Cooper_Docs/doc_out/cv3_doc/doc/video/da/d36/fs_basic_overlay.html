<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: BASIC - Overlay on Streams</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('da/d36/fs_basic_overlay.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BASIC - Overlay on Streams </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_overlay_feature"></a>
1. Overlay Features</h1>
<p >Cooper family chips use overlay hardware to superimpose graphical and/or textual information on video streams. With the CV overlay function, the video is encoded with extra YUV data, which results in overlay data format in YUV. To display the overlay data, DSP refers to a color look-up table (CLUT) to obtain the correct color. The memory is mapped to the application filled with the CLUT information and OSD data. The total memory size depends on the chip version.</p>
<dl class="section user"><dt>Overlay &amp; Source Buffer</dt><dd></dd></dl>
<p>The overlay is inserted directly into the source buffer associated with the encoded stream. Adding an overlay when the streams are encoding from the same canvas can cause an overlay flickering, or "overlay leakage". For example, if both stream A and B encode from the canvas with the main buffer, the overlay inserted on stream A will also be shown on stream B, and vice versa. If stream B's frame rate does not match stream A's, the result can be a loss of OSD in the frames on stream B, causing an overlay flickering effect ("overlay leakage").</p>
<p >Therefore, if users require to perform overlay blending with more than one stream while avoiding overlay leakage, Ambarella recommends encoding the streams from separate source buffers and configuring overlays for each stream.</p>
<dl class="section user"><dt>Color Look-up Table</dt><dd></dd></dl>
<p>Cooper family chips support 16 independent color look-up tables (CLUT). Only CLUT8 mode is supported. Each CLUT requires 1 KB of memory.<br  />
 With CLUT8, each look-up table is an array of 256 entries. The entry is defined for four individual channels: Y, U, V, and alpha (transparency). Alpha 0 is transparent and 255 is non-transparent.</p>
<dl class="section user"><dt>Coordinate: Position &amp; Size</dt><dd></dd></dl>
<p>The coordinate space of the overlay window is the same as that of the stream. The following figure shows the overlay area position and size.</p>
<div class="image">
<img src="../../overlay_coordinate.png" alt=""/>
<div class="caption">
Overlay Area Position and Size</div></div>
<dl class="section note"><dt>Note</dt><dd>For each overlay area, the following restrictions are mandatory:<ul>
<li>The overlay width and height cannot be zero.</li>
<li>The overlay cannot exceed the boundary of the stream.</li>
<li>The width/height and horizontal/vertical offset of the overlay area must be a multiple of 4. The buffer pitch of the overlay area is suggested to be aligned to 64 bytes for high DRAM transferring efficiency.</li>
<li>The total overlay size of all the streams should be no larger than the half of the mapped memory size. For all streams, up to 64 overlay areas are supported.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Rotated Overlay</dt><dd></dd></dl>
<p>Because rotation and flip are performed after overlay insertion, the overlay rotates or flips with the stream.</p>
<p >To display the overlay in the orientation of the stream, the offset/width/height of the overlay region should be calculated according to rotation degree, and the overlay data should be transformed by a rotation matrix.</p>
<p >The following figures show the overlay on the stream, and the overlay buffer before clockwise rotations.</p>
<div class="image">
<img src="../../overlay_feature_rotate.png" alt=""/>
<div class="caption">
Rotated Overlay</div></div>
<dl class="section user"><dt>Multiple Buffering</dt><dd></dd></dl>
<p>To prevent cache pollution, use the multiple buffering strategy to update overlay content. The buffer number is determined by the updating frequency.</p>
<p >The following describes when a user assumes that overlay is updated every N frames:</p><ul>
<li><b>Double Buffering</b><br  />
 N &gt;= 5. For example, in real time overlay display, the time string is updated every second. The frequency is much greater than 5 frames.</li>
<li><b>Quad buffering</b><br  />
 N &lt; 5. For example, using overlay as time stamp, every frame has different overlay content. The frequency is 1 frame.</li>
</ul>
<dl class="section user"><dt>Insert Always</dt><dd></dd></dl>
<p>"Insert Always" means that the overlay is inserted into every captured frame, without taking into consideration if the encode frame factor is being used. This feature is used to prevent overlay leakage when different streams with distinct frame factors are encoded from the same source buffer.</p>
<p >The following is an example scenario in which two streams are encoding from the same source buffer:<br  />
</p>
<dl class="section user"><dt></dt><dd>Both stream A and B are encoding from the main source buffer. Stream A's frame rate is 30, and stream B's frame rate is 15. If the insert overlay to stream B with "insert always" flag is enabled, stream A will also contain the overlay in all frames. Alternatively, if the insert overlay with "insert always" is not enabled, the overlay content will not appear in every frame from stream A, causing stream A to appear as if it contains flash overlay content.</dd></dl>
<dl class="section user"><dt>Text Language Support</dt><dd></dd></dl>
<p>Because many languages, such as Chinese and Japanese, use character sets larger than the range of values of type char, the GNU C library includes support for extended character sets. Follow this link for details on the GNU C extended characters:</p>
<p ><a href="http://www.chemie.fu-berlin.de/chemnet/use/info/libc/libc_18.html">http://www.chemie.fu-berlin.de/chemnet/use/info/libc/libc_18.html</a></p>
<ul>
<li><b>Wide Character</b><br  />
 The text insert package of the CV5x Flexible Linux SDK requires characters to be represented as wide characters. As a result, users must convert Chinese and other languages to the wide character type before using the text insert package.</li>
<li><b>Character Set</b><br  />
 The behavior of the function "char to wchar" is affected by the current locale. Users should install the character set and set it up before calling the function "char to wchar". Locales can be found in the toolchain folder:<br  />
 <em>linaro-aarch64-2018.08-gcc8.2/aarch64-linux-gnu/libc/usr/share/locale.</em><br  />
 Put the required locale to /usr/lib on the CV5x board. Before the function "char to wchar", call setlocale to set the current locale.</li>
</ul>
<p ><br  />
</p>
<hr  />
<h1><a class="anchor" id="section_overlay_example"></a>
2. Overlay Examples</h1>
<h2><a class="anchor" id="example_overlay_rect"></a>
Example 1: Rectangle Overlay</h2>
<p >Reboot the EVK board and then set up a stream on the EVK board.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --><dl class="section user"><dt>Set up three rectangle overlay areas.</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# test_overlay -A -a 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gaf80df1bdae91e5f76236e6ed1110825d">x</a> 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 0 -w 128 -h 64\</div>
<div class="line">                       -a 1 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gaf80df1bdae91e5f76236e6ed1110825d">x</a> 200 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 100 -w 64 -h 128\</div>
<div class="line">                       -a 2 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gaf80df1bdae91e5f76236e6ed1110825d">x</a> 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 300 -w 48 -h 96</div>
<div class="ttc" id="agroup__IAV_html_ga11e444dd61d48abbdd34eed23186cb4b"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a></div><div class="ttdeci">u32 y</div></div>
<div class="ttc" id="agroup__IAV_html_gaf80df1bdae91e5f76236e6ed1110825d"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#gaf80df1bdae91e5f76236e6ed1110825d">x</a></div><div class="ttdeci">u32 x</div></div>
</div><!-- fragment --><div class="image">
<img src="../../ut_overlay_3rects.jpg" alt=""/>
<div class="caption">
Three Rectangles Overlay on One Stream</div></div>
<dl class="section user"><dt>Update the Overlay Area</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# test_overlay -A -a 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gaf80df1bdae91e5f76236e6ed1110825d">x</a> 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 100 -w 64 -h 128 --update</div>
</div><!-- fragment --><dl class="section user"><dt>Clear all overlays for multiple streams</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# test_overlay -A --disable\</div>
<div class="line">                    -B --disable\</div>
<div class="line">                    -C --disable\</div>
<div class="line">                    -D --disable</div>
</div><!-- fragment --><h2><a class="anchor" id="example_overlay_always"></a>
Example 2: Update the Overlay Every Frame</h2>
<p >Reboot the EVK board and then set up 2 streams on the EVK board.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -e</div>
</div><!-- fragment --><p >Update the Overlay Every Frame</p>
<div class="fragment"><div class="line">board# test_overlay -r 1</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
