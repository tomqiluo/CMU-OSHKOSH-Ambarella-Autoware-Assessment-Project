<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: BASIC - Stream</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d7d/fs_basic_stream.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BASIC - Stream </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >CV5x / CV72 can encode up to twenty streams simultaneously. The streams can include different configurations for profile, resolution, bit rate, frame rate, group of pictures (GOP) setting, and duration. Each stream can be independently started or stopped.</p>
<h1><a class="anchor" id="section_stream_features"></a>
1. Stream Features</h1>
<h2><a class="anchor" id="section_stream_input"></a>
1.1 Stream Input – from Single Canvas</h2>
<p >For multi-channel design, each channel's source buffer can output the data with different resolutions independently. Then user application can put the final outputs of these source buffers together into one canvas so that the stream encoded from this canvas can cover several field of views (FoVs) of different video input (VIN) channels. The streams can be encoded from any of the canvases, which are configured as an "encode" type. Alternatively, the application can encode several streams cropped from different areas of one canvas separately.</p>
<div class="image">
<img src="../../stream_input_from_canvas.png" alt=""/>
<div class="caption">
Figure 1-1. Stream Encode from Canvas.</div></div>
<p >The above cases have two possible ways for a stream encoded from a source canvas.</p>
<ul>
<li>
Stream is encoded with the same size and FoV as its source canvas </li>
<li>
Stream is encoded with a cropped area and smaller FoV than its source canvas. </li>
</ul>
<p >Because the source canvas from each channel contains the source buffers that have already been cropped and scaled from its VIN, the video digital signal processor (VDSP) does not support re-scale from canvas anymore. However users can encode from the area of interest, which will sacrifice its FoV.</p>
<p >The benefits of using different canvases for streams include the following:<br  />
</p>
<ul>
<li>
Full FoV for streams </li>
<li>
Independent overlays for each stream </li>
<li>
Changing the buffer size (except for the main buffer) does not affect the other streams </li>
<li>
Independent effect of the digital pan / tilt / zoom (DPTZ) </li>
</ul>
<p >See <a class="el" href="../../d6/d71/fs_basic_canvas.html">Canvas</a>.</p>
<h2><a class="anchor" id="section_stream_multi_input"></a>
1.2 Stream Input – From Multi-Canvas</h2>
<p >As introduced above, each stream usually is encoded from only one source canvas. Sometimes, there is a special requirement to have one stream encoded from multiple source canvases. The CV5x / CV72 VDSP provides such capability. When these canvases are encoded to the same stream, they will be encoded sequentially in frame-interleaved order.</p>
<div class="image">
<img src="../../stream_input_from_multi_canvas.png" alt=""/>
<div class="caption">
Figure 1-2. Stream Encode from Multi-Canvas.</div></div>
<p >Canvases that will be encoded to a single stream must meet the following requirements:<br  />
</p>
<ul>
<li>
Have the same canvas size </li>
<li>
Have the same canvas framerate </li>
</ul>
<h2><a class="anchor" id="section_frame_rate"></a>
1.3 Frame Rate</h2>
<p >The frame rate cannot be larger than the image digital signal processing (IDSP) frame rate or smaller than 1 frames per second (fps).</p>
<p ><b> Encoding Frame Rate = IDSP Frame Rate * Frame Factor (0 &lt; Frame Factor ≤ 1) </b> ' If a stream's frame rate is scaled by the frame factor, the time interval between two consecutive frames may not be a constant value. The IDSP frame rate can be larger than VIN frame rate if the IDSP frame rate upscaling is enabled.</p>
<p >For example, assume that the VIN frame rate is 30 fps, the IDSP frame rate is 30 fps, and stream A is 20 fps. Use a frame factor of 20/30 to scale the IDSP frame rate. The time interval between two output encoded frames can be 33 MS or 66 MS. However, there are only 20 frames in one second.</p>
<p >To obtain identical time intervals between every frame, set the stream frame rate to equal the IDSP frame rate.</p>
<p >See <a class="el" href="../../dc/d95/fs_basic_fps.html">Frame Rate</a>.</p>
<h2><a class="anchor" id="section_bit_rate"></a>
1.4 Bit Rate</h2>
<p >The bit rate is for H.264 / H.265, and changes with the frame factor.</p>
<p ><b> Encoding Bit Rate = Target Bit Rate * Frame Factor (0 &lt; Frame Factor ≤ 1) </b></p>
<p >If a stream's frame rate changes quickly, for example, from 30 fps to fewer, the actual encoded bit rate will decrease proportionally with the frame factor.</p>
<p >If an application requires a constant bit rate (CBR), even when the frame rate is changed to other values, it must to configure the bit rate multiplied by the reciprocal of the frame factor with the frame factor together. Then, DSP will output the constant bit rate for the lower frame rate stream.</p>
<p >The image audio video (IAV) driver supports the feature of absolute bit rate (example_absolute_bitrate), which can help user applications to achieve this goal automatically when changing the stream frame rate at runtime.</p>
<p >The average bit rate calculated inside the DSP is based on the GOP length, not seconds. This is because if the GOP length is longer than one second, the average bit rate computed in seconds would fluctuate for every GOP length.</p>
<p >The IAV driver supports the feature of strict constant bit rate (example_strict_constant_bitrate), which is used to keep the actual bit rate around the target bit rate as much as possible whenever the scene is in motion or static.</p>
<p >The DSP also supports high bit rate encoding for advanced video coding (AVC) and high-efficiency video coding (HEVC). To achieve the high bit rate, the user application must set a smaller QP-limit value for I / P / B frames. Beause the default QP ranges in the IAV driver are designed for low bit-rate cases rather than high bit-rate cases.</p>
<p >The average bit rate calculated in the first second would be higher than the rest of the seconds due to the large frame size of the first I frame.</p>
<h2><a class="anchor" id="section_maximum_gop_m"></a>
1.5 Maximum GOP M</h2>
<p >The maximum GOP M field provides information to DSP, as well as information about allocating dynamic random access memory (DRAM) for the reference frames in H.264 / H.265 encoding.</p>
<p >For H.264 / H.265 encoding, a valid range is between 1~3. The larger the number is, the more reference frames DSP allocates for encoding are. This results in DSP reserving more DRAM for H.264 / H.265 encoding. If multiple reference frames are not needed in the user applications, Ambarella recommends setting it to 1 to save the DSP DRAM footprint. Additionally, when the value is greater than 1, DSP will also need to allocate extra internal resources. To prevent the DSP from hanging due to the shortage of internal resources, the default configuration is stream A / B enables max_gop_M &gt; 1, while other streams cannot.</p>
<p >MJPEG encoding can be set to zero to save DRAM, especially for larger resolutions such as 6 MP, or a small system DRAM.</p>
<h2><a class="anchor" id="section_gop_n"></a>
1.6 GOP N</h2>
<p >The GOP N (GOP length) field provides information to DSP on how many frames have one IDR / I frame, and it is a run-time to the changeable parameter for H.264 / H.265 encoding.</p>
<p >The longest GOP length (N) is 1800, or about 60 seconds (1800 = 30 * 60) for 30 fps streams. When the application changes the GOP N value dynamically, the action is immediately applied to the current GOP. Additionally, an IDR frame is immediately generated if the frame number in the current GOP already exceeds the new GOP length. This feature is called "instant GOP change" instead of "run-time GOP change".</p>
<h2><a class="anchor" id="section_encode_duration"></a>
1.7 Encode Duration</h2>
<p >The encode duration provides information on the number of frames to be encoded in the stream. A valid range is from 0~65535.</p>
<p >For example, if the application sets "encode duration" to a non-zero value, the DSP will automatically stop encoding after these frames are encoded. This eliminates the need for Arm® to issue an encode stop command. If the application sets the "encode duration" as a zero value, the application issues an encode stop command explicitly.</p>
<p >This feature supports H.264 / H.265 and MJPEG in all modes. If there is no change, the image audio video (IAV) driver retains the previous value.</p>
<h2><a class="anchor" id="section_encode_frame_drop"></a>
1.8 Encode Frame Drop</h2>
<p >The encode frame drop provides information on the number of frames that will be discarded and not be encoded for the specified stream. The valid range is from 1~255.</p>
<p >If the application sends "encode frame drop" command, the DSP will discard the upcoming frames and will not encode them into the bit stream. This feature will not change the GOP length. For example, if the application sets N = 30 and issues "frame drop" command with 2 frames, the total frames in this GOP will be still 30 frames. The two dropped frames are discarded directly before encoding; this does not affect the encoding.</p>
<p >When this feature works in conjunction with the frame factor, the frames that encode several frames will be discarded; frames that were intended to be discarded are not included.</p>
<h2><a class="anchor" id="section_encode_frame_trigger"></a>
1.9 Encode Frame Trigger</h2>
<p >The encode frame trigger provides information on the number of frames that will be encoded for the specified stream. The valid range is from 1~255.</p>
<p >If the application sends "encode frame trigger" command, the DSP will encode the upcoming frames into the bit stream. For example, if the application issues "frame trigger" command with 2 frames, the encoder will encode 2 frames. In addition, if the application issues "frame trigger" command with frame-trigger-repeat option and 3 frames, the encoder will encode 3 frames every time after drop one frame.</p>
<p >The application can use manual-arm-pts option. With this option, users can get continuous Arm presentation time stamp (PTS) even DSP skip to encode some frames.</p>
<h2><a class="anchor" id="section_canvas_stream_sync"></a>
1.10 Canvas and Stream Sync</h2>
<p >There may be two types of synchronization requirements between canvases and streams:</p><ul>
<li>Locate a specific canvas with the PTS, perform motion analysis or object detection on the frame YUV or ME data, and apply encode parameters accordingly.</li>
<li>Apply the IDSP and encode parameters to the same frame, not necessarily to a predefined frame with the PTS.</li>
</ul>
<p >For the first one, it is required to implement the frame FIFO to cache several frames, in order to allow applications to have enough time to do analysis and apply the encode parameters. There are two places to implement this FIFO: FIFO between canvas output and encoder, as well as the FIFO inside encoder. Both need to allocate more YUV / ME buffers, and thus requires more DSP DRAM size.</p>
<p >For the second one, FIFO is not needed, due to no requirement to specific frame. In this case, no extra DRAM size is required.</p>
<h3><a class="anchor" id="subsection_encode_dummy_latency"></a>
1.10.1 Encode Dummy Latency</h3>
<p >In order to configure encode parameters or apply overlay / blur effect on the exact frame, IAV driver provides a method called "encode dummy latency" or "frame sync mechanism".</p>
<p >This method allows DSP to allocate more frame buffers in the FIFO between the canvas ouput and other modules (such as encoder or VOUT). These new allocated buffers are used to cache frames, so that application has enough time to calculate the encode parameters and configure them on the exact frame. This method helps the application to perform a frame accurate encode control. PTS is used to synchronized between canvas output and other modules, to achieve the frame accurate operations.</p>
<p >For CV5x, there are only one way for "encode dummy latency", and the latency is per canvas. The canvas based latency has a good granuarity, by specifying the latency only for the specified canvas, thus only allocating frame buffers for this canvas.</p>
<p >When the latency is added between canvas output and encoder input, the encoder will delay n frames to fetch and apply overlay / blur and encode the YUV data when the command is sent to the DSP. The range of n is 0~8, where 0 means no delay.</p>
<p >One of the typical use case is to use CVflow® hardware (HW) to perform convolutional neural network (CNN) object detection (people / face / licence plate / objects) on the canvas or pyramid frames, and apply frame accurate results to the encoded stream (including overlay / blur effects and the frame / region of interest (ROI) level encode parameters). The detected results can be drawn on the frame with bonding boxes (overlay) and applied with blur effect (people / face). The detected objects can also apply different ROI encode parameters, to improve the video quality for these specific areas. Check 21. Frame Sync for usage.</p>
<div class="image">
<img src="../../enc_dummy_latency.png" alt=""/>
<div class="caption">
Figure 1-3. Encode Dummy Latency.</div></div>
<h3><a class="anchor" id="subsection_stream_dummy_latency"></a>
1.10.2 Stream Dummy Latency</h3>
<p >Besides "encode dummy latency", IAV driver provides another way to do synchronization between canvas output and encoder, called "stream dummy latency".</p>
<p >Different from "encode dummy latency", "stream dummy latency" adds the latency inside the encoder, which is right before compressor / decompressor (codec) (perform advanced video coding (AVC) / high efficiency video coding (HEVC) / MJPEG encoding) and after overlay / blur / rotate / flip operations. This method enables DSP to report pre-encoding frame data to Arm, and cache several frames to allow the application to do motion analysis and object detecion, and finally apply frame accurate encode parameters to the specified frame.</p>
<p >The latency is a per stream parameter, with the range of 0~4, where 0 means no delay. DSP reports the pre-encoded YUV / ME data for Arm to do analysis. Arm needs to apply the frame accurate encode parameters to DSP with the specified latency, using PTS to perform synchronization.</p>
<p >This method is user-friendly for the encoder control. The reported pre-encoded YUV / ME has the same FoV as the encoder. The frame rate is also the same as encoder. With "encode dummy latency", the YUV / ME FoV is the full canvas FoV, and the frame rate is full canvas frame rate, which may be different from the encoded stream.</p>
<p >The typical use case for "stream dummy latency" is the SmartRC library. It will use the ME data before codec to do motion analysis, and apply frame level and ROI level encode parameters according to the analysis results. Check 23. Stream Sync for usage.</p>
<div class="image">
<img src="../../stream_dummy_latency.png" alt=""/>
<div class="caption">
Figure 1-4. Stream Dummy Latency.</div></div>
<h3><a class="anchor" id="subsection_latency_comparison"></a>
1.10.3 Comparison for Encode/Stream Dummy Latency</h3>
<a class="anchor" id="encode_stream_dummy_latency_comparison"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Description </th><th><b>Encode Dummy Latency</b> </th><th>Stream Dummy Latency </th></tr>
<tr>
<td>FIFO for the buffers </td><td>Yes, added between Canvas output and VDSP input </td><td>Yes, added inside VDSP, before coded and after overlay / blur / rotate / flip </td></tr>
<tr>
<td>Buffer FoV </td><td>The FoV / size is the same as original canvas FoV / size. </td><td>The FoV / size is the same as the stream FoV / size, may be cropped / rotated / flipped </td></tr>
<tr>
<td>Overlay/Blur </td><td>May not have overlay or blur </td><td>With overlay / blur </td></tr>
<tr>
<td>Reported buffer frame rate </td><td>The frame rate is the same as the canvas frame rate </td><td>The frame rate is the same as the stream frame rate </td></tr>
<tr>
<td>Use scope </td><td>Between IDSP and encoder / video output (VOUT) / vector processor (VP). </td><td>Mainly for smart rate control, due to encoder friendly </td></tr>
</table>
<h3><a class="anchor" id="subsection_idsp_encode_sync"></a>
1.10.4 IDSP Encoder Sync</h3>
<p >For IDSP Encoder sync mechanism, the target is to apply the IDSP / Encoder operations to the same frame. However, it is not required to apply the operations to the specific frame with the PTS.</p>
<p >This is implemented by binding the IDSP / Encoder operations to the same CMD block to DSP. So user applications need to configure IDSP and Encoder operations first, and apply the operations at the same time. IAV would pass the opertions in the same CMD block to DSP. DSP would process and apply them in the same frame time. It will apply to the frame when DSP receives and processes the IDSP operation. So the encoder operation is also applied to this frame. Therefore, this achieves the effect of applying the IDSP / Encoder operations to the same frame.</p>
<p >The typical use case for "IDSP / Encoder Sync" is the magic zoom feature. For example, users can apply DPTZ to perform zoom operation to the canvas at IDSP stage, configure the encode offset at Encoder stage, and apply these operations the same frame. Check @ref idsp_enc_fsync "22. Frame Sync between iDSP and Encoder" for usage.</p>
<div class="image">
<img src="../../idsp_encoder_sync.png" alt=""/>
<div class="caption">
Figure 1-5. IDSP / Encoder Sync.</div></div>
<h2><a class="anchor" id="section_monochrome"></a>
1.11 Monochrome</h2>
<p >In order to encode monochrome streams with AVC / HEVC / MJPEG, the IAV driver provides a new parameter named the "--chrome" format for the application to configure.</p>
<p >This parameter enables the DSP to generate monochrome streams and enables the application to change it dynamically.</p>
<h2><a class="anchor" id="section_strict_cbr"></a>
1.12 Strict Constant Bit Rate</h2>
<p >In order to configure more strict constant bit rate behavior on the streams, IAV driver provides a new option named "--cbr-stable-br-enable [0|1]" to support this feature. With this option enabled, the DSP will encode the bit stream with smaller bit rate fluctuation.</p>
<h2><a class="anchor" id="section_multiple_sltile_enc"></a>
1.13 Multiple Tile Encoding</h2>
<p >For HEVC, it supports multiple-tile encoding. The encoder can divide the frame into 5 tiles at most. These tiles can be encoded in parallel by the hardware. It can increase the encoding performance. However, not all the cases can be divided to 5 tiles, there are some limitations from HEVC standard. The width of each tile should be greater than 256, which means for the cases such as 640x360, the maximum number of tile is 2, otherwise the stream cannot be decoded successfully. In addition, the IAV driver will update the tile number according to the encoding width automatically in <code>iav_dsp_cmd.c</code>. <b> Please note, for mass production, it is not suggested to change the tile number manually. </b></p>
<div class="image">
<img src="../../multiple_tile_number_5.png" alt=""/>
<div class="caption">
Figure 1-6. Set Tile Number 5.</div></div>
<p >Bits-info of structure <a class="elRef" href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a> is used to describe the information about tile. There is tile_id in the structure <a class="elRef" href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a>. Customers can fetch the tile information by calling IAV_DESC_FRAME.</p>
<h2><a class="anchor" id="subsection_encoder_dual_cores"></a>
1.14 Encoder Dual Cores</h2>
<p >CV5x has two VDSP cores and four modes to make use of these two cores.</p>
<ul>
<li>
Single core 0: Use VDSP core 0 only. </li>
<li>
Single core 1: Use VDSP core 1 only. </li>
<li>
Dual core temporal: Use VDSP dual cores. To use this mode, streams have to be configured as 2 layers SVC-T, then stream layer 0 and layer 1 are encoded simultaneously on two cores. Only H.264 and H.265 streams support this mode. </li>
<li>
Dual core spatial: Use VDSP dual cores. When using this mode, a VDSP input frame is splited into two halves side by side, then these two halves are encoded simultaneously on two cores. Only H.265 streams support this mode at the moment. In dual core spatial mode, multi-slices / tiles encoding will take effect on each half. For example, setting 3 tiles means that both the left and right halves are divided into 3 tiles, which is equal to divide one frame into 6 tiles. </li>
</ul>
<p >The encoder core mode is a per stream configuration, which means it is possible to encode several streams at the same time using different encoder core modes.<br  />
 The VDSP can achieve the best performance only when the work is evenly assigned to two cores. DSP will ensure load balancing between the two cores in dual core temporal and dual core spatial mode. Then it's up to users to assign loadings when streams are configured using a single core.<br  />
 IAV default configures dual core temporal for H.26x streams and single core 0 for MJPEG streams.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>It is not supported to configure all streams on VDSP core 1.</li>
<li>For CV72, there is only one VDSP core.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="section_pjpeg_tile_size"></a>
1.15 Encode PJPEG Tile DRAM Size</h2>
<p >PJPEG tile DRAM buffers are specially used by DSP to store the intermediate process data of video encoding flow. For CV chip (like CV5 &amp; CV3) which have dual VDSP cores, core 0 and core 1 each have their own PJPEG tile DRAM buffer with the following layout, total of 10 buffers are allocated.</p>
<div class="image">
<img src="../../pjpeg_size.png" alt=""/>
<div class="caption">
Figure 1-7. Encode PJPEG DRAM Layout.</div></div>
<p >Tile 0 can be used for AVC / HEVC, tile 1 can be used for AVC / HEVC / MJPEG, and tile 2/3/4 are only used for HEVC. Each buffer can be allocated up to 16 MB, so the PJPEG tile size can be up to 160 MB in total. However, in practical scenarios, according to the used resolution and coding quality, the appropriate buffer size can be dynamically allocated to save the DRAM usage of DSP.</p>
<p >Ambarella has optimized the default PJPEG DRAM size for AVC and HEVC to ensure the best balance between average coding quality and DRAM usage. However, if users see the following artifacts from high-quality or larger resolution MJPEG encoding (such as 4Kp JPEG with high quality, or 8Kp JPEG), it means the PJPEG buffer is insufficient for this case. Users need to increase the PJPEG tile for MJPEG accordingly.</p>
<div class="image">
<img src="../../artifacts_due_low_pjpeg_tile.png" alt=""/>
<div class="caption">
Figure 1-8. Artifacts Due to Low PJPEG Size.</div></div>
<p >The following three debug options are also provided to set the corresponding PJPEG tile DRAM size to meet the higher DRAM requirements. </p><a class="anchor" id="table_stream_lua"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Option </th><th><div style="width:150px"><b>Range(MB)</b></div> </th><th>Description </th></tr>
<tr>
<td>avc_pjpeg_size_MB_per_tile </td><td>[0~16] </td><td>Specifies the tile 0/1 PJPEG tile DRAM size for both core 0/1 </td></tr>
<tr>
<td>mjpeg_pjpeg_size_MB_per_tile </td><td>[0~16] </td><td>Specifies the tile 1 PJPEG tile DRAM size for both core 0/1 </td></tr>
<tr>
<td>hevc_pjpeg_size_MB_per_tile </td><td>[0~16] </td><td>Specifies the tile 2/3/4 PJPEG tile DRAM size for both core 0/1 </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Tile 0 is shared by AVC / HEVC, so the final DRAM size of tile 0 will be the maximum between avc_pjpeg_size_MB_per_tile and hevc_pjpeg_size_MB_per_tile.</li>
<li>Tile 1 is shared by AVC / HEVC / MJPEG, so the final tile 1 DRAM size will be the maximum between avc_pjpeg_size_MB_per_tile, hevc_pjpeg_size_MB_per_tile, and mjpeg_pjpeg_size_MB_per_tile.</li>
</ul>
</dd></dl>
<p>If users want to use high quailty MJPEG encoding, Ambarella recommends setting the tile 1 size to 16 MB when the maximum resolution is above 4K, 12 MB or above for 5M resolution, and 6 MB or above for 1080p resolution. Here is an example.</p>
<div class="fragment"><div class="line">board# init.sh --na; modprobe imx274_mipi vinc_id=8 <span class="comment">// For CV5/CV52</span></div>
<div class="line">(Or board# init.sh --na; modprobe imx274_mipi vinc_id=8) <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/local/bin/scripts/cv5_vin0_4k_linear.lua --vout-cfg /usr/local/bin/scripts/vout_hdmi.lua --mjpeg-pjpeg-tile-size 16 <span class="comment">// For CV5/CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/local/bin/scripts/cv72_vin0_4k_linear.lua --vout-cfg /usr/local/bin/scripts/vout_hdmi.lua --mjpeg-pjpeg-tile-size 16) <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -m 3840x2160 --quality 90 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_custom_sei"></a>
1.16 Insert User-Customized Data into Bitstream</h2>
<p >This feature is used for users to insert their own customized data into the bitstream, such as DPTZ information, additional information of the interested objects in the stream scene, and more. The data format and size can be freely defined by users. AVC, HEVC, and MJPEG all can support this feature. For AVC / HEVC bitstream, the customized data is inserted in the form of supplement enhancement information (SEI) data in <b>SEI (users data unregistered) NALU</b>. For MJPEG bitstreams, the customized data is inserted directly into the user's customized field marked as <b>APP0</b>.</p>
<p >User need to pre-allocate custom sei memory resources of the stream. Please configure the following parameters: </p><div class="fragment"><div class="line"> stream_0 = {</div>
<div class="line">   <span class="keywordtype">id</span> = 0,</div>
<div class="line">   ...</div>
<div class="line">   custom_sei_possible = 1,  <span class="comment">// The flag to alloc custom sei buffer memroy for the current stream.</span></div>
<div class="line">   custom_sei_buf_num = 8,  <span class="comment">// The custom sei buffer number of custom sei buffer pool for current stream, it determines the queue depth of pts frame sync.</span></div>
<div class="line">   custom_sei_data_max_size = 1024,  <span class="comment">// The maximum data size for custom sei, which is used for allocating memory in DSP and iav driver.</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --><p> Note that the byte order of the data stored in bitstream is in Big-Endian. For example, if the inserted data (from Byte0 to ByteN) is "0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, ...", its byte-order in the bitstream will be "0x33, 0x22, 0x11, 0x00, 0x77, 0x66, 0x55, 0x44, ...". </p><table class="doxtable">
<caption>Byte-Order of User Customized Data in Bitstream</caption>
<tr>
<th>Byte3</th><th>Byte2</th><th>Byte1</th><th>Byte0</th><th>Byte3</th><th>Byte2</th><th>Byte1</th><th>Byte0</th><th>... </th></tr>
<tr>
<td>0x33</td><td>0x22</td><td>0x11</td><td>0x00</td><td>0x77</td><td>0x66</td><td>0x55</td><td>0x44</td><td>... </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>"test_custom_sei" is a sample application that demonstrates how to insert users-customized data. In real use cases, users can insert their own customized data in any format and size.</li>
<li>Repeat custom sei data only support no pts sync, random sei data size only support pts sync.</li>
<li>For fixed payload size case, "--custom-sei-data-size" is the real sei payload size in the bitstreams, it can't larger than "custom_sei_data_max_size". In order to provide enough redundant bits space for RBSP preventive byte stuffing process. When user insert the custom sei data, the real data size can't exceed 3/4 of the "custom-sei-data-size", which is 3/4 of the payload size.</li>
<li>For dynamic custom sei data size case, the sei payload size will be adjusted based on the actual data size and the number of preventive byte stuffing (0x03) that need to be inserted into the data. We also need to make sure that the actual data size is not larger than 3/4 of "custom_sei_data_max_size".</li>
<li>Support inserting custom SEI data for I-frame only.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Insert User-Customized SEI Data into AVC / HEVC / MJPEG Bitstreams</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode -i 1080p --hdmi 1080p</div>
<div class="line">board# test_encode --resource-cfg cv5_vin0_1080p_linear_custom_sei.lua  --vout-cfg /usr/local/bin/scripts/vout_hdmi.lua</div>
<div class="line">board# rtsp_server --streaming-sei &amp;</div>
<div class="line"> </div>
<div class="line">example 1: Fixed payload size with pts sync:</div>
<div class="line">board# test_encode -A -b0 -h/-H/-m 1080p --custom-sei-data-size 256 -e <span class="comment">// The user specifies the payload size (256) in all next frames</span></div>
<div class="line">board# test_custom_sei -S 0 -p -d 12x34         <span class="comment">// users customized SEI data(12, 34) is inserted in all next frames by frame sync</span></div>
<div class="line"> </div>
<div class="line">example 2: Fixed payload size with no pts sync:</div>
<div class="line">board# test_encode -A -b0 -h/-H/-m 1080p --custom-sei-data-size 256 -e <span class="comment">// The user specifies the payload size (256) in all next frames</span></div>
<div class="line">board# test_custom_sei -S 0 -d 12x34        <span class="comment">// users customized SEI data(12, 34) is inserted in all next frames by no frame sync</span></div>
<div class="line"> </div>
<div class="line">example 3: Fixed payload size repeat sei data:</div>
<div class="line">board# test_encode -A -b0 -h/-H/-m 1080p --custom-sei-data-size 256 -e <span class="comment">// The user specifies the payload size (256) in all next frames</span></div>
<div class="line">board# test_custom_sei -S 0 -d 12x34 -r         <span class="comment">// users customized SEI data(12, 34) is inserted repeatedly in all next frames</span></div>
<div class="line"> </div>
<div class="line">example 4: Dynamic payload size with pts sync:</div>
<div class="line">board# test_encode -A -b0 -h/-H/-m 1080p --custom-sei-dynamic-size-enable 1 -e <span class="comment">// The user enable the dynamic payload size</span></div>
<div class="line">board# test_custom_sei -S 0 -p -d 1920x1080     <span class="comment">// users customized SEI data(12, 34) is inserted in all next frames by frame sync</span></div>
<div class="line"> </div>
<div class="line">example 5: Dynamic payload size with random data size::</div>
<div class="line">board# test_encode -A -b0 -h/-H/-m 1080p --custom-sei-dynamic-size-enable 1 -e <span class="comment">// The user enable the dynamic payload size</span></div>
<div class="line">board# test_custom_sei -S 0 -p -R  <span class="comment">// usres can use -R to test different sei data size for each frame.</span></div>
<div class="line"> </div>
<div class="line">example 6: Insertion <span class="keywordflow">for</span> I-frame only:</div>
<div class="line">board# test_encode -A -b0 -h/-H 1080p --custom-sei-data-size 256 --custom-sei-I-only 1 -e</div>
<div class="line">board# test_custom_sei -S 0 -d 12x34 -r    <span class="comment">// users customized SEI data(12, 34) is inserted repeatedly in all next I frames</span></div>
</div><!-- fragment --><p> <br  />
</p>
<hr  />
<h1><a class="anchor" id="section_stream_configuration"></a>
2. Stream Configuration</h1>
<p >Users can configure the stream resource via Lua script. Here are the parameters for stream resource <a class="elRef" href="../../../library/d0/d9e/structiav__stream__resource.html">iav_stream_resource</a>.</p>
<a class="anchor" id="table_stream_lua"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Item </th><th><div style="width:150px"><b>Parameter</b></div> </th><th>Description </th></tr>
<tr>
<td>id </td><td>id &gt;= 0 </td><td>Specifies stream ID. It is suggested to keep the same value as stream index, and it starts from zero. </td></tr>
<tr>
<td>max_size </td><td>{width, height} </td><td>Specifies the maximum resolution of stream. </td></tr>
<tr>
<td>max_M </td><td></td><td>Specifies maximum GOP M for stream. For B frame, max_M &gt; 1. For MJPEG encoding, max_M = 0. </td></tr>
<tr>
<td>fast_seek_enable </td><td>0: Disable<br  />
 1: Enable </td><td>Enables / disable fast seek frame. </td></tr>
<tr>
<td>two_ref_enable </td><td>0: No SVC-T<br  />
 1: 2 layers SVC-T. </td><td>Enable / disable 2 forward reference frames. </td></tr>
<tr>
<td>max_svct_layers_minus_1 </td><td></td><td>Specifies maximum SVC-T layers options. </td></tr>
<tr>
<td>max_num_minus_1_ltrs </td><td></td><td>Specifies maximum long term number minus 1. </td></tr>
<tr>
<td><a class="anchor" id="anchor_codec_enable"></a>codec_enable </td><td>0: HEVC / H264 /MJPEG <br  />
 1: HEVC / MJPEG <br  />
 2: H264 /M JPEG <br  />
 3: MJPEG only </td><td>Enables / disable stream codec. </td></tr>
<tr>
<td>efm_enable </td><td>0: Disable <br  />
 1: Enable </td><td>Enables / disable to do encode from memory (EFM) for current stream. </td></tr>
<tr>
<td>efm_buf_num </td><td></td><td>Specifies the number of frame buffers allocated for EFM. These frame buffers are allocated by DSP and occupies extra DSP memory. </td></tr>
<tr>
<td>efm_size </td><td>{width, height} </td><td>Specifies the resolution of EFM frame buffer. </td></tr>
<tr>
<td>efm_skip_waiting </td><td>0: Disable<br  />
 1: Enable </td><td>Enables skipping waiting for DSP's response when starting / stopping EFM streams. </td></tr>
<tr>
<td>efm_extern_src_enable </td><td></td><td>Enables sharing EFM buffer from other streams. </td></tr>
<tr>
<td>efm_extern_src_stream </td><td></td><td>Specifies the stream ID of shared EFM buffer for the current stream. </td></tr>
<tr>
<td>possible_enc_src_map </td><td></td><td>Specifies the possible encoding source canvas map for a stream, which can deploy DSP encoding resource in a more saving way. </td></tr>
<tr>
<td>stream_mv_statis_enable </td><td>0: Disable<br  />
 1: Enable </td><td>Enables motion vector (MV) dump for stream. </td></tr>
<tr>
<td>stream_pic_statis_enable </td><td>0: Disable<br  />
 1: Enable </td><td>Enables picture statistic dump for stream. </td></tr>
<tr>
<td>enc_core_cfg_enable </td><td>0: Disable<br  />
 1: Enable </td><td>Enables VDSP core mode configuration. </td></tr>
<tr>
<td>enc_core_mode </td><td>0: Single VDSP core 0<br  />
 1: Single VDSP core 1<br  />
 2: VDSP dual core temporal<br  />
 3: VDSP dual core spatial </td><td>Specifies the VDSP core mode. </td></tr>
</table>
<p ><b>An Example for Stream Lua Configuration</b></p>
<div class="fragment"><div class="line">stream_0 = {</div>
<div class="line">     <span class="keywordtype">id</span> = 0,</div>
<div class="line">     max_size = {1920, 1080},</div>
<div class="line">     max_M = 1,</div>
<div class="line">     fast_seek_enable = 0,</div>
<div class="line">     two_ref_enable = 0,</div>
<div class="line">     max_svct_layers_minus_1 = 0,</div>
<div class="line">     max_num_minus_1_ltrs = 0,</div>
<div class="line">     possible_enc_src_map = 0,</div>
<div class="line">     codec_enable = 0,             -- 0: H264/H265/MJPEG; 1: H265/MJPEG; 2: H264/MJPEG; 3: MJPEG</div>
<div class="line">     efm_enable = 0,</div>
<div class="line">     efm_buf_num = 0,</div>
<div class="line">     efm_size = {0, 0},</div>
<div class="line">     efm_skip_waiting = 0,</div>
<div class="line">     efm_extern_src_enable = 0,</div>
<div class="line">     efm_extern_src_stream = 0,</div>
<div class="line">     stream_mv_statis_enable = 0,</div>
<div class="line">     stream_pic_statis_enable = 0,</div>
<div class="line">     enc_core_cfg_enable = 0,</div>
<div class="line">     enc_core_mode = 0,            --0: core0; 1:core1; 2:dual core temporal; 3:dual core spatial</div>
<div class="line">}</div>
</div><!-- fragment --><p ><br  />
</p>
<hr  />
<h1><a class="anchor" id="section_stream_example"></a>
3. Stream Examples</h1>
<h2><a class="anchor" id="example_get_bit_stream"></a>
Example 1: Get Bitstream</h2>
<dl class="section user"><dt>Hardware and Software Environment</dt><dd></dd></dl>
<p>Insert an secure digital memory (SD) card to the SD slot on the board.</p>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A statistic if the following command was not executed previously. Then, put the IAV driver into "preview" state.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)   <span class="comment">// For CV72</span></div>
</div><!-- fragment --><dl class="section user"><dt>Record a Stream to the Board</dt><dd></dd></dl>
<p>Users can record the stream with the unit test tool <em>test_stream</em>. Start test_stream with "-f" option. Then it will query the IAV driver if there is any update for all streams. It will block in the console until there is any stream in encoding state.</p>
<div class="fragment"><div class="line">board# test_stream -f /tmp/test (in console 2)</div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --><p >Wait for a period of time. Then, stop encoding stream A.</p>
<div class="fragment"><div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><p >The stream is recorded in the folder <code>/tmp</code> with the prefix "test_A".</p>
<dl class="section user"><dt>Record Streams to the SD card</dt><dd></dd></dl>
<p>The sdcard is mounted on the "/sdcard" directory by default. Users can record the stream with the unit test tool <em>test_stream</em>.</p>
<div class="fragment"><div class="line">board# test_stream -f /sdcard/test (in console 2)</div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -e</div>
</div><!-- fragment --><p >Wait for a period of time. Then, stop encoding stream A and stream B.</p>
<div class="fragment"><div class="line">board# test_encode -A -s -B -s</div>
</div><!-- fragment --><p >The streams are recorded in the folder <code>/tmp/mmcblk0p1</code> with the prefix <em>"test_A"</em> and <em>"test_B"</em>. Users can view the bit stream via VLC Player.</p>
<dl class="section user"><dt>Get Bitstream Statistic without Saving Files</dt><dd></dd></dl>
<p>Sometimes it is very helpful to start the test_stream without saving files. Because test_stream will print a lot of debug information.</p>
<p >First, ensure that none process of <em>test_stream</em> is running. Also, do not enable the RTSP server. Then start test_stream with option "--nofile".</p>
<div class="fragment"><div class="line">board# test_stream --nofile (in console 2)</div>
<div class="line">board# test_encode -A -h 1080p -e -B -h 480p -e</div>
<div class="line">board# test_encode -A -s -B -s</div>
</div><!-- fragment --><p >The debug information will be printed in console 2.</p>
<h2><a class="anchor" id="example_encoding_control"></a>
Example 2: Encoding Control</h2>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A statistic if the following command was not executed previously. Then, put the IAV driver into "preview" state.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)   <span class="comment">// For CV72</span></div>
</div><!-- fragment --><dl class="section user"><dt>Start / Stop Stream Synchronously</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h 480p  -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -e</div>
<div class="line">board# test_encode -A -s -B -s</div>
</div><!-- fragment --><dl class="section user"><dt>Start / Stop Stream Independently</dt><dd></dd></dl>
<p>Configure stream A &amp; stream B with the following command.</p>
<div class="fragment"><div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0\</div>
<div class="line">                   -B -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1</div>
</div><!-- fragment --><p >Start and stop these two streams independently.</p>
<div class="fragment"><div class="line">board# test_encode -A -e</div>
<div class="line">board# test_encode -B -e</div>
<div class="line">board# test_encode -B -s</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><dl class="section user"><dt>codec Enable</dt><dd></dd></dl>
<p>If some codec modules are turned off, it will save system resources. See <a class="el" href="../../d5/d7d/fs_basic_stream.html#anchor_codec_enable">Codec Enable in Lua</a>.</p>
<div class="fragment"><div class="line">board# test_encode -A --codec-enable 1</div>
<div class="line">board# test_encode -A -h 1080p -e</div>
<div class="line">1080p resolution is 1920x1080</div>
<div class="line">[  102.185427] check_encode_stream_type(642): Encode type cannot be set as H.264. Change <span class="stringliteral">&#39;codec enable&#39;</span> flag in the system resource!</div>
<div class="line">[  102.198275] check_encode_stream_state(677): Invalid encode type for stream A.</div>
<div class="line">board# test_encode -A -H 1080p -e</div>
</div><!-- fragment --><dl class="section user"><dt>Turn Off HEVC Hardware</dt><dd></dd></dl>
<p>Users can turn off the HEVC hardware to reduce power consumption. The following example turn off the HEVC hardware, then start an AVC stream.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua\        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">                   -X --bsize 1080p --bmaxsize 1080p\</div>
<div class="line">                   -Y --bsize 480p\</div>
<div class="line">                   -J --btype enc --bsize 720p --bmaxsize 720p</div>
<div class="line">                   --hevc-off 1</div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua\   <span class="comment">// For CV72</span></div>
<div class="line">                   -X --bsize 1080p --bmaxsize 1080p\</div>
<div class="line">                   -Y --bsize 480p\</div>
<div class="line">                   -J --btype enc --bsize 720p --bmaxsize 720p)</div>
<div class="line">                   --hevc-off 1</div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="example_choose_source_canvas"></a>
Example 3: Encode from Specified Single Canvas</h2>
<p >Choose the canvas 0 that contains main buffer for stream A 1080p, the canvas 2 that contains the third buffer for stream B 720p, and the canvas 1 that contains the second buffer for stream C.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua\        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">                   -X --bsize 1080p --bmaxsize 1080p\</div>
<div class="line">                   -Y --bsize 480p\</div>
<div class="line">                   -J --btype enc --bsize 720p --bmaxsize 720p</div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua\   <span class="comment">// For CV72</span></div>
<div class="line">                   -X --bsize 1080p --bmaxsize 1080p\</div>
<div class="line">                   -Y --bsize 480p\</div>
<div class="line">                   -J --btype enc --bsize 720p --bmaxsize 720p)</div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h  720p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 3 -e\</div>
<div class="line">                   -C -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="example_stream_resolution"></a>
Example 4: Setting up Maximum Resolution</h2>
<p >Users can set the maximum resolution for each stream via option "--smaxsize". In this example, the maximum resolutions for stream A, stream B, and stream C are 1080p, 720p, and 480p.</p>
<div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A --smaxsize 1080p\</div>
<div class="line">                   -B --smaxsize 720p\</div>
<div class="line">                   -C --smaxsize 480p</div>
<div class="line">board# test_encode -A -h 1080p -b 0 -e\</div>
<div class="line">                   -B -h  720p -b 3 -e\</div>
<div class="line">                   -C -h  480p -b 1 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="example_crop_from_canvas"></a>
Example 5: Cropping from Source Canvas</h2>
<p >In this example, stream A, stream B, and stream C are encoded from canvas 0. The size of canvas 0 is 1920x1080. To enable encoding 3 streams from the same canvas, 2 extra buffers are needed for canvas 0.</p>
<p >Modify the lua file for 2 extra buffers for canvas 0.</p>
<div class="fragment"><div class="line">canvas = {</div>
<div class="line">   {</div>
<div class="line">       type = <span class="stringliteral">&quot;encode&quot;</span>,</div>
<div class="line">       size = {0, 0}, -- min size to contain <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> buffers</div>
<div class="line">       <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.main&quot;</span>,},</div>
<div class="line">       extra_dram_buf = 2,</div>
<div class="line">   },</div>
<div class="line">   ......</div>
<div class="line">}</div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div><div class="ttdef"><b>Definition:</b> vin_init.c:57</div></div>
</div><!-- fragment --><div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 --offset 0x0 -e\</div>
<div class="line">                   -B -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 --offset 100x480 -e\</div>
<div class="line">                   -C -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 --offset 720x300 -e</div>
</div><!-- fragment --><p >Stream A is encoded with the same size FoV as canvas 0. Stream B and steam C are cropped from the cavas 0. Field of view for the 3 streams are as follows.</p>
<div class="image">
<img src="../../example_stream_crop.png" alt=""/>
<div class="caption">
Figure 3-1. Stream Cropping from Canvas.</div></div>
<h2><a class="anchor" id="example_stream_frame_rate"></a>
Example 6: Set Encoding Frame Rate</h2>
<p >Set up the system resouce limitation on the EVK board first. And then enter "Preview" state. In this example, the input framerate is set to 60.</p>
<p >Modify the lua file for 1080p60 mode.</p>
<div class="fragment"><div class="line">vsrc_0 = {</div>
<div class="line">   vsrc_id = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a> = 0,</div>
<div class="line">   mode = <span class="stringliteral">&quot;1080p&quot;</span>,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>, -- options: <span class="stringliteral">&quot;linear&quot;</span>, <span class="stringliteral">&quot;2x&quot;</span> or <span class="stringliteral">&quot;3x&quot;</span></div>
<div class="line">   fps = 60,</div>
<div class="line">   max_fps = 0,</div>
<div class="line">   vsrc_ctx_switch = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 0,</div>
<div class="line">   mirror = 0,</div>
<div class="line">   bayer = 0,</div>
<div class="line">}</div>
<div class="ttc" id="avin__init_8c_html_a847f1d2f5eba7f8c6af44233c27f71a4"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a></div><div class="ttdeci">int vsrc_status</div><div class="ttdef"><b>Definition:</b> vin_init.c:69</div></div>
<div class="ttc" id="avin__init_8c_html_a9586a0cc85ebac1f283fc9f2d94c82e2"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a></div><div class="ttdeci">int hdr_mode</div><div class="ttdef"><b>Definition:</b> vin_init.c:61</div></div>
<div class="ttc" id="avin__init_8c_html_ad1e28a1a66a25529b0b61b9ca4e66d44"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a></div><div class="ttdeci">int bits</div><div class="ttdef"><b>Definition:</b> vin_init.c:63</div></div>
</div><!-- fragment --><div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
</div><!-- fragment --><p >Then start encode stream A and stream B. By default, the frame rate of a stream is the same as the input frame rate. In this emample, frame rate of stream A and stream B are 60.</p>
<div class="fragment"><div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -e</div>
</div><!-- fragment --><p >Users can see the actual frame rate with <em>test_stream</em>. Open another console. And then, start the process test_stream to do stream statistic without saving files.</p>
<div class="fragment"><div class="line">board# test_stream --nofile</div>
<div class="line">...</div>
<div class="line">stream A:   2100 frames, 60.00 fps,   35676951   bytes,  7782 kbps, enc_pipe_time [ 2474: 2653]</div>
<div class="line">stream B:   1530 frames, 60.00 fps,   12935030   bytes,  3922 kbps, enc_pipe_time [ 2534: 2836]</div>
<div class="line">stream A:   2130 frames, 60.00 fps,   36204046   bytes,  8236 kbps, enc_pipe_time [ 2474: 2653]</div>
<div class="line">stream B:   1560 frames, 60.00 fps,   13182262   bytes,  3863 kbps, enc_pipe_time [ 2534: 2836]</div>
<div class="line">...</div>
</div><!-- fragment --><p >Adjust the frame rate of stream A and stream B on the fly.</p>
<div class="fragment"><div class="line">board# test_encode -A --frame-factor 45/60 -B --frame-factor 30/60</div>
</div><!-- fragment --><p >The frame rate of stream A will be adjusted to 45. The frame rate of stream B will be adjusted to 30. For more details, see the output information of the process test_stream.</p>
<div class="fragment"><div class="line">board# test_stream --nofile</div>
<div class="line">...</div>
<div class="line">stream A:   180 frames, 45.89 fps,   2994167   bytes,  6897 kbps, enc_pipe_time [ 2474: 2613]</div>
<div class="line">stream B:   120 frames, 30.80 fps,   1028681   bytes,  3307 kbps, enc_pipe_time [ 2536: 2670]</div>
<div class="line">stream A:   210 frames, 45.01 fps,   3464028   bytes,  5507 kbps, enc_pipe_time [ 2474: 2613]</div>
<div class="line">stream B:   150 frames, 30.00 fps,   1247731   bytes,  1711 kbps, enc_pipe_time [ 2536: 2670]</div>
<div class="line">...</div>
</div><!-- fragment --><p >By default, the frame rate will be changed immediately after rising the framerate adjusting command. However, users can apply the new frame rate until the next GOP if the option "--fps-update-mode" is set to 1.</p>
<div class="fragment"><div class="line">board# test_encode -A --frame-factor 30/60 --fps-update-mode 1</div>
</div><!-- fragment --><h2><a class="anchor" id="example_encode_duration"></a>
Example 7: Set Encoding Duration</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -d 150 -e\</div>
<div class="line">                   -B -m  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -d 120 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="example_stream_monochrome"></a>
Example 8: Monochrome Stream</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H 1080p --chrome 1 -e</div>
<div class="line">board# test_encode -A --chrome 0</div>
</div><!-- fragment --><div class="image">
<img src="../../stream_monochrome.png" alt=""/>
<div class="caption">
Figure 3-2. Monochrome Stream: a) Origin Stream b) Monochrome.</div></div>
<h2><a class="anchor" id="example_frame_drop"></a>
Example 9: Frame Drop</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H 1080p -e</div>
<div class="line">board# test_encode -A --frame-drop-repeat 1 --frame-drop 1</div>
</div><!-- fragment --><div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H 1080p -e</div>
<div class="line">board# test_encode -A --frame-drop-repeat 0 --frame-drop 10</div>
<div class="line">board# sleep 10</div>
<div class="line">board# test_encode -A --frame-drop-repeat 0 --frame-drop 4</div>
</div><!-- fragment --><h2><a class="anchor" id="example_frame_trigger"></a>
Example 10: Frame Trigger</h2>
<p >Enable the frame trigger. Then set DSP to encode one frame every time after drop one frame.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Modification of cv5_vin0_1080p_linear.lua or cv72_vin0_1080p_linear.lua file for Canvas 0 dummy latency: </p><div class="fragment"><div class="line">canvas = {</div>
<div class="line">       {</div>
<div class="line">           ...</div>
<div class="line">           enc_dummy_latency = 4,</div>
<div class="line">           ...</div>
<div class="line">       },</div>
<div class="line">       ...</div>
</div><!-- fragment --><div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -b 0 -h 1080p --trigger-frame 1 -e</div>
<div class="line">board# test_frame_sync -A --frame-trigger 1 --frame-trigger-repeat 1</div>
</div><!-- fragment --><p >Enable the frame trigger. Set DSP to encode 10 frames, then set DSP to encode 4 frames after sleeping 10 seconds.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
</div><!-- fragment --><p >Modification of cv5_vin0_1080p_linear.lua file for Canvas 0 dummy latency: </p><div class="fragment"><div class="line">canvas = {</div>
<div class="line">       {</div>
<div class="line">           ...</div>
<div class="line">           enc_dummy_latency = 4,</div>
<div class="line">           ...</div>
<div class="line">       },</div>
<div class="line">       ...</div>
</div><!-- fragment --><div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -b 0 -h 1080p --trigger-frame 1 -e</div>
<div class="line">board# test_frame_sync -A --frame-trigger 10 --frame-trigger-repeat 0</div>
<div class="line">board# sleep 10</div>
<div class="line">board# test_frame_sync -A --frame-trigger 4 --frame-trigger-repeat 0</div>
</div><!-- fragment --><p >Enable the frame trigger without the frame sync.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -h 1080p --trigger-frame 1 -e</div>
<div class="line">board# test_encode -A --trigger-frame-num 10</div>
</div><!-- fragment --><h2><a class="anchor" id="example_strict_cbr"></a>
Example 11: Strict Constant Bit Rate</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H 1080p -e</div>
<div class="line">board# test_encode -A --bc cbr --bitrate 4000000 --cbr-stable-br-adjust 1</div>
</div><!-- fragment --><h2><a class="anchor" id="example_stream_session_id"></a>
Example 12: Configure Stream Session ID</h2>
<p >Session ID is used to identify a stream session. Even though there is stream ID, a single stream might be started / stopped repeatedly at runtime. Each time it is restarted, it might be taken as a new session. When stream settings are the same between two successive sessions, it is hard for users to distinguish the bitstream between them, resulting in confusion. Specifying a different session ID when the stream is restarted can properly address this problem.</p>
<dl class="section note"><dt>Note</dt><dd>Users can specify their own session ID. If it is specified to 0, IAV will generate a random and unique session ID for it automatically.</dd></dl>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p --session-<span class="keywordtype">id</span> 1234 -e</div>
</div><!-- fragment --><h2><a class="anchor" id="example_show_stream_info"></a>
Example 13: Display System Information</h2>
<dl class="section user"><dt>Show Stream Information</dt><dd></dd></dl>
<p>Configuration of the stream can be printed to console with option "--show-stream-info". See the following example.</p>
<div class="fragment"><div class="line">board# test_encode -A -h 1080p -e</div>
<div class="line">board# test_encode --show-stream-info</div>
<div class="line">   [Encode stream info]:</div>
<div class="line">   Stream A</div>
<div class="line">               Format : H.264</div>
<div class="line">                State : encoding</div>
<div class="line">            Canvas <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> : 0</div>
<div class="line">             Duration : 0</div>
<div class="line">           Resolution : (1920x1080)</div>
<div class="line">            Encode offset : (0,0)</div>
<div class="line">               H-Flip : Disabled</div>
<div class="line">               V-Flip : Disabled</div>
<div class="line">               Rotate : Disabled</div>
<div class="line">           Session id : 1234</div>
<div class="line">             Fake AVG PTS : Disabled</div>
<div class="line">            FPS ratio : 1/1</div>
<div class="line">           <a class="code hl_defineRef" href="../../../library/d3/d5a/group__iav-common-helper.html#ga996f7be338ccb40d1a2a5abc1ad61759">ABS</a> FPS enable : Disabled</div>
<div class="line">              Abs FPS : 30</div>
<div class="line">           FPS Update : Current GOP</div>
<div class="ttc" id="agroup__iav-common-helper_html_ga996f7be338ccb40d1a2a5abc1ad61759"><div class="ttname"><a href="../../../library/d3/d5a/group__iav-common-helper.html#ga996f7be338ccb40d1a2a5abc1ad61759">ABS</a></div><div class="ttdeci">#define ABS(x)</div></div>
</div><!-- fragment --><dl class="section user"><dt>Display Resource Information</dt><dd></dd></dl>
<div class="fragment"><div class="line">board# test_encode --show-resource-info</div>
<div class="line"> </div>
<div class="line">   [System information]:</div>
<div class="line">         Encode mode : [Advanced ISO]</div>
<div class="line">   Channel vcap mode : [Disabled]</div>
<div class="line"> </div>
<div class="line">   [Codec resource limit info]:</div>
<div class="line">     max <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> of encode streams : 1</div>
<div class="line">     Stream A Max : [1920x1088], M [1].</div>
<div class="line">     Stream A fast_seek : Disabled.</div>
<div class="line">     Stream A two ref : Disabled.</div>
<div class="line">     Stream A max svct layers minus 1 : 1.</div>
<div class="line">     Stream A max num ltrs minus 1 : 0.</div>
<div class="line">     Stream A possible enc src map : 0x0.</div>
<div class="line">     Stream A codec enable : HEVC / H264 / MJPEG</div>
<div class="line"> </div>
<div class="line">     Stream A mv statis : 0.</div>
<div class="line">     Stream A pic statis : 0.</div>
<div class="line"> </div>
<div class="line">          Channel-Num : 1</div>
<div class="line">            Sharpen-B : Disabled</div>
<div class="line">              Mixer-A : Disabled</div>
<div class="line">              Mixer-B : Enabled</div>
<div class="line">          RAW capture : Disabled</div>
<div class="line">   vsync loss dummy frame : Disabled</div>
<div class="line">            ME0 scale : 1/8 X</div>
<div class="line">           HEVC STATE : Enabled</div>
<div class="line">     Vsync loss detection : Disabled</div>
<div class="ttc" id="acJSON_8h_html_a01b4671c6b7cc8f831c951c000a37735"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a></div><div class="ttdeci">const char *const const double number</div></div>
</div><!-- fragment --><h2><a class="anchor" id="example_show_encoded_order"></a>
Example 14: Encoded Frame Order</h2>
<p >When enabling B frame encoding, the encoding frame sequence would be different from the frame capture sequence.</p>
<p >For user application to query the encoded frames, it is necessary to know whether there are frame dropping behavior happened at Arm side. This can be achieved by keeping checking the frame based encoding sequence number.</p>
<p >For the example below, "frame_num" shows the frame capture (or display) order, while "encoded_frame_num" shows the frame encoding order.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h 1080p -M 3 -N 30 -e</div>
<div class="line">board# test_stream -v</div>
<div class="line">. . . .</div>
<div class="line">type=4, is_skipped 0, size=1366, addr=0x1527808, strm_id=0, sesn_id=3207481868, frame_num=290, encoded_frame_num=292,</div>
<div class="line">type=3, is_skipped 0, size=7201, addr=0x1529216, strm_id=0, sesn_id=3207481868, frame_num=294, encoded_frame_num=293,</div>
<div class="line">type=4, is_skipped 0, size=1252, addr=0x1536512, strm_id=0, sesn_id=3207481868, frame_num=292, encoded_frame_num=294,</div>
<div class="line">type=4, is_skipped 0, size=1599, addr=0x1537792, strm_id=0, sesn_id=3207481868, frame_num=293, encoded_frame_num=295,</div>
<div class="line">type=3, is_skipped 0, size=7500, addr=0x1539456, strm_id=0, sesn_id=3207481868, frame_num=297, encoded_frame_num=296,</div>
<div class="line">type=4, is_skipped 0, size=1544, addr=0x1547008, strm_id=0, sesn_id=3207481868, frame_num=295, encoded_frame_num=297,</div>
<div class="line">type=4, is_skipped 0, size=1711, addr=0x1548672, strm_id=0, sesn_id=3207481868, frame_num=296, encoded_frame_num=298,</div>
<div class="line">type=1, is_skipped 0, size=72233, addr=0x1550464, strm_id=0, sesn_id=3207481868, frame_num=300, encoded_frame_num=299,</div>
<div class="line">type=4, is_skipped 0, size=2553, addr=0x1622784, strm_id=0, sesn_id=3207481868, frame_num=298, encoded_frame_num=300,</div>
<div class="line">. . . .</div>
</div><!-- fragment --><h2><a class="anchor" id="example_hevc_width_padding"></a>
Example 15: HEVC Width Padding</h2>
<p >The encoder can improve the performance of high efficiency video coding (HEVC) encoding if the stream's width can be align to 128 or 160.</p>
<p >Enable <code>hevc_width_align_enable</code> to make DSP available to do width padding that will also align HEVC's buffer and stream width to the optimal size.</p>
<p >Here is an example of how to enable this improvement. Stream and canvas have the same option <code>hevc_width_align_enable = 1</code>, both should be enabled for the width padding.</p>
<div class="fragment"><div class="line">......</div>
<div class="line">stream_0 = {</div>
<div class="line">   ......</div>
<div class="line">   hevc_width_align_enable = 1,</div>
<div class="line">   ......</div>
<div class="line">}</div>
<div class="line">_resource_config_ = {</div>
<div class="line">  ......</div>
<div class="line">  canvas = {</div>
<div class="line">      {</div>
<div class="line">           .....</div>
<div class="line">           <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.main&quot;</span>,},</div>
<div class="line">           hevc_width_align_enable = 1,</div>
<div class="line">           .....</div>
<div class="line">      },</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p >This improvement is evident with the HEVC streams that is 5M size such as 2592x1944. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
