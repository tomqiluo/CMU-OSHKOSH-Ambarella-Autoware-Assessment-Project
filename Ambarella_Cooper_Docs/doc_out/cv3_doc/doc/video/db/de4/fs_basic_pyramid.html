<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: BASIC - Pyramid</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/de4/fs_basic_pyramid.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BASIC - Pyramid </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_pyramid_features"></a>
1. Pyramid Features</h1>
<p >CV5x / CV72 chips support pyramid generation for video content analysis (VCA), and support up to 7 layers of pyramid buffers. Each layer of pyramid can be <a class="el" href="../../db/de4/fs_basic_pyramid.html#anchor_layer_map">enable/disable</a> independently. The data format of each pyramid layer is YUV420 (NV12).</p>
<div class="image">
<img src="../../pyramid_layout_v6.png" alt=""/>
<div class="caption">
Pyramid Block Diagram</div></div>
<h2><a class="anchor" id="pyramid_input_buffer"></a>
1.1 Pyramid Input Buffer</h2>
<p >The pyramid is generated from one of the source buffers. Users can choose the <a class="el" href="../../db/de4/fs_basic_pyramid.html#anchor_input_buf">pyramid input</a> from the main buffer, or one of the sub buffers. If Layer 0 of the pyramid is enabled, data from the input buffer will be copied to the buffer of pyramid Layer 0. In addition, the size of pyramid Layer 0 is the same as the pyramid input buffer. Ambarella recommends using the sub buffer as the input for the pyramid buffer, as this can save DRAM bandwidth. </p><dl class="section note"><dt>Note</dt><dd><ul>
<li>When main buffer is specified as pyramid input buffer, it can also be used for encoding.</li>
<li>When sub source buffer is specified as pyramid input buffer, it cannot be used for neither encoding nor VOUT preview.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="pyramid_downsampling"></a>
1.2 Pyramid Downsampling Rate</h2>
<p >In addition to Layer 0, there are two types of <a class="el" href="../../db/de4/fs_basic_pyramid.html#anchor_scale_type">downsampling rate</a> to determine the pyramid sizes: For the first one, each layer width / height is 1/sqrt{2} of the previous layer's width / height; for the second one, each layer width / height is 1/2 of the previous layer's size. For example, suppose that the pyramid input buffer is the fifth buffer with the size 1280 x 720. The output of the pyramid layout is as follows.</p>
<a class="anchor" id="table_pyramid_resolution"></a>
<table class="doxtable">
<caption>Pyramid Layout Table</caption>
<tr>
<th>Layer </th><th>sqrt{2} </th><th>1/2 </th></tr>
<tr>
<td>Input </td><td colspan="2" align="center">1280 x 720 </td></tr>
<tr>
<td>Layer 0 </td><td colspan="2">1280 x 720 (<em>Same as the input buffer</em>) </td></tr>
<tr>
<td>Layer 1 </td><td align="center">906 x 510 </td><td align="center">640 x 360 </td></tr>
<tr>
<td>Layer 2 </td><td align="center">640 x 360 </td><td align="center">320 x 180 </td></tr>
<tr>
<td>Layer 3 </td><td align="center">456 x 256 </td><td align="center">160 x 90 </td></tr>
<tr>
<td>Layer 4 </td><td align="center">320 x 180 </td><td align="center">80 x 46 </td></tr>
<tr>
<td>Layer 5 </td><td align="center">228 x 128 </td><td align="center">40 x 24 </td></tr>
<tr>
<td>Layer 6 </td><td align="center">160 x 90 </td><td align="center">20 x 12 </td></tr>
</table>
<h2><a class="anchor" id="pyramid_crop"></a>
1.3 Crop from Pyramid</h2>
<p >The full size for each pyramid layer is determined by the Layer 0 size and the scale type. However, users can <a class="el" href="../../db/de4/fs_basic_pyramid.html#anchor_crop_win">specify the cropped window</a> from the full pyramid layer size. Users can also specify the ROI region as the cropped window, and perform VCA based on this ROI. (This can also save DRAM bandwidth.)</p>
<h2><a class="anchor" id="pyramid_feed_mode"></a>
1.4 Pyramid Feed Mode</h2>
<p >Each group of pyramid buffers is generated and reported to ArmÂ® by the digital signal processor (DSP), and is allocated and maintained using three different methods. Additionally, it can be configured through <a class="el" href="../../db/de4/fs_basic_pyramid.html#anchor_manual_feed">manual_feed</a> item or "ext_mem" item in the Lua script. In the pyramid auto-generation mode, pyramid buffers cannot be accessed by the VP. In the pyramid manual feed mode and pyramid external-memory mode, pyramid buffers can be accessed by the VP.</p>
<ul>
<li>
<b>Pyramid Auto-Generation Mode</b> </li>
<li>
<b>Pyramid Manual-Feed Mode</b> </li>
<li>
<b>Pyramid External-Memory Mode</b> </li>
</ul>
<p >In the pyramid auto-generation mode, DSP allocates and maintains the pyramid buffers. Each time DSP generates a group of pyramid buffers, the group is automatically reported to Arm, which uses the buffers to perform the video content analysis (VCA). However, this method has two disadvantages: <br  />
 <em> </p><ol>
<li>
When Arm receives the pyramid buffers, it copies them to additional memory to prevent data from being overwritten (in case the user's application VCA algorithm is insufficient). (DSP reuses the pyramid buffers several frames later.) Copying the data requires extra the dynamic random-access memory (DRAM) size, bandwidth, and CPU cycles. <br  />
 </li>
<li>
Because of the processing speed of the VCA algorithm, user applications typically fetch pyramid buffers at a lower fps; however, DSP generates pyramid buffers according to its own processing speed. As a result, more DRAM bandwidth are required for DSP to generate extra pyramid buffers. <br  />
 </li>
</ol>
<p></em></p>
<p >To avoid the potential disadvantages of using the pyramid auto-generation mode, Ambarella recommends using the pyramid manual-feed mode instead. The pyramid manual-feed mode enables Arm to allocate and maintain the pyramid buffers. Each time an user application requests a group of pyramid buffers, it feeds an empty group to DSP. DSP fills pyramid data into the buffers, and then reports back to Arm. Because Arm is responsible for the maintaining the pyramid buffers, not feeding them to the DSP before they have been processed is to avoid data overwriting. Additionally, Arm does not need to copy the pyramid buffers into its local memory, and it can control the feeding rate of pyramid buffers, making it unnecessary for DSP to generate pyramid buffers at the image digital signal processing (IDSP) fps. Due to these advantages, including reducing the DRAM bandwidth, Ambarella recommends using the pyramid manual-feed mode for user applications.</p>
<p >In the pyramid external-memory mode, Arm allocates the pyramid buffers and DSP maintains these pyramid buffers. These pyramid buffers can be accessed by the VP. Each time DSP generates a group of pyramid buffers, the group is automatically reported to Arm. Because of CV5x and CV72's special architecture, VP cannot access the pyramid memory in the pyramid auto-generation mode. If the user wants the DSP to maintain the pyramid buffers and also VP can access these buffers, then the pyramid external-memory mode is a good choice. <br  />
</p>
<h2><a class="anchor" id="pyramid_arbitrary_scale"></a>
1.5 Arbitrary Pyramid Size</h2>
<p >For the pyramid input, users can choose an arbitrary size instead of the input buffer size. To choose an arbitrary size, users would apply the digital zoom operation from the pyramid's input buffer to the pyramid Layer 1. The pyramid Layer 0 is the same size as the pyramid input buffer. Therefore, there are a maximum of six available pyramid layers. The latter pyramid layers size are down-sampled with the fixed ratio of 2; the ratio of sqrt{2} is no longer supported.<br  />
</p>
<p >See the following figure for a diagram of choosing an arbitrary pyramid size.</p>
<div class="image">
<img src="../../pyramid_arbitrary_size_v6.png" alt=""/>
<div class="caption">
Arbitrary Pyramid Size</div></div>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>For pyramid layers, it is only supports arbitrary downscaling from Layer 0 to Layer 1. The downscaling ratio can be various from 1/1 (inclusive) to 1/8 (exclusive).</li>
</ul>
</dd></dl>
<p>Please check <a class="el" href="../../db/de4/fs_basic_pyramid.html#lua_pyramid_configuration"><ol type="1">
<li>Pyramid Configuration</li>
</ol>
</a> for more information.<br  />
</p>
<p ><br  />
</p>
<hr  />
<h1><a class="anchor" id="lua_pyramid_configuration"></a>
2. Pyramid Configuration</h1>
<p >Users can configure the pyramid via Lua script. Here is the parameters for pyramid.<br  />
</p>
<a class="anchor" id="table_pyramid_lua"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Item </th><th><div style="width:240px"><b>Parameter</b></div> </th><th>Description </th></tr>
<tr>
<td><a class="anchor" id="anchor_input_buf"></a>input_buf_id </td><td>0: Main Buffer <br  />
 1: Second Buffer <br  />
 2: Third Buffer <br  />
 3: Fourth Buffer <br  />
 4: Fifth Buffer </td><td>Specifying the input source buffer ID in this channel. </td></tr>
<tr>
<td><a class="anchor" id="anchor_scale_type"></a>scale_type </td><td>0: Downsampled by sqrt{2} <br  />
 1: Downsampled by 2 <br  />
 2: Arbitrary Scale </td><td>Specifying the paramid downsampling rate. </td></tr>
<tr>
<td>buf_addr </td><td>Physical Address </td><td>Specifying the external buffer address in pyramid auto-generation mode. It is 0 when pyramid is from DSP internal buffer. In pyramid manual-feed mode, it must be 0 as its pyramid buffer pool is allocated by IAV driver. </td></tr>
<tr>
<td>buf_size </td><td>buf_size &gt;= 0 </td><td>In pyramid auto-generation mode, it is used to specify the total external buffer size to store all pyramid layers. It is valid only when the "buf_addr" is specified. This total buffer size should include up to 7 layers, with 4x ~ 8x for circular usage. In pyramid manual-feed mode, it can also be used to specify a fixed pyramid buffer pool size. When it is specified, IAV driver won't reallocate pyramid buffer pool again even if the really required pool size is changed. </td></tr>
<tr>
<td><a class="anchor" id="anchor_frame_rate"></a>frame_rate </td><td>0 &lt;= frame_rate &lt;= idsp_fps </td><td>Specify the pyramid frame rate, it must be less than idsp_fps. (This feature is not yet supported.) </td></tr>
<tr>
<td><a class="anchor" id="anchor_manual_feed"></a>manual_feed </td><td>0: Pyramid Auto-generation Mode <br  />
 1: Pyramid Manual-feed Mode </td><td>Enable pyramid manual-feed mode. </td></tr>
<tr>
<td>item_num </td><td>[4, 12] </td><td>Specifying the number of the manual feed or external buffers. This value should be in the range of [4, 12]. If lower than 4, it will be set to 4 by IAV driver. If higher than 12, it will be set to 12 by IAV driver. If value is 0, it will be set to the default value 6.<br  />
 </td></tr>
<tr>
<td>rescale_size </td><td>{width, height} </td><td>Specifying rescale size for pyramid Layer 1. The scale ratio of width or height from Layer 0 to Layer 1 must be in the range of <b>1X to 8X (Downscale)</b>. The scale ratio from Layer N(N = 1 ~ 5) to Layer N+1 is fixed to 2X (Downscale). Only valid when <b>"scale_type == IAV_PYRAMID_SCALE_ARBITRARY"</b>.<br  />
 </td></tr>
<tr>
<td>max_rescale_size </td><td>{width, height} </td><td>Specifying max rescale size for pyramid Layer 1. Used to set the max rescale size of pyramid Layer 1, <b>"rescale_size"</b> must be within <b>"max_scale_size"</b>. Only valid when <b>"scale_type == IAV_PYRAMID_SCALE_ARBITRARY"</b>.<br  />
 </td></tr>
<tr>
<td><a class="anchor" id="anchor_layer_map"></a>layer_map </td><td>Bits map </td><td>Specifying bits map for pyramid layers, one bit for one layer (eg. bit 0 means layer 0, bit 1 means layer 1, ... , bit 6 means layer 6), can be changed dynamically. To enable all 7 layers, set this value to 0x7F. </td></tr>
<tr>
<td>max_layer_map </td><td>Bits map </td><td>Specifying max bits map for pyramid layers, one bit for one layer (eg. bit 0 means layer 0, bit 1 means layer 1, ... , bit 6 means layer 6), can only be changed before entering preview. <b>"layer_map"</b> must be within <b>"max_layer_map"</b>.<br  />
 </td></tr>
<tr>
<td><a class="anchor" id="anchor_crop_win"></a>crop_win </td><td>{offset_x, offset_y, width, height} </td><td>Specifying the output window of pyramid buffer from each layer. The default value {0,0,0,0} means the pyramid layer's active window without cropping, rather than the window with size 0x0. </td></tr>
<tr>
<td><a class="anchor" id="anchor_enable_frame_tag"></a>enable_frame_tag </td><td>0: disable<br  />
 1: enable </td><td>Enable pyramid frame-tag. </td></tr>
<tr>
<td><a class="anchor" id="anchor_frame_tag_value"></a>frame_tag_value </td><td>[0, 0xFFFFFFFF] </td><td>Specifying frame tag value. Only valid when enable_frame_tag is enabled. </td></tr>
<tr>
<td><a class="anchor" id="anchor_frame_tag_mask"></a>frame_tag_mask </td><td>[0, 0xFFFFFFFF] </td><td>Specifying bitmask of frame tag. Only valid when enable_frame_tag is enabled. Note: frame_tag_mask must meet the condition: frame_tag_mask &amp; frame_tag_value = frame_tag_value. </td></tr>
<tr>
<td><a class="anchor" id="anchor_ext_mem"></a>ext_mem </td><td>0(Default): disable<br  />
 1: enable </td><td>is used to enable pyramid external memory mode. Set to 1 to enable pyramid external memory. </td></tr>
</table>
<p ><b>An Example for Pyramid Lua Configuration</b><br  />
</p>
<div class="fragment"><div class="line">pyramid = {</div>
<div class="line">   input_buf_id = 2,     -- 0: Main, 1: Second, 2: Third, 3: Fourth, 4: Fifth</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a> = 0,       -- 0: 1/sqrt(2); 1: 1/2; 2: Arbitrary size</div>
<div class="line">   buf_addr = 0x0,</div>
<div class="line">   buf_size = 0x0,</div>
<div class="line">   manual_feed = 0,</div>
<div class="line">   item_num = 0,</div>
<div class="line">   layer_map = 0x2A,</div>
<div class="line">   layers = {</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0, 0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">         crop_win = {0, 0, 0 ,0},</div>
<div class="line">      },</div>
<div class="line">   },</div>
<div class="line">},</div>
<div class="ttc" id="avin__init_8c_html_a12db301b040a15818f8d32874c312444"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a></div><div class="ttdeci">int scale_type</div><div class="ttdef"><b>Definition:</b> vin_init.c:77</div></div>
</div><!-- fragment --><p >See <a class="el" href="../../d8/dab/fs_adv_lua.html">Configure with Lua Script</a>.</p>
<p ><br  />
</p>
<hr  />
<h1><a class="anchor" id="section_pryamid_example"></a>
3. Pyramid Examples</h1>
<h2><a class="anchor" id="example_pyramid_data_capture"></a>
Example 1: Pyramid Data Capture</h2>
<p >Pyramid can be captured by user application. Here pyramid data from Layer 0 to Layer 6 will be captured by <em>test_yuvcap</em>.<br  />
</p>
<p >The following is the resource configuration. </p><a class="anchor" id="table_pyramid_scale"></a>
<table class="doxtable">
<caption>Resource Configure</caption>
<tr>
<th>Item </th><th><div style="width:500px"><b>Description</b></div> </th></tr>
<tr>
<td>Sensor </td><td>IMX274_MIPI 3840 x 2160 </td></tr>
<tr>
<td>Pyramid Input </td><td>Third Buffer 1920 x 1080 </td></tr>
<tr>
<td>Scale Type </td><td>scale_type = 0. Pyramid downsampling ratio will be sqrt{2}. </td></tr>
<tr>
<td>Feed Mode </td><td>manual_feed = 0. Auto-genetation mode. </td></tr>
<tr>
<td>Pyramid Layer Map </td><td>layer_map = 0x7F. Enable the pyramid from Layer 0 to Layer 6. </td></tr>
</table>
<p>Test steps are as follows.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        // For CV5 or CV52</div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)            // For CV72</div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# *here you need to modify Lua script as described above.*</div>
<div class="line">board# test_encode --resource-cfg pyramid.lua</div>
<div class="line">board# test_yuvcap -c 0 -P 0~6 -f cap_pyramid</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 0 for chan 0 resolution 1920x1080 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 1 for chan 0 resolution 1360x770 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 2 for chan 0 resolution 960x540 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 3 for chan 0 resolution 680x386 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 4 for chan 0 resolution 480x270 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 5 for chan 0 resolution 340x194 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 6 for chan 0 resolution 240x136 in NV12 format</div>
</div><!-- fragment --><p >The following is a full set of the captured pyramid.</p>
<div class="image">
<img src="../../example_capture_pyramid_archv6.png" alt=""/>
<div class="caption">
Capture Pyramid Data</div></div>
<h2><a class="anchor" id="example_pyramid_manual_feed"></a>
Example 2: Pyramid Manual Feed</h2>
<p >In lua file, pyramid parameters "manual_feed" and "item_num" should be set to support feeding the pyramid manually. The following is the resource configuration.</p>
<a class="anchor" id="table_pyramid_scale"></a>
<table class="doxtable">
<caption>Resource Configure</caption>
<tr>
<th>Item </th><th><div style="width:500px"><b>Description</b></div> </th></tr>
<tr>
<td>Sensor </td><td>IMX274_MIPI 1920 x 1080 </td></tr>
<tr>
<td>Pyramid Input </td><td>Main Buffer 1920 x 1080 </td></tr>
<tr>
<td>Scale Type </td><td>scale_type = 1. Pyramid downsampling ratio will be 2. </td></tr>
<tr>
<td>Feed Mode </td><td>manual_feed = 1. Enable pyramid manual feed </td></tr>
<tr>
<td>Pyramid Buffer Item </td><td>item_num = 6. Buffer alloced by IAV for pyramid manual feed are set to 6. </td></tr>
<tr>
<td>Pyramid Layer Map </td><td>layer_map = 0x2f. Enable pyramid Layer0, Layer1, Layer2, Layer3, and Layer5. </td></tr>
</table>
<p >Test steps are as follows. As well as the Lua script can be found <a href="../../script/pyramid_manual_feed.lua" target="_blank"><b>here</b></a>. Put the script in the same folder where you launch the <em> test_encode </em> command.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)            <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# *here you need to modify Lua script as described above.*</div>
<div class="line">board# test_encode --resource-cfg pyramid_manual_feed.lua</div>
<div class="line">board# test_manual_feed -c 0 -q 1</div>
<div class="line">Pyramid buffer pool phys_addr 0xf1100000 map to virt_addr 0x7f8c360000, with total size 0x24e4000.</div>
<div class="line">Chan_0 Pyramid Layer 0: pts = 0, y_data = 0x7f8c360000, uv_data = 0x7f8c779280, dma_buf_fd = -1.</div>
<div class="line">Chan_0 Pyramid Layer 0: pts = 0, y_data = 0x7f8c986000, uv_data = 0x7f8cd9f280, dma_buf_fd = -1.</div>
<div class="line">Chan_0 Pyramid Layer 0: pts = 0, y_data = 0x7f8cfac000, uv_data = 0x7f8d3c5280, dma_buf_fd = -1.</div>
<div class="line">Chan_0 Pyramid Layer 0: pts = 0, y_data = 0x7f8d5d2000, uv_data = 0x7f8d9eb280, dma_buf_fd = -1.</div>
<div class="line"> </div>
<div class="line">...</div>
</div><!-- fragment --><h2><a class="anchor" id="example_pyramid_arbitrary_scale"></a>
Example 3: Pyramid Arbitrary Scale</h2>
<p >In this example Ambarella uses IMX274_MIPI with 4K input resolution. Pyramid input is main buffer, which has a 4K output resolution. Then the pyramid Layer 1 is re-scaled from 4K to 720p. </p><a class="anchor" id="table_pyramid_scale"></a>
<table class="doxtable">
<caption>Resource Configure</caption>
<tr>
<th>Item </th><th><div style="width:500px"><b>Description</b></div> </th></tr>
<tr>
<td>Sensor </td><td>IMX274_MIPI 3840 x 2160 </td></tr>
<tr>
<td>Pyramid Input </td><td>Main Buffer 3840 x 2160 </td></tr>
<tr>
<td>Scale Type </td><td>scale_type = 2. Apply pyramid arbitraty scale, and the downsampling ratio will be 2. </td></tr>
<tr>
<td>Pyramid Rescale Size </td><td>rescale_size = {1280, 720}. Pyramid Layer 1 will be re-scaled to 720p. </td></tr>
<tr>
<td>Pyramid Layer Map </td><td>layer_map = 0x7F. Enable the pyramid from layer 0 to layer 6. </td></tr>
</table>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)            <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# *here you need to modify Lua script as described above.*</div>
<div class="line">board# test_encode --resource-cfg pyramid_arbitrary_scale.lua</div>
<div class="line">board# test_yuvcap -c 0 -P 0~6 -f cap_pyramid</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 0 <span class="keywordflow">for</span> chan 0 resolution 3840x2160 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 1 <span class="keywordflow">for</span> chan 0 resolution 1280x720 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 2 <span class="keywordflow">for</span> chan 0 resolution 640x360 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 3 <span class="keywordflow">for</span> chan 0 resolution 320x180 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 4 <span class="keywordflow">for</span> chan 0 resolution 160x90 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 5 <span class="keywordflow">for</span> chan 0 resolution 80x46 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 6 <span class="keywordflow">for</span> chan 0 resolution 40x24 in NV12 format</div>
</div><!-- fragment --><p >In this case, Layer 0 is copied from the input buffer. The size of Layer 0 is the same as the output of the input buffer. Then Layer 1 is re-scaled from 4K to 720p. After that each layers will be down-sampled with the ratio of 2.<br  />
.</p>
<h2><a class="anchor" id="example_change_pyramid_configurations"></a>
Example 4: Change Pyramid Rescale Size and Layer Map Dynamically.</h2>
<p >This example shows the method on how to change the rescale size from 1080p to 720p, and the layer map from "0x1f" to "0x3f" dynamically.</p>
<p >In this example, the initial pyramid configurations are set as shown in the following table when entering the preview state.</p>
<a class="anchor" id="table_pyramid_configuration"></a>
<table class="doxtable">
<caption>Preview Resource Configuration</caption>
<tr>
<th>Item </th><th><div style="width:500px"><b>Description</b></div> </th></tr>
<tr>
<td>Sensor </td><td>IMX274_MIPI 3840 x 2160 </td></tr>
<tr>
<td>Pyramid Input </td><td>Main Buffer 3840 x 2160 </td></tr>
<tr>
<td>Scale Type </td><td>scale_type = 2. Apply pyramid arbitraty scale, and downsampling ratio will be 2. </td></tr>
<tr>
<td>Pyramid Rescale Size </td><td>max_rescale_size = {1920, 1080}. Pyramid Layer 1 size should no greater than 1920x1080.<br  />
 rescale_size = {1920, 1080}. Pyramid Layer 1 will be re-scaled to 1080p. </td></tr>
<tr>
<td>Pyramid Layer Map </td><td>max_layer_map = 0x3F. Only layers within max layers map can be turned on/off dynamically.<br  />
 layer_map = 0x1F. Enable the pyramid from Layer 0 to Layer 4. </td></tr>
</table>
<p >After entering the preview state, users can change the pyramid rescale size and the layer map dynamically. As an example in following table, the pyramid rescale size is updated to 720p, and the layer map is updated to "0x3f".</p>
<a class="anchor" id="table_pyramid_configuration"></a>
<table class="doxtable">
<caption>Target Resource Configuration</caption>
<tr>
<th>Item </th><th><div style="width:500px"><b>Description</b></div> </th></tr>
<tr>
<td>Pyramid Rescale Size </td><td>rescale_size = {1280, 720}. Pyramid Layer 1 will be re-scaled to 720p. </td></tr>
<tr>
<td>Pyramid Layer Map </td><td>layer_map = 0x3F. Enable the pyramid from Layer 0 to Layer 5. </td></tr>
</table>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)            <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# *here you need to modify Lua script as described above.*</div>
<div class="line">board# test_encode --resource-cfg pyramid_change_rescale_size_and_layer_map.lua</div>
<div class="line">board# test_multi_chan -c 0 --prescalesize 1280x720 --pLayers 0x3f</div>
<div class="line">board# test_yuvcap -c 0 -P 0~6 -f cap_pyramid</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 0 <span class="keywordflow">for</span> chan 0 resolution 3840x2160 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 1 <span class="keywordflow">for</span> chan 0 resolution 1280x720 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 2 <span class="keywordflow">for</span> chan 0 resolution 640x360 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 3 <span class="keywordflow">for</span> chan 0 resolution 320x180 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 4 <span class="keywordflow">for</span> chan 0 resolution 160x90 in NV12 format</div>
<div class="line">Capture_Pyramid_buffer: Pyramid layer 5 <span class="keywordflow">for</span> chan 0 resolution 80x46 in NV12 format</div>
<div class="line">Pyramid <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> 0: layer 6 is not switched on</div>
<div class="ttc" id="avin__init_8c_html_adf7dff2c57c0da9a4a2b70e3e815be31"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a></div><div class="ttdeci">int channel</div><div class="ttdef"><b>Definition:</b> vin_init.c:56</div></div>
</div><!-- fragment --><h2><a class="anchor" id="example_pyramid_external_mem"></a>
Example 5: Pyramid External Memory</h2>
<p >Here is an example for used external memory for pyramid. As well as the Lua script can be found <a href="../../script/pyramid_ext_mem.lua" target="_blank"><b>here</b></a>.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)            <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a &amp;</div>
<div class="line">board# test_encode --resource-cfg pyramid_ext_mem.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
