<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: ADVANCED - Configure with Lua Script</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/dab/fs_adv_lua.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">ADVANCED - Configure with Lua Script </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="lua_lua"></a>
1. Introduction to Lua Configuration</h1>
<p >For a specific product design, user applications must configure the various resource and layout settings, including video input (VIN) (multi-VIN), canvas, stream, and video output (VOUT). In order to make the parameters easier to parse, the Lua script file is introduced as the configuration file for these resource and layout settings. The Lua script improves the organization of parameters and multi-VIN design options. This Lua script format is an excellent reference for users to configure their own implementation and file formats to organize these options.</p>
<p >Generally, a Lua script is comprised of five main sections:</p>
<ul>
<li>
<b>Video source (VSRC) configuration:</b> Each sensor (either an RGB sensor, such as "IMX274", or a YUV input device, such as "Lt6911") is enumerated as a "VSRC" instance. In the Lua script, all sensor-related configurations are included in this section. </li>
<li>
<b>Channel configuration:</b> A channel is an independent unit for the image digital signal processor (IDSP) to process image data generated by "VSRC" (sensor). Each channel possesses its own 3A parameters, including a different IDSP pipeline. It also has a set of source buffers (main / second / third /...) and its own Pyramid buffers. In the Lua script, all channel-related configurations are included in this section. </li>
<li>
<b>Canvas configuration:</b> The canvas maintains the channels' source buffers. It can be either outputed through video output (VOUT) or encoded to streams. User applications can combine the field of view (FoV) of each channel's source buffer together into one canvas so that the stream encoded from this canvas can cover several FoVs from different VIN channels. Alternatively, each source buffer can have its own canvas. </li>
<li>
<b>Stream configuration:</b> Canvases can be encoded as streams with various stream numbers and configurations. In the Lua script, all stream-related configurations are included in this section. </li>
<li>
<b>Resource:</b> All configurations mentioned above will be collected into this section. </li>
</ul>
<hr  />
<h1><a class="anchor" id="lua_vsrc_cfg"></a>
2. VSRC Configuration</h1>
<h2><a class="anchor" id="lua_vsrc_cfg_common"></a>
2.1 VSRC Common Configuration</h2>
<a class="anchor" id="vsrc_cfg"></a>
<table class="doxtable">
<caption>Table 2-1. VSRC Common Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>vsrc_id</b> </td><td>Specify the sensor input ID. Ambarella suggests keeping the same value as a sensor index, which is automatically generated during sensor driver probing and corresponds to a real sensor </td></tr>
<tr>
<td><b>vsrc_status</b> </td><td>Specify if the sensor is active or broken / not connected </td></tr>
<tr>
<td><b>mode</b> </td><td>Specify the sensor resolutions </td></tr>
<tr>
<td><b>hdr_mode</b> </td><td>Specify the HDR mode or linear mode, such "linear", "2x", "3x" or wide dynamic range "wdr" </td></tr>
<tr>
<td><b>fps</b> </td><td>Specify the sensor framerate </td></tr>
<tr>
<td><b>vsrc_ctx_switch</b> </td><td>Enable vsrc_ctx by switching the VIN driver. It is required for some sensors, such as AR0230 and AR0237, which can support multiple register groups of the shutter and active gain contol (AGC) (vsrc_ctx), but must switch among them manually via the VIN driver </td></tr>
<tr>
<td><b>bits</b> </td><td>Specify the sensor RGB bits. 0 for AUTO, 8 ~ 16 for specified bits </td></tr>
<tr>
<td><b>mirror</b> </td><td>Specify the sensor mirror pattern. 0: none, 1: flip, 2: mirror, 3: mirror and flip, 255: AUTO </td></tr>
<tr>
<td><b>bayer</b> </td><td>Specify the sensor Bayer pattern. 0: RG, 1: BG, 2: GR, 3: GB, 255: AUTO </td></tr>
<tr>
<td><b>scale_type</b> </td><td>Specify the VIN scale type. 0: no scale, 1: 1/2 for both width and height, 2: 1/4 for width and 1/2 for height, 3: 1/2 only for width, 4: 1/4 only for width, the default is 0. </td></tr>
<tr>
<td><b>roi_enable</b> </td><td>Flag to enable ROI VIN </td></tr>
<tr>
<td><b>roi_list</b> </td><td>Specifies the crop window of each ROI VIN </td></tr>
</table>
<p ><b>Example</b><br  />
 </p><div class="fragment"><div class="line">vsrc_0 = {</div>
<div class="line">   vsrc_id = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a> = 0,</div>
<div class="line">   mode = <span class="stringliteral">&quot;1080p&quot;</span>,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>, -- options: <span class="stringliteral">&quot;linear&quot;</span>, <span class="stringliteral">&quot;2x&quot;</span> or <span class="stringliteral">&quot;3x&quot;</span></div>
<div class="line">   fps = 30,</div>
<div class="line">   vsrc_ctx_switch = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 0,</div>
<div class="line">   mirror = 0,</div>
<div class="line">   bayer = 0,</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">vsrc_1 = {</div>
<div class="line">   vsrc_id = 1,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a> = 0,</div>
<div class="line">   mode = <span class="stringliteral">&quot;3840x2160&quot;</span>,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>, -- options: <span class="stringliteral">&quot;linear&quot;</span>, <span class="stringliteral">&quot;2x&quot;</span> or <span class="stringliteral">&quot;3x&quot;</span></div>
<div class="line">   fps = 30,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 0,</div>
<div class="line">   vsrc_ctx_switch = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 0,</div>
<div class="line">   mirror = 0,</div>
<div class="line">   bayer = 0,</div>
<div class="line">}</div>
<div class="ttc" id="avin__init_8c_html_a847f1d2f5eba7f8c6af44233c27f71a4"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a></div><div class="ttdeci">int vsrc_status</div><div class="ttdef"><b>Definition:</b> vin_init.c:69</div></div>
<div class="ttc" id="avin__init_8c_html_a9586a0cc85ebac1f283fc9f2d94c82e2"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a></div><div class="ttdeci">int hdr_mode</div><div class="ttdef"><b>Definition:</b> vin_init.c:61</div></div>
<div class="ttc" id="avin__init_8c_html_ad1e28a1a66a25529b0b61b9ca4e66d44"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a></div><div class="ttdeci">int bits</div><div class="ttdef"><b>Definition:</b> vin_init.c:63</div></div>
</div><!-- fragment --><p ><br  />
 </p>
<h2><a class="anchor" id="lua_src_virtual_cfg"></a>
2.2 Custom Virtual VIN Mode Configuration</h2>
<a class="anchor" id="virt_mode_cfg"></a>
<table class="doxtable">
<caption>Table 2-2. Custom Virtual VIN Mode Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>width</b> </td><td>VSRC output window width </td></tr>
<tr>
<td><b>height</b> </td><td>VSRC output window height </td></tr>
<tr>
<td><b>hdr_mode</b> </td><td>Specify HDR mode for the virtual sensor </td></tr>
<tr>
<td><b>default_fps</b> </td><td>Specify the default frame rate of the virtual sensor </td></tr>
<tr>
<td><b>max_fps</b> </td><td>Specify the maximum frame rate of the virtual sensor </td></tr>
<tr>
<td><b>bits</b> </td><td>Specify the virtual sensor RGB bits </td></tr>
<tr>
<td><b>hdr_offset_long</b> </td><td>Line offset of the longest exposure frame </td></tr>
<tr>
<td><b>hdr_offset_short1</b> </td><td>Line offset of the medium exposure frame </td></tr>
<tr>
<td><b>hdr_offset_short2</b> </td><td>Line offset of the above-medium exposure frame </td></tr>
<tr>
<td><b>hdr_offset_short3</b> </td><td>Line offset of the shortest exposure frame </td></tr>
<tr>
<td><b>sensor_id</b> </td><td>Specify the sensor_id of the virtual sensor </td></tr>
<tr>
<td><b>agc_db_step</b> </td><td>Specify the agc_db_step of the virtual sensor </td></tr>
<tr>
<td><b>dual_gain_mode</b> </td><td>Flag to indicate if the current VIN supports dual-gain mode </td></tr>
<tr>
<td><b>video_type</b> </td><td>Specify the virtual sensor video type </td></tr>
</table>
<p ><b>Example for Virtual VIN Mode Lua Configuration:</b><br  />
</p>
<div class="fragment"><div class="line">virt_mode_cfg_0 = {</div>
<div class="line">    <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> = 1920,</div>
<div class="line">    <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a> = 1080,</div>
<div class="line">    <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 12,</div>
<div class="line">    max_fps = 30,</div>
<div class="line">    default_fps = 30,</div>
<div class="line">    <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>,</div>
<div class="line">    video_type = <span class="stringliteral">&quot;rgb_raw&quot;</span>, -- options: <span class="stringliteral">&quot;yuv_601&quot;</span>, <span class="stringliteral">&quot;yuv_656&quot;</span>, <span class="stringliteral">&quot;rgb_601&quot;</span>, <span class="stringliteral">&quot;rgb_656&quot;</span>, <span class="stringliteral">&quot;rgb_raw&quot;</span>, <span class="stringliteral">&quot;yuv_bt1120&quot;</span>, <span class="stringliteral">&quot;rgb_bt1120&quot;</span></div>
<div class="line">    sensor_id = 0x3014,</div>
<div class="line">    agc_db_step = 0x00180000,</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">vsrc_0 = {</div>
<div class="line">   vsrc_id = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a847f1d2f5eba7f8c6af44233c27f71a4">vsrc_status</a> = 0,</div>
<div class="line">   mode = <span class="stringliteral">&quot;1080p&quot;</span>,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>, -- options: <span class="stringliteral">&quot;linear&quot;</span>, <span class="stringliteral">&quot;2x&quot;</span> or <span class="stringliteral">&quot;3x&quot;</span></div>
<div class="line">   fps = 30,</div>
<div class="line">   vsrc_ctx_switch = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 0,</div>
<div class="line">   <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a74dbe65312dc9cdc765d66ddf85aa5cd">virt_mode_cfg_enable</a> = 1,</div>
<div class="line">   virt_mode_cfg = virt_mode_cfg_0,</div>
<div class="line">}</div>
<div class="ttc" id="agroup__IAV_html_ga85db88ffee2944ecd35c616393976289"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div><div class="ttdeci">u32 width</div></div>
<div class="ttc" id="agroup__IAV_html_gadd40f8a56ae8cc650f92a3aa4d2bac99"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a></div><div class="ttdeci">u32 height</div></div>
<div class="ttc" id="avin__init_8c_html_a74dbe65312dc9cdc765d66ddf85aa5cd"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a74dbe65312dc9cdc765d66ddf85aa5cd">virt_mode_cfg_enable</a></div><div class="ttdeci">int virt_mode_cfg_enable</div><div class="ttdef"><b>Definition:</b> vin_init.c:75</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="lua_chan_cfg"></a>
3. Channel Configuration</h1>
<a class="anchor" id="chan_cfg"></a>
<table class="doxtable">
<caption>Table 3-1. Channel Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>id</b> </td><td>Specify the channel ID. Ambarella recommends that users keep the same value as the channel index starting from zero </td></tr>
<tr>
<td><b>vsrc</b> </td><td>Specify the channel VSRC. The content must be declared before the channel definition in the Lua script </td></tr>
<tr>
<td><b>idsp_fps</b> </td><td>Specify the resample IDSP output framerate </td></tr>
<tr>
<td><b>idsp_fps_locked_enable</b> </td><td>Enable locking IDSP output framerate. If it is disabled, idsp_fps is updated proportionally when the VIN framerate is changed at runtime. While it is enabled, idsp_fps will remain constant, regardless of how the VIN framerate is changed </td></tr>
<tr>
<td><b>vsrc_ctx</b> </td><td>Specify the sensor register context of the VSRC for the channel. It only functions for some sensors, such as AR0230, which support multiple register groups for shutter and AGC </td></tr>
<tr>
<td><b>use_vsrc_ctx_pattern</b> </td><td>Specify if the IDSP splits the VIN frame into the current channel according to its "vsrc_ctx_pattern" </td></tr>
<tr>
<td><b>vsrc_ctx_pattern</b> </td><td>Specify the data pattern, which is embedded in the first line of sensor data </td></tr>
<tr>
<td><b>vsrc_ctx_pattern_mask</b> </td><td>Specify valid bits in "vsrc_ctx_pattern" </td></tr>
<tr>
<td><b>sensor_ctrl</b> </td><td>Tells the sensor driver which channel is allowed to configure the shutter and AGC. It is only used for special "IDSP virtual channel" cases </td></tr>
<tr>
<td><b>img_stats_src_chan</b> </td><td>Tells the 3A process which channel's statistics are used to perform 3A control for the channel. It is used for multi-channel stitching and IDSP virtual channel cases </td></tr>
<tr>
<td><b>app_img_profile</b> </td><td>Specify 3A image profile mode. 0: IPC, 1: BWC, 2: ITS, 3: DVR, 4: DMS, 5: ADAS, 6: OMC, 7: eMIRROR </td></tr>
<tr>
<td><b>packing_mode_enable</b> </td><td>Enable VIN packing mode only when VIN RAW compression is disabled to save dynamic random-access memory (DRAM) bandwidth </td></tr>
<tr>
<td><b>raw_capture</b> </td><td>Enable capture of RAW data or RAW slice data from the RGB sensor. Users can get more information from the help message of the unit test application, test_yucap </td></tr>
<tr>
<td><b>ext_mem</b> </td><td>Enable RAW external memory </td></tr>
<tr>
<td><b>raw_manual_feed</b> </td><td>Enable RAW manual feed </td></tr>
<tr>
<td><b>raw_feed_frame_num</b> </td><td>Specify the RAW feed buffer number </td></tr>
<tr>
<td><b>raw_cached_items</b> </td><td>Specify the RAW cache buffer number. The system will not discard RAW data immediately but place it in the cache buffer if raw_cached_items &gt; 0. This provides users with a greater time margin to query it </td></tr>
<tr>
<td><b>raw_slice_num</b> </td><td>Specify the captured number of RAW slice data. If raw_slice_num &gt; 1, it will be enabled, and raw_slice_num should be in range [1, 8]. </td></tr>
<tr>
<td><b>raw_slice_cached_items</b> </td><td>Specify the RAW slice cache buffer number. The system will not discard RAW slice data immediately but place it in the cache buffer if raw_slice_num &gt; 1. This provides users with a greater time margin to query it </td></tr>
<tr>
<td><b>y12_enable</b> </td><td>Enable C2Y Y12 output </td></tr>
<tr>
<td><b>y12_cached_items</b> </td><td>Specify Y12 cached items for user to query with blocking call </td></tr>
<tr>
<td><b>mctf_cmpr</b> </td><td>Enable motion-compensated temporal filtering (MCTF) compression </td></tr>
<tr>
<td><b>expo_num</b> </td><td>Specify the DOLHDR exposure frames number </td></tr>
<tr>
<td rowspan="8"><b>vcap_mode_flags</b> </td><td>Specify vcap_mode for each channel. The following are the vcap modes for different cases: </td></tr>
<tr>
<td>0x00: Advanced ISO mode. This is the mode for lowest latency from VIN to VOUT </td></tr>
<tr>
<td>0x05: Line-interleaved HDR mode. This is the mode for 3X HDR and multi-pass scale </td></tr>
<tr>
<td>0x08: Image Pipeline Only mode. This is the mode for EIS source channel </td></tr>
<tr>
<td>0x09: AI ISP mode. This is the mode for AI ISP </td></tr>
<tr>
<td>0x0B: Custom AI ISP mode. This is the mode for Custom AI ISP </td></tr>
<tr>
<td>0x7F: Mode none. This is the mode to skip ISP processing for current channel </td></tr>
<tr>
<td>0x80: Automatic mode. This flag enables vcap_mode_flags to follow encode_mode </td></tr>
<tr>
<td><b>vsrc_region_num</b> </td><td>Specify the total region number of the source sensor. Multiple vsrc_region must be stored in line-interleaved format in sensor data </td></tr>
<tr>
<td><b>vsrc_region_map</b> </td><td>Specify region index map from which the current channel captures the sensor data </td></tr>
<tr>
<td><b>enable_group</b> </td><td>Enable channel grouping </td></tr>
<tr>
<td><b>group_idx</b> </td><td>Specify channel group index </td></tr>
<tr>
<td><b>group_order_idx</b> </td><td>Specify channel order idx inside the group with the group index "group_idx" </td></tr>
<tr>
<td><b>group_sync</b> </td><td>Enable group synchronization among channels of same group Only valid when "group_enable" and "group_idx" are set </td></tr>
<tr>
<td><b>reuse_src_chan_iso_cfg</b> </td><td>Reuse ISO cfg from its source channel for current channel </td></tr>
<tr>
<td><b>extra_iso_cfg</b> </td><td>Specify the extra ISO cfg num for current channel </td></tr>
<tr>
<td><b>lens_warp</b> </td><td>Enable the lens distortion correction (LDC) function </td></tr>
<tr>
<td><b>max_padding_width</b> </td><td>Specify the padding width at C2Y stage (RAW processing stage) for LDC on this channel It must function with the "lens_warp" option </td></tr>
<tr>
<td><b>max_warp_input_width</b> </td><td>Specify the maximum input width for dewarp </td></tr>
<tr>
<td><b>max_warp_output_width</b> </td><td>Specify the maximum output width for dewarp </td></tr>
<tr>
<td><b>max_vwarp_wait_lines</b> </td><td>Specify the waiting lines for vwarp </td></tr>
<tr>
<td><b>max_vwarp_blk_height</b> </td><td>Specify maximum vwarp block height for LDC use case </td></tr>
<tr>
<td><b>rotate_cw</b> </td><td>Enable 90-degree clockwise rotation </td></tr>
<tr>
<td><b>hflip</b> </td><td>Enable horizontal flipping </td></tr>
<tr>
<td><b>vflip</b> </td><td>Enable vertical flipping </td></tr>
<tr>
<td><b>extra_downscale</b> </td><td>Enable the large down-scale. When the downscale ratio is larger than or equal than 6X, it should be set to 1 </td></tr>
<tr>
<td><b>eis_delay_count</b> </td><td>Specify electronic image stabilization (EIS) delay frame number before IDSP pipeline for each channel </td></tr>
<tr>
<td><b>raw_src_chan</b> </td><td>Specify RAW source channel for EIS channel. For EIS, it is implemented with dual channels </td></tr>
<tr>
<td><b>c2y_burst_tile</b> </td><td>Enable C2Y burst tile mode. By default, it is 1 </td></tr>
<tr>
<td><b>max_main_input_width</b> </td><td>Specify the maximum main buffer input width. It can help the DSP to allocate the proper resources from various cases. It must be configured when the user application requires a small main buffer input size (such as 720x480) with a large VIN size (such as 3840x2160). If it is set, the main buffer input width cannot exceed it through the run-time update during Preview / Encoding </td></tr>
<tr>
<td><b>slice_cfg_enable</b> </td><td>Enable slice-related configurations </td></tr>
<tr>
<td><b>slice_num</b> </td><td>Specify the slice number at the Y2Y stage (YUV domain processing stage). Only valid when "slice_cfg_enable" is enabled </td></tr>
<tr>
<td><b>slice_width</b> </td><td>Specify single-slice width at the Y2Y stage (YUV domain processing stage). Only valid when "slice_cfg_enable" is enabled </td></tr>
<tr>
<td><b>warp_padding_width</b> </td><td>Specify the padding width for YUV data at the Y2Y stage (YUV domain processing stage) when IDSP stitching is used. Only valid when "slice_cfg_enable" is enabled </td></tr>
<tr>
<td><b>chan_input_src</b> </td><td>Specify the channel input source. 0: RAW data, 1: CE data, 2: Low-resolution data This parameter should be 0 for most cases. Only for EIS use cases; it can be 1 or 2 to improve IDSP performance </td></tr>
<tr>
<td><b>idsp_core_cfg_enable</b> </td><td>Enable IDSP dual-core configurations for this channel. By default, it is 0 </td></tr>
<tr>
<td><b>idsp_core_mode</b> </td><td>Specify the IDSP core modes for this channel Only valid when "idsp_core_cfg_enable" is enabled. 0: single-core 0, 1: single-core 1, 2: dual-cores </td></tr>
<tr>
<td><b>pre_dec_enable</b> </td><td>Enable decoding function before channel processing. Only enable it for decoding channel </td></tr>
<tr>
<td><b>pre_dec_type</b> </td><td>Specify the decoder type for the decoding. Only valid when pre_dec_enable is 1 </td></tr>
<tr>
<td><b>pass_num</b> </td><td>Specify the pass number for which IDSP generates source buffers </td></tr>
<tr>
<td><b>premain / main / second / third / fourth / fifth / sixth</b> </td><td>Specify the buffer output of each channel </td></tr>
<tr>
<td><b>vin_roi_idx</b> </td><td>Specify the index of ROI VIN. Only valid when "roi_enable" in vsrc configuration is enabled. </td></tr>
<tr>
<td><b>ver_slice_num</b> </td><td>Specify the IDSP vertical slice number. Default is 1. </td></tr>
<tr>
<td><b>raw_padding_height </b> </td><td>Specify the padding height of the raw image. Default is 0. </td></tr>
</table>
<p ><b>Example</b><br  />
 </p><div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">    <span class="keywordtype">id</span> = 0,</div>
<div class="line">    vsrc = vsrc_0,</div>
<div class="line">    raw_capture = 1,</div>
<div class="line">    vsrc_ctx = 0,</div>
<div class="line">    img_stats_src_chan = <span class="stringliteral">&quot;chan_0&quot;</span>,</div>
<div class="line">    sensor_ctrl = 1,</div>
<div class="line">    max_padding_width = 0,</div>
<div class="line">    idsp_fps = 0,</div>
<div class="line">    lens_warp = 0,</div>
<div class="line">    max_main_input_width = 0, -- 0: VIN <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a> <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">    mctf_cmpr = 0,</div>
<div class="line">    c2y_burst_tile = 1,</div>
<div class="line">    extra_downscale = 0,</div>
<div class="line">    <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> = {</div>
<div class="line">        max_output = {0, 0}, -- output <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">        input      = {0, 0, 0, 0}, -- full VIN</div>
<div class="line">        output     = {0, 0, 1920, 1080},</div>
<div class="line">    },</div>
<div class="line">    second = {</div>
<div class="line">        max_output = {0, 0}, -- output <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">        input      = {0, 0, 0, 0}, -- full <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div>
<div class="line">        output     = {0, 0, 720, 480},</div>
<div class="line">    },</div>
<div class="line">    third = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">    fourth = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">    fifth = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">    pyramid = {</div>
<div class="line">        input_buf_id = 4,  -- 0: Main, 1: Second, 2: Third, 3: Fourth, 4: Fifth</div>
<div class="line">        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a> = 0,        -- 0: 1/sqrt(2) 1: 1/2</div>
<div class="line">        layer_map = 0x7F,</div>
<div class="line">        layers = {</div>
<div class="line">            {</div>
<div class="line">                crop_win = {0, 0, 0 ,0},</div>
<div class="line">            },</div>
<div class="line">            ... ... ...</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">}</div>
<div class="ttc" id="acJSON_8h_html_a788db922597cf2fb6389e278f822e59f"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div><div class="ttdeci">const char *const const char *const raw</div></div>
<div class="ttc" id="atest__vout__cfg_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> test_vout_cfg.c:85</div></div>
<div class="ttc" id="avin__init_8c_html_a12db301b040a15818f8d32874c312444"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a></div><div class="ttdeci">int scale_type</div><div class="ttdef"><b>Definition:</b> vin_init.c:77</div></div>
</div><!-- fragment --><h2><a class="anchor" id="lua_buf_cfg"></a>
3.1 Buffer Configuration</h2>
<a class="anchor" id="buf_cfg"></a>
<table class="doxtable">
<caption>Table 3-2. Buffer Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>max_output {width, height}</b> </td><td>Specify the maximum output width / height of each source buffer </td></tr>
<tr>
<td><b>input {offset_x, offset_y, width, height}</b> </td><td>Specify the input window of each source buffer. The main buffer input window is cropped from sensor (VSRC) resolution, and other source buffer input windows are cropped from the main buffer output window </td></tr>
<tr>
<td><b>output {offset_x, offset_y, width, height}</b> </td><td>Specify the output window of each source buffer in the canvas. The output offset is in the canvas coordinate </td></tr>
</table>
<div class="fragment"><div class="line">chan_0 = {</div>
<div class="line">    ... ... ...</div>
<div class="line">    <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> = {</div>
<div class="line">        max_output = {1920, 1080},</div>
<div class="line">        input      = {0, 0, 1920, 1080},</div>
<div class="line">        output     = {0, 0, 1920, 1080},</div>
<div class="line">    },</div>
<div class="line">    second = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">    third = {</div>
<div class="line">        max_output = {1920, 1080},</div>
<div class="line">        input      = {0, 0, 960, 1080},</div>
<div class="line">        output     = {960, 0, 960, 1080},</div>
<div class="line">    },</div>
<div class="line">    fourth = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">    fifth = {</div>
<div class="line">        ... ... ...</div>
<div class="line">    },</div>
<div class="line">}</div>
</div><!-- fragment --><p ><br  />
 </p>
<h2><a class="anchor" id="lua_pyramid_cfg"></a>
3.2 Pyramid Configuration</h2>
<a class="anchor" id="pyramid_cfg"></a>
<table class="doxtable">
<caption>Table 3-3. Pyramid Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>input_buf_id</b> </td><td>Specify the input source buffer ID in this channel </td></tr>
<tr>
<td><b>scale_type</b> </td><td>Specify the pyramid layer scale ratio. 0: 1/sqrt(2); 1: 1/2; 2: Arbitrary size. When scale_type is 2, the downscaling ratio between layer_0 and layer_1 can be arbitrary. The size of layer_1 is specified through <b>rescale_size {width, height}</b>. While for the remaining layers, the downscaling ratio are fixed to 1/2 </td></tr>
<tr>
<td><b>ext_mem</b> </td><td>Enable the external memory for pyramid buffers. It is 0 when the pyramid is from DSP's internal buffer. When it is 1, the pyramid buffer pool is allocated by the IAV driver, and pyramid buffer is automatically generated by DSP into the external pyramid buffer pool </td></tr>
<tr>
<td><b>frame_rate</b> </td><td>Specify the pyramid frame rate, it must be less than idsp_fps (This feature is not yet supported.) </td></tr>
<tr>
<td><b>manual_feed</b> </td><td>Enable manual-feed mode. 0: Pyramid auto-generation mode; 1: Pyramid manual-feed mode </td></tr>
<tr>
<td><b>item_num</b> </td><td>Specify the number of pyramid buffers in pyramid manual-feed mode. It must be within the range of [4, 12]. When set to 0, it uses 6 as a default </td></tr>
<tr>
<td><b>rescale_size {width, height}</b> </td><td>Specify the size of layer_1 when <b>scale_type</b> is 2 </td></tr>
<tr>
<td><b>max_rescale_size {width, height}</b> </td><td>Specify the max size of layer_1 </td></tr>
<tr>
<td><b>layer_map</b> </td><td>Specify which layers are not enabled to reduce DRAM bandwidth. To enable all seven layers, set this to 0x7F </td></tr>
<tr>
<td><b>max_layer_map</b> </td><td>Specify maximum bitmaps for pyramid layers, one bit for one layer. This can only be changed before entering into preview. The "layer_map" must be within "max_layer_map" </td></tr>
<tr>
<td><b>crop_win {offset_x, offset_y, width, height}</b> </td><td>Specify the output window of each pyramid layer buffer. The default value {0,0,0,0} refers to the pyramid layer's active window without cropping, rather than the window with the size 0x0. The cropping window of current layer will not affect latter layers </td></tr>
</table>
<p ><b>Example</b><br  />
 </p><div class="fragment"><div class="line">pyramid = {</div>
<div class="line">    input_buf_id = 4,  -- 0: Main, 1: Second, 2: Third, 3: Fourth, 4: Fifth</div>
<div class="line">    <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a> = 0,        -- 0: 1/sqrt(2); 1: 1/2; 2: Arbitrary size.</div>
<div class="line">    ext_mem = 0,</div>
<div class="line">    frame_rate = 0,</div>
<div class="line">    manual_feed = 0,</div>
<div class="line">    item_num = 0,</div>
<div class="line">    layer_map = 0x7F,  -- 0: means disable all pyramid layers</div>
<div class="line">    --[[For each pyramid layer, the input is always full sized from the specified <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>. As well as the full sized pyramid is</div>
<div class="line">        generated according to input <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a> size and the <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a>. The output pyramid is cropped from the full sized pyramid.</div>
<div class="line">        Offset 0x0 with size 0x0 means the full pyramid output without cropping.</div>
<div class="line">    --]]</div>
<div class="line">    layers = {</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        crop_win = {0, 0, 0 ,0},</div>
<div class="line">    },</div>
<div class="line">},</div>
<div class="ttc" id="acJSON_8h_html_aff2566f4c366b48d73479bef43ee4d2e"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a></div><div class="ttdeci">char * buffer</div></div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div><div class="ttdef"><b>Definition:</b> vin_init.c:57</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="lua_canvas_cfg"></a>
4. Canvas Configuration</h1>
<a class="anchor" id="canvas_cfg"></a>
<table class="doxtable">
<caption>Table 4-1. Canvas Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>type</b> </td><td>Specify the canvas type. It can be either "encode" or "prev". There is no "off" type for canvas If the application must turn off the canvas, it has to reconfigure the system and remove the canvas definition. If the canvas type is previewed, it can be in either YUV422 or YUV420 format with UV-interleaved data. If the canvas type is encoded, it must be in YUV420 format with UV-interleaved data </td></tr>
<tr>
<td><b>size {width, height}</b> </td><td>Specify the canvas resolution </td></tr>
<tr>
<td><b>source</b> </td><td>Specify source buffers of channels to canvas. The DSP follows the source buffer declare order in order to place a channel source buffer data in this field. The latter source buffer is placed in with a higher Z order and may cover the source buffer with a lower Z order. The channels whose source buffer are placed into the same canvas must have the same "idsp_fps" </td></tr>
<tr>
<td><b>extra_dram_buf</b> </td><td>Specify extra DRAM frames for the canvas </td></tr>
<tr>
<td><b>vout_id</b> </td><td>Specify VOUT when canvas type is "prev". If the value is set to 1, VOUT1 (such as high-definition multimedia interface (HDMIÂ®) or composite video with blanking and sync (CVBS)) will be used to show preview canvas. If the value is set to 0, VOUT0 (such as LDC or DSI) will be used to show the preview canvas </td></tr>
<tr>
<td><b>vout_YUV422</b> </td><td>Specify YUV format when the canvas type is "prev". If the value is set to 1, its YUV format is YUV422. Then, VOUT captures the display data from it directly. If the value is set to 0, its YUV format is YUV420, which is the same as other "encode" type canvases. Then, VOUT will convert it to YUV422 before showing </td></tr>
<tr>
<td><b>vout_back_pressure_margin</b> </td><td>Specify the current VOUT input FIFO depth. Valid range is [0,3]. 0 means using the default value 2. </td></tr>
<tr>
<td><b>manual_feed</b> </td><td>Enable manual-feed mode. 0: Canvas auto-generation mode. 1: Canvas manual-feed mode </td></tr>
<tr>
<td><b>feed_frame_num</b> </td><td>Specify the number of canvas buffers in manual-feed mode. It must be within the range of [4, 12]. When set to 0, it uses 6 as a default </td></tr>
<tr>
<td><b>cached_items</b> </td><td>Specify the canvas cache buffer number. The system will not discard canvas data immediately but place it in the cache buffer if cached_items &gt; 0. This provides users with a greater time margin to query it </td></tr>
<tr>
<td><b>enc_dummy_latency</b></td><td>Specify the latency number of the encode dummy buffer </td></tr>
<tr>
<td><b>frame_rate</b> </td><td>Specify the canvas frame rate; it must be less than idsp_fps </td></tr>
<tr>
<td><b>zero_fps</b> </td><td>Enable 0 fps canvas frame rate. When set to 0, "frame_rate = 0" represents idsp_fps. When set to 1, "frame_rate = 0" is real 0 fps </td></tr>
<tr>
<td><b>set_min_unlocked_buf_num</b> </td><td>Enable set min_unlocked_buf_num config. 1: Enable. 0: Disable </td></tr>
<tr>
<td><b>min_unlocked_buf_num</b> </td><td>Specify minimum number of Pyramid unlocked buffers. When users want to set min_unlocked_buf_num accordingly, they must enable manual_feed and set_min_unlocked_buf_num first </td></tr>
<tr>
<td><b>disable_yuv_dram</b> </td><td>Enable DSP to allocate the canvas YUV buffer, which is used to save memory when users have such requirements. 0 (Default): Allocate buffer. 1: Do not allocate buffer </td></tr>
<tr>
<td><b>enable_frame_tag</b> </td><td>Enable canvas frame tag pattern feature </td></tr>
<tr>
<td><b>frame_tag_value</b> </td><td>Specify canvas frame tag value. This value is valid when enable_frame_tag flag is enabled </td></tr>
<tr>
<td><b>frame_tag_mask</b> </td><td>Specify canvas frame tag mask. This value is valid when enable_frame_tag flag is enabled </td></tr>
<tr>
<td><b>ext_mem</b> </td><td>Enable the external memory for the canvas YUV data </td></tr>
<tr>
<td><b>blend_stitch_type</b> </td><td>Specify the blend stitch type for this canvas when multiple-channel stitching is used. 0: No stitch blending. 1: Horizontal stitch blending. 2: Vertical stitch blending </td></tr>
<tr>
<td><b>blend_stitch_circular_margin</b> </td><td>Specify The overlap margin of the last channel and first channel. Only valid when "blend_stitch_type" isn't 0 </td></tr>
<tr>
<td><b>blend_warp_enable</b> </td><td>Enable H warp for blending overlap region. Only valid when "blend_stitch_type" isn't 0 </td></tr>
<tr>
<td><b>blur_enable</b> </td><td>Enable blur insertion into the canvas. This is only for canvases whose type is "encode" </td></tr>
<tr>
<td><b>max_blur_area_num</b> </td><td>Maximum possible blur areas to insert. Valid range is [0, 8]. 0 means using the default value 8 </td></tr>
<tr>
<td><b>enc_extra_padding_enable</b> </td><td>Enable extra padding for streams encoding with offset. 1 : Enable. 0 : Disable </td></tr>
<tr>
<td><b>low_delay_enable</b> </td><td>This is a flag to enable / disable canvas low delay output with multiple vertical slices enabled. Default is 0. </td></tr>
</table>
<p ><b>Example</b><br  />
 </p><div class="fragment"><div class="line">canvas = {</div>
<div class="line">    {</div>
<div class="line">        type = <span class="stringliteral">&quot;encode&quot;</span>,</div>
<div class="line">        size = {1920, 1080},</div>
<div class="line">        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.main&quot;</span>, <span class="stringliteral">&quot;chan_1.main&quot;</span>, },</div>
<div class="line">        extra_dram_buf = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        type = <span class="stringliteral">&quot;prev&quot;</span>,</div>
<div class="line">        size = {1920, 1080},</div>
<div class="line">        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.third&quot;</span>, <span class="stringliteral">&quot;chan_1.third&quot;</span>, },</div>
<div class="line">        <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#a049a525f0e8bc8bee106f89f18f896ce">vout_id</a> = 1,</div>
<div class="line">        <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#ab4a73b5629d37ce98639684eb84d8410">vout_YUV422</a> = 0,</div>
<div class="line">        vout_back_pressure_margin = 3,</div>
<div class="line">        extra_dram_buf = 0,</div>
<div class="line">    },</div>
<div class="line">}</div>
<div class="ttc" id="avout__init_8c_html_a049a525f0e8bc8bee106f89f18f896ce"><div class="ttname"><a href="../../d4/de8/vout__init_8c.html#a049a525f0e8bc8bee106f89f18f896ce">vout_id</a></div><div class="ttdeci">int vout_id</div><div class="ttdef"><b>Definition:</b> vout_init.c:36</div></div>
<div class="ttc" id="avout__init_8c_html_ab4a73b5629d37ce98639684eb84d8410"><div class="ttname"><a href="../../d4/de8/vout__init_8c.html#ab4a73b5629d37ce98639684eb84d8410">vout_YUV422</a></div><div class="ttdeci">int vout_YUV422[VOUT_NUM]</div><div class="ttdef"><b>Definition:</b> vout_init.c:42</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="lua_stream_cfg"></a>
5. Stream Configuration</h1>
<a class="anchor" id="stream_cfg"></a>
<table class="doxtable">
<caption>Table 5-1. Stream Configuration.</caption>
<tr>
<th align="left">Item </th><th align="left">Description </th></tr>
<tr>
<td><b>id</b> </td><td>Specify the stream ID. Ambarella recommends keeping the same value as the stream index (starting from zero) </td></tr>
<tr>
<td><b>max_size</b> </td><td>Specify the maximum stream resolution </td></tr>
<tr>
<td><b>max_M</b> </td><td>Specify the maximum group of pictures (GOP) M for the stream. For B frames, max_M &gt; 1. For MJPEG encoding, max_M = 0 </td></tr>
<tr>
<td><b>fast_seek_enable</b> </td><td>Enable the Fast Seek frame </td></tr>
<tr>
<td><b>two_ref_enable</b> </td><td>Enable two forward reference frames </td></tr>
<tr>
<td><b>max_svct_layers_minus_1</b> </td><td>Specify maximum scalable video coding (SVC-T) layers options. 0: No SVC-T. 1: Two-layer SVC-T </td></tr>
<tr>
<td><b>max_num_minus_1_ltrs</b> </td><td>Specify the maximum long-term number minus 1 </td></tr>
<tr>
<td><b>possible_enc_src_map</b> </td><td>Specify the encoding source canvas map for the encoding stream. 0 (default): all canvases. Users should specify when the stream will be encoded with advanced GOP. Advanced GOP requires more memory resources to be allocated for the source canvases. By default, DSP allocates memory resources for all canvases. Specifying the designated source canvases can save memory </td></tr>
<tr>
<td><b>codec_enable</b> </td><td>Enable the stream codec. 0: High-efficiency video coding (HEVC) / H.264 / MJPEG; 1: HEVC / MJPEG; 2: H.264 / MJPEG; 3: MJPEG only </td></tr>
<tr>
<td><b>efm_enable</b> </td><td>Specify if the current stream can run encode from memory (EFM) </td></tr>
<tr>
<td><b>efm_buf_num</b> </td><td>Specify the number of frame buffers allocated for EFM. These frame buffers are allocated by DSP and occupy extra memory </td></tr>
<tr>
<td><b>efm_size</b> </td><td>Specify the EFM frame buffer size </td></tr>
<tr>
<td><b>efm_skip_waiting</b> </td><td>Enable skip waiting for DSP's response when starting / stopping EFM streams </td></tr>
<tr>
<td><b>efm_extern_src_enable</b> </td><td>Enable sharing EFM buffers from other streams </td></tr>
<tr>
<td><b>efm_ext_mem</b> </td><td>Enable external memory as the EFM stream input </td></tr>
<tr>
<td><b>stream_mv_statis_enable</b> </td><td>Enable stream motion vector statistics </td></tr>
<tr>
<td><b>stream_pic_statis_enable</b> </td><td>Enable stream frame encoding information statistics </td></tr>
<tr>
<td><b>custom_sei_possible</b> </td><td>Specify if the current stream can insert custom SEI </td></tr>
<tr>
<td><b>custom_sei_buf_num</b> </td><td>Specify the custom sei buffer number in one stream custom sei buffer pool and only used when custom_sei_possible is 1. </td></tr>
<tr>
<td><b>custom_sei_data_max_size</b> </td><td>Specify the maximum data size (bytes) for custom sei, which is used for allocating memory in DSP and iav driver. </td></tr>
</table>
<p ><b>Example:</b><br  />
 </p><div class="fragment"><div class="line">stream_0 = {</div>
<div class="line">    <span class="keywordtype">id</span> = 0,</div>
<div class="line">    max_size = {1920, 1080},</div>
<div class="line">    max_M = 1,</div>
<div class="line">    fast_seek_enable = 0,</div>
<div class="line">    two_ref_enable = 0,</div>
<div class="line">    max_svct_layers_minus_1 = 0,</div>
<div class="line">    max_num_minus_1_ltrs = 0,</div>
<div class="line">    possible_enc_src_map = 0,</div>
<div class="line">    codec_enable = 0, -- 0: H264/H265/MJPEG; 1: H265/MJPEG; 2: H264/MJPEG; 3: MJPEG</div>
<div class="line">    efm_enable = 0,</div>
<div class="line">    efm_buf_num = 0,</div>
<div class="line">    efm_size = {0, 0},</div>
<div class="line">    efm_skip_waiting = 0,</div>
<div class="line">    efm_extern_src_enable = 0,</div>
<div class="line">    efm_extern_src_stream = 0,</div>
<div class="line">    stream_mv_statis_enable = 0,</div>
<div class="line">    stream_pic_statis_enable = 0,</div>
<div class="line">    custom_sei_possible = 1,</div>
<div class="line">    custom_sei_buf_num = 8,</div>
<div class="line">    custom_sei_data_max_size = 256,</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<p ><b>Typical Structure of Lua Configuration File:</b><br  />
 </p><div class="fragment"><div class="line">-- vsrc configuration</div>
<div class="line">vsrc_0 = {</div>
<div class="line">        vsrc_id = 1,</div>
<div class="line">        mode = <span class="stringliteral">&quot;1080p&quot;</span>,</div>
<div class="line">        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a9586a0cc85ebac1f283fc9f2d94c82e2">hdr_mode</a> = <span class="stringliteral">&quot;linear&quot;</span>, -- options: <span class="stringliteral">&quot;linear&quot;</span>, <span class="stringliteral">&quot;2x&quot;</span>, <span class="stringliteral">&quot;3x&quot;</span> or <span class="stringliteral">&quot;wdr&quot;</span></div>
<div class="line">        fps = 30,</div>
<div class="line">        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a>= 0,</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">-- <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> configuration</div>
<div class="line">chan_0 = {</div>
<div class="line">        <span class="keywordtype">id</span> = 0,</div>
<div class="line">        vsrc = vsrc_0,</div>
<div class="line">        ...</div>
<div class="line">        <a class="code hl_function" href="../../db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> = {</div>
<div class="line">                max_output = {0, 0},             -- output <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div>
<div class="line">                input      = {0, 0, 0, 0},       -- full VIN</div>
<div class="line">                output     = {0, 0, 1920, 1080},</div>
<div class="line">        },</div>
<div class="line">        ...</div>
<div class="line">        pyramid = {</div>
<div class="line">                input_buf_id = 4,  -- 0: Main, 1: Second, 2: Third, 3: Fourth, 4: Fifth</div>
<div class="line">                <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a12db301b040a15818f8d32874c312444">scale_type</a> = 0,    -- 0: 1/sqrt(2); 1: 1/2; 2: Arbitrary size</div>
<div class="line">                ...</div>
<div class="line">                },</div>
<div class="line">        },</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">-- stream configuration</div>
<div class="line">stream_0 = {</div>
<div class="line">        <span class="keywordtype">id</span> = 0,</div>
<div class="line">        max_size = {1920, 1080},</div>
<div class="line">        max_M = 1,</div>
<div class="line">        fast_seek_enable = 0,</div>
<div class="line">        two_ref_enable = 0,</div>
<div class="line">        max_svct_layers_minus_1 = 0,</div>
<div class="line">        max_num_minus_1_ltrs = 0,</div>
<div class="line">        codec_enable = 0, -- 0: H264/H265/MJPEG; 1: H265/MJPEG; 2: H264/MJPEG; 3: MJPEG</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">-- system resource</div>
<div class="line">_resource_config_ = {</div>
<div class="line">        version = 1,</div>
<div class="line">        log_level = 0,               -- 0: error; 1: warning; 2: info; 3: debug</div>
<div class="line">        channels = {</div>
<div class="line">                chan_0,</div>
<div class="line">        },</div>
<div class="line">        chan_groups = {</div>
<div class="line">               {<span class="stringliteral">&quot;chan_0&quot;</span>,},         -- group <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> 0</div>
<div class="line">        },</div>
<div class="line">        canvas = {</div>
<div class="line">                {</div>
<div class="line">                        type = <span class="stringliteral">&quot;encode&quot;</span>,</div>
<div class="line">                        size = {0, 0},        -- min size to contain <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> buffers</div>
<div class="line">                        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.main&quot;</span>,},</div>
<div class="line">                        extra_dram_buf = 0,</div>
<div class="line">                },</div>
<div class="line">                ...</div>
<div class="line">                {</div>
<div class="line">                        type = <span class="stringliteral">&quot;prev&quot;</span>,</div>
<div class="line">                        size = {0, 0},</div>
<div class="line">                        <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> = {<span class="stringliteral">&quot;chan_0.third&quot;</span>, },</div>
<div class="line">                        <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#a049a525f0e8bc8bee106f89f18f896ce">vout_id</a> = 1,</div>
<div class="line">                        extra_dram_buf = 0,</div>
<div class="line">                },</div>
<div class="line">        },</div>
<div class="line">        streams = {</div>
<div class="line">                stream_0,</div>
<div class="line">                stream_1,</div>
<div class="line">                stream_2,</div>
<div class="line">        },</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">return</span> _resource_config_</div>
<div class="ttc" id="acJSON_8h_html_a750b5d744c39a06bfb13e6eb010e35d0"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a></div><div class="ttdeci">int index</div></div>
<div class="ttc" id="avin__init_8c_html_adf7dff2c57c0da9a4a2b70e3e815be31"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a></div><div class="ttdeci">int channel</div><div class="ttdef"><b>Definition:</b> vin_init.c:56</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="lua_vout_cfg"></a>
6. VOUT Configuration</h1>
<p >There are three VOUT controllers in the CV5x / CV72 SoC. The VOUT Lua is required to correctly set up the VOUT controller. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">ITEM   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>status</b>   </td><td class="markdownTableBodyLeft">Selection: 0: Disable, 1: on, 2: off, 3: reset;<br  />
 disable: do not use this VOUT controller    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>mode</b>   </td><td class="markdownTableBodyLeft">Specify VOUT format, such as "1080i" or "720p"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>input_yuv422</b>   </td><td class="markdownTableBodyLeft">Specify if the input YUV format is YUV422    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>video_output_window</b>   </td><td class="markdownTableBodyLeft">Specify the output window in the format {offset_x, offset_y, output_width, output_heigh}    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>type</b>   </td><td class="markdownTableBodyLeft">Specify the valid VOUT type for each controller    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>hdmi_output_format</b>   </td><td class="markdownTableBodyLeft">Specify the data format for HDMI output. This is valid when the type is "hdmi" or "cvbs"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>vout_from_image</b>   </td><td class="markdownTableBodyLeft">Specify the flag for VOUT from the image    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>default_image_format</b>   </td><td class="markdownTableBodyLeft">Specify the default image format. This is valid when VOUT from the image is enabled    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>video_rotate</b>   </td><td class="markdownTableBodyLeft">Specify the flag for enabling rotation for VOUT    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>video_flip_mode</b>   </td><td class="markdownTableBodyLeft">Specify the flip mode for VOUT; "no": disable, "h": horizontal, "v": vertical, "hv": horizontal + vertical    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>own_mixer</b>   </td><td class="markdownTableBodyLeft">Specify if the VOUT controller has a mixer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>osd_output_window</b>   </td><td class="markdownTableBodyLeft">Specify the onscreen display (OSD) output window of {offset_x, offset_y, output_width, output_heigh}    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>osd_flip_mode</b>   </td><td class="markdownTableBodyLeft">Specify the flip mode for OSD; "no": disable, "h": horizontal, "v": vertical, "hv": horizontal + vertical    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>osd_rescaler</b>   </td><td class="markdownTableBodyLeft">Specify the flag to enable the OSD rescaler    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>osd_rescaler_output_window</b>   </td><td class="markdownTableBodyLeft">Specify the OSD rescaler window of {offset_x, offset_y, output_width, output_heigh}    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>osd_transparent_color_enable</b>   </td><td class="markdownTableBodyLeft">Specify if the OSD rescaler tranparent color is enabled or not    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>max_osd_bit_depth</b>   </td><td class="markdownTableBodyLeft">Specify the max OSD bit depth: 0: auto, 8: 8bits, 16: 16bits, 32: 32bits   </td></tr>
</table>
<p >Example: </p><div class="fragment"><div class="line">vout_2 = {</div>
<div class="line">     status = <span class="stringliteral">&quot;on&quot;</span>,                                  --selection: 0:disable, 1:on, 2:off, 3:reset</div>
<div class="line">                                                     --disable: <span class="keywordflow">do</span> not use <span class="keyword">this</span> vout controller</div>
<div class="line">                                                     --on: use <span class="keyword">this</span> vout controller and enable video display</div>
<div class="line">                                                     --off: use <span class="keyword">this</span> vout controller and disable video display</div>
<div class="line">                                                     --reset: reset <span class="keyword">this</span> vout controller</div>
<div class="line">     mode = <span class="stringliteral">&quot;1080p&quot;</span>,</div>
<div class="line">     input_yuv422 = <span class="stringliteral">&quot;yes&quot;</span>,</div>
<div class="line">     video_output_window = {0, 0, 1920, 1080},       --{offsetx, offsety, output_width, output_heigh}</div>
<div class="line"> </div>
<div class="line">     type = <span class="stringliteral">&quot;hdmi&quot;</span>,                                  --selection: hdmi, mipi_csi, cvbs</div>
<div class="line"> </div>
<div class="line">     hdmi_output_format = <span class="stringliteral">&quot;rgb&quot;</span>;                     --selection: 0:rgb, 1:yuv422, 2:yuv444</div>
<div class="line">                                                        --only <span class="keywordflow">for</span> hdmi output mode</div>
<div class="line">     <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#abf5456cca33a36fb256bce85a8447f82">vout_from_image</a> = <span class="stringliteral">&quot;disable&quot;</span>,</div>
<div class="line">     default_img_format = <span class="stringliteral">&quot;yuv422&quot;</span>,                  --selection: 0:yuv422, 1:yuv420</div>
<div class="line"> </div>
<div class="line">     <a class="code hl_variable" href="../../d4/de8/vout__init_8c.html#a2a6bf30514e846e0156bc3e92e471100">video_rotate</a> = <span class="stringliteral">&quot;no&quot;</span>,                            --selection: 0:no, 1:yes</div>
<div class="line">     video_flip_mode = <span class="stringliteral">&quot;no&quot;</span>,                         --selection: 0:no, 1:hv, 2:h, 3:v</div>
<div class="line"> </div>
<div class="line">     own_mixer = <span class="stringliteral">&quot;yes&quot;</span>,                              --selection: 0:no, 1:yes</div>
<div class="line"> </div>
<div class="line">     osd_output_window = {0, 0, 0, 0},               --{offsetx, offsety, output_width, output_heigh}</div>
<div class="line">     osd_flip_mode = <span class="stringliteral">&quot;no&quot;</span>,                           --selection: 0:no, 1:hv, 2:h, 3:v</div>
<div class="line">     osd_rescaler = <span class="stringliteral">&quot;disable&quot;</span>,                       --selection: 0:disable, 1:enable</div>
<div class="line">     osd_rescaler_output_window = {0, 0, 0, 0},      --{offsetx, offsety, output_width, output_heigh}</div>
<div class="line">}</div>
<div class="ttc" id="avout__init_8c_html_a2a6bf30514e846e0156bc3e92e471100"><div class="ttname"><a href="../../d4/de8/vout__init_8c.html#a2a6bf30514e846e0156bc3e92e471100">video_rotate</a></div><div class="ttdeci">static u32 video_rotate[VOUT_NUM]</div><div class="ttdef"><b>Definition:</b> vout_init.c:96</div></div>
<div class="ttc" id="avout__init_8c_html_abf5456cca33a36fb256bce85a8447f82"><div class="ttname"><a href="../../d4/de8/vout__init_8c.html#abf5456cca33a36fb256bce85a8447f82">vout_from_image</a></div><div class="ttdeci">u8 vout_from_image[VOUT_NUM]</div><div class="ttdef"><b>Definition:</b> vout_init.c:47</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="section_lua_example"></a>
7. Lua Script Examples</h1>
<h2><a class="anchor" id="example_lua1"></a>
Example 1: Single VIN with 1080p30 Input</h2>
<dl class="section user"><dt>Hardware and Software Environment</dt><dd></dd></dl>
<p>In order for this test case to function, users must perform the following:</p><ul>
<li>Insert the input sensor IMX274 with a mobile industry processor interface (MIPIÂ®) into the VIN0 slot.</li>
<li>Connect the EVK board to PC via a universal asynchronous receiver / transmitter (UART) and Ethernet interface.</li>
<li>Connect a monitor to the HDMI interface.</li>
</ul>
<div class="image">
<img src="../../example_lua1.png" alt=""/>
<div class="caption">
Figure 7-1. Single VIN Hardware Connection.</div></div>
<dl class="section user"><dt>Overview of the System Resources</dt><dd></dd></dl>
<p>The following diagram is an overview of system resources for the current case. For more details, users can refer to the following Lua source file, which is located in</p>
<p ><em> /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua or /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua </em></p>
<div class="image">
<img src="../../lua_1080p_linear.png" alt=""/>
<div class="caption">
Figure 7-2. Lua Configuration for Single VIN with 1080p Input.</div></div>
<p >First, initialize the EVK board to load the essential drivers and microcode, and start 3A statistics if the following command was not executed previously. </p><div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
</div><!-- fragment --><p >Set up the system resources with the Lua script. </p><div class="fragment"><div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua        <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_vin0_1080p_linear.lua --vout-cfg /usr/share/ambarella/lua_scripts/vout_hdmi.lua)  <span class="comment">// For CV72</span></div>
</div><!-- fragment --><p >Then, set up three streams. Stream_0's encoding format is H.265, encoded from canvas 0. Stream_1's encoding format is H.264, encoded from canvas 3. Stream_2's encoding format is MJPEG, encoded from canvas 2.</p>
<div class="fragment"><div class="line">board# test_encode -A -H 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0 -e\</div>
<div class="line">                   -B -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 3 -e\</div>
<div class="line">                   -C -m  480p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -e</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
