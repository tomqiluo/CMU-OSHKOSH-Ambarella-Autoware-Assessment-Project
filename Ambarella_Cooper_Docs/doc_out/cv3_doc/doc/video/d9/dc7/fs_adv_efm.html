<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: ADVANCED - Encode from Memory</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d9/dc7/fs_adv_efm.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">ADVANCED - Encode from Memory </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="efm_efm"></a>
1. Encode from Memory</h1>
<p >This chapter describes the usage of encoding from the memory cases.</p>
<p >There are two main cases for this feature based on different processing stages inside the DSP.</p><ul>
<li><b>Encode from RAW</b>: The input for DSP is in the form of RAW data (either bayer RGB format or YUV format), and it is fed into the VIN buffer.</li>
<li><b>Encode from MEM</b>: The input for the DSP is YUV (YUV420 format with UV interleaved) / ME1 data, and it is fed into the extended source buffer (EFM buffer).</li>
</ul>
<h1><a class="anchor" id="preparations"></a>
2. Preparations</h1>
<h2><a class="anchor" id="memory"></a>
2.1 Memory</h2>
<p >For the EFM case, user memory partition is needed to transfer the RAW data, configure it from "menuconfig" as below. Below size is 64 MB.<br  />
 For Cooper SDK Amba build: </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       -&gt; drv_modules</div>
<div class="line">          -&gt; <span class="keyword">private</span></div>
<div class="line">             -*- ambvideo-header (drv_modules/<span class="keyword">private</span>/video/dsp_v6)</div>
<div class="line">                 (0x4000000) IAV Usr Buffer Size</div>
</div><!-- fragment --><p> For Cooper SDK Yocto build: </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       Main menu</div>
<div class="line">          -&gt; meta-ambabsp</div>
<div class="line">             -&gt; recipes-bsp</div>
<div class="line">                -&gt; recipes-video</div>
<div class="line">                   -&gt; ambvideo-header (meta-ambabsp/recipes-video/ambvideo-header)</div>
<div class="line">                      (0x4000000) IAV Usr Buffer Size</div>
</div><!-- fragment --><p >Or use "test_mempart" to allocate user buffer runtime. </p><div class="fragment"><div class="line">board# test_mempart -m 2 -s 0x4000000</div>
</div><!-- fragment --><h2><a class="anchor" id="configrations"></a>
2.2 Configrations</h2>
<p >For the encode from MEM case, users should configure related settings through lua script first. Here is part of /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua as example. </p><div class="fragment"><div class="line">...</div>
<div class="line">stream_0 = {</div>
<div class="line">     <span class="keywordtype">id</span> = 0,</div>
<div class="line">     ...</div>
<div class="line">     efm_enable = 1, -- 0: disable; 1: enable</div>
<div class="line">     efm_buf_num = 8, -- <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a> <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> should at range [5-10]</div>
<div class="line">     efm_size = {720, 480},</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="ttc" id="acJSON_8h_html_a01b4671c6b7cc8f831c951c000a37735"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a></div><div class="ttdeci">const char *const const double number</div></div>
<div class="ttc" id="acJSON_8h_html_aff2566f4c366b48d73479bef43ee4d2e"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a></div><div class="ttdeci">char * buffer</div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ol type="1">
<li>For H.264, YUV and ME1 buffers are needed for the DSP. If there is no ME1, <code>test_efm</code> will generate it automatically.</li>
<li>For H.265, YUV, ME1 and ME0 buffers are needed for the DSP. If there is no ME1 or ME0, <code>test_efm</code> will generate them automatically.</li>
<li>For MJPEG , only YUV is needed for the DSP. If only doing MJPEG encoding, especially for high-resolution, it is strongly suggested to set "codec_enable = 3" for the EFM stream through lua script. This is to save certain DSP hardware resource, in case running out of it.</li>
<li>Start EFM stream encoding, it needs to run <code>"test_efm"</code> in another console right after <code>"test_encode -A -h 1080p -b 24 -e"</code> to feed EFM buffer with specific YUV data continuously into the DSP. Different from CV2x platform, CV5x uses the ID 24 for EFM streams, because CV5x supports up to 20 canvases. So the ID 16 on CV5x actually means canvas with ID 16, and 24 stands for EFM buffer.</li>
<li>EFM stream supports overlay, but doesn't support blur.</li>
</ol>
</dd></dl>
<h1><a class="anchor" id="efm_exp"></a>
3. EFM Examples</h1>
<h2><a class="anchor" id="example_efm1"></a>
Example 1: Encode H.264 stream from EFM buffer: Input from main buffer</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board# test_encode -A -s</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm2"></a>
Example 2: Encode 4K H.264 stream from EFM buffer: Input from main buffer</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_4k_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_4k_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h3840x2160 --smaxsize 3840x2160 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm3"></a>
Example 3: Encode 2x H.264 streams from EFM buffer: Input from main buffer and third buffer</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e -B -h720p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board# test_efm -B -t 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 (in another console)</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm4"></a>
Example 4: Encode H.264 stream from EFM buffer: YUV (NV12) file</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 1080p_nv12.yuv -s 1920x1080</div>
<div class="line">board# test_encode -A -s</div>
<div class="ttc" id="agroup__IAV_html_ga11e444dd61d48abbdd34eed23186cb4b"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a></div><div class="ttdeci">u32 y</div></div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm5"></a>
Example 5: Encode H.264 stream from EFM buffer with specified frame rate: YUV (NV12) file</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 1080p_nv12.yuv -s 1920x1080 -r 25</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm7"></a>
Example 6: Encode 4K H.264 stream from EFM buffer: Input from YUV (NV12) file</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_4k_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_4k_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -h3840x2160 --smaxsize 3840x2160 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 4k_nv12.yuv -s 3840x2160</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm9"></a>
Example 7: Encode H.265 stream from EFM buffer: Input from main buffer</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm10"></a>
Example 8: Encode H.265 stream from EFM buffer: Input from YUV (NV12) file</h2>
<div class="fragment"><div class="line">board# init.sh --na;modprobe imx274_mipi vinc_id=8 bus_id=3     <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# init.sh --na;modprobe imx274_mipi vinc_id=8)         <span class="comment">// For CV72</span></div>
<div class="line">board# test_aaa_service -a&amp;</div>
<div class="line">board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv5_multi_efm_1080p_linear.lua         <span class="comment">// For CV5 or CV52</span></div>
<div class="line">(Or board# test_encode --resource-cfg /usr/share/ambarella/lua_scripts/cv72_multi_efm_1080p_linear.lua)   <span class="comment">// For CV72</span></div>
<div class="line">board# test_encode -A -H1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 1080p_nv12.yuv -s 1920x1080</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --><h2><a class="anchor" id="example_efm11"></a>
Example 9: Enter preview with virtual vinc_id, and Encode H.265 stream</h2>
<p >from EFM buffer: Input from YUV (NV12) file</p>
<p >This is for debug usage, channel 0 is for virtual vinc_id, channel 1 is for EFM.</p>
<div class="fragment"><div class="line">board# init.sh --na;modprobe ambds mipi=0 lane=2</div>
<div class="line">board# test_mempart -m 2 -s 0x4000000</div>
<div class="line">board# test_encode --resource-cfg cv5_efm_1080p.lua</div>
<div class="line">board# test_encode -A -H 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 24 -e</div>
<div class="line">board# test_efm -A -t 0 -<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga11e444dd61d48abbdd34eed23186cb4b">y</a> 1080p_nv12.yuv -s 1920x1080</div>
<div class="line">board# test_encode -A -s</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
