<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Video: OTHER - DSP Monitor Service</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Video"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Video<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d7/df4/fs_others_dsp_monitor_service.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">OTHER - DSP Monitor Service </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_dsp_monitor_service_features"></a>
1. DSP Monitor Service Features</h1>
<p >Since Cooper SDK 0.5, the digital signal processor (DSP) monitor service is added to monitor the DSP working state at runtime. This service must be enabled before DSP is booted up to the running state. In the Ambarella SDK, this service is enabled by default in the sensor initialization script (init.sh &ndash;sensor). If users don't use this initialization script, they must run the "dsp_monitor_service" service before booting up DSP to the running state. Else, users must integrate the calling of "libdspmonitor.so" library into their own application. If users don't follow the above guidelines, they may expect DSP running at abnormal state. When this happens, there may be error prints showing up in the IAV driver log, and users may find significant frame drop happens from the DSP side.</p>
<p >So this DSP monitor service is working actively to communicate with DSP to monitor its state. Once abnormal state is detected from DSP side, IAV driver would immediately get notified. IAV reports this information in the dmesg log, and users may also get notified from the DSP monitor service API "dsp_mon_get_dsp_state" as well. So when this happens, users may need to check whether there are abnormal configurations, such as invalid clock settings for DSP or VP. Users may need to adjust back these clock settings to be within the target clock settings for the specific chip part number, and recover to normal after putting DSP back to preview again. The dsp monitor service can also detect DSP assertion happens or not. When this happens, users may have to reboot the entire system to get DSP back to the running state again.</p>
<p >For CV72, there is a limitation that cavalry must be loaded before booting DSP operations. In DSP Moniter Service, it will also monitor this behavior, when booting DSP operations. When users try to booting DSP before loading cavalry, there will be a warning message from DSP Monitor Service, but it won't block cavalry reload operations. But when users try to reload cavalry after DSP is booted, DSP will fail to enter into preview state.</p>
<h2><a class="anchor" id="dsp_monitor_service_sample_flow"></a>
1.1 DSP Monitor Service Sample Flow</h2>
<p >Below is the pseudo code for how users implement the DSP monitor service into their application. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *monitor_service(<span class="keywordtype">void</span> *context)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>dsp_mon_dsp_state dsp_state;</div>
<div class="line">  <span class="keyword">struct </span>pollfd pool_fd = {0};</div>
<div class="line">  <span class="keywordtype">char</span> <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a>[64];</div>
<div class="line">  <span class="keywordtype">int</span> fd = 0, rval = 0, <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a> = 0;</div>
<div class="line">  snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;/proc/ambarella/vdsp_sync&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Init DSP monitor service library.</span></div>
<div class="line">  <a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a> = open(<span class="stringliteral">&quot;/dev/iav&quot;</span>, O_RDWR, 0));</div>
<div class="line">  dsp_mon_init_lib(<a class="code hl_variable" href="../../d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a>);</div>
<div class="line">  <span class="comment">// Set up the timing to query DSP state</span></div>
<div class="line">  fd = open(name, O_RDONLY, 0);</div>
<div class="line">  pool_fd.fd = fd;</div>
<div class="line">  pool_fd.events = POLLIN | POLLERR;</div>
<div class="line">  <span class="keywordflow">while</span> (!quit_thread) {</div>
<div class="line">    rval = poll(&amp;pool_fd, 1, TIMEOUT_INFINITE);</div>
<div class="line">    poll_times++;</div>
<div class="line">    <span class="comment">// POLL_THRESHOLD is suggested to be in the ange of 30 ~ 240</span></div>
<div class="line">    <span class="keywordflow">if</span> (poll_times % POLL_THRESHOLD) {</div>
<div class="line">       <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// Call the API to get DSP state</span></div>
<div class="line">    dsp_mon_get_dsp_state(&amp;dsp_state);</div>
<div class="line">    <span class="keywordflow">if</span> (dsp_state.state != DSP_MON_STATE_OK) {</div>
<div class="line">      <span class="comment">// DSP is in abnormal state or assertioin</span></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">// DSP working normally</span></div>
<div class="line">      monitor_times = 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">// Release the DSP monitor service library.</span></div>
<div class="line">  dsp_mon_deinit_lib();</div>
<div class="line">}</div>
<div class="ttc" id="acJSON_8h_html_a25d22ecc7e656d2c59332072684e8766"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a></div><div class="ttdeci">const char *const name</div></div>
<div class="ttc" id="avin__init_8c_html_a5294002f7dca0cd9bcc0009a27895ef7"><div class="ttname"><a href="../../d4/daa/vin__init_8c.html#a5294002f7dca0cd9bcc0009a27895ef7">fd_iav</a></div><div class="ttdeci">int fd_iav</div></div>
</div><!-- fragment --><p> For more details, users can find the example from the dsp_monitor_service.c, which is located in sdk\ambarella\app\utility\dsp_tool\dsp_monitor_service.c. For the DSP monitor service library APIs, users can find them from sdk\ambarella\prebuild\library\dsp_monitor\dsp_v6\include\lib_dsp_monitor.h. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
