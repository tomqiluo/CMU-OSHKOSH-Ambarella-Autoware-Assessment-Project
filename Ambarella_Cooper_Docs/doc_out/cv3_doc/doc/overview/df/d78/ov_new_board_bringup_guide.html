<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ambarella Linux SDK: New Board Bring-Up Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Ambarella Linux SDK"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Ambarella Linux SDK<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d78/ov_new_board_bringup_guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">New Board Bring-Up Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="new_board_bringup_overview"></a>
1. Overview</h1>
<p >This document guides users through bringing up a new board on the Ambarella platform.<br  />
</p>
<p >This chapter contains the following section:<br  />
</p>
<ul>
<li>Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_key_updates">1.1 Key Updates</a></li>
</ul>
<h2><a class="anchor" id="new_board_bringup_key_updates"></a>
1.1 Key Updates</h2>
<a class="anchor" id="key_updates"></a>
<table class="doxtable">
<caption>Table 1-1. Key Updates.</caption>
<tr>
<th>Version </th><th>Date </th><th>Modification </th></tr>
<tr>
<td align="center">1.0 </td><td align="center">20221009 </td><td>Initial Version </td></tr>
<tr>
<td align="center">1.1 </td><td align="center">20230914 </td><td>Move to common part and add CV5x support </td></tr>
<tr>
<td align="center">1.2 </td><td align="center">20240112 </td><td>Updated Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_modify_gpio_configuration">3.3.3 GPIO configuration</a> </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="new_board_bringup_background"></a>
2. Background Introduction</h1>
<p >To aid customers in bringing up new boards for the start of their projects, Ambarella provides the following guide to prepare, configure, and test new boards using the Ambarella platform.<br  />
</p>
<hr  />
<h1><a class="anchor" id="new_board_bringup_common_steps"></a>
3. Common System Bring-Up Steps</h1>
<p >This chapter describes the general steps used during system bring-up, and consists of the following sections:<br  />
</p>
<ul>
<li>Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_preparation">3.1 Bring-Up Preparation</a></li>
<li>Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_download_firmware_through_ambausb">3.2 Download Firmware Through AmbaUSB</a></li>
<li>Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_configuration_instructions_of_amboot">3.3 Configuration Instructions for AMBoot</a></li>
<li>Section <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#new_board_bringup_configuration_instructions_of_kernel">3.4 Kernel Configuration Instructions</a></li>
</ul>
<h2><a class="anchor" id="new_board_bringup_preparation"></a>
3.1 Bring-Up Preparation</h2>
<p >Upon the arrival of a new board, the following steps must be performed:<br  />
</p>
<ol type="1">
<li>Verify that power-up timing meets the required specifications.</li>
<li>Check the power of all hardware modules.</li>
<li>Verify that the power-on configuration (POC) settings are as expected in the design. This step is critical because the POC settings decide the boot options, such as boot media (NAND, embedded multi-media controller (eMMC), SPI, or SPI-NOR), boot method (normal or secure boot) and more. For more details, refer to the POC table in the hardware schematic diagram.</li>
<li>Check the double data rate (DDR) voltage. This step is important because the firmware must first be moved into memory. If the new board is empty, the firmware must first be downloaded into dynamic random access memory (DRAM) using the tool AmbaUSB; otherwise, the firmware will be read from boot media and translated to memory.</li>
<li>Verify that the USB is functioning, as the firmware must be downloaded to the board via USB.</li>
</ol>
<p >Contact the Ambarella hardware support team for assitance.<br  />
</p>
<h2><a class="anchor" id="new_board_bringup_download_firmware_through_ambausb"></a>
3.2 Download Firmware Through AmbaUSB</h2>
<p >Before bring-up, users must install the AmbaUSB tool and understand how it is used. This tool is released through Ambarella’s portal release order (PRO) system. Users can find the installation package in PRO.<br  />
</p>
<p >The following steps help users download the firmware onto a new board:</p>
<ol type="1">
<li>Pull-high POC[10] of the board. The system enters into force USB boot mode.<br  />
</li>
<li>If the users’s operating system (OS) is Windows, open the device manager and check if the Ambarella evaluation board devices have been detected. If the Ambarella evaluation board devices were not previously installed, they should be installed automatically when the board powers up with the USB connected.<br  />
</li>
</ol>
<div class="image">
<img src="../../board_bringup_ambarella_evaluation_board_device.png" alt=""/>
<div class="caption">
Figure 3-1. Ambarella Evaluation Board Device.</div></div>
<ol type="1">
<li>Launch AmbaUSB and choose the correct chip (marked as red box 1 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_force_usb_mode">Figure 3-2</a> for CV22 and <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_force_usb_mode_cv5">Figure 3-3</a> for CV5). Here, the CV22 Walnut and CV5 Timn evaluation kit (EVK) boards are used as examples. Then, the CV22 / CV5 USB device is detected by AmbaUSB (marked in red box 2 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_force_usb_mode">Figure 3-2</a> and <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_force_usb_mode_cv5">Figure 3-3</a>).<br  />
</li>
</ol>
<p ><a class="anchor" id="fig_ambausb_force_usb_mode"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_force_usb_display.png" alt=""/>
<div class="caption">
Figure 3-2. AmbaUSB with Force USB Mode for CV22 Walnut.</div></div>
<p ><a class="anchor" id="fig_ambausb_force_usb_mode_cv5"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_force_usb_cv5.png" alt=""/>
<div class="caption">
Figure 3-3. AmbaUSB with Force USB Mode for CV5 Timn.</div></div>
<ol type="1">
<li>Use AmbaUSB to verify if the POC settings are correct. If the POC settings are not correctly set, they must be adjusted.<br  />
</li>
</ol>
<p ><a class="anchor" id="fig_ambausb_read_register"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_read_register.png" alt=""/>
<div class="caption">
Figure 3-4. Read Registers Using AmbaUSB in CV22 Walnut.</div></div>
<p >When the CV22 Walnut board enters into force USB boot mode, users can click the magic icon (marked as a red 1 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_read_register">Figure 3-4</a>). Then, AmbaUSB will go to the “AMBoot tool wizard” page. After choosing the “Read Register” checkbox and specifying the address and length of the POC register (marked as red boxes 2, 3, and 4 respectively in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_read_register">Figure 3-4</a>), AmbaUSB can read the value of the POC register (shown in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_read_register_result">Figure 3-5</a>) by clicking the <b>Ok</b> button.</p>
<p ><a class="anchor" id="fig_ambausb_read_register_result"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_read_register_result.png" alt=""/>
<div class="caption">
Figure 3-5. POC Register Value Displayed in AmbaUSB on CV22 Walnut.</div></div>
<p >On the CV5x platform, for the sake of security consideration, AmbaUSB must load a usbstrap file (end with <code>.ust</code>) to initialize the board first. Then, it can execute operations such as reading registers, reading / writing memory, and more. <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_load_ust_cv5">Figure 3-6. Loading UST Files in AmbaUSB.</a></p>
<p ><a class="anchor" id="fig_ambausb_load_ust_cv5"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_load_ust_cv5.png" alt=""/>
<div class="caption">
Figure 3-6. Load UST File in AmbaUSB on CV5 Timn.</div></div>
<p >AmbaUSB has some <code>.ust</code> files and users can select them from the installing directory (<code>cv5_lpddr5_540MHz.ust</code> is used here). When a correct <code>.ust</code> file has been loaded successfully, AmbaUSB will check and execute it. Then, it will enter into UST mode. Refer to <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_ust_mode_cv5">Figure 3-7</a>.</p>
<p ><a class="anchor" id="fig_ambausb_ust_mode_cv5"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_ust_mode_cv5.png" alt=""/>
<div class="caption">
Figure 3-7. UST Mode in AmbaUSB on CV5 Timn.</div></div>
<p >Reading POC registers in UST mode is similar to the operations used on the CV22 Walnut board; the only difference is the address of the POC register. On the CV5 platform, the value is <b>0x20ed080034</b> (40 bits, not 32 bits). <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_ust_mode_cv5">Figure 3-8</a> shows the reading POC register operations on CV5 Timn and <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_ust_mode_cv5">Figure 3-9</a> displays the result.</p>
<p ><a class="anchor" id="fig_ambausb_read_poc_cv5"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_read_poc_register_cv5.png" alt=""/>
<div class="caption">
Figure 3-8. Read POC Registers on CV5 Timn.</div></div>
<p ><a class="anchor" id="fig_ambausb_poc_value_cv5"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_poc_value_cv5.png" alt=""/>
<div class="caption">
Figure 3-9. Display POC Register Values in AmbaUSB on CV5 Timn.</div></div>
<ol type="1">
<li>AmbaUSB can test memory access operations and check if there are DRAM hardware issues.<br  />
</li>
</ol>
<p ><a class="anchor" id="fig_ambausb_memory_test"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_memory_test.png" alt=""/>
<div class="caption">
Figure 3-10. Memory Tests in AmbaUSB on CV22 Walnut.</div></div>
<p >As shown in the figure above, when the CV22 Walnut board enters into force USB boot mode, users can click the magic icon (marked as a red 1 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_memory_test">Figure 3-10</a>). Then, AmbaUSB will go to the “AMBoot tool wizard” page. Users can test memory in this page:</p>
<ul>
<li>Select the memory test in the top-left corner.</li>
<li>Input the accessing address correctly, such as 0x100000.</li>
<li>Input the data to be written into the memory, such as 0x55aa55aa.</li>
<li>Input the data length.</li>
</ul>
<p >When all parameters for memory testing are ready, users can click the <b>Ok</b> button to enable AmbaUSB to perform memory tests by attempting to read the data that has been written into memory. If data read from the memory is the same as what users input in the “AMBoot tool wizard”(see <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_memory_test_result">Figure 3-11</a>), there is no issue regarding memory read / write. Otherwise, users can refer to <b>FAQ 2</b> to find the root cause.</p>
<p ><a class="anchor" id="fig_ambausb_memory_test_result"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_memory_test_result.png" alt=""/>
<div class="caption">
Figure 3-11. Memory Test Results in AmbaUSB on CV22 Walnut.</div></div>
<p >On the CV5x platform, AmbaUSB disables the "Test Memory" operation, and the user must split the into two steps: "write memory" and "read memory". The following figures demonstrate the process of writing and reading memory.</p>
<div class="image">
<img src="../../board_bringup_amba_usb_write_memory_cv5.png" alt=""/>
<div class="caption">
Figure 3-11. Write Memory Operation in AmbaUSB On CV5 Timn.</div></div>
<div class="image">
<img src="../../board_bringup_amba_usb_write_memory_result_cv5.png" alt=""/>
<div class="caption">
Figure 3-12. Result of the Writing Memory Operation in AmbaUSB On CV5 Timn.</div></div>
<div class="image">
<img src="../../board_bringup_amba_usb_read_memory_cv5.png" alt=""/>
<div class="caption">
Figure 3-13. Read Memory Operation in AmbaUSB On CV5 Timn.</div></div>
<div class="image">
<img src="../../board_bringup_amba_usb_read_memory_result_cv5.png" alt=""/>
<div class="caption">
Figure 3-14. Result of the Reading Memory Operation in AmbaUSB On CV5 Timn.</div></div>
<ol type="1">
<li>Users can manually load the Ambarella bootloader (BLD) to enter into the BLD’s command line mode.</li>
</ol>
<p >The following figure and steps provide instructions for the CV22 Walnut board (similar process on CV5 Timn):</p>
<p ><a class="anchor" id="fig_ambausb_load_bld_manually"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_load_bld_manually.png" alt=""/>
<div class="caption">
Figure 3-15. Load Ambarella Bootloader Manually in AmbaUSB.</div></div>
<ol type="1">
<li>Choose the board configuration (marked as red box 1 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_load_bld_manually">Figure 3-15</a>); for CV22 Walnut, LINUX.CV22.LPDDR4.NAND is selected.</li>
<li>Click the magic icon (marked as red box 2 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_load_bld_manually">Figure 3-15</a>). Then, AmbaUSB will go to the “AMBoot tool wizard” page.</li>
<li>Choose the Ambarella bootloader (marked as red box 3 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_load_bld_manually">Figure 3-15</a>). When the board firmware is compiled, the Ambarella bootloader bld_release.elf will be generated in the directory <code>ambarella/out/board_name/amboot</code>.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>In order for AmbaUSB to successfully load the BLD, Ambarella recommends disabling the Arm® TrustZone® feature (in the configuration file) at the bring-up stage. <div class="fragment"><div class="line"><span class="preprocessor"># For SDK 3.0:</span></div>
<div class="line">$ make menuconfig</div>
<div class="line">    Ambarella Boot Configuration ---&gt;</div>
<div class="line">      Bootloader ---&gt;</div>
<div class="line">        Ambarella Firmware Configuration ---&gt;</div>
<div class="line">          Memory Options ---&gt;</div>
<div class="line">            (0x00000000) AMBoot starting address</div>
<div class="line">          AMBoot Options ---&gt;</div>
<div class="line">            [] Boot with TrustZone ----</div>
<div class="line"> </div>
<div class="line"># For Cooper SDK:</div>
<div class="line">$ make menuconfig</div>
<div class="line">    boot ---&gt;</div>
<div class="line">      [*] amboot (boot/ambamk) ---&gt;</div>
<div class="line">        Ambarella Firmware Configuration ---&gt;</div>
<div class="line">          Memory Options ---&gt;</div>
<div class="line">            (0x00000000) AMBoot starting address</div>
<div class="line">          AMBoot Options ---&gt;</div>
<div class="line">            [] Boot with TrustZone ----</div>
</div><!-- fragment --></dd></dl>
<p>Click the <b>Ok</b> button, then press the <b>Enter</b> key in the serial port. When this bootloader is loaded completely by AmbaUSB, it will be executed in memory and the command line mode appears in the serial port, as shown below.<br  />
</p>
<div class="image">
<img src="../../board_bringup_bld_command_line_mode.png" alt=""/>
<div class="caption">
Figure 3-16. Ambarella Bootloader Command Line Mode.</div></div>
<p >Many commands in the BLD can be used for debugging purposes. The “help” command shows all applications supported in the Ambarella bootloader.<br  />
</p>
<div class="image">
<img src="../../board_bringup_bld_command_line_mode_help.png" alt=""/>
<div class="caption">
Figure 3-17. Ambarella Bootloader Help Command.</div></div>
<p >After successfully completing the previous steps, users can now burn the firmware onto the board.</p>
<ol type="1">
<li>Choose the board configuration (marked as red box 1 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_download_fw">Figure 3-18</a>). For CV22 Walnut, LINUX.CV22.LPDDR4.NAND is selected.</li>
<li>Specify the firmware's location (marked as red box 2 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_download_fw">Figure 3-18</a>).</li>
<li>Download the firmware onto the board (marked as red box 3 in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_ambausb_download_fw">Figure 3-18</a>).</li>
</ol>
<p ><a class="anchor" id="fig_ambausb_download_fw"></a></p><div class="image">
<img src="../../board_bringup_amba_usb_download_firmware.png" alt=""/>
<div class="caption">
Figure 3-18. Download Firmware in AmbaUSB on CV22 Walnut.</div></div>
<p >To build and burn the firmware, users can take reference from <a class="el" href="../../d9/d98/ov_code_build.html">SDK Code Building</a> and <a class="el" href="../../d7/d6c/page_getting_start_guide.html">Getting Started Guide</a>.</p>
<h2><a class="anchor" id="new_board_bringup_configuration_instructions_of_amboot"></a>
3.3 Configuration Instructions for AMBoot</h2>
<p >Per different hardware designs, the bootloader and kernel must be configured accordingly when building a firmware for users’ boards.<br  />
</p>
<p >This section introduces how to prepare AMBoot (the bootloader of Ambarella systems on chip (SoCs)). The two parts of the Ambarella SoC bootloader are the bootstrapper (BST) and the bootloader (BLD).<br  />
</p>
<ul>
<li>BST: initializes DDR and loads the BLD from storage media to DRAM</li>
<li>BLD: loads and runs the kernel. Additionally, the Ambarella BLD provides many applications when users enter into BLD command line mode. Users can enter into this command line mode by pressing the “Enter” key in the serial port while the BLD is loading</li>
</ul>
<h3><a class="anchor" id="new_board_bringup_ini_file_for_bst"></a>
3.3.1 INI Files for BST</h3>
<p >Before compiling the software development kit (SDK), an <code>.ini</code> file must be provided for the BST. All parameters configured in this <code>.ini</code> file will be parsed and passed to the BST module. The tool bstiniparser is located in <code>ambarella/amboot/src/bst/tools</code> (SDK 3.0) and <code>ambarella/boot/amboot/src/bst/tools</code> (Cooper SDK). This tool analyzes the <code>.ini file</code> and translates it into a C header file. Here, the <code>cv22aq_walnut_76_lpddr4.ini</code> of the CV22 Walnut EVK board is used as an example (CV5 is similar). <br  />
</p>
<div class="image">
<img src="../../board_bringup_ddr_parameter_ini.png" alt=""/>
<div class="caption">
Figure 3-19. DDR Parameters in cv22aq_walnut_76_lpdd4.ini.</div></div>
<div class="fragment"><div class="line"><span class="preprocessor"># For SDK 3.0:</span></div>
<div class="line">board $ cd ambarella/amboot/src/bst/tools</div>
<div class="line">board $ ./bstiniparser ../../../../boards/cv22_walnut/bsp/cv22aq_walnut_76_lpddr4.ini | grep DRAM</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># For Cooper SDK:</span></div>
<div class="line">board $ cd ambarella/boot/amboot/src/bst/tools</div>
<div class="line">board $ ./bstiniparser ../../../../../boards/cv22_walnut/bsp/cv22aq_walnut_76_lpddr4.ini | grep DRAM</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define PARAM_DRAM_TRAINING_VAL                   0x00fa007d</span></div>
<div class="line"><span class="preprocessor">#define DRAM_CONTROL_DDRC0_VAL                    0x6dc02a80</span></div>
<div class="line"><span class="preprocessor">#define DRAM_RSVD_SPACE_DDRC0_VAL                 0x7ff00000</span></div>
<div class="line"><span class="preprocessor">#define DRAM_CONFIG_DDRC0_VAL                     0x702842d8</span></div>
<div class="line"><span class="preprocessor">#define DRAM_TIMING1_DDRC0_VAL                    0x76ace30c</span></div>
<div class="line"><span class="preprocessor">#define DRAM_TIMING2_DDRC0_VAL                    0x1ce30d89</span></div>
<div class="line"><span class="preprocessor">#define DRAM_TIMING3_DDRC0_VAL                    0x20000153</span></div>
<div class="line"><span class="preprocessor">#define DRAM_TIMING4_DDRC0_VAL                    0x12d8c7b6</span></div>
<div class="line"><span class="preprocessor">#define DRAM_TIMING5_LP4TRAIN_DDRC0_VAL           0x6c588000</span></div>
<div class="line"><span class="preprocessor">#define DRAM_PAD_TERM_DDRC0_VAL                   0x0002009c</span></div>
<div class="line"><span class="preprocessor">#define DRAM_PAD_TERM2_DDRC0_VAL                  0x090f990f</span></div>
<div class="line"><span class="preprocessor">#define DRAM_PAD_TERM3_DDRC0_VAL                  0x00987000</span></div>
<div class="line"><span class="preprocessor">#define DRAM_BYTE_MAP_DDRC0_VAL                   0x000000e4</span></div>
<div class="line"><span class="preprocessor">#define DRAM_DQS_SYNC_DDRC0_VAL                   0x00001ea0</span></div>
<div class="line"><span class="preprocessor">#define DRAM_ZQ_CALIB_DDRC0_VAL                   0x00000860</span></div>
<div class="line"><span class="preprocessor">#define DRAM_DLL_CALIB_DDRC0_VAL                  0x001e3204</span></div>
<div class="line"><span class="preprocessor">#define DRAM_SELF_REFRESH_DDRC0_VAL               0x00000001</span></div>
<div class="line"><span class="preprocessor">#define DRAM_POWER_DOWN_DDRC0_VAL                 0x00000030</span></div>
<div class="line"><span class="preprocessor">#define DRAM_MODE_REG_VAL                         0x00000010</span></div>
</div><!-- fragment --><p >As there are too many parameters, select the last macro, DRAM_MODE_REG_VAL to display where it is used in the BLD:<br  />
</p>
<div class="fragment"><div class="line"><span class="preprocessor"># For SDK 3.0</span></div>
<div class="line">board $ cd ambarella/amboot</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># For Cooper SDK:</span></div>
<div class="line">board $ cd ambarella/boot/amboot</div>
<div class="line"> </div>
<div class="line">board $ grep -n <span class="stringliteral">&quot;DRAM_MODE_REG_VAL&quot;</span> -r ./src | grep cv22</div>
<div class="line">./src/bst/cv22/parameters.S:167:dram_mode_param:                .int DRAM_MODE_REG_VAL</div>
<div class="line"> </div>
<div class="line">board $ grep -n <span class="stringliteral">&quot;dram_mode_param&quot;</span> -r ./src | grep cv22</div>
<div class="line">./src/bst/cv22/parameters.S:119:.globl dram_mode_param</div>
<div class="line">./src/bst/cv22/parameters.S:167:dram_mode_param:                .int DRAM_MODE_REG_VAL</div>
<div class="line">./src/bst/cv22/memsetup_lpddr4.S:59:    ldr     w0, dram_mode_param</div>
</div><!-- fragment --><p >Before compiling Ambarella SDK, users can choose <code>.ini</code> file through “make menuconfig” in the SDK:<br  />
 </p><div class="fragment"><div class="line"><span class="preprocessor"># For SDK 3.0</span></div>
<div class="line">Build $ make menuconfig</div>
<div class="line">        [*] Ambarella Board Configuration ---&gt;</div>
<div class="line">           [*] Board Revision (CV22 WALTNUT AUTO AQ76 with micron 16Git LPDDR4 @1392MHz) ---&gt;</div>
<div class="line"> </div>
<div class="line"># For Cooper SDK:</div>
<div class="line">Build $ make menuconfig</div>
<div class="line">          boot ---&gt;</div>
<div class="line">            amboot (boot/ambamk) ---&gt;</div>
<div class="line">              Ambarella Firmware Configuration ---&gt;</div>
<div class="line">                Board ---&gt;</div>
<div class="line">                  Board Revision (CV22 WALTNUT AUTO (AQ76 with micron 16Git LPDDR4 @1392MHz)) ---&gt;</div>
</div><!-- fragment --><p >The DRAM size also must be adjusted by changing MACRO “DRAM_SIZE”, which is defined in <code>ambarella/boards/cv22_walnut/bsp/bsp.h</code>. The default value of this macro is 0x80000000 (2 GB). Users must set it according to the real DDR capacity of the board.<br  />
</p>
<h3><a class="anchor" id="new_board_bringup_modify_partition_size_flash"></a>
3.3.2 Modify Partition Flash Size</h3>
<p >The definition of each partition flash size is located in <code>ambarella/boards/cv22_walnut/bsp/bsp.h</code>. Users can modify the sizes according to the actual capacity of storage media:<br  />
</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CONFIG_BOOT_MEDIA_SPINOR</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/spinor.h&quot;</span></div>
<div class="line"><span class="preprocessor">#elif defined(CONFIG_AMBARELLA_ROOTFS_CPIO)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/cpio.h&quot;</span></div>
<div class="line"><span class="preprocessor">#elif defined(CONFIG_BOOT_MEDIA_EMMC)</span></div>
<div class="line"><span class="preprocessor">#if defined(CONFIG_RTOS_MINDSP)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/fastboot_emmc.h&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/emmc.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#elif defined(AMBOOT_THAW_HIBERNATION)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/hibernation.h&quot;</span></div>
<div class="line"><span class="preprocessor">#elif defined(CONFIG_AMBARELLA_INIT_LINUXRC_FAST)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/fastinit.h&quot;</span></div>
<div class="line"><span class="preprocessor">#elif defined(BUILD_FIRMWARE_RECOVERY)</span></div>
<div class="line"><span class="preprocessor">#if defined(BUILD_AMBARELLA_ORYX_V2_SWAP_UPGRADE) || \</span></div>
<div class="line"><span class="preprocessor">    defined(BUILD_AMBARELLA_ORYX_V2_UPGRADE_FIRMWARE_SIMPLE_SWAP_UPGRADE_DEMO) || \</span></div>
<div class="line"><span class="preprocessor">    defined(BUILD_AMBARELLA_ORYX_V2_UPGRADE_FIRMWARE_SECURITY_SWAP_UPGRADE_DEMO)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/swap_upgrade.h&quot;</span></div>
<div class="line"><span class="preprocessor">#elif defined(BUILD_AMBARELLA_ORYX_V2_PBA_UPGRADE) || \</span></div>
<div class="line"><span class="preprocessor">      defined(BUILD_AMBARELLA_ORYX_V2_UPGRADE_FIRMWARE_SIMPLE_PBA_UPGRADE_DEMO) || \</span></div>
<div class="line"><span class="preprocessor">      defined(BUILD_AMBARELLA_ORYX_V2_UPGRADE_FIRMWARE_SECURITY_PBA_UPGRADE_DEMO)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/pba_upgrade.h&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/recovery.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#elif defined(CONFIG_RTOS_MINDSP)</span></div>
<div class="line"><span class="preprocessor">#include &quot;partition/fastboot_v5.h&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_BST_SIZE     (AMBOOT_BST_FIXED_SIZE)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_BLD_SIZE     (AMBOOT_MIN_PART_SIZE * 8)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_PTB_SIZE     (AMBOOT_MIN_PART_SIZE * 7)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_ATF_SIZE     (AMBOOT_MIN_PART_SIZE * 8)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_PBA_SIZE     (16 * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_PRI_SIZE     (16 * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_SEC_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_BAK_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_RMD_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_ROM_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_DSP_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_LNX_SIZE     (144 * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_SWP_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_ADD_SIZE     (12  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#define AMBOOT_ADC_SIZE     (0  * 1024 * 1024)</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p >For more information about flash partitions, users can refer to <a class="elRef" target="_blank" href="../../../peripherals/d4/d64/si_fs.html">File System</a> and <a class="elRef" target="_blank" href="../../../peripherals/dc/dac/si_nand.html">NAND</a>.</p>
<h3><a class="anchor" id="new_board_bringup_modify_gpio_configuration"></a>
3.3.3 GPIO Configuration</h3>
<p >There are two ways to configure general purpose input / output (GPIO).</p><ul>
<li>The first way is the legacy method, where the configurations are maintained in the <code>bsp.h</code> file.</li>
<li>The second way is a new method, where the configurations are maintained in the device trees (DTS).</li>
</ul>
<p >The user can use "CONFIG_SUPPORT_OF_FDT" configuration. When this configuration is enabled, the new method will be used. When disabled, the legacy method is used.</p>
<p >For the legacy method, the user operation process is as follows:</p><ol type="1">
<li>Based on the hardware design, generate the complete GPIO configurations. There is a dedicated Excel tool from Ambarella.</li>
<li>Capture the GPIO configurations into the <code>bsp.h</code> under the board folder.</li>
<li>Update the AMBoot or kernel modules to use these GPIOs when necessary.</li>
<li>Generate a firmware, and apply the configurations.</li>
</ol>
<p >The working flow for the legacy method is as follows:</p><ol type="1">
<li>AMBoot loads all the configurations in <code>bsp.h</code>, and sets to the hardware.</li>
<li>AMBoot and Linux uses these initialized GPIOs for different purposes.</li>
</ol>
<p >The potential issues for the legacy method:</p><ul>
<li>Users are required to generate the entire GPIO configuration map. It is easy to make mistakes for GPIO settings.</li>
<li>These incorrect GPIO settings can cause potential hardware failures, or power increases.</li>
<li>Sometimes users directly copy GPIO configurations from the Ambarella evaluation kit (EVK) that do not match their board. Locating and fixing these hardware or power-related issues will take a long time.</li>
</ul>
<p >For the legacy method, the CV22 GPIO settings are located in <code>ambarella/boards/cv22_walnut/bsp/bsp.h</code>. Ambarella provides an Excel tool to aid hardware engineers in configuring the GPIOs (column marked as red box 2 of the hardware page in <a class="el" href="../../df/d78/ov_new_board_bringup_guide.html#fig_gpio_mux_table">Figure 3-20</a>).</p>
<p ><a class="anchor" id="fig_gpio_mux_table"></a></p><div class="image">
<img src="../../board_bringup_pin_mux.png" alt=""/>
<div class="caption">
Figure 3-20. GPIO Mux Table.</div></div>
<p >If users encounter any issues while obtaining this tool, contact the Ambarella hardware support team for assitance.<br  />
</p>
<p >After the application of each GPIO is configured properly, contents of the remaining four pages (control, pull, IOMUX, and GPIO_DS) will be generated automatically. Then, users can update these configurations into <code>ambarella/boards/cv22_walnut/bsp/bsp.h</code>.<br  />
</p>
<div class="image">
<img src="../../board_bringup_pin_mux_bsp.png" alt=""/>
<div class="caption">
Figure 3-21. GPIO Configuration.</div></div>
<p >For the new method, the user operation process is as follows:</p><ol type="1">
<li>Configure the necessary GPIO configurations into the device tree.</li>
<li>Update the AMBoot or kernel modules to use these GPIOs when necessary.</li>
<li>For those unused GPIOs, it would be reserved as GPIO input and the configurations from device tree will be ignored.</li>
</ol>
<p >The working flow for the new method is as follows:</p><ol type="1">
<li>AMBoot reads the used GPIO settings from the device tree, initializes the hardware and use it. Normally, AMBoot only reads.</li>
<li>For those GPIO that are not configured in the device tree, they are initialized as "INPUT" and pulled to "LOW" by default.</li>
<li>AMBoot and Linux uses these initialized GPIOs for different purposes.</li>
</ol>
<p >Improvements for the new method are as follows:</p><ul>
<li>Users are only required to specify the necessary GPIO settings in the device tree. This avoids potential issues if the complete GPIO settings are incorrectly configured.</li>
<li>For these unused GPIOs, initializing to "INPUT" avoids unnecessary power consumptions.</li>
</ul>
<p >Normally AMBoot will only initialize NAND / SPIOR / eMMC related pins according to the boot media. So these relevant GPIOs can be used in AMBoot. For example, if the boot media is eMMC, then AMBoot loads and uses eMMC-related GPIO configurations.</p>
<p >Compared with the legacy method, the new method only requires to ensure that the used GPIOs are properly configured in the device tree.</p>
<p >The following is an example of I2S configurations in the device tree.</p>
<div class="fragment"><div class="line">i2s0: i2s@e001c000 {</div>
<div class="line">        compatible = <span class="stringliteral">&quot;ambarella,i2s&quot;</span>;</div>
<div class="line">        …</div>
<div class="line">        pinctrl-names = <span class="stringliteral">&quot;default&quot;</span>;</div>
<div class="line">        pinctrl-0 = &lt;&amp;i2s0_pins&gt;;</div>
<div class="line">        …</div>
<div class="line">        status = <span class="stringliteral">&quot;ok&quot;</span>;</div>
<div class="line">};</div>
<div class="line">i2s0_pins: i2s0@0 {</div>
<div class="line">       reg = &lt;0&gt;;</div>
<div class="line">       amb,pinmux-ids = &lt;0x1030 0x1031 0x1032 0x1033&gt;;</div>
<div class="line">};</div>
</div><!-- fragment --><p >So in AMBoot, the I2S pins will be configured as I2S mode, when the code below is called. And related GPIOs will be parsed and configured. </p><div class="fragment"><div class="line">of_pin_init(of_find_node(<span class="stringliteral">&quot;ambarella,i2s&quot;</span>), <span class="stringliteral">&quot;default&quot;</span>);</div>
</div><!-- fragment --><p >For Linux, the I2S pins will be configured as I2S mode, when status = "ok". But when status = "disabled", the I2S pins then will not be configured as I2S mode, and related GPIOs will be parsed and configured.</p>
<h2><a class="anchor" id="new_board_bringup_configuration_instructions_of_kernel"></a>
3.4 Kernel Configuration Instructions</h2>
<p >The main function of configuring the kernel is to modify DTS. This can be divided into two parts: common configuration of the SoC and specific configuration for the user’s board. This example uses the CV22 Walnut EVK board.<br  />
</p>
<ul>
<li>Common configuration: the corresponding DTS file is located in <code>ambarella/kernel/linux-/arch/arm64/boot/dts/ambarella/ambarella-cv22.dtsi</code>. For information regarding how to configure each node, users can refer to the kernel document <code>ambarella/kernel/linux-/Documentation/devicetree/bingings/arm/ambarella.txt</code></li>
<li>Board-specific configuration: the corresponding DTS file is located in <code>ambarella/boards/cv22_walnut/bsp/cv22_walnut.dts</code></li>
</ul>
<p >Further, Peripheral provides instructions for usage of peripheral hardware based on the Ambarella platform. <em>AMBARELLA_CV2x_HW_PRM.pdf</em> is the programming reference manual, which provides a detailed description pf each module’s registers. Contact the ambarella hardware support team to obtain this document.</p>
<hr  />
<h1><a class="anchor" id="new_board_bringup_faq"></a>
4. FAQ</h1>
<h2><a class="anchor" id="new_board_bringup_can_not_enter_force_usb_mode"></a>
4.1 Board Cannot Enter into Force USB Mode</h2>
<ol type="1">
<li>Check if POC[10] is pulled high. To enter force USB mode, POC[10] must be pulled high.</li>
<li>Verify that the power sequence and power supply for each hardware are normal.</li>
<li>Check if POC[6] is pulled low. When POC[6] is pulled low, the secure boot feature will be enabled and the board cannot enter into force USB mode.</li>
<li>Check if POC[3:1] are configured. The configuration of POC[3:1] decides the clocks of main components (IDSP, VDSP, DRAM, VISION, and CORTEX) and system cannot boot up when POC[3:1] is not configured correctly.</li>
<li>Check if there are issues in the USB circuit design.</li>
</ol>
<p >The checks above should remedy the issue. For more information on setting POCs, users can refer to <em>Ambarella_CV_POC_UG.pdf</em>. Contact the Ambarella hardware support team to obtain this document.</p>
<h2><a class="anchor" id="new_board_bringup_failed_to_test_memory"></a>
4.2 Failed to Perform Memory Test in AmbaUSB</h2>
<ol type="1">
<li>Verify that DDR power is normal.</li>
<li>Verify that the selection of the developing board (marked in a red box in the figure below) is correct.</li>
<li>Verify that the HDMI_REXT pin connects tightly. This pin cannot dangle because the chip current internal phase-locked loop (PLL) is obtained from this pin.</li>
</ol>
<div class="image">
<img src="../../board_bringup_choose_board_configure.png" alt=""/>
<div class="caption">
Figure 4-1. Board Selection in AmbaUSB.</div></div>
<p >If the checks above do not resolve the issue, the problem may be related to the default DDR parameters configured in the AmbaUSB tool. The parameters may not be suitable; contact the Ambarella support team for help.</p>
<hr  />
<h1><a class="anchor" id="board_bringup_license"></a>
5. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ("Software") are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
