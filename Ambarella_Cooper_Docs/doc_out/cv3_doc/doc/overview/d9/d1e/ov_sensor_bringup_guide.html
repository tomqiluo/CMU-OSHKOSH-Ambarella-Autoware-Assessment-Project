<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ambarella Linux SDK: Sensor Bring-Up Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Ambarella Linux SDK"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Ambarella Linux SDK<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d9/d1e/ov_sensor_bringup_guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Sensor Bring-Up Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sensor_bringup_overview"></a>
1. Overview</h1>
<p >This document guides users through the video input (VIN) bring-up process on the Ambarella platform.</p>
<p >This section is divided into the following sections:<br  />
</p>
<ul>
<li><a class="el" href="../../d9/d1e/ov_sensor_bringup_guide.html#sensor_bringup_key_updates">1.1 Key Updates</a></li>
</ul>
<h2><a class="anchor" id="sensor_bringup_key_updates"></a>
1.1 Key Updates</h2>
<a class="anchor" id="key_updates"></a>
<table class="doxtable">
<caption>Table 1-1. Key Updates.</caption>
<tr>
<th>Version </th><th>Updated Date </th><th>Modification </th></tr>
<tr>
<td align="center">1.0 </td><td align="center">20230202 </td><td>Initial Version </td></tr>
<tr>
<td align="center">1.1 </td><td align="center">20230922 </td><td>Move to common directory and add other SoC support </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="sensor_bringup_background"></a>
2. Background Introduction</h1>
<p >To aid customers through bringing-up the VIN and sensor, Ambarella provides the following guide to prepare, configure, and test the VIN and sensor on the Ambarella platform.<br  />
</p>
<hr  />
<h1><a class="anchor" id="sensor_bringup_sensor_bringup"></a>
3. Sensor Bring-Up</h1>
<p >This section describes the general Vin / sensor bring-up steps.<br  />
</p>
<h2><a class="anchor" id="sensor_bringup_preparation"></a>
3.1 Preparation</h2>
<p >Upon the arrival of a new sensor, the following steps must be performed:</p>
<ol type="1">
<li>Verify that the sensor driver exists in the software development kit (SDK). If not, Ambarella will add the sensor driver</li>
<li>Connect the sensor to the main board</li>
<li>Verify that the sensor module uses an internal crystal or an external clock.</li>
<li>Check if the sensor module's output format can be supported by the serializer / deserializer (SERDES) For example, a sensor module's output may be 16-bit RAW, but SERDES can only accept 14-bit RAW. To remedy this situation, users must modify the sensor's configuration or replace the SERDES group</li>
<li>Check if the sensor module includes an image signal processor (ISP). If the ISP is in the YUV module, the dummy sensor driver can be attempted; for example: <div class="fragment"><div class="line">board # modprobe ambds_brg mipi=1 w=1920 h=1080</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="sensor_bringup_non_serdes_bring_up"></a>
3.2 Non-SERDES Sensor Bring-Up</h2>
<h3><a class="anchor" id="sensor_bringup_hardware_information"></a>
3.2.1 Collect Sensor Hardware Information</h3>
<ul>
<li>Sensor type: AR0231, AR0239, OV9706, ...</li>
<li>Sensor interface: mobile industry processer interface (MIPI®), parallel, HiSPi™, ...</li>
<li>Sensor bits: 10 bits, 12 bits, 16 bits, ...</li>
<li>Sensor work voltage: 5 V, 12 V</li>
<li>Sensor clock: 24 MHz, 27 MHz; external oscillator or from another source, such as from the CV2x clock source gclk_so and from the serializer</li>
<li>Sensor reset pin: RC circuit or controlled by another general purpose input / output (GPIO)</li>
<li>Sensor I2C address</li>
</ul>
<h3><a class="anchor" id="sensor_bringup_configure_dts"></a>
3.2.2 Device Tree Configuration</h3>
<p >Similar to configuring most devices in Linux, VIN must be configured in the device trees (DTS).<br  />
 For example, when a sensor module is connected in I2C bus 3, the module should be configured as shown below:<br  />
</p>
<div class="image">
<img src="../../sensor_bringup_dts_local_sensor.png" alt=""/>
<div class="caption">
Figure 3-1. DTS Configuration of Local Sensor.</div></div>
<h3><a class="anchor" id="sensor_bringup_load_driver"></a>
3.2.3 Load Sensor Driver</h3>
<p >There are many sensors that can be supported in the Ambarella platform. The user must select the corresponding sensor driver when compiling the Ambarella SDK. An IMX335 sensor is used in the example below:<br  />
</p>
<dl class="section user"><dt>For CV2x SDK 3.0 Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  [*] Ambarella Linux Configuration ---&gt;</div>
<div class="line">    [*] Ambarella Private Drivers Configuration ---&gt;</div>
<div class="line">      [*] Build Ambarella <span class="keyword">private</span> Vin modules ---&gt;</div>
<div class="line">        [*] Ambarella Sensor Configuration ---&gt;</div>
<div class="line">          [*] Sony IMX335 5.14M CMOS sensor(MIPI)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  drv_modules  ---&gt;</div>
<div class="line">    platform  ---&gt;</div>
<div class="line">      vin  ---&gt;</div>
<div class="line">        sensors  ---&gt;</div>
<div class="line">          [*] kernel-module-imx335-mipi (drv_modules/platform/vin/sensors/sony_imx335_mipi)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Yocto build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  meta-ambabsp  ---&gt;</div>
<div class="line">    recipes-sensor  ---&gt;</div>
<div class="line">      [*] kernel-module-imx335-mipi (meta-ambabsp/recipes-sensor/kernel-module-imx335-mipi)</div>
</div><!-- fragment --></dd></dl>
<p>When the firmware is generated and downloaded onto the board, all sensor drivers are located in <code>/lib/modules//extra</code>. Users can use the insmod or modprobe commands to load the correct sensor driver.<br  />
</p>
<div class="fragment"><div class="line">board # modprobe imx335_mipi</div>
</div><!-- fragment --><p >Some parameters (such as bus_id, addr, vinc_id ...) can be specified when a sensor driver is loaded.</p>
<div class="fragment"><div class="line">board# modprobe imx335_mipi bus_id=xxx addr=xxx</div>
</div><!-- fragment --><h2><a class="anchor" id="sensor_bringup_serdes_bringup"></a>
3.3 SERDES Sensor Bring-Up</h2>
<h3><a class="anchor" id="sensor_bringup_hardware_information_three"></a>
3.3.1 Collect Sensor Hardware Information</h3>
<dl class="section user"><dt>Serializer</dt><dd></dd></dl>
<ul>
<li>Serializer type: MAX96705, TI953, TI913, TI935, ...</li>
<li>Serializer power source: power can come from a coaxial cable via power-on configuration (POC)</li>
<li>Important pins for serializer:</li>
<li>MAX96705:<ul>
<li>BWS and HIM pins: connecting the HIM pin to IOVDD is prefered</li>
<li>LCCEN pin: LCCEN typically connects to IOVDD. It can also connect to MAX96705's GPIO</li>
<li>Other pins include PWDNB, CONF0, CONF1, ...</li>
</ul>
</li>
<li>TI953 / TI913 / TI935:<ul>
<li>PDB pin: MODE_SET, CLK_IN, ...</li>
<li>Clock source can be an external oscillator or be supplied by deserializer through BC-ward</li>
</ul>
</li>
</ul>
<dl class="section user"><dt>Deserializer</dt><dd></dd></dl>
<ul>
<li>Deserializer type: MAX9286, TI954, TI936, ...</li>
<li>Power to deserializer</li>
<li>Important pins for deserializer:</li>
<li>MAX9286:<ul>
<li>BWS and HIM pins: connecting HIM pin to IOVDD is preferred<ul>
<li>Others pins include PWDNB, CONF0, CONF1, ...</li>
</ul>
</li>
</ul>
</li>
<li>TI954(clock, PDB pin, IDX, MODE, ...):<ul>
<li>IDX determines TI954's I2C bus address</li>
</ul>
</li>
</ul>
<p >MODE pin determines the TI954's receiver (RX) mode, and it can be programmed by the driver</p>
<h3><a class="anchor" id="sensor_bringup_serdes_config_dts"></a>
3.3.2 Configuration of Device Tree</h3>
<p >For more information on how to configure the SERDES driver, users can take reference from <a class="elRef" target="_blank" href="../../../driver/d2/dcb/page_sys_sensor_driver_installation.html#Sensors_with_SERDES_Bridge">3.4 Sensors with SERDES Bridge</a></p>
<h3><a class="anchor" id="sensor_bringup_load_serdes_driver"></a>
3.3.3 Load Sensor Driver</h3>
<p >Select the correct SERDES driver (such as B8 + imx290_brg). <br  />
</p>
<dl class="section user"><dt>For CV2x SDK 3.0 Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  [*] Ambarella Linux Configuration ---&gt;</div>
<div class="line">    [*] Ambarella Private Drivers Configuration ---&gt;</div>
<div class="line">      [*] Build Ambarella <span class="keyword">private</span> Vin modules ---&gt;</div>
<div class="line">        [*] Build Ambarella VIN bridge modules ---&gt;</div>
<div class="line">          [*] Ambarella B8</div>
<div class="line">          [*] Ambarella Sensor Configuration ---&gt;</div>
<div class="line">          [*] Bridge sensor ---&gt;</div>
<div class="line">            [*] Sony IMX290 2.13M CMOS Sensor(MIPI)(Bridge)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  drv_modules  ---&gt;</div>
<div class="line">    platform  ---&gt;</div>
<div class="line">      vin  ---&gt;</div>
<div class="line">        bridges  ---&gt;</div>
<div class="line">          [*] kernel-module-ambrg (drv_modules/platform/vin/bridges/ambrg)</div>
<div class="line">          [*]   kernel-module-b8 (drv_modules/platform/vin/bridges/b8)</div>
<div class="line">        sensors  ---&gt;</div>
<div class="line">          [*] kernel-module-imx290-brg (drv_modules/platform/vin/sensors/sony_imx290_brg)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Yocto build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  meta-ambabsp  ---&gt;</div>
<div class="line">    recipes-bridge  ---&gt;</div>
<div class="line">      [*] kernel-module-ambrg (meta-ambabsp/recipes-bridge/kernel-module-ambrg)</div>
<div class="line">      [*]   kernel-module-b8 (meta-ambabsp/recipes-bridge/kernel-module-b8)</div>
<div class="line">    recipes-sensor  ---&gt;</div>
<div class="line">      [*] kernel-module-imx290-mipi-brg (meta-ambabsp/recipes-sensor/kernel-module-imx290-mipi-brg)</div>
</div><!-- fragment --></dd></dl>
<p>When the firmware is generated and downloaded into board, all sensor drivers are located in <code>/lib/modules//extra</code>. Users can use insmod or modprobe command to load the correct sensor driver.<br  />
</p>
<p >For information on how to load the SERDES driver, users can reference <a class="elRef" target="_blank" href="../../../driver/d2/dcb/page_sys_sensor_driver_installation.html#driver_installation_guide"><ol type="1">
<li>Driver Installation Guide</li>
</ol>
</a>.</p>
<hr  />
<h1><a class="anchor" id="sensor_bringup_driver_introduction"></a>
4. Sensor and SERDES Driver Introduction</h1>
<h2><a class="anchor" id="sensor_bringup_iav_driver_structure"></a>
4.1 IAV Driver Structure</h2>
<p >The Ambarella video driver is called the image audio video (IAV) device driver. It includes a set of Linux device drivers that encapsulate the lower-level complexities of digital signal processor (DSP) core functionalities. The driver exposes a series of APIs that can be invoked using device IOCTL system calls. <a class="el" href="../../d9/d1e/ov_sensor_bringup_guide.html#fig_iav_driver_structure">Figure 4-1</a> displays the IAV structure.</p>
<p ><a class="anchor" id="fig_iav_driver_structure"></a></p><div class="image">
<img src="../../iav_driver_structure.png" alt=""/>
<div class="caption">
Figure 4-1. IAV Driver Structure.</div></div>
<h2><a class="anchor" id="sensor_bringup_sensor_driver"></a>
4.2 Sensor Driver</h2>
<p >The following figure is the system architecture of the sensor driver:</p>
<div class="image">
<img src="../../sensor_driver_architecture.png" alt=""/>
<div class="caption">
Figure 4-2. Sensor Driver Architecture.</div></div>
<p >Because there are so many sensor drivers, IMX335 is used as an example. The sensor ID is defined in <code>ambarella/include/iav_vin_common.h</code> for CV2x SDK 3.0 and <code>ambarella/drv_modules/private/video/dsp_/uapi/iav_vin_common.h</code> for Cooper SDK.</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> <a class="code hl_enumerationRef" target="_blank" href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#gabe47c58eecc0d607bd1f67835c9bc18a">sensor_list</a> {</div>
<div class="line">  ...</div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7ee126010a68414cecf0595312949178">SENSOR_IMX335</a> = 0x0000301A,</div>
<div class="line">  ...</div>
<div class="line">};</div>
<div class="ttc" id="agroup__iav-ioctl-vin-helper_html_gabe47c58eecc0d607bd1f67835c9bc18a"><div class="ttname"><a href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#gabe47c58eecc0d607bd1f67835c9bc18a">sensor_list</a></div><div class="ttdeci">sensor_list</div></div>
<div class="ttc" id="agroup__iav-ioctl-vin-helper_html_ggabe47c58eecc0d607bd1f67835c9bc18aa7ee126010a68414cecf0595312949178"><div class="ttname"><a href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7ee126010a68414cecf0595312949178">SENSOR_IMX335</a></div><div class="ttdeci">SENSOR_IMX335</div></div>
</div><!-- fragment --><p >When a new sensor driver is added, for Cooper SDK, <code>ambarella/build/bin/common/gen_build_chain.py</code> automatically manages the configuration of the compile switch; for CV2x SDK 3.0, the configuration for "menuconfig" must be added into <code>ambarella/kernel/private/platform/vin/sensors/AmbaConfig</code>.</p>
<div class="fragment"><div class="line">config CONFIG_SENSOR_IMX335_MIPI</div>
<div class="line">  <span class="keywordtype">bool</span> <span class="stringliteral">&quot;Sony IMX335 5.14M CMOS sensor(MIPI)&quot;</span></div>
<div class="line">  <span class="keywordflow">default</span> n</div>
<div class="line">  help</div>
<div class="line">       Select Sony IMX335 5.14M CMOS sensor.</div>
</div><!-- fragment --><p >There are five files for sony_imx335_mipi listed below.</p>
<div class="image">
<img src="../../tree_local_sensor_imx335.png" alt=""/>
<div class="caption">
Figure 4-3. Tree of IMX335 Driver on CV2x SDK 3.0.</div></div>
 <div class="image">
<img src="../../tree_local_sensor_imx335_cooper.png" alt=""/>
<div class="caption">
Figure 4-4. Tree of IMX335 Driver on Cooper SDK.</div></div>
<p >Many constants are defined in imx335.h. The register table and video modes that can be supported by IMX335 are listed in imx335_table.c.<br  />
</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code hl_structRef" target="_blank" href="../../../driver/d6/db6/structvin__video__format.html">vin_video_format</a> imx335_formats[] = {</div>
<div class="line">  ...</div>
<div class="line">     {  <span class="comment">// 2x2 binning linear: 720p60 12bits</span></div>
<div class="line">      .<a class="code hl_variableRef" target="_blank" href="../../../driver/d6/db6/structvin__video__format.html#ae112fded769b40c9e6746898ea35b13d">video_mode</a>            = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82ca998e87d8834983aa2526120821d0327a">AMBA_VIDEO_MODE_720P</a>,</div>
<div class="line">      .def_start_x           = (6+6+1296-1280) / 2,</div>
<div class="line">      .<a class="code hl_variableRef" target="_blank" href="../../../driver/d6/db6/structvin__video__format.html#af56ffed4659eeebdcc6184a9f054c6be">def_start_y</a>           = (4+4+972-720)/2 + 4,</div>
<div class="line">      .def_width             = 1280,</div>
<div class="line">      .def_height            = 720,</div>
<div class="line">     <span class="comment">//  sensor mode</span></div>
<div class="line">      .hdr_mode              = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggadee8cf6b5e7d4440b593dee128b40cbca619771d2f5c160239c431e4ee6cdd455">AMBA_VIDEO_LINEAR_MODE</a>,</div>
<div class="line">      .device_mode           = 2,</div>
<div class="line">      .pll_idx               = 1,</div>
<div class="line">      .width                 = 1280,</div>
<div class="line">      .height                = 720,</div>
<div class="line">      .format                = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggaa3f7b0ae74c549a99bdcf80cedca9074a7d1abc8077a1f4ca6c7d3e57debb9cea">AMBA_VIDEO_FORMAT_PROGRESSIVE</a>,</div>
<div class="line">      .type                  = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggabb48088ea2d26de5eed22d76111fcdb9a3b69859a5e3c36e5a151d53ae33b6f02">AMBA_VIDEO_TYPE_RGB_RAW</a>,</div>
<div class="line">      .bits                  = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggab2030203eb82b8e363b7f9cfe4cd68cea49d81de9fd3016c66e05438140721333">AMBA_VIDEO_BITS_12</a>, <span class="comment">// output format</span></div>
<div class="line">      .ratio                 = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#ggaf12d0cda52417be2f1f981747a2adc9fa217aa733c3abe9d7f23a81c7a221247e">AMBA_VIDEO_RATIO_16_9</a>,</div>
<div class="line">      .max_fps               = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#gga09812ec4ee4468ebaa0864878a08e2eaa50a3e5473e68c8df3a79ba94ba3f9a53">AMBA_VIDEO_FPS_60</a>, <span class="comment">// sensor&#39;s frame rate</span></div>
<div class="line">      .default_fps           = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#gga09812ec4ee4468ebaa0864878a08e2eaadb3eb6a5df5ab7c5e65709e69abe6cab">AMBA_VIDEO_FPS_29_97</a>,</div>
<div class="line">      .default_agc           = 0,</div>
<div class="line">      .default_shutter_time  = <a class="code hl_variableRef" target="_blank" href="../../../driver/d3/d5a/group__iav-common-helper.html#gga09812ec4ee4468ebaa0864878a08e2eaa50a3e5473e68c8df3a79ba94ba3f9a53">AMBA_VIDEO_FPS_60</a>,</div>
<div class="line">      .default_bayer_pattern = <a class="code hl_variableRef" target="_blank" href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#ggaa685d01f1263d2922d67926858510d95a9edf8dce55545368b8a6ec121482b0eb">VINDEV_BAYER_PATTERN_RG</a>,</div>
<div class="line">     },</div>
<div class="line">  ...</div>
<div class="line">};</div>
<div class="ttc" id="agroup__iav-common-helper_html_gga09812ec4ee4468ebaa0864878a08e2eaa50a3e5473e68c8df3a79ba94ba3f9a53"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#gga09812ec4ee4468ebaa0864878a08e2eaa50a3e5473e68c8df3a79ba94ba3f9a53">AMBA_VIDEO_FPS_60</a></div><div class="ttdeci">AMBA_VIDEO_FPS_60</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_gga09812ec4ee4468ebaa0864878a08e2eaadb3eb6a5df5ab7c5e65709e69abe6cab"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#gga09812ec4ee4468ebaa0864878a08e2eaadb3eb6a5df5ab7c5e65709e69abe6cab">AMBA_VIDEO_FPS_29_97</a></div><div class="ttdeci">AMBA_VIDEO_FPS_29_97</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggaa3f7b0ae74c549a99bdcf80cedca9074a7d1abc8077a1f4ca6c7d3e57debb9cea"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggaa3f7b0ae74c549a99bdcf80cedca9074a7d1abc8077a1f4ca6c7d3e57debb9cea">AMBA_VIDEO_FORMAT_PROGRESSIVE</a></div><div class="ttdeci">AMBA_VIDEO_FORMAT_PROGRESSIVE</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggab2030203eb82b8e363b7f9cfe4cd68cea49d81de9fd3016c66e05438140721333"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggab2030203eb82b8e363b7f9cfe4cd68cea49d81de9fd3016c66e05438140721333">AMBA_VIDEO_BITS_12</a></div><div class="ttdeci">AMBA_VIDEO_BITS_12</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggabb48088ea2d26de5eed22d76111fcdb9a3b69859a5e3c36e5a151d53ae33b6f02"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggabb48088ea2d26de5eed22d76111fcdb9a3b69859a5e3c36e5a151d53ae33b6f02">AMBA_VIDEO_TYPE_RGB_RAW</a></div><div class="ttdeci">AMBA_VIDEO_TYPE_RGB_RAW</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggadee8cf6b5e7d4440b593dee128b40cbca619771d2f5c160239c431e4ee6cdd455"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggadee8cf6b5e7d4440b593dee128b40cbca619771d2f5c160239c431e4ee6cdd455">AMBA_VIDEO_LINEAR_MODE</a></div><div class="ttdeci">AMBA_VIDEO_LINEAR_MODE</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggae1713c20e46dd967b9d34e7f8343f82ca998e87d8834983aa2526120821d0327a"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggae1713c20e46dd967b9d34e7f8343f82ca998e87d8834983aa2526120821d0327a">AMBA_VIDEO_MODE_720P</a></div><div class="ttdeci">AMBA_VIDEO_MODE_720P</div></div>
<div class="ttc" id="agroup__iav-common-helper_html_ggaf12d0cda52417be2f1f981747a2adc9fa217aa733c3abe9d7f23a81c7a221247e"><div class="ttname"><a href="../../../driver/d3/d5a/group__iav-common-helper.html#ggaf12d0cda52417be2f1f981747a2adc9fa217aa733c3abe9d7f23a81c7a221247e">AMBA_VIDEO_RATIO_16_9</a></div><div class="ttdeci">AMBA_VIDEO_RATIO_16_9</div></div>
<div class="ttc" id="agroup__iav-ioctl-vin-helper_html_ggaa685d01f1263d2922d67926858510d95a9edf8dce55545368b8a6ec121482b0eb"><div class="ttname"><a href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#ggaa685d01f1263d2922d67926858510d95a9edf8dce55545368b8a6ec121482b0eb">VINDEV_BAYER_PATTERN_RG</a></div><div class="ttdeci">VINDEV_BAYER_PATTERN_RG</div></div>
<div class="ttc" id="astructvin__video__format_html"><div class="ttname"><a href="../../../driver/d6/db6/structvin__video__format.html">vin_video_format</a></div></div>
<div class="ttc" id="astructvin__video__format_html_ae112fded769b40c9e6746898ea35b13d"><div class="ttname"><a href="../../../driver/d6/db6/structvin__video__format.html#ae112fded769b40c9e6746898ea35b13d">vin_video_format::video_mode</a></div><div class="ttdeci">u32 video_mode</div></div>
<div class="ttc" id="astructvin__video__format_html_af56ffed4659eeebdcc6184a9f054c6be"><div class="ttname"><a href="../../../driver/d6/db6/structvin__video__format.html#af56ffed4659eeebdcc6184a9f054c6be">vin_video_format::def_start_y</a></div><div class="ttdeci">u16 def_start_y</div></div>
</div><!-- fragment --><p >the main source code of the IMX335 sensor driver is included in imx335.c. The entry point of this driver is imx335_probe; it will be called when the user loads this driver. After initialization operations are completed in the probe function, the sensor driver will register the current sensor driver into the IAV module by calling the ambarella_vin_register_device interface. This interface passes an important parameter, imx335_ops, to the VIN module.<br  />
</p>
<div class="image">
<img src="../../imx335_mipi_ops.png" alt=""/>
<div class="caption">
Figure 4-5. IMX335_MIPI OPS.</div></div>
<p >Users can find the declaration of the <a class="elRef" target="_blank" href="../../../driver/de/de0/structvin__ops.html">vin_ops</a> structure in <code>ambarella/kernel/private/include/vin_api.h</code> for CV2x SDK 3.0 and <code>ambarella/drv_modules/private/video/dsp_/include/driver/vin_api.h</code> for Cooper SDK.<br  />
</p>
<div class="image">
<img src="../../vin_ops.png" alt=""/>
<div class="caption">
Figure 4-6. VIN OPS.</div></div>
<p >When the user wants to execute an operation, such as adjusting the frame rate of a sensor, an IOCTL system call must be executed at the application level. Then, the IAV's VIN module accepts this IOCTL system call, and the function pointer set_frame_rate in <a class="elRef" target="_blank" href="../../../driver/de/de0/structvin__ops.html">vin_ops</a> is called. Finally, imx335_set_fps is executed because it is assigned to the set_frame_rate function pointer.</p>
<h2><a class="anchor" id="sensor_bringup_serdes_driver"></a>
4.3 SERDES Driver</h2>
<p >The following figure is the system architecture of SERDES driver:</p>
<div class="image">
<img src="../../serdes_driver_architecture.png" alt=""/>
<div class="caption">
Figure 4-7. SERDES Driver Architecture.</div></div>
<h3><a class="anchor" id="sensor_bringup_sensor_bridge_driver"></a>
4.3.1 Bridge Sensor Driver</h3>
<p >Similar to imx335_mipi, imx335_mipi_brg is used as an example. The sensor ID is defined in <code>ambarella/include/iav_vin_common.h</code> for CV2x SDK 3.0 and <code>ambarella/drv_modules/private/video/dsp_/uapi/iav_vin_common.h</code> for Cooper SDK.</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> <a class="code hl_enumerationRef" target="_blank" href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#gabe47c58eecc0d607bd1f67835c9bc18a">sensor_list</a> {</div>
<div class="line">  ...</div>
<div class="line">  <a class="code hl_variableRef" target="_blank" href="../../../driver/d8/d8c/group__iav-ioctl-vin-helper.html#ggabe47c58eecc0d607bd1f67835c9bc18aa7ee126010a68414cecf0595312949178">SENSOR_IMX335</a> = 0x0000301A,</div>
<div class="line">     ...</div>
<div class="line">};</div>
</div><!-- fragment --><p >When a new bridge sensor driver is added, for Cooper SDK, <code>ambarella/build/bin/common/gen_build_chain.py</code> automatically manages the configuration of the compile switch; for CV2x SDK 3.0, the configuration for "menuconfig" must be added into <code>ambarella/kernel/private/platform/vin/sensors/AmbaConfig</code>.</p>
<div class="fragment"><div class="line">config CONFIG_SENSOR_IMX335_MIPI_BRG</div>
<div class="line">     <span class="keywordtype">bool</span> <span class="stringliteral">&quot;Sony IMX335 5.14M CMOS sensor(MIPI)(Bridge)&quot;</span></div>
<div class="line">     <span class="keywordflow">default</span> n</div>
<div class="line">     help</div>
<div class="line">         Select Sony IMX335 5.14M CMOS sensor, with MIPI output, <span class="keywordflow">for</span> bridge driver.</div>
</div><!-- fragment --><p >Video modes and operations are similar to IMX335; the differences of IMX335_BRG are located in imx335_probe. For imx335_mipi, after initialization operations are completed in the probe interface, ambarella_vin_register_device is called to create a connection with the IAV's VIN module. For imx335_mipi_brg, the VIN module calls amba_brg_register_device to create a connection with the bridge driver. Then, the bridge driver (ambrg.c) calls ambarella_vin_register_device with imx335_mipi_brg's OPS to create a connection with the IAV's VIN module.</p>
<h3><a class="anchor" id="sensor_bringup_serdes_driver_sub"></a>
4.3.2 SERDES Driver</h3>
<dl class="section user"><dt>Device Tree</dt><dd></dd></dl>
<div class="image">
<img src="../../dts_serdes.png" alt=""/>
<div class="caption">
Figure 4-8. SERDES Device Trees.</div></div>
<ul>
<li>brgpwr-gpios: power GPIO for deserializer</li>
<li>brgrst-gpios: reset GPIO for deserializer</li>
<li>bus-addr: related to the specified driver's parameter dts_addr</li>
<li>vinc_id: related to the bridge driver parameter vinc_id</li>
</ul>
<dl class="section user"><dt>Power-on and Reset</dt><dd></dd></dl>
<p>In the amba_register_vin_brg (ambrg.c) function, ambrg_init_pwr_rst_gpio will be called to get GPIO definitions from the device table.</p>
<p >Power-on and reset operations are executed in the ambarella_vin_register_device function:</p>
<div class="fragment"><div class="line"><a class="code hl_functionRef" target="_blank" href="../../../driver/d6/dea/vin__api_8h.html#abb5364fcbd04af79e110151d88bbb318">ambarella_vin_register_device</a></div>
<div class="line">  --&gt; init_vsrc_device</div>
<div class="line">     --&gt; vdev-&gt;ops-&gt;init_device (ambrg_init_device is assigned to <span class="keyword">this</span> function pointer)</div>
<div class="line">       --&gt; ambrg_hw_init</div>
<div class="line">         --&gt; ambrg_hw_reset</div>
<div class="ttc" id="avin__api_8h_html_abb5364fcbd04af79e110151d88bbb318"><div class="ttname"><a href="../../../driver/d6/dea/vin__api_8h.html#abb5364fcbd04af79e110151d88bbb318">ambarella_vin_register_device</a></div><div class="ttdeci">int ambarella_vin_register_device(struct vin_device *vdev, struct vin_ops *ops, struct vin_video_format *formats, u32 num_formats, struct vin_video_pll *plls, u32 num_plls)</div></div>
</div><!-- fragment --><dl class="section user"><dt>Bridge Driver Operations</dt><dd></dd></dl>
<ul>
<li>Interfaces to read and write registers:</li>
</ul>
<a class="anchor" id="read_write_interface"></a>
<table class="doxtable">
<caption>Table 4-1. Interfaces to Read and Write Registers.</caption>
<tr>
<th>Hardware </th><th>Read / Write </th><th>Interfaces Name </th></tr>
<tr>
<td align="center" rowspan="2">Serializer + Deserializer </td><td align="center">Read </td><td align="center">brg_read_reg </td></tr>
<tr>
<td align="center">Write </td><td align="center">brg_write_reg </td></tr>
<tr>
<td align="center" rowspan="2">Sensor </td><td align="center">Read </td><td align="center">brg_read_chan_reg </td></tr>
<tr>
<td align="center">Write </td><td align="center">brg_write_chan_reg </td></tr>
</table>
<ul>
<li>brg_hw_init_pre</li>
</ul>
<p >This interface is used to initialize SERDES and remap the I2C address of the serializer and sensor.</p>
<a class="anchor" id="brg_hw_init_pre"></a>
<table class="doxtable">
<caption>Table 4-2. Hardware Address and Remapping I2C Address.</caption>
<tr>
<th>Hardware </th><th>Hardware Address </th><th>I2C Address (Remapping) </th></tr>
<tr>
<td align="center">Serializer </td><td align="center">pinfo-&gt;i2c_ctrl.addr.ser_def </td><td align="center">pinfo-&gt;i2c_ctrl.addr.ser_chan0/ser_chan1 </td></tr>
<tr>
<td align="center">Sensor </td><td align="center">pinfo-&gt;sensor_ctrl.dev_addr </td><td align="left">1 pinfo-&gt;i2c_ctrl.add.sen_all<br  />
 2 IDC_ADDR_SEN_BASE + ... </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Texas Instrument's (TI) deserializer can automatically obtain the I2C address. Before remapping the I2C address, the deserializer will choose one port and turn off others.<br  />
</li>
<li>MAXIM requires software to specify the hardware address. Before remapping the i2c address, MAXIM will choose one link and turn off others.<br  />
</li>
<li>MAX9296 is used as an example: <div class="fragment"><div class="line">board# test_vin -r 0xffff</div>
<div class="line">  [0xffff: 0x8272a560]</div>
<div class="line">board# dmesg | tail -n 20</div>
<div class="line">  VIN: max9296[0] I2C address mapping</div>
<div class="line">  DES:0x90 &lt;-- 8 bit i2c address and real address needs to be shift 1 bit to right(0x48)</div>
<div class="line">  SER A:0x82</div>
<div class="line">  SER B:0xa2</div>
<div class="line">  SEN base:0x60 &lt;-- IDC_ADDR_SEN_BASE</div>
<div class="line">  SEN all:0x74 &lt;-- address after remapping</div>
<div class="line">  CMU:locked!</div>
<div class="line">  ERRB:off!</div>
<div class="line">  GMSL2 link:locked! &lt;-- needs to check whether SerDes is locked or not firstly</div>
<div class="line">  Active link mode:0x60!</div>
<div class="line">  Link A Decoding:pass!</div>
<div class="line">  Link B Decoding:pass!</div>
<div class="line">  Idle word:pass!</div>
<div class="line">  Line Fault:pass!</div>
<div class="line">  Remote side:pass!</div>
</div><!-- fragment --></li>
</ul>
</dd></dl>
<ul>
<li>brg_set_clk_si</li>
</ul>
<p >Some sensors do not use a crystal to provide a clock but instead require SERDES to output an external clock.</p>
<ul>
<li>brg_vin_config_pre</li>
</ul>
<p >This interface is used to initialize connecting the configuration for the serializer and sensor.</p>
<a class="anchor" id="brg_vin_config_pre"></a>
<table class="doxtable">
<caption>Table 4-3. Parameters in brg_vin_config_pre.</caption>
<tr>
<th>Parameter Name </th><th>Description </th></tr>
<tr>
<td align="center">Lane_number </td><td align="center">SENSOR_2_LANE / SENSOR_4_LANE </td></tr>
<tr>
<td align="center">Lane mapping </td><td align="center">Lane order can change </td></tr>
<tr>
<td align="center">Lane speed </td><td align="center">Bandwidth to receive sensor data </td></tr>
<tr>
<td align="center">Pipeline / streamID </td><td align="center">Related to vender </td></tr>
</table>
<ul>
<li>brg_vout_config</li>
</ul>
<p >This interface is used to configure parameters between the deserializer and the SoC:</p>
<a class="anchor" id="brg_vout_config"></a>
<table class="doxtable">
<caption>Table 4-4. Parameters in brg_vout_config.</caption>
<tr>
<th>Parameter Name </th><th>Description </th></tr>
<tr>
<td align="center">lane_number </td><td align="center">SENSOR_2_LANE / SENSOR_4_LANE </td></tr>
<tr>
<td align="center">interface_type </td><td align="center">SENSOR_MIPI / SENSOR_MIPI_VC / ... </td></tr>
<tr>
<td align="center">data_rate </td><td align="left">Choose the closest speed; otherwise, the video frame may be a single line.<br  />
 enum { <br  />
 SENSOR_MIPI_BIT_RATE_M = 0, // default, ~ 400Mbps<br  />
 SENSOR_MIPI_BIT_RATE_H, // ~ 800Mbps<br  />
 SENSOR_MIPI_BIT_RATE_L, // ~ 200Mbps<br  />
 SENSOR_MIPI_BIT_RATE_UH, // ~ 2200Mbps<br  />
 SENSOR_MIPI_BIT_RATE_NA, // for non-MIPI sensor<br  />
 }; </td></tr>
</table>
<ul>
<li>brg_get_status</li>
</ul>
<p >This interface is used to check SERDES status. When SERDES is locked, the serializer registers can be read.</p>
<hr  />
<h1><a class="anchor" id="sensor_bringup_debug"></a>
5. Debug</h1>
<h2><a class="anchor" id="sensor_bringup_measure_signal"></a>
5.1 Sensor Signal</h2>
<p >When a new sensor cannot function normally, MIPI CLK / DATA and SYNC signals must be checked first.<br  />
</p>
<h2><a class="anchor" id="sensor_bringup_i2c_tool"></a>
5.2 I2C Tools</h2>
<p >Certain I2C tools can be used to debug, such as i2cdetect and i2ctranfer.</p>
<div class="fragment"><div class="line">board # echo 0 &gt; /proc/sys/kernel/printk</div>
<div class="line">board # modprobe i2c-dev</div>
<div class="line">board # i2cdetect -ya 2</div>
</div><!-- fragment --><p >The command "i2cdetect -ya 2" scans all I2C devices mounted on I2C bus 2.</p>
<div class="fragment"><div class="line">board # i2ctransfer -yf 2 w1@0x38 0x5b r1</div>
</div><!-- fragment --><p >The command "i2ctransfer -yf 2 w1@0x38 0x5b r1" reads register 0x5b's data from I2C device, which is mounted on I2C bus 2 with an I2C address equal to 0x38.</p>
<div class="fragment"><div class="line">board # i2ctransfer -yf 2 w2@0x38 0x11 0x13</div>
</div><!-- fragment --><p >The command "i2ctransfer -yf 2 w2@0x38 0x11 0x13 " writes 0x13 to the register 0x11 of the I2C device, which is mounted on I2C bus 2 with an I2C address equal to 0x38.</p>
<div class="fragment"><div class="line">board # modprobe ambad</div>
<div class="line">board # amba_debug -g 81 -d 1</div>
</div><!-- fragment --><p >The command "amba_debug -g 81 -d 1" manually pulls GPIO 81 to a high level.</p>
<h2><a class="anchor" id="sensor_bringup_test_vin"></a>
5.3 test_vin</h2>
<p >The unit test program test_vin is located in <code>ambarella/unit_test/private/vin_test/test_vin.c</code> for CV2x SDK 3.0 and <code>ambarella/unit_test/private/iav_test/dsp_/vin/test_vin.c</code>. By default, it is compiled into te firmware with $board_ipcam_config selected.<br  />
</p>
<p >The following is the usage information of test_vin:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># test_vin</span></div>
<div class="line">test_vin usage:</div>
<div class="line">-i --vin [vin mode]             change vin mode</div>
<div class="line">-S --src [<a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a>]               select <a class="code hl_variableRef" target="_blank" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a>(vsrc_id)</div>
<div class="line">-h --<span class="keywordflow">switch</span>-reg-ctx [vsrc_id]   <span class="keywordflow">switch</span> vsrc context</div>
<div class="line">-f --frame-rate [frate]         set encoding frame rate</div>
<div class="line">-m --mirror-pattern [0~3]       set vin mirror pattern, 0:none, 1:flip, 2:mirror, 3:mirror&amp;flip, 255:<span class="keyword">auto</span></div>
<div class="line">-<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> --bayer-pattern [0~3]        set vin bayer pattern, 0:RG, 1:BG, 2:GR, 3:GB, 255:AUTO</div>
<div class="line">-t --test-fps [vinc_id]         test vin fps</div>
<div class="line">-r --read-reg [addr]            read regisger</div>
<div class="line">-w --write-reg [addr]           write <span class="keyword">register</span></div>
<div class="line">-d --reg-data [data]            the <span class="keyword">register</span> data to write</div>
<div class="line">-n --reg-<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> [<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>]          <span class="keyword">register</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> to read/write</div>
<div class="line">-s --shutter [1-8000]           set shutter time in 1/n sec <a class="code hl_variableRef" target="_blank" href="../../../driver/d6/db6/structvin__video__format.html#a97667129c1e0d8b4fe4909f6635977d2">format</a></div>
<div class="line">-g --agc-<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> [<a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a>]          set agc <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a>, -n <span class="keywordflow">for</span> <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div>
<div class="line">-c --ae-check [0 or 1]          enable/disable shutter/agc check</div>
<div class="line">-e --set-stream [0 or 1]        set sensor streaming mode</div>
<div class="line">-p --set-tp [tp_mode]           set sensor test pattern</div>
<div class="line">-A --awb [set awb]              set sensor awb gain</div>
<div class="line">   --rgain [1024~6144]          set sensor r gain, 1024 stand <span class="keywordflow">for</span> 1X gain</div>
<div class="line">   --bgain [1024~6144]          set sensor <a class="code hl_variableRef" target="_blank" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> gain, 1024 stand <span class="keywordflow">for</span> 1X gain</div>
<div class="line">   --hdr-mode [0~3|15]          set VIN HDR mode</div>
<div class="line">   --max-fps [max fps]          set VIN max fps</div>
<div class="line">   --<a class="code hl_variableRef" target="_blank" href="../../../driver/d6/db6/structvin__video__format.html#a890f59302dd3148726197557dad05bf9">bits</a> [8|10|12]             set VIN bit</div>
<div class="line">   --dual-gain [0~2]            set dual gain mode, 0:off, 1:hcg+lcg, 2:hcg+lcg combined</div>
<div class="line">   --runtime-<span class="keywordflow">switch</span>             Runtime <span class="keywordflow">switch</span> vin mode</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
<div class="ttc" id="acJSON_8h_html_a750b5d744c39a06bfb13e6eb010e35d0"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a></div><div class="ttdeci">int index</div></div>
<div class="ttc" id="acJSON_8h_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div><div class="ttdeci">int count</div></div>
<div class="ttc" id="astructvin__video__format_html_a890f59302dd3148726197557dad05bf9"><div class="ttname"><a href="../../../driver/d6/db6/structvin__video__format.html#a890f59302dd3148726197557dad05bf9">vin_video_format::bits</a></div><div class="ttdeci">u8 bits</div></div>
<div class="ttc" id="astructvin__video__format_html_a97667129c1e0d8b4fe4909f6635977d2"><div class="ttname"><a href="../../../driver/d6/db6/structvin__video__format.html#a97667129c1e0d8b4fe4909f6635977d2">vin_video_format::format</a></div><div class="ttdeci">u8 format</div></div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div></div>
</div><!-- fragment --><p >Here, users can use the <code>test_vin</code> options "-r" and "-w" to read and write registers:</p>
<div class="fragment"><div class="line">board # test_vin -r $register_address -n $registers_amount</div>
<div class="line">board # test_vin -w $register_address -d $value</div>
</div><!-- fragment --><h2><a class="anchor" id="sensor_bringup_soc_registers"></a>
5.4 Check SoC Registers</h2>
<p >Users can use amba_debug to dump SoC's registers, as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// VIN0</span></div>
<div class="line">board # amba_debug -w 0xed1c8000   -d 0x1000 &amp;&amp; amba_debug -r 0xed1c0000   -s 0x120 (CV2x)</div>
<div class="line">board # amba_debug -w 0x20ed1e8000 -d 0x1000 &amp;&amp; amba_debug -r 0x20ed1e0000 -s 0x140 (CV5x)</div>
<div class="line">board # amba_debug -w 0xffed1e8000 -d 0x1000 &amp;&amp; amba_debug -r 0xffed1e0000 -s 0x140 (CV7x)</div>
<div class="line"><span class="comment">// VIN1</span></div>
<div class="line">board # amba_debug -w 0xed1c8000   -d 0xa000 &amp;&amp; amba_debug -r 0xed1c0000   -s 0x120 (CV2x)</div>
<div class="line">board # amba_debug -w 0x20ed1e8000 -d 0x2000 &amp;&amp; amba_debug -r 0x20ed1e0000 -s 0x140 (CV5x)</div>
<div class="line">board # amba_debug -w 0xffed1e8000 -d 0x2000 &amp;&amp; amba_debug -r 0xffed1e0000 -s 0x140 (CV7x)</div>
</div><!-- fragment --><p >When the system is abnormal or in reset status, value of register 0xed1c800 (CV2x), 0x20ed1e8000 (CV5x) and 0xffed1e8000 are 0x00000001.</p>
<ul>
<li>The normal value of register 0xed1c00c8 in master mode is 0x2841 (CV2x);</li>
<li>The normal value of register 0x20ed1e00bc in master mode is 0xf (CV5x);</li>
<li>The normal value of register 0xffed1e00bc in master mode is 0xf (CV7x);</li>
<li>the normal value in slave mode is 0x3841; (CV2x)</li>
<li>the normal value in slave mode is 0x40f; (CV5x and CV7x)</li>
</ul>
<h2><a class="anchor" id="sensor_bringup_debug_dsp_log"></a>
5.5 Capture DSP Log</h2>
<p >Ambarella provides the tool dsplog_cap to capture the DSP log. Detailed debug information can help users locate issues. Following steps will display how to configure and use this tool:</p>
<p >1). Enable building <code>dsplog_cap</code></p>
<dl class="section user"><dt>For CV2x SDK 3.0 Amba build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  [*] Ambarella Linux Configuration ---&gt;</div>
<div class="line">    [*] Ambarella Private Drivers Configuration ---&gt;</div>
<div class="line">      [*] Build Ambarella DSP Log Driver module</div>
<div class="line">@code {.c}</div>
<div class="line"> </div>
<div class="line">@par For Cooper SDK Amba build:</div>
<div class="line">@code {.c}</div>
<div class="line">build$ make menuconfig</div>
<div class="line">  drv_modules  ---&gt;</div>
<div class="line">    platform  ---&gt;</div>
<div class="line">      [*] kernel-module-dsplog (drv_modules/platform/dsplog)  ---&gt;</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Yocto build:</dt><dd><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">  meta-ambabsp  ---&gt;</div>
<div class="line">    recipes-dbgtool  ---&gt;</div>
<div class="line">      [*] kernel-module-dsplog (meta-ambabsp/recipes-dbgtool/kernel-module-dsplog)  ---&gt;</div>
</div><!-- fragment --></dd></dl>
<p>2). Start to capture the DSP log</p>
<p >board # init.sh &ndash;na board # modprobe ambad board # modprobe dsplog board # dsplog_cap -m all -b all -l 3 -r 0 -o /tmp/dsplog.bin -p 10000000 &amp; </p>
<p >3). When DSP enters into abnormal status:</p>
<div class="fragment"><div class="line">board # killall dsplog_cap</div>
<div class="line">board # dsplog_cap -i /tmp/dsplog.bin -f /tmp/dsplog.txt</div>
</div><!-- fragment --><p >4). Then, users can send dsplog.txt to the Ambarella support team to receive help.</p>
<h2><a class="anchor" id="sensor_bringup_vin_synchronization_fail"></a>
5.6 VIN: Port[0] Synchronization Fail</h2>
<p >When this issue occurs, check if:</p>
<ul>
<li>FSYNC pin is connected</li>
<li>The wait time before synchronization is insufficient</li>
</ul>
<h2><a class="anchor" id="sensor_bringup_video_black"></a>
5.7 Video Frame is Completely Black</h2>
<p >When this issue occurs, follow the steps below:</p>
<ol type="1">
<li>Enssure that auto white balance (AWB) / auto exposure (AE) / auto focus (AF) (3A) parameters are correct</li>
<li>Verify if VIN outputs video data, dump the VIN register, and check the number of lanes</li>
<li>Ensure that SERDES has data</li>
<li>Ensure that the sensor has data and check the data pin wave</li>
<li>If multiple sensors are connected, ensure that FSYNC / TRIGGER pins are connected</li>
</ol>
<h2><a class="anchor" id="sensor_bringup_drop_frame"></a>
5.8 Frame Drop</h2>
<p >Users can use the unit test programs test_encode and test_stream to check if frame drop issues occur. Below is an example on CV25 Hazelnut Evaluation Kit (EVK) with an IMX274 sensor:</p>
<div class="fragment"><div class="line">board # init.sh --na</div>
<div class="line">board # modprobe imx274_mipi</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line">board # test_encode -i1080p --hdmi 720p -X --bmaxsize 1080p --bsize 1080p</div>
<div class="line">board # test_encode -A -h1080p -e</div>
<div class="line">board # test_stream --nofile</div>
</div><!-- fragment --><p >Then, users can watch the average frames per second (FPS) printed by test_stream unit test commands.</p>
<p >Along with the method mentioned above, the feature "IDSP drop audit function" detects frame drops. For more details about this feature, refer to example3_audit_function for CV2x and <a class="elRef" target="_blank" href="../../../video/dc/d27/fs_adv_pl_latency.html#frame_drop_aud">3.5 IDSP and Encode Frame Drop Audit</a> for other SoCs.</p>
<hr  />
<h1><a class="anchor" id="sensor_bringup_license"></a>
6. License</h1>
<p >Copyright (c) 2024 Ambarella International LP.</p>
<p >This file and its contents ( "Software" ) are protected by intellectual property rights including, without limitation, U.S. and/or foreign copyrights. This Software is also the confidential and proprietary information of Ambarella International LP and its licensors. You may not use, reproduce, disclose, distribute, modify, or otherwise prepare derivative works of this Software or any portion thereof except pursuant to a signed license agreement or nondisclosure agreement with Ambarella International LP or its authorized affiliates. In the absence of such an agreement, you agree to promptly notify and return this Software to Ambarella International LP.</p>
<p >THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY, AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL AMBARELLA INTERNATIONAL LP OR ITS AFFILIATES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; COMPUTER FAILURE OR MALFUNCTION; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
