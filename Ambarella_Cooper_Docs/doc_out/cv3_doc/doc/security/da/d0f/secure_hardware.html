<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: Secure Hardware</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('da/d0f/secure_hardware.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Secure Hardware </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="otp_history"></a>
0. Revision History</h1>
<a class="anchor" id="secure_hardware_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Version</th><th>Updated Date</th><th align="left">Modification </th></tr>
<tr>
<td>0.0.1</td><td>20231217</td><td>Initial Version </td></tr>
</table>
<h1><a class="anchor" id="otp"></a>
1. One-Time Programmable</h1>
<p >One-time programmable (OTP) is a hardware component inside the CV5x / CV7x / CV3 system on chip (SoC). The total size of OTP is 8 KB.</p>
<hr  />
<h2><a class="anchor" id="otp_layout"></a>
1.1. OTP Data Layout</h2>
<p >OTP can be programmed only once; if programmed incorrectly, the chip will become unusable. Ambarella's OTP has 32768 bits. The layout of OTP is divided into two sections: the Ambarella-defined sections, which comprises the first 16128 bits, and the user-defined sections, which comprises the remainder. The following table displays the properties of the Ambarella-defined OTP.</p>
<a class="anchor" id="otp_data_layout"></a>
<table class="doxtable">
<caption>Table 1-1. OTP Data Layout.</caption>
<tr>
<th align="left">No.</th><th align="left">Bit Address (DEC)</th><th align="left">Bit Address (HEX)</th><th align="left">Bits</th><th align="left">OTP Function</th><th align="left">Lock Bit </th></tr>
<tr>
<td>1</td><td>0 - 63</td><td>0x0000 - 0x003F</td><td>64</td><td>Reserved by Ambarella</td><td>Lock bit 0 </td></tr>
<tr>
<td>2</td><td>64 - 86</td><td>0x0040 - 0x0056</td><td>23</td><td>sys_config</td><td rowspan="9">Lock bit 3 </td></tr>
<tr>
<td>3</td><td>87 - 92</td><td>0x0057 - 0x005C</td><td>6</td><td>unused </td></tr>
<tr>
<td>4</td><td>93 - 93</td><td>0x005D -0x005D</td><td>1</td><td>sys_config </td></tr>
<tr>
<td>5</td><td>94 - 95</td><td>0x005E -0x005F</td><td>2</td><td>sys_config </td></tr>
<tr>
<td>6</td><td>96 - 118</td><td>0x0060 - 0x0076</td><td>23</td><td>sys_config </td></tr>
<tr>
<td>7</td><td>119 - 124</td><td>0x0077 - 0x007C</td><td>6</td><td>unused </td></tr>
<tr>
<td>8</td><td>125 - 125</td><td>0x007D - 0x007D</td><td>1</td><td>sys_config </td></tr>
<tr>
<td>9</td><td>126 - 126</td><td>0x007F - 0x007E</td><td>1</td><td>sys_config </td></tr>
<tr>
<td>19</td><td>127 - 127</td><td>0x007F - 0x007F</td><td>1</td><td>efuse_disable_jtag </td></tr>
<tr>
<td>11</td><td>128 - 191</td><td>0x0080 - 0x00BF</td><td>64</td><td>Reserved by Ambarella</td><td>Lock bit 2 </td></tr>
<tr>
<td>12</td><td>192 - 223</td><td>0x00C0 - 0x00DF</td><td>32</td><td>write_lock</td><td>No lock </td></tr>
<tr>
<td>13</td><td>224 - 255</td><td>0x00E0 - 0x00FF</td><td>32</td><td>cst_seed</td><td>Lock bit 4 </td></tr>
<tr>
<td>14</td><td>256 - 383</td><td>0x0100 - 0x017F</td><td>128</td><td>Unique ID</td><td>Lock bit 1 </td></tr>
<tr>
<td>15</td><td>384 - 511</td><td>0x0180 - 0x01FF</td><td>128</td><td>cst_cuk</td><td>Lock bit 4 </td></tr>
<tr>
<td>16</td><td>512 - 767</td><td>0x0200 - 0x02FF</td><td>256</td><td>Reserved by Ambarella</td><td rowspan="2">Lock bit 0 </td></tr>
<tr>
<td>17</td><td>768 - 15999</td><td>0x0300 - 0x3E7F</td><td>15232</td><td>Reserved by Ambarella </td></tr>
<tr>
<td>18</td><td>16000 - 16015</td><td>0x3E80 - 0x3E8F</td><td>16</td><td>data_invalid</td><td rowspan="5">No lock </td></tr>
<tr>
<td>19</td><td>16016 - 16016</td><td>0x3E90 - 0x3E90</td><td>1</td><td>anti_rollback_en </td></tr>
<tr>
<td>20</td><td>16017 - 16017</td><td>0x3E91 - 0x3E91</td><td>1</td><td>secure_usb_boot_disable </td></tr>
<tr>
<td>21</td><td>16018 - 16031</td><td>0x3E92 - 0x3E9F</td><td>14</td><td>misc_config </td></tr>
<tr>
<td>22</td><td>16032 - 16127</td><td>0x3EA0 - 0x3EFF</td><td>96</td><td>bst_ver_cnt </td></tr>
<tr>
<td>23</td><td>16128 - 16255</td><td>0x3F00 - 0x3F7F</td><td>128</td><td>serial_number</td><td>Lock bit 5 </td></tr>
<tr>
<td>24</td><td>16256 - 16383</td><td>0x3F00 - 0x3FFF</td><td>128</td><td>OTP_TEST</td><td>Lock bit 6 </td></tr>
<tr>
<td>25</td><td>16384 - 16639</td><td>0x4000 - 0x40FF</td><td>256</td><td>HUK</td><td>Lock bit 11 </td></tr>
<tr>
<td>26</td><td>16640 - 16895</td><td>0x4100 - 0x41FF</td><td>256</td><td>USER_CUK</td><td>Lock bit 12 </td></tr>
<tr>
<td>27</td><td>16896 - 17151</td><td>0x4200 - 0x42FF</td><td>256</td><td>AES_KEY_0</td><td>Lock bit 13 </td></tr>
<tr>
<td>28</td><td>17152 - 17407</td><td>0x4300 - 0x43FF</td><td>256</td><td>AES_KEY_1</td><td>Lock bit 14 </td></tr>
<tr>
<td>29</td><td>16408 - 17663</td><td>0x4400 - 0x44FF</td><td>256</td><td>AES_KEY_2</td><td>Lock bit 15 </td></tr>
<tr>
<td>30</td><td>16664 - 17919</td><td>0x4500 - 0x45FF</td><td>256</td><td>AES_KEY_3</td><td>Lock bit 16 </td></tr>
<tr>
<td>31</td><td>17920 - 18175</td><td>0x4600 - 0x46FF</td><td>256</td><td>ECC_KEY_0</td><td>Lock bit 17 </td></tr>
<tr>
<td>32</td><td>18176 - 18431</td><td>0x4700 - 0x47FF</td><td>256</td><td>ECC_KEY_1</td><td>Lock bit 18 </td></tr>
<tr>
<td>33</td><td>18432 - 18687</td><td>0x4800 - 0x48FF</td><td>256</td><td>ECC_KEY_2</td><td>Lock bit 19 </td></tr>
<tr>
<td>34</td><td>18688 - 18943</td><td>0x4900 - 0x49FF</td><td>256</td><td>ECC_KEY_3</td><td>Lock bit 20 </td></tr>
<tr>
<td>35</td><td>18944 - 19199</td><td>0x4A00 - 0x4AFF</td><td>256</td><td>USER_SLOT_0</td><td>Lock bit 21 </td></tr>
<tr>
<td>36</td><td>19200 - 19455</td><td>0x4B00 - 0x4BFF</td><td>256</td><td>USER_SLOT_1</td><td>Lock bit 22 </td></tr>
<tr>
<td>37</td><td>19456 - 19711</td><td>0x4C00 - 0x4CFF</td><td>256</td><td>USER_SLOT_2</td><td>Lock bit 23 </td></tr>
<tr>
<td>38</td><td>19712 - 19967</td><td>0x4D00 - 0x4DFF</td><td>256</td><td>USER_SLOT_3</td><td>Lock bit 24 </td></tr>
<tr>
<td>39</td><td>19968 - 20223</td><td>0x4E00 - 0x4EFF</td><td>256</td><td>USER_SLOT_4</td><td>Lock bit 25 </td></tr>
<tr>
<td>40</td><td>20224 - 20479</td><td>0x4F00 - 0x4FFF</td><td>256</td><td>USER_SLOT_5</td><td>Lock bit 26 </td></tr>
<tr>
<td>41</td><td>20480 - 20735</td><td>0x5000 - 0x50FF</td><td>256</td><td>ROT_KEY_0</td><td rowspan="16">Lock bit 8 </td></tr>
<tr>
<td>42</td><td>20736 - 20991</td><td>0x5100 - 0x51FF</td><td>256</td><td>ROT_KEY_1 </td></tr>
<tr>
<td>43</td><td>20736 - 20991</td><td>0x5200 - 0x52FF</td><td>256</td><td>ROT_KEY_2 </td></tr>
<tr>
<td>44</td><td>20992 - 21503</td><td>0x5300 - 0x53FF</td><td>256</td><td>ROT_KEY_3 </td></tr>
<tr>
<td>45</td><td>21504 - 21759</td><td>0x5400 - 0x54FF</td><td>256</td><td>ROT_KEY_4 </td></tr>
<tr>
<td>46</td><td>21760 - 22015</td><td>0x5500 - 0x55FF</td><td>256</td><td>ROT_KEY_5 </td></tr>
<tr>
<td>47</td><td>22016 - 22271</td><td>0x5600 - 0x56FF</td><td>256</td><td>ROT_KEY_6 </td></tr>
<tr>
<td>48</td><td>22272 - 22527</td><td>0x5700 - 0x57FF</td><td>256</td><td>ROT_KEY_7 </td></tr>
<tr>
<td>49</td><td>22528 - 22783</td><td>0x5800 - 0x58FF</td><td>256</td><td>ROT_KEY_8 </td></tr>
<tr>
<td>50</td><td>22784 - 23039</td><td>0x5900 - 0x59FF</td><td>256</td><td>ROT_KEY_9 </td></tr>
<tr>
<td>51</td><td>23040 - 23295</td><td>0x5A00 - 0x5AFF</td><td>256</td><td>ROT_KEY_10 </td></tr>
<tr>
<td>52</td><td>23296 - 23551</td><td>0x5B00 - 0x5BFF</td><td>256</td><td>ROT_KEY_11 </td></tr>
<tr>
<td>53</td><td>23552 - 23807</td><td>0x5C00 - 0x5CFF</td><td>256</td><td>ROT_KEY_12 </td></tr>
<tr>
<td>54</td><td>23808 - 24063</td><td>0x5D00 - 0x5DFF</td><td>256</td><td>ROT_KEY_13 </td></tr>
<tr>
<td>55</td><td>24064 - 24319</td><td>0x5E00 - 0x5EFF</td><td>256</td><td>ROT_KEY_14 </td></tr>
<tr>
<td>56</td><td>24320 - 24575</td><td>0x5F00 - 0x5FFF</td><td>256</td><td>ROT_KEY_15 </td></tr>
<tr>
<td>57</td><td>24576 - 24831</td><td>0x6000 - 0x60FF</td><td>256</td><td>MONO_COUNT_0</td><td rowspan="6">No lock </td></tr>
<tr>
<td>58</td><td>24832 - 25087</td><td>0x6100 - 0x61FF</td><td>256</td><td>MONO_COUNT_1 </td></tr>
<tr>
<td>59</td><td>25088 - 25599</td><td>0x6200 - 0x63FF</td><td>512</td><td>MONO_COUNT_2 </td></tr>
<tr>
<td>60</td><td>25600 - 26623</td><td>0x6400 - 0x67FF</td><td>1024</td><td>USER_DATA_0 </td></tr>
<tr>
<td>61</td><td>26624 - 27647</td><td>0x6800 - 0x6BFF</td><td>1024</td><td>USER_DATA_1 </td></tr>
<tr>
<td>62</td><td>27648 - 28671</td><td>0x6C00 - 0x6FFF</td><td>1024</td><td>USER_DATA_2 </td></tr>
<tr>
<td>63</td><td>28672 - 29695</td><td>0x7000 - 0x73FF</td><td>1024</td><td>USER_SLOT_6</td><td>Lock bit 27 </td></tr>
<tr>
<td>64</td><td>29696 - 30719</td><td>0x7400 - 0x77FF</td><td>1024</td><td>USER_SLOT_7</td><td>Lock bit 28 </td></tr>
<tr>
<td>65</td><td>30720 - 31743</td><td>0x7800 - 0x7BFF</td><td>1024</td><td>USER_SLOT_8</td><td>Lock bit 29 </td></tr>
<tr>
<td>66</td><td>31744 - 32767</td><td>0x7C00 - 0x7FFF</td><td>1024</td><td>USER_SLOT_9</td><td>Lock bit 30 </td></tr>
</table>
<hr  />
<h2><a class="anchor" id="program_otp"></a>
1.2. Program OTP</h2>
<p >The Ambarella software development kit (SDK) supports programming OTP with or without a trusted operating system (TOS), such as the open programmable trusted execution environment (OP-TEE). When there is a TOS, use <code>test_program_otp</code>. When there is no TOS, use <code>test_otp</code>. The <code>test_program_otp</code> includes the client application (CA) and the pseudo trusted application (PTA) to program / read the OTP:</p><ul>
<li>CA: <code>SDK/external/tee/optee_test/host/test_program_otp.c</code></li>
<li>PTA: <code>SDK/external/tee/optee_os/core/arch/arm/pta/pta_ambarella_otp.c</code></li>
</ul>
<p >Below are <code>test_program_otp</code> options: </p><div class="fragment"><div class="line">--writepubkey [%%d] [%%s] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writepubkey<span class="stringliteral">&#39; writes (%%d&#39;</span>th) the root of trust (RoT) <span class="keyword">public</span> key (file name %%s) and locks (%%d)\n</div>
<div class="line">--readpubkey [%%d]<span class="stringliteral">&#39;: &#39;</span>--readpubkey<span class="stringliteral">&#39; reads (%%d&#39;</span>th) the RoT <span class="keyword">public</span> key</div>
<div class="line">--readpubkeydigest [%%d]<span class="stringliteral">&#39;: &#39;</span>--readpubkeydigest<span class="stringliteral">&#39; reads (%%d&#39;</span>th) the RoT <span class="keyword">public</span> key<span class="stringliteral">&#39;s digest</span></div>
<div class="line"><span class="stringliteral">--readambauniqueid: reads the Ambarella-unique ID</span></div>
<div class="line"><span class="stringliteral">--readmonocounter [%%d]&#39;</span>: reads the mono counter, (%%d<span class="stringliteral">&#39;th counter)</span></div>
<div class="line"><span class="stringliteral">--increasemonocounter [%%d]&#39;</span>: increases the mono counter, (%%d<span class="stringliteral">&#39;th counter)</span></div>
<div class="line"><span class="stringliteral">--writecustomeruid [%%s] [%%d]&#39;</span>: writes the customer ID (file name %%s) (lock or not %%d)</div>
<div class="line">--readcustomeruid<span class="stringliteral">&#39;: reads the customer ID</span></div>
<div class="line"><span class="stringliteral">--permanentlyenablesecureboot&#39;</span>: permanently enables secure boot</div>
<div class="line">--generatehuk<span class="stringliteral">&#39;: generates the hardware-unique encryption key</span></div>
<div class="line"><span class="stringliteral">--writeaeskey [%%d] [%%d]&#39;</span>: <span class="stringliteral">&#39;--writeaeskey&#39;</span> writes (%%d<span class="stringliteral">&#39;th) the advanced encryption standard (AES) key, (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--writeecckey [%%d] [%%d]&#39;</span>: <span class="stringliteral">&#39;--writeecckey&#39;</span> writes (%%d<span class="stringliteral">&#39;th) the elliptic curve cryptography (key), (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--writeusrslotg0 [%%d] [%%s] [%%d]&#39;</span>: <span class="stringliteral">&#39;--writeusrslotg0&#39;</span> writes (%%d<span class="stringliteral">&#39;th) usr slot g0 (file name %%s), (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--readusrslotg0 [%%d]&#39;</span>: <span class="stringliteral">&#39;--readusrslotg0&#39;</span> reads (%%d<span class="stringliteral">&#39;th) the usr slot g0 region</span></div>
<div class="line"><span class="stringliteral">--writehex2usrslotg0 [%%d] [%%s]&#39;</span>: <span class="stringliteral">&#39;--writehex2usrslotg0&#39;</span> writes (%%d<span class="stringliteral">&#39;th) usr slot g0 with a hex string</span></div>
<div class="line"><span class="stringliteral">--writeusrslotg1 [%%d] [%%s] [%%d]&#39;</span>: <span class="stringliteral">&#39;--writeusrslotg1&#39;</span> writes (%%d<span class="stringliteral">&#39;th) usr slot g1 (file name %%s), (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--readusrslotg1 [%%d]&#39;</span>: <span class="stringliteral">&#39;--readusrslotg1&#39;</span> reads (%%d<span class="stringliteral">&#39;th) the usr slot g1 region</span></div>
<div class="line"><span class="stringliteral">--writehex2usrslotg1 [%%d] [%%s]&#39;</span>: <span class="stringliteral">&#39;--writehex2usrslotg1&#39;</span> writes (%%d<span class="stringliteral">&#39;th) usr slot g1 with a hex string</span></div>
<div class="line"><span class="stringliteral">--writetestregion [%%s] [%%d]&#39;</span>: <span class="stringliteral">&#39;--writetestregion&#39;</span> writes the test region (file name %%s), (lock or not %%d)</div>
<div class="line">--readtestregion<span class="stringliteral">&#39;: &#39;</span>--readtestregion<span class="stringliteral">&#39; reads the test region</span></div>
<div class="line"><span class="stringliteral">--writehex2testregion [%%s]&#39;</span>: <span class="stringliteral">&#39;--writehex2testregion&#39;</span> writes the test region with a hex <span class="keywordtype">string</span></div>
<div class="line">--revokekey [%%d]<span class="stringliteral">&#39;: &#39;</span>--revokekey<span class="stringliteral">&#39; revoke (%%d&#39;</span>th) the key</div>
<div class="line">--queryotpsetting<span class="stringliteral">&#39;: &#39;</span>--queryotpsetting<span class="stringliteral">&#39; queries the OTP setting</span></div>
<div class="line"><span class="stringliteral">--setjtagefuse&#39;</span>: <span class="stringliteral">&#39;--setjtagefuse&#39;</span> will sets the JTAG eFUSE bit</div>
<div class="line">--writesysconfig [%%x] [%%x] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writesysconfig<span class="stringliteral">&#39; writes sysconfig; the first is sysconfig, the second is sysconfig_mask, the last is lock</span></div>
<div class="line"><span class="stringliteral">--querysysconfig&#39;</span>: <span class="stringliteral">&#39;--querysysconfig&#39;</span> queries sysconfig</div>
<div class="line">--writemiscconfig [%%x]<span class="stringliteral">&#39;: &#39;</span>--writemiscconfig<span class="stringliteral">&#39; writes miscellaneous configurations; the parameter is misc config</span></div>
<div class="line"><span class="stringliteral">--querymiscconfig&#39;</span>: <span class="stringliteral">&#39;--querymiscconfig&#39;</span> queries misc config</div>
<div class="line">--writecstseedcuk<span class="stringliteral">&#39;: &#39;</span>--writecstseedcuk<span class="stringliteral">&#39; writes the customer-planted seed and CUK</span></div>
<div class="line"><span class="stringliteral">--querycstseed&#39;</span>: <span class="stringliteral">&#39;--querycstseed&#39;</span> queries the customer-planted seed</div>
<div class="line">--querycstcuk<span class="stringliteral">&#39;: &#39;</span>--querycstcuk<span class="stringliteral">&#39; queries the customer-planted CUK</span></div>
<div class="line"><span class="stringliteral">--writeusrcuk&#39;</span>: <span class="stringliteral">&#39;--writeusrcuk&#39;</span> writes the user-planted CUK</div>
<div class="line">--queryusrcuk<span class="stringliteral">&#39;: &#39;</span>--queryusrcuk<span class="stringliteral">&#39; queries the user-planted CUK</span></div>
<div class="line"><span class="stringliteral">--increasebstver&#39;</span>: <span class="stringliteral">&#39;--increasebstver&#39;</span> increases the BST version</div>
<div class="line">--querybstver<span class="stringliteral">&#39;: &#39;</span>--querybstver<span class="stringliteral">&#39; queries the BST version</span></div>
<div class="line"><span class="stringliteral"> //printf(&quot;\t&#39;</span>--enantirollback<span class="stringliteral">&#39;: &#39;</span>--enantirollback<span class="stringliteral">&#39; enables BST anti-rollback</span></div>
<div class="line"><span class="stringliteral">--dissecureusbboot&#39;</span>: <span class="stringliteral">&#39;--dissecureusbboot&#39;</span> disables secure USB boot</div>
<div class="line">--lockallrotpubkeys<span class="stringliteral">&#39;: &#39;</span>--lockallrotpubkeys<span class="stringliteral">&#39; locks all RoT public keys</span></div>
<div class="line"><span class="stringliteral">--lockzonea&#39;</span>: <span class="stringliteral">&#39;--lockzonea&#39;</span> locks zone A, include sysconfig</div>
<div class="line">--simulate<span class="stringliteral">&#39;: &#39;</span>--simulate<span class="stringliteral">&#39; simulates OTP write; only prints the OTP write address and size.  OTP is not actually written</span></div>
<div class="line"><span class="stringliteral">--dailytest [%%d]&#39;</span>: <span class="stringliteral">&#39;--dailytest&#39;</span> performs a daily test covering all APIs; [%%d] means to <span class="keywordflow">try</span> to write one bit in the test region</div>
<div class="line">--help<span class="stringliteral">&#39;: prints help</span></div>
</div><!-- fragment --><p >The following are the <code>test_program_otp</code> prerequisites:</p>
<div class="fragment"><div class="line">board# modprobe optee</div>
<div class="line">board# tee-supplicant &amp;</div>
</div><!-- fragment --><p >The following completes an OTP daily test:</p>
<div class="fragment"><div class="line">board# test_program_otp --dailytest 0</div>
</div><!-- fragment --><p >The <code>test_otp</code> functions when there is no TOS (OP-TEE), depending on the <code>amba_otp</code> driver. Further, it includes a similar option to the <code>test_program_otp</code>, as shown below:</p>
<div class="fragment"><div class="line">--writepubkey [%%d] [%%s] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writepubkey<span class="stringliteral">&#39; writes (%%d&#39;</span>th) the ROT <span class="keyword">public</span> key (file name %%s) (lock or not %%d)</div>
<div class="line">--readpubkey [%%d]<span class="stringliteral">&#39;: &#39;</span>--readpubkey<span class="stringliteral">&#39; reads (%%d&#39;</span>th) the RoT <span class="keyword">public</span> key</div>
<div class="line">--readambauniqueid: reads the Ambarella-unique ID</div>
<div class="line">--readmonocounter<span class="stringliteral">&#39;: reads the mono counter</span></div>
<div class="line"><span class="stringliteral">--increasemonocounter&#39;</span>: increases the mono counter</div>
<div class="line">--writecustomeruid [%%s] [%%d]<span class="stringliteral">&#39;: writes the customer-unique ID (file name %%s) (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--readcustomeruid&#39;</span>: reads the customer-unique ID</div>
<div class="line">--permanentlyenablesecureboot<span class="stringliteral">&#39;: permanently enables secure boot</span></div>
<div class="line"><span class="stringliteral">--generatehuk&#39;</span>: generates the hardware-unique encryption key</div>
<div class="line">--writeaeskey [%%d] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writeaeskey<span class="stringliteral">&#39; writes (%%d&#39;</span>th) the AES key, (lock or not %%d)</div>
<div class="line">--writeecckey [%%d] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writeecckey<span class="stringliteral">&#39; writes (%%d&#39;</span>th) the ECC key, (lock or not %%d)</div>
<div class="line">--writeusrslotg0 [%%d] [%%s] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writeusrslotg0<span class="stringliteral">&#39; will write (%%d&#39;</span>th) usr slot g0 (file name %%s), (lock or not %%d)</div>
<div class="line">--readusrslotg0 [%%d]<span class="stringliteral">&#39;: &#39;</span>--readusrslotg0<span class="stringliteral">&#39; will read (%%d&#39;</span>th) usr slot g0 region</div>
<div class="line">--writehex2usrslotg0 [%%d] [%%s]<span class="stringliteral">&#39;: &#39;</span>--writehex2usrslotg0<span class="stringliteral">&#39; writes (%%d&#39;</span>th) usr slot g0 with a hex <span class="keywordtype">string</span></div>
<div class="line">--writetestregion [%%s] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writetestregion<span class="stringliteral">&#39; write the test region (file name %%s), (lock or not %%d)</span></div>
<div class="line"><span class="stringliteral">--readtestregion&#39;</span>: <span class="stringliteral">&#39;--readtestregion&#39;</span> read the test region</div>
<div class="line">--writehex2testregion [%%s]<span class="stringliteral">&#39;: &#39;</span>--writehex2testregion<span class="stringliteral">&#39; writes the test region with a hex string</span></div>
<div class="line"><span class="stringliteral">--revokekey [%%d]&#39;</span>: <span class="stringliteral">&#39;--revokekey&#39;</span> revokes (%%d<span class="stringliteral">&#39;th) the key</span></div>
<div class="line"><span class="stringliteral">--lockpubkey [%%d]&#39;</span>: <span class="stringliteral">&#39;--lockpubkey&#39;</span> locks (%%d<span class="stringliteral">&#39;th) the key</span></div>
<div class="line"><span class="stringliteral">--queryotpsetting&#39;</span>: <span class="stringliteral">&#39;--queryotpsetting&#39;</span> queries the OTP setting</div>
<div class="line">--setjtagefuse<span class="stringliteral">&#39;: &#39;</span>--setjtagefuse<span class="stringliteral">&#39; sets the JTAG eFUSE bit</span></div>
<div class="line"><span class="stringliteral">--lockzonea&#39;</span>: <span class="stringliteral">&#39;--lockzonea&#39;</span> locks zone A, include sysconfig</div>
<div class="line">--writesysconfig [%%x] [%%x] [%%d]<span class="stringliteral">&#39;: &#39;</span>--writesysconfig<span class="stringliteral">&#39; writes sysconfig; the first is sysconfig, the second is sysconfig_mask, the last is lock</span></div>
<div class="line"><span class="stringliteral">--querysysconfig&#39;</span>: <span class="stringliteral">&#39;--querysysconfig&#39;</span> queries sysconfig</div>
<div class="line">--writemiscconfig [%%x]<span class="stringliteral">&#39;: &#39;</span>--writemiscconfig<span class="stringliteral">&#39; writes miscellaneous configurations; the parameter is `misc config`</span></div>
<div class="line"><span class="stringliteral">--querymiscconfig&#39;</span>: <span class="stringliteral">&#39;--querymiscconfig&#39;</span> queries misc config</div>
<div class="line">--simulate<span class="stringliteral">&#39;: &#39;</span>--simulate<span class="stringliteral">&#39; simulates an OTP write; it prints the OTP write address and size.  OTP is not actually written</span></div>
<div class="line"><span class="stringliteral">--dailytest [%%d]&#39;</span>: <span class="stringliteral">&#39;--dailytest&#39;</span> performs a daily test covering all APIs; [%%d] means to <span class="keywordflow">try</span> to write one bit in the test region</div>
<div class="line">--help<span class="stringliteral">&#39;: print help</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">The following is the `test_otp` prerequisite:</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">@code</span></div>
<div class="line"><span class="stringliteral">board # modprobe amba_otp</span></div>
</div><!-- fragment --><p >The following performs an OTP daily test:</p>
<div class="fragment"><div class="line">board # test_otp -dailytest 0</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="otp_scenarios"></a>
1.3. Typical Scenarios for Each OTP Region</h2>
<p >The table below describes each OTP region’s typical scenario. ‘Mandatory’ means this region’s definition is defined by Ambarella. ‘Recommended’ means this region can be customized. If users want to change a recommended region’s usage, the corresponding changes in code are also required. </p><a class="anchor" id="table_otp_scenarios"></a>
<table class="doxtable">
<caption>Table 1-2. Typical Scenarios for Each OTP Region.</caption>
<tr>
<th align="left">OTP Region </th><th align="left">Definition</th><th align="left">Scenario</th><th align="left">Comment </th></tr>
<tr>
<td>sys_config</td><td>Mandatory</td><td>Configuration</td><td>System configuration </td></tr>
<tr>
<td>efuse_disable_jtag</td><td>Mandatory</td><td>Configuration</td><td>Disable hardware debug port </td></tr>
<tr>
<td>write_lock</td><td>Mandatory</td><td>Lock bits</td><td>Each bit locks an OTP region </td></tr>
<tr>
<td>cst_seed</td><td>Recommended</td><td>Planted seed / key</td><td>Customer-planted seed </td></tr>
<tr>
<td>Unique ID</td><td>Mandatory</td><td>Unique ID</td><td>Chip-unique ID </td></tr>
<tr>
<td>cst_cuk</td><td>Recommended</td><td>Planted seed / key</td><td>Customer-planted key </td></tr>
<tr>
<td>data_invalid</td><td>Mandatory</td><td>Secure boot</td><td>For RoT key revocation </td></tr>
<tr>
<td>secure_usb_boot_disable</td><td>Mandatory</td><td>Configuration</td><td>Disables secure USB boot </td></tr>
<tr>
<td>misc_config</td><td>Recommended</td><td>Configuration</td><td>Customized configuration </td></tr>
<tr>
<td>bst_ver_cnt</td><td>Recommended</td><td>Anti-rollback</td><td>Monotonic counters can be used by the OTA program </td></tr>
<tr>
<td>serial_number</td><td>Recommended</td><td>Serial number</td><td>Product serial number </td></tr>
<tr>
<td>OTP_TEST</td><td>Recommended</td><td>OTP function test</td><td>OTP read / write function test </td></tr>
<tr>
<td>HUK</td><td>Mandatory</td><td>Chip key</td><td>Root of TEE secure storage </td></tr>
<tr>
<td>USER_CUK</td><td>Recommended</td><td>Planted seed / key</td><td>User-planted key </td></tr>
<tr>
<td>AES_KEY_0 ~ AES_KEY_3</td><td>Recommended</td><td>Data encryption key</td><td>Data encryption key; users can specify their access to be secure world only or normal world accessible </td></tr>
<tr>
<td>ECC_KEY_0 ~ ECC_KEY_3</td><td>Recommended</td><td>Authentication key</td><td>Authentication key; users can specify their access to be secure world only or normal world accessible </td></tr>
<tr>
<td>USER_SLOT_0 ~ USER_SLOT_5</td><td>Recommended</td><td>Lockable data</td><td>Customized data (lockable) </td></tr>
<tr>
<td>ROT_KEY_0 ~ ROT_KEY_15</td><td>Mandatory</td><td>Root of trust key</td><td>RoT key </td></tr>
<tr>
<td>MONO_COUNT_0 ~ MONO_COUNT_2</td><td>Recommended</td><td>Anti-rollback</td><td>Monotonic counters can be used by OTA program </td></tr>
<tr>
<td>USER_DATA_0 ~ USER_DATA_2</td><td>Recommended</td><td>Data</td><td>Customized data </td></tr>
<tr>
<td>USER_SLOT_6 ~ USER_SLOT_9</td><td>Recommended</td><td>Lockable data</td><td>Customized data (lockable) </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="uuid"></a>
2. Unique ID</h1>
<p >There are three types of unique IDs. The first is the 256-bit digital signal processor (DSP)-unique ID, which is available after booting the DSP. The second type is the 128-bit Ambarella-unique ID inside the OTP. These two ID types are maintained by Ambarella, and are easily accessible to the user. The third type is another 128-bit space inside the OTP for the user’s unique ID. Users can define and program their own ID.</p>
<h2><a class="anchor" id="read_dsp_uuid"></a>
2.1 Read DSP-Unique ID from IOCTL</h2>
<p >Use the input / output control (IOCTL) <code>IAV_IOC_QUERY_INFO</code>. The sample code is provided below: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>iav_queryinfo query_unique_id;</div>
<div class="line">memset(&amp;query_unique_id, 0x0, <span class="keyword">sizeof</span>(query_unique_id));</div>
<div class="line">query_unique_id.qid = IAV_INFO_UNIQUE_ID;</div>
<div class="line">ret = ioctl(iav_fd, IAV_IOC_QUERY_INFO, &amp;query_unique_id);</div>
</div><!-- fragment --><h2><a class="anchor" id="read_amba_uuid_with_tz"></a>
2.2 Read the Ambarella Unique ID with TrustZone Enabled</h2>
<p >When Arm TrustZone is enabled, use the following steps to read the unique ID: </p><div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line">BOARD# test_program_otp –-readambauniqueid</div>
</div><!-- fragment --><h2><a class="anchor" id="read_amba_uuid_without_tz"></a>
2.3 Read the Ambarella Unique ID with TrustZone Disabled</h2>
<p >When TrustZone is disabled, use the <code>amba_otp</code> driver to access OTP with the configuration below. This module is mutually exclusive with TrustZone; therefore, if TrustZone is enabled, it will not function.</p>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> drv_modules  ---&gt;</div>
<div class="line">  <span class="keyword">private</span>  ---&gt;</div>
<div class="line">   kernel-module-ambotp (drv_modules/<span class="keyword">private</span>/amba_otp/dsp_v5)</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">    meta-ambabsp  ---&gt;</div>
<div class="line">  recipes-otp  ---&gt;</div>
<div class="line">   kernel-module-ambotp (meta-ambabsp/recipes-otp/kernel-module-ambotp)</div>
</div><!-- fragment --><p >Next, use the following steps to read the Ambarella-unique ID: </p><div class="fragment"><div class="line">BOARD# modprobe amba_otp</div>
<div class="line">BOARD# cat /proc/ambarella/amba_unique_id</div>
</div><!-- fragment --><p> The following reads the unique ID with <code>test_otp</code>: </p><div class="fragment"><div class="line">BOARD# modprobe amba_otp</div>
<div class="line">BOARD# test_otp –-readambauniqueid</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="mono_counter"></a>
3. Monotonic Counter</h1>
<p >The hardware monotonic counter is used to prevent a downgrade attack. A downgrade attack refers to an attacker downgrading or rolling back firmware to an older version in order to exploit the known security vulnerabilities. A version binding check with the hardware monotonic counter can detect and prevent this kind of attack. There are three monotonic counters on CV5x / CV7x / CV3, the first two are 256 bits, and the third is 512 bits.</p>
<hr  />
<h1><a class="anchor" id="TRNG"></a>
4. True Random Number Generator</h1>
<p >The CV5x / CV7x / CV3 chip family includes true random number generator (TRNG) hardware. The entropy source of the TRNG is the thermal noise of the SoC. The Ambarella Linux SDK has enabled it in both the rich OS (Linux) and the TOS (OP-TEE). Drivers can be found in the following paths:</p><ul>
<li>TRNG driver in OP-TEE: <code>ambarella/boot/tee/optee_os/core/drivers/ambarella_trng.c</code></li>
<li>TRNG driver in Linux: <code>ambarella/kernel/linux-5.15/drivers/char/hw_random/ambarella-rng.c</code></li>
<li>TRNG driver in AMBoot: <code>ambarella/boot/amboot/src/bld/rng.c</code></li>
<li>Sample code in Linux: <code>ambarella/security/validation/rng_quality</code> Use the command below to obtain the random number from the TRNG: <div class="fragment"><div class="line">BOARD# rng_quality –str /dev/hwrng --rng_num 10000 --file_num 1</div>
</div><!-- fragment --></li>
</ul>
<p >Check the following configuration to build a binary with TRNG enabled:</p>
<p ><a class="anchor" id="RNG_Quality_Test"></a></p><ol type="1">
<li>To enable the hardware RNG in Linux, select the following command: <div class="fragment"><div class="line">build$ make linux_menuconfig</div>
<div class="line"> Device Drivers  ---&gt;</div>
<div class="line">  Character devices  --&gt;</div>
<div class="line">   &lt;M&gt; Hardware Random Number Generator Core Support  ---&gt;</div>
<div class="line">    &lt;M&gt; Ambarella HW Random Number Generator support</div>
</div><!-- fragment --> OP-TEE-OS uses the hardware RNG. No extra user application code is required.</li>
<li>To enable <code>test_random</code> in Linux, select the following command:<br  />
 <b>Amba build</b> <div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> meta-ambasecurity  ---&gt;</div>
<div class="line">  recipes-security-validation  ---&gt;</div>
<div class="line">   rngtest (meta-ambasecurity/recipes-security-validation/rngtest)</div>
</div><!-- fragment --> <b>Yocto build</b> <div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> security  ---&gt;</div>
<div class="line">  validation  ---&gt;</div>
<div class="line">   rngtest (security/validation/rng_quality)</div>
</div><!-- fragment --></li>
<li>Generate RNG on the device: <div class="fragment"><div class="line"><span class="comment">// Test for /dev/random</span></div>
<div class="line">BOARD# ./rng_quality_test --str /dev/random --rng_num 3000000 --file_num 3 --t</div>
<div class="line"><span class="comment">// Test for /dev/urandom</span></div>
<div class="line">BOARD# ./rng_quality_test --str /dev/urandom --rng_num 3000000 --file_num 3 --t</div>
<div class="line"><span class="comment">// Test for hwrng</span></div>
<div class="line">BOARD# ./rng_quality_test --str /dev/hwrng --rng_num 3000000 --file_num 3 --t</div>
</div><!-- fragment --></li>
<li>Check the RNG quality: Users can use the tools provided by NIST to check the RNG quality. For more details about the tools, refer to <a href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-22r1a.pdf">https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-22r1a.pdf</a>. <dl class="section note"><dt>Note</dt><dd>The Ambarella SDK provides this tool in <code>ambarella/security/validation/rng_quality/sts-2.1.2</code>.</dd></dl>
<hr  />
</li>
</ol>
<h1><a class="anchor" id="disable_jtag_usb_boot"></a>
5. Disable JTAG and USB Boot</h1>
<p >JTAG and USB boot are used only for debugging purposes. Ambarella recommends that users disable them in an actual-use cases. </p><dl class="section note"><dt>Note</dt><dd><ul>
<li>Force USB boot is automatically disabled when secure boot is enabled.</li>
<li>The JTAG eFUSE bit (OTP63) must be set for JTAG, and then JTAG can be disabled.</li>
</ul>
</dd></dl>
<p>Use either of the following commands: </p><div class="fragment"><div class="line"><span class="preprocessor">#test_program_otp –-setjtagefuse </span></div>
</div><!-- fragment --><p> Or </p><div class="fragment"><div class="line"><span class="preprocessor">#test_otp --setjtagefuse </span></div>
</div><!-- fragment --><p> The two commands above set the JTAG eFUSE bit. After the JTAG eFUSE bit has been set, the <code>JTAG_EN</code> register (AHBSP_JTAG_EN_REG) can toggle JTAG on / off. <code>mmio_clrbits_32(AHBSP_JTAG_EN_REG, BIT(0));</code></p>
<p >The logic is provided as shown in the table below. </p><a class="anchor" id="jtag_efuse_and_reg_logic"></a>
<table class="doxtable">
<caption>Table 1-3. Logic JTAG eFUSE and Register Logic Table.</caption>
<tr>
<th align="left"></th><th align="left">JTAG_en = 0</th><th align="left">JTAG_en = 1 </th></tr>
<tr>
<td>JTAG_efuse = 0</td><td>JTAG available</td><td>JTAG available </td></tr>
<tr>
<td>JTAG_efuse = 1</td><td>JTAG NOT available</td><td>JTAG available </td></tr>
</table>
<p >In the flexible Linux SDK, the JTAG_en is 0 by default. The scenarios are as follows:</p><ul>
<li><code>JTAG_en</code> = 0, <code>JTAG_efuse</code> = 0: in the development stage, JTAG is available for debugging purposes</li>
<li><code>JTAG_en</code> = 0: <code>JTAG_efuse</code> will be set to 1 in the factory (during the mass-production (MP) process), then the JTAG is disabled (JTAG not available) to enhance the product’s security level</li>
<li><code>JTAG_en</code> = 1, <code>JTAG_efuse</code> = 1: performed by special firmware (the special firmware writes <code>JTAG_en</code> to 1 in the secure world); bring back the JTAG for the return material authorization (RMA) process’s debugging and analysis</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Users can add <code>mmio_setbits_32(AHBSP_JTAG_EN_REG, BIT(0))</code> in <code>ambarealla/boot/tee/arm-trusted-firmware/ambarella/ambarella_security.c</code> to enable JTAG for the RMA process. <div class="fragment"><div class="line"><span class="keywordtype">void</span> ambarella_security_setup(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">         uint32_t i;</div>
<div class="line"> </div>
<div class="line">        assert(boot_cookie_ptr()-&gt;bld_ram_start == BL33_BASE);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (AMBARELLA_SUPPORT_SEURITY_CTRL == 1)</span></div>
<div class="line">         <span class="comment">/* Disable all devices&#39;s security by default in cold boot */</span></div>
<div class="line">        ambarella_device_security_restore();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt;= NIC_GPV_MASTER_PORT; i++)</div>
<div class="line">                 mmio_write_32(NIC_GPV_REG(0x08 + i * 4), NON_SECURE);</div>
<div class="line"> </div>
<div class="line">         mmio_write_32(NIC_GPV_REG(NIC_GPV_SLAVE_PORT_AXI), SECURE);</div>
<div class="line"> </div>
<div class="line">         mmio_setbits_32(AHBSP_JTAG_EN_REG, BIT(0));        <span class="comment">//add this line to enable JTAG</span></div>
<div class="line"> </div>
<div class="line">         isb();</div>
<div class="line">         dsb();</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* setup platform ATT (Address Translation Table) */</span></div>
<div class="line">        ambarella_att_setup();</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* If secure boot is disabled, no need to setup Secure Memory */</span></div>
<div class="line">         <span class="keywordflow">if</span> (!ambarella_is_secure_boot())</div>
<div class="line">                   <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">         ambarella_secure_memory_setup();</div>
<div class="line">}</div>
</div><!-- fragment --> </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
