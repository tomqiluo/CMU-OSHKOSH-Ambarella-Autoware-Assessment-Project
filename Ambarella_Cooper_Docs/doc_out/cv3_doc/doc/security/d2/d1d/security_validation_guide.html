<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: Validation Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d2/d1d/security_validation_guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title"></div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="validation_guide_history"></a>
0. Revision History</h1>
<a class="anchor" id="security_validation_guide_history"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Version</th><th>Updated Date</th><th align="left">Modification </th></tr>
<tr>
<td>0.0.1</td><td>20231221</td><td>Initial version </td></tr>
</table>
<p >Users can follow this guide to test the security features on CV5x / CV7x / CV3 </p><a class="anchor" id="security_validation_guide"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th align="left">Secure aspects</th><th align="left">Security Features</th><th align="left">Validation Guide </th></tr>
<tr>
<td rowspan="4">System Integrity Protection</td><td>Secure Boot </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Secure_Boot">Secure_Boot</a> </td></tr>
<tr>
<td>Online Upgarde </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Online_Upgrade">Online_Upgrade</a> </td></tr>
<tr>
<td>Rescue Mode </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Rescue_Mode">Rescue_Mode</a> </td></tr>
<tr>
<td>Linux DM-Verity </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Linux_Dm_verity">Linux_Dm_verity</a> </td></tr>
<tr>
<td rowspan="2">System Reinforcement </td><td>Secure Enhanced Bootloader </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Secure_Enhanced_Bootloader">Secure_Enhanced_Bootloader</a> </td></tr>
<tr>
<td>OP-TEE </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#OP_TEE">OP_TEE</a> </td></tr>
<tr>
<td rowspan="3">Data Storage Protection </td><td>DM-Crypt </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Dm_Crpypt">Dm_Crpypt</a> </td></tr>
<tr>
<td>Data Encryption </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Data_Encryption">Data_Encryption</a> </td></tr>
<tr>
<td>Secure Storage </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Secure_Storage">Secure_Storage</a> </td></tr>
<tr>
<td rowspan="2">Intellectual Property Protection </td><td>Unit License Protection </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Unit_License_Protection">Unit_License_Protection</a> </td></tr>
<tr>
<td>Neural Network Model Protection </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Neural_Network_Model_Protection">Neural_Network_Model_Protection</a> </td></tr>
<tr>
<td rowspan="2">Secure Hardware </td><td>OTP </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#One_Time_Programmable">One_Time_Programmable</a> </td></tr>
<tr>
<td>RNG </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Random_Number_Generator">Random_Number_Generator</a> </td></tr>
<tr>
<td></td><td>Key Tools </td><td align="center"><a class="el" href="../../d2/d1d/security_validation_guide.html#Key_tools">Key_tools</a> </td></tr>
</table>
<p ><a class="anchor" id="Secure_Boot"></a></p>
<h1><a class="anchor" id="test_secure_boot"></a>
1. Secure Boot</h1>
<p >By default, Ambarella provides three methods for users to store keys:</p><ul>
<li>In the local software development kit (SDK)</li>
<li>Use the remote procedure call (RPC) toolkits provided by Ambarella</li>
<li>Use Amazom Web Service (AWS) Key Management Service (KMS) Users also can use their own key management service to store keys.</li>
</ul>
<h2><a class="anchor" id="generate_secure_boot_keys"></a>
1.1 Generate Keys for Secure Boot</h2>
<h3><a class="anchor" id="generate_secure_boot_keys_local"></a>
1.1.1 Generate Keys for the Local Approach</h3>
<p >Refer to <a class="el" href="../../db/dfb/key_management.html#generate_new_key_pairs">5.1.1 Generating New Keys for the Local Approach (Optional)</a> for more information.</p>
<h3><a class="anchor" id="generate_secure_boot_keys_rpc"></a>
1.1.2 Generate Keys for the RPC Approach</h3>
<p >When users prepare the development server, these keys will automatically be generated.<br  />
 Users can refer to <a class="el" href="../../db/dfb/key_management.html#set_up_rpc_env">5.4 Setting Up the RPC Environment</a> to set up RPC enviroment.</p>
<h2><a class="anchor" id="validation_compile_sdk_with_secure_boot"></a>
1.2 Compile the SDK with Secure Boot</h2>
<p >If users use the default configuration file provided by Ambarella, they can can refer to <a class="el" href="../../db/dfb/key_management.html#compile_sdk_with_secure_boot">5.3 Compiling the SDK with a Secure Boot</a>.<br  />
 If users want to enable secure boot with Arm® TrustZone® from a non-secure boot configuration, the following options should be selected:<br  />
 <b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> boot  ---&gt;</div>
<div class="line"> [*] amboot (boot/ambamk)  ---&gt;</div>
<div class="line">  Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">   AMBoot Options  ---&gt;</div>
<div class="line">    [*] Boot with TrustZone  ---&gt;</div>
<div class="line">     -*-   Secure Boot with Signature</div>
<div class="line">      -*-   Secure DTB with Signature (SOC Firmware Config)</div>
<div class="line">       [*]   Boot with trusted OS(OPTEE)</div>
<div class="line"> tee  ---&gt;</div>
<div class="line">  [*] arm-tf (boot/tee/ambamk)</div>
<div class="line">  [*] optee-client (boot/tee/ambamk)</div>
<div class="line">  [*] optee-os (boot/tee/ambamk)</div>
<div class="line">  [*] optee-test (boot/tee/ambamk)</div>
<div class="line"> security  ---&gt;</div>
<div class="line"> [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">  [*]   Bootloader Authenticate Linux Kernel  ---&gt;</div>
<div class="line">   [*]   Bootloader Embed Kernel Public Bin Key</div>
<div class="line">    Bootloader Authenticate Linux Kernel Algorithm (ED25519)  ---&gt;</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> meta-ambabsp  ---&gt;</div>
<div class="line">  recipes-bsp  ---&gt;</div>
<div class="line">   [*] amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">    Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">     AMBoot Options  ---&gt;</div>
<div class="line">      [*] Boot with TrustZone  ---&gt;</div>
<div class="line">       -*-   Secure Boot with Signature</div>
<div class="line">        -*-   Secure DTB with Signature (SOC Firmware Config)</div>
<div class="line">         [*]   Boot with trusted OS(OPTEE)</div>
<div class="line">      [*] arm-tf (meta-ambabsp/recipes-bsp/boot) </div>
<div class="line">  recipes-tee  ---&gt;</div>
<div class="line">   [*] optee-os (meta-ambabsp/recipes-tee/optee-os)</div>
<div class="line">    [*] opteeclient (meta-ambabsp/recipes-tee/opteeclient)</div>
<div class="line">     [*]   opteetest (meta-ambabsp/recipes-tee/opteetest)</div>
<div class="line"> meta-ambasecurity  ---&gt;</div>
<div class="line">  recipes-boot-security  ---&gt;</div>
<div class="line">   [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">    [*]   Bootloader Authenticate Linux Kernel  ---&gt;</div>
<div class="line">     [*]   Bootloader Embed Kernel Public Bin Key</div>
<div class="line">       Bootloader Authenticate Linux Kernel Algorithm (ED25519)  ---&gt;</div>
</div><!-- fragment --><p >Users also must modify the system memory layout to enable secure boot with TrustZone; refer to <a class="el" href="../../df/d7d/sys_integrity_protection.html#mem_layout">1.4 System Memory Layout</a> for more information.</p>
<p >If users want to enable secure boot without TrustZone from a non-secure boot configuration, the following options should be selected:<br  />
 <b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> boot  ---&gt;</div>
<div class="line"> [*] amboot (boot/ambamk)  ---&gt;</div>
<div class="line">  Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">   AMBoot Options  ---&gt;</div>
<div class="line">    [*] Boot with TrustZone  ---&gt;</div>
<div class="line">     -*-   Secure Boot with Signature</div>
<div class="line">      -*-   Secure DTB with Signature (SOC Firmware Config)</div>
<div class="line"> tee  ---&gt;</div>
<div class="line">  [*] arm-tf (boot/tee/ambamk)</div>
<div class="line"> security  ---&gt;</div>
<div class="line"> [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">  [*]   Bootloader Authenticate Linux Kernel  ---&gt;</div>
<div class="line">   [*]   Bootloader Embed Kernel Public Bin Key</div>
<div class="line">    Bootloader Authenticate Linux Kernel Algorithm (ED25519)  ---&gt;</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> meta-ambabsp  ---&gt;</div>
<div class="line">  recipes-bsp  ---&gt;</div>
<div class="line">   [*] amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">    Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">     AMBoot Options  ---&gt;</div>
<div class="line">      [*] Boot with TrustZone  ---&gt;</div>
<div class="line">       -*-   Secure Boot with Signature</div>
<div class="line">        -*-   Secure DTB with Signature (SOC Firmware Config)</div>
<div class="line">      [*] arm-tf (meta-ambabsp/recipes-bsp/boot) </div>
<div class="line">  recipes-tee  ---&gt;</div>
<div class="line">   [*] optee-os (meta-ambabsp/recipes-tee/optee-os)</div>
<div class="line"> meta-ambasecurity  ---&gt;</div>
<div class="line">  recipes-boot-security  ---&gt;</div>
<div class="line">   [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">    [*]   Bootloader Authenticate Linux Kernel  ---&gt;</div>
<div class="line">     [*]   Bootloader Embed Kernel Public Bin Key</div>
<div class="line">       Bootloader Authenticate Linux Kernel Algorithm (ED25519)  ---&gt;</div>
</div><!-- fragment --><p >By default, the Ambarella SDK stores keys in the local approach. Users can store keys in other locations:</p>
<h3><a class="anchor" id="compile_secure_boot_with_rpc"></a>
1.2.1 Using Ambarella RPC Toolkits</h3>
<ol type="1">
<li>Set up the RPC enviroment; refer to set_up_rpc_env.</li>
<li><p class="startli">Select RPC in the menuconfig base configuration file with secure boot enabled:<br  />
 <b> Amba Build </b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> security  ---&gt;</div>
<div class="line"> [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">   [*]   Using RPC(Remote Procedure Call) Toolkit to sign binary  ---&gt;</div>
</div><!-- fragment --><p class="startli"><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">*  meta-ambasecurity  ---&gt;</div>
<div class="line"> recipes-boot-security  ---&gt;</div>
<div class="line">  [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">   [*]   Using RPC(Remote Procedure Call) Toolkit to sign binary  ---&gt;</div>
</div><!-- fragment --></li>
<li>Compile the SDK with the RPC enviroment enabled.</li>
</ol>
<h3><a class="anchor" id="compile_secure_boot_with_aws_kms"></a>
1.2.2 Using AWS KMS</h3>
<ol type="1">
<li>Compile the security tools. <div class="fragment"><div class="line">cd ambarella/security/plugins/aws_kms/aws_kms_openssl_engine_amba &amp;&amp; make</div>
<div class="line">cd ambarella/security/security_tools &amp;&amp; make &amp;&amp; make install</div>
</div><!-- fragment --></li>
<li>Set up the KMS key and environment (users can use their own keys): <div class="fragment"><div class="line">aws configure</div>
<div class="line">AWS Access Key ID [None]: abc</div>
<div class="line">AWS Secret Access Key [None]: abc</div>
<div class="line">Default region name [None]: cn-north-1</div>
<div class="line">Default output format [None]:</div>
</div><!-- fragment --></li>
<li>Get the public RoT key (must be programmed into OTP) and the kernel key (must be compiled into <code>boot_loader</code>) <div class="fragment"><div class="line"><span class="comment">//get public rot key, copy pem to .pem file (pub_rot.pem)</span></div>
<div class="line">openssl pkey -engine aws_kms -inform engine -in arn:aws-cn:kms:cn-north-1:1234567890ab:key/12345678-abcd-efgh-1234-1234567890ab -pubout -text -out pub_rot.pem</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert public rot key (.pem -&gt; .txt -&gt; .bin)</span></div>
<div class="line">ambarella/security/build/generic_tools/key_convertor --in pub_rot.pem --out pub_rot.txt --convertpem</div>
<div class="line">ambarella/security/build/generic_tools/key_convertor --in pub_rot.txt --out pub_rot.bin --generatepubkeybin</div>
<div class="line"> </div>
<div class="line"><span class="comment">//get public kernel key, copy pem to .pem file (pub_kernel.pem)</span></div>
<div class="line">openssl pkey -engine aws_kms -inform engine -in arn:aws-cn:kms:cn-north-1:1234567890ab:key/12345678-abcd-efgh-1234-1234567890ab -pubout -text -out pub_kernel.pem</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert public kernel key (.txt)</span></div>
<div class="line">ambarella/security/build/generic_tools/key_convertor --in pub_kernel.pem --out pub_kernel.txt --convertpem</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert public kernel key (.c)</span></div>
<div class="line">ambarella/security/build/sbss_dev_gen_key/sbss_dev_gen_key --convert pub_kernel.txt ambarella/security/boot_security/rsa2048_exp65537_pubkey.c</div>
</div><!-- fragment --></li>
<li><p class="startli">Select <code>Using AWS KMS key to sign binary</code> in the menuconfig base in the configuration file with secure boot enabled:<br  />
 <b>Amba build: </b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> security  ---&gt;</div>
<div class="line"> [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">   [*]   Using AWS KMS key to sign binary</div>
<div class="line">   () Rot-key  <span class="comment">//add KMS key in menuconfig</span></div>
<div class="line">   ...</div>
<div class="line">   () Kernel-key</div>
</div><!-- fragment --><p class="startli"><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">*  meta-ambasecurity  ---&gt;</div>
<div class="line"> recipes-boot-security  ---&gt;</div>
<div class="line">  [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">   [*]   Using AWS KMS key to sign binary</div>
<div class="line">   () Rot-key  <span class="comment">//add KMS key in menuconfig</span></div>
<div class="line">   ...</div>
<div class="line">   () Kernel-key</div>
</div><!-- fragment --></li>
<li>Compile the SDK: <div class="fragment"><div class="line">make arm-tf_clean (clean ATF first to ensure the cert_create tool is built with ams-kms engine)</div>
<div class="line">make</div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="compile_secure_boot_with_other_key_management_service"></a>
1.2.3 Using Other Key Management Services</h3>
<p >If users have their own key management service and they want to use the keys in it for secure boot, the following Makefile must be modified with their own key signing methods:<br  />
</p><ul>
<li>For the kernel key, RoT key, and CoT root key, check <code>ambarella/security/boot_security/Makefile.security</code><br  />
</li>
<li>For the trusted application (TA) key in the open-portable trusted execution environment (OP-TEE), check the lines in the following files:<br  />
 In <code>ambarella/boot/tee/optee_os</code>: <div class="fragment"><div class="line">mk/config.mk:222</div>
<div class="line">core/sub.mk:15</div>
<div class="line">ta/ta.mk:175</div>
<div class="line">ta/arch/arm/link_shlib.mk:6</div>
<div class="line">ta/arch/arm/link_shlib.mk:57</div>
<div class="line">ta/arch/arm/link.mk:5</div>
<div class="line">ta/arch/arm/link.mk:119</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="validation_program_public_key_into_otp"></a>
1.3 Programming a Public Key into OTP</h2>
<p >Refer to <a class="el" href="../../db/dfb/key_management.html#program_public_key_into_otp">5.5 Programming a Public Key into OTP</a> for more information.</p>
<h2><a class="anchor" id="validation_enable_sec_boot"></a>
1.4 Enabling Secure Boot</h2>
<p >Refer to <a class="el" href="../../db/dfb/key_management.html#enable_sec_boot">5.6 Enabling Secure Boot</a> for more information.</p>
<h2><a class="anchor" id="validation_run_se_boot"></a>
1.5 Running Secure Boot</h2>
<p >Refer to <a class="el" href="../../db/dfb/key_management.html#run_se_boot">5.7 Running Secure Boot</a> for more information.</p>
<h2><a class="anchor" id="test_suite_for_secure_boot"></a>
1.6 Test Suite For Secure Boot</h2>
<p >Users can follow the steps below to test whether secure boot is able to function:</p>
<h3><a class="anchor" id="test_suite_secure_boot_auth_chain"></a>
1.6.1 Test Suite For Authentication Chain</h3>
<p >The secure boot authentication chain inculudes three stages (refer to <a class="el" href="../../df/d7d/sys_integrity_protection.html#auth_chain">1.1 Authentication Chain</a>). If users use the wrong key to sign different partition, boot fails at different stages:</p><ol type="1">
<li>Prepare two sets of images signed with key pair A and key pair B. Burn image A onto the board.</li>
<li>Upgrade image B's kernel parition onto the board and reboot.<ul>
<li>Boot should fail at the BLD stage, with secure boot enabled or disabled: <div class="fragment"><div class="line">Authenticate <span class="stringliteral">&quot;kernel&quot;</span>: failed</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Burn image A onto the board, upgrade image B's BLD partition onto board, then reboot.<ul>
<li>With secure boot enabled:<br  />
 boot should fail at the BL2 stage</li>
<li>With secure boot disabled:<br  />
 BL2 check pass; boot failed at BLD stage (because the kernel key in BLD changed) <div class="fragment"><div class="line">Authenticate <span class="stringliteral">&quot;kernel&quot;</span>: failed</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Burn image A onto the board, then upgrade image B's Arm trusted firmware (ATF) partition onto the board and reboot<ul>
<li>Boot should fail at the BST stage, with secure boot enabled (no print at console)</li>
</ul>
</li>
<li>Burn image A onto the board, then upgrade image B's BST partition onto the board and reboot<ul>
<li>Boot should fail at the ROM stage, with secure boot enabled (no print at console)</li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="test_suite_rpc_toolkit"></a>
1.6.2 Test Suite For RPC Toolkit</h3>
<ol type="1">
<li>Set up the RPC toolkit; refer to <a class="el" href="../../d2/d1d/security_validation_guide.html#generate_secure_boot_keys_rpc">1.1.2 Generate Keys for the RPC Approach</a> for more information.</li>
<li>Compile the SDK with three sets of keys:<ul>
<li>Set A is with default local keys</li>
<li>Set B is with new generated keys (RPC approach)</li>
<li>Set C is with new generated keys (RPC approach), replace with the default RoT key in the RPC server: <div class="fragment"><div class="line">ambarella/security/keys/local_keys/rot_keys/ed25519/pri_rot.bin ambarella/security/build/tz_dev_server/pri_rot.bin</div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<p >Case 1: Set A images should boot successfully, with secure boot enabled<br  />
 Case 2: Set C images should boot successfully, with secure boot enabled<br  />
 Case 3: Set A images + Set B’s kernel partition <code>k</code>ernel_release.elf`) via AmbaUSB<br  />
 &gt;&gt;&gt; Boot should fail at the BLD stage, with secure boot enabled<br  />
 Case 4: Set A images + Set B’s BLD partition (<code>bld_release.elf</code>) via AmbaUSB<br  />
 &gt;&gt;&gt; Boot should fail at the BL2 stage, with secure boot enabled<br  />
 &gt;&gt;&gt; BL2 check pass, boot failed at the BLD stage (because the kernel key in BLD changed), with secure boot disabled<br  />
 Case 5: Set A images + Set B’s ATF partition (atf_release.elf) via AmbaUSB<br  />
 &gt;&gt;&gt; Boot should fail at the BST stage, with secure boot enabled (no print at console)<br  />
 &gt;&gt;&gt; Boot was successful, with secure boot disabled<br  />
 Case 6: Set A images + Set B’s BST partition (<code>bst_release.elf</code>) via AmbaUSB<br  />
 &gt;&gt;&gt; Boot should fail at the ROM stage, with secure boot enabled (no print at console)<br  />
 &gt;&gt;&gt; Boot was successful, with secure boot disabled<br  />
</p>
<h3><a class="anchor" id="test_suite_key_revocation"></a>
1.6.3 Test Suite For Key Revocation</h3>
<ol type="1">
<li>Write 16 RoT keys(key0, key1, key2, and so on) into OTP and lock them.<ul>
<li>By default, the firmware is compiled with key0, and the board can boot successfully</li>
</ul>
</li>
<li>Revoke key0 and reboot. <div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line">BOARD# test_program_otp --revokekey</div>
<div class="line">BOARD# reboot</div>
</div><!-- fragment --><ul>
<li>The boot fails because key0 was revoked</li>
</ul>
</li>
<li>Replace the key with key1 and compile a new image. <dl class="section note"><dt>Note</dt><dd>When using key1, the key index in <code>ambarella/boot/amboot/vif/bst.info</code> must be changed: <div class="fragment"><div class="line"><span class="preprocessor">#define BST_SEC_KEYINX  0x0001</span></div>
</div><!-- fragment --></dd></dl>
</li>
<li>Burn the new image (signed with key1) and boot.<ul>
<li>The expected result is 'boot sucess'</li>
</ul>
</li>
</ol>
<p ><a class="anchor" id="OP_TEE"></a></p>
<h1><a class="anchor" id="test_optee"></a>
2. OP-TEE</h1>
<p >Users can use the <code>xtest</code> command in OP-TEE to test OP-TEE related features: </p><div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line">BOARD# xtest</div>
<div class="line">BOARD# &gt;&gt;&gt; check xtest result</div>
<div class="line">BOARD# xtest --sha-perf</div>
<div class="line">BOARD# &gt;&gt;&gt;check sha performance result</div>
<div class="line">BOARD# xtest --aes-perf</div>
<div class="line">BOARD# &gt;&gt;&gt;check aes performance result</div>
</div><!-- fragment --><h1><a class="anchor" id="test_ota"></a>
3. Secure Over The Air</h1>
<p ><a class="anchor" id="Online_Upgrade"></a></p>
<h2><a class="anchor" id="test_online_upgrade"></a>
3.1 Online Upgrade</h2>
<p >Refer to <a class="el" href="../../df/d7d/sys_integrity_protection.html#online_upgrade">2.1. Online Upgrade</a> for more information.</p>
<p ><a class="anchor" id="Rescue_Mode"></a></p>
<h2><a class="anchor" id="test_rescue_mode"></a>
3.2 Rescue Mode</h2>
<p >Refer to <a class="el" href="../../df/d7d/sys_integrity_protection.html#rescue_mode">2.2 Rescue Mode</a> for more information.</p>
<p ><a class="anchor" id="Linux_Dm_verity"></a></p>
<h2><a class="anchor" id="test_dm_verity"></a>
3.3 Linux Dm-verity</h2>
<p >Refer to <a class="el" href="../../df/d7d/sys_integrity_protection.html#set_up_dm_verity">3.1 Set Up dm-verity on the Ambarella Platform</a> for more information.</p>
<p ><a class="anchor" id="Secure_Enhanced_Bootloader"></a></p>
<h1><a class="anchor" id="test_sebld"></a>
4. Secure Enhanced Bootloader</h1>
<p >Refer to <a class="el" href="../../db/d12/system_reinforcement.html#SEBLD"><ol type="1">
<li>Secure Enhanced Bootloader</li>
</ol>
</a> for more information.</p>
<p ><a class="anchor" id="Dm_Crpypt"></a></p>
<h1><a class="anchor" id="test_dm_crypt"></a>
5. Dm Crpypt</h1>
<p >Refer to <a class="el" href="../../d1/d37/data_storage_protection.html#dm_crypt">1.1 dm-crypt</a> for more information.</p>
<p ><a class="anchor" id="Data_Encryption"></a></p>
<h1><a class="anchor" id="test_data_encryption"></a>
6. Data Encryption</h1>
<h2><a class="anchor" id="data_encryption_optee"></a>
6.1 Data Encryption in OP-TEE</h2>
<p >Use <code>data_encryption_aes_v2_test</code> to perform AES encryption / decryption in OP-TEE: </p><div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line"><span class="comment">//encrypt data</span></div>
<div class="line">BOARD# data_encryption_aes_v2_test --in input.bin --out enc.bin --mode XTS --op enc --len 128</div>
<div class="line"><span class="comment">//decrypt data</span></div>
<div class="line">BOARD# data_encryption _aes_v2_test --in enc.bin --out dec.bin --mode XTS --op dec --len 128</div>
</div><!-- fragment --><p> Both <code>input.bin</code> and <code>dec.bin</code> must be the same.</p>
<p ><a class="anchor" id="Secure_Storage"></a></p>
<h1><a class="anchor" id="test_secure_storage"></a>
7. Secure Storage</h1>
<p >Use <code>test_secure_storage</code> to test secure storage in OP-TEE. For secure storage datails, refer to <a class="el" href="../../d1/d37/data_storage_protection.html#data_at_rest_protection">3.1 Data at Rest Protection</a>. </p><div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line">BOARD# test_secure_storage --storebuffer testbuffer a</div>
<div class="line">BOARD# test_secure_storage --load2buffer a</div>
<div class="line">BOARD# &gt;&gt;Load <span class="keywordtype">string</span> object (a): testbuffer</div>
<div class="line">The output buffer should be the same as the input buffer.</div>
<div class="line"> </div>
<div class="line">BOARD# test_secure_storage --storefile test.txt b</div>
<div class="line">BOARD# test_secure_storage --load2file b test_out.txt</div>
<div class="line">BOARD# diff test.txt test_out.txt</div>
<div class="line">The two files should be the same.</div>
</div><!-- fragment --><p ><a class="anchor" id="Unit_License_Protection"></a></p>
<h1><a class="anchor" id="test_ulp"></a>
8. Unit License Protection</h1>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#ulp_user_guide"><ol type="1">
<li>Unit License Protection User Guide</li>
</ol>
</a> for more information.</p>
<p ><a class="anchor" id="Neural_Network_Model_Protection"></a></p>
<h1><a class="anchor" id="test_nmp"></a>
9. Neural Network Model Protection</h1>
<p >Check the results between the RAW neural network (NN) model and the encrypted model</p>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#compile_nn_model_protection_code">4.1 Compile NN Model Protection Sample Code</a> for the usage of neural network model protection (NMP).</p><ol type="1">
<li>Run the scripts in <code>ambarella/security/security_tools/scripts/test_encrypt_network_output.sh</code>. The result should be the same, and CRC should not change with multi loop.</li>
<li>Performance should be amost the same for both RAW and encoded NNs: <div class="fragment"><div class="line">BOARD# cavalry_gen -d vas_output -k pek.bin -f bvlc_googlenet_enc.bin</div>
<div class="line">BOARD# test_nnctrl -b pnet_enc.bin  --in data=13.bin --out prob1=prob1_enc.bin --out conv4-2=conv4-2_enc.bin -v</div>
<div class="line">BOARD# test_nnctrl -b pnet_enc.bin  --in data=13.bin --out prob1=prob1_enc.bin --out conv4-2=conv4-2_enc.bin --cert \</div>
<div class="line">/usr/local/bin/ulp_nmp_test/certs/license_cert.bin --key /usr/local/bin/ulp_nmp_test/dev_encrypt_pek.bin --digest \</div>
<div class="line">/usr/local/bin/ulp_nmp_test/dev_encrypt_pek.digest</div>
</div><!-- fragment --></li>
</ol>
<p ><a class="anchor" id="One_Time_Programmable"></a></p>
<h1><a class="anchor" id="test_otp"></a>
10. OTP</h1>
<p >Refer to <a class="el" href="../../da/d0f/secure_hardware.html#program_otp">1.2. Program OTP</a> for more information, Generally, users can use <code>--daily test</code> to test OTP: <br  />
 <b>With TrustZone: </b> </p><div class="fragment"><div class="line">BOARD# modprobe optee</div>
<div class="line">BOARD# tee-supplicant &amp;</div>
<div class="line">BOARD# test_program_otp --dailytest 1</div>
</div><!-- fragment --><p ><b>Without TrustZone: </b> </p><div class="fragment"><div class="line">BOARD# modprobe amba_otp</div>
<div class="line">BOARD# test_otp --dailytest 1</div>
</div><!-- fragment --><p ><a class="anchor" id="Random_Number_Generator"></a></p>
<h1><a class="anchor" id="test_rng"></a>
11. Random Number Generator</h1>
<p >Refer to <a class="el" href="../../da/d0f/secure_hardware.html#RNG_Quality_Test">RNG_Quality_Test</a> for more information.</p>
<p ><a class="anchor" id="Key_tools"></a></p>
<h1><a class="anchor" id="test_key_tools"></a>
12. Key tools</h1>
<p >Ambarella provides several key tools for security issues; refer to the following to test them:<br  />
 <b><code>test_pkey_openssl</code>: </b> </p><div class="fragment"><div class="line">build$ cd ambarella/security/security_tools/pkey_openssl</div>
<div class="line">build$ make </div>
<div class="line">build$ test_pkey_openssl --genkey a.priv a.pub ed25519 sha512</div>
<div class="line">build$ test_pkey_openssl --sign test.file a.priv test.sign</div>
<div class="line">build$ test_pkey_openssl --verify test.file a.pub test.sign</div>
<div class="line"> </div>
<div class="line">build$ test_pkey_openssl_v2 --sign test.file abc_pri.pem test.sign</div>
<div class="line">build$ test_pkey_openssl_v2 --verify test.file abc_pub.pem test.sign</div>
</div><!-- fragment --><p ><b><code>key_convertor</code>: </b> </p><div class="fragment"><div class="line">build$ cd ambarella/security/build/generic_tools</div>
<div class="line">build$ cp ../../tz_sb_keys/local_keys/cot_root_keys/rsa2048/ * ./</div>
<div class="line"> </div>
<div class="line"><span class="comment">//run cmdlines in usage, compare the result</span></div>
<div class="line">build$ ./key_convertor --in pri_cot_root.txt --out test_private.pem --converttxt --<span class="keyword">private</span></div>
<div class="line">build$ ./key_convertor --in pub_cot_root.txt --out test_public.pem --converttxt</div>
<div class="line">build$ diff pri_cot_root.pem test_private.pem</div>
<div class="line">build$ diff pub_cot_root.pem test_public.pem</div>
<div class="line">build$ ./key_convertor --in pub_cot_root.txt --out test_public.bin --generatepubkeybin</div>
<div class="line">build$ diff test_public.bin pub_cot_root.bin</div>
<div class="line">build$ ./key_convertor --in pri_cot_root.pem --out test_private.txt --convertpem --<span class="keyword">private</span></div>
<div class="line">build$ diff pri_cot_root.txt test_private.txt</div>
<div class="line">build$ ./key_convertor --in pub_cot_root.pem --out test_public.txt --convertpem</div>
<div class="line">build$ diff test_public.txt pub_cot_root.txt</div>
<div class="line">build$ ./key_convertor --in pri_cot_root.txt --out test_private.pem --converttxt --<span class="keyword">private</span> --encrypt</div>
</div><!-- fragment --><p ><b><code>key_tool_ed25519</code>: </b> </p><div class="fragment"><div class="line">build$ key_tool_ed25519 --genkey <span class="keyword">new</span></div>
<div class="line">build$ key_tool_ed25519 --genkey new2</div>
<div class="line"> </div>
<div class="line">build$ key_tool_ed25519 --sign test.file pri_new.bin <span class="keyword">new</span>.sign</div>
<div class="line">build$ key_tool_ed25519 --sign test2.file pri_new.bin new2.sign</div>
<div class="line"> </div>
<div class="line"><span class="comment">//should get pass(no return)</span></div>
<div class="line">build$ key_tool_ed25519 --verify test.file pub_new.bin <span class="keyword">new</span>.sign</div>
<div class="line">build$ key_tool_ed25519 --verify test2.file pub_new.bin new2.sign</div>
<div class="line"> </div>
<div class="line"><span class="comment">//should get failed([error]: verify_signature failed, ret -100)</span></div>
<div class="line">build$ key_tool_ed25519 --verify test.file pub_new.bin new2.sign</div>
<div class="line">build$ key_tool_ed25519 --verify test.file pub_new2.bin <span class="keyword">new</span>.sign </div>
<div class="line">build$ key_tool_ed25519 --verify test2.file pub_new.bin <span class="keyword">new</span>.sign</div>
<div class="line"> </div>
<div class="line">build$ cp test2.file test3.file</div>
<div class="line">build$ key_tool_ed25519 --sign test3.file pri_new.bin --embeded</div>
<div class="line">build$ key_tool_ed25519 --verify test3.file pub_new.bin --embeded</div>
<div class="line"><span class="comment">//should fail</span></div>
<div class="line">build$ key_tool_ed25519 --verify test3.file pub_new.bin --embeded\</div>
</div><!-- fragment --><p ><b><code>test_digital_signature</code> </b> </p><div class="fragment"><div class="line">build$ test_digital_signature --genrsakey <span class="keyword">new</span></div>
<div class="line">build$ test_digital_signature --genrsakey new2</div>
<div class="line"> </div>
<div class="line">build$ test_digital_signature --sign test.file new_private.txt <span class="keyword">new</span>.sign</div>
<div class="line">build$ test_digital_signature --sign test2.file new_private.txt new2.sign</div>
<div class="line"> </div>
<div class="line"><span class="comment">//should get pass(no return)</span></div>
<div class="line">build$ test_digital_signature --verifysign test.file new_public.txt <span class="keyword">new</span>.sign</div>
<div class="line">build$ test_digital_signature --verifysign test2.file new_public.txt new2.sign</div>
<div class="line"> </div>
<div class="line">build$ test_digital_signature --verifysign test.file new_public.bin <span class="keyword">new</span>.sign --binkey</div>
<div class="line">build$ test_digital_signature --verifysign test2.file new_public.bin new2.sign --binkey</div>
<div class="line"> </div>
<div class="line"><span class="comment">//should get failed([error]: verify_signature failed, ret -7)</span></div>
<div class="line">build$ test_digital_signature --verifysign test.file new_public.txt new2.sign</div>
<div class="line">build$ test_digital_signature --verifysign test.file new2_public.txt <span class="keyword">new</span>.sign </div>
<div class="line">build$ test_digital_signature --verifysign test2.file new_public.txt <span class="keyword">new</span>.sign</div>
<div class="line"> </div>
<div class="line">build$ test_digital_signature --verifysign test.file new_public.bin new2.sign --binkey</div>
<div class="line">build$ test_digital_signature --verifysign test.file new2_public.bin <span class="keyword">new</span>.sign --binkey</div>
<div class="line">build$ test_digital_signature --verifysign test2.file new_public.bin <span class="keyword">new</span>.sign --binkey</div>
<div class="line"> </div>
<div class="line">build$ cp test2.file test3.file</div>
<div class="line">build$ test_digital_signature --sign test3.file new_private.txt --embeded</div>
<div class="line">build$ test_digital_signature --verifysign test3.file new_public.txt --embeded</div>
<div class="line">build$ test_digital_signature --verifysign test3.file new_public.bin  --embeded --binkey</div>
<div class="line"> </div>
<div class="line"><span class="comment">//should fail</span></div>
<div class="line">build$ test_digital_signature --verifysign test1.file new_public.txt --embeded</div>
</div><!-- fragment --><p ><a class="anchor" id="Crypto_Performace"></a></p>
<h1><a class="anchor" id="test_crypto_performance"></a>
13. Crypto Performace</h1>
<p >Users can test the crypto performance for Ambarella chips. </p>
<h2><a class="anchor" id="test_crypto_performance_openssl"></a>
13.1 Openssl Crypto Performace</h2>
<p >Refer to <code>ambarella/security/validation/crypto_performance/openssl/help_crypto_performance.txt</code> for more information.</p>
<h2><a class="anchor" id="test_crypto_performance_optee"></a>
13.2 OP-TEE Crypto Performace</h2>
<p >Refer to <code>ambarella/security/validation/crypto_performance/optee/help_crypto_performance.txt</code> for more information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
