<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: System Integrity Protection</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d7d/sys_integrity_protection.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">System Integrity Protection </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_boot"></a>
1. Secure Boot by Built-In Hardware Engine</h1>
<p >Secure boot is a mechanism which guarantees that only the trusted firmware is executed. Typically, the digital signature is used to identify if the loaded firmware is secure or corrupt. Only the private key owner is able to generate the correct digital signature, and the public key on the device is protected by hardware, such as one-time programmable (OTP). The private key and the public key in OTP constitute the "key pair."</p>
<p >The boot sequence includes several components which must authenticate the following component before it can be executed. The complete authentication chain that includes the "not-tampered public key" and the "not-leaked private key" successfully achieves the secure boot.</p>
<h2><a class="anchor" id="auth_chain"></a>
1.1 Authentication Chain</h2>
<p >Code execution begins with the code built into the system on chip (SoC)'s read-only memory (ROM). The ROM code with the digital signature check capability is called Secure ROM.</p>
<p >The following diagram illustrates the <a class="el" href="../../df/d7d/sys_integrity_protection.html#Authentication_Chain_of_the_Secure_Boot_With_Arm_TrustZone">Authentication_Chain_of_the_Secure_Boot_With_Arm_TrustZone</a> and <a class="el" href="../../df/d7d/sys_integrity_protection.html#Authentication_Chain_of_the_Secure_Boot_Without_Arm_TrustZone">Authentication_Chain_of_the_Secure_Boot_Without_Arm_TrustZone</a>. The black line indicates the boot sequence, while the blue dashed line represents the authentication key and target.</p>
<p ><a class="anchor" id="Authentication_Chain_of_the_Secure_Boot_With_Arm_TrustZone"></a></p><div class="image">
<img src="../../auth_chain_sec_boot.png" alt=""/>
<div class="caption">
Figure 1-1. Authentication Chain of Secure Boot With Arm® TrustZone®.</div></div>
<p ><a class="anchor" id="Authentication_Chain_of_the_Secure_Boot_Without_Arm_TrustZone"></a></p><div class="image">
<img src="../../auth_chain_without_sec_boot.png" alt=""/>
<div class="caption">
Figure 1-2. Authentication Chain of the Secure Boot Without Arm TrustZone.</div></div>
<p >The secure boot authentication chain includes three stages, as follows:</p><ol type="1">
<li>First, the Secure ROM code covers ROM to bootstrapper (BST), and BST to BL2 (ATF)</li>
<li>Next, the Arm trusted firmware (ATF) (BL2) code covers the second stage:<ul>
<li>BL2 (ATF) to BL31 (ATF)</li>
<li>BL2 (ATF) to BL32 (OP-TEE)</li>
<li>BL2 (ATF) to BL33 (AMBoot)</li>
</ul>
</li>
<li>Finally, the AMBoot code (BL33) covers the third stage:<ul>
<li>BL33 (AMBoot) to the Linux kernel OTP stores the root of trust (RoT) public key (PK). The RoT PK is used to authenticate the BST and the ATF (BL2). The keys in chain of trust (CoT) certificates are used to authenticate BL31, BL32, and BL33. The kernel key authenticates the Linux kernel.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="cot"></a>
1.2 Chain of Trust</h2>
<p >ATF defines the CoT, which describes the root key (CoT root) and its derived keys. The figure illustrates the ATF chain of trust.</p>
<p ><a class="anchor" id="Chain_of_Trust_as_Defined_by_ATF"></a></p><div class="image">
<img src="../../chain_of_trust.png" alt=""/>
<div class="caption">
Figure 1-3. Chain of Trust as Defined by ATF.</div></div>
<h2><a class="anchor" id="chose_crypt_alg"></a>
1.3 Chosen Cryptography Algorithms</h2>
<p >The secure boot employs EdDSA (ED25519 and SHA2-512) for digital signature authentication. The CoT in ATF uses RSA or ellipse curve cryptography (ECC) as an asymmetric cryptography.</p>
<h2><a class="anchor" id="mem_layout"></a>
1.4 System Memory Layout</h2>
<p >When a secure operating system (OS) (BL32) is required for Arm TrustZone, it will require approximately 16 MB of memory. The tables below provide the different system memory layouts with and without Arm TrustZone. Users can also update the BL33 start address and the Linux (kernel) start address in menuconfig.</p>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> boot  ---&gt;</div>
<div class="line">  amboot (boot/ambamk)  ---&gt;</div>
<div class="line">   Ambarella Firmware Configuration  ---&gt;</div>
<div class="line">    Memory Options ---&gt;</div>
<div class="line">     (0x01c00000) AMBoot starting address  <span class="comment">// BL33 start address</span></div>
<div class="line">  Memory ---&gt;</div>
<div class="line">   (0x02000000) Kernel start address    <span class="comment">// Linux (Kernel) start address</span></div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> recipes-bsp  ---&gt;</div>
<div class="line">  amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">   Ambarella Firmware Configuration  ---&gt;</div>
<div class="line">    Memory Options ---&gt;</div>
<div class="line">     (0x01c00000) AMBoot starting address  <span class="comment">// BL33 start address</span></div>
<div class="line">  Memory ---&gt;</div>
<div class="line">   (0x02000000) Kernel start address    <span class="comment">// Linux (Kernel) start address</span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>When the bootloader (BLD) address changes with Arm TrustZone enabled, the firmware programming start address must be changed accordingly. Otherwise, the firmware programming will conflict with the bootloader in memory. Re-downloading non-TrustZone firmware will fail, for example, when the board is using TrustZone-enabled firmware. To prevent this potential failure, change the firmware programming start address of the non-TrustZone firmware, then re-compile.</dd></dl>
<h3><a class="anchor" id="mem_layout_with_tz"></a>
1.4.1 With Arm TrustZone</h3>
<p >Users can refer to <code>ambarella\boot\amboot\doc\mem_layout.txt</code>.</p>
<a class="anchor" id="System_Memory_Layouts_with_Arm_TrustZone"></a>
<table class="doxtable">
<caption>Table 1-1. System Memory Layouts with Arm TrustZone.</caption>
<tr>
<th align="left">Major</th><th align="left">Sub1</th><th align="left">Sub2</th><th align="left">Start Address</th><th align="left">End Address</th><th align="left">Total Size </th></tr>
<tr>
<td rowspan="4"><b>Secure World Memory</b> </td><td>ATF (BL2)</td><td></td><td>0x00000000</td><td>0x0007FFFF</td><td>512 KB </td></tr>
<tr>
<td>ATF (BL31)</td><td></td><td>0x00080000</td><td>0x000FFFFF</td><td>512 KB </td></tr>
<tr>
<td rowspan="2">Open portable trusted execution environment (OP-TEE) (BL32)</td><td>Trusted execution environment (TEE) memory</td><td>0x00100000</td><td>0x001FFFFF</td><td>1 MB </td></tr>
<tr>
<td>Trusted application (TA) memory</td><td>0x00200000</td><td>0x013FFFFF</td><td>18 MB </td></tr>
<tr>
<td rowspan="4"><b>Normal World Memory</b> </td><td>Shared memory</td><td></td><td>0x01400000</td><td>0x017FFFFF</td><td>4 MB </td></tr>
<tr>
<td>EL2 RSVD</td><td></td><td>0x01800000</td><td>0x01BFFFFF</td><td>4 MB </td></tr>
<tr>
<td>BLD (BL33)</td><td></td><td>0x01C00000</td><td>0x01FFFFFF</td><td>4 MB </td></tr>
<tr>
<td>Linux</td><td></td><td>0x02000000</td><td></td><td>Total: 32 MB </td></tr>
</table>
<h3><a class="anchor" id="mem_layout_without_tz"></a>
1.4.2 Without Arm TrustZone</h3>
<a class="anchor" id="System_Memory_Layouts_without_Arm_TrustZone"></a>
<table class="doxtable">
<caption>Table 1-2. System Memory Layouts without Arm TrustZone.</caption>
<tr>
<th align="left">Modules</th><th align="left">Start Address</th><th align="left">End Address</th><th align="left">Total Size </th></tr>
<tr>
<td><b>ATF (BL2)</b></td><td>0x00000000</td><td>0x0007FFFF</td><td>512 KB </td></tr>
<tr>
<td><b>ATF (BL31)</b></td><td>0x00080000</td><td>0x000FFFFF</td><td>512 KB </td></tr>
<tr>
<td><b>BLD (BL33)</b></td><td>0x00100000</td><td>0x0047FFFF</td><td>3.5 MB </td></tr>
<tr>
<td><b>Linux</b> </td><td>0x01C00000</td><td></td><td>Total size: 28 MB </td></tr>
</table>
<h2><a class="anchor" id="sec_boot_user_guide"></a>
1.5 User Guide</h2>
<p >Refer to <a class="el" href="../../db/dfb/key_management.html">Key Management</a> for more information.</p>
<h1><a class="anchor" id="sec_ota"></a>
2. Secure Over the Air (OTA)</h1>
<h2><a class="anchor" id="online_upgrade"></a>
2.1. Online Upgrade</h2>
<p >Users can upgrade each partition with the tools provided by Ambarella.</p>
<h3><a class="anchor" id="partition_with_sec_boot_on"></a>
2.1.1 Partition Locations with Secure Boot Enabled</h3>
<p >When secure boot is enabled, partitions such as BST, BLD, ATF, and primary (PRI) are signed. The items below list their locations.</p>
<p ><b>Amba build:</b></p><ul>
<li><b>BST:</b> <code>ambarella/out/&lt;board&gt; /objects/boot/amboot/bst_release.bin.signed</code></li>
<li><b>BLD:</b> <code>ambarella/out/&lt;board&gt;/objects/boot/amboot/fip.bin</code></li>
<li><b>ATF:</b> <code>ambarella/out/&lt;board&gt;/objects/boot/amboot/atf.bin.signed</code></li>
<li><b>PRI:</b> <code>ambarella/out/&lt;board&gt;/images/Image.SIGNED</code></li>
</ul>
<p ><b>Yocto build:</b></p><ul>
<li><b>BST:</b> <code>ambarella/out/&lt;board&gt;/tmp/work/cortexa53-crypto-poky-linux/amboot/1.0-r0/amboot-1.0/bst_release.bin.signed</code></li>
<li><b>BLD:</b> <code>ambarella/tmp/work/cortexa53-crypto-poky-linux/amboot/1.0-r0/amboot-1.0/fip.bin</code></li>
<li><b>ATF:</b> <code>ambarella/tmp/work/cortexa53-crypto-poky-linux/amboot/1.0-r0/amboot-1.0/atf.bin.signed</code></li>
<li><b>PRI:</b> <code>ambarella/out/&lt;board&gt;/images/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</code></li>
</ul>
<h3><a class="anchor" id="enable_upgrade_tool"></a>
2.1.2 Enable the Upgrade Tool</h3>
<p >To enable the upgrade tool, select the following items in <code>make menuconfig</code>.</p>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> app  ---&gt;</div>
<div class="line">  utility  ---&gt;</div>
<div class="line">   upgrade_partition  ---&gt;</div>
<div class="line">    upgrade-partition (app/utility/upgrade_partition/app)</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line"> meta-ambaapp  ---&gt;</div>
<div class="line">  recipes-upgrade-partition  ---&gt;</div>
<div class="line">    upgrade-partition (meta-ambaapp/recipes-upgrade-partition/upgrade-partition)</div>
</div><!-- fragment --><h3><a class="anchor" id="upgrade_partition_on_board"></a>
2.1.3 Upgrade the Partition on Board</h3>
<ol type="1">
<li>Place or mount the partition to be upgraded on the board (use <code>/mnt/partition/&lt;partition file&gt;</code> for example).</li>
<li>Upgrade the partition with tools. Below are two examples, one for the electronic logic gate NAND and one for the embedded multi-media controller (eMMC).</li>
<li>The following lists the partition file locations.<br  />
 <b>BST partition file:</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line"> ambarella/out/amba_out/cv5_timn/amboot/bst_release.bin.signed</div>
<div class="line">b. yocto-build:</div>
<div class="line"> ambarella/out/yocto_out/cv5_timn/tmp/work/cortexa76-poky-linux/amboot/1.0-r0/ deploy-amboot/bst_release.bin.signed</div>
</div><!-- fragment --> <b>ATF partition file:</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line">ambarella/out/amba_out/cv5_timn/amboot/atf.bin.signed</div>
<div class="line">b. yocto-build:</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/tmp/work/cortexa76-poky-linux/amboot/1.0-r0/deploy-amboot/atf.bin.signed</div>
</div><!-- fragment --> <b>BLD partition file:</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line">ambarella/out/amba_out/cv5_timn/amboot/fip.bin</div>
<div class="line">b. yocto-build:</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/tmp/work/cortexa76-poky-linux/amboot/1.0-r0/deploy-amboot/fip.bin</div>
</div><!-- fragment --> <b>BAK partition file</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line">ambarella/out/amba_out/cv5_timn/amboot/bakfw/bst_bld_atf_release.bin</div>
<div class="line">b. yocto-build:</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/tmp/work/cortexa76-poky-linux/amboot/1.0-r0/ amboot-1.0/bakfw/bst_bld_atf_release.bin</div>
</div><!-- fragment --> <b>Linux kernel file:</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line">ambarella/out/amba_out/cv5_timn/kernel/Image.SIGNED</div>
<div class="line">b. yocto-build:</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/images/Image--5.15.120-r0-cv5x-20230801023530.bin.SIGNED</div>
</div><!-- fragment --> <b>Linux rootfs file:</b> <div class="fragment"><div class="line">a. amba-build:</div>
<div class="line">1) NAND</div>
<div class="line"> ambarella/out/amba_out/cv5_timn/rootfs/ubifs</div>
<div class="line">2) EMMC</div>
<div class="line">ambarella/out/amba_out/cv5_timn/rootfs/ext4</div>
<div class="line">yocto-build:</div>
<div class="line">1) NAND</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/images/ipcam-image-cv5x-20230526073637.rootfs.ubi</div>
<div class="line">2) EMMC</div>
<div class="line">ambarella/out/yocto_out/cv5_timn/images/ipcam-image-cv5x-20230526073637.rootfs.ext4</div>
</div><!-- fragment --></li>
<li>The commands to erase / upgrade partitions are as follows:</li>
</ol>
<ul>
<li><p class="startli"><b>NAND:</b></p>
<p class="startli">Amba build: </p><div class="fragment"><div class="line">BST:    flash_eraseall /dev/mtd0       upgrade_partition -p    /dev/mtd0  /sdcard/bst_release.bin.signed</div>
<div class="line">BLD:    flash_eraseall /dev/mtd1       upgrade_partition -p -G /dev/mtd1  /sdcard/fip.bin</div>
<div class="line">ATF:    flash_z`eraseall /dev/mtd3       upgrade_partition -p -H /dev/mtd3  /sdcard/atf.bin.signed</div>
<div class="line">PRI:    flash_eraseall /dev/mtd5       upgrade_partition -p -K /dev/mtd5  /sdcard/Image.SIGNED</div>
<div class="line">PBA:    flash_eraseall /dev/mtd4       upgrade_partition -p -Q /dev/mtd4  /sdcard/Image.SIGNED</div>
<div class="line">LNX:    flash_eraseall /dev/mtd8       upgrade_partition -p -W /dev/mtd8  /sdcard/ubifs</div>
<div class="line">ROM:    flash_eraseall /dev/mtd7       upgrade_partition -p -R /dev/mtd7  /sdcard/ubifs</div>
<div class="line">BAK:    flash_eraseall /dev/mtd6       upgrade_partition -p -B /dev/mtd6  /sdcard/.bin file <span class="keywordflow">for</span> backup（bst_bld_atf_release.bin）</div>
</div><!-- fragment --><p class="startli">Yocto build: </p><div class="fragment"><div class="line">BST:    flash_eraseall /dev/mtd0       upgrade_partition -p    /dev/mtd0  /sdcard/bst_release.bin.signed</div>
<div class="line">BLD:    flash_eraseall /dev/mtd1       upgrade_partition -p -G /dev/mtd1  /sdcard/fip.bin</div>
<div class="line">ATF:    flash_eraseall /dev/mtd3       upgrade_partition -p -H /dev/mtd3  /sdcard/atf.bin.signed</div>
<div class="line">PRI:    flash_eraseall /dev/mtd5       upgrade_partition -p -K /dev/mtd5  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">PBA:    flash_eraseall /dev/mtd4       upgrade_partition -p -Q /dev/mtd4  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">LNX:    flash_eraseall /dev/mtd8       upgrade_partition -p -W /dev/mtd8  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ubi</div>
<div class="line">ROM:    flash_eraseall /dev/mtd7       upgrade_partition -p -R /dev/mtd7  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ubi</div>
<div class="line">BAK:    flash_eraseall /dev/mtd6       upgrade_partition -p -B /dev/mtd6  /sdcard/bst_bld_atf_release.bin</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>eMMC</b></p>
<p class="startli">Amba build: </p><div class="fragment"><div class="line">BST:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p1       upgrade_partition -p    /dev/mmcblk0p1  /sdcard/bst_release.bin.signed</div>
<div class="line">BLD:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p2       upgrade_partition -p -G /dev/mmcblk0p2  /sdcard/fip.bin</div>
<div class="line">ATF:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p4       upgrade_partition -p -H /dev/mmcblk0p4  /sdcard/atf.bin.signed</div>
<div class="line">PRI:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p6       upgrade_partition -p -K /dev/mmcblk0p6  /sdcard/Image.SIGNED</div>
<div class="line">PBA:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p5       upgrade_partition -p -Q /dev/mmcblk0p5  /sdcard/Image.SIGNED</div>
<div class="line">LNX:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p9       upgrade_partition -p -W /dev/mmcblk0p9  /sdcard/ubifs</div>
<div class="line">ROM:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p8       upgrade_partition -p -R /dev/mmcblk0p8  /sdcard/ubifs</div>
<div class="line">BAK:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p7       upgrade_partition -p -B /dev/mmcblk0p7  /sdcard/.bin file <span class="keywordflow">for</span> backup（bst_bld_atf_release.bin）</div>
</div><!-- fragment --><p class="startli">Yocto build: </p><div class="fragment"><div class="line">BST:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0boot0    upgrade_partition -p -b 1    /dev/mmcblk0boot0  /sdcard/bst_release.bin.signed</div>
<div class="line">BLD:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p2       upgrade_partition -p -b 1 -G /dev/mmcblk0p2  /sdcard/fip.bin</div>
<div class="line">ATF:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p4       upgrade_partition -p -b 1 -H /dev/mmcblk0p4  /sdcard/atf.bin.signed</div>
<div class="line">PRI:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p6       upgrade_partition -p -b 1 -K /dev/mmcblk0p6  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">PBA:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p5       upgrade_partition -p -b 1 -Q /dev/mmcblk0p5  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">LNX:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p9       upgrade_partition -p -b 1 -W /dev/mmcblk0p9  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ext4</div>
<div class="line">ROM:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p8       upgrade_partition -p -b 1 -R /dev/mmcblk0p8  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ext4</div>
<div class="line">BAK:    dd <span class="keywordflow">if</span>=/dev/zero of=/dev/mmcblk0p7       upgrade_partition -p -b 1 -B /dev/mmcblk0p7  /sdcard/bst_bld_atf_release.bin</div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Partitions are located in different places with different file systems; users must change the upgrade command line to fit their own environment. Users can find the partition location from the boot log: <div class="fragment"><div class="line">[1.060741]  (bst): 0x0000000000000000, 0x0000000000001000</div>
<div class="line">[1.066215]  (bld): 0x0000000000001000, 0x0000000000100000</div>
<div class="line">[1.071684]  (ptb): 0x0000000000101000, 0x00000000000e0000</div>
<div class="line">[1.077152]  (atf): 0x00000000001e1000, 0x0000000000100000</div>
<div class="line">[1.082620]  (pba): 0x00000000002e1000, 0x0000000001000000</div>
<div class="line">[1.088088]  (pri): 0x00000000012e1000, 0x0000000001000000</div>
<div class="line">[1.093559]  (lnx): 0x00000000022e1000, 0x0000000020000000</div>
<div class="line">[1.099032]  (raw): 0x00000000222e1000, 0x00000001afeef000</div>
<div class="line">[1.104496]  mmcblk0: p1(bst) p2(bld) p3(ptb) p4(atf) p5(pba) p6(pri) p7(lnx) p8(raw)</div>
</div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="rescue_mode"></a>
2.2 Rescue Mode</h2>
<p >Rescue mode uses the recovery partition (BAK) as a back-up boot option. When there is an authentication failure (or a digital signature check failure), the boot can switch to rescue mode and boot from the recovery partition. An authentication failure indicates unexpected contents in the external storage, which could be caused by an attack, an aging device, sudden power loss, or a system upgrade abortion, among other causes. Rescue mode enables manufacturers to attempt to repair the device online. The figure below illustrates the boot sequence (red text represents the partition names), including rescue mode and the secure BAK partition with a digital signature. In the BAK partition, only BL2, BL31, BL32, and BL33 can be included.</p>
<p ><a class="anchor" id="Authentication_Chain_and_Partition_Layout_in_Rescue_Mode"></a></p><div class="image">
<img src="../../auth_chain_in_res_mode.png" alt=""/>
<div class="caption">
Figure 1-4. Authentication Chain and Partition Layout in Rescue Mode.</div></div>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Firmware inside the recovery partition also includes a valid digital signature.</li>
<li>If the BST is broken, rescue mode cannot function; the CPU will remain at Secure ROM until the damaged NAND is replaced.</li>
</ul>
</dd></dl>
<h3><a class="anchor" id="rescue_mode_with_mcu"></a>
2.2.1 Rescue Mode with External MCU</h3>
<p >Due to the BST code size limit, selecting the normal boot path and the rescue boot path is explicitly triggered via the external microcontroller unit (MCU); therefore, an external MCU is required for this rescue mode.</p>
<h3><a class="anchor" id="rescue_mode_without_mcu"></a>
2.2.2 Rescue Mode without External MCU (V2)</h3>
<p >On chips such as CV5x / CV7x, on which the BST code size is sufficient in order to embed auto-selected "normal boot" and "rescue boot" logic, Ambarella plans to enable "Rescue Mode v2", which can function without an external MCU. In Rescue Mode V2, the system selects “normal boot path” or “rescue boot path” automatically at the bootloader stage. If the “normal boot path” fails multiple times, the system will reset and attempt the “rescue boot path”. There are two copies for A/B ping-pong switching for the Linux kernel and rootfs partitions. The PRI and LNX partitions are A’s kernel and rootfs, while the PBA and ROM partitions are B’s kernel and rootfs. A and B are also fail-safe; the system will record the “last workable kernel and rootfs”. If the “last workable kernel and rootfs” does not function, the system marks the “last workable kernel and rootfs” to the other set and then resets the boot process. Both the “normal boot path” and “rescue boot path” can function with A and B. The success of kernel+Roofts boot is guarded by a watchdog; by default, the watchdog is internal. If there is an external watchdog, support for “disable external watchdog” must be added.</p>
<p ><a class="anchor" id="Authentication_Chain_and_Partition_Layout_in_Rescue_Mode_V2"></a></p><div class="image">
<img src="../../auth_chain_in_res_mode_v2.png" alt=""/>
<div class="caption">
Figure 1-5. Authentication Chain and Partition Layout in Rescue Mode V2.</div></div>
<p> 、</p>
<p >Rescue Mode v2 is designed to guarantee fail-safes during system upgrade, except in very extreme cases (for example, the BST partition upgrade is aborted or the BST partition is damaged). The recommended upgrade processes for different scenarios are listed below. Except for the “BST partition” issue, all cases care fail-safe, meaning that the system is able to boot into Linux and continue to complete the upgrade process. The BST is located at the first NAND block. The NAND manufacturer ensures that the first block is not easily corrupted. OTA can perform a sanity check of the BST partition content before programming the BST partition (a signature check with the RoT key inside OTP, as well as a cyclic redundancy check (CRC) for the partition). Because the BST partition is small, the program runs quickly. A sudden loss of power in such a small time frame is extremely unlikely. The result is a well-designed OTA process that, with Rescue Mode v2, covers almost all OTA failure cases.</p>
<a class="anchor" id="Recommended_Upgrade_Processes_for_Different_Scenarios"></a>
<table class="doxtable">
<caption>Table 1-3.Recommended Upgrade Processes for Different Scenarios</caption>
<tr>
<th align="left">Scenarios</th><th align="left">Affect Partitions</th><th align="left">Recommended Steps</th><th align="left">Fail-safe Description</th><th align="left">Possibility</th><th align="left">Severity </th></tr>
<tr>
<td rowspan="4">RoT key revocation</td><td rowspan="4">BST, ATF, BLD, BAK </td><td rowspan="4">Step 1: upgrade BAK (new key)<br  />
Step 2: revoke RoT key<br  />
Step 3: upgrade BST (new key)<br  />
Step 4: upgrade ATF </td><td>Update BAK failed: no issues, the “normal boot path” is still OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Revoke key failed: no issues, “normal boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Upgrade BST failed: return material authorization (RMA) is required; reprogram NAND or replace NAND</td><td>Very small</td><td>Critical </td></tr>
<tr>
<td>Upgrade ATF, BLD partition failed: no problem, “rescue boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td rowspan="4">Kernel key revocation</td><td rowspan="4">BLD, BAK, PRI, LNX, PBA, ROM </td><td rowspan="4">Step 1: upgrade BAK (new key)<br  />
Step 2: upgrade PBA, ROM (new key)<br  />
Step 3: upgrade ATF, BLD (new key)<br  />
Step 4: upgrade PRI, LNX (new key) </td><td>Update BAK failed: no issues, “normal boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Update PBA, ROM failed: no issues, “normal boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Update ATF, BLD failed: no issues, “rescue boot path + B” is OK</td><td>Very small</td><td>Critical </td></tr>
<tr>
<td>Update PRI, LNX failed: no issues, “rescue boot path” + B is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>BST update / bugfix</td><td>BST</td><td>Update BST</td><td>Upgrade BST failed: RMA is required, reprogram NAND or replace NAND</td><td>Very small</td><td>Critical </td></tr>
<tr>
<td rowspan="2">ATF update / bugfix</td><td rowspan="2">ATF, BLD, BAK </td><td rowspan="2">Step 1: upgrade BAK<br  />
Step 2: upgrade ATF, BLD </td><td>BAK failed: no issues, “normal boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Upgrade ATF, BLD failed: no issues, “rescue boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td rowspan="2">OP-TEE OS and AMBoot update / bugfix</td><td rowspan="2">BLD, BAK </td><td rowspan="2">Step 1: upgrade BAK<br  />
Step 2: upgrade BLD </td><td>BAK failed: no issues, “normal boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Upgrade BLD failed: no issues, “rescue boot path” is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Update Linux, maintain compatibility</td><td>PRI, LNX</td><td>Update PRI, LNX</td><td>Upgrade PRI, LNX failed: no issues, B (PBA, ROM) is OK</td><td></td><td>Minor </td></tr>
<tr>
<td rowspan="2">Update Linux, do not maintain compatibility</td><td rowspan="2">PRI, LNX, PBA, ROM </td><td rowspan="2">Step 1: upgrade PBA, ROM<br  />
Step 2: upgrade PRI, LNX </td><td>Upgrade PBA, ROM failed: no issues, A (PRI, LNX) is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Upgrade PRI, LNX failed: no issues, B (PBA, ROM) is OK </td><td></td><td>Minor </td></tr>
<tr>
<td rowspan="3">Update Linux, do not maintain compatibility</td><td rowspan="3">BST, ATF, BLD, BAK, PRI, LNX, PBA, ROM </td><td rowspan="3">Step 1: upgrade BAK, PBA, and ROM<br  />
Step 2: upgrade BST<br  />
Step 3: upgrade ATF, BLD, PRI, and LNX </td><td>Upgrade BAK, PBA, ROM failed: no issues, “normal boot path” + A is OK</td><td></td><td>Minor </td></tr>
<tr>
<td>Upgrade BST failed: RMA is required, reprogram NAND or replace NAND</td><td>Very small</td><td>Critical </td></tr>
<tr>
<td>Upgrade ATF, BLD, PRI, LNX failed: no issues, “rescue boot path” + B is OK</td><td></td><td>Minor </td></tr>
</table>
<p ><b>Getting Started</b></p>
<p >To build firmware with Rescue Mode v2, the following configurations must be selected in menuconfig. Or, users can use the existing board configuration: <code>xxx_rescue_config</code> or <code>xxx_emmc_rescue_config</code>. Select <code>Recovery Firmware Images</code> in <code>menuconfig</code>: </p><div class="fragment"><div class="line"> Prompt: Build Recovery Firmware Images</div>
<div class="line">│   Depends on: CONFIG_BOOT [=y] &amp;&amp; CONFIG_BOOTLOADER_AMBOOT [=y]</div>
<div class="line">│   Location:</div>
<div class="line">│    Main menu</div>
<div class="line">│     -&gt; meta-ambabsp</div>
<div class="line">│      -&gt; recipes-bsp</div>
<div class="line">│       -&gt; boot (meta-ambabsp/recipes-bsp/boot) (CONFIG_BOOT [=y])</div>
<div class="line">│        -&gt; Bootloader</div>
<div class="line">│         -&gt; Ambarella Firmware Configuration</div>
<div class="line">│          -&gt; AMBoot Options</div>
<div class="line">│           -&gt; Build Recovery Firmware Images (BUILD_FIRMWARE_RECOVERY [=y])</div>
</div><!-- fragment --><p> Select <code>Without External MCU</code> in <code>menuconfig</code>: </p><div class="fragment"><div class="line">│   Prompt: Build Recovery Firmware Images</div>
<div class="line">│   Depends on: CONFIG_BOOT [=y] &amp;&amp; CONFIG_BOOTLOADER_AMBOOT [=y]</div>
<div class="line">│   Location:</div>
<div class="line">│       Main menu</div>
<div class="line">│     -&gt; meta-ambabsp</div>
<div class="line">│      -&gt; recipes-bsp</div>
<div class="line">│       -&gt; boot (meta-ambabsp/recipes-bsp/boot) (CONFIG_BOOT [=y])</div>
<div class="line">│        -&gt; Bootloader</div>
<div class="line">│         -&gt; Ambarella Firmware Configuration</div>
<div class="line">│          -&gt; AMBoot Options</div>
<div class="line">│           -&gt; Build Recovery Firmware Images (BUILD_FIRMWARE_RECOVERY [=y])</div>
</div><!-- fragment --><p> Select <code>Without External MCU</code> in <code>menuconfig</code>: </p><div class="fragment"><div class="line">│   Prompt: Auto Recovery Without External MCU</div>
<div class="line">│   Depends on: CONFIG_BOOT [=y] &amp;&amp; CONFIG_BOOTLOADER_AMBOOT [=y] &amp;&amp; BUILD_FIRMWARE_RECOVERY [=y]</div>
<div class="line">│   Location:</div>
<div class="line">│    Main menu</div>
<div class="line">│     -&gt; meta-ambabsp</div>
<div class="line">│      -&gt; recipes-bsp</div>
<div class="line">│       -&gt; boot (meta-ambabsp/recipes-bsp/boot) (CONFIG_BOOT [=y])</div>
<div class="line">│        -&gt; Bootloader</div>
<div class="line">│         -&gt; Ambarella Firmware Configuration</div>
<div class="line">│          -&gt; AMBoot Options</div>
<div class="line">│           -&gt; Build Recovery Firmware Images (BUILD_FIRMWARE_RECOVERY [=y])</div>
<div class="line">│            -&gt; Auto Recovery Without External MCU</div>
</div><!-- fragment --><p> Select <code>mtd-utils</code> in <code>menuconfig</code> (NAND): </p><div class="fragment"><div class="line">│   Prompt: mtd-utils (meta/recipes-devtools/mtd)</div>
<div class="line">│   Location:</div>
<div class="line">│    Main menu</div>
<div class="line">│     -&gt; meta</div>
<div class="line">│      -&gt; recipes-devtools</div>
<div class="line">│       -&gt; mtd-utils</div>
</div><!-- fragment --><p> Select the bootstat driver in <code>menuconfig</code>: </p><div class="fragment"><div class="line">│   Prompt: kernel-module-bootstat (meta-ambabsp/recipes-bootstat/kernel-module-bootstat)│</div>
<div class="line">│   Location:</div>
<div class="line">│    Main menu</div>
<div class="line">│     -&gt; meta-ambabsp</div>
<div class="line">│      -&gt; recipes-bootstat</div>
<div class="line">│       -&gt; kernel-module-bootstat</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>If using eMMC, the boot arguments (bootargs) must be changed. In <code>ambarella/&lt;board&gt;/ bsp/xxx.dts</code>, change the bootargs to <code>console=ttyS0 noinitrd root=/dev/mmcblk0p9 rw rootfstype=ext4 rootwait</code>.</dd></dl>
<p><b>Check the Current Boot Mode</b></p>
<p >Users can check the kernel command line to see which partitions are used for the file system.</p>
<ul>
<li><b>NAND:</b></li>
</ul>
<p >If the file system is from the LNX partition, the kernel command line is printed as follows: <code>console=ttyS0 ubi.mtd=lnx root=ubi0:rootfs rw rootfstype=ubifs</code>. If the file system is from the ROM partition, the kernel command line is printed as follows: <code>console=ttyS0 ubi.mtd=rom root=ubi0:rootfs rw rootfstype=ubifs</code>.</p>
<ul>
<li><b>eMMC:</b></li>
</ul>
<p >If the file system is from the LNX partition, the kernel command line is printed as follows: <code>console=ttyS0 noinitrd root=/dev/mmcblk0p9 rw rootfstype=ext4 rootwait</code>. If the file system is from the ROM partition, the kernel command line is printed as follows: <code>console=ttyS0 noinitrd root=/dev/mmcblk0p8 rw rootfstype=ext4 rootwait</code>.</p>
<p ><b>Check the Current Boot Path</b> </p><div class="fragment"><div class="line">Board# modprobe bootstat</div>
<div class="line">Board# cat /proc/ambarella/bootstat</div>
<div class="line">       boot   statu 0x0                        ---&gt; Bootfrom Normal Mode</div>
<div class="line">       system statu 0x5a5a                     ---&gt; Bootfrom PRI+LNX</div>
<div class="line"> </div>
<div class="line">Board# modprobe bootstat</div>
<div class="line">Board# cat /proc/ambarella/bootstat</div>
<div class="line">       boot   statu 0x35a5a                    ---&gt; Bootfrom Recovery Mode</div>
<div class="line">       system statu 0x5a5a                     ---&gt; Bootfrom PRI+LNX</div>
<div class="line"> </div>
<div class="line">Board# modprobe bootstat</div>
<div class="line">Board# cat /proc/ambarella/bootstat</div>
<div class="line">       statu 0x35a5a                    ---&gt; Bootfrom Recovery Mode</div>
<div class="line">       system statu 0xc0015a5a Swap            ---&gt; Bootfrom PBA+ROM</div>
</div><!-- fragment --><ul>
<li><b>System Upgrade with RoT Key Revocation</b></li>
</ul>
<ol type="1">
<li>Upgrade the BAK partition with a new RoT key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd6</div>
<div class="line">board# upgrade_partition -p -B /dev/mtd6  /sdcard/bst_bld_atf_release.bin</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -B /dev/mmcblk0p7  /sdcard/bst_bld_atf_release.bin</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system boots successfully from "Normal Mode + PRI+LNX".</li>
</ul>
</li>
<li>Upgrade the BST partition with a new RoT key. Revoke key1 (new RoT key). <div class="fragment"><div class="line">board# modprobe optee</div>
<div class="line">board# tee-supplicant&amp;</div>
</div><!-- fragment --><ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd0</div>
<div class="line">board# upgrade_partition -p     /dev/mtd0  /sdcard/bst_release.bin.signed</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# echo 0 &gt; /sys/block/mmcblk0boot/force_ro</div>
<div class="line">board# upgrade_partition -p -b 1 /dev/mmcblk0boot0  /sdcard/bst_release.bin.signed</div>
<div class="line">board# test_program_otp --revokekey 0</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system fails at the BST stage, and then check if it can recover. a) Boot will fail at the BST stage several times; there is no print at the serial port. b) The system will boot from "Recover mode + PRI+LNX".</li>
</ul>
</li>
<li>Upgrade the ATF partition to the new RoT key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd3</div>
<div class="line">board# upgrade_partition -p -H /dev/mtd3  /sdcard/atf.bin.signed</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -H /dev/mmcblk0p4  /sdcard/atf.bin.signed</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system fails at the BL2 stage, and then check if it can recover. a) Boot fails at the BL2 stage several times; there is no "BL2: Booting BL31". b) Then, the system boots from "Recovery Mode + PRI+LNX".</li>
</ul>
</li>
<li>Update the BLD partition with the new RoT key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd1</div>
<div class="line">board# upgrade_partition -p -G /dev/mtd1  /sdcard/fip.bin</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -G /dev/mmcblk0p2  /sdcard/fip.bin</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system boots successfully from "Normal Mode + PRI+LNX".</li>
</ul>
</li>
</ol>
<ul>
<li><b>System Upgrade with Kernel Key Revocation</b></li>
</ul>
<ol type="1">
<li>Update the BAK, PBA, and ROM partitions with the new kernel key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd6</div>
<div class="line">board# upgrade_partition -p -B /dev/mtd6  /sdcard/bst_bld_atf_release.bin</div>
<div class="line">board# flash_eraseall /dev/mtd4</div>
<div class="line">board# upgrade_partition -p -Q /dev/mtd4  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">board# flash_eraseall /dev/mtd7</div>
<div class="line">board# upgrade_partition -p -R /dev/mtd7  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ubi</div>
<div class="line">board# upgrade_partition -S 2</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -B /dev/mmcblk0p7  /sdcard/bst_bld_atf_release.bin</div>
<div class="line">board# upgrade_partition -p -b 1 -Q /dev/mmcblk0p5  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">board# upgrade_partition -p -b 1 -R /dev/mmcblk0p8  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ext4</div>
<div class="line">board# upgrade_partition -b 1 -S 2</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Update the BLD partition with a new kernel key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd1</div>
<div class="line">board# upgrade_partition -p -G /dev/mtd1  /sdcard/fip.bin</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -G /dev/mmcblk0p2  /sdcard/fip.bin</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system fails at the BLD stage, then check if it can recover. a) Boot fails at the BLD stage several times; "Authenticate "PRI": failed". b) Then, the system will boot from "Normal mode + PBA+ROM".</li>
</ul>
</li>
<li>Update the PRI partition with a new kernel key.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# flash_eraseall /dev/mtd5</div>
<div class="line">board# upgrade_partition -p -K /dev/mtd5  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">board# upgrade_partition -S 0</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -p -b 1 -K /dev/mmcblk0p6  /sdcard/Image--5.15.112-r0-cv5x-20230526072630.bin.SIGNED</div>
<div class="line">board# upgrade_partition -b 1 -S 0</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system boots successfully from "Normal Mode + PRI+LNX".</li>
</ul>
</li>
<li>Update the LNX partition.<ul>
<li><b>NAND:</b> <div class="fragment"><div class="line">board# upgrade_partition -S 2</div>
<div class="line">board# reboot</div>
<div class="line">board# flash_eraseall /dev/mtd8</div>
<div class="line">board# upgrade_partition -p -W /dev/mtd8  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ubi</div>
<div class="line">board# upgrade_partition -S 0</div>
</div><!-- fragment --></li>
<li><b>eMMC:</b> <div class="fragment"><div class="line">board# upgrade_partition -b 1 -S 2</div>
<div class="line">board# reboot</div>
<div class="line">board# upgrade_partition -p -b 1 -W /dev/mmcblk0p9  /sdcard/ipcam-image-cv5x-20230526073637.rootfs.ext4</div>
<div class="line">board# upgrade_partition -b 1 -S 0</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# echo 0 &gt; /proc/ambarella/bootstat</div>
<div class="line">board# reboot</div>
<div class="line">board# modprobe bootstat</div>
<div class="line">board# cat /proc/ambarella/bootstat</div>
</div><!-- fragment --> Check if the system boots successfully from "Normal Mode + PRI+LNX".</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="dm_verity"></a>
3. Linux Dm-verity</h1>
<p >The device mapper’s “verity” target provides the transparent integrity checking of block devices using a cryptographic digest provided by the kernel crypto application programming interface (API). This target is read-only. Dm-verity cannot function on memory technology devices (MTDs).</p>
<h2><a class="anchor" id="set_up_dm_verity"></a>
3.1 Set Up dm-verity on the Ambarella Platform</h2>
<p >The following lists the steps to set up dm-verity:</p><ol type="1">
<li>Configure the Linux kernel: <div class="fragment"><div class="line">build$ make linux_menuconfig</div>
<div class="line">         -&gt;Device Drivers</div>
<div class="line">          &gt;Multiple devices driver support (RAID and LVM)</div>
<div class="line">           &gt;Device mapper support</div>
<div class="line">              DM <span class="stringliteral">&quot;dm-mod.create=&quot;</span> parameter support</div>
<div class="line">              &gt;Verity target support</div>
<div class="line">               &gt;Verity data device root hash signature verification support</div>
</div><!-- fragment --></li>
<li>Configure the Ambarella platform: Users can enable dm-crypt and test it from the user space. Dm-crypt requires an extra partition to store hash maps; the swap (SWP) partition is used as an example:</li>
</ol>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       &gt; prebuild  ---&gt;</div>
<div class="line">        &gt; oss  ---&gt;</div>
<div class="line">         &gt; prebuild-cryptsetup (prebuild/oss/armv8-a/cryptsetup)  --</div>
<div class="line">          &gt; Add cryptsetup utils into root_fs</div>
<div class="line">        &gt; prebuild-device-mapper (prebuild/oss/armv8-a/device-mapper)  --</div>
<div class="line">         &gt; Add device-mapper utils into root_fs</div>
<div class="line">       &gt; rootfs  ---&gt;</div>
<div class="line">        &gt; rootfs (rootfs/system)  ---&gt;</div>
<div class="line">         &gt; Linux Root File System (EXT4)  ---&gt;</div>
<div class="line">       &gt; boot  ---&gt;</div>
<div class="line">        &gt; amboot (boot/ambamk)  ---&gt;</div>
<div class="line">        &gt; Ambarella Bootloader Configuration</div>
<div class="line">         &gt; AMBoot Options</div>
<div class="line">          &gt; Firmware Options</div>
<div class="line">           &gt; Swap Partition</div>
<div class="line">           ($(AMB_TOPDIR)/amboot/vif/swp.bin) SWP image</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       &gt; meta-oe  ---&gt;</div>
<div class="line">        &gt; recipes-crypto  ---&gt;</div>
<div class="line">         &gt; cryptsetup (meta-oe/recipes-crypto/cryptsetup)</div>
<div class="line">         &gt; recipes-support  ---&gt;</div>
<div class="line">          &gt; libdevmapper (meta-oe/recipes-support/lvm2)</div>
<div class="line">       &gt; meta-ambabsp  ---&gt;</div>
<div class="line">        &gt; recipes-bsp  ---&gt;</div>
<div class="line">         &gt; amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">          &gt; Ambarella Bootloader Configuration</div>
<div class="line">           &gt; AMBoot Options</div>
<div class="line">          &gt; Firmware Options</div>
<div class="line">           &gt; Swap Partition</div>
<div class="line">            ($(AMB_TOPDIR)/amboot/vif/swp.bin) SWP image</div>
</div><!-- fragment --><p >Use the command below to generate a blank <code>swp.bin</code>. </p><div class="fragment"><div class="line">build$ dd <span class="keywordflow">if</span>=/dev/zero of=swp.bin bs=1024 count=20480</div>
</div><!-- fragment --><p> Define the SWP partition size in <code>ambarella/boards/&lt;board_name&gt;/bsp/partition/emmc.h</code>. </p><div class="fragment"><div class="line"><span class="preprocessor">#define AMBOOT_SWP_SIZE     (20 * 1024 * 1024)</span></div>
</div><!-- fragment --><h2><a class="anchor" id="use_dm_verity"></a>
3.2 Use Dm-verity</h2>
<p >Follow the steps below to use dm-verity on the board:</p><ol type="1">
<li>Retrieve the file system block size on the PC. <div class="fragment"><div class="line">build$ tune2fs –l ambarella/out/cv5_timn/rootfs/ext4</div>
</div><!-- fragment --></li>
<li>Set up dm-verity on the board. Partitions: mmcblk0: p1(bst) p2(bld) p3(ptb) p4(atf) p5(pba) p6(pri) p7(lnx) p8(swp) <div class="fragment"><div class="line">board# blockdev –getsz /dev/mmcblk0p7</div>
<div class="line">1024000</div>
<div class="line">board# veritysetup format /dev/mmcblk0p7 /dev/mmcblk0p8 –data-block-size=1024</div>
<div class="line">Data blocks:    512000</div>
<div class="line">Data block size:    1024</div>
<div class="line">Hash block size:    4096</div>
<div class="line">Hash algorithm: sha256</div>
<div class="line">Salt:           4e884d15950b027c65fd0ab8e78131ccf0016c765507c53a299e5e699da74b23</div>
<div class="line">Root hash:      87e678a6e7c017ffaac5f9d5eb11484539668b1b555061918e26922d6fc0d144</div>
</div><!-- fragment --></li>
<li>Enter into AMBoot. <div class="fragment"><div class="line">fdt cmdline console=ttyS0 noinitrd rw rootfstype=ext4 init=/linuxrc rootwait dm-mod.create=<span class="stringliteral">&quot;dm-verity,,0,ro, 0 1024000 verity 1 /dev/mmcblk0p7 /dev/mmcblk0p8 1024 4096 512000 1 sha256 87e678a6e7c017ffaac5f9d5eb11484539668b1b555061918e26922d6fc0d144 4e884d15950b027c65fd0ab8e78131ccf0016c765507c53a299e5e699da74b23&quot;</span> root=/dev/dm-0</div>
</div><!-- fragment --></li>
</ol>
<dl class="section note"><dt>Note</dt><dd>For setups using the device mapper on top of the asynchronously probed block devices (MMC, USB, and more), it may be necessary to tell dm-init to explicitly wait for them to become available before setting up the device mapper tables. This can be performed with the <code>dm-mod.waitfor=</code> module parameter, which uses a list of devices to wait for: <div class="fragment"><div class="line">dm-mod.waitfor=&lt;device1&gt;[,..,&lt;deviceN&gt;]</div>
</div><!-- fragment --> Then, the commandline written in AMBoot changes to the following: <div class="fragment"><div class="line">fdt cmdline console=ttyS0 noinitrd rw rootfstype=ext4 init=/linuxrc rootwait dm-mod.waitfor=/dev/mmcblk0boot0 dm-mod.create=<span class="stringliteral">&quot;dm-verity,,0,ro, 0 1024000 verity 1 /dev/mmcblk0p7 /dev/mmcblk0p8 1024 4096 512000 1 sha256 87e678a6e7c017ffaac5f9d5eb11484539668b1b555061918e26922d6fc0d144 4e884d15950b027c65fd0ab8e78131ccf0016c765507c53a299e5e699da74b23&quot;</span> root=/dev/dm-0</div>
</div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="dm_verity_with_sign_dtb"></a>
3.3 Enable Dm-verity with Signed DTB</h2>
<p >If users are required to use signed device tree blob (DTB) and dm-verity together, bootargs cannot be changed. Follow the below steps to enable both:</p><ol type="1">
<li>Compile and generate the firmware with both the signed DTB and dm-verity; save the <code>rootfs.ext4</code>.</li>
<li>Burn the firmware to the board and run <code>blockdev</code>. <div class="fragment"><div class="line">board# blockdev --getsz /dev/mmcblk0p6</div>
<div class="line">1048576</div>
</div><!-- fragment --></li>
<li>Create a hashtree using a rootfs partition on the evaluation kit (EVK) and save it to the <code>hash_evk.img</code>, save the root hash and salt values to <code>evk_verity.txt</code>. <div class="fragment"><div class="line">board# veritysetup format /dev/mmcblk0p6 hash_evk.img --data-block-size=1024</div>
<div class="line">       VERITY header information <span class="keywordflow">for</span> hash_evk.img</div>
<div class="line">       UUID:                   6b56a58b-2d71-460d-98e1-4d2fa4cbcd43</div>
<div class="line">       Hash type:              1</div>
<div class="line">       Data blocks:            524288</div>
<div class="line">       Data block size:        1024</div>
<div class="line">       Hash block size:        4096</div>
<div class="line">       Hash algorithm:         sha256</div>
<div class="line">       Salt:                   83870773ca1164fe5a8e79a990e6281d22c74f491f2df0bb735827b2f1165bb2</div>
<div class="line">      Root hash:              8991988d265251a0d016450f3580a8f2f1a26e685d65214aff21c61df9577c20</div>
</div><!-- fragment --></li>
<li>Change the LNX image to <code>rootfs.ext4</code> saved in ste p1, set the SWP image to <code>hash_evk.img</code>, and add dm-verity related commands to the command line.</li>
</ol>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">         &gt; boot  ---&gt;</div>
<div class="line">              &gt; amboot (boot/ambamk)  ---&gt;</div>
<div class="line">               &gt; Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">                &gt; AMBoot Options</div>
<div class="line">                 &gt; Commoon Boot Options</div>
<div class="line">                  &gt; (console=ttyS0 noinitrd rw rootfstype=ext4 init=/linuxrc rootwait dm-mod.waitfor=/dev/mmcblk0boot0 dm-mod.create=<span class="stringliteral">&quot;dm-verity,,0,ro, 0 1048576 verity 1 /dev/mmcblk0p6 /dev/mmcblk0p7 1024 4096 524288 1 sha256 8991988d265251a0d016450f3580a8f2f1a26e685d65214aff21c61df9577c20  83870773ca1164fe5a8e79a990e6281d22c74f491f2df0bb735827b2f1165bb2&quot;</span> root=/dev/dm-0) Booting cmdline</div>
<div class="line">                &gt; Firmware Options</div>
<div class="line">                 &gt; Linux Partition</div>
<div class="line">                  (rootfs.ext4) Linux FS image</div>
<div class="line">                 &gt; Swap Partition</div>
<div class="line">                  (hash_evk.img) SWP image</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">         &gt; meta-ambabsp  ---&gt;</div>
<div class="line">          &gt; recipes-bsp  ---&gt;</div>
<div class="line">           &gt; amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">         &gt; Ambarella Bootloader Configuration</div>
<div class="line">          &gt; AMBoot Options</div>
<div class="line">           &gt; Commoon Boot Options</div>
<div class="line">            &gt; (console=ttyS0 noinitrd rw rootfstype=ext4 init=/linuxrc rootwait dm-mod.waitfor=/dev/mmcblk0boot0 dm-mod.create=<span class="stringliteral">&quot;dm-verity,,0,ro, 0 1048576 verity 1 /dev/mmcblk0p6 /dev/mmcblk0p7 1024 4096 524288 1 sha256 8991988d265251a0d016450f3580a8f2f1a26e685d65214aff21c61df9577c20  83870773ca1164fe5a8e79a990e6281d22c74f491f2df0bb735827b2f1165bb2&quot;</span> root=/dev/dm-0) Booting cmdline</div>
<div class="line">          &gt; Firmware Options</div>
<div class="line">           &gt; Linux Partition</div>
<div class="line">            (rootfs.ext4) Linux FS image</div>
<div class="line">             &gt; Swap Partition</div>
<div class="line">              (hash_evk.img) SWP image</div>
</div><!-- fragment --><ol type="1">
<li>Compile and generate the new firmware with the <code>rootfs.ext4</code> in step 1, the hash tree stored in the SWP partition, and the signed DTB with bootargs that enable dm-verity.</li>
</ol>
<h2><a class="anchor" id="dm_verity_on_nand"></a>
3.4 Dm-verity on NAND</h2>
<p >The dm-verity feature must function with a read-only file system that runs on a block device; SquashFS is a candidate.</p>
<dl class="section note"><dt>Note</dt><dd>Dm-verity cannot support unsorted block image file system (UBIFS), as UBIFS does not run on block devices.</dd></dl>
<h3><a class="anchor" id="dm_verity_for_squashFS_with_initramfs"></a>
3.4.1 Dm-verity for SquashFS with Initramfs</h3>
<p >Using <b>initramfs</b> is straight-forward and flexible, enabling users to more-easily adjust or calculate verification arguments from Initramfs.</p>
<p ><b>Usage: </b></p><ul>
<li><code>make menuconfig_public_linux</code> and ensure that the configurations below are enabled: <div class="fragment"><div class="line">CONFIG_MTD_UBI_BLOCK=y</div>
<div class="line">CONFIG_DM_VERITY=y</div>
</div><!-- fragment --></li>
<li><code>make menuconfig</code> and ensure that the configurations below are enabled: <div class="fragment"><div class="line">LNX=$(AMB_BOARD_OUT)/rootfs/squashfs</div>
<div class="line">LNX_VIF=$(AMBOOT_TOPDIR)/vif/squashfs.info</div>
<div class="line">CONFIG_AMBARELLA_ROOTFS_SQUASHFS=y</div>
<div class="line">CONFIG_SQUASHFS_DM_VERITY=y</div>
<div class="line">CONFIG_BUILD_INITRAMFS=y</div>
<div class="line">CONFIG_INITRAMFS_DYNAMIC_BUSYBOX=y</div>
<div class="line">CONFIG_INITRAMFS_DM_TOOLS=y</div>
</div><!-- fragment --></li>
<li>Add the options below into the kernel command line (for example, bootargs in device trees (DTS)): <div class="fragment"><div class="line">console=ttyS0 ubi.mtd=lnx ubi.block=0,0 ubi.block=0,1 root=/dev/mapper/dm-root ro rootfstype=squashfs init=/linuxrc</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="dm_verity_for_squashfs_without_initramfs"></a>
3.4.2 Dm-verity for SquashFS without Initramfs</h3>
<p >Using <b>initramfs</b> may add undesirable boot time and storage requirements to the system. If the system is operating with VERY strict boot timing or storage requirements, skipping initramfs may be beneficial.</p>
<p ><b>Usage: </b></p><ul>
<li><code>make menuconfig_public_linux</code> and ensure that the configurations below are enabled: <div class="fragment"><div class="line">CONFIG_MTD_UBI_BLOCK=y</div>
<div class="line">CONFIG_DM_VERITY=y</div>
<div class="line">CONFIG_DM_INIT=y</div>
<div class="line">- `make menuconfig` and ensure that the configurations below are enabled:</div>
<div class="line">@code</div>
<div class="line">LNX=$(AMB_BOARD_OUT)/rootfs/squashfs</div>
<div class="line">LNX_VIF=$(AMBOOT_TOPDIR)/vif/squashfs.info</div>
<div class="line">CONFIG_AMBARELLA_ROOTFS_SQUASHFS=y</div>
<div class="line">CONFIG_SQUASHFS_DM_VERITY=y</div>
<div class="line">and also please disable CONFIG_BUILD_INITRAMFS</div>
</div><!-- fragment --></li>
<li>Use <code>make</code> to build the firmware. Then, users can find information related to <b>dm-verity</b> in <code>/rootfs/dm-verity.info</code></li>
<li>Add the options below into the kernel command line (for example, bootargs in DTS): <div class="fragment"><div class="line">console=ttyS0 ubi.mtd=lnx ubi.block=0,0 ubi.block=0,1 root=/dev/dm-0 rootfstype=squashfs init=/linuxrc dm-mod.create=\<span class="stringliteral">&quot;dm-root,,,ro,0 117256 verity 1 /dev/ubiblock0_0 /dev/ubiblock0_1 4096 4096 14657 1 sha256 3196082c8db1529244fa96ff7372ebbf2935fd117a925bc4b802a44265fc2864 25d2ec914df6dbe3fac237a3c08f74bd3fa35bf6fc6346359c0cf35af5162f88\&quot;</span></div>
</div><!-- fragment --> Here, "dm-mod.create" is used to pass DM table information into the kernel. Its format is as follows: <div class="fragment"><div class="line">dm-mod.create=<span class="stringliteral">&quot;&lt;name&gt;,&lt;uuid&gt;,&lt;minor&gt;,&lt;flags&gt;,[dm_table_params {dm_verity_params}]&quot;</span></div>
<div class="line">Where dm_table_params=<span class="stringliteral">&quot;&lt;start_sector&gt; &lt;num_sectors&gt; &lt;target_type&gt; &lt;dm_verity_params&gt;&quot;</span></div>
<div class="line">And dm_verity_params=<span class="stringliteral">&quot;&lt;version&gt; &lt;dev&gt; &lt;hash_dev&gt; &lt;data_block_size&gt; &lt;hash_block_size&gt; &lt;num_data_blocks&gt; \</span></div>
<div class="line"><span class="stringliteral">&lt;hash_start_block&gt; &lt;algorithm&gt; &lt;digest&gt; &lt;salt&gt; [&lt;#opt_params&gt; &lt;opt_params&gt;]&quot;</span></div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Here, Ambarella provides an example string for "dm-mod.create". User-created strings must be different from this example. All required values in <code>dm-mod.create</code> can be found in <code>/rootfs/dm-verity.info</code>.</li>
<li><code>&lt;uuid&gt;</code> and <code>&lt;minor&gt;</code> are not required, so they can be left empty.</li>
<li><code>&lt;num_sectors&gt;</code> is calculated via "Data blocks" * "Data block size" / <code>Sector_size</code>. The most common value for <code>Sector_size</code> is 512.</li>
<li>For details, refer to <code>LINUX/Documentation/admin-guide/device-mapper/dm-init.rst</code>.</li>
<li>Build the firmware again via <code>make amboot</code>.</li>
</ul>
</dd>
<dd>
Do not use <code>make</code> to rebuild the firmware in this step; otherwise, the HASH value for SquashFS will be changed. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
