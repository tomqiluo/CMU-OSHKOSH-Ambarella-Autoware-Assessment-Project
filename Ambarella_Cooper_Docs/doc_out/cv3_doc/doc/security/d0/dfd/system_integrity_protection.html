<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: Intellectual Property Protection</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/dfd/system_integrity_protection.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Intellectual Property Protection </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Pan Shi provides two major features for intellectual property protection: unit licence protection (ULP), which prevents one license from covering multiple devices, and neural network (NN) model protection (NMP), which protects the vendor’s NN model from being reverse-engineered by attackers.</p>
<h1><a class="anchor" id="ulp"></a>
1. Unit License Protection</h1>
<p >For unit license protection (ULP), the software / algorithm vendor issues a unit license to devices: the device with the unit license is able to run the vendor’s software / algorithm; however, the device without the unit license is not able to run the vendor’s software / algorithm. There are two online verification approaches: unique ID and non-forgeable unique ID. Additionally, there are two on-chip verification approaches: via the external hardware module and via AMBA on-chip verification. Online verification offers better device management, while the on-chip verification is faster and is lower cost because it does not require verification cloud service.</p>
<a class="anchor" id="unit_license_difference"></a>
<table class="doxtable">
<caption>Table 1-1. Comparisons Between Different Unit License Approaches.</caption>
<tr>
<th align="left"></th><th align="left">Unique ID</th><th align="left">Non-Forgeable Unique ID</th><th align="left">External HW Module</th><th align="left">Ambarella On-Chip Verification </th></tr>
<tr>
<th>Cost</th><td>No extra cost</td><td>No extra cost</td><td>HW module cost</td><td>No extra cost </td></tr>
<tr>
<th>Forge License</th><td>Easy (duplicate unique ID)</td><td>Difficult</td><td>Difficult</td><td>Difficult </td></tr>
<tr>
<th>Requires Online Verification</th><td>Yes</td><td>Yes</td><td>Depends on implementation</td><td>Not required </td></tr>
<tr>
<th>Verify Time Cost</th><td>Typical 500 ms – 2000 ms, varies with different networks and servers</td><td>Typical 500 ms – 2000 ms, varies with different networks and servers</td><td>Typical 20 ms – 1000 ms, varies with different hardware</td><td>CV0 3 ms or CVflow 900 ms </td></tr>
</table>
<h2><a class="anchor" id="non_forgeable_uuid"></a>
1.1 Non-Forgeable Unique ID</h2>
<p >Individual devices must possess unique IDs, and therefore require different unit licenses. If the unique ID is forgeable, the attacker is able to tamper with a batch of devices with one unique ID. The following diagram shows the problems of a forgeable, unique ID (marked in yellow on the right side).</p>
<p ><a class="anchor" id="Problems_of_Forgeable_Unique_ID"></a></p><div class="image">
<img src="../../forgeable_uuid_problem.png" alt=""/>
<div class="caption">
Figure 1-1. Problems of Forgeable Unique ID.</div></div>
<p> Vendors who choose the online verification approach must use a non-forgeable, unique ID to protect the unit license. The ULP in the Ambarella Flexible Linux Software Development Kit (SDK) supports both non-forgeable unique ID and AMBA on-chip verification.</p>
<h2><a class="anchor" id="ulp_concept"></a>
1.2 Unit License Protection Concept</h2>
<p >The software / algorithm vendor uses its private key to issue a “unit license” to each device. <br  />
 If a device has a valid unit license, then it is able to run the vendor’s software / algorithm; otherwise, the vendor’s software / algorithm is not available. Vendors can use this mechanism to charge per device unit. A device with a unit license is called an “activated device”; a device without a unit license is called a “not-activated device”.</p>
<p ><a class="anchor" id="Activated_Device_and_Not_Activated_Device"></a></p><div class="image">
<img src="../../activated_device_and_not_activated_device.png" alt=""/>
<div class="caption">
Figure 1-2. Activated Device and Not-Activated Device.</div></div>
<h2><a class="anchor" id="related_keys_and_certs"></a>
1.3 Related Keys and Certificates</h2>
<p >This section describes the keys and certificates associated with the ULP solution, followed by a table listing the format, owner, confidentiality, and storage information of the related keys and certificates.<br  />
</p><ul>
<li>The vendor license key (VLK) is an asymmetric key (ED25519). The vendor generates the VLK and must maintain confidentiality of the private VLK. The private VLK owner is able to issue a unit license; therefore, the vendor maintains the private VLK’s confidentiality. The owner is the only entity to issue the unit license. The vendor must send the public VLK to Ambarella, and Ambarella will issue a license certificate to the vendor. The public VLK is embedded inside the license certificate.<br  />
</li>
<li>The Ambarella certificate key (ACK) is an asymmetric key (ED25519). Ambarella uses the ACK to issue a license certificate for vendors.<br  />
</li>
<li>The Ambarella platform key (APK) is an asymmetric key (ED25519). The APK is used in scenarios where providing the ULP transaction is being conducted on the actual Ambarella platform, not a simulator. Note that there are two APKs: one for CVflow, and one for the CV0 library.<br  />
</li>
<li>The device identity key (DIK) is an asymmetric key (ED25519). The DIK is dynamically derived from the chip hardware’s unique information and the vendor’s license certificate; therefore, it is not statically stored on the chip. Additionally, the DIK is unique per chip: different vendors will have unique DIKs. This design prevents cross-vendor attacks and analyses.<br  />
</li>
<li>The client key is the vendor’s customer identity key; it is also asymmetric (ED25519). The vendor’s customer must keep the private client key confidential. The public client key is sent to the vendor’s license server during registration, and the vendor’s server stores it in its database.<br  />
</li>
<li>The certificate authority key is an asymmetric key (RSA or ECDSA), which is used to sign the client application (CA) certificate or the server certificates.<br  />
</li>
<li>The server key is the server’s identity key; it is also asymmetric (RSA or ECDSA). The server key proves that the server is not fake during TLS.<br  />
</li>
<li>The license certificate, which is issued by Ambarella, embeds and protects both the public VLK and the public APK. It is a binary file with a length of 256 bytes. Typically, the license certificate is distributed together with the vendor’s software package. The license certificate is required for chips that invoke ULP-related application programming interfaces (APIs).<br  />
</li>
<li>The CA certificate is the root certificate of the TLS, issued by the vendor or a third-party CA. The CA certificate is in a standard x.509 format.<br  />
</li>
<li>The server certificate is a certificate of a server that is part of the chain of trust (CoT), while the CA certificate is the root of the CoT.<br  />
</li>
<li>The device encryption key (DEK) is a symmetric key (advanced encryption standard (AES)). The DEK is dynamically derived from the chip hardware’s unique information and vendor’s license certificate; therefore, it is not statically stored on the chip. The DEK is unique per chip; some vendors will have different DEKs for the same chip. This design prevents cross-vendor attacks and analyses.<br  />
</li>
<li>The package encryption key (PEK) is a symmetric key (AES). Because the PEK is used to encrypt the neural network (NN) model, the vendor must maintain the PEK’s confidentiality.<br  />
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The DEK and PEK are only required for ‘ULP + NMP’ cases. If only the ULP case is used, users can disregard the DEK and PEK.<br  />
 The following table lists the related keys and certificates. <a class="anchor" id="related_keys_and_certs"></a>
<table class="doxtable">
<caption>Table 1-2. Related Keys and Certificates.</caption>
<tr>
<th align="left"></th><th align="left"></th><th align="left">Format</th><th align="left">Owner</th><th align="left">Keep Confidential</th><th align="left">Storage and Comment </th></tr>
<tr>
<td rowspan="2">VLK</td><td>Private</td><td rowspan="2">ED25519</td><td rowspan="2">Vendor</td><td>Yes, the vendor keeps the private VLK confidential</td><td>Stored at the vendor license server in encrypted form </td></tr>
<tr>
<td>Public</td><td><b>No</b>, the vendor sends the public VLK to Ambarella</td><td>Stored at the license certificate </td></tr>
<tr>
<td rowspan="2">ACK</td><td>Prvate</td><td rowspan="2">ED25519</td><td rowspan="2">Ambarella</td><td>Yes, Ambarella keeps the private ACK confidential</td><td></td></tr>
<tr>
<td>Public</td><td>Yes, the chip keeps the public ACK confidential</td><td></td></tr>
<tr>
<td rowspan="2">APK</td><td>Private</td><td rowspan="2">ED25519</td><td rowspan="2">Chip</td><td>Yes, the chip keeps the private APK confidential</td><td></td></tr>
<tr>
<td>Public</td><td><b>No</b>, the public APK is inside the license certificate</td><td>Stored at the license certificate </td></tr>
<tr>
<td rowspan="2">DIK</td><td>Private</td><td rowspan="2">ED25519</td><td rowspan="2">Chip</td><td>Yes, the chip keeps the private DIK confidential</td><td rowspan="2">The DIK is unique per chip. On the same chip, different vendors (different license certificates) will receive different DIKs </td></tr>
<tr>
<td>Public</td><td><b>No</b>, the public DIK is a device unique ID </td></tr>
<tr>
<td rowspan="2">Client key</td><td>Private</td><td rowspan="2">ED25519</td><td rowspan="2">Vendor’s customer</td><td>Yes, the vendor’s customer keeps the private client key confidential</td><td>Stored at the deployment tool side in encrypted form </td></tr>
<tr>
<td>Public</td><td><b>No</b>, the vendor’s customer sends the public client key to the vendor license server</td><td>Stored at the license server’s database </td></tr>
<tr>
<td rowspan="2">CA key</td><td>Private</td><td rowspan="2">RSA or ECDSA</td><td rowspan="2">Vendor or third-party CA</td><td>Yes, the vendor or third-party CA keeps the private CA key confidential </td><td></td></tr>
<tr>
<td>Public</td><td></td><td></td></tr>
<tr>
<td rowspan="2">Server key</td><td>Private</td><td rowspan="2">RSA or ECDSA</td><td rowspan="2">Vendor</td><td>Yes, the vendor keeps the private server key confidential</td><td></td></tr>
<tr>
<td>Public</td><td></td><td></td></tr>
<tr>
<td colspan="2">License certificate</td><td>Binary</td><td>Ambarella and Vendor</td><td>No, Ambarella issues a certificate to the vendor</td><td>Distributed by the vendor </td></tr>
<tr>
<td colspan="2">CA certificate</td><td>X.509</td><td>Vendor</td><td><b>No</b>, the vendor distributes its CA certificate to its customer</td><td>Stored at the vendor’s server side and the client’s deployment tool </td></tr>
<tr>
<td colspan="2">Server certificate</td><td>X.509</td><td>Vendor</td><td><b>No</b></td><td>Stored at the vendor’s server and the client’s deployment tool </td></tr>
<tr>
<td colspan="2">DEK (Optional)</td><td>AES</td><td>Chip</td><td>Yes, the chip keeps the DEK confidential</td><td>DEK is unique per chip. On the same chip, different vendors (different license certificates) will receive different DEKs </td></tr>
<tr>
<td colspan="2">PEK (Optional)</td><td>AES</td><td>Vendor</td><td>Yes, the vendor keeps the PEK confidential</td><td>Stored at the vendor’s license server in encrypted form </td></tr>
</table>
</dd></dl>
<h2><a class="anchor" id="license_deployment_process"></a>
1.4 License Deployment Process</h2>
<p >The vendor generates a VLK and uses this VLK to issue licenses via a license server. Each manufacturer (customer of the vendor) uses a deployment tool to distribute the unit license (activating devices). The manufacturer must register an account with the vendor’s approval. The vendor also specifies the number of licenses for each account (manufacturer). The connection between the manufacturer’s deployment tool and the vendor’s license server uses TLS, along with a bi-directional authentication process. This design prevents attacks from the internet. The DIK is used as a device ID; the VLK sign “public DIK + meta” is used as a unit license. If the vendor maintains confidentiality of its private VLK, then only the vendor can generate unit licenses. Because each device has a unique device ID (public DIK), each unit license applies only to a single device. </p><dl class="section note"><dt>Note</dt><dd>Engineering samples may have the same device ID, but mass-production (MP) chips have unique device IDs. Note that the unit license file is 256 bytes; therefore, the deployment process will require a writeable space to store the unit license file. The unit license file location is configurable in the <code>.lc</code> file. The product design must consider the writable space in the file system for this feature.</dd></dl>
<p><a class="anchor" id="Fig_License_Deployment_Process"></a></p><div class="image">
<img src="../../license_deployment_process.png" alt=""/>
<div class="caption">
Figure 1-3. License Deployment Process.</div></div>
<h2><a class="anchor" id="license_verification_process"></a>
1.5 License Verification Process</h2>
<p >There are two license verification methods: local verification and online verification. The Ambarella Flexible Linux SDK supports both methods, and the vendor can choose according to their requirements. While local verification is fast and does not require cloud service for the license verification, online license verification provides better management for devices.</p>
<h3><a class="anchor" id="local_license_verification_process"></a>
1.5.1 Local License Verification Process</h3>
<p >Ambarella’s CVflow / CV0 library performs a unit license check and reports the result to the vendor’s software. This license verification process does not require network access. The license verification process is as follows: “Pub ACK” -&gt; verify “license certificate” -&gt; retrieve “Pub VLK” -&gt; verify that the “unit license” is valid. The vendor’s software triggers the license verification process by invoking the related application programming interfaces (APIs). For more details on verifying license APIs, refer to <code>ambarella/security/ulp_nmp/common/platform_ cvflow.c</code> and <code>platform_cv0.c</code>.</p>
<p >The APIs are as shown below. </p><div class="fragment"><div class="line">CVflow: ioctl(thiz-&gt;fd, CAVALRY_ULP_VERIFY_LICENSE, &amp;ulp_verfiy_lic)</div>
<div class="line">CV0 Library: thiz-&gt;library.ulp_verify_license()</div>
</div><!-- fragment --><p >The CVflow / CV0 library response also includes the <code>ED25519_sign</code> (APK, challenge) and the <code>ED25519_sign</code> (DIK, challenge). The challenge is sent by the vendor’s software and is a nonce from the random number generator (RNG). The challenge includes a random nonce in order to prevent a “replay attack”. The replay attack records and reuses historic valid responses. As such, the random nonce guarantees that each challenge is different; consequently, historically valid responses cannot be reused.</p>
<h3><a class="anchor" id="non_forgable_uuid"></a>
1.5.2 Non-Forgeable Unique ID for Online Verification</h3>
<p >ULP implementation also supports online license verification. The key purpose is to provide a non-forgeable unique ID. The non-forgeable unique ID includes a random challenge, a unique ID, and an APK signature. The server generates the random challenge and verifies the APK signature in order to ensure that the unique ID has not been forged.</p>
<p ><a class="anchor" id="Non_Forgeable_Unique_ID"></a></p><div class="image">
<img src="../../non_forgeable_uuid.png" alt=""/>
<div class="caption">
Figure 1-4. Non-Forgeable Unique ID.</div></div>
<h3><a class="anchor" id="compare_with_ither_ul"></a>
1.5.3 Comparing with Other Unit License Approaches</h3>
<p >There are four approaches for unit license protection: “unique ID + online verification”; “non-forgeable unique ID + online verification”; “external hardware module”; and “AMBA chip verification”. The primary difference between a unique ID and a non-forgeable unique ID is that the non-forgeable unique ID can prevent multiple chips from being exploited with a tampered duplicated ID running on a single license. Additionally, the primary difference between the external hardware module and the Ambarella chip verification is cost. As described previously, the Ambarella Flexible Linux SDK supports two approaches: “non-forgeable unique ID + online verification” and “AMBA chip verification”. The comparison list is as follows. </p><a class="anchor" id="compare_different_ul"></a>
<table class="doxtable">
<caption>Table 1-3. Comparison Table of Different Unit License Approaches.</caption>
<tr>
<th align="left"></th><th align="left">Unique ID</th><th align="left">Non-Forgeable Unique ID</th><th align="left">External Hardware Module</th><th align="left">Ambarella Chip Verification </th></tr>
<tr>
<td>Cost</td><td>No extra cost</td><td>No extra cost</td><td>Hardware module cost</td><td>No extra cost </td></tr>
<tr>
<td>Forge license difficulty</td><td>Easy (duplicate unique ID)</td><td>Difficult</td><td>Difficult</td><td>Difficult </td></tr>
<tr>
<td>Online verification service requirement</td><td>Required</td><td>Required</td><td>Depends on the implementation</td><td>Not required </td></tr>
<tr>
<td>Speed of license verification</td><td>Depends on the network speed and the server capability</td><td>Depends on the network speed and the server capability</td><td>Fast</td><td>Fast </td></tr>
</table>
<h2><a class="anchor" id="on_chip_sw_hierarchy"></a>
1.6 On-Chip Software Hierarchy</h2>
<p >For the green-colored components shown in the following image, the Linux SDK provides sample code for the evaluation of the information maintained by the software vendor. For the blue-colored components, the SDK includes the source code.</p>
<p ><a class="anchor" id="On_Chip_Software_Hierarchy"></a></p><div class="image">
<img src="../../on_chip_sw_hierarchy.png" alt=""/>
<div class="caption">
Figure 1-5. On-Chip Software Hierarchy.</div></div>
<h2><a class="anchor" id="sw_hierarchy_on_linux_pc"></a>
1.7 Software Hierarchy on the Linux PC</h2>
<p >For the green-colored components shown below, the Linux SDK provides the sample code for the evaluation of the information maintained by the software vendor.</p>
<p ><a class="anchor" id="Software_Hierarchy_on_the_Linux_PC"></a></p><div class="image">
<img src="../../sw_hierarchy_on_linux_pc.png" alt=""/>
<div class="caption">
Figure 1-6. Software Hierarchy on the Linux PC.</div></div>
<h2><a class="anchor" id="muti_customers_support"></a>
1.8 Support for Multiple Customers</h2>
<p >With the reference code, the vendor is able to support multiple customers, and the license server manages transactions in parallel. The system diagram, showing support for multiple customers, is below.</p>
<p ><a class="anchor" id="Multiple_Customers_Support"></a></p><div class="image">
<img src="../../muti_customers_support.png" alt=""/>
<div class="caption">
Figure 1-5. System Diagram Showing Support for Multiple Customers.</div></div>
<h1><a class="anchor" id="ulp_user_guide"></a>
2. Unit License Protection User Guide</h1>
<h2><a class="anchor" id="compile_ulp_sample_code"></a>
2.1 Compile Unit License Protection Sample Code</h2>
<p >The Ambarella ULP sample code (demonstrated in the following sections) includes two parts: one part runs on the SoC, and the other runs on Linux (Ubuntu).</p>
<h3><a class="anchor" id="sample_code_on_pc"></a>
2.1.1 Compile Sample Code on the SoC</h3>
<p >Select 'menuconfig' below.</p>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">-&gt; security  ---&gt;</div>
<div class="line">-&gt; ulp-nmp (security/ulp_nmp) ---&gt;</div>
<div class="line"> -&gt; ulp-nmp (security/ulp_nmp)</div>
<div class="line">  -&gt; ULP and NMP by CVflow</div>
<div class="line">  -&gt; ULP by CV0 Library</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">-&gt; meta-ambasecurity  ---&gt;</div>
<div class="line"> -&gt; recipes-ulpnmp  ---&gt;</div>
<div class="line">  -&gt; ulpnmp (meta-ambasecurity/recipes-ulpnmp/ulpnmp)  ---&gt;</div>
<div class="line">   -&gt; ulpnmp (meta-ambasecurity/recipes-ulpnmp/ulpnmp)</div>
<div class="line">    -&gt; ULP and NMP by CVflow</div>
<div class="line">    -&gt; ULP by CV0 Library</div>
</div><!-- fragment --><p >On CV5x / CV7x / CV3 chips, “by CVflow” and “by CV0 library” can be selected simultaneously. The license deploys and verifies the unit test (<code>ulp_nmp_pt_activate</code> and <code>ulp_nmp_pt_check_license</code>), which is located under <code>/usr/local/bin/</code> on the SoC. The default option uses the default key and certificate to set up the ULP and NMP (refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#quick_launch_user_guide">2.4 Quick Launch User Guide</a>). If using the key generated by the user, “ULP use product certs” must be selected (refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#launch_from_scratch">2.2 Launch from Scratch User Guide</a>).</p>
<h3><a class="anchor" id="ulp_prerequisites"></a>
2.1.2 Prerequisites</h3>
<p >Because the sample code on Linux (Ubuntu) requires OpenSSL, install it first. The minimum-required version of OpenSSL is 1.0.2. </p><div class="fragment"><div class="line">apt-get install openssl</div>
</div><!-- fragment --><p> Generate a random seed for OpenSSL. </p><div class="fragment"><div class="line">cd ~</div>
<div class="line">openssl rand -out .rnd 1</div>
</div><!-- fragment --><h3><a class="anchor" id="sample_code_on_linux"></a>
2.1.3 Compile Sample Code on Linux (Ubuntu)</h3>
<p >Go to the source code location and compile. </p><div class="fragment"><div class="line">cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">make &amp;&amp; make install &amp;&amp; make install_configs</div>
</div><!-- fragment --><p >The servers and tools are placed in <code>/ambarella/security/build/</code>.</p>
<h2><a class="anchor" id="launch_from_scratch"></a>
2.2 Launch from Scratch User Guide</h2>
<p >Components related to ULP include the license server, the deployment tool, and the provisioning tool on the device. The following sections describe how to launch the license server and tools after compiling and installing the configurations. Users can also refer to the help file located at <code>/ambarella/security/ulp_nmp/doc/ulp_ from_scratch_steps.txt</code>.</p>
<dl class="section note"><dt>Note</dt><dd>This chapter includes key generation. Keep the private key and encryption key confidential, retain the passphrase for each key, and enable backup storage for the keys. There is no recovery option for a lost key file or forgotten passphrase.</dd></dl>
<h3><a class="anchor" id="compile_installl_config"></a>
2.2.1 Compile and Install Configurations</h3>
<p >Go to the source code location, compile, and install. </p><div class="fragment"><div class="line">build $ cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">build $ make &amp;&amp; make install &amp;&amp; make install_configs</div>
</div><!-- fragment --><h2><a class="anchor" id="launch_license_server"></a>
2.2.2 Launch the License Server</h2>
<p >Go to the license sever location. </p><div class="fragment"><div class="line">build $</div>
<div class="line">cd $(SDK)/ambarella/security/build/ulp_nmp_license_server/</div>
</div><!-- fragment --><p ><b>First-Time Setup</b><br  />
 The license server requires some prerequisites: the CA key and certificate, the server key and certificate, the vendor license key and certificate, the package encryption key, and so on. The “first time setup” steps show how to generate or get those prerequisites. Typically,“first time setup” must be performed only once because it generates new keys and replaces existing keys. If the key file is replaced, there is no way to recover it. Users must be very cautious when executing those command lines; only do so when necessary. </p><dl class="section note"><dt>Note</dt><dd>Before generating keys, change the key passphrases <code>-pass pass:1234</code> and <code>--passphrase 1234</code> for the following command lines. <code>1234</code> is the default passphrase for test purposes only; <b>DO NOT</b> use it in production.</dd></dl>
<ol type="1">
<li>Generate a CA key and a CA certificate. <div class="fragment"><div class="line">build $ openssl genpkey -algorithm RSA -out ./keys/priv_ca.pem -pkeyopt rsa_keygen_bits:2048 -pkeyopt rsa_keygen_pubexp:65537 -pass pass:1234 -aes-256-cbc</div>
<div class="line">build $ openssl req -<span class="keyword">new</span> -x509 -days 3650 -key ./keys/priv_ca.pem -out ./certs/ca.crt -subj <span class="stringliteral">&quot;/C=CN/ST=SH/L=PD/O=test/OU=test/CN=testCA/emailAddress=ca@test.com&quot;</span></div>
</div><!-- fragment --></li>
<li>Generate a server key and issue a server certificate. <div class="fragment"><div class="line">build $ openssl genpkey -algorithm RSA -out ./keys/priv_svr.pem -pkeyopt rsa_keygen_bits:2048 -pkeyopt rsa_keygen_pubexp:65537 -pass pass:1234 -aes-256-cbc build $ openssl req -<span class="keyword">new</span> -key ./keys/priv_svr.pem -out server.csr -subj /C=CN/ST=SH/L=PD/O=test/OU=test/CN=testSVR/emailAddress=svr@test.com</div>
<div class="line">build $ openssl x509 -req -days 3650 -CA ./certs/ca.crt -CAkey ./keys/priv_ca.pem -CAserial ca.srl -CAcreateserial -in server.csr -out ./certs/server.crt</div>
</div><!-- fragment --></li>
<li>Generate the VLK. <div class="fragment"><div class="line">build $ ../ulp_nmp_key_tool/ulp_nmp_key_tool --gen-ed25519 vlk --path ./keys/ --passphrase 1234</div>
</div><!-- fragment --></li>
<li>Generate the PEK. This step is only necessary when it is combined with NMP; otherwise, it can be skipped. <div class="fragment"><div class="line">build $ ../ulp_nmp_key_tool/ulp_nmp_key_tool --gen-aesctr pek --path ./keys/ --passphrase 1234</div>
</div><!-- fragment --></li>
<li>Send the public VLK to Ambarella, and get the license certificate from Ambarella. Note that “by CVflow” and “by CV0 library” are different certificate files.</li>
<li>Copy the license certificate to <code>product_certs/</code>.</li>
</ol>
<p >By CVflow: </p><div class="fragment"><div class="line">build $ cp license_cert.bin ./certs/</div>
</div><!-- fragment --><p >By CV0: </p><div class="fragment"><div class="line">build $ cp license_cert_cv0.bin ./certs/</div>
</div><!-- fragment --><ol type="1">
<li>Copy the license certificate file for the device. <div class="fragment"><div class="line">build $ cp ./certs/ ../ulp_nmp_simulate_device –rf</div>
</div><!-- fragment --></li>
</ol>
<p ><b>Launch the License Server</b><br  />
 When the prerequisites are ready, the command line below will launch a license server. Choose <code>ulp_license_svr_cvflow.lc</code> or <code>ulp_license_svr_cv0.lc</code> accordingly, as they use different certificate files.</p>
<p >By CVflow: </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_license_svr_cvflow.lc</div>
</div><!-- fragment --><p >By CV0 library: </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_license_svr_cv0.lc</div>
</div><!-- fragment --><p >After entering the correct passphrases for “private server key,” “private VLK key,” and “PEK,” the server is running and the console displays the following information: </p><div class="fragment"><div class="line">load lc config (lc_configs/ulp_license_svr_xxx.lc) done</div>
<div class="line">NN Model Protection Disabled</div>
<div class="line">Check pre-requirement done</div>
<div class="line">initialize_db (db path: db, total license file: total_license_num.txt) done</div>
<div class="line"> * new_ssl_server_ctx done</div>
<div class="line">Enter PEM pass phrase:</div>
<div class="line">server_set_ca_cert_key done</div>
<div class="line">load_license_cert done</div>
<div class="line">Enter private VLK&#39;s passphrase:</div>
<div class="line">verify shadow done</div>
<div class="line">decrypt vlk priv done</div>
<div class="line">get vlk pub done</div>
<div class="line">store vlk pub done</div>
<div class="line">load_priv_vlk_enc done</div>
<div class="line">open and listen 19000 ...</div>
<div class="line">open and listen 19000 done</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The highlighted portions are the prompts for users to enter the default passphrase “1234.” Users must immediately change the default passphrase to a more secure passphrase, as “1234” is used for test purposes only.</dd></dl>
<h3><a class="anchor" id="launch_deployment_tool"></a>
2.2.3 Launch the Deployment Tool</h3>
<p >Go to the following location to find the deployment tool. </p><div class="fragment"><div class="line">build $</div>
<div class="line">cd $(SDK)/ambarella/security/build/ulp_nmp_deployment_tool</div>
</div><!-- fragment --><p ><b>First-Time Setup</b><br  />
 The deployment tool requires the following prerequisites: the CA certificate, the public vendor license key, and the account key. The “first-time setup” steps show how to generate or obtain the prerequisites. Typically, “first-time setup” is required only once. However, because the setup process generates keys and replaces existing keys, users must execute command lines with caution, and only when necessary, as the key file is not recoverable.</p>
<dl class="section note"><dt>Note</dt><dd>Before generating keys, change the passphrases “-pass pass:1234” and “&ndash;passphrase 1234” for the following command lines. “1234” is the default passphrase for test purposes only; DO NOT use it in production.</dd></dl>
<ol type="1">
<li>Obtain the CA certificate and the public VLK from the vendor. <div class="fragment"><div class="line">build $ cp ca.crt ./certs/</div>
<div class="line">build $ cp pub_vlk.bin ./keys/</div>
</div><!-- fragment --></li>
<li>Generate the client key for the account. <div class="fragment"><div class="line">build $ ../ulp_nmp_key_tool/ulp_nmp_key_tool --gen-ed25519 cli --path ./keys/ --passphrase 1234</div>
</div><!-- fragment --></li>
</ol>
<p ><b>Launch the Deployment Tool</b><br  />
 When the prerequisites are ready, the command line below will launch the deployment tool.</p>
<dl class="section note"><dt>Note</dt><dd>Users must specify the correct license server IP address and port in <code>ulp_nmp_deployment_tool.lc</code>. The deployment tool then prompts users to enter the client’s private key passphrase. This key is the identity key for the client (vendor’s customer). <div class="fragment"><div class="line">new_ssl_client_ctx done</div>
<div class="line">load vlk done</div>
<div class="line">Enter cli priv<span class="stringliteral">&#39;s passphrase:</span></div>
</div><!-- fragment --></dd></dl>
<p>After entering the private key’s passphrase (<b>“1234” + ENTER</b>), the deployment tool runs, and the console displays the following information: </p><div class="fragment"><div class="line">verify shadow done</div>
<div class="line">decrypt cli priv done</div>
<div class="line">get cli pub done</div>
<div class="line">store cli pub done</div>
<div class="line">load cli done</div>
<div class="line">Connecting to localhost:19000 ...</div>
<div class="line">Connect to localhost:19000 done</div>
<div class="line">[Handshake]: check protocol version done</div>
<div class="line"> </div>
<div class="line">[Authenticate]: challenge to peer</div>
<div class="line">0x0f, 0xd5, 0xd4, 0x04, 0x70, 0x48, 0x06, 0x6e,</div>
<div class="line">0x55, 0xbc, 0x8a, 0xf4, 0x91, 0x26, 0x34, 0xe5,</div>
<div class="line">0xda, 0xd8, 0xa2, 0x10, 0x1b, 0xee, 0x35, 0x90,</div>
<div class="line">0x94, 0x23, 0x9f, 0xbc, 0xc1, 0xbc, 0x91, 0x7f,</div>
<div class="line">[Authenticate]: response from peer</div>
<div class="line">0xea, 0x41, 0xe7, 0x06, 0x65, 0xee, 0x0b, 0xc1,</div>
<div class="line">0xf5, 0xf0, 0xd3, 0x94, 0x7c, 0x19, 0x56, 0x97,</div>
<div class="line">0xc8, 0x31, 0xf3, 0xf7, 0x1c, 0xc8, 0x9a, 0x6e,</div>
<div class="line">0xd1, 0x7a, 0xc4, 0x80, 0x7f, 0x81, 0xd8, 0x90,</div>
<div class="line">0xfa, 0xb6, 0x6f, 0x89, 0x76, 0x1b, 0x3f, 0xae,</div>
<div class="line">0xcb, 0x13, 0x5c, 0x39, 0x5e, 0xcf, 0xbc, 0xe5,</div>
<div class="line">0x00, 0xaa, 0x4c, 0xe0, 0xf2, 0x61, 0xe1, 0xa7,</div>
<div class="line">0x70, 0xe2, 0xdb, 0x25, 0x43, 0x84, 0x64, 0x08,</div>
<div class="line">[Authenticate]: client authenticate server done</div>
<div class="line"> </div>
<div class="line">login: amba_test</div>
</div><!-- fragment --><p >The login prompt is displayed. If the account is unregistered, users must register it. There are two approaches to registering an account: manual and interactive. For the manual approach, users send the “account name” and “public account key file” to the server side and wait for the server side’s approval. For more details regarding manual approval on the server side, refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#Approve_an_Account_Manually">Approve_an_Account_Manually</a>. For the interactive approach, see the information below. For more details regarding interactive approval on the server side, refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#Approve_an_Account_Interactively">Approve_an_Account_Interactively</a>. Users must type <b>“y + ENTER”</b> to post a registration request to the server.</p>
<div class="fragment"><div class="line">[Register]: (zhe) is not in account list, <span class="keyword">register</span> (<span class="charliteral">&#39;y&#39;</span> or <span class="charliteral">&#39;Y&#39;</span>)? or re-enter username to login again (<span class="charliteral">&#39;l&#39;</span> or <span class="charliteral">&#39;L&#39;</span>)?</div>
</div><!-- fragment --><p >Next, users must wait for approval from the server side. The server side also specifies the total number of licenses for this account. After approval, the console outputs the log, as shown below, including the total number of licenses. The deployment tool is now ready to activate the device.</p>
<div class="fragment"><div class="line">[Register]: <span class="keyword">register</span> done</div>
<div class="line">[Handshake]: login done</div>
<div class="line"> </div>
<div class="line">[Authenticate]: challenge from peer</div>
<div class="line">0x8a, 0xf5, 0x11, 0xeb, 0xf7, 0x8e, 0x36, 0x2a,</div>
<div class="line">0x82, 0x36, 0x21, 0x5f, 0xa2, 0xe2, 0x94, 0x97,</div>
<div class="line">0x28, 0x9e, 0xaa, 0x03, 0x37, 0xeb, 0xaa, 0x81,</div>
<div class="line">0x5e, 0x8e, 0xc7, 0x69, 0x85, 0xd0, 0xb6, 0x92,</div>
<div class="line">[Authenticate]: response to peer</div>
<div class="line">0xdc, 0x77, 0xb5, 0x9c, 0x63, 0x96, 0x88, 0xfc,</div>
<div class="line">0x1a, 0x94, 0x2b, 0x99, 0xdb, 0xa3, 0xf7, 0x39,</div>
<div class="line">0x7f, 0xc8, 0xac, 0x97, 0xb0, 0x50, 0x22, 0x6b,</div>
<div class="line">0x23, 0x33, 0x60, 0xd9, 0x40, 0xbd, 0x77, 0xdc,</div>
<div class="line">0x7e, 0x9a, 0x00, 0x40, 0xc3, 0x7f, 0xa5, 0x68,</div>
<div class="line">0x7a, 0xc7, 0x30, 0xe4, 0x65, 0xab, 0x1a, 0xb5,</div>
<div class="line">0xc2, 0x38, 0xcf, 0x6f, 0x27, 0x29, 0x88, 0x39,</div>
<div class="line">0xfd, 0x07, 0xaf, 0xba, 0x54, 0xa6, 0xb0, 0x0a,</div>
<div class="line">[Handshake]: server authenticate client done</div>
<div class="line">receive license number: 1000</div>
<div class="line">0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe8,</div>
<div class="line">NN model protection is available</div>
</div><!-- fragment --><h3><a class="anchor" id="approve_account"></a>
2.2.4 Approve an Account</h3>
<p >There are two approaches to approve an account: interactive and manual.</p>
<p ><b>Approve an Account Interactively</b><br  />
 </p><div class="fragment"><div class="line">[Login]: user_name (amba_test)</div>
<div class="line">[Login]: user account does NOT exist</div>
<div class="line"> </div>
<div class="line">[Register]: <span class="keyword">new</span> user (amba_test), approve(<span class="charliteral">&#39;y&#39;</span> or <span class="charliteral">&#39;Y&#39;</span>) or not?</div>
</div><!-- fragment --><p >Type <b>“y + ENTER”</b> to approve. Next, specify the “granted license number” and the “metadata index” for this account to complete registration. The console displays this account’s settings, as shown below.</p>
<div class="fragment"><div class="line">[Register]: grant number of license <span class="keywordflow">for</span> <span class="keyword">new</span> user (amba_test):</div>
<div class="line">1000</div>
<div class="line">[Register]: granted license number: 1000</div>
<div class="line">[Register]: specify metadata index for new user (amba_test):</div>
<div class="line">0</div>
<div class="line">[Register]: specified metadata index: 0</div>
<div class="line">[Register]: add user (amba_test) into db done</div>
<div class="line">[Register]: send status code done</div>
</div><!-- fragment --><p ><a class="anchor" id="Approve_an_Account_Interactively"></a><b>Approve an Account Interactively</b><br  />
</p>
<p >After a new account is registered on the server side, the following prompt appears: </p><div class="fragment"><div class="line">[Login]: user_name (amba_test)</div>
<div class="line">[Login]: user account does NOT exist</div>
<div class="line"> </div>
<div class="line">[Register]: <span class="keyword">new</span> user (amba_test), approve(<span class="charliteral">&#39;y&#39;</span> or <span class="charliteral">&#39;Y&#39;</span>) or not?</div>
</div><!-- fragment --><p >Type “y + ENTER” to approve. Next, specify the “granted license number” and the “metadata index” for this account to complete registration. The console will display this account’s settings, as follows.</p>
<div class="fragment"><div class="line">[Register]: grant number of license <span class="keywordflow">for</span> <span class="keyword">new</span> user (amba_test):</div>
<div class="line">1000</div>
<div class="line">[Register]: granted license number: 1000</div>
<div class="line">[Register]: specify metadata index for new user (amba_test):</div>
<div class="line">0</div>
<div class="line">[Register]: specified metadata index: 0</div>
<div class="line">[Register]: add user (amba_test) into db done</div>
<div class="line">[Register]: send status code done</div>
</div><!-- fragment --><p ><a class="anchor" id="Approve_an_Account_Manually"></a><b>Approve an Account Manually</b><br  />
</p>
<ol type="1">
<li>Go to the database directory of the license server. <div class="fragment"><div class="line">build $</div>
<div class="line">cd $(SDK)/ambarella/security/build/ulp_nmp_license_server/db/</div>
</div><!-- fragment --></li>
<li>Create a new <code>dir</code>. The <code>.dir</code> name is the account name. <div class="fragment"><div class="line">build $ mkdir zhe</div>
</div><!-- fragment --></li>
<li>Copy the account’s public key file to this folder. Then, create two new text files: one is for the total license number (<code>total_license_num.txt</code>), and the other for the metadata index (<code>metadata_ index.txt</code>). The files are as shown below. <div class="fragment"><div class="line">-rw-rw-r-- 1 zhe zhe    1 7月   8 19:35 metadata_index.txt</div>
<div class="line">-rw-rw-r-- 1 zhe zhe   32 7月   8 19:35 pub_cli.bin</div>
<div class="line">-rw-rw-r-- 1 zhe zhe    5 7月   8 19:35 total_license_num.txt</div>
</div><!-- fragment --></li>
</ol>
<p >Those two text files contain one digital number, so the user can edit the number as required. For example, <code>total_license_num.txt</code> has a digital number of 10000, and <code>metadata_index.txt</code> has a digital number of 0. After this process is complete, restart the license server program.</p>
<h3><a class="anchor" id="run_provision_tool_to_deploy_license"></a>
2.2.5 Run the Provisioning Tool to Deploy the License</h3>
<p >By default, the IP address of the device is 10.0.0.2. Once <code>ulp_nmp_pt_activate</code> is running, the deployment tool connects to it via <code>device_url:device_port</code> in the <code>.lc</code> file. To prepare for the running of the provisioning tool (PT), users must copy <code>ambarella/security/build/ulp_nmp_simulate_device</code> to <code>DEVICE_PATH</code>. Then, the provisioning tool can run on the device.</p>
<p ><b>PT Tool by CVflow</b> </p><div class="fragment"><div class="line">init.sh --na</div>
<div class="line">modprobe cavalry</div>
<div class="line">cavalry_load -f /lib/firmware/cavalry.bin -r</div>
<div class="line">test_encode --idle  --nopreview</div>
<div class="line">ulp_nmp_pt_activate $(DEVICE_PATH)/lc_configs/pt_cvflow.lc</div>
</div><!-- fragment --><p> After activation, <code>pub_dik_cvflow.bin</code> and <code>unit_license_cvflow.bin</code> are generated. For this chip, <code>unit_license_cvflow.bin</code> is the unit license.</p>
<p ><b>PT Tool by CV0 Library</b> </p><div class="fragment"><div class="line">init.sh --na</div>
<div class="line">test_encode --idle --nopreview</div>
<div class="line">ulp_nmp_pt_activate $(DEVICE_PATH)/lc_configs/pt_cv0.lc</div>
</div><!-- fragment --><p >After activation, <code>pub_dik_cv0.bin</code> and <code>unit_license_cv0.bin</code> are generated. For this chip, <code>unit_license_cv0.bin</code> is the unit license.</p>
<h2><a class="anchor" id="run_sample_code_to_check_license"></a>
2.3 Run Sample Code to Check the License</h2>
<p >To prepare for the running of the provisioning tool, users must copy <code>ambarella/security/build/ulp_nmp_simulate_device</code> to <code>DEVICE_PATH</code>. Then, the provisioning tool can run on the device.</p>
<p ><b>PT Tool by CVflow</b> </p><div class="fragment"><div class="line">init.sh --na</div>
<div class="line">modprobe cavalry</div>
<div class="line">cavalry_load -f /lib/firmware/cavalry.bin -r</div>
<div class="line">test_encode --idle --nopreview</div>
<div class="line">ulp_nmp_pt_check_license $(DEVICE_PATH)/lc_configs/pt_cvflow.lc</div>
</div><!-- fragment --><p> <code>ulp_nmp_pt_check_license</code> reports the check license result.</p>
<p ><b>PT Tool by CV0 Library</b> </p><div class="fragment"><div class="line">init.sh --na</div>
<div class="line">test_encode --idle --nopreview</div>
<div class="line">ulp_nmp_pt_check_license $(DEVICE_PATH)/lc_configs/pt_cv0.lc</div>
<div class="line">init.sh --na</div>
<div class="line">test_encode --idle --nopreview</div>
<div class="line">ulp_nmp_pt_check_license $(DEVICE_PATH)/lc_configs/pt_cv0.lc</div>
</div><!-- fragment --><p> <code>ulp_nmp_pt_check_license</code> reports the check license result.</p>
<dl class="section note"><dt>Note</dt><dd>The software vendor must integrate this check code into the software. The function call (thiz-&gt;platform.verify_license) checks the Cvflow- / CV0 library-returned response and checks the response’s signatures. Note that the random challenge is created by an RNG so as to prevent a replay attack.</dd></dl>
<h2><a class="anchor" id="quick_launch_user_guide"></a>
2.4 Quick Launch User Guide</h2>
<p >ULP-related components include the license server, the deployment tool, and the provisioning tools on the device. The following sections describe how to proceed with setting up and using the pre-set test files. Users can also refer to the help file located at <code>/ambarella/security/ulp_nmp/doc/ulp_quick_launch_steps.txt</code>.</p>
<dl class="section note"><dt>Note</dt><dd>The process in this chapter copies the pre-set keys and certificates to the <code>server/deployment_tool/provisioning_tool</code> location; therefore, it will replace the existing keys and certificates. If those existing keys and certificates are required, back them up first. Otherwise, those replaced keys and certificates will be lost.</dd></dl>
<h3><a class="anchor" id="compille_and_install_pre_set_test_fille"></a>
2.4.1 Compile and Install the Pre-Set Test Files</h3>
<p >Go to the source code location, compile it, and install it together with the pre-set test files. </p><div class="fragment"><div class="line">build $ cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">build $ make &amp;&amp; make install</div>
<div class="line">build $ make install_preset_test_files</div>
</div><!-- fragment --><h3><a class="anchor" id="launch_license_server"></a>
2.2.2 Launch the License Server</h3>
<p >Go to the license server’s location and launch the server. </p><div class="fragment"><div class="line">build $</div>
<div class="line">cd $(SDK)/ambarella/security/build/ulp_nmp_license_server/</div>
</div><!-- fragment --><p >By CVflow: </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_license_svr_cvflow.lc</div>
</div><!-- fragment --><p >By CV0 library: </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_license_svr_cv0.lc</div>
</div><!-- fragment --><p >After entering the correct passphrases for the private server key, the private VLK key, and PEK, the server begins running.</p>
<h3><a class="anchor" id="launch_dev_tool"></a>
2.4.3 Launch the Deployment Tool</h3>
<p >Go to the following location to launch the deployment tool. </p><div class="fragment"><div class="line">build $ cd ambarella/security/build/ulp_nmp_deployment_tool/</div>
<div class="line">build $ ./ulp_nmp_deployment_tool lc_configs/ulp_nmp_deployment_tool.lc</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Users must specify the correct license server IP address and port in <code>ulp_nmp_deployment_tool.lc</code>.</dd></dl>
<p>The deployment tool then prompts the user to enter the client’s private key passphrase. This key is the identity key for clients (vendor’s customer). </p><div class="fragment"><div class="line">new_ssl_client_ctx done</div>
<div class="line">load vlk done</div>
<div class="line">Enter cli priv<span class="stringliteral">&#39;s passphrase:</span></div>
</div><!-- fragment --><p >After entering the private key’s passphrase (<b>“1234 + ENTER”</b>), the deployment tool begins.</p>
<h3><a class="anchor" id="approve_account"></a>
2.2.4 Approve an Account</h3>
<p >There are two approaches for approving an account: interactive and manual.</p>
<p ><a class="anchor" id="Approve_Account_Interactively"></a><b>Approve an Account Interactively</b><br  />
</p>
<p >After a new account is registered on the server side, the following prompt appears: </p><div class="fragment"><div class="line">[Login]: user_name (amba_test)</div>
<div class="line">[Login]: user account does NOT exist</div>
<div class="line"> </div>
<div class="line">[Register]: <span class="keyword">new</span> user (amba_test), approve(<span class="charliteral">&#39;y&#39;</span> or <span class="charliteral">&#39;Y&#39;</span>) or not?</div>
</div><!-- fragment --><p >Type <b>“y + ENTER”</b> to approve. Next, specify the granted license number and the metadata index in order for this account to complete the registration. The console will display this account’s settings, as shown below.</p>
<div class="fragment"><div class="line">[Register]: grant number of license <span class="keywordflow">for</span> <span class="keyword">new</span> user (amba_test):</div>
<div class="line">1000</div>
<div class="line">[Register]: granted license number: 1000</div>
<div class="line">[Register]: specify metadata index for new user (amba_test):</div>
<div class="line">0</div>
<div class="line">[Register]: specified metadata index: 0</div>
<div class="line">[Register]: add user (amba_test) into db done</div>
<div class="line">[Register]: send status code done</div>
</div><!-- fragment --><p ><a class="anchor" id="Approve_Account_Manually"></a><b>Approve an Account Manually</b><br  />
</p>
<p >Go to the database directory of the license server. </p><div class="fragment"><div class="line">build $</div>
<div class="line">cd $(SDK)/ambarella/security/build/ulp_nmp_license_server/db/</div>
</div><!-- fragment --><p> Make a new dir. The dir name is the account name. </p><div class="fragment"><div class="line">build $ mkdir amba_test</div>
</div><!-- fragment --><p >Copy the account’s public key file to this folder and create two new text files: one is for the total license number <code>total_license_num.txt</code> , and the other is for the metadata index <code>metadata_index.txt</code>. The files are as shown below. -rw-rw-r&ndash; 1 amba_test amba_test 1 JUN 8 19:35 metadata_index.txt -rw-rw-r&ndash; 1 amba_test amba_test 32 JUN 8 19:35 pub_cli.bin -rw-rw-r&ndash; 1 amba_test amba_test 5 JUN 8 19:35 total_license_num.txt</p>
<p >Those two text files only contain one digital number, so the user can edit the number as required. For example, <code>total_license_num.txt</code> has a digital number of 10000 and <code>metadata_index.txt</code> has a digital number of 0.</p>
<h3><a class="anchor" id="run_provision_tool_to_deplloy_license"></a>
2.4.5 Run the Provisioning Tool to Deploy the License</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#run_provision_tool_to_deploy_license">2.2.5 Run the Provisioning Tool to Deploy the License</a> for more information.</p>
<h3><a class="anchor" id="run_sample_code_to_check_the_license"></a>
2.4.6 Run the Sample Code to Check the License</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#run_sample_code_to_check_license">2.3 Run Sample Code to Check the License</a> for more information.</p>
<h2><a class="anchor" id="config_for_programs_and_database"></a>
2.5 Configurations for Programs and the Database</h2>
<h3><a class="anchor" id="license_server_config"></a>
2.5.1 License Server Configuration</h3>
<p >The location of the configuration file for the license server is as follows: <code>/ambarella/security/ulp_nmp/license_server/lc_configs/ulp_license_svr_cvflow.lc</code> or <code>ulp_license_svr_cv0.lc</code></p>
<div class="fragment"><div class="line">ULP_NMP_LicenseServer</div>
<div class="line"> Config</div>
<div class="line">  nn_model_protection = 0</div>
<div class="line">  debug_log = 1</div>
<div class="line">  listen_port = 19000</div>
<div class="line">  db_path = db</div>
<div class="line">  priv_ca_pem = ./keys/priv_ca.pem</div>
<div class="line">  ca_crt = ./certs/ca.crt</div>
<div class="line">  server_crt = ./certs/server.crt</div>
<div class="line">  priv_svr_pem = ./keys/priv_svr.pem</div>
<div class="line">  pub_cli_bin = pub_cli.bin</div>
<div class="line">  cli_total_license_num = total_license_num.txt</div>
<div class="line">  cli_metadata_index = metadata_index.txt</div>
<div class="line">  priv_vlk_enc = ./keys/priv_vlk_enc.bin</div>
<div class="line">  priv_vlk_enc_shadow = ./keys/priv_vlk_enc.shadow</div>
<div class="line">  pub_vlk = ./keys/pub_vlk.bin</div>
<div class="line">  license_cert = ./certs/license_cert.bin</div>
</div><!-- fragment --><p >The following describes each field:</p><ul>
<li>nn_model_protection: NMP is enabled or disabled. If users only require a per-unit license, this field is disabled</li>
<li>debug_log: if set to 1, it will print the debug information</li>
<li>listen_port: the listening TCP port</li>
<li>db_path: the database path</li>
<li>priv_ca_pem: the CA private key that signs the CA certificate</li>
<li>ca_crt: the CA certificate, in X509 format. The CA certificate is the root certificate of a CoT</li>
<li>server_crt: the server certificate, in X509 format. The server certificate is signed by the CA</li>
<li>priv_svr_pem: the server private key. The server’s public key is inside the server certificate</li>
<li>pub_cli_bin: each client’s (account) public key file name in the database</li>
<li>cli_total_license_num: each client’s (account) license total number file name in the database</li>
<li>cli_metadata_index: each client’s (account) metadata index file name in the database</li>
<li>priv_vlk_enc: the private VLK file in encrypted form</li>
<li>priv_vlk_enc_shadow: the private VLK file’s passphrase shadow file</li>
<li>pub_vlk: the public VLK file</li>
<li>license_cert: the license certificate from Ambarella in binary format</li>
</ul>
<h3><a class="anchor" id="deployment_tool_config"></a>
2.5.2 Deployment Tool Configuration</h3>
<p >The location of the configuration file for the license server is <code>/ambarella/security/ulp_nmp/deployment_tool/lc_configs/ulp_nmp_deployment_tool.lc</code>.</p>
<div class="fragment"><div class="line">ULP_NMP_DeploymentTool</div>
<div class="line"> Config</div>
<div class="line">  debug_log = 1</div>
<div class="line">  remote_url = localhost</div>
<div class="line">  remote_port = 19000</div>
<div class="line">  device_url = 10.0.0.2</div>
<div class="line">  device_port = 9292</div>
<div class="line">  ca_crt = ./certs/ca.crt</div>
<div class="line">  pub_vlk = ./keys/pub_vlk.bin</div>
<div class="line">  priv_cli_enc_bin = ./keys/priv_cli_enc.bin</div>
<div class="line">  pub_cli_bin = ./keys/pub_cli.bin</div>
</div><!-- fragment --><p >The following describes each field.</p><ul>
<li>debug_log: if set to 1, it will print the debug information</li>
<li>remote_url: the license server’s URL or IP address</li>
<li>remote_port: the license server’s TCP port</li>
<li>device_url: the device’s IP address</li>
<li>device_port: the device’s TCP port</li>
<li>ca_crt: the CA certificate, in X509 format. The CA certificate includes a CA’s public key</li>
<li>pub_vlk: the public VLK key</li>
<li>priv_cli_enc_bin: the client’s (account) private key in encrypted form</li>
<li>pub_cli_bin: the client’s (account) public key</li>
</ul>
<h3><a class="anchor" id="provisioning_tool_config"></a>
2.5.3 Provisioning Tool Configuration</h3>
<p >The provisioning tool includes <code>ulp_nmp_pt_activate</code> and <code>ulp_nmp_pt_check_license</code>. The location of the configuration file for the provisioning tool is <code>/ambarella/security/ulp_nmp/provisioning_tool/lc_configs/pt_cvflow.lc</code> or <code>pt_cv0.lc</code>.</p>
<div class="fragment"><div class="line">ULP_NMP_ProvisioningTool</div>
<div class="line"> Config</div>
<div class="line">  debug_log = 1</div>
<div class="line">  listen_port = 9292</div>
<div class="line">  license_cert = license_cert.bin</div>
<div class="line">  platform = cvflow</div>
<div class="line">  unique_id_file = cavalry_pub_dik.bin</div>
<div class="line">  unit_license_file = unit_license_cavalry.bin</div>
<div class="line">  dek_encrypt_pek_file = dev_encrypt_pek.bin</div>
<div class="line">  digest_file = dev_encrypt_pek.digest</div>
</div><!-- fragment --><p >The following describes each field:</p><ul>
<li>debug_log: if set to 1, it will print the debug information</li>
<li>listen_port: the device’s listening port (TCP)</li>
<li>license_cert: the license certificate</li>
<li>platform: CVflow or CV0; this is the field to choose from the CVflow or CV0 library approach</li>
<li>unique_id_file: the unique ID file</li>
<li>unit_license_file: the unit license file</li>
<li>dek_encrypt_pek_file: the DEK encrypt PEK file</li>
<li>digest_file: the digest file</li>
</ul>
<h3><a class="anchor" id="database_config"></a>
2.5.4 Database Configuration</h3>
<p >By default, the database path is under the server’s directory: <code>/ambarella/security/ build/ulp_nmp_license_server/db</code>.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Under the database, the first level subdirectory is an account.</li>
<li>Each account’s subdirectory includes three files: <code>pub_cli.bin</code>, <code>metadata_index.txt</code>, and <code>total_license_num.txt</code>.</li>
<li>Users can check and edit the total license number and metadata index for each account.</li>
<li>In addition to the online register / approve account, creating the subdirectory and then placing those three files has the same function as the register / approve account.</li>
<li>When the account starts to activate devices, the account’s subdirectory records each activated device’s information: the unique ID and the unit license file. Those files are located in the subdirectory of the unique ID.</li>
</ul>
</dd></dl>
<h3><a class="anchor" id="metadata"></a>
2.5.5 Metadata</h3>
<p >The license is a signature of the “unique_id + metadata”. Metadata is managed by the software vendor; the vendor is able to embed the information into the license as required. Additionally, the license server supports multiple metadata types, so the software vendor is able to apply various types of metadata for different customers. Typically, metadata is used by the vendor to identify the unit license’s capability. Different price points receive different services. It is easy for vendors to modify the metadata definition in the source code; check <code>metadata.c</code> at the license server. The <code>metadata.c</code> is a reference implementation of eight metadata.</p>
<h2><a class="anchor" id="offline_issuer"></a>
2.6 Offline Issuer</h2>
<p >If users are not required to use the license server to distribute (issue) a license, they can issue a license manually using an offline approach. For additional help, refer to <code>/ambarella/security/ulp_nmp/doc/ offline_issuer_steps.txt</code>.</p>
<p >Go to the offline issuer location: </p><div class="fragment"><div class="line">build $ cd ambarella/security/build/ulp_nmp_license_server/</div>
</div><!-- fragment --><p >Offline issuer command: </p><div class="fragment"><div class="line">build $ ./ulp_nmp_offline_issuer lc_configs/ulp_nmp_license_svr.lc &lt;uid_file&gt; &lt;meta index&gt; &lt;unit license file&gt;</div>
</div><!-- fragment --><p >The parameters of the <code>ulp_nmp_offline_issuer</code> are described below:</p><ul>
<li>&lt;uid_file&gt;: the <code>cavalry_pub_dik.bin</code> from the target device (chip)</li>
<li>&lt;meta index&gt;: the index of the metadata</li>
<li>&lt;unit license file&gt;: the unit license file to issue a license for the device</li>
</ul>
<p >The process is as follows:</p><ol type="1">
<li>Obtain pub_dik_cvflow.bin or public_dik_cv0 from the target device (chip).</li>
<li>Use the offline tool to generate the license manually.</li>
<li>Deploy the license file to the device (unit_license_cvflow.bin or unit_license_cv0.bin)</li>
</ol>
<h1><a class="anchor" id="neural_network_model_protection"></a>
3. Neural Network Model Protection</h1>
<p >NMP protects NN models on Ambarella chips. The NN model in NAND and in memory are in encrypted forms. When enabling NMP, CVflow loads the encrypted model, decrypts it, and then executes it. There is a secure channel for the vendor server to transfer the model’s encryption key to CVflow in the deployment stage. CVflow re-encrypts the model key and stores it in NAND.</p>
<h2><a class="anchor" id="NN_model_protection"></a>
3.1 NN Model Protection</h2>
<p >The NN model exists in encrypted form on the Linux side. Then, when it is loaded into CVflow, it is decrypted and executed. <a class="anchor" id="NN_Model_Protection_Concept"></a></p><div class="image">
<img src="../../nn_model_protection_concept.png" alt=""/>
<div class="caption">
Figure 3.1 NN Model Protection Concept.</div></div>
<h2><a class="anchor" id="deployment_process"></a>
3.2 Deployment Process</h2>
<p >The primary objective of NMP is to protect the model encryption keys. There are two main keys: PEK and DEK. The PEK, generated by the vendor, is used to encrypt the NN model within a software release package. It is the vendor’s responsibility to keep the PEK confidential. DEK is used to encrypt the PEK on the device. The DEK is unique for each chip and can only be accessed by CVflow. When CVflow receives the PEK, it decrypts and re-encrypts the PEK with the DEK; then, the re-encrypted PEK is stored back to the file system. A major design target of the deployment process is the secure distribution of the PEK to CVflow. The Ambarella SDK uses X25519 for key exchange, in addition to ED25519 for identity authentication, in order to set up a secure channel between the software vendor’s server and CVflow. To enhance the security level, the sample code in the SDK uses a bi-directional authenticated TLS for internet communication. The two cryptography layers of defense include TLS (RSA / ECDSA + DH / ECDH) and ED25519 + X25519. The deployment process is typically used in conjunction with “unit license” distribution. For unit license protection, refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#ulp"><ol type="1">
<li>Unit License Protection</li>
</ol>
</a>. <a class="anchor" id="Distributing_the_PEK_in_a_Secure_Channel"></a>. </p><div class="image">
<img src="../../distribute_pek_in_secure_channel.png" alt=""/>
<div class="caption">
Figure 3.2 Distributing the PEK in a Secure Channel.</div></div>
<h2><a class="anchor" id="online_upgrade_process"></a>
3.3 Online Upgrade Process</h2>
<p >If the vendor’s PEK remains the same, the online upgrade is the same as the plaintext NN model upgrade. Additionally, if the PEK does not change, the DEK-encrypted PEK is not required to change. However, if the PEK changes, the device can re-trigger a new key exchange for the new PEK; CVflow then re-encrypts the new PEK and stores it back on the Linux side. <a class="anchor" id="Distributing_the_PEK_in_a_Secure_Channel"></a>. </p><div class="image">
<img src="../../distribute_pek_in_secure_channel.png" alt=""/>
<div class="caption">
Figure 3.3 Distributing the PEK in a Secure Channel.</div></div>
<h2><a class="anchor" id="device_working_process"></a>
3.4 Device Working Process</h2>
<p >CVflow loads the encrypted model, along with the encrypted PEK and digest. CVflow decrypts the PEK first, and then uses the PEK to decrypt the NN model and execute the model. <a class="anchor" id="Device_Working_Process"></a>. </p><div class="image">
<img src="../../device_working_process.png" alt=""/>
<div class="caption">
Figure 3.4 Device Working Process.</div></div>
<h2><a class="anchor" id="sw_hierarchy_on_chip"></a>
3.5 Software Hierarchy on Chip</h2>
<p >For green-colored components, the Linux SDK provides the sample code for evaluation. The software vendor is responsible for their maintenance. <a class="anchor" id="Software_Hierarchy_on_Chip"></a>. </p><div class="image">
<img src="../../fig_sw_hierarchy_on_chip.png" alt=""/>
<div class="caption">
Figure 3.5 Software Hierarchy on Chip.</div></div>
<h2><a class="anchor" id="sw_hierarchy_on_pc"></a>
3.6 Software Hierarchy on Linux PC</h2>
<p >For green-colored components in the following image, the Linux SDK provides the sample code for evaluation. The software vendor is responsible for their maintenance. <a class="anchor" id="Software_Hierarchy_on_PC"></a>. </p><div class="image">
<img src="../../fig_sw_hierarchy_on_pc.png" alt=""/>
<div class="caption">
Figure 3.6 Software Hierarchy on PC.</div></div>
<h2><a class="anchor" id="support_muti_customers"></a>
3.7 Support Multiple Customers</h2>
<p >Each software vendor can support multiple customers. Additionally, the license server and upgrade server can manage transactions in parallel, as shown below. <a class="anchor" id="Muti_Customer_Support"></a></p><div class="image">
<img src="../../muti_customer_support.png" alt=""/>
<div class="caption">
Figure 3.7 Multi-Customer Support.</div></div>
<h1><a class="anchor" id="neural_network_model_protections_user_guide"></a>
4. Neural Network Model Protection User Guide</h1>
<h2><a class="anchor" id="compile_nn_model_protection_code"></a>
4.1 Compile NN Model Protection Sample Code</h2>
<p >Users can compile the Ambarella NN model protection sample code on the SoC and on the Linux (Ubuntu) platform. Refer to the following to compile the sample code.</p>
<h3><a class="anchor" id="compile_nmp_sample_code_on_soc"></a>
4.1.1 Compile Sample Code on the SoC</h3>
<p >Select <code>menuconfig</code> below.</p>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">security  ---&gt;</div>
<div class="line"> ulp-nmp (security/ulp_nmp)</div>
<div class="line">  ULP and NMP by CVflow</div>
</div><!-- fragment --><p> The provisioning tools (<code>ulp_nmp_pt_activate</code>) are under <code>/usr/local/bin/</code> on the SoC.</p>
<p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">-&gt; meta-ambasecurity  ---&gt;</div>
<div class="line"> -&gt; recipes-ulpnmp  ---&gt;</div>
<div class="line">  -&gt; ulpnmp (meta-ambasecurity/recipes-ulpnmp/ulpnmp)  ---&gt;</div>
<div class="line">   -&gt; ulpnmp (meta-ambasecurity/recipes-ulpnmp/ulpnmp)</div>
<div class="line">    -&gt; ULP and NMP by CVflow</div>
</div><!-- fragment --><h3><a class="anchor" id="compile_nmp_sample_code_on_linux"></a>
4.1.2 Compile Sample Code on Linux (Ubuntu)</h3>
<p >Go to the source code location and compile. </p><div class="fragment"><div class="line">cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">make &amp;&amp; make install &amp;&amp; make install_configs</div>
</div><!-- fragment --><p >The servers and tools are placed on <code>/ambarella/security/build/</code>.</p>
<h2><a class="anchor" id="derive_pek_and_enc_model"></a>
4.2 Derive the PEK and Encrypt Model</h2>
<p >For a encrypted NN model with PEK, users can also refer to <code>/ambarella/security/ ulp_nmp/doc/derive_pek_and_encrypt_model.txt</code>.</p>
<h3><a class="anchor" id="dervie_pek"></a>
4.2.1 Derive the PEK</h3>
<p >Go to the following license server location: </p><div class="fragment"><div class="line">build $ cd ambarella/security/build/ulp_nmp_license_server</div>
</div><!-- fragment --><p >Generate the PEK if it is not yet generated. If PEK is already generated, re-generation is not required. </p><div class="fragment"><div class="line">build $ ../ulp_nmp_key_tool/ulp_nmp_key_tool --gen-aesctr pek --path ./keys/ --passphrase 1234</div>
</div><!-- fragment --><p >Decrypt the PEK: </p><div class="fragment"><div class="line">build $ ../ulp_nmp_key_tool/ulp_nmp_key_tool --decrypt ./keys/pek_enc.bin ./keys/pek.bin --shadow ./keys/pek_enc.shadow --passphrase 1234</div>
<div class="line">./keys/pek_enc.bin is the encrypted form of the PEK, and ./keys/pek.bin is the PEK; users should use pek.bin <span class="keywordflow">for</span> model encryption.</div>
</div><!-- fragment --><h2><a class="anchor" id="enc_model_with_pek"></a>
4.2.2 Encrypt Model with PEK</h2>
<p >Encrypt the model via the PEK: </p><div class="fragment"><div class="line">build $ cavalry_gen -d vas_output -k pek.bin -f net_enc.bin</div>
</div><!-- fragment --><p >For more information about Cavalry generation and <code>vas_output</code>, refer to the related CVflow documents.</p>
<p >Show model encryption status: </p><div class="fragment"><div class="line">BOARD# test_nnctrl -b net_enc.bin --show-encrypt</div>
</div><!-- fragment --><p >Load the encrypted model and execute: </p><div class="fragment"><div class="line">BOARD# test_nnctrl -b net_enc.bin --in input=input.bin --out output=out.bin --cert license_cert.bin --key dev_encrypt_pek.bin --digest dev_encrypt_pek.digest</div>
</div><!-- fragment --><p >The <code>dev_encrpted_pek.bin</code> and <code>dev_encrypted_pek.digest</code> are generated after deployment (device activation). Note that Cavalry must be loaded first on the chip. </p><div class="fragment"><div class="line">BOARD# init.sh --na</div>
<div class="line">BOARD# modprobe cavalry</div>
<div class="line">BOARD# cavalry_load -f /lib/firmware/cavalry.bin –r</div>
</div><!-- fragment --><h2><a class="anchor" id="nmp_launch_from_scratch_user_guide"></a>
4.3 Launch-from-Scratch User Guide</h2>
<p >Components related to NMP include the license server, the deployment tool, and the provisioning tool on the device. The following sections describe how to launch the license server and tools after compiling and installing the configurations. Users can also refer to the help file located at <code>/ambarella/security/ulp_nmp/doc/ulp_nmp_from_scratch_steps.txt</code>.</p>
<dl class="section note"><dt>Note</dt><dd>The process in this chapter includes key generation. It is important that users keep the private key and encryption key confidential, in addition to maintaining a record and backup of the key passphrases, as security of the system is dependent on proper key maintenance. Moreover, because there is no method for recovering lost or forgotten key files, it is vital that users prioritize key maintence in order to maintain system security.</dd></dl>
<h3><a class="anchor" id="nmp_scratch_compile_and_install_config"></a>
4.3.1 Compile and Install Configurations</h3>
<p >Go to the source code location, then compile and install the configurations. </p><div class="fragment"><div class="line">build $ cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">build $ make &amp;&amp; make install &amp;&amp; make install_configs</div>
</div><!-- fragment --><h3><a class="anchor" id="nmp_launch_license_server"></a>
4.3.2 Launch the License Server</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#launch_license_server">2.2.2 Launch the License Server</a> for more information. Only change the .lc file when launching the server. </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_nmp_license_svr_cvflow.lc</div>
</div><!-- fragment --><h3><a class="anchor" id="nmp_launch_deployment_tool"></a>
4.3.3 Launch the Deployment Tool</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#launch_deployment_tool">2.2.3 Launch the Deployment Tool</a> for more information.</p>
<h3><a class="anchor" id="nmp_approve_account"></a>
4.3.4 Approve An Account</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#approve_account">2.2.4 Approve an Account</a> for more information.</p>
<h3><a class="anchor" id="nmp_run_provisiong_tool_to_deploy_pek"></a>
4.3.5 Run the Provisioning Tool to Deploy PEK</h3>
<p >By default, the IP address of the device is 10.0.0.2. Once <code>ulp_nmp_pt_activate</code> is running, the deployment tool connects to it via <code>device_url:device_port</code> in the .lc file. To prepare, copy <code>ambarella/security/build/ulp_nmp_simulate_device</code> to <code>DEVICE_PATH</code>. Then, run the provisioning tool on the device. </p><div class="fragment"><div class="line">init.sh --na</div>
<div class="line">modprobe cavalry</div>
<div class="line">cavalry_load -f /lib/firmware/cavalry.bin -r</div>
<div class="line">test_encode --idle --nopreview</div>
<div class="line">ulp_nmp_pt_activate $(DEVICE_PATH)/lc_configs/pt_cvflow.lc</div>
</div><!-- fragment --><p >After activation, <code>pub_dik_cvflow.bin</code> and <code>unit_license_cvflow.bin</code> will be generated; <code>unit_license_cvflow.bin</code> is the unit license for this chip. At the same time, a re-encrypted PEK <code>dev_encrypt_pek.bin</code> and a digest file <code>dev_encrypt_ pek.digest</code> are generated. Those two files are required for CVflow load encrypted modeling and execution. Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#enc_model_with_pek">4.2.2 Encrypt Model with PEK</a> for more information.</p>
<h2><a class="anchor" id="nmp_quick_launch_user_guide"></a>
4.4 Quick-Launch User Guide</h2>
<p >NMP-related components include the license server, the deployment tool, and the provisioning tools on the device. The following sections describe how to proceed with setup using the pre-set test files. Users can also refer to the help file located at <code>/ambarella/security/ulp_nmp/doc/ ulp_nmp_quick_launch_steps.txt</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Because the process in this chapter includes copying the pre-set keys and certificates to the <code>server/deployment_tool/provisioning_tool</code> location, it will replace the current keys and certificates. If the current keys and certificates are still required, perform a backup; otherwise, the keys and certificate will be overwritten.</dd></dl>
<h3><a class="anchor" id="nmp_quick_compile_install_preset_test_file"></a>
4.4.1 Compile and Install the Pre-Set Test Files</h3>
<p >Go to the source code location. Then, compile and install together with the pre-set test files. </p><div class="fragment"><div class="line">build $ cd $(SDK)/ambarella/security/ulp_nmp</div>
<div class="line">build $ make &amp;&amp; make install</div>
<div class="line">build $ make install_preset_test_files</div>
</div><!-- fragment --><h3><a class="anchor" id="nmp_quick_launch_license_server"></a>
4.4.2 Launch the License Server</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#launch_license_server">2.2.2 Launch the License Server</a> for more information. Only change the .lc file when launching the server. </p><div class="fragment"><div class="line">build $ ./ulp_nmp_license_server lc_configs/ulp_nmp_license_svr_cvflow.lc</div>
</div><!-- fragment --><h3><a class="anchor" id="nmp_quick_launch_deployment_tool"></a>
4.3.3 Launch the Deployment Tool</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#launch_deployment_tool">2.2.3 Launch the Deployment Tool</a> for more information.</p>
<h3><a class="anchor" id="nmp_quick_approve_account"></a>
4.3.4 Approve An Account</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#approve_account">2.2.4 Approve an Account</a> for more information.</p>
<h3><a class="anchor" id="nmp_quick_run_provisiong_tool_to_deploy_pek"></a>
4.3.5 Run the Provisioning Tool to Deploy PEK</h3>
<p >Refer to <a class="el" href="../../d0/dfd/system_integrity_protection.html#nmp_run_provisiong_tool_to_deploy_pek">4.3.5 Run the Provisioning Tool to Deploy PEK</a> for more information.</p>
<h1><a class="anchor" id="ulp_nmp_key_tool"></a>
5. ULP NMP Key Tools</h1>
<p >The ULP NMP key tool can be used to generate the AES key <code>*.bin</code>, its encrypted form <code>*_enc.bin</code>, and the corresponding shadow file <code>*.shadow</code>.</p>
<h2><a class="anchor" id="change_key_passphrase"></a>
5.1 Change Key Passphrase</h2>
<p >In some cases, users may be required to change the key’s passphrase. The following examples demonstrate how to change the VLK passphrase, re-encrypt the key (client account key), and generate the corresponding shadow file.</p>
<p ><b>Decrypt with Old Passphrase</b> </p><div class="fragment"><div class="line">./ulp_nmp_key_tool --decrypt priv_cli_enc.bin priv_cli.bin --passprase 1234 --shadow priv_cli_enc.shadow</div>
</div><!-- fragment --><p ><b>Remove Old Encrypted File and Shadow File</b> </p><div class="fragment"><div class="line">rm priv_cli_enc.shadow -rf</div>
<div class="line">rm priv_cli_enc.bin -rf</div>
<div class="line">rm pub_cli_enc.bin -rf</div>
</div><!-- fragment --><p ><b>Re-Encrypt with New Passphrase</b> </p><div class="fragment"><div class="line">./ulp_nmp_key_tool --encrypt priv_cli.bin priv_cli_enc.bin --passphrase 2345 --shadow priv_cli_enc.shadow</div>
<div class="line">./ulp_nmp_key_tool --encrypt pub_cli.bin pub_cli_enc.bin --passphrase 2345 --shadow priv_cli_enc.shadow</div>
</div><!-- fragment --><p ><b>Remove the Plaintext Private Key</b> </p><div class="fragment"><div class="line">rm priv_cli.bin -rf</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
