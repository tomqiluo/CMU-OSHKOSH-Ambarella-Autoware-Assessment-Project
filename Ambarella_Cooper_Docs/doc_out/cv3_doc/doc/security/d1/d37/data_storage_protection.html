<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: Data Storage Protection</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d1/d37/data_storage_protection.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Data Storage Protection </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="data_part_enc"></a>
1. Data Partition Encryption</h1>
<p >The Ambarella Flexible Linux Software Development Kit (SDK) supports dm-crypt, a standard feature in Linux for data partition encryption (DPE), which encrypts the entire partition.</p>
<h2><a class="anchor" id="dm_crypt"></a>
1.1 dm-crypt</h2>
<p >Using the Linux kernel’s crypto application programming interface (API) framework and device mapper subsystem, dm-crypt enables administrators to encrypt entire disks, logical volumes, partitions, and single files. The dm-crypt subsystem supports the Linux unified key setup (LUKS) structure, which enables multiple keys to access the encrypted data, as well as the ability to manipulate the keys (such as changing the keys, adding additional passphrases, and more.)</p>
<h3><a class="anchor" id="setup_dm_crypt_on_amba_platform"></a>
1.1.1 Set Up dm-crypt on the Ambarella Platform</h3>
<p >Follow the steps below to set up dm-crypt:</p><ol type="1">
<li>The configuration for the Linux kernel is as follows: <div class="fragment"><div class="line">build$ make linux_menuconfig</div>
<div class="line">       -&gt;[*] ARM64 Accelerated Cryptograohic Algorithems</div>
<div class="line">        -&gt;&lt;*&gt; AES core cipher <span class="keyword">using</span> ARMv8 Crypto Extensions</div>
<div class="line">         &lt;*&gt; AES in ECB/CBC/CTR/XTS modes <span class="keyword">using</span> ARMv8 Crypto Extensions</div>
<div class="line"> </div>
<div class="line">       -&gt;Cryptographic API</div>
<div class="line">        -&gt;&lt;M&gt; User-sapce <span class="keyword">interface </span>for sysmmetric key cipher algorithms</div>
<div class="line"> </div>
<div class="line">       -&gt;Device Drivers</div>
<div class="line">        -&gt;[*] Multiple devices driver support (RAID and LVM)</div>
<div class="line">        -&gt;&lt;M&gt; Device mapper support</div>
<div class="line">         &lt;M&gt; Crypt target support</div>
</div><!-- fragment --></li>
<li>The configuration for the Ambarella platform is as follows: Users can enable dm-crypt and test it from the user space.</li>
</ol>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       -&gt; prebuild  ---&gt;</div>
<div class="line">        &gt; oss  ---&gt;</div>
<div class="line">         &gt; prebuild-cryptsetup (prebuild/oss/armv8-a/cryptsetup)  --</div>
<div class="line">          &gt; Add cryptsetup utils into root_fs</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       &gt; meta-oe  ---&gt;</div>
<div class="line">        &gt; recipes-crypto  ---&gt;</div>
<div class="line">         &gt; cryptsetup (meta-oe/recipes-crypto/cryptsetup)</div>
</div><!-- fragment --><h3><a class="anchor" id="use_cryptosetup_to_run_dm_crypt"></a>
1.1.2 Use Cryptsetup to Run dm-crypt</h3>
<p >Cryptsetup is a command-line tool that interfaces with dm-crypt for creating, accessing, and managing encrypted devices. The following is a simple test for cryptsetup: </p><div class="fragment"><div class="line"><span class="comment">// modprobe</span></div>
<div class="line">modprobe dm-crypt</div>
<div class="line">modprobe  algif_skcipher</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a simple image for test</span></div>
<div class="line">dd <span class="keywordflow">if</span>=/dev/zero of=./secret.img bs=1M count=50</div>
<div class="line">losetup /dev/loop8 ./secret.img</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create encrypt fs on image</span></div>
<div class="line">cryptsetup -y create test_encrypt_fs   /dev/loop8</div>
<div class="line"> </div>
<div class="line"><span class="comment">//setup file system and mount</span></div>
<div class="line">mkfs.ext2 /dev/mapper/test_encrypt_fs</div>
<div class="line">mkdir  /mnt/test_encrypt_fs</div>
<div class="line">mount /dev/mapper/test_encrypt_fs /mnt/test_encrypt_fs -t ext2</div>
</div><!-- fragment --><h3><a class="anchor" id=""></a>
</h3>
<p >Cryptosetup uses Armv8 crypto extensions to accelerate the advanced encryption standard (AES) speed. Follow the steps below to test AES performance: </p><div class="fragment"><div class="line">board# cryptsetup benchmark -c aes-ecb -s 256</div>
<div class="line">Tests are approximate <span class="keyword">using</span> memory only (no storage IO).</div>
<div class="line">Algorithm |       Key |      Encryption |      Decryption</div>
<div class="line">    aes-ecb        256b       368.6 MiB/s       368.3 MiB/s</div>
<div class="line">board# cryptsetup benchmark -c aes-cbc -s 256 -v</div>
<div class="line">Tests are approximate <span class="keyword">using</span> memory only (no storage IO).</div>
<div class="line">Algorithm |       Key |      Encryption |      Decryption</div>
<div class="line">    aes-cbc        256b       271.0 MiB/s       341.0 MiB/s</div>
<div class="line">board# cryptsetup benchmark -c aes-ctr -s 256</div>
<div class="line"> Tests are approximate <span class="keyword">using</span> memory only (no storage IO).</div>
<div class="line">Algorithm |       Key |      Encryption |      Decryption</div>
<div class="line">   aes-ctr        256b       340.6 MiB/s       342.3 MiB/s</div>
<div class="line">board# cryptsetup benchmark -c aes-xts -s 256</div>
<div class="line"> Tests are approximate <span class="keyword">using</span> memory only (no storage IO).</div>
<div class="line">Algorithm |       Key |      Encryption |      Decryption</div>
<div class="line">aes-xts        256b       349.3 MiB/s       351.7 MiB/s</div>
</div><!-- fragment --><h1><a class="anchor" id="data_enc_protection"></a>
2. Data Encryption Protection</h1>
<p >Ambarella provides different crypto libraries for data encryption.</p>
<h2><a class="anchor" id="data_enc_alg"></a>
2.1 Data Encryption Algorithm</h2>
<p >AES is a popular block cipher for data encryption. The Ambarella SDK supports 128-bit, 192-bit, and 256- bit AES, as well as ECB / CBC / CTR / XTR modes. Ambarella recommends using the AES algorithm.</p>
<h2><a class="anchor" id="crypto_lib"></a>
2.2 Cryptography Library</h2>
<p >The paths for the prebuilt library and OpenSSL sample code are listed below:</p><ul>
<li>OpenSSL prebuilt library: <code>ambarella/prebuild/oss/armv8-a/openssl</code></li>
<li>AES OpenSSL sample code: <code>ambarella/security/validation/crypto_performance/ openssl</code> <dl class="section note"><dt>Note</dt><dd>OpenSSL can use the Armv8 crypto extension instructions to achieve a high AES performance.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="lightweight_crypto_lib"></a>
2.3 Lightweight Cryptography Library in Linux</h2>
<p >The paths for library and sample code for the lightweight cryptography library in Linux are provided below.</p><ul>
<li>Library code: <code>ambarella/security/lw_cryptography/src</code></li>
<li>Sample code: <code>ambarella/security/lw_cryptography/unit_test</code> <dl class="section note"><dt>Note</dt><dd>The lightweight cryptography library does not use Armv8 crypto extension instructions, and its AES performance is sub-optimal.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="native_aes_with_crypto_extension"></a>
2.4 Native AES with Crypto Extension Instructions in Linux</h2>
<p >The paths for the native AES with crypto extension instructions in Linux are as follows:</p><ul>
<li>Library code: <code>ambarella/security/crypto_engine/src/armv8_crypto_extension</code></li>
<li>Sample code: <code>ambarella/security/crypto_engine/unit_test</code></li>
</ul>
<h2><a class="anchor" id="mbed_tls_in_atf"></a>
2.5 Mbed TLS in ATF</h2>
<p >The path for Mbed TLS in Arm® trusted firmware (ATF) is as follows:</p><ul>
<li>Library code: <code>ambarella/boot/tee/mbedtls</code></li>
</ul>
<h1><a class="anchor" id="secure_storage"></a>
3. Secure Storage</h1>
<p >Secure storage refers to data-at-rest protection (DARP), or data in an encrypted form in external storage.</p>
<h2><a class="anchor" id="data_at_rest_protection"></a>
3.1 Data at Rest Protection</h2>
<p >The data encryption key is managed by the trusted OS (OP-TEE), and is inaccessible from the unsecure world. The following diagram displays the data encryption flow. Abbreviations used in the diagram include the following:</p><ul>
<li>HUK: hardware-unique encryption key, unique to each chip, on one-time programmable (OTP)</li>
<li>SSK: secure storage key, unique to each chip</li>
<li>TSK: trusted application storage key, unique to each application</li>
<li>FEK: file encryption key, random per file</li>
<li>HMAC: hash-based message authentication code</li>
</ul>
<p ><a class="anchor" id="Data_Encryption_Diagram"></a></p><div class="image">
<img src="../../data_encryption_diag.png" alt=""/>
<div class="caption">
Figure 3-1. Data Encryption Diagram.</div></div>
<p> The paths for the example code of the client application (CA) and for the trusted application (TA) are as follows:</p><ul>
<li>CA: <code>ambarella/boot/tee/optee_test/host/test_secure_storage</code></li>
<li>TA: <code>ambarella/boot/tee/optee_test/ta/test_secure_storage</code></li>
</ul>
<h2><a class="anchor" id="data_protection_by_passphrase"></a>
3.2 Data Protection by Passphrase</h2>
<p >Data protection by passphrase is demonstrated on the following page. <a class="anchor" id="Data_Protection_by_Passphrase_Diagram"></a></p><div class="image">
<img src="../../data_protection_by_passphrase.png" alt=""/>
<div class="caption">
Figure 3-2. Data Protection by Passphrase Diagram.</div></div>
<p> The paths for the example code of the CA and TA are as follows:</p><ul>
<li>CA: <code>ambarella/boot/tee/optee_test/host/data_encryption_aes_v2</code></li>
<li>TA: <code>ambarella/boot/tee/optee_test/ta/data_encryption_aes_v2</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
