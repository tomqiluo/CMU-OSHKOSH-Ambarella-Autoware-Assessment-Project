<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security: System Reinforcement</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Security"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Security<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('db/d12/system_reinforcement.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">System Reinforcement </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="SEBLD"></a>
1. Secure Enhanced Bootloader</h1>
<p >The secure enhanced bootloader (SEBLD) is a bootloader with public key authentication; only users who pass the authentication can execute commands inside the BLD console. The BLD generates a random challenge to the user with an embedded public key, and users must provide the correct response (the digital signature of the random challenge). Otherwise, the commands in the BLD are not executed. Only the private key owner can generate the correct response.</p>
<h2><a class="anchor" id="perpare_sebld_key"></a>
1.1 Prepare the Key Pair</h2>
<p >The SEBLD’s public key is embedded inside the BLD firmware. For RSA2048 + SHA256, the public key is in C source file format, located in the folder <code>ambarella/security/boot_security/locker_pubkey.c</code>. For ED25519 + SHA512, the public key is embedded with <code>.bin</code> format, located in the folder <code>ambarella/security/tz_sb_keys/local_keys/sebld_keys/ed25519/ pub_sebld.bin</code>. Before this feature is used, users should already have their own key pair. This can be performed by generating a new key pair, or using an existing key pair. The private key should be kept confidential.</p>
<h3><a class="anchor" id=""></a>
</h3>
<p >Use the command below to replace the default key pairs that accompany the software development kit (SDK). </p><div class="fragment"><div class="line">build$ cd ambarella/security/security_tools/scripts</div>
<div class="line">build$ ./gen_sebld_key.sh ed25519</div>
</div><!-- fragment --><h3><a class="anchor" id="use_an_existing_key_pair"></a>
1.1.2 Use an Existing Key Pair</h3>
<p >Replace the existing private key in <code>ambarella/security/tz_sb_keys/local_keys/sebld_keys</code>. Use the command below to derive the corresponding public key: </p><div class="fragment"><div class="line">build$ cd ambarella/security/security_tools/scripts</div>
<div class="line">build$ ./derive_sebld_pub_key.sh ed25519</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>The private key should be kept confidential.</li>
<li>Ambarella recommends removing both <code>pri_sebld.bin</code> from the source code after the public key is derived.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="perpare_cfg_partition"></a>
1.2 Prepare the Configuration Partition</h2>
<p >Ambarella recommends storing the lock / unlock state in the configuration (CFG) partition. However, because the CFG partition is not enabled by default, users must first enable it. To enable the CFG partition, follow the steps below (Yocto build is used as an example). If using the legacy firmware layout, the CFG partition must be selected in menuconfig: </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       &gt; meta-ambabsp  ---&gt;</div>
<div class="line">        &gt; recipes-bsp  ---&gt;</div>
<div class="line">         &gt; amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">          &gt; Ambarella Firmware Configuration ---&gt;</div>
<div class="line">           Firmware Options ---&gt;</div>
<div class="line">            Configuration Partition ---&gt;</div>
<div class="line">            ($(AMB_TOPDIR)/amboot/vif/cfg.bin) CFG</div>
<div class="line">            ($(AMB_TOPDIR)/amboot/vif/cfg.info) CFG Version File</div>
</div><!-- fragment --><p> If using the flexible firmware layout, add the CFG partition in the profile file: </p><div class="fragment"><div class="line">ifeq ($(SEBLD_STORE_IN_CFG), y)</div>
<div class="line">IMAGE_7_NAME   := cfg</div>
<div class="line">IMAGE_7_FILE   := $(ENV_TOP_DIR)/security/boot_security/cfg.bin</div>
<div class="line">IMAGE_7_ADDR   := -1</div>
<div class="line">IMAGE_7_FLAG   := force</div>
<div class="line">endif</div>
</div><!-- fragment --><p> Use the command below to generate a blank <code>cfg.bin</code>. </p><div class="fragment"><div class="line">build$ dd <span class="keywordflow">if</span>=/dev/zero of=cfg.bin bs=1024 count=1</div>
</div><!-- fragment --><p> Or, use the pre-generated blank <code>cfg.bin</code> file in <code>ambarella/security/boot_security/cfg.bin</code>. Modify <code>ambarella/boards/cv5_timn/bsp.h</code>, and then set <code>AMBOOT_CFG_SIZE:</code> </p><div class="fragment"><div class="line"><span class="preprocessor">#define AMBOOT_CFG_SIZE                (AMBOOT_MIN_PART_SIZE * 4)</span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>If there is no CFG partition in a product, the backup plan is to store the lock state in the PTB partition.</li>
<li>Check the MACROs in <code>ambarella/security/boot_security/locker.c</code> (for SDK 1.0, use the keys in <code>ambarella/packages/security/boot_security/locker.c</code>).</li>
<li>“STORE_LOCK_STATUS” indicates the locker state.</li>
<li>“STORE_IN_CFG” indicates that the locker state should be stored in the CFG partition rather than in the PTB partition.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="prepare_android_fastboot"></a>
1.3 Prepare Android Fastboot</h2>
<h3><a class="anchor" id="get_android_fastboot_tools"></a>
1.3.1 Get Android Fastboot Tools</h3>
<p >Android Fastboot tools can be downloaded from <a href="https://www.teamandroid.com/2017/05/06/download-adb-fastboot-android-sdk-platform-tools/">https://www.teamandroid.com/2017/05/06/download-adb-fastboot-android-sdk-platform-tools/</a>.</p>
<h3><a class="anchor" id="enter_android_fastboot"></a>
1.3.2 Enter Android Fastboot on the EVK</h3>
<p >There are two approaches to enter Android Fastboot on an evaluation kit (EVK) board:</p><ul>
<li>Execute “Fastboot” on the AMBoot console</li>
<li>Enter Android Fastboot directly via general purpose input / output (GPIO)</li>
</ul>
<p >If the product does not have a serial port, Ambarella recommends that users choose the latter approach. For the latter approach, the board support package (BSP) code must be modified in order to enter into Android Fastboot directly via <code>GPIO_DEBUG</code>. Add the highlighted part below in <code>ambarella/boards/cv5_timn/bsp/bsp.c</code>: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> amboot_bsp_entry(flpart_table_t *pptb)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> retval = 0;</div>
<div class="line">    flpart_table_t ptb;</div>
<div class="line"> </div>
<div class="line">    {<span class="comment">//add to setup debug gpio for fastboot</span></div>
<div class="line"><span class="preprocessor">    #define AMBARELLA_DEBUG_GPIO    107</span></div>
<div class="line">        gpio_config_sw_in(AMBARELLA_DEBUG_GPIO);</div>
<div class="line">        <span class="keywordflow">if</span> (!gpio_get(AMBARELLA_DEBUG_GPIO))</div>
<div class="line">            <span class="keywordflow">return</span> 4;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Read the partition table */</span></div>
<div class="line">    retval = flprog_get_part_table(&amp;ptb);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* BIOS boot */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ptb.dev.rsv[0] &gt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Find BIOS boot flag\n&quot;</span>);</div>
<div class="line">        retval = ptb.dev.rsv[0];</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="sebld_user_guide"></a>
1.4 User Guide</h2>
<p >There are two approaches to execute commands in the bootloader: the first uses the AMBoot console; the second uses Android Fastboot. The following sections demonstrate these two approaches (using the ed25519 key for example).</p>
<h3><a class="anchor" id="sebld_via_amboot_console"></a>
1.4.1 Via AMBoot Console</h3>
<ul>
<li>Compile options: To enable SEBLD, select the following items in “make menuconfig”:</li>
</ul>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       security  ---&gt;</div>
<div class="line">        [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">         [*]   Security-Enhanced BLD Support [locker]  ---&gt;</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       meta-ambasecurity  ---&gt;</div>
<div class="line">        recipes-boot-security  ---&gt;</div>
<div class="line">         [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">          [*]   Security-Enhanced BLD Support [locker]  ---&gt;</div>
</div><!-- fragment --><ol type="1">
<li>Enter the AMBoot console (press <b>Enter</b> and reboot).</li>
<li>Get the challenge. <div class="fragment"><div class="line">amboot&gt; sebld challenge</div>
</div><!-- fragment --> The 40-byte challenge is shown below. <div class="fragment"><div class="line">amboot &gt; sebld challenge</div>
<div class="line">fa3177810ee1078bb34f8118539e9046n4q6a6x5</div>
</div><!-- fragment --></li>
<li>Use the private key to sign the challenge (ED25519 for example; RSA2048 is similar). <div class="fragment"><div class="line">build$ cd ambarella/packages/security/build/sebld_tool</div>
<div class="line">build$ ./sebld_disable fa3177810ee1078bb34f8118539e9046n4q6a6x5 ed25519 ../../keys/local_keys/sebld_keys/ed25519/pri_sebld.bin</div>
<div class="line">dbf7f77265bb9f2e9e92f2539af6900e2ffa96de854f82df28d754c71601e20964814d65930a5e6cb796b925d07920e4c87dcbd81d90f744e000d7e1ef860c0b</div>
</div><!-- fragment --></li>
<li>Use the signature to unlock the BLD in the AMBoot console: <div class="fragment"><div class="line">amboot&gt; sebld challenge</div>
<div class="line">fa3177810ee1078bb34f8118539e9046n4q6a6x5</div>
<div class="line">amboot&gt; sebld disable dbf7f77265bb9f2e9e92f2539af6900e2ffa96de854f82df28d754c71601e20964814d65930a5e6cb796b925d07920e4c87dcbd81d90f744e000d7e1ef860c0b</div>
<div class="line">store signature:</div>
<div class="line">dbf7f77265bb9f2e9e92f2539af6900e2ffa96de854f82df28d754c71601e20964814d65930a5e6cb796b925d07920e4c87dcbd81d90f744e000d7e1ef860c0b </div>
</div><!-- fragment --></li>
</ol>
<p >When the bootloader is unlocked, inputting <code>help</code> lists the available commands.</p>
<ol type="1">
<li>Lock BLD: <div class="fragment"><div class="line">amboot&gt; selbd enable</div>
</div><!-- fragment --> The message below signifies that no command is available after it is locked. <div class="fragment"><div class="line">amboot&gt;help</div>
<div class="line">Security-Enhanced BLD is enable</div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="sebld_via_android_fastboot"></a>
1.4.2 Via Android Fastboot</h3>
<ul>
<li>Compile Options To enable SEBLD and Android Fastboot, select the following items in “make menuconfig”:</li>
</ul>
<p ><b>Amba build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       boot  ---&gt;</div>
<div class="line">        [*] amboot (boot/ambamk)  ---&gt;</div>
<div class="line">           Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">            AMBoot Options  ---&gt;</div>
<div class="line">             Common Boot Options  ---&gt;</div>
<div class="line">       security  ---&gt;</div>
<div class="line">        [*] boot-security (security/boot_security)  ---&gt;</div>
<div class="line">         [*]   Security-Enhanced BLD Support [locker]  ---&gt;</div>
</div><!-- fragment --><p ><b>Yocto build:</b> </p><div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       meta-ambabsp  ---&gt;</div>
<div class="line">        recipes-bsp  ---&gt;</div>
<div class="line">         [*] amboot (meta-ambabsp/recipes-bsp/boot)  ---&gt;</div>
<div class="line">           Ambarella Bootloader Configuration  ---&gt;</div>
<div class="line">            AMBoot Options  ---&gt;</div>
<div class="line">             Common Boot Options  ---&gt;</div>
<div class="line">              [* ] Android Fastboot Support</div>
<div class="line">       meta-ambasecurity  ---&gt;</div>
<div class="line">        recipes-boot-security  ---&gt;</div>
<div class="line">         [*] boot-security (meta-ambasecurity/recipes-boot-security/boot-security)  ---&gt;</div>
<div class="line">          [*]   Security-Enhanced BLD Support [locker]  ---&gt;</div>
</div><!-- fragment --><p >Follow the steps below to execute the lock and unlock functions.</p><ol type="1">
<li>Enter Android Fastboot by pressing the <code>GPIO_DEBUG</code> button and rebooting. An example of the board entering Android Fastboot is provided below. <a class="anchor" id="Android_Fastboot"></a><div class="image">
<img src="../../android_fastboot_console.png" alt=""/>
<div class="caption">
Figure 1-1. Android Fastboot.</div></div>
</li>
<li>Get the challenge. <div class="fragment"><div class="line">host$ fastboot.exe getvar challenge</div>
<div class="line">challenge: fa3177810ee1078bb34f8118539e9046l7r5a4v6 </div>
<div class="line">Finished. Total time: 0.009s</div>
</div><!-- fragment --></li>
<li>Use the private key to sign the challenge. <div class="fragment"><div class="line">build$ cd ambarella/packages/security/build/sebld_tool</div>
<div class="line">build$ ./sebld_disable fa3177810ee1078bb34f8118539e9046l7r5a4v6 ed25519 ../../keys/local_keys/sebld_keys/ed25519/pri_sebld.bin</div>
</div><!-- fragment --></li>
</ol>
<p >The signature file is <code>sebld.sign</code>. Copy <code>sebld.sign</code> to the Android Fastboot tool folder.</p>
<ol type="1">
<li>Upload the signature to the board. <div class="fragment"><div class="line">host$ fastboot.exe signature sebld.sign</div>
</div><!-- fragment --></li>
<li>Unlock the BLD. <div class="fragment"><div class="line">host$ fastboot.exe oem unlock</div>
</div><!-- fragment --> The following message will be displayed if the unlock was successful. <a class="anchor" id="Unlock_Android_Fastboot_Successful"></a><div class="image">
<img src="../../unlock_android_fastboot.png" alt=""/>
<div class="caption">
Figure 1-2. Unlock Android Fastboot Successful.</div></div>
 Then, the other Android Fastboot commands are available for use. For example, the “boot” command can download firmware, such as AmbaUSB: <div class="fragment"><div class="line">host$ fastboot.exe boot bld_release.bin</div>
</div><!-- fragment --></li>
<li>Lock the BLD. <div class="fragment"><div class="line">host$ fastboot.exe boot bld_release.bin</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="selinux"></a>
2. Secure Enhanced Linux (SELinux)</h1>
<h2><a class="anchor" id="selinux_overview"></a>
2.1 SELinux Overview</h2>
<h3><a class="anchor" id="selinux_introduction"></a>
2.1.1 Introduction</h3>
<p >SELinux is the primary mandatory access control (MAC) mechanism built into a number of GNU / Linux distributions. SELinux originally began as the Flux Advanced Security Kernel (FLASK), developed by the Utah University Flux team and the U.S. Department of Defense. The development was later enhanced by the National Security Agency (NSA) and released as an open source software (OSS).</p>
<h3><a class="anchor" id="core_selinux_components"></a>
2.1.2 Core SELinux Components</h3>
<p >The following figure shows a high-level diagram of the SELinux core components that manage the enforcement of the policy and is comprised of the following:</p><ul>
<li>An object manager that knows the actions required for a particular resource (such as a file) and can enforce those actions (for example, allows it to write to a file, if permitted by the policy)</li>
<li>A security server that makes decisions regarding the subject’s right to perform the requested action on the object, based on the existing security policy rules</li>
<li>A security policy that describes the rules using the SELinux policy language</li>
<li>An access vector cache (AVC) that improves system performance by caching security server decisions <a class="anchor" id="High_Level_Core_SELinux_Components"></a><div class="image">
<img src="../../high_level_core_selinux_components.png" alt=""/>
<div class="caption">
Figure 2-1. High-Level Core SELinux Components.</div></div>
</li>
</ul>
<h3><a class="anchor" id="mandatory_access_control"></a>
2.1.3 Mandatory Access Control</h3>
<p >Mandatory access control is a type of access control in which the operating system (OS) is used to constrain a user or process (the subject) from accessing or performing an operation on an object (such as file, disk, memory, and more). Each of the subjects and objects include a set of security attributes that can be interrogated by the OS to check if the requested operation can be performed. For SELinux, the following are true:</p><ul>
<li>Subjects are processes</li>
<li>Objects are system resources, such as files and sockets</li>
<li>Security attributes are the security context</li>
<li>The security server within the Linux kernel authorizes access using the security policy that describes the rules that must be enforced</li>
</ul>
<h3><a class="anchor" id="selinux_users"></a>
2.1.4 SELinux Users</h3>
<p >Users in <code>GNU / Linux</code> are generally associated with human users (such as Alice and Bob) or operator / system functions (such as admin). While this can be implemented in SELinux, SELinux usernames are generally groups or classes of users. For example, all standard system users can be assigned an SELinux username of <code>user_u</code>. Administration staff can be assigned under <code>staff_u</code>.</p>
<h3><a class="anchor" id="rbac"></a>
2.1.5 Role-Based Access Control</h3>
<p >To further control access to type enforcement (TE) domains, SELinux uses role-based access control (RBAC). This feature enables SELinux users to be associated with one or more roles, where each role is then associated with one or more domain types, as shown in the figure below. <a class="anchor" id="Role_Based_Access_Control"></a></p><div class="image">
<img src="../../role_based_access_control.png" alt=""/>
<div class="caption">
Figure 2-2. Role-Based Access Control.</div></div>
<h3><a class="anchor" id="security_context"></a>
2.1.6 Security Context</h3>
<p >SELinux requires security context to be associated with each process (or subject) and object that is used by the security server to decide if access is permitted, as defined by the policy. The security context is additionally known as a ‘security label’. Within SELinux, the security context is represented as variable-length strings that define the SELinux user, their role, a type identifier, and an optional MCS / MLS security range level shown below. <code>user:role:type[:range]</code> The following table describes the user, role, type, and range within the security context. </p><a class="anchor" id="security_context"></a>
<table class="doxtable">
<caption>Table 2-1. Security Context.</caption>
<tr>
<th align="left">User</th><th align="left">Role</th><th align="left">Type</th><th align="left">Range </th></tr>
<tr>
<td>The SELinux user identity can be associated with one or more roles that the SELinux user is allowed to use </td><td>The SELinux role can be associated with one or more types that the SELinux user is allowed to access </td><td>When a type is associated with a process, it defines what processes (or domains) the SELinux user (the subject) can access. When a type is associated with an object, it defines what access permissions are available to the SELinux object </td><td>This field is known as a level; it is only present if the policy supports MCS or MLS. The entry can consist of the following:<br  />
<ul>
<li>A single security level that contains a sensitivity level and zero or more categories (for example, s0, s1:c0)</li>
<li>A range that consists of two security levels separated by a hyphen (for example, ss0-s15:c0.c1023) </li>
</ul>
</td></tr>
</table>
<h3><a class="anchor" id="selinux_subjects"></a>
2.1.7 Subjects</h3>
<p >A subject is an active entity (generally in the form of a person, process, or device) that enables information to flow among objects or that changes the system state. Within SELinux, a subject is an active process with an associated security context. However, a process can also be referred to as an object, depending on the context. For example:</p><ul>
<li>A running process (such as an active entity) is a subject because it causes information to flow among objects or can change the system state</li>
<li>The process can also be referred to as an object because each process has an associated object class called “process.” This process “object” defines what permissions the policy is allowed to grant or deny on the active process</li>
</ul>
<h3><a class="anchor" id="selinux_objects"></a>
2.1.8 Objects</h3>
<p >Within SELinux, an object is a resource (such as files, sockets, pipes, or network interfaces) that are accessed via processes (also known as subjects). These objects are classified according to which resource they provide access permissions relevant to their purpose (for example, read, receive, and write), and are assigned a security context. Each object consists of a class identifier that defines its purpose (for example, file or socket), along with a set of permissions (also known as access vectors) that describe what services the object can manage (read, write, send, and so on). When an object is instantiated, it will be allocated a name (for example, a file could be called <code>configured</code>, a <code>socket</code>, or <code>my_connection</code>) and a security context (for example, <code>system_u:object_r:selinux_config_t</code>).</p>
<h3><a class="anchor" id="selinux_modes"></a>
2.1.9 SELinux Modes</h3>
<p >SELinux includes three major operation modes:</p><ul>
<li>Enforcing: SELinux is enforcing the loaded policy</li>
<li>Permissive: SELinux has loaded the policy, but is not enforcing the policy rules. This is generally used for testing as the audit log contains the AVC-denied messages</li>
<li>Disabled: The SELinux infrastructure is not enabled; therefore, no policy can be loaded These flags are set in the <code>/etc/selinx/config</code> file.</li>
</ul>
<h3><a class="anchor" id="auditing_selinux_events"></a>
2.1.10 Auditing SELinux Events</h3>
<p >SELinux includes two main types of audit events: AVC audit events and SELinux-aware application events. AVC audit events are generated by the AVC subsystem as a result of access denials, or where specific events have requested an audit message. SELinux-aware application events are generated by the SELinux kernel services and SELinux-aware applications for events, such as system errors, initialization, policy loading, changing Boolean states, setting of enforcing / permissive mode, and relabeling.</p>
<p ><b>AVC Audit Events</b> The table below describes the general format of AVC audit messages in <code>/var/log/audit/audit.log</code> when access has been denied or an audit event has been specifically requested. </p><a class="anchor" id="AVC_Audit"></a>
<table class="doxtable">
<caption>Table 2-2. AVC Audit Message Description.</caption>
<tr>
<th align="left">Keyword</th><th align="left">Description </th></tr>
<tr>
<td>type</td><td>For SELinux AVC events:<br  />
<code>type = AVC</code> – for kernel events&lt;br&gt;<code>type = USER_AVC</code> – for user-space object manager events<br  />
The AVC event can always be tied to the relevant <code>SYSCALL</code> event as they have the same <code>serial_nmuber</code> in the <code>msg = audit (time: serial_number)</code> field </td></tr>
<tr>
<td>msg</td><td>Contains the audit keyword with a reference number (for example, <code>msg = audit(1243332701.74:101)</code>) </td></tr>
<tr>
<td>avc</td><td>Will be either denied when access has been <b>denied</b> or <b>granted</b> when an <code>audit allow</code> rule has been defined by the policy </td></tr>
<tr>
<td>pid</td><td rowspan="2">If it is a task, log the process ID (pid) and the name of the executable file (comm) </td></tr>
<tr>
<td>comm </td></tr>
<tr>
<td>capability </td><td>If it is a capability event, log the identifier </td></tr>
<tr>
<td>path</td><td rowspan="4">If it is a file system event, log the relevant information. Note that the <code>name</code> field may not always be present </td></tr>
<tr>
<td>name </td></tr>
<tr>
<td>dev </td></tr>
<tr>
<td>ino </td></tr>
<tr>
<td>laddr</td><td rowspan="4">If it is a socket event, log the source / destination address and ports for IP4 and IP6 sockets <code>AF_INET</code> </td></tr>
<tr>
<td>lport </td></tr>
<tr>
<td>faddr </td></tr>
<tr>
<td>fport </td></tr>
<tr>
<td>path</td><td>If it is a file socket event, log the path <code>AF_UNIX</code> </td></tr>
<tr>
<td>saddr</td><td rowspan="5">If it is a network event, log the source / destination addresses and ports with the network interface for IP4 or IP6 networks <code>AF_INET</code> </td></tr>
<tr>
<td>src </td></tr>
<tr>
<td>daddr </td></tr>
<tr>
<td>dest </td></tr>
<tr>
<td>netif </td></tr>
<tr>
<td>sauid</td><td rowspan="4">IPSec security association identifiers </td></tr>
<tr>
<td>hostname </td></tr>
<tr>
<td>addr </td></tr>
<tr>
<td>terminal </td></tr>
<tr>
<td>resid</td><td rowspan="2">X-Windows resource ID and type </td></tr>
<tr>
<td>restype </td></tr>
<tr>
<td>scontext</td><td>The security context of the source or subject </td></tr>
<tr>
<td>tcontext</td><td>The security context of the target or object </td></tr>
<tr>
<td>tclass</td><td>The object class of the target or object </td></tr>
</table>
<p >The following is an <code>audit.log</code> example: </p><div class="fragment"><div class="line">type=AVC msg=audit(1242575005.122:101): avc: denied { rename } for pid=2508</div>
<div class="line">comm=<span class="stringliteral">&quot;canberra-gtk-pl&quot;</span> name=<span class="stringliteral">&quot;c73a516004b572d8c845c74c49b2511d:runtime.tmp&quot;</span></div>
<div class="line">dev=dm-0 ino=188999 scontext=test_u:staff_r:oddjob_mkhomedir_t:s0</div>
<div class="line">tcontext=test_u:object_r:gnome_home_t:s0 tclass=lnk_file</div>
<div class="line">type=AVC msg=audit(1242575005.122:101): avc: denied { unlink } for pid=2508</div>
<div class="line">comm=<span class="stringliteral">&quot;canberra-gtk-pl&quot;</span> name=<span class="stringliteral">&quot;c73a516004b572d8c845c74c49b2511d:runtime&quot;</span> dev=dm-0</div>
<div class="line">ino=188578 scontext=test_u:staff_r:oddjob_mkhomedir_t:s0</div>
<div class="line">tcontext=system_u:object_r:gnome_home_t:s0 tclass=lnk_file</div>
<div class="line">type=SYSCALL msg=audit(1242575005.122:101): arch=40000003 syscall=38 success=yes</div>
<div class="line">exit=0 a0=82d2760 a1=82d2850 a2=da6660 a3=82cb550 items=0 ppid=2179 pid=2508</div>
<div class="line">auid=500 uid=500 gid=500 euid=500 suid=500 fsuid=500 egid=500 sgid=500 fsgid=500</div>
<div class="line">tty=(none) ses=1 comm=<span class="stringliteral">&quot;canberra-gtk-pl&quot;</span> exe=<span class="stringliteral">&quot;/usr/bin/canberra-gtk-play&quot;</span></div>
<div class="line">subj=test_u:staff_r:oddjob_mkhomedir_t:s0 key=(null)</div>
</div><!-- fragment --><h2><a class="anchor" id="selinux_amba_user_guide"></a>
2.2 SELinux User Guide for Ambarella</h2>
<h3><a class="anchor" id="amba_selinux_support"></a>
2.2.1 Ambarella SELinux Support</h3>
<p >Currently, only EXT4 can completely support SELinux (label with XATTR and change it). UBIFS can label XATTR, but cannot change it. </p><dl class="section note"><dt>Note</dt><dd>Only embedded multi-media card (eMMC) storage can support the EXT4 file system.</dd></dl>
<h3><a class="anchor" id="enable_selinux_on_amba"></a>
2.2.2 Enable SELinux on the Ambarella Platform</h3>
<p >There are two methods for configuring SELinux on the Ambarella platform: using the default configuration by Ambarella or manually setting up the SELinux configuration.</p>
<p ><b>Use the Default Configuration</b><br  />
 Ambarella offers a default configuration to set up SELinux. Follow the steps below to set up the SELinux configuration: </p><div class="fragment"><div class="line">build$ make sync_build_mkcfg</div>
<div class="line">build$ make xxxxx_selinux_config</div>
<div class="line">build$ make defconfig_pulbic_linux</div>
<div class="line">build$ make –j16</div>
</div><!-- fragment --><p ><b>Setting Up SELinux Configuration Manually</b> SELinux can be set up manually. Follow the steps below to set up SELinux in menuconfig: </p><div class="fragment"><div class="line">build$ make linux_menuconfig</div>
<div class="line">       &gt; General steps</div>
<div class="line">        &gt; Auditing support</div>
<div class="line">       &gt; Security options</div>
<div class="line">        &gt; Enable different security models</div>
<div class="line">        &gt; Enable the securityfs filesystem</div>
<div class="line">        &gt; Socket and Networking Security Hooks</div>
<div class="line">        &gt; NSA SELinux support</div>
<div class="line">        &gt; NSA SELinux boot parameter</div>
<div class="line">        &gt; NSA SELinux runtime disable</div>
<div class="line">        &gt; NSA SELinux Development Support</div>
<div class="line">        &gt; NSA SELinux AVC Statistics</div>
<div class="line">        &gt; (1)NSA SELinux checkreqprot <span class="keywordflow">default</span> value</div>
<div class="line">        &gt; First legacy <span class="stringliteral">&#39;major LSM&#39;</span> to be initialized (SELinux)</div>
<div class="line">        &gt; (lockdown,yama,loadpin,safesetid,integrity, selinux) Ordered list of enabled LSMs</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>If using SELinux with the UBIFS file system, in "File systems", select "UBIFS XATTR support" in "Miscellaneous file systems".</dd></dl>
<div class="fragment"><div class="line">build$ make menuconfig</div>
<div class="line">       &gt; prebuild</div>
<div class="line">        &gt; oss</div>
<div class="line">         &gt; -*- prebuild-audit (prebuild/oss/armv8-a/audit)</div>
<div class="line">          &gt; [*]   Add audit service into root_fs</div>
<div class="line">         &gt; [*] prebuild-policycoreutils (prebuild/oss/armv8-a/policycoreutils)</div>
<div class="line">          &gt; [*]   SELINUX policy from Fedora system</div>
<div class="line">          &gt; [*]   Add restorecond service into root_fs</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>When using the UBIFS file system, in <code>rootfs -&gt; rootfs</code>, select <code>Initialize file labeling with XATTR</code>. For SELinux, if the SELinux <code>file_context</code> file must be changed, then change the file context address.</dd></dl>
<h3><a class="anchor" id="selinux_command"></a>
2.2.3 SELinux Commands</h3>
<p ><b>Print Security Context</b><br  />
 The command <code>-Z</code> is used to print the security context for the file <code>/process/user</code>.</p>
<p >For example: </p><div class="fragment"><div class="line">board# ls -Z</div>
<div class="line">       system_u:object_r:usr_t:s0       selinux_test.txt</div>
<div class="line">board# <span class="keywordtype">id</span> -Z</div>
<div class="line">       system_u:system_r:local_login_t:s0-s0:c0.c1023</div>
<div class="line">board# ps -Z |grep nginx</div>
<div class="line">       system_u:system_r:httpd_t:s0          271 root      0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</div>
<div class="line">       system_u:system_r:httpd_t:s0          272 nginx     0:00 nginx: worker process</div>
<div class="line">       system_u:system_r:httpd_t:s0          273 nginx     0:00 nginx: worker process</div>
<div class="line">       system_u:system_r:httpd_t:s0          274 nginx     0:00 nginx: worker process</div>
<div class="line">       system_u:system_r:httpd_t:s0          275 nginx     0:00 nginx: worker process</div>
</div><!-- fragment --><p ><b>Get the SELinux Status</b><br  />
 <code>sestatus</code> is used to obtain the status of the system running SELinux.</p><ul>
<li>Usage: <code>sestatus [OPTION]</code></li>
<li><code>-v</code>: verbose check of process and file contexts</li>
<li><code>-b</code>: display the current state of Booleans</li>
<li>If there are no options, <code>sestatus</code> displays the SELinux status</li>
</ul>
<p >For example: </p><div class="fragment"><div class="line">board# sestatus</div>
<div class="line">       SELinux status:                 enabled</div>
<div class="line">       SELinuxfs mount:                /sys/fs/selinux</div>
<div class="line">       SELinux root directory:         /etc/selinux</div>
<div class="line">       Loaded policy name:             targeted</div>
<div class="line">       Current mode:                   permissive</div>
<div class="line">       Mode from config file:          permissive</div>
<div class="line">       Policy MLS status:              enabled</div>
<div class="line">       Policy deny_unknown status:     allowed</div>
<div class="line">       Memory protection checking:     requested (insecure)</div>
<div class="line">       Max kernel policy version:      31</div>
<div class="line"> </div>
<div class="line">&lt;b&gt;Get and Modify SELinux Mode&lt;/b&gt;&lt;br&gt;</div>
<div class="line">`getenforce` is used to get the mode SELinux is running in.  `setenforce` is used to modify the mode SELinux is running in.</div>
<div class="line">Use `Enforcing` or `1` to put SELinux in enforcing mode.  Use `Permissive` or `0` to put SELinux in permissive mode.</div>
<div class="line">For example:</div>
<div class="line">@code</div>
<div class="line">board# getenforce</div>
<div class="line">       Permissive</div>
<div class="line">board# setenforce 1</div>
<div class="line">board# getenforce</div>
<div class="line">       Enforcing</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>SELinux mode changes using <code>setenforce</code>, which is recovered after a reboot. If users want to change the SELinux mode permanently or disable SELinux, they must modify <code>/etc/selinux/config</code>. For more information, refer to <a class="el" href="../../db/d12/system_reinforcement.html#selinux_config_files">2.2.4 SELinux Configuration Files</a>.</dd></dl>
<p><b>Change the Security Context</b><br  />
 <code>chcon</code> is used to change the security context. </p><div class="fragment"><div class="line">Usage: chcon [OPTIONS] CONTEXT FILE...</div>
<div class="line">        chcon [OPTIONS] [-u USER] [-r ROLE] [-l RANGE] [-t TYPE] FILE...</div>
<div class="line">        chcon [OPTIONS] --reference=RFILE FILE...</div>
<div class="line">        -v      Verbose</div>
<div class="line">        -c      Report changes made</div>
<div class="line">        -h      Affect symlinks instead of their targets</div>
<div class="line">        -f      Suppress most error messages</div>
<div class="line">        --reference RFILE  Use RFILE<span class="stringliteral">&#39;s group instead of using a CONTEXT value</span></div>
<div class="line"><span class="stringliteral">        -u USER  Set user/role/type/range in the target security context</span></div>
<div class="line"><span class="stringliteral">        -r ROLE</span></div>
<div class="line"><span class="stringliteral">        -t TYPE</span></div>
<div class="line"><span class="stringliteral">        -l RNG</span></div>
<div class="line"><span class="stringliteral">        -R      Recurse</span></div>
</div><!-- fragment --><p> For example: </p><div class="fragment"><div class="line">board# ls -Z</div>
<div class="line">       system_u:object_r:admin_home_t:s0 selinux_test.txt</div>
<div class="line">board# chcon -t usr_t selinux_test.txt</div>
<div class="line">board# ls -Z</div>
<div class="line">       system_u:object_r:usr_t:s0       selinux_test.txt</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>Only an eMMC board with an EXT4 file system can change the security context.</dd></dl>
<h3><a class="anchor" id="selinux_config_files"></a>
2.2.4 SELinux Configuration Files</h3>
<p >This configuration file controls the SELinux state; it is located in <code>/etc/selinux/config</code>. It uses the following parameters: </p><div class="fragment"><div class="line">SELINUX=enforcing|permissive|disabled</div>
<div class="line">SELINUXTYPE=policy_name</div>
</div><!-- fragment --><p >Editing the value in this file can change the SELinux state, as follows: </p><a class="anchor" id="selinux_config_values"></a>
<table class="doxtable">
<caption>Table 2-3. /etc/selinux/config Values.</caption>
<tr>
<th align="left">SELinux</th><th align="left">SELinux Type </th></tr>
<tr>
<td>This entry can contain one of three values:<br  />
 <b>Enforcing</b>: SELinux security policy is enforced<br  />
 <b>Permissive</b>: SELinux logs warnings instead of enforcing the policy<br  />
 <b>Disabled</b>: No SELinux policy is loaded </td><td>The <code>policy_name</code> is used as the directory name where the active policy and its configuration files will locate and load the policy contained within this directory structure.<br  />
 <code>/etc/selinux/&lt;policy_name&gt;</code> </td></tr>
</table>
<h3><a class="anchor" id="policy_config_files"></a>
2.2.5 Policy Configuration Files</h3>
<p >Each file discussed in this section is related to the policy name, as follows: <code>/etc/selinx/&lt;policy_name&gt;</code> (Ambarella uses <code>targeted</code> by default)</p><ul>
<li><code>Seusers</code><br  />
 The seusers file is used by login programs and maps the GNU / Linux user to the SELinux user. A typical login sequence would be as follows:<ul>
<li>Using the GNU / Linux <code>user_id</code>, look up the <code>seuser_id</code> from this file. If an entry cannot be found, use <code>__default__entry</code>.</li>
<li>To determine the remaining context to be used as the security context, read the <code>./contexts/users/[user_id]</code> file. If this file is not present, check for a default context in the <code>./contexts/default_contexts</code> file. If no default context is found, read the <code>./contexs/failsafe_context</code> file to enable a failed safe context to be set. Example of seusers file contents: <div class="fragment"><div class="line">system_u:system_u</div>
<div class="line">root:root</div>
<div class="line">__default__:user_u</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><code>Policy / policy.&lt;ver&gt;</code><br  />
 This is the binary policy file that is loaded into the kernel to enforce the policy.</li>
<li><code>Contexts / customizable_types</code><br  />
 The <code>customizable_types</code> file contains a list of types that will not be re-labeled by the <code>setfiles</code> or <code>restorecon</code> commands. The commands check this file before re-labeling and exclude those in the list unless the <code>–F</code> flag is used. Example of file contents: <div class="fragment"><div class="line">container_file_t</div>
<div class="line">sandbox_file_t</div>
<div class="line">svirt_image_t</div>
<div class="line">svirt_home_t</div>
<div class="line">svirt_sandbox_file_t</div>
<div class="line">virt_content_t</div>
<div class="line">httpd_user_htaccess_t</div>
<div class="line">httpd_user_script_exec_t</div>
<div class="line">httpd_user_rw_content_t</div>
<div class="line">httpd_user_ra_content_t</div>
<div class="line">httpd_user_content_t</div>
<div class="line">git_session_content_t</div>
<div class="line">home_bin_t</div>
<div class="line">user_tty_device_t</div>
</div><!-- fragment --></li>
<li><code>Contexts / default_contexts</code><br  />
 The <code>default_context</code> file is used by SELinux-aware applications that are required to set a security context for user processes (generally the login applications). The following is an example of <code>default_contexts</code> contents: <div class="fragment"><div class="line">system_r:crond_t:s0 system_r:system_crond_t:s0</div>
<div class="line">system_r:local_login_t:s0 user_r:user_t:s0</div>
<div class="line">system_r:remote_login_t:s0 user_r:user_t:s0</div>
<div class="line">system_r:sshd_t:s0 user_r:user_t:s0</div>
<div class="line">system_r:sulogin_t:s0 sysadm_r:sysadm_t:s0</div>
<div class="line">system_r:xdm_t:s0 user_r:user_t:s0</div>
</div><!-- fragment --></li>
<li><code>Contexts / Files / file_contexts</code><br  />
 The <code>file_contexts</code> file is used by a number of SELinux-aware commands (<code>setfiles</code>, <code>fixfiles</code>, <code>matchpatchcon</code>, and <code>restorecon</code>) to re-label either part or all of the file system. The format of the <code>file_context</code> file is as follows. Each line within the file consists of the following: <div class="fragment"><div class="line">pathname_regexp [file_type] opt_security_context</div>
</div><!-- fragment --> <a class="anchor" id="file_context_para"></a>
<table class="doxtable">
<caption>Table 2-4. Parameters for file_context</caption>
<tr>
<th align="left">pathname_regexp</th><th align="left">file_type</th><th align="left">opt_security_context </th></tr>
<tr>
<td>An entry that defines the path name that may be in the form of a regular expression </td><td>One of the following optional file_type entries:<br  />
-b: Block device<br  />
-c: Character device<br  />
-d: Directory<br  />
-p: Named pipe<br  />
-l: Symbolic link<br  />
-s: Socket file </td><td>This can be either:<br  />
 The security context<br  />
 A value of &lt;&lt;none&gt;&gt; can be used to indicate that matching files must not be re-labeled </td></tr>
</table>
</li>
</ul>
<p >The following is an example of <code>file_contexts</code> contents: </p><div class="fragment"><div class="line">/.* system_u:object_r:default_t:s0</div>
<div class="line">/[^/]+ -- system_u:object_r:etc_runtime_t:s0</div>
<div class="line">/a?quota\.(user|group) -- system_u:object_r:quota_db_t:s0</div>
<div class="line">/nsr(/.*)? system_u:object_r:var_t:s0</div>
<div class="line">/sys(/.*)? system_u:object_r:sysfs_t:s0</div>
<div class="line">...</div>
<div class="line">/etc/ntop.* system_u:object_r:ntop_etc_t:s0</div>
<div class="line">HOME_DIR/.+ system_u:object_r:user_home_t:s0</div>
<div class="line">/dev/dri/.+ -c system_u:object_r:dri_device_t:s0</div>
<div class="line">...</div>
<div class="line">/tmp/gconfd-USER -d system_u:object_r:user_tmp_t:s0</div>
<div class="line">...</div>
<div class="line">/tmp/gconfd-USER/.* -- system_u:object_r:gconf_tmp_t:s0</div>
<div class="line">...</div>
<div class="line">HOME_ROOT/\.journal &lt;&lt;none&gt;&gt;</div>
</div><!-- fragment --><h3><a class="anchor" id="customize_policy"></a>
2.2.6 Customize Policy</h3>
<p >Users can customize their own policy to fit their systems by adding a new SELinux module. <b>Create Module CIL Files</b><br  />
 To create a new module, create a <code>cil</code> file and write the rules: </p><div class="fragment"><div class="line">board# vi test_policy.cil</div>
<div class="line">      (allow systemd_logind_t init_var_lib_t (lnk_file (read)))</div>
</div><!-- fragment --><p> This rule indicates that when the source file is <code>system_logind_t</code>, the targeted file is <code>init_var_lib_t</code>, the object class is <code>lnk_file</code>, and the object permission is <code>read</code>. Thus, the operation is allowed.</p>
<p ><b>Install the Module</b><br  />
 Use the semodule <code>–i</code> to install the module: </p><div class="fragment"><div class="line">board# semodule –i test_policy.cil</div>
</div><!-- fragment --><p ><b>Update the Module</b><br  />
</p><ol type="1">
<li>Obtain <code>cil</code> files from the module (if the user already has the cil files, this step can be skipped). <div class="fragment"><div class="line">board# semodule -c --extract test_policy</div>
</div><!-- fragment --></li>
<li>Add the rules to the <code>cil</code> file. <div class="fragment"><div class="line">board# echo <span class="stringliteral">&#39;(allow systemd_rfkill_t init_var_lib_t (lnk_file (read)))&#39;</span> &gt;&gt; test_policy.cil</div>
</div><!-- fragment --></li>
<li>Install a new module. <div class="fragment"><div class="line">board#semodule –i test_policy.cil</div>
</div><!-- fragment --></li>
</ol>
<p ><b>Check the Policy</b><br  />
 Use <code>selinux_check_access</code> to determine if the rules have been written into the policy. </p><div class="fragment"><div class="line">board# selinux_check_access system_u:system_r:systemd_rfkill_t:s0   system_u:object_r:init_var_lib_t:s0 lnk_file read</div>
</div><!-- fragment --><p> If the module was not successfully installed, the following error message appears: </p><div class="fragment"><div class="line">avc:  denied  { read } <span class="keywordflow">for</span>  scontext=system_u:system_r:systemd_rfkill_t:s0 tcontext=system_u:object_r:iit_var_lib_t:s0 tclass=lnk_file permissive=1</div>
</div><!-- fragment --><h1><a class="anchor" id="tee_and_trustzone"></a>
3. TEE and Arm TrustZone</h1>
<p >TEE is a specification / standard from GlobalPlatform (GP), a non-profit industry association. One of TEE’s implementations is Arm TrustZone. For more information about GP, visit the following link: <a href="https://globalplatform.org/">https://globalplatform.org/</a>. TEE specification can be found here: <a href="https://globalplatform.org/specs-library/">https://globalplatform.org/specs-library/</a>?filter-committee=tee For more information about TEE programming, users can refer to TEE API and TEE client API specifications as follows: <em>GPD_TEE_Internal_Core_API_Specification_v1.3.1_PublicRelease_CC.pdf</em> and <em>TEE_Client_API_Specification-V1.0_c.pdf</em></p>
<h2><a class="anchor" id="arm_trustzone"></a>
3.1. Arm® TrustZone®</h2>
<p >Arm TrustZone technology offers an efficient, system-wide approach to security with hardware-enforced isolation built into the CPU. TrustZone provides the perfect starting point for establishing a device root of trust (RoT) based on platform security architecture (PSA) guidelines. For more information, visit <a href="https://www.arm.com/technologies/trustzone-for-cortex-a">https://www.arm.com/technologies/trustzone-for-cortex-a</a>. <a class="anchor" id="The_System_Diagram_of_Arm_TrustZone"></a></p><div class="image">
<img src="../../sys_diag_of_arm_trustzone.png" alt=""/>
<div class="caption">
Figure 3.1. System Diagram of Arm TrustZone</div></div>
<p> On Ambarella platforms, Arm TrustZone can be enabled in the flexible Linux SDK. In the flexible Linux SDK, Linux functions as the rich OS, the open portable trusted execution environment (OP-TEE) as the trusted operating system (TOS), and Arm trusted firmware (ATF) as the trusted firmware / secure monitor. The hypervisor and multiple-rich OS are not implemented in the SDK. The following diagram illustrates Arm TrustZone in the Ambarella Flexible Linux SDK. <a class="anchor" id="Arm_TrustZone_in_Linux_SDK"></a></p><div class="image">
<img src="../../arm_trustzone_in_linux_sdk.png" alt=""/>
<div class="caption">
Figure 3.2 Arm TrustZone in Linux SDK</div></div>
<h2><a class="anchor" id="arm_trusted_firmware"></a>
3.2. Arm Trusted Firmware</h2>
<p >ATF is the reference software for Arm TrustZone. It implements a secure monitor, which manages the switch between the normal world (rich OS) and the secure world (secure OS). ATF also implements authentication during the boot stage (secure boot). During this process, the Ambarella Linux SDK employs a partial authentication chain for secure boot via the built-in hardware engine: BL2 authenticates BL31, BL32, and BL33.</p>
<h2><a class="anchor" id="op_tee"></a>
3.3. OP-TEE</h2>
<p >OP-TEE is an open source project, which implements the GlobalPlatform TEE system architecture specifications and serves as a TOS. OP-TEE provides the TEE application programming interface (API) and the TEE client API, and implements a TEE-suppliant. The TEE API, as defined by the GlobalPlatform TEE standard, is for the development of trusted applications (TAs). The TOS is accessible from the rich OS (Linux) using the GlobalPlatform TEE client API specification. The TEE client API is used to trigger the secure execution of applications within the TEE. The TEE-supplicant loads the TA from the rich OS into the secure OS for execution. The following diagram shows the software stack of Arm TrustZone (Linux, OP-TEE, and ATF).</p>
<p ><a class="anchor" id="The_Software_Stack_of_a_TrustZone"></a></p><div class="image">
<img src="../../sw_stack_of_trustzone.png" alt=""/>
<div class="caption">
Figure 3.3 Software Stack of TrustZone (Linux, OP-TEE, and ATF)</div></div>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Refer to <a href="https://www.op-tee.org/">https://www.op-tee.org/</a> to access the OP-TEE home page.<br  />
</li>
<li>Refer to <a href="https://github.com/OP-TEE/">https://github.com/OP-TEE/</a> to access the project.<br  />
</li>
<li>Refer to <a href="https://optee.readthedocs.io/">https://optee.readthedocs.io/</a> to check OP-TEE documents.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="ta_and_ca"></a>
3.4. Trusted Application and Client Application</h2>
<p >The TA functions in the secure world in OP-TEE. It can be a user TA, which operates in the TEE user space, or a pseudo TA (PTA), which operates in the TEE kernel space. The user TA includes a signature and resides in the normal world storage. The PTA is embedded in the trusted OS (OP-TEE-OS). Each TA includes a universally unique identifier (UUID) as its identity. When a normal TA is requested, it is loaded by a TEE-supplicant in rich the OS and conveyed to the secure world after the digital signature has been verified. The client application (CA) functions in the normal world. The SDK locations for the modules are as follows:</p><ul>
<li>TEE_Client_API: <code>SDK/ambarella/boot/tee/optee_client/libteec</code></li>
<li>RPC service: <code>SDK/ambarella/boot/tee/optee_client/tee-supplicant</code></li>
<li>OP-TEE driver: <code>SDK/ambarella/kernel/linux-5.15/drivers/tee/optee</code></li>
<li>TEE_Internal_API: <code>SDK/ambarella/boot/tee/optee_os/lib/libutee/include</code> OP-TEE’s user TAs are signed by <code>SDK/ambarella/boot/tee/optee_os/keys/default_ta.pem</code>. <dl class="section note"><dt>Note</dt><dd>Each TA in the secure world should include a UUID to enable the CA application to locate it through the TEE API in the normal world.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="source_code_location_in_sdk"></a>
3.5 Source Code Location in the SDK Package</h2>
<p >The following lists locations of the source files.</p><ul>
<li>ATF: <code>SDK/ambarella/boot/tee/arm-trusted-firmware</code></li>
<li>Cryptography library: <code>SDK/ambarella/boot/tee/mbedtls</code></li>
<li>OP-TEE_OS: <code>SDK/ambarella/boot/tee/optee_os</code></li>
<li>OP-TEE_Client: <code>SDK/ambarella/boot/tee/optee_client</code></li>
<li>OP-TEE_Test: <code>SDK/ambarella/boot/tee/optee_test</code></li>
</ul>
<h1><a class="anchor" id="anti_rollback"></a>
4. Anti-Rollback</h1>
<p >To prevent the software version from being rolled backed by a hacker (a method used by hackers to exploit known security vulnerabilities in older software versions), the Ambarella CV5x / CV7x series provides a hardware monotonic counter, which can be used for anti-rollback.</p>
<h1><a class="anchor" id="disable_hw_debug_port"></a>
5. Disable the Hardware Debug Port</h1>
<p >Ambarella recommends removing or disabling hardware debug ports, including force USB boot and joint test action group (JTAG). On CV5x, force USB boot is disabled when secure boot is enabled. Additionally, there is an eFUSE bit that can be used to disable JTAG.</p>
<h1><a class="anchor" id="disable_no_secure_protocol"></a>
6. Disable the Non-Secure Protocol / Port</h1>
<p >Ambarella recommends disabling all ports for non-secure protocols. The following is a widely used, non-secure protocol list: Telnet (port 23), file transfer protocol (FTP) (port 21), trivial file transfer protocol (TFTP) (port 69), hypertext transfer protocol (HTTP) (port 80), and system gateway (port 19531). For remote login, secure shell (SSH) is more secure than Telnet and HTTPS is more secure than HTTP. The following command enables users to check what port is opened using the portscan tool, <code>nmap</code>: </p><div class="fragment"><div class="line"><span class="preprocessor">#apt-get install nmap</span></div>
<div class="line">nmap -A 10.0.0.2</div>
<div class="line">nmap -A –p1-65535 10.0.0.2</div>
</div><!-- fragment --><h1><a class="anchor" id="buffer_overflow_attack_resistance"></a>
7. Buffer Overflow Attack Resistance</h1>
<p >Hackers commonly use buffer overflow attacks. To resist a buffer overflow attack, Ambarella recommends that users enable the following items supported by the SDK. Additionally, users should remove / reduce software bugs, especially string manipulation functions. Users are forbidden from using unsafe string functions, such as <code>strcpy</code>, <code>strcat</code>, and <code>sprintf</code>. As an alternative, Ambarella recommends using <code>strncpy</code> and <code>snprintf</code>.</p>
<h2><a class="anchor" id="add_space_layout_randomization"></a>
7.1. Address Space Layout Randomization</h2>
<p >Address space layout randomization (ASLR) increases the difficulty of a buffer overflow attack. Linux supports ASLR. Use the command below to enable it on Ambarella chips: </p><div class="fragment"><div class="line">echo 2 &gt; /proc/sys/kernel/randomize_va_space</div>
</div><!-- fragment --><h2><a class="anchor" id="pos_independent_executable"></a>
7.2. Position Independent Executable</h2>
<p >Position independent executable (PIE) enables code to be executed at different places, thus increasing the difficulty of a buffer overflow attack. PIE is supported by the GNU compiler collection (GCC), as shown below: </p><div class="fragment"><div class="line">-fPIE -pie</div>
</div><!-- fragment --><h2><a class="anchor" id="no_execute_protect"></a>
7.3. No-eXecute Protect</h2>
<p >No-eXecute protect (NX) prevents execution on the no-execute part and is enabled, by default, in GCC. The following demonstrates how to enable and disable NX.</p><ul>
<li>Disable NX: <code>-z execstack</code></li>
<li>Enable NX: <code>-z noexecstack</code></li>
</ul>
<h2><a class="anchor" id="stack_protector"></a>
7.4. Stack Protector</h2>
<p >GCC supports stack protection. The compile option enables the stack protector.</p><ul>
<li>Protect functions that have string / char local variables: <code>-fstack-protector</code></li>
<li>Protect all functions: <code>-fstack-protector-all</code></li>
</ul>
<h2><a class="anchor" id="fortify"></a>
7.5. FORTIFY</h2>
<p >FORTIFY is a GCC feature that can be used for code and runtime checks if there is a potential buffer overflow risk.</p><ul>
<li>Buffer overflow check at the compile stage: <code>-D_FORTIFY_SOURCE=1</code></li>
<li>Buffer overflow check at both the compile and runtime stages: <code>-D_FORTIFY_SOURCE=2</code></li>
</ul>
<h2><a class="anchor" id="read_only_relocation"></a>
7.6. Read-Only Relocation</h2>
<p >GCC supports read-only relocation (RELRO), which means the relocation region is read-only. RELRO can increase the difficulty of a buffer overflow attack and can be used to protect the global offset table (GOT). By default, the RELRO setting is partial (partial RELRO means the GOT is writable).</p><ul>
<li>Disable RELRO: <code>-z norelro</code></li>
<li>Partial RELRO: <code>-z,relro -z lazy</code></li>
<li>Full RELRO: <code>-z,relro -z,now</code></li>
</ul>
<h1><a class="anchor" id="dram_scrambling"></a>
8. DRAM Scrambling</h1>
<p >Dynamic random-access memory (DRAM) scrambling is automatically enabled when secure boot is enabled; it is designed to prevent a potential sniffer on the physical DRAM memory.</p>
<h1><a class="anchor" id="cve_fix_strategy"></a>
9. CVE Fix Strategy</h1>
<p >Regarding CVE fixes, Ambarella synchronizes up to the latest version of the Linux kernel and open sourse software (OSS) modules, then provide the updates inside the SDK package (quarterly or bi-quarterly) for both Linux kernel and OSS module fixes. For these open source modules, Ambarella relies only on the community updates, but will not provide its own fixes for these modules. This is a general support rule of CVE fixes for all Cooper Linux SDK customers. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
