<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Peripherals: SD Card</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Peripherals"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Peripherals<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/da5/si_sd_card.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">SD Card </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The CV5x / CV7x evaluation kit (EVK) board has two secure digital (SD) interfaces: one slot is used for the SD card and the other is used for the micro SD card. The two SD slots are independent; they have their own SD controllers. The maximum frequency of the SD controller is 150 MHz.</p>
<h1><a class="anchor" id="uvc_cam_sd_slot"></a>
1. SD Slot</h1>
<p >The following figure shows the bottom of the CV5x EVK (Timn) board. </p><div class="image">
<img src="../../sd_slots_arch_v6.png" alt=""/>
<div class="caption">
Figure 1-1. SD Slots.</div></div>
<hr  />
<h1><a class="anchor" id="uvc_cam_sd_card_type"></a>
2. SD Card Type</h1>
<p >Secure digital is a non-volatile memory card format developed by the SD Card Association for use in portable devices. See <a href="https://www.sdcard.org/home/">https://www.sdcard.org/home/</a> for further details. Users can also refer to <a href="http://en.wikipedia.org/wiki/SD_card">http://en.wikipedia.org/wiki/SD_card</a> for SD card standards. </p><div class="image">
<img src="../../sd_sdhc_sdxc_mmc_cards_from_different_vendors.png" alt=""/>
<div class="caption">
Figure 2-1. SD / SDHC / SDXC / MMC Cards from Different Vendors.</div></div>
 <div class="image">
<img src="../../sd_pins_on_an_sd_card.png" alt=""/>
<div class="caption">
Figure 2-2. Pins on an SD Card.</div></div>
<p> If the application requires storing data continuously, Ambarella recommends using high speed / high quality SD cards. High speed / high quality SD cards write data in less time and require less CPU for input / output (I/O).<br  />
 The following sections provide information about SD card formats, speeds, and design notes. Ambarella does not recommend normal-speed SD cards, low-speed SD cards, low-speed multi-media controller (MMC) cards, or small-capacity SD cards for typical internet protocol camera (IPCAM) system designs or car DV designs. As an alternative, Ambarella recommends using SDHC class 4 (or above) for continuous data writing applications.<br  />
 If applications require long-time, continuous data writing, Ambarella recommends using SDHC class 4 or above for typical IP camera or car DV products.<br  />
 Although various SD cards might be usable for use with CV5x, only the SD cards in the following list are verified on the CV5x EVK board. </p><table class="doxtable">
<tr>
<th><div style="width:120px">Brand</div></th><th><div style="width:120px"></div>Class </th><th><div style="width:120px">Capacity</div></th><th><div style="width:120px"></div>Type  </th></tr>
<tr>
<td rowspan="6">Kingston </td></tr>
<tr>
<td>Normal</td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>MicroSD card </td></tr>
<tr>
<td></td><td>2 GB</td><td>SD card </td></tr>
<tr>
<td></td><td>4 GB</td><td>SD card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>SDHC card  </td></tr>
<tr>
<td rowspan="3">Kingmax </td></tr>
<tr>
<td>Normal</td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 6</td><td>4 GB</td><td>Micro-SDHC card  </td></tr>
<tr>
<td rowspan="6">SanDisk </td></tr>
<tr>
<td>Class 2</td><td>4 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Normal</td><td>512 MB</td><td>SD card </td></tr>
<tr>
<td>Class 2</td><td>4 GB</td><td>SDHC card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>SDHC card  </td></tr>
<tr>
<td rowspan="3">Toshiba </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 10</td><td>16 GB</td><td>SDHC card  </td></tr>
<tr>
<td rowspan="3">Apacer </td></tr>
<tr>
<td></td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>MicroSD card  </td></tr>
<tr>
<td rowspan="3">PNY </td></tr>
<tr>
<td></td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Class 4</td><td>4 GB</td><td>MicroSD card  </td></tr>
<tr>
<td>PQI</td><td></td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Esuninfo</td><td></td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Verbatim</td><td></td><td>2 GB</td><td>MicroSD card </td></tr>
<tr>
<td>SONY</td><td>Class 4</td><td>32 GB</td><td>MicroSD card </td></tr>
<tr>
<td>Lenovo</td><td></td><td>1 GB</td><td>SD card </td></tr>
<tr>
<td>Adata</td><td></td><td>256 MB</td><td>SD card </td></tr>
<tr>
<td rowspan="3">Transcend </td></tr>
<tr>
<td>Class 10</td><td>8 GB</td><td>SDHC card </td></tr>
<tr>
<td>Class 10</td><td>32 GB</td><td>SDHC card  </td></tr>
</table>
<p><br  />
</p>
<hr  />
<h1><a class="anchor" id="hardware_software_preparation"></a>
3. Hardware and Software Preparation</h1>
<h2><a class="anchor" id="cv5_evk"></a>
3.1 CV5 EVK</h2>
<p >For CV5, CONFIG_CV5_TIMN_SELECT_SD1 should be enabled for SDIO0, and CONFIG_CV5_TIMN_SELECT_SD2 should be enabled for SDIO1.<br  />
 For CV52, CONFIG_CV52_CRCO_SELECT_SD1 should be enabled for SDIO0, and CONFIG_CV52_CRCO_SELECT_SD2 should be enabled for SDIO1.<br  />
 For CV5 and CV52, SW2-1, SW2-2, and SW2-3 should be set to "off"; remove J18 and connect J16 when using SDIO0. SW2-4, SW3-1, and SW3-2 should be set to "off"; remove J24 and connect J22 when using SDIO1.</p>
<hr  />
<h1><a class="anchor" id="mount_format"></a>
4. Mount and Format</h1>
<h2><a class="anchor" id="mount_an_sd_card"></a>
4.1 Mount an SD Card</h2>
<p >The CV5x board recognizes the SD card after the card is inserted into the SD card slot, and it is automatically mounted to <code>/mnt/sdcard</code>. Enter mount on the CV5x board to see the mounting information. </p><div class="fragment"><div class="line">board # mount</div>
<div class="line">/dev/mmcblk0p1 on /sdcard type vfat</div>
<div class="line">(rw,relatime,fmask=0000,dmask=0000,allow_utime=0022,codepage=cp437,iocharset=iso8859-1,</div>
<div class="line">shortname=mixed,errors=remount-ro)</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>NTFS file system is not supported by default. To get NTFS-formatted SD cards recognized by the board, enable the kernel menuconfig in bellow: <div class="fragment"><div class="line">File systems</div>
<div class="line">    DOS/FAT/NT Filesystems</div>
<div class="line">        &lt;*&gt; NTFS file system support</div>
<div class="line">            [*]   NTFS write support</div>
</div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="unmount_an_sd_card"></a>
4.2 Unmount an SD Card</h2>
<p >Before removing the SD card, close all files, then unmount the SD card (see below). </p><div class="fragment"><div class="line">board # cd /</div>
<div class="line">board # umount /dev/mmcblk0p1</div>
</div><!-- fragment --><p> If the message "Device or resource busy" appears, check if all files on the SD card are closed and <code>/mnt/sdcard</code> is not being accessed (type "cd /" to go to the root directory).</p><ol type="1">
<li>Format the SD card. Although the SD card may arrive pre-formatted, Ambarella recommends formatting the card manually to avoid potential errors and to maximize performance.<br  />
 The SD card can be formatted to FAT32, NTFS, ext3, and other file systems. For SD cards equal to or less than 32 GB, FAT32 is recommended. For SD cards larger than 32 GB, NTFS is preferred, as Windows limits FAT32 partitions to 32 GB.<br  />
 Windows 7 also supports exFAT, but exFAT is not formally supported by the Linux kernel. Ext3 is supported on Linux to support large SDHC (or SDXC) cards, but Windows does not recognize ext3.<br  />
 There are three main options to format the SD cards to the required format. To successfully format an SD card, the write protection lock on the side of the card must be in the "unlock" position. SD mini and micro SD cards must be used with an adapter or specialized USB card reader when a computer is formatting them.</li>
<li>Use a format utility.<br  />
 Most computer systems include generic formatting utilities for nearly every format of writable media. For example, in the Windows operating system (OS), users can access the format option by right-clicking an "SD card" driver in the "My Computer" folder. Use the default setting to format the SD card.<br  />
 The SD Association SD Formatter is the recommended option for the Windows OS platform. The SD Formatter is recommended because generic-format utilities are not designed to format SD cards to their official SD memory format requirements that are required to run at optimum performance on devices. The SD formatter that the SD Association offers is free and is offered at SDcard.org: <a href="https://www.sdcard.org/downloads/formatter_3/">https://www.sdcard.org/downloads/formatter_3/</a>.</li>
<li>The tool "mkdosfs" is included in the CV5x Flexible Linux SDK.<br  />
 The tool can format an SD card to the FAT32 format, and is used to create a DOS file system under Linux. <div class="fragment"><div class="line">board # umount /dev/mmcblk0p1 (Unmount the SD card first)</div>
<div class="line">board # mkdosfs -v -n LOCAL /dev/mmcblk0p1</div>
<div class="line">board # mount /dev/mmcblk0p1 /tmp/mmcblk0p1</div>
</div><!-- fragment --> If users intend to use a SD card as common data storage, they must format the card in their product (under Linux) using mkdosfs in order to ensure optimal performance. An SD card that is formatted by a different tool on Windows can potentially result in lower performance.<br  />
</li>
<li>Check the file system integrity.<br  />
 The tool "dosfsck" is used to check and repair the MS-DOS file system. The source code of dosfs is available at <a href="http://ftp.uni-erlangen.de/pub/Linux/LOCAL/dosfstools/">http://ftp.uni-erlangen.de/pub/Linux/LOCAL/dosfstools/</a>. <div class="fragment"><div class="line">board # dsfsck /dev/mmcblk0p1</div>
</div><!-- fragment --> If the file system of the SD card is correct, the output message is as follows: <div class="fragment"><div class="line">dosfsck 2.11, 12 Mar 2005, FAT32, LFN</div>
<div class="line">/dev/mmcblk0p1: 1 files, 1/965792 clusters</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>If the SD card is removed before unmounting, users must check the integrity of the file system again before using the card. Removing the SD card before unmounting can cause inconsistent data storage and reduce the integrity of the file system. To avoid this potential issue, good product design should include unmounting the SD card before removing. Alternatively, it should call a poweroff command to enable the system to close all open files and flush data to sync, and then unmount.</dd></dl>
</li>
<li>Partition the SD card.<br  />
 Occasionally, users must partition the SD card. For example, if a user must format a 64-GB SDXC card to the FAT32 file system, note the following: because Windows limits FAT32 to 32 GB, multiple partitions are required. However, only the first partition can be seen on Windows while Linux can display all partitions.<br  />
 <b>Gparted</b> is a software utility that scans storage devices, examining the data in order to detect partitions which may exist but are absent from the disk's partition tables. For more details, go to <a href="http://gparted.sourceforge.net/">http://gparted.sourceforge.net/</a>. <dl class="section note"><dt>Note</dt><dd>If users must access all partitions in Windows, Ambarella does not recommend using the Linux tool to form the partition. As an alternative, users can attempt to port exFAT to Linux or use NTFS on the SD card to support large partitions that can be recognized on Windows.</dd></dl>
<br  />
</li>
</ol>
<hr  />
<h1><a class="anchor" id="write_performance"></a>
5. Write Performance</h1>
<p >In most applications, the SD card is used as local storage in which data is written. However, data write performance and I/O CPU usage is important; if the I/O CPU usage is too high, it can lead to write errors or other issues.<br  />
 Good write performance is achieved if the CPU load in the I/O operation is less than 20% (on average) in the top command when performing a continuous write to the SD card. If the write performance does not meet this average, it should be checked; reasons for less than optimal performance could include a slow SD card, too many concurrent read / write operations on the SD card, insufficient I/O memory buffer, or bad hardware design.</p><ol type="1">
<li>Check write performance.<br  />
 Check the SD card write performance using the command <b>dd</b>. The usage of dd can be found in the Linux user manual. <div class="fragment"><div class="line">board # time dd <span class="keywordflow">if</span>=/dev/zero of=/sdcard/write_tmp bs=1M <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>=128</div>
<div class="line">128+0 records in</div>
<div class="line">128+0 records out</div>
<div class="line">134217728 bytes (128.0MB) copied, 14.356227 seconds, 8.9<a class="code hl_defineRef" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>/s</div>
<div class="line">real 0m 14.36s</div>
<div class="line">user 0m 0.00s</div>
<div class="line">sys 0m 0.75s</div>
<div class="ttc" id="acJSON_8h_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div><div class="ttdeci">int count</div></div>
<div class="ttc" id="aiav__utils_8h_html_aa6b38d492364d98453284934ed7caee9"><div class="ttname"><a href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div><div class="ttdeci">#define MB</div></div>
</div><!-- fragment --> The results are shown above: the average writing speed is 128 MB / 14.36 s = 8.9 MB/s</li>
<li>Improve write performance:<br  />
 Users can optimize the writing method to improve the write performance of the FAT32 SD card. If each "write" syscall is in multiples of 16-KB sizes, the SD card can obtain a better write performance. For a larger SD card, 32 KB or 64 KB is preferred. A quick solution is to write in multiples of 64 KB to obtain optimal performance on all SD cards. If writing data of a random size, the FAT32 file system may include fragments. The fragments will be lower than the writing speed, and the I/O operation may require more CPU resources, affecting the overall write performance.<br  />
 The prototype of the write function is as follows: <div class="fragment"><div class="line">ssize_t write(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> count)</div>
</div><!-- fragment --> For the FAT32 file system, Ambarella suggests that the "count" is aligned to 64 KB in the code, meaning that if there is not enough data, it is preferred to place it into a queue and add data to increase the size to 64 KB.</li>
</ol>
<hr  />
<h1><a class="anchor" id="boot_from_rootfs_in_sd_card"></a>
6. Boot from Rootfs in the SD Card</h1>
<p >The size of rootfs can be very large, and flash may not have sufficient space to store it. In this case, users can use SD card to store rootfs.<br  />
 The following steps use the SD card as rootfs: the kernel is stored in the flash, and rootfs is stored in the SD card.</p>
<ol type="1">
<li>Change rootfs to the SD card. <div class="fragment"><div class="line">ambarella$ git diff</div>
<div class="line">diff --git a/rootfs/skeleton/initramfs_sysroot/init <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/rootfs/skeleton/initramfs_sysroot/init</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> 59e351b..563b58a 100755</div>
<div class="line">--- a/rootfs/skeleton/initramfs_sysroot/init</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/rootfs/skeleton/initramfs_sysroot/init</div>
<div class="line">@@ -9,6 +9,9 @@ SYSTEM_DEV=`echo ${CMDLINE##*root=}|awk <span class="stringliteral">&#39;{print $1}&#39;</span>`</div>
<div class="line"> SYSTEM_FSTYPE=`echo ${CMDLINE##*rootfstype=}|awk <span class="stringliteral">&#39;{print $1}&#39;</span>`</div>
<div class="line"> SYSTEM_MOUNT=/system</div>
<div class="line"> </div>
<div class="line">+SYSTEM_DEV=/dev/mmcblk0</div>
<div class="line">+SYSTEM_FSTYPE=ext4</div>
<div class="line">+</div>
<div class="line"> __clean_boot() {</div>
<div class="line">        exec /linuxrc</div>
<div class="line"> }</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
<div class="ttc" id="acJSON_8h_html_a750b5d744c39a06bfb13e6eb010e35d0"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a></div><div class="ttdeci">int index</div></div>
</div><!-- fragment --></li>
<li>Enable initramfs and build it (Amba build). <div class="fragment"><div class="line">build $ <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> build/env/amba-build.env</div>
<div class="line">build $ make ipcam_config</div>
<div class="line">build $ make menuconfig</div>
<div class="line">    rootfs  ---&gt;</div>
<div class="line">        [*] initramfs (rootfs/initramfs)  ---&gt;</div>
<div class="line">build $ make initramfs</div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div></div>
</div><!-- fragment --></li>
<li>Generate rootfs, whose type is <code>tar</code>. <div class="fragment"><div class="line">ambarella/metadata$ git diff</div>
<div class="line">diff --git a/meta-ambabsp/conf/machine/include/rootfs-type.inc <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/meta-ambabsp/conf/machine/include/rootfs-type.inc</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> f079b40..f54d7be 100644</div>
<div class="line">--- a/meta-ambabsp/conf/machine/include/rootfs-type.inc</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/meta-ambabsp/conf/machine/include/rootfs-type.inc</div>
<div class="line">@@ -144,5 +144,5 @@ python() {</div>
<div class="line">             comptype = <span class="stringliteral">&#39;-zst&#39;</span></div>
<div class="line">         fstype = fstype + comptype</div>
<div class="line"> </div>
<div class="line">-    d.setVar(<span class="stringliteral">&#39;IMAGE_FSTYPES&#39;</span>, fstype)</div>
<div class="line">+    d.setVar(<span class="stringliteral">&#39;IMAGE_FSTYPES&#39;</span>, <span class="stringliteral">&#39;%s tar&#39;</span> % (fstype))</div>
<div class="line"> }</div>
</div><!-- fragment --></li>
<li>Set the initramfs file path (Yocto build). <div class="fragment"><div class="line">build $ <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> build/env/yocto-build.env</div>
<div class="line">build $ make ipcam_config</div>
<div class="line">build $ make linux_menuconfig</div>
<div class="line">    search CONFIG_INITRAMFS_SOURCE</div>
<div class="line">    (/home/jleng/data/cooper_sdk/ambarella/out/amba_out/cv3_dk_mini/firmware/initramfs.cpio.gz) Initramfs source file(s)</div>
</div><!-- fragment --></li>
<li>Change the ext4 and MMC drivers to "built-in" instead of "module". <div class="fragment"><div class="line">build $ make linux_menuconfig</div>
<div class="line">    search CONFIG_EXT4_FS</div>
<div class="line">        &lt;*&gt; The Extended 4 (ext4) filesystem</div>
<div class="line">        [*] Use ext4 <span class="keywordflow">for</span> ext2 file systems</div>
<div class="line">        [*] Ext4 POSIX Access Control Lists</div>
<div class="line">        [*] Ext4 Security Labels</div>
<div class="line">        [ ] Ext4 debugging support</div>
<div class="line">        [ ] JBD2 (ext4) debugging support</div>
<div class="line">    search CONFIG_MMC</div>
<div class="line">        &lt;*&gt; MMC/SD/SDIO card support  ---&gt;</div>
<div class="line">            &lt; &gt; HW reset support <span class="keywordflow">for</span> eMMC</div>
<div class="line">            &lt; &gt; Simple HW reset support <span class="keywordflow">for</span> MMC</div>
<div class="line">            &lt;*&gt; MMC block device driver</div>
<div class="line">            (32) Number of minors per block device</div>
<div class="line">            &lt; &gt; SDIO UART/GPS class support</div>
<div class="line">            &lt; &gt; MMC host test driver</div>
<div class="line">                *** MMC/SD/SDIO Host Controller Drivers ***</div>
<div class="line">            [ ] MMC host drivers debugging</div>
<div class="line">            &lt;*&gt; Ambarella Media Processor SD/MMC Host Controller driver</div>
<div class="line">            &lt; &gt; ARM AMBA Multimedia Card Interface support</div>
<div class="line">            &lt;*&gt; Secure Digital Host Controller Interface support</div>
<div class="line">            &lt; &gt;     SDHCI support on PCI bus</div>
<div class="line">            &lt;*&gt;     SDHCI platform and OF driver helper</div>
<div class="line">            &lt; &gt;         SDHCI OF support for the Arasan SDHCI controllers</div>
<div class="line">            &lt; &gt;         SDHCI OF support for the ASPEED SDHCI controller</div>
<div class="line">            &lt; &gt;         SDHCI OF support for the Atmel SDMMC controller</div>
<div class="line">            &lt; &gt;         SDHCI OF support for the Synopsys DWC MSHC</div>
<div class="line">            &lt;*&gt;         SDHCI support for Ambarella DWC MSHC</div>
<div class="line">            &lt; &gt;         SDHCI support for the Cadence SD/SDIO/eMMC controller</div>
</div><!-- fragment --></li>
<li>Build ipcam-image and burn the image to the board. <div class="fragment"><div class="line">build $ make</div>
</div><!-- fragment --></li>
<li>Build ros rootfs. <div class="fragment"><div class="line">build $ make ipcam-image_clean</div>
<div class="line">build $ make ros-image</div>
</div><!-- fragment --></li>
<li>Untar rootfs.tar to the SD card. <div class="fragment"><div class="line">build $ sudo umount /dev/mmcblk0</div>
<div class="line">build $ sudo mkfs.ext4 /dev/mmcblk0</div>
<div class="line">build $ sudo mkdir -p /mnt/sd</div>
<div class="line">build $ sudo mount -t ext4 /dev/mmcblk0 /mnt/sd</div>
<div class="line">build $ sudo tar -xvpf images/ros-image-galactic-cv3x-20230721091753.rootfs.tar -C /mnt/sd</div>
</div><!-- fragment --></li>
<li>Insert the SD card to board and reboot it. The kernel is from the flash and rootfs is from the SD card.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li><code>/dev/mmcblk0</code> is the SD card device; the actual value depends on the user's system.</li>
<li>The rootfs of Amba build is different from Yocto build; it is <code>ambarella/out/amba_out/&lt;board&gt;/fakeroot</code></li>
</ul>
</dd></dl>
<hr  />
<h1><a class="anchor" id="troubleshooting"></a>
7. Troubleshooting</h1>
<p ><b>Question 1:</b> Why is the system boot speed too slow when using the customer’s board? It seems to be related to the SD card interrupt.<br  />
 <b>Answer:</b></p><ol type="1">
<li>Check the hardware design. If there is only one SD interface that is being used, and no secure digital input / output (SDIO) interface, check the SD configuration file.</li>
<li>To verify if the slow boot issue is caused by the SD card, do not insert ambarella_sd.ko. Remove the following line from <code>/etc/init.d/S11init</code>: <div class="fragment"><div class="line"><span class="keywordflow">if</span> [ -r /lib/modules/$kernel_ver/kernel/drivers/mmc/host/ambarella_sd.ko</div>
<div class="line">  modprobe ambarella_sd</div>
<div class="line">fi</div>
</div><!-- fragment --> If the issue is solved, the slow boot was a result of SD detection. If the issue is not solved, proceed to the next troubleshooting step.</li>
<li>Check if fixed_cd is floating.<br  />
 Ambarella recommends pulling down fixed_cd if SDIO WiFi is not used permanently.<br  />
 If SDIO WiFi is reserved for future use and fixed_cd is floating, disable SDIO WiFi detection on the software side.<br  />
 Modify <code>/etc/init.d/S11init</code> as follows: <div class="fragment"><div class="line"><span class="keywordflow">if</span> [ -r /lib/modules/$kernel_ver/kernel/drivers/mmc/host/ambarella_sd.ko</div>
<div class="line">    echo 0 &gt; cat /debug/mmc0/ambhost/fixed_cd</div>
<div class="line">    modprobe ambarella_sd</div>
<div class="line">fi</div>
</div><!-- fragment --></li>
</ol>
<p ><b>Question 2:</b> Why do I/O errors occur after the message: "ambarella_sd_request cmd25 timeout 2@100, retries" when recording to the SD card?<br  />
 <b>Answer:</b> cmd25 is WRITE_MULTIPLE_BLOCK. As the SD device is busy, no acknowledgement is passed after the defined time is out.<br  />
 Try the following solutions to solve this issue:</p><ol type="1">
<li>Use 12 MHz as the SD clock frequency.<br  />
 The SD clock quality is not good enough for some boards, which may lead SD cards to being unrecognized. Lowering the SD clock frequency fixes this issue.</li>
<li>Check the current SD clock frequency. <div class="fragment"><div class="line">board # grep sd /proc/ambarella/clock</div>
</div><!-- fragment --></li>
<li>Modify ambarella/boards/&lt;broad&gt;/bsp/&lt;broad&gt;.dts to use 12 MHz as the SD clock frequency. <div class="fragment"><div class="line">max-frequency = &lt;12000000&gt;;</div>
</div><!-- fragment --></li>
</ol>
<p ><b>Question 3:</b> Why do "out of memory" or "cannot allocate memory" errors appear when data is recorded to the SD card over a long period of time?<br  />
 <b>Answer:</b> Large amounts of memory are used to record streams to the SD card or perform intensive SD written tests. Therefore, the free memory may be insufficient for other applications. The errors mentioned above are caused when users attempt to use a large amount of memory.<br  />
 To avoid this issue, perform the following steps:</p><ol type="1">
<li>Dynamically allocate memory to create memory fragments, making further memory allocation difficult or impossible. Users should try allocating the memory consisting of large blocks to the applications, and manage the memory internally.</li>
<li>The kernel reserves a dedicated amount of memory for itself to process jobs. Release part of the memory to the user space.<br  />
 Check the memory size (20000 KB) reserved for the kernel. <div class="fragment"><div class="line">board # cat /proc/sys/vm/min_free_kbytes</div>
</div><!-- fragment --> Check the free memory size. <div class="fragment"><div class="line">board # top -d 1</div>
</div><!-- fragment --> Memory: 32488K used, 183572K free, 0K shared, 0K buffer, 13148K cached<br  />
 Edit /proc/sys/vm/min_free_kbytes. Note that the change will be forgotten after rebooting. <div class="fragment"><div class="line">board # echo 1024 &gt; /proc/sys/vm/min_free_kbytes</div>
</div><!-- fragment --> </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
