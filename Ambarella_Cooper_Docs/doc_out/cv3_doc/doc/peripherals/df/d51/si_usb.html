<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Peripherals: USB</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Peripherals"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Peripherals<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('df/d51/si_usb.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">USB </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The CV5x USB 3.2 Gen-2 port supports both device and host modes. The USB 2.0 port only supports device mode.</p>
<p >Device mode can be used to perform flash direct downloading, mass storage, virtual Ethernet device, and serial downloading. Host mode can be used to connect with USB storage, USB WiFi, and the USB mouse / keyboard.</p>
<h1><a class="anchor" id="usb_device"></a>
1. USB Device</h1>
<ol type="1">
<li>Set the USB to function on "device" mode. <div class="fragment"><div class="line">board # usb_role_switch.sh device</div>
<div class="line">[   33.795578] cdns-usb3 2020008000.cdns3: Rev: 00000204/00001c7d, eps: 00ff00ff, buff: 04000010/03000020</div>
</div><!-- fragment --></li>
<li>Confirm that the USB is functioning on "device" mode. <div class="fragment"><div class="line">board # cat cat /sys/<span class="keyword">class</span>/usb_role/2020008000.cdns3-role-<span class="keywordflow">switch</span>/role</div>
<div class="line">device</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="ud_usb_mass_storage"></a>
1.1 USB Device: USB Mass Storage</h2>
<p >The CV5x platform can use the free partition for a mass storage.<br  />
</p><ul>
<li>USB mass storage: USB storage requirements<ul>
<li>The CV5x platform</li>
<li>The USB storage driver (g_mass_storage.ko) <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers --&gt;</div>
<div class="line">    [*] USB supports --&gt;</div>
<div class="line">        &lt;M&gt; USB Mass Storage Support</div>
</div><!-- fragment --></li>
<li>Unused partition or space</li>
</ul>
</li>
<li>USB mass storage: testing the USB storage<ol type="1">
<li>Confirm that the USB is functioning on "device" mode and the module ambarella_udc is loaded into the system. <div class="fragment"><div class="line">board # usb_role_switch.sh device</div>
</div><!-- fragment --></li>
<li>The first time the USB is used as a mass storage device, confirm that the unused partition of the board will be used for storage. If it is not formatted to the correct file system, skip to Section <a class="el" href="../../d4/d64/si_fs.html#fs_ubi">1. UBIFS (Recommended)</a> to set up unsorted block image file system (UBIFS) on the partition and mount it to /mass_storage. If UBIFS is not directly supported by the PC, Vfat is required. Users can create a Vfat file system with the commands below.<br  />
 In the following commands, the storage size is 36 MB (storage size should be at least 32 MB). <div class="fragment"><div class="line">board # dd <span class="keywordflow">if</span>=/dev/zero of=/mass_storage/usb bs=1024 <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>=36864</div>
<div class="line">board # mkfs.vfat /mass_storage/usb</div>
<div class="ttc" id="acJSON_8h_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div><div class="ttdeci">int count</div></div>
</div><!-- fragment --></li>
<li>Load the USB storage module. <div class="fragment"><div class="line">board # modprobe g_mass_storage file=/mass_storage/usb stall=0 removable=1</div>
</div><!-- fragment --></li>
<li>Use the storage partition from the Windows PC or the CV5x platform (one user at a time). To use the storage from the PC, unmount it on the CV5x platform. To use storage on the CV5x platform, go to the PC and eject the device.<br  />
 To use the storage partition on the CV2x platform, use the following code: <div class="fragment"><div class="line">board # mkdir -p /tmp/usbdisk</div>
<div class="line">board # mount -t vfat /mass_storage/usb /tmp/usbdisk</div>
</div><!-- fragment --> To use the storage partition from Windows, connect the CV5x board to the PC via USB. The Windows PC will recognize the CV5x board as a mass storage device. <div class="fragment"><div class="line">board # umount /tmp/usbdisk</div>
<div class="line">(USB mass storage is located in /dev/mtdblock6).</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="ud_usb_ethernet_device"></a>
1.2 USB Device: USB Ethernet Device</h2>
<p >The CV5x platform USB can serve as a virtual Ethernet device.<br  />
</p><ul>
<li>USB Ethernet device: USB Ethernet device requirements<br  />
 The following components are required to test the USB Ethernet device with the Windows operating system (OS) host.<ul>
<li>Windows OS PC<br  />
 The USB driver (linux.inf)<br  />
 ambarella/kernel/linux/Documentation/usb/linux.inf<br  />
 The USB application (PortServer / ps.exe)</li>
<li>CV5x platform</li>
<li>Linux USB Ethernet / RNDIS gadget driver (g_ether.ko) <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers --&gt;</div>
<div class="line">    [*] USB supports --&gt;</div>
<div class="line">      &lt;*&gt; USB Gadget Support --&gt;</div>
<div class="line">        [*] Ethernet Control Model (CDC ECM)</div>
</div><!-- fragment --></li>
<li>The USB application (test_bsreader, test_stream)</li>
</ul>
</li>
<li>USB Ethernet device: test USB Ethernet device<br  />
 Transfer the video streams via USB as an Ethernet device using the following steps:<ol type="1">
<li>Verify that the USB cable is connected between the windows PC and the CV5x board.</li>
<li>Confirm that the USB is functioning in "device" mode and that the module ambarella_udc is loaded into the system. <div class="fragment"><div class="line">board # usb_role_switch.sh device</div>
<div class="line">ambarella_udc 40960 0</div>
</div><!-- fragment --></li>
<li>Log in to the CV5x board and load the module g_ether. <div class="fragment"><div class="line">board # modprobe g_ether</div>
<div class="line">[ 19.140000] g_ether gadget: <span class="keyword">using</span> random self ethernet address</div>
<div class="line">[ 19.140000] g_ether gadget: <span class="keyword">using</span> random host ethernet address</div>
<div class="line">[ 19.170000] usb0: MAC 52:d7:87:0c:65:82</div>
<div class="line">[ 19.170000] usb0: HOST MAC de:2<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>:af:57:03:96</div>
<div class="line">[ 19.210000] g_ether gadget: Ethernet Gadget, version: Memorial Day 2008</div>
<div class="line">[ 19.230000] g_ether gadget: g_ether ready</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --></li>
<li>The PC will discover the device Linux USB Ethernet / RNDIS Gadget. Install the driver (ambarella/kernel/linux/Documentation/usb/linux.inf) for the device. After installation, the PC will add a device to network adapters. Refer to the figure below. <div class="image">
<img src="../../usb_is_recognized_as_a_network_adapter_in_the_pc.png" alt=""/>
<div class="caption">
Figure 1-1. USB is Recognized as a Network Adapter in the PC.</div></div>
</li>
<li>Set up the IP address (for example, 10.0.1.1) for the Linux USB ethernet / RNDIS Gadget on the PC. Refer to the figure below.<br  />
 <div class="image">
<img src="../../usb_ip_address_of_linux_usb_ethernet_rndis_gadget_on_the_pc.png" alt=""/>
<div class="caption">
Figure 1-2. IP Address of Linux USB Ethernet / RNDIS Gadget on the PC.</div></div>
</li>
<li>Configure the USB0 IP address (for example, 10.0.1.10) on the CV5x board. <div class="fragment"><div class="line">board # ifconfig usb0 10.0.1.10 netmask 255.255.255.0</div>
<div class="line">borad # ping 10.0.1.1 (test connection between the board and PC)</div>
</div><!-- fragment --></li>
<li>Use USB as an Ethernet device. For example, run mediaserver via USB0 Ethernet. <div class="fragment"><div class="line">board # /etc/init.d/S99IPCamControlServer stop</div>
<div class="line">board # /etc/init.d/S98avahi-daemon stop</div>
</div><!-- fragment --> The example above is for the CV5x EVK board because the Avahi daemon will enable eth0 automatically if it finds eth0 down. <div class="fragment"><div class="line">board # ifconfig eth0 down</div>
<div class="line">board # rtspserver</div>
</div><!-- fragment --> Receive the streams VLC with the USB0 IP (for example, 10.0.1.10).</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="ud_usb_serial"></a>
1.4 USB Device: USB Serial</h2>
<p >The CV5x USB port can be used as a serial gadget to be a virtual serial port for the PC.<br  />
</p><ul>
<li>USB serial requirements<br  />
 The following components are required to test USB serial with a Window OS host.<br  />
<ul>
<li>Windows OS PC<br  />
 The USB driver (linux-cdc-acm.inf)<br  />
 ambarella/kernel/linux/Documentation/usb/linux-cdc-acm.inf</li>
<li>CV5x platform<br  />
 Linux USB Ethernet / RNDIS gadget driver (g_serial.ko) <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  Ambarella File System Configuration -&gt;</div>
<div class="line">     Serial Port Configuration -&gt;</div>
<div class="line">       [*] USB serial tty support</div>
<div class="line"> </div>
<div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers -&gt;</div>
<div class="line">    [*] USB support -&gt;</div>
<div class="line">      &lt;*&gt; USB Gadget Support -&gt;</div>
<div class="line">        [*] Serial support</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Test the USB serial<br  />
<ol type="1">
<li>Confirm that the USB is functioning in "device" mode and module ambarella_udc is loaded into the system. <div class="fragment"><div class="line">board # usb_role_switch.sh device</div>
<div class="line">ambarella_udc 40960 0</div>
</div><!-- fragment --> If the firmware is built with the configuration shown above, the USB gadget serial driver will be loaded automatically when the board boots. Skip this step and proceed to the next step.<br  />
 If the USB gadget serial driver is not loaded automatically, it must be installed manually. Users should ensure that they have <b>"g_serial.ko"</b> in <code>/lib/modules/5.10.61/kernel/drivers/usb/gadget/legacy</code>. <div class="fragment"><div class="line">board # modprobe g_serial</div>
<div class="line">[ 85.660148] g_serial gadget: Gadget Serial v2.4</div>
<div class="line">[ 85.664661] g_serial gadget: g_serial ready</div>
</div><!-- fragment --></li>
<li>After the gadget driver has been established, users should then see a <code>/dev/ttyGS0</code> node: <div class="fragment"><div class="line">board # ls -l /dev/ttyGS0 | cat</div>
<div class="line">crw--w---- 1 root root 250, 0 Jan 1 08:00 /dev/ttyGS0</div>
</div><!-- fragment --></li>
<li>Set up an <code>/etc/inittab</code> entry to run "getty". The <code>/dev/ttyGS0</code> line should be as follows: <div class="fragment"><div class="line">ttyGS0::respawn:/sbin/getty -L ttyGS0 115200 vt100</div>
</div><!-- fragment --></li>
<li>Install the Windows host abstract control model (ACM) driver.<br  />
 To use the Windows ACM driver, users must have the <code>linux-cdc-acm.inf</code> file (<code>ambarella/kernel/linux/Documentation/usb/</code>) which supports all recent versions of Windows.<br  />
 When the gadget serial driver is loaded and the USB device is connected to the Windows host with a USB cable, Windows will recognize the gadget serial device and ask for a driver. The driver can be found in the folder that contains the <code>linux-cdc-acm.inf</code> file.<br  />
 <b>Windows XP</b><br  />
 When the gadget serial device is first plugged in, the <b>Found New Hardware Wizard</b> starts up. Select <b>Install from a list or specific location (Advanced)</b>. Then, on the next screen, select <b>Include this location in the search</b> and enter the path or browse to the folder containing the <code>linux-cdc-acm.inf</code> file. Windows will display a warning that the gadget serial driver has not passed the Windows Logo testing, but users should select <b>Continue anyway</b> to finish the driver installation.<br  />
 <b>Windows 7</b><br  />
 When the gadget serial device is first plugged in, go to <b>Control Panel &gt; System &gt; Hardware &gt; Device Manager</b> and expand Other Devices. Right click on <b>Gadget Serial</b> entry and select <b>Update Driver Software</b>. Click <b>Browse my computer for driver software</b> and enter the path or browse to the folder containing the <code>linux-cdc-acm.inf</code> file. Select <b>Install the driver anyway</b> and finish the installation.<br  />
 In <b>Control Panel &gt; System &gt; Hardware &gt; Device Manager</b> expand the Ports (COM and LPT) entry. Users should see "Gadget Serial" listed as the driver for one of the COM ports (shown in the figure below).<br  />
 To uninstall the Windows XP driver for "Gadget Serial", right click on the <b>Gadget Serial</b> entry in the <b>Device Manager</b> and select <b>Uninstall</b>. <div class="image">
<img src="../../usb_gadget_serial_port.png" alt=""/>
<div class="caption">
Figure 1-3. Gadget Serial Port.</div></div>
</li>
<li>Test with PuTTy.<br  />
 The PuTTy console and PC settings must match the specifications below: <div class="fragment"><div class="line">Serial line: COM10 (Check the port number in <span class="stringliteral">&quot;Control Panel &gt; System &gt; Hardware</span></div>
<div class="line"><span class="stringliteral">&gt; Device &gt; Ports (COM &amp; LPT) &gt; ELMO GMAS&quot;</span>)</div>
<div class="line">Speed: 115200</div>
<div class="line">Date <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a>: 8</div>
<div class="line">Stop <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a>: 1</div>
<div class="line">Parity: None</div>
<div class="line">Flow control: None</div>
<div class="ttc" id="avin__init_8c_html_ad1e28a1a66a25529b0b61b9ca4e66d44"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#ad1e28a1a66a25529b0b61b9ca4e66d44">bits</a></div><div class="ttdeci">int bits</div></div>
</div><!-- fragment --> Verify that <b>AmbaUSB</b> is not in use while using USB as the serial port. If there is no print on the USB serial console, unplug the USB cable and plug in again. Before rebooting the board, disconnect the USB serial console.<br  />
 Users can test the "Gadget Serial" function as follows:<br  />
 First, in the debug console (always COMM1), type the information below: <div class="fragment"><div class="line">board # echo ambarella cv chip &gt; /dev/ttyGS0</div>
</div><!-- fragment --> <div class="image">
<img src="../../usb_gadget_serial_port_output_information.png" alt=""/>
<div class="caption">
Figure 1-4. Gadget Serial Port Output Information.</div></div>
</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="ud_troubleshooting"></a>
1.5 Troubleshooting</h2>
<p ><b>Question 1:</b> Is it possible for users to burn the code to flash when it is completely empty?<br  />
 <b>Answer:</b> Yes, it is possible to use the USB to perform those operations.</p>
<p ><b>Question 2:</b> The CV5x board is not responding, and the AMBoot shell cannot be accessed. How can the binary be burned to the board?<br  />
 <b>Answer:</b> Set the dual in-line package (DIP) switches to USB boot mode and upgrade the firmware directly.</p>
<p ><b>Question 3:</b> The system fails when the user tries to download the firmware using the USB. Why does the USB performance appear to be unstable?<br  />
 <b>Answer:</b> Ensure that the USB cable is good quality. Data transfer may be unreliable if the poor-quality USB cables are used. The cable in the photo below is an example of a suitable USB 2.0 cable. </p><div class="image">
<img src="../../usb_2.0_cable.png" alt=""/>
<div class="caption">
Figure 1-5. USB 2.0 Cable.</div></div>
<p ><b>Question 4:</b> Does the Cooper Software Development Kit (SDK) provide a USB driver on the platform? Is the USB device compatible with (insert device name here)?<br  />
 <b>Answer:</b> Yes. The USB driver for Linux can be found in the SDK Linux patch. The USB driver implementation is open to customers and used "AS IS". The data transfer speed and reliability are good. However, the USB driver is not designed as "video class" and the protocol is simple. Developers can choose to use the driver for applications if it is required.</p>
<p ><b>Question 5:</b> What does Ambarella recommend for burning firmware to flash in production?<br  />
 <b>Answer:</b> Use a USB. Ambarella suggests reserving four pins on the printed circuit board (PCB) for USB connections. Upgrading firmware using the USB has the following advantages:</p><ul>
<li>USB can burn codes to an empty NAND flash in production.</li>
<li>USB can download firmware to the board if the wrong codes have been burnt or if the system is unable to boot up.</li>
</ul>
<p ><b>Question 6:</b> While using the USB as an Ethernet device, the connection between the PC and the board is running normally. The ping is being received from each side. However, the rtsp_server shows the message "rtsp://0.0.0.0/stream1" which does not match the IP of USB0. Why are the streams not being viewed using this address?<br  />
 <b>Answer:</b> This is because the rtsp_server requires the default route to stream the video. Check the default route. </p><div class="fragment"><div class="line">board # route</div>
<div class="line">Kernel IP routing table</div>
<div class="line">Destination Gateway    Genmask       Flags Metric Ref Use Iface</div>
<div class="line">10.0.1.0    *          255.255.255.0 U     0      0   0 usb0</div>
<div class="line">127.0.0.0   *          255.0.0.0     U     0      0   0 lo</div>
<div class="line"><span class="keywordflow">default</span>     10.0.1.1   0.0.0.0       UG    0      0   0 usb0</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="usb_host"></a>
2. USB Host</h1>
<p >The usage of the CV5x USB host mode is shown below.</p><ol type="1">
<li>Set the USB to function in "host" mode. <div class="fragment"><div class="line">board # usb_role_switch.sh host</div>
<div class="line">Current usb role is device</div>
<div class="line">Try to set usb to host</div>
<div class="line">[  220.925708] usbcore: deregistering device driver usb</div>
<div class="line">[  220.930835] usbcore: deregistering <span class="keyword">interface </span>driver usbfs</div>
<div class="line">[  220.936401] usbcore: deregistering interface driver hub</div>
<div class="line">[  220.975505] usbcore: registered new interface driver usbfs</div>
<div class="line">[  220.981045] usbcore: registered new interface driver hub</div>
<div class="line">[  220.986482] usbcore: registered new device driver usb</div>
<div class="line">[  221.014036] xhci-hcd xhci-hcd.1.auto: xHCI Host Controller</div>
<div class="line">[  221.019566] xhci-hcd xhci-hcd.1.auto: new USB bus registered, assigned bus <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 1</div>
<div class="line">[  221.027628] xhci-hcd xhci-hcd.1.auto: hcc params 0x08007f0d hci version 0x110 quirks 0x0000002000018010</div>
<div class="line">[  221.037081] xhci-hcd xhci-hcd.1.auto: irq 97, io mem 0x2020008000</div>
<div class="line">[  221.043457] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 5.15</div>
<div class="line">[  221.051760] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1</div>
<div class="line">[  221.059006] usb usb1: Product: xHCI Host Controller</div>
<div class="line">[  221.063896] usb usb1: Manufacturer: Linux 5.15.55 xhci-hcd</div>
<div class="line">[  221.069396] usb usb1: SerialNumber: xhci-hcd.1.auto</div>
<div class="line">[  221.074448] hub 1-0:1.0: USB hub found</div>
<div class="line">[  221.078222] hub 1-0:1.0: 1 port detected</div>
<div class="line">[  221.082243] xhci-hcd xhci-hcd.1.auto: xHCI Host Controller</div>
<div class="line">[  221.087749] xhci-hcd xhci-hcd.1.auto: new USB bus registered, assigned bus <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 2</div>
<div class="line">[  221.095435] xhci-hcd xhci-hcd.1.auto: Host supports USB 3.1 Enhanced SuperSpeed</div>
<div class="line">[  221.102797] usb usb2: We don&#39;t know the algorithms for LPM for this host, disabling LPM.</div>
<div class="line">[  221.110942] usb usb2: New USB device found, idVendor=1d6b, idProduct=0003, bcdDevice= 5.15</div>
<div class="line">[  221.119235] usb usb2: New USB device strings: Mfr=3, Product=2, SerialNumber=1</div>
<div class="line">[  221.126480] usb usb2: Product: xHCI Host Controller</div>
<div class="line">[  221.131370] usb usb2: Manufacturer: Linux 5.15.55 xhci-hcd</div>
<div class="line">[  221.136870] usb usb2: SerialNumber: xhci-hcd.1.auto</div>
<div class="line">[  221.141866] hub 2-0:1.0: USB hub found</div>
<div class="line">[  221.145633] hub 2-0:1.0: 1 port detected</div>
<div class="line">[  221.319641] usb 1-1: new high-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 2 using xhci-hcd</div>
<div class="line">[  221.452158] usb 1-1: New USB device found, idVendor=0424, idProduct=2814, bcdDevice= 6.25</div>
<div class="line">[  221.460365] usb 1-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0</div>
<div class="line">[  221.467523] usb 1-1: Product: USB2814 Smart Hub</div>
<div class="line">[  221.472065] usb 1-1: Manufacturer: Microchip</div>
<div class="line">[  221.476670] hub 1-1:1.0: USB hub found</div>
<div class="line">[  221.480618] hub 1-1:1.0: 7 ports detected</div>
<div class="line">[  221.769641] usb 1-1.7: new high-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 3 using xhci-hcd</div>
<div class="line">[  221.864399] usb 1-1.7: New USB device found, idVendor=0424, idProduct=2840, bcdDevice= 2.04</div>
<div class="line">[  221.872781] usb 1-1.7: New USB device strings: Mfr=1, Product=2, SerialNumber=0</div>
<div class="line">[  221.880113] usb 1-1.7: Product: Hub Feature Controller</div>
<div class="line">[  221.885265] usb 1-1.7: Manufacturer: Microchip</div>
<div class="ttc" id="acJSON_8h_html_a01b4671c6b7cc8f831c951c000a37735"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a></div><div class="ttdeci">const char *const const double number</div></div>
</div><!-- fragment --></li>
<li>Confirm that the USB is functioning in "host" mode. <div class="fragment"><div class="line">board # cat /sys/<span class="keyword">class</span>/usb_role/2020008000.cdns3-role-<span class="keywordflow">switch</span>/role</div>
<div class="line">host</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="uh_support_usb_mass_storage_device"></a>
2.1 USB Host: Support USB Mass Storage Device</h2>
<ul>
<li>Support USB storage device: requirement<br  />
 CV5x platform <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers -&gt;</div>
<div class="line">    [*] USB support -&gt;</div>
<div class="line">      &lt;M&gt; Support <span class="keywordflow">for</span> Host-side USB</div>
<div class="line">      &lt;M&gt; USB Mass Storage support</div>
<div class="line"> </div>
<div class="line">File systems -&gt;</div>
<div class="line">  DOS/FAT/NT Filesystems -&gt;</div>
<div class="line">    &lt;*&gt; VFAT (Windows-95) fs support</div>
<div class="line">    &lt;*&gt; NTFS file system support</div>
<div class="line">    [*] NTFS write support</div>
</div><!-- fragment --></li>
<li>Support USB storage device: test steps<br  />
<ol type="1">
<li>Confirm that the USB is working in the "host" mode. <div class="fragment"><div class="line">board # usb_role_switch.sh host</div>
</div><!-- fragment --></li>
<li>Plug in the USB storage device. The kernel will add "sd_mod", "scsi_mod", and "usb_storage" modules automatically. Afterwards, it will detect the USB storage. <div class="fragment"><div class="line">[  169.086517] usb 1-1.2: <span class="keyword">new</span> high-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 4 <span class="keyword">using</span> xhci-hcd</div>
<div class="line">[  169.183451] usb 1-1.2: New USB device found, idVendor=05e3, idProduct=0747, bcdDevice= 8.19</div>
<div class="line">[  169.191831] usb 1-1.2: New USB device strings: Mfr=3, Product=4, SerialNumber=5</div>
<div class="line">[  169.199163] usb 1-1.2: Product: USB Storage</div>
<div class="line">[  169.203356] usb 1-1.2: Manufacturer: Generic</div>
<div class="line">[  169.207636] usb 1-1.2: SerialNumber: 000000000819</div>
<div class="line">[  169.227520] SCSI subsystem initialized</div>
<div class="line">[  169.236982] usb-storage 1-1.2:1.0: USB Mass Storage device detected</div>
<div class="line">[  169.243862] scsi host0: usb-storage 1-1.2:1.0</div>
<div class="line">[  169.248638] usbcore: registered <span class="keyword">new</span> <span class="keyword">interface </span>driver usb-storage</div>
<div class="line">[  170.278124] scsi 0:0:0:0: Direct-Access     Generic  STORAGE DEVICE   0819 PQ: 0 ANSI: 6</div>
<div class="line">[  170.697718] sd 0:0:0:0: [sda] 62333952 512-byte logical blocks: (31.9 GB/29.7 GiB)</div>
<div class="line">[  170.705937] sd 0:0:0:0: [sda] Write Protect is off</div>
<div class="line">[  170.711167] sd 0:0:0:0: [sda] Write cache: disabled, read cache: enabled, doesn&#39;t support DPO or FUA</div>
<div class="line">[  170.729780]  sda: sda1</div>
<div class="line">[  170.733539] sd 0:0:0:0: [sda] Attached SCSI removable disk</div>
</div><!-- fragment --></li>
<li>Find the device name of the USB storage device. <div class="fragment"><div class="line">board # fdisk -l</div>
<div class="line">Disk /dev/sda: 8011 <a class="code hl_defineRef" href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a>, 8011120640 bytes</div>
<div class="line">255 heads, 63 sectors/track, 973 cylinders, total 15646720 sectors</div>
<div class="line">Units = sectors of 1 * 512 = 512 bytes</div>
<div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div>
<div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div>
<div class="line">Disk identifier: 0xcad4ebea</div>
<div class="line"> </div>
<div class="line">Device Boot Start End Blocks Id System</div>
<div class="line">/dev/sda4 * 63 15646656 7823297 <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> W95 FAT32</div>
<div class="ttc" id="aiav__utils_8h_html_aa6b38d492364d98453284934ed7caee9"><div class="ttname"><a href="../../../driver/d6/d56/iav__utils_8h.html#aa6b38d492364d98453284934ed7caee9">MB</a></div><div class="ttdeci">#define MB</div></div>
</div><!-- fragment --></li>
<li>Mount the USB storage device. <div class="fragment"><div class="line">board # mkdir -p /tmp/usbstorage</div>
<div class="line">board # mount -t /dev/sda1 /tmp/usbstorage</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="uh_mouse_keyboard"></a>
2.2 USB Host: Mouse / Keyboard</h2>
<ul>
<li>Support for USB mouse / keyboard device: requirements<br  />
 CV5x platform <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers --&gt;</div>
<div class="line">    HID support --&gt;</div>
<div class="line">   {M} HID bus support</div>
<div class="line">   &lt;M&gt; Generic HID driver</div>
<div class="line">          USB HID support ---&gt;</div>
<div class="line">                  &lt;M&gt; USB HID transport layer</div>
</div><!-- fragment --></li>
<li>Support USB mouse / keyboard device: sample<br  />
<ol type="1">
<li>Confirm that the USB is functioning in "host" mode (possible parameter: <b>host device</b>). <div class="fragment"><div class="line">board # usb_role_switch.sh host</div>
</div><!-- fragment --></li>
<li>Plug in the USB mouse device. The kernel will recognize the device as follows: <div class="fragment"><div class="line">[  386.942517] usb 1-1.2: <span class="keyword">new</span> low-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 5 <span class="keyword">using</span> xhci-hcd</div>
<div class="line">[  387.041511] usb 1-1.2: New USB device found, idVendor=0461, idProduct=4d51, bcdDevice= 7.17</div>
<div class="line">[  387.049894] usb 1-1.2: New USB device strings: Mfr=0, Product=2, SerialNumber=0</div>
<div class="line">[  387.057317] usb 1-1.2: Product: DELL Laser Mouse</div>
<div class="line">[  387.078319] usbcore: registered <span class="keyword">new</span> <span class="keyword">interface </span>driver usbhid</div>
<div class="line">[  387.083928] usbhid: USB HID core driver</div>
<div class="line">[  387.089981] input: DELL Laser Mouse as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.0/0003:0461:4D51.0001/input/input0</div>
<div class="line">[  387.104852] hid-generic 0003:0461:4D51.0001: input: USB HID v1.11 Mouse [DELL Laser Mouse] on usb-xhci-hcd.1.auto-1.2/input0</div>
</div><!-- fragment --></li>
<li>Confirm the event interface of the USB mouse. <div class="fragment"><div class="line">board # cat /proc/bus/input/devices</div>
<div class="line">I: Bus=0003 Vendor=0461 Product=4d51 Version=0111</div>
<div class="line">N: Name=<span class="stringliteral">&quot;DELL Laser Mouse&quot;</span></div>
<div class="line">P: Phys=usb-xhci-hcd.1.auto-1.2/input0</div>
<div class="line">S: Sysfs=/devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.0/0003:0461:4D51.0001/input/input0</div>
<div class="line">U: Uniq=</div>
<div class="line">H: Handlers=mouse0 event0</div>
<div class="line">B: PROP=0</div>
<div class="line">B: EV=17</div>
<div class="line">B: KEY=1f0000 0 0 0 0</div>
<div class="line">B: REL=903</div>
<div class="line">B: MSC=10</div>
</div><!-- fragment --></li>
<li>Get the mouse event. <div class="fragment"><div class="line">board # cat /dev/input/event0</div>
</div><!-- fragment --> Or, <div class="fragment"><div class="line">board # cat /dev/input/mouse0</div>
</div><!-- fragment --></li>
<li>Plug in the USB keyboard device. The kernel will recognize the device and send the message as shown below: <div class="fragment"><div class="line">[  639.614517] usb 1-1.2: <span class="keyword">new</span> full-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 6 <span class="keyword">using</span> xhci-hcd</div>
<div class="line">[  639.709699] usb 1-1.2: New USB device found, idVendor=0483, idProduct=4025, bcdDevice= 0.00</div>
<div class="line">[  639.718082] usb 1-1.2: New USB device strings: Mfr=1, Product=2, SerialNumber=3</div>
<div class="line">[  639.725499] usb 1-1.2: Product: 69M-RGB</div>
<div class="line">[  639.729354] usb 1-1.2: Manufacturer: CATEX TECH.</div>
<div class="line">[  639.733987] usb 1-1.2: SerialNumber: CA2017091</div>
<div class="line">[  639.740994] input: CATEX TECH. 69M-RGB as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.0/0003:0483:4025.0002/input/input1</div>
<div class="line">[  639.807640] hid-<span class="keyword">generic</span> 0003:0483:4025.0002: input: USB HID v1.10 Keyboard [CATEX TECH. 69M-RGB] on usb-xhci-hcd.1.auto-1.2/input0</div>
<div class="line">[  639.820653] hid-<span class="keyword">generic</span> 0003:0483:4025.0003: device has no listeners, quitting</div>
<div class="line">[  639.829588] input: CATEX TECH. 69M-RGB Consumer Control as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.2/0003:0483:4025.0004/input/input2</div>
<div class="line">[  639.897730] input: CATEX TECH. 69M-RGB System Control as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.2/0003:0483:4025.0004/input/input3</div>
<div class="line">[  639.914229] input: CATEX TECH. 69M-RGB Keyboard as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.2/0003:0483:4025.0004/input/input4</div>
<div class="line">[  639.930201] input: CATEX TECH. 69M-RGB Mouse as /devices/platform/2020000000.cdns3/2020008000.cdns3/xhci-hcd.1.auto/usb1/1-1/1-1.2/1-1.2:1.2/0003:0483:4025.0004/input/input5</div>
<div class="line">[  639.945887] hid-<span class="keyword">generic</span> 0003:0483:4025.0004: input: USB HID v1.10 Keyboard [CATEX TECH. 69M-RGB] on usb-xhci-hcd.1.auto-1.2/input2</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="uh_support_usb_serial_device"></a>
2.3 USB Host: Support USB Serial Device</h2>
<ul>
<li>Support USB serial device: requirements<br  />
 CV5x platform<br  />
 The system and binary build: <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">   [*] USB support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Support <span class="keywordflow">for</span> Host-side USB</div>
<div class="line">      &lt;M&gt;   xHCI HCD (USB 3.0) support</div>
<div class="line">      [*]     xHCI support <span class="keywordflow">for</span> debug capability</div>
<div class="line">      -M-     Generic xHCI driver <span class="keywordflow">for</span> a platform device</div>
<div class="line">      &lt;M&gt;   USB Serial Converter support  ---&gt;</div>
<div class="line">      [*]   USB Generic Serial Driver</div>
</div><!-- fragment --></li>
<li>Support USB serial device: test steps<br  />
<ol type="1">
<li>Confirm that the USB is functioning in "host" mode (possible parameter: <b>host device</b>). <div class="fragment"><div class="line">board # usb_role_switch.sh host</div>
</div><!-- fragment --></li>
<li>Plug in the USB serial device. The kernel will add "usbserial" modules automatically and detect the USB serial device. <div class="fragment"><div class="line">board # [ 1165.438518] usb 1-1.2: <span class="keyword">new</span> full-speed USB device <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 7 <span class="keyword">using</span> xhci-hcd</div>
<div class="line">[ 1165.533156] usb 1-1.2: New USB device found, idVendor=067<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>, idProduct=2303, bcdDevice= 4.00</div>
<div class="line">[ 1165.541538] usb 1-1.2: New USB device strings: Mfr=1, Product=2, SerialNumber=0</div>
<div class="line">[ 1165.548871] usb 1-1.2: Product: USB-Serial Controller D</div>
<div class="line">[ 1165.554111] usb 1-1.2: Manufacturer: Prolific Technology Inc.</div>
<div class="line">...  ...  ...</div>
</div><!-- fragment --></li>
<li>Check the USB serial device. <div class="fragment"><div class="line">board # lsusb</div>
<div class="line"> Bus 001 Device 002: ID 067<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>:2303</div>
<div class="line"> Bus 001 Device 001: ID 1d6b:0001</div>
<div class="line"> Bus 002 Device 001: ID 1d6b:0002</div>
<div class="line">board # cat /dev/ttyUSB0</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="uh_support_usb_eye_diagram_testing"></a>
2.4 USB Host: HS Electrical Test (Eye Diagram)</h2>
<ul>
<li>Why do users require the eye diagram test? The USB eye diagram is the result of accumulating and displaying bits of the serial signal collected by the afterglow method. The shape of the superimposed image resembles an eye, so it is called the eye diagram test. According to the information of the eye diagram, the inter-symbol crosstalk and noise can be observed, reflecting the overall characteristics of the digital signal, so as to estimate the advantages and disadvantages of the system. Therefore, the eye diagram test is the core of signal integrity analysis of high-speed interconnection systems.</li>
<li>How do users test the eye diagram in the Ambarella evaluation kit (EVK)?<ol type="1">
<li>List of testing equipment<ul>
<li>Select any two EVK test boards with USB devices (one for USB host and one for USB device)</li>
<li>USB OTG cable</li>
<li>Micro USB cable</li>
<li>E2666B USB 2.0 hi-speed device test fixture kit (Agilent / Keysight test fixture)</li>
<li>Compatible oscilloscopes</li>
</ul>
</li>
<li>Configure the USB device EVK firmware. Then, burn them to the host EVK to be tested. <div class="fragment"><div class="line">build $ make defconfig_public_linux</div>
<div class="line">build $ make menuconfig_public_linux</div>
<div class="line">       Device Drivers ---&gt;</div>
<div class="line">           [*] USB support ---&gt;</div>
<div class="line">               USB EHSET Test Fixture driver</div>
</div><!-- fragment --></li>
<li>Set up the environemnt. <div class="image">
<img src="../../usb_eye_environment.png" alt=""/>
<div class="caption">
Figure 2-1. Ambarella USB Eye Diagram Environment Setting.</div></div>
</li>
<li>Follow the steps below for the test procedure.<ol type="a">
<li>Host: as the USB host, connect the micro-USB port to the test jig. <div class="fragment"><div class="line">board # echo host &gt; /proc/ambarella/usbphy0</div>
<div class="line">board # modprobe usbcore</div>
<div class="line">board # modprobe ehci-hcd</div>
<div class="line">board # modprobe ehci_ambarella</div>
<div class="line">board # modprobe ehset</div>
</div><!-- fragment --></li>
<li>Device: as USB device, connect the micro-USB port plug to the same test fixture (as a USB device-like dongle) <div class="fragment"><div class="line">board # echo device &gt; /proc/ambarella/usbphy0</div>
<div class="line">board # dd <span class="keywordflow">if</span>=/dev/zero of=/tmp/fsg bs=1M <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>=10</div>
<div class="line">board # modprobe g_mass_storage file=/tmp/fsg stall=0 removable=1 idVendor=0x1a0a idProduct=0x0104</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd><ul>
<li>Ensure that the EVK_host (as USB host) starts to output the USB test pattern. Check point: The host has identified the device. <div class="image">
<img src="../../usb_eye_host_result.png" alt=""/>
<div class="caption">
Figure 2-2 Ambarella USB Eye Diagram Test Result.</div></div>
</li>
<li>Switch the jig to test mode on the kit board.</li>
<li>After the negotiation between the host / device is complete and the test mode is sent, the user can unplug the EVK_host (as a USB device).</li>
<li>The system must be rebooted and commands must be repeated if the user wants to start a new test product identifier (PID).</li>
<li>This test is only for the direct USB port on the Ambarella chip, not the USB HUB ports. For HUB ports test, ask the USB HUB vendor for help.</li>
<li>Do not connect other USB devices during the eye diagram test to avoid interference.</li>
</ul>
</dd></dl>
</li>
</ol>
</li>
<li>Conclusion <div class="image">
<img src="../../usb_eye_diagram.png" alt=""/>
<div class="caption">
Figure 2-3. Ambarella USB Eye Diagram.</div></div>
</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="uh_support_usb_uvc_camera_device"></a>
2.5 USB Host: Support USB UVC Camera Device</h2>
<ul>
<li>Support USB UVC camera device: requirements<br  />
 For the CV5 platform:<br  />
 <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">   Device Drivers ---&gt;</div>
<div class="line">    [*] USB support ---&gt;</div>
<div class="line">           &lt;M&gt; Support <span class="keywordflow">for</span> Host-side USB</div>
<div class="line">           &lt;M&gt; OHCI HCD support</div>
<div class="line">             [*] Ambarella OHCI support</div>
<div class="line">    &lt;M&gt; Multimedia support ---&gt;</div>
<div class="line">       Media device types  ---&gt;</div>
<div class="line">           [*] Cameras and video grabbers</div>
<div class="line">       Media drivers  ---&gt;</div>
<div class="line">           [*] Media USB Adapters ---&gt;</div>
<div class="line">                   &lt;M&gt; USB Video Class (UVC)</div>
<div class="line">                     [*] UVC input events device support</div>
</div><!-- fragment --></li>
<li>Support USB UVC device: test steps<br  />
<ol type="1">
<li>Ensure that USB (3.0) is functioning in "host" mode (possible parameter: <b>host device</b>). <div class="fragment"><div class="line">board # usb_role_switch.sh host</div>
</div><!-- fragment --> <div class="fragment"><div class="line">[   31.021908] usbcore: deregistering device driver usb</div>
<div class="line">[   31.027183] usbcore: deregistering <span class="keyword">interface </span>driver usbfs</div>
<div class="line">[   31.032945] usbcore: deregistering interface driver hub</div>
<div class="line">[   31.073446] usbcore: registered new interface driver usbfs</div>
<div class="line">[   31.079324] usbcore: registered new interface driver hub</div>
<div class="line">[   31.084686] usbcore: registered new device driver usb</div>
<div class="line"><span class="preprocessor"># [   31.109275] xhci-hcd xhci-hcd.1.auto: xHCI Host Controller</span></div>
<div class="line">[   31.114803] xhci-hcd xhci-hcd.1.auto: new USB bus registered, assigned bus <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 1</div>
<div class="line">[   31.122870] xhci-hcd xhci-hcd.1.auto: hcc params 0x08007f0d hci version 0x110 quirks 0x0000002000018010</div>
<div class="line">[   31.132335] xhci-hcd xhci-hcd.1.auto: irq 94, io mem 0x2020008000</div>
<div class="line">[   31.138743] xhci-hcd xhci-hcd.1.auto: xHCI Host Controller</div>
<div class="line">[   31.144277] xhci-hcd xhci-hcd.1.auto: new USB bus registered, assigned bus <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a01b4671c6b7cc8f831c951c000a37735">number</a> 2</div>
<div class="line">[   31.151965] xhci-hcd xhci-hcd.1.auto: Host supports USB 3.1 Enhanced SuperSpeed</div>
<div class="line">[   31.159338] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 5.15</div>
<div class="line">[   31.167633] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1</div>
<div class="line">[   31.174894] usb usb1: Product: xHCI Host Controller</div>
<div class="line">[   31.179785] usb usb1: Manufacturer: Linux 5.15.93 xhci-hcd</div>
<div class="line">[   31.185285] usb usb1: SerialNumber: xhci-hcd.1.auto</div>
<div class="line">[   31.190634] hub 1-0:1.0: USB hub found</div>
<div class="line">[   31.194413] hub 1-0:1.0: 1 port detected</div>
<div class="line">[   31.198705] usb usb2: We don&#39;t know the algorithms for LPM for this host, disabling LPM.</div>
<div class="line">[   31.206857] usb usb2: New USB device found, idVendor=1d6b, idProduct=0003, bcdDevice= 5.15</div>
<div class="line">[   31.215154] usb usb2: New USB device strings: Mfr=3, Product=2, SerialNumber=1</div>
<div class="line">[   31.222429] usb usb2: Product: xHCI Host Controller</div>
<div class="line">[   31.227321] usb usb2: Manufacturer: Linux 5.15.93 xhci-hcd</div>
<div class="line">[   31.232843] usb usb2: SerialNumber: xhci-hcd.1.auto</div>
<div class="line">[   31.238123] hub 2-0:1.0: USB hub found</div>
<div class="line">[   31.241917] hub 2-0:1.0: 1 port detected</div>
</div><!-- fragment --></li>
<li>Use modprobe uvcvideo. <div class="fragment"><div class="line">board # modprobe uvcvideo</div>
</div><!-- fragment --></li>
<li>Plug in the USB UVC device. The kernel identifies the USB UVC camera and registers the V4L2 video device automatically. <div class="fragment"><div class="line"><span class="preprocessor"># [  115.568858] usb 2-1: new SuperSpeed Plus Gen 2x1 USB device number 2 using xhci-hcd</span></div>
<div class="line">[  115.588258] usb 2-1: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 5.15</div>
<div class="line">[  115.596466] usb 2-1: New USB device strings: Mfr=1, Product=2, SerialNumber=3</div>
<div class="line">[  115.603624] usb 2-1: Product: USB V/A Streaming</div>
<div class="line">[  115.608170] usb 2-1: Manufacturer: Ambarella</div>
<div class="line">[  115.612452] usb 2-1: SerialNumber: 123456789AB</div>
<div class="line">[  115.640430] mc: Linux media interface: v0.10</div>
<div class="line">[  115.657828] videodev: Linux video capture interface: v2.00</div>
<div class="line">[  115.677051] uvcvideo 2-1:1.1: Unknown video <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a> 59455247-0000-0010-8000-00aa00389b71</div>
<div class="line">[  115.685098] usb 2-1: Found UVC 1.00 device USB V/A Streaming (1d6b:0104)</div>
<div class="line">[  115.704845] usbcore: registered <span class="keyword">new</span> <span class="keyword">interface </span>driver uvcvideo</div>
<div class="ttc" id="acJSON_8h_html_adb411a44855a4c49231d72a0fc9a3b3b"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a></div><div class="ttdeci">char const int const cJSON_bool format</div></div>
</div><!-- fragment --></li>
<li>Check the USB UVC device. <div class="fragment"><div class="line">board # lsusb</div>
<div class="line">Bus 002 Device 002: ID 1d6b:0104</div>
<div class="line">Bus 001 Device 001: ID 1d6b:0002</div>
<div class="line">Bus 002 Device 001: ID 1d6b:0003</div>
<div class="line">board # ls /dev/video*</div>
<div class="line">/dev/video0</div>
</div><!-- fragment --></li>
<li><p class="startli">Capture a YUV picture based on V4L2.</p>
<p class="startli">The v4l-utils are a series of packages for managing media devices that aid in obtaining YUV frames from a UVC camera.<br  />
 First, use the v4l2-ctl command to set camera parameters, such as frame size and frame rate. For example, the command below will set up a camera with a resolution of 1920x1080 and a frame rate of 30 frames per second (fps). </p><div class="fragment"><div class="line">board # v4l2-ctl --device=/dev/video0 --set-<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aa813b2b7bde1a5a1f528cd9d9aa9ee7d">fmt</a>-video=<a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a>=1920, <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a>=1080, pixelformat=YUYV --set-parm=30</div>
<div class="ttc" id="acJSON_8h_html_aa813b2b7bde1a5a1f528cd9d9aa9ee7d"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aa813b2b7bde1a5a1f528cd9d9aa9ee7d">fmt</a></div><div class="ttdeci">int cJSON_bool fmt</div></div>
<div class="ttc" id="agroup__IAV_html_ga85db88ffee2944ecd35c616393976289"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a></div><div class="ttdeci">u32 width</div></div>
<div class="ttc" id="agroup__IAV_html_gadd40f8a56ae8cc650f92a3aa4d2bac99"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a></div><div class="ttdeci">u32 height</div></div>
</div><!-- fragment --><p> Then, use the v4l2-ctl command to enable streaming and output a frame to a file. For example, the following command will capture a YUV image and save it to a file named yuv_image.yuv. </p><div class="fragment"><div class="line">board # v4l2-ctl --stream-mmap --stream-<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>=1 --stream-to=yuv_image.yuv --device=/dev/video0</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="usb_speed"></a>
3. USB Speed</h1>
<p >The table below is the test result of USB 3.2 speed of mass storage: </p><table class="doxtable">
<tr>
<th><div style="width:120px">USB Mode</div></th><th><div style="width:120px"></div>Read / Write </th><th><div style="width:120px">Speed</div>  </th></tr>
<tr>
<td rowspan="3">USB Host </td></tr>
<tr>
<td>Read</td><td>696.4 MB/s </td></tr>
<tr>
<td>Write</td><td>544.1 MB/s  </td></tr>
<tr>
<td rowspan="3">USB Device </td></tr>
<tr>
<td>Read</td><td>560 MB/s </td></tr>
<tr>
<td>Write</td><td>560 MB/s  </td></tr>
</table>
<p><br  />
</p>
<dl class="section note"><dt>Note</dt><dd>The USB port on PC greatly affects the read and write speed of the USB device.</dd></dl>
<p>For example, with the same device, the read / write speed of the USB 3.0 port maybe 150 MB/s ~ 200 MB/s slower than that of the USB 3.1 port on host PC.<br  />
 </p><div class="image">
<img src="../../usb_speed_device_usb3.1_port.png" alt=""/>
<div class="caption">
Figure 3-1. Ambarella USB Speed with USB 3.1 Port.</div></div>
 <div class="image">
<img src="../../usb_speed_device_usb3.0_port.png" alt=""/>
<div class="caption">
Figure 3-2. Ambarella USB Speed with USB 3.0 Port.</div></div>
<p >The reference test steps are as follows:<br  />
</p><ol type="1">
<li>Assemble the jumper on J28.<br  />
</li>
<li>Input the following test commands:<br  />
 <div class="fragment"><div class="line">board # rmmod Ambarella_udc</div>
<div class="line">board # dd <span class="keywordflow">if</span>=/dev/zero of=/tmp/fsg bs=1M <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>=500</div>
<div class="line">board # mkfs.vfat /tmp/fsg</div>
<div class="line">board # modprobe g_mass_storage file=/tmp/fsg stall=0 removable=1</div>
</div><!-- fragment --></li>
</ol>
<hr  />
<h1><a class="anchor" id="amba_uvc_camera"></a>
4. Ambarella UVC Camera</h1>
<p >The Ambarella UVC camera is a camera with a USB interface that meets the standards set for the USB video class (UVC).</p>
<h2><a class="anchor" id="uvc_cam_specifications"></a>
4.1 Specifications</h2>
<a class="anchor" id="uvac_spec_table"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th>Parameters </th><th align="left">Specification </th></tr>
<tr>
<td>UVC features </td><td><ul>
<li>UVC 1.0 / UVC 1.1 / UVC 1.5<br  />
</li>
<li>Bulk and isochronous (ISOC) mode (Ambarella suggests using bulk mode for higher throughput) <br  />
</li>
<li>Multiple endpoints (EPs) with multiple streams<br  />
<ul>
<li>Up to 2 UVCs for USB 2.0<br  />
</li>
<li>Up to 7 UVCs for USB 3.2-Gen2<br  />
</li>
</ul>
</li>
<li>Streams with different resolution in the same format<br  />
</li>
<li>Camera terminal (CT) control<br  />
</li>
<li>Processing unit (PU) control<br  />
</li>
<li>USB 3.2-Gen2 transmission<br  />
</li>
<li>Bit rate up to 2 Gbps </li>
</ul>
</td></tr>
<tr>
<td>UVC stream </td><td><ul>
<li>Up to H.265 8K @ 30 fps (Default 1080p@30fps)<br  />
</li>
<li>Up to H.264 8K @ 30 fps (Default 1080p@30fps)<br  />
</li>
<li>Up to MJPEG 8K @ 30 fps (Default 1080p@30fps)<br  />
</li>
<li>Up to NV12 4K @ 30 fps (Default 720p@30fps)<br  />
</li>
<li>Up to YUYV 1080p @ 30 fps (Default 480p@30fps)<br  />
</li>
<li>JPEG, NV12 and YUYV image </li>
</ul>
</td></tr>
<tr>
<td>UAC features </td><td><ul>
<li>UAC 1.0 (microphone)<br  />
</li>
<li>UAC 2.0 (microphone)<br  />
</li>
<li>48 Kbps sample rate and stereo microphone input<br  />
</li>
<li>Volume and mute control </li>
</ul>
</td></tr>
<tr>
<td>Compatibility </td><td><ul>
<li>Microsoft Windows (7 and above)<br  />
</li>
<li>Linux (Ubuntu 16.04 and above) </li>
</ul>
</td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>USB3 has <b>15</b> physical EPs in total: 1x EP0, 7x IN EPs, and 7x OUT EPs. Only 7x IN EPs can be used for UVC / USB audio class (UAC) purposes. Each UVC uses either 1 or 2 IN EPs. Each UAC uses 1 IN EP.<ul>
<li>If only UVC, up to 7x UVCs can be supported in parallel if using single IN EP.</li>
<li>If UVC + UAC, up to 6x UVC + 1x UAC can be supported in parallel if using single IN EP for UVC.</li>
<li>For UAC, if enabling audio volume control, one additional IN EP will be occupied. Therefore, 5x UVC + 1x (UAC + UAC volume control) can be supported with a total of IN EPs = 7 if using a single IN EP for UVC.</li>
</ul>
</li>
<li>The maximum UVC throughput is about 4.278 Gbps (NV12 4K @ 43fps: <code>3840 * 2160 * 12 * 43 / 1000000000</code>) without loading.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="uvc_cam_build_firmware"></a>
4.2 Build Firmware Support UVC</h2>
<dl class="section user"><dt>For Old SDK Amba Build:</dt><dd><div class="fragment"><div class="line">build $ <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> ../../build/env/cortex-a76-linux5.15-gcc.env</div>
<div class="line">build $ make sync_build_mkcfg</div>
<div class="line">build $ make cv5_ipcam_config</div>
<div class="line">build $ make menuconfig</div>
<div class="line">    [*] Ambarella Linux Configuration  ---&gt;</div>
<div class="line">        [*]   Apply Linux Patch  ---&gt;</div>
<div class="line">            [*]   Apply Ambarella UVAC Patch</div>
<div class="line">        [*]   Ambarella Private Drivers Configuration  ---&gt; <span class="comment">// If running 8K@30</span></div>
<div class="line">            [*]   Build Ambarella <span class="keyword">private</span> IAV module  ---&gt;</div>
<div class="line">                (7680)   Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> in pixel</div>
<div class="line">                (4320)   Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a></div>
<div class="line">    [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">        [*]   Ambarella Private Linux Unit test configs  ---&gt;</div>
<div class="line">            [*]   Build uvc stream tool</div>
<div class="ttc" id="avin__init_8c_html_a07a87b2e6ed927503e2f95f119c9fc23"><div class="ttname"><a href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a></div><div class="ttdeci">int source</div></div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Amba Build:</dt><dd><div class="fragment"><div class="line">build $ <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> build/env/amba-build.env</div>
<div class="line">build $ make ipcam_config</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  kernel ---&gt;</div>
<div class="line">    linux-patch-uvac-choice@<span class="keyword">virtual</span> (kernel/linux-patch) (linux-patch-uvac) ---&gt;</div>
<div class="line">  drv_modules ---&gt;</div>
<div class="line">    <span class="keyword">private</span> ---&gt;</div>
<div class="line">      -*- ambavideo-header (drv_modules/<span class="keyword">private</span>/dsp_v5) ---&gt; <span class="comment">// If running 8K@30</span></div>
<div class="line">       (7680) Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> in pixel</div>
<div class="line">       (4320) Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a></div>
<div class="line">  packages ---&gt;</div>
<div class="line">    usb_gadget ---&gt;</div>
<div class="line">      [*] usb-gadget-configfs (packages/usb_gadget/configfs)</div>
<div class="line">      [*] libuvc (packages/usb_gadget/libuvc)</div>
<div class="line">        [*] uvc-stream (packages/usb_gadget/unit_test/dsp_v5)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Yocto Build:</dt><dd><div class="fragment"><div class="line">build $ <a class="code hl_variableRef" href="../../../video/d4/daa/vin__init_8c.html#a07a87b2e6ed927503e2f95f119c9fc23">source</a> build/env/yocto-build.env</div>
<div class="line">build $ make ipcam_config</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  meta-ambabsp ---&gt;</div>
<div class="line">    recipes-kernel ---&gt;</div>
<div class="line">      linux-patch-uvac-choice@<span class="keyword">virtual</span> (meta-ambabsp/recipes-kernel/linux-patch) (linux-patch-uvac) ---&gt;</div>
<div class="line">    recipes-video ---&gt;</div>
<div class="line">      -*- ambavideo-header (meta-ambabsp/recipes-video/ambvideo-header) ---&gt; <span class="comment">// If running 8K@30</span></div>
<div class="line">        (7680) Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a> in pixel</div>
<div class="line">        (4320) Max VIN <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a></div>
<div class="line">  meta-ambalib ---&gt;</div>
<div class="line">    recipes-video ---&gt;</div>
<div class="line">      [*] libuvc (meta-ambalib/recipes-video/libuvc)</div>
<div class="line">  meta-ambaapp ---&gt;</div>
<div class="line">    recipes-usb-gadget ---&gt;</div>
<div class="line">      [*] usb-gadget-configfs (meta-ambaapp/recipes-usb-gadget/usb-gadget-configfs)</div>
<div class="line">      [*] uvc-stream (meta-ambaapp/recipes-usb-gadget/uvc-stream)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Linux kernel 5.15:</dt><dd><div class="fragment"><div class="line">build $ make defconfig_public_linux  <span class="comment">// Cooper SDK doesn&#39;t need do it</span></div>
<div class="line">build $ make menuconfig_public_linux <span class="comment">// Cooper SDK is &quot;make linux_menuconfig&quot;</span></div>
<div class="line">    Device Drivers  ---&gt;</div>
<div class="line">        &lt;M&gt; Multimedia support  ---&gt;</div>
<div class="line">            Media device types  ---&gt;</div>
<div class="line">                [*] Cameras and video grabbers</div>
<div class="line">        [*] USB support  ---&gt;</div>
<div class="line">            &lt;M&gt;   Cadence USB3 support on Ambarella platforms</div>
<div class="line">                [*]     Cadence CDNSP device controller  <span class="comment">// USB 3.2-Gen2 UDC</span></div>
<div class="line">                [*]     Cadence CDNSP host controller</div>
<div class="line">            &lt;*&gt;   USB Gadget Support  ---&gt;</div>
<div class="line">                &lt;M&gt;   USB Gadget functions configurable through configfs</div>
<div class="line">                [*]     Audio Class 1.0  <span class="comment">// UAC 1.0</span></div>
<div class="line">                [*]     Audio Class 2.0  <span class="comment">// UAC 2.0</span></div>
<div class="line">                [*]     USB Webcam function</div>
</div><!-- fragment --></dd></dl>
<ul>
<li>If users do not want to change "Max VIN" using "make menuconfig", they can also add <b>"options ambcma max_vin_width=7680 max_vin_height=4320"</b> in "/etc/modprobe.d/ambarella.conf", and then restart the board.</li>
</ul>
<h2><a class="anchor" id="uvc_cam_stream_ambarella_uvc"></a>
4.3 Stream Ambarella UVC</h2>
<p >The following is the recommended topology between canvases and encode streams in the image audio video (IAV) layer, which is required to match the UVC stream application. Users can refer to the <code>Lua script v6_generic_1080px2.lua</code> and the UVC stream configuration file <code>uvc.conf</code>. </p><div class="image">
<img src="../../usb_cv5x_uvc_pipeline.png" alt=""/>
<div class="caption">
Figure 4-1. Ambarella UVC Pipeline.</div></div>
<p> UVC stream application is a unit test which is responsible for fetching the video frame from the IAV layer, and then feeding it to Linux V4L2. The source is located under <code>ambarella/unit_test/private/uvc_stream</code>. Before streaming the UVC, set up IAV canvas and encoding (1080p). </p><div class="fragment"><div class="line">board # init.sh --na; modprobe imx274_mipi vinc_id=8 bus_id=3 lane=2</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line"><span class="comment">// For Old SDK:</span></div>
<div class="line">board # test_encode --resource-cfg /vendor/config/v6_generic_1080px2.lua --vout-cfg /vendor/config/vout_hdmi_480p.lua</div>
<div class="line"><span class="comment">// For Cooper SDK:</span></div>
<div class="line">board # test_encode --resource-cfg /usr/share/uvc-stream/uvc_1080p.lua --vout-cfg /usr/share/uvc-stream/vout_hdmi_480p.lua</div>
<div class="line">board # test_encode -A -m 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -B -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -C -H 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board # test_encode -A -e -B -e -C -e</div>
</div><!-- fragment --><p> Before streaming the UVC, set up IAV canvas and encoding (High-efficiency video coding (HEVC) 8K). </p><div class="fragment"><div class="line">board # init.sh --na; modprobe imx586_mipi vinc_id=8 bus_id=3</div>
<div class="line">board # test_aaa_service -a &amp;</div>
<div class="line"><span class="comment">// For Old SDK:</span></div>
<div class="line">board # test_encode --resource-cfg /vendor/config/v6_generic_8k.lua</div>
<div class="line"><span class="comment">// For Cooper SDK:</span></div>
<div class="line">board # test_encode --resource-cfg /usr/share/uvc-stream/uvc_8kp.lua</div>
<div class="line">board # test_encode -A -m 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1 -B -h 1080p -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2 -C -H 7680x4320 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0</div>
<div class="line">board # test_encode -A -e -B -e -C -e</div>
<div class="line">board # start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd><ul>
<li>Ambarella recommends using a sensor with direct 8K resolution.</li>
<li>Configure the <code>/vendor/config/uvc.conf</code> according to the actual stream. <div class="fragment"><div class="line">stream: m 1920 1080 333333 8 0</div>
<div class="line">stream: h 1920 1080 333333 8 1</div>
<div class="line">stream: H 7680 4320 333333 8 2</div>
<div class="line">stream: u 1920 1080 333333 12 3</div>
</div><!-- fragment --></li>
</ul>
</dd></dl>
<p>Start streaming UVC 1.0 and UAC 1.0. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div>
</div><!-- fragment --><p> Or, start streaming UVC 1.1 and UAC 1.0. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -u 0x0110</div>
</div><!-- fragment --><p> Or, start streaming UVC 1.5 and UAC 1.0. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -u 0x0150</div>
</div><!-- fragment --><p> Or, start streaming UVC 1.0 and UAC 2.0. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -s</div>
</div><!-- fragment --><p> Or, start streaming the multiple-UVCs and UAC 1.0 by USB 2.0. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -X -Y       <span class="comment">// two UVCs</span></div>
</div><!-- fragment --><p> Note: USB 2.0 UDC only has six physical endpoints (1 EP0 + 5 IN EPs). USB 3.2-Gen2 UDC only has 15 physical endpoints (1 EP0 + 7 IN EPs + 7 OUT EPs). Each UVC will use two IN EPs, and each UAC will use 2 IN EPs with volume control enabled. If users enable the volume control while using two UVCs in USB 2.0 or three UVCs in USB 3.2-Gen2, the number of used IN EPs will exceed the number of physical IN EPs and the device will have no audio. Users must disable volume control in these situations.<br  />
 Or, start streaming UVC 1.0 and UAC 1.0 by USB 3.2-Gen2 ISOC mode. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -t</div>
</div><!-- fragment --><p> Or, start streaming UVC 1.0 and UAC 1.0 by USB 3.2-Gen2 bulk mode. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -t -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div>
</div><!-- fragment --><p> Bulk mode can achieve higher transmission speed than ISOC mode. Or, start streaming the multiple-UVCs and UAC 1.0 by USB 3.2-Gen2 bulk mode. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -a -t -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -X -Y -Z <span class="comment">// three UVCs</span></div>
<div class="line">build $ start-uvac-configfs -a -t -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -N 6     <span class="comment">// seven UVCs without UAC</span></div>
</div><!-- fragment --><p> Stop streaming UVC and UAC. </p><div class="fragment"><div class="line">build $ start-uvac-configfs -q</div>
</div><!-- fragment --><p >Users can use the command <b>start-uvac-configfs -h</b> for help with the options.</p>
<p >Connect the PC with the USB cable. </p><div class="image">
<img src="../../usb_cv5x_connect_the_pc.png" alt=""/>
<div class="caption">
Figure 4-2. Connect the PC.</div></div>
<p> Check the <b>Device Manager</b>. </p><div class="image">
<img src="../../usb_device_manager.png" alt=""/>
<div class="caption">
Figure 4-3. Device Manager.</div></div>
<p> Use Potplayer to stream the Ambarella UVC.</p><ul>
<li>Menu-&gt;Preferences (F5)-&gt;Device-&gt;Webcam <div class="image">
<img src="../../usb_potplayer.png" alt=""/>
<div class="caption">
Figure 4-4. Potplayer.</div></div>
 Select the video and audio device, and then open the devices to view the preview.</li>
<li>Menu-&gt;Open-&gt;Open Webcam / Other Device <div class="image">
<img src="../../usb_preview.png" alt=""/>
<div class="caption">
Figure 4-5. Preview.</div></div>
 For more details, refer to <code>ambarella/unit_test/private/uvc_stream/doc/Ambarella_UVAC_GETTING_STARTED.md</code></li>
</ul>
<h2><a class="anchor" id="ud_usb_uvc_latency"></a>
4.4 Ambarella UVC Latency</h2>
<a class="anchor" id="uvac_spec_table"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th align="center">codec Type </th><th align="center">Streaming </th><th align="center">Encode Latency<br  />
 from DSP (ms) </th><th align="center">Encode Latency<br  />
 from Potplayer (ms)  </th></tr>
<tr>
<td rowspan="4">MJPEG </td></tr>
<tr>
<td>1080p60</td><td>11.35</td><td>100 </td></tr>
<tr>
<td>4kp60</td><td>23.82</td><td>240 </td></tr>
<tr>
<td>8kp30</td><td>77.61</td><td>590  </td></tr>
<tr>
<td rowspan="4">AVC (Temporal Mode) </td></tr>
<tr>
<td>1080p60</td><td>12.64/28.75</td><td>160 </td></tr>
<tr>
<td>4kp60</td><td>26.44/41.82</td><td>200 </td></tr>
<tr>
<td>8kp30</td><td>102.02/124.11</td><td>390  </td></tr>
<tr>
<td rowspan="4">HEVC (Temporal Mode) </td></tr>
<tr>
<td>1080p60</td><td>12.91/29.53</td><td>120 </td></tr>
<tr>
<td>4kp60</td><td>26.10/42.26</td><td>130 </td></tr>
<tr>
<td>8kp30</td><td>98.83/130.96</td><td>380  </td></tr>
<tr>
<td rowspan="4">HEVC (Spatial Mode) </td></tr>
<tr>
<td>1080p60</td><td>12.64</td><td>90 </td></tr>
<tr>
<td>4kp60</td><td>24.35</td><td>100 </td></tr>
<tr>
<td>8kp30</td><td>87.26</td><td>360  </td></tr>
<tr>
<td rowspan="3">NV12 </td></tr>
<tr>
<td>800x600@30</td><td>/</td><td>260 </td></tr>
<tr>
<td>720p30</td><td>/</td><td>430  </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>This latency is measured between sensor frame exposure and UVC streaming out, it contains three parts, the pipeline latency, the transfer latency, and the decoding latency. The first two lantencies are related to the performance of Ambarella system on chip (SoC), and the decoding latency is highly dependent on the decoding performance of the connected PC / laptop.</li>
<li>The way to measure pipeline latency (from sensor capture done to image digital signal processing (IDSP) encode done) can be found on Page <a class="elRef" href="../../../video/dc/d27/fs_adv_pl_latency.html">ADVANCED - Pipeline Latency</a>.</li>
<li>The way to measure transfer latency (from encode done to UVC frame capture done by PC host) is as follows.</li>
</ul>
</dd></dl>
<ul>
<li>Modify the source code <div class="fragment"><div class="line">diff --git a/unit_test/dsp_v6/iav_query.c <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/unit_test/dsp_v6/iav_query.c</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> cbb2665..744dc8f 100644</div>
<div class="line">--- a/unit_test/dsp_v6/iav_query.c</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/unit_test/dsp_v6/iav_query.c</div>
<div class="line">@@ -135,6 +135,7 @@ <span class="keywordtype">int</span> iav_query_bitstream(uint32_t stream_id, <span class="keywordtype">void</span> *buffer, uint32_t size)</div>
<div class="line"><span class="preprocessor">#define USB_CHUNK_SIZE (2048)</span></div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_structRef" href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a> *frame_desc = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_structRef" href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a> query_desc;</div>
<div class="line">+   <span class="keyword">struct </span>timespec tp;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        memset(&amp;query_desc, 0, <span class="keyword">sizeof</span>(query_desc));</div>
<div class="line">@@ -174,6 +175,9 @@ <span class="keywordtype">int</span> iav_query_bitstream(uint32_t stream_id, <span class="keywordtype">void</span> *buffer, uint32_t size)</div>
<div class="line">        frame_desc-&gt;<a class="code hl_variableRef" href="../../../library/d9/d2b/structiav__framedesc.html#acfd6273064c5acdcfc39a23a69dd4343">size</a> = (frame_desc-&gt;<a class="code hl_variableRef" href="../../../library/d9/d2b/structiav__framedesc.html#acfd6273064c5acdcfc39a23a69dd4343">size</a> + USB_CHUNK_SIZE - 1) &amp; ~(USB_CHUNK_SIZE - 1);</div>
<div class="line">    }</div>
<div class="line">    memcpy(buffer, bsb_virt_addr + frame_desc-&gt;<a class="code hl_variableRef" href="../../../library/d9/d2b/structiav__framedesc.html#a16f01e9ac75392f8e05471ead76a95ae">data_addr_offset</a>, frame_desc-&gt;<a class="code hl_variableRef" href="../../../library/d9/d2b/structiav__framedesc.html#acfd6273064c5acdcfc39a23a69dd4343">size</a>);</div>
<div class="line">+   memset(&amp;tp, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timespec));</div>
<div class="line">+   clock_gettime(CLOCK_REALTIME, &amp;tp);</div>
<div class="line">+   memcpy(buffer, &amp;tp, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timespec));</div>
<div class="line">    <span class="keywordflow">return</span> frame_desc-&gt;<a class="code hl_variableRef" href="../../../library/d9/d2b/structiav__framedesc.html#acfd6273064c5acdcfc39a23a69dd4343">size</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">diff --git a/uvc_host/test_uvc_host.c <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/uvc_host/test_uvc_host.c</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> 6148931..2334792 100644</div>
<div class="line">--- a/uvc_host/test_uvc_host.c</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/uvc_host/test_uvc_host.c</div>
<div class="line">@@ -41,6 +41,7 @@ <span class="keyword">static</span> user_options_t G_usr_opt = {</div>
<div class="line">   .filename = {0},</div>
<div class="line">   .stream = V4L2_PIX_FMT_MJPEG,</div>
<div class="line">   .cap_num = -1,</div>
<div class="line"> + .lat_num = 0,</div>
<div class="line">   .width = UVC_DEFAULT_WIDTH,</div>
<div class="line">   .height = UVC_DEFAULT_HEIGHT,</div>
<div class="line"> };</div>
<div class="line">@@ -57,6 +58,41 @@ <span class="keyword">static</span> uvc_cap_context_t G_uvc_cap_ctx = {</div>
<div class="line">   .not_exit = 1,</div>
<div class="line"> };</div>
<div class="line"> </div>
<div class="line">+<span class="keyword">static</span> <span class="keywordtype">int</span> measure_time(<span class="keyword">const</span> <span class="keyword">struct</span> v4l2_buffer *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **buf_addr)</div>
<div class="line">+{</div>
<div class="line">+  <span class="keyword">struct </span>timespec tp1, tp2;</div>
<div class="line">+  <span class="keywordtype">void</span> *pbuf = buf_addr[<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>-&gt;index];</div>
<div class="line">+  <span class="keywordtype">long</span> <span class="keywordtype">int</span> lat;</div>
<div class="line">+  <span class="keyword">static</span> <span class="keywordtype">int</span> filfram = 90, latnum = 0;</div>
<div class="line">+  <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> max_lat = 0, min_lat = 1000000, avg_lat = 0;</div>
<div class="line">+</div>
<div class="line">+  memset(&amp;tp1, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timespec));</div>
<div class="line">+  memset(&amp;tp2, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timespec));</div>
<div class="line">+  memcpy(&amp;tp1, pbuf, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timespec));</div>
<div class="line">+  clock_gettime(CLOCK_REALTIME, &amp;tp2);</div>
<div class="line">+  lat = (tp2.tv_sec - tp1.tv_sec) * 1000000 + (tp2.tv_nsec - tp1.tv_nsec) / 1000;</div>
<div class="line">+</div>
<div class="line">+  <span class="keywordflow">if</span> (latnum != G_usr_opt.lat_num)</div>
<div class="line">+  {</div>
<div class="line">+      <span class="keywordflow">if</span> (filfram)</div>
<div class="line">+          filfram--;</div>
<div class="line">+      <span class="keywordflow">else</span></div>
<div class="line">+      {</div>
<div class="line">+         printf(<span class="stringliteral">&quot;clock_id = CLOCK_REALTIME, latency = %ld\n&quot;</span>, lat);</div>
<div class="line">+          max_lat = (max_lat &gt; lat) ? max_lat : lat;</div>
<div class="line">+          min_lat = (min_lat &lt; lat) ? min_lat : lat;</div>
<div class="line">+         avg_lat += lat;</div>
<div class="line">+         latnum++;</div>
<div class="line">+         <span class="keywordflow">if</span> (latnum == G_usr_opt.lat_num) {</div>
<div class="line">+             avg_lat = avg_lat / latnum;</div>
<div class="line">+             printf(<span class="stringliteral">&quot;Latency(us):\nmax = %ld, min = %ld, avg = %ld\n&quot;</span>, max_lat, min_lat, avg_lat);</div>
<div class="line">+          }</div>
<div class="line">+     }</div>
<div class="line">+  }</div>
<div class="line">+  <span class="keywordflow">return</span> 0;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line"> <span class="keyword">static</span> <span class="keywordtype">int</span> save_frame(<span class="keyword">const</span> <span class="keyword">struct</span> v4l2_buffer *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **buf_addr, FILE *file)</div>
<div class="line"> {</div>
<div class="line">   <span class="keywordtype">void</span> *pbuf = buf_addr[<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a>-&gt;index];</div>
<div class="line">@@ -106,6 +142,8 @@ <span class="keyword">static</span> <span class="keywordtype">int</span> uvc_frame_capture(<span class="keywordtype">int</span> fd, FILE *file, uvc_cap_context_t *ctxs)</div>
<div class="line">   <span class="keywordflow">if</span> (file) {</div>
<div class="line">       save_frame(&amp;buffer, buf_addr, file);</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">+  measure_time(&amp;buffer, buf_addr);</div>
<div class="line"> </div>
<div class="line">   ret = ioctl(fd, VIDIOC_QBUF, &amp;buffer);</div>
<div class="line">   <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">@@ -285,6 +323,8 @@ <span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *myself)</div>
<div class="line"> {</div>
<div class="line">   printf(<span class="stringliteral">&quot;Usage: %s [options]\n&quot;</span>, myself);</div>
<div class="line">   printf(<span class="stringliteral">&quot;Available options are:\n&quot;</span>);</div>
<div class="line">+  printf(<span class="stringliteral">&quot; \033[34m-t --latency [frame]\033[0m           Specify the frame numbers to caculate latency, &quot;</span> \</div>
<div class="line">+      <span class="stringliteral">&quot;default: function closed\n&quot;</span>);</div>
<div class="line">   printf(<span class="stringliteral">&quot; \033[34m-d --device [devicename]\033[0m       Specify the video device name, default: /dev/video0\n&quot;</span>);</div>
<div class="line">   printf(<span class="stringliteral">&quot; \033[34m-f --file [filename]\033[0m           Specify the file to save video frame and &quot;</span> \</div>
<div class="line">       <span class="stringliteral">&quot;Open the dump function, default: the dump function is closed\n&quot;</span>);</div>
<div class="line">@@ -304,6 +344,9 @@ <span class="keyword">static</span> <span class="keywordtype">int</span> init_param(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, user_options_t *usr_opt)</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">while</span> ((ch = getopt_long(argc, argv, short_options, long_options, &amp;option_index)) != -1) {</div>
<div class="line">       <span class="keywordflow">switch</span> (ch) {</div>
<div class="line">+      <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div>
<div class="line">+          usr_opt-&gt;lat_num = atoi(optarg);</div>
<div class="line">+          <span class="keywordflow">break</span>;</div>
<div class="line">       <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div>
<div class="line">           snprintf(usr_opt-&gt;dev_path, <span class="keyword">sizeof</span>(usr_opt-&gt;dev_path), <span class="stringliteral">&quot;%s&quot;</span>, optarg);</div>
<div class="line">           <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">diff --git a/uvc_host/test_uvc_host.h <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/uvc_host/test_uvc_host.h</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> 27eb98b..f7acb98 100644</div>
<div class="line">--- a/uvc_host/test_uvc_host.h</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/uvc_host/test_uvc_host.h</div>
<div class="line">@@ -45,6 +45,7 @@</div>
<div class="line"><span class="preprocessor"> #include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;poll.h&gt;</span></div>
<div class="line">+#include &lt;time.h&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;sys/mman.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;sys/ioctl.h&gt;</span></div>
<div class="line">@@ -63,6 +64,7 @@ <span class="keyword">typedef</span> <span class="keyword">struct </span>user_options_s {</div>
<div class="line">   <span class="keywordtype">char</span> filename[<a class="code hl_defineRef" href="../../../video/d2/de8/dec__lua__cfg_8c.html#a58ce36916c399104e18d32ff090f21c6">MAX_STR_LEN</a>];</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stream;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cap_num;</div>
<div class="line">+  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lat_num;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga85db88ffee2944ecd35c616393976289">width</a>;</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#gadd40f8a56ae8cc650f92a3aa4d2bac99">height</a>;</div>
<div class="line"> } user_options_t;</div>
<div class="line">@@ -73,9 +75,10 @@ <span class="keyword">typedef</span> <span class="keyword">struct </span>uvc_cap_context_s {</div>
<div class="line">   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code hl_variableRef" href="../../../driver/df/dc0/group__IAV.html#ga60ef8bae6f4bb3dc7582a4ff861f2d36">reserved</a> : 31;</div>
<div class="line"> } uvc_cap_context_t;</div>
<div class="line"> </div>
<div class="line">-<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *short_options = <span class="stringliteral">&quot;d:f:hn:r:s:&quot;</span>;</div>
<div class="line">+<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *short_options = <span class="stringliteral">&quot;t:d:f:hn:r:s:&quot;</span>;</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[] = {</div>
<div class="line">+  {<span class="stringliteral">&quot;latency&quot;</span>, <a class="code hl_defineRef" href="../../../video/d3/d6c/test__fb_8h.html#affec572f11fcba59ce0cd49cbcd0110f">HAS_ARG</a>, 0, <span class="charliteral">&#39;t&#39;</span>},</div>
<div class="line">   {<span class="stringliteral">&quot;device&quot;</span>, <a class="code hl_defineRef" href="../../../video/d3/d6c/test__fb_8h.html#affec572f11fcba59ce0cd49cbcd0110f">HAS_ARG</a>, 0, <span class="charliteral">&#39;d&#39;</span>},</div>
<div class="line">   {<span class="stringliteral">&quot;file&quot;</span>, <a class="code hl_defineRef" href="../../../video/d3/d6c/test__fb_8h.html#affec572f11fcba59ce0cd49cbcd0110f">HAS_ARG</a>, 0, <span class="charliteral">&#39;f&#39;</span>},</div>
<div class="line">   {<span class="stringliteral">&quot;help&quot;</span>, <a class="code hl_defineRef" href="../../../video/d3/d6c/test__fb_8h.html#a2d0022791143e08a64621257f48d9739">NO_ARG</a>, 0, <span class="charliteral">&#39;h&#39;</span>},</div>
<div class="ttc" id="acJSON_8h_html_a750b5d744c39a06bfb13e6eb010e35d0"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a></div><div class="ttdeci">int index</div></div>
<div class="ttc" id="acJSON_8h_html_aff2566f4c366b48d73479bef43ee4d2e"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#aff2566f4c366b48d73479bef43ee4d2e">buffer</a></div><div class="ttdeci">char * buffer</div></div>
<div class="ttc" id="adec__lua__cfg_8c_html_a58ce36916c399104e18d32ff090f21c6"><div class="ttname"><a href="../../../video/d2/de8/dec__lua__cfg_8c.html#a58ce36916c399104e18d32ff090f21c6">MAX_STR_LEN</a></div><div class="ttdeci">#define MAX_STR_LEN</div></div>
<div class="ttc" id="agroup__IAV_html_ga60ef8bae6f4bb3dc7582a4ff861f2d36"><div class="ttname"><a href="../../../driver/df/dc0/group__IAV.html#ga60ef8bae6f4bb3dc7582a4ff861f2d36">reserved</a></div><div class="ttdeci">u16 reserved</div></div>
<div class="ttc" id="astructiav__framedesc_html"><div class="ttname"><a href="../../../library/d9/d2b/structiav__framedesc.html">iav_framedesc</a></div></div>
<div class="ttc" id="astructiav__framedesc_html_a16f01e9ac75392f8e05471ead76a95ae"><div class="ttname"><a href="../../../library/d9/d2b/structiav__framedesc.html#a16f01e9ac75392f8e05471ead76a95ae">iav_framedesc::data_addr_offset</a></div><div class="ttdeci">unsigned long data_addr_offset</div></div>
<div class="ttc" id="astructiav__framedesc_html_acfd6273064c5acdcfc39a23a69dd4343"><div class="ttname"><a href="../../../library/d9/d2b/structiav__framedesc.html#acfd6273064c5acdcfc39a23a69dd4343">iav_framedesc::size</a></div><div class="ttdeci">u32 size</div></div>
<div class="ttc" id="astructiav__querydesc_html"><div class="ttname"><a href="../../../library/d8/de5/structiav__querydesc.html">iav_querydesc</a></div></div>
<div class="ttc" id="atest__fb_8h_html_a2d0022791143e08a64621257f48d9739"><div class="ttname"><a href="../../../video/d3/d6c/test__fb_8h.html#a2d0022791143e08a64621257f48d9739">NO_ARG</a></div><div class="ttdeci">#define NO_ARG</div></div>
<div class="ttc" id="atest__fb_8h_html_affec572f11fcba59ce0cd49cbcd0110f"><div class="ttname"><a href="../../../video/d3/d6c/test__fb_8h.html#affec572f11fcba59ce0cd49cbcd0110f">HAS_ARG</a></div><div class="ttdeci">#define HAS_ARG</div></div>
</div><!-- fragment --></li>
<li>Build the firmware<ol type="1">
<li>Enable UVC function. <a class="el" href="../../df/d51/si_usb.html#uvc_cam_build_firmware">4.2 Build Firmware Support UVC</a></li>
<li>Enable PTP function. <a class="el" href="../../db/d1c/si_ptp.html#ptp_on_ambarella_platform">2 PTP Examples on the Ambarella Platform</a></li>
<li>Enable UVC_HOST application. <div class="fragment"><div class="line"><span class="comment">// For amba build:</span></div>
<div class="line">make menuconfig</div>
<div class="line">    packages  ---&gt;</div>
<div class="line">        usb_gadget  ---&gt;</div>
<div class="line">            [*]test-uvc-host-native</div>
<div class="line"><span class="comment">// For yocto build:</span></div>
<div class="line">make menuconfig</div>
<div class="line">    meta-ambaapp  ---&gt;</div>
<div class="line">        recipes-usb-gadget  ---&gt;</div>
<div class="line">            [*] test-uvc-host</div>
</div><!-- fragment --></li>
</ol>
</li>
<li>Test the latency<ol type="1">
<li>Copy the <code>test-uvc-host-native</code> to the Ubuntu PC (this tool is not related to the SDK version).</li>
<li>Load firmware to the board.</li>
<li>Start PTP. <div class="fragment"><div class="line"><span class="comment">// pc command:</span></div>
<div class="line">phc2sys -s CLOCK_REALTIME -c eth0 -w -m -r -r -O 0 &amp;</div>
<div class="line">ptp4l -i eth0 -m -H &amp;</div>
<div class="line"><span class="comment">// board command:</span></div>
<div class="line">phc2sys -s eth0 -c CLOCK_REALTIME -w -m -r -O 0 &amp;</div>
<div class="line">ptp4l -i eth0 -m -s -H &amp;</div>
</div><!-- fragment --></li>
<li>Start UVC on board.</li>
<li>Start capturing UVC frame on Ubuntu PC. <div class="fragment"><div class="line"><span class="comment">// example: test the uvc latency of 300 frames</span></div>
<div class="line">./test-uvc-host -d /dev/video0 -t 300</div>
</div><!-- fragment --></li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="ud_usb_device_uvc_gadget"></a>
4.5 Test uvc-gadget</h2>
<p >The uvc-gadget (<a href="https://git.ideasonboard.org/uvc-gadget.git">https://git.ideasonboard.org/uvc-gadget.git</a>) UVC test program, officially recommended by Linux, only supports MJPEG and YUV streams with <code>ISOC mode</code>.</p>
<p >Ambarella adds BULK mode support for uvc_gadget with the following patch:</p>
<div class="fragment"><div class="line">From 0dacb67fc4d39743fe0ee7f2871bbdea6b5b33bc Mon Sep 17 00:00:00 2001</div>
<div class="line">From: jleng &lt;jleng@ambarella.com&gt;</div>
<div class="line">Date: Fri, 3 Feb 2023 15:40:18 +0800</div>
<div class="line">Subject: [PATCH] Add bulk transport support</div>
<div class="line"> </div>
<div class="line">---</div>
<div class="line"> include/uvcgadget/configfs.h |  1 +</div>
<div class="line"> lib/uvc.c                    |  4 +++-</div>
<div class="line"> src/<a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>.c                   | 10 +++++++++-</div>
<div class="line"> 3 files changed, 13 insertions(+), 2 deletions(-)</div>
<div class="line"> </div>
<div class="line">diff --git a/include/uvcgadget/configfs.h b/include/uvcgadget/configfs.h</div>
<div class="line">index e5a7efa..054051e 100644</div>
<div class="line">--- a/include/uvcgadget/configfs.h</div>
<div class="line">+++ b/include/uvcgadget/configfs.h</div>
<div class="line">@@ -100,6 +100,7 @@ struct uvc_function_config {</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">struct </span>uvc_function_config_control control;</div>
<div class="line">  <span class="keyword">struct </span>uvc_function_config_streaming streaming;</div>
<div class="line">+ <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_payload_size;</div>
<div class="line"> };</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">struct </span>uvc_function_config *configfs_parse_uvc_function(<span class="keyword">const</span> <span class="keywordtype">char</span> *function);</div>
<div class="line">diff --git a/lib/uvc.c <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/lib/uvc.c</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> 747cd65..f130332 100644</div>
<div class="line">--- a/lib/uvc.c</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/lib/uvc.c</div>
<div class="line">@@ -173,7 +173,9 @@ uvc_fill_streaming_control(<span class="keyword">struct</span> uvc_device *dev,</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">- ctrl-&gt;dwMaxPayloadTransferSize = dev-&gt;fc-&gt;streaming.ep.wMaxPacketSize;</div>
<div class="line">+ ctrl-&gt;dwMaxPayloadTransferSize = dev-&gt;fc-&gt;max_payload_size ? \</div>
<div class="line">+                  dev-&gt;fc-&gt;max_payload_size : \</div>
<div class="line">+                  dev-&gt;fc-&gt;streaming.ep.wMaxPacketSize;</div>
<div class="line">  ctrl-&gt;bmFramingInfo = 3;</div>
<div class="line">  ctrl-&gt;bPreferedVersion = 1;</div>
<div class="line">  ctrl-&gt;bMaxVersion = 1;</div>
<div class="line">diff --git a/src/<a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>.c <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/src/<a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>.c</div>
<div class="line"><a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a> cec622a..faa9e88 100644</div>
<div class="line">--- a/src/<a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>.c</div>
<div class="line">+++ <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>/src/<a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>.c</div>
<div class="line">@@ -9,6 +9,7 @@</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"> #include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor"> #include &lt;stdio.h&gt;</span></div>
<div class="line">+#include &lt;stdlib.h&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;unistd.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"> #include &quot;config.h&quot;</span></div>
<div class="line">@@ -25,6 +26,7 @@ <span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *argv0)</div>
<div class="line"> {</div>
<div class="line">  fprintf(stderr, <span class="stringliteral">&quot;Usage: %s [options] &lt;uvc device&gt;\n&quot;</span>, argv0);</div>
<div class="line">  fprintf(stderr, <span class="stringliteral">&quot;Available options are\n&quot;</span>);</div>
<div class="line">+ fprintf(stderr, <span class="stringliteral">&quot; -p max_payload_size   Set dwMaxPayloadTransferSize\n&quot;</span>);</div>
<div class="line"><span class="preprocessor"> #ifdef HAVE_LIBCAMERA</span></div>
<div class="line">  fprintf(stderr, <span class="stringliteral">&quot; -c &lt;index|id&gt; libcamera camera name\n&quot;</span>);</div>
<div class="line"><span class="preprocessor"> #endif</span></div>
<div class="line">@@ -76,11 +78,16 @@ <span class="keywordtype">int</span> <a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">  <span class="keyword">struct </span>uvc_stream *stream = NULL;</div>
<div class="line">  <span class="keyword">struct </span>video_source *src = NULL;</div>
<div class="line">  <span class="keyword">struct </span>events events;</div>
<div class="line">+ <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_payload_size = 0;</div>
<div class="line">  <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">  <span class="keywordtype">int</span> opt;</div>
<div class="line"> </div>
<div class="line">- <span class="keywordflow">while</span> ((opt = getopt(argc, argv, <span class="stringliteral">&quot;c:d:i:s:k:h&quot;</span>)) != -1) {</div>
<div class="line">+ <span class="keywordflow">while</span> ((opt = getopt(argc, argv, <span class="stringliteral">&quot;p:c:d:i:s:k:h&quot;</span>)) != -1) {</div>
<div class="line">      <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">+     <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">+         max_payload_size = atoi(optarg);</div>
<div class="line">+         <span class="keywordflow">break</span>;</div>
<div class="line">+</div>
<div class="line"><span class="preprocessor"> #ifdef HAVE_LIBCAMERA</span></div>
<div class="line">      <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">          camera = optarg;</div>
<div class="line">@@ -117,6 +124,7 @@ <span class="keywordtype">int</span> <a class="code hl_functionRef" href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">      printf(<span class="stringliteral">&quot;Failed to identify function configuration\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">+ fc-&gt;max_payload_size = max_payload_size;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (cap_device != NULL &amp;&amp; img_path != NULL) {</div>
<div class="line">      printf(<span class="stringliteral">&quot;Both capture device and still image specified\n&quot;</span>);</div>
<div class="line">--</div>
<div class="line">2.17.1</div>
<div class="ttc" id="atest__vout__cfg_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../../video/db/d1a/test__vout__cfg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>If using BULK mode, set max_payload_size with <code>-p</code> option.</li>
</ul>
</dd></dl>
<ul>
<li>The configuration steps are as follows: <div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  Ambarella File System Configuration -&gt;</div>
<div class="line">     Open Source Software (OSS) -&gt;</div>
<div class="line">       Multimedia Software -&gt;</div>
<div class="line">         [*] Add uvc-gadget into root_fs</div>
<div class="line">build $ make j8</div>
</div><!-- fragment --></li>
<li>The test steps are as follows: <div class="fragment"><div class="line">board # echo <span class="stringliteral">&quot;image: m 1280 720 10000000 8 /vendor/data/test_720p.jpg&quot;</span> &gt; uvc-gadget.conf</div>
<div class="line">board # start-uvac-configfs -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> -c uvc-gadget.conf</div>
<div class="line">board # uvc-gadget -p $(( 128 * 1024 )) -i /vendor/data/test_720p.jpg uvc.usb0</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="ud_usb_ffs_device"></a>
4.6 USB FunctionFS Device (Cooper SDK)</h2>
<p >The configuration steps are as follows:</p>
<ol type="1">
<li>Enable the device driver. <div class="fragment"><div class="line">build $ make linux_menuconfig</div>
<div class="line">  Device Drivers --&gt;</div>
<div class="line">    [*] USB supports --&gt;</div>
<div class="line">      [M] USB Gadget Support --&gt;</div>
<div class="line">        [M] USB Gadget functions configurable through configfs</div>
<div class="line">          [*] Function filesystem (FunctionFS)</div>
</div><!-- fragment --></li>
<li><p class="startli">Enable the device package.</p>
<dl class="section user"><dt>For Cooper SDK Amba Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  oss --&gt;</div>
<div class="line">    [*] libaio (oss/libaio)</div>
<div class="line">  packages --&gt;</div>
<div class="line">    usb_gadget --&gt;</div>
<div class="line">      [*] usb-gadget-configfs (packages/usb_gadget/configfs)</div>
<div class="line">      ffs_test  --&gt;</div>
<div class="line">        [*] test-ffs-device (packages/usb_gadget/ffs_test/device)</div>
<div class="line">build $ make test-ffs-device</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper SDK Yocto Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  meta-ambapp --&gt;</div>
<div class="line">    recipes-usb-gadget --&gt;</div>
<div class="line">      [*] usb-gadget-configfs (meta-ambaapp/recipes-usb-gadget/usb-gadget-configfs)</div>
<div class="line">      [*] test-ffs-device (meta-ambaapp/recipes-usb-gadget/test-ffs)</div>
<div class="line">build $ make test-ffs-device</div>
</div><!-- fragment --></dd></dl>
</li>
<li><p class="startli">Enable the host package.</p>
<dl class="section user"><dt>Build PC Host Tool With Amba Build:</dt><dd><div class="fragment"><div class="line">build $ sudo apt install libusb-1.0-dev</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  packages --&gt;</div>
<div class="line">    usb_gadget --&gt;</div>
<div class="line">      ffs_test  --&gt;</div>
<div class="line">        [*] test-ffs-host-native (packages/usb_gadget/ffs_test/host)</div>
<div class="line">build $ make test-ffs-host-native</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>Enable Board Host Tool With Amba Build:</dt><dd><div class="fragment"><div class="line">build $ sudo apt install libusb-1.0-dev</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  prebuild --&gt;</div>
<div class="line">    oss --&gt;</div>
<div class="line">      [*] prebuild-libusbx (prebuild/oss/armv8-a/libusbx)</div>
<div class="line">  packages --&gt;</div>
<div class="line">    usb_gadget --&gt;</div>
<div class="line">      ffs_test  --&gt;</div>
<div class="line">        [*] test-ffs-host (packages/usb_gadget/ffs_test/host)</div>
<div class="line">build $ make test-ffs-host</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>Enable Board Host Tool With Yocto Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  meta-ambapp --&gt;</div>
<div class="line">    recipes-usb-gadget --&gt;</div>
<div class="line">      [*] test-ffs-host (meta-ambaapp/recipes-usb-gadget/test-ffs)</div>
<div class="line">build $ make test-ffs-host</div>
</div><!-- fragment --></dd></dl>
</li>
<li><p class="startli">Test FunctionFS (single device).</p>
<p class="startli">Device: </p><div class="fragment"><div class="line">board # start-uvac-configfs -F 8192</div>
</div><!-- fragment --><p> Host: </p><div class="fragment"><div class="line">host $ sudo time ./test_ffs_host -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 8192 -i 0 -t 1000</div>
</div><!-- fragment --></li>
<li><p class="startli">Test FunctionFS (composite device).</p>
<p class="startli">Device: </p><div class="fragment"><div class="line">board # start-uvac-configfs -F 65536 -a</div>
</div><!-- fragment --><p> Host: </p><div class="fragment"><div class="line">host $ sudo time ./test_ffs_host -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 65536 -i 4 -t 1000</div>
</div><!-- fragment --></li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Users can run <code>./test_ffs_host -h</code> to get help.</li>
<li>Due to CV5x UDC hardware limitation, the max chunk size can only be <b>up to 64 KB</b>. </li>
</ul>
</dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
