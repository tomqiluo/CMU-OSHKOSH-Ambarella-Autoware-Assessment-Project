<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Peripherals: SPI</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Peripherals"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Peripherals<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('da/dcf/si_spi.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">SPI </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="doc_perihperals_spi_introduciton"></a>
1 Serial Peripheral Interface Introduction</h1>
<p >The serial peripheral interface (SPI) is a synchronous, full-duplex serial communication interface used for short-distance communication. SPI uses a masterâ€“slave architecture and uses separate clock and data lines, along with a chip select line to choose the device that users wish to talk to.</p>
<h2><a class="anchor" id="doc_perihperals_spi_interface"></a>
1.1 SPI Interface</h2>
<p >The SPI bus specifies four logic signals:</p><ul>
<li>SCLK: Serial clock (output from master)</li>
<li>MOSI: Master out, slave in (data output from master)</li>
<li>MISO: Master in, slave out (data output from slave)</li>
<li>CS: Chip / slave select (output from master to indicate that data is being sent) <div class="image">
<img src="../../spi_interface_connections.png" alt=""/>
<div class="caption">
Figure 1-1. Connecting Map between SPI Interfaces.</div></div>
</li>
</ul>
<h2><a class="anchor" id="doc_perihperals_spi_mode"></a>
1.2 SPI Mode</h2>
<p >The SPI bus has four modes (0, 1, 2, 3) that correspond to four possible clocking configurations of the clock polarity (CPOL) and the clock phase (CPHA).</p><ul>
<li><b>Mode 0</b><ul>
<li>CPOL=0: The clock is idle when low</li>
<li>CPHA=0: Data is sampled on the leading edge (rising edge) of the clock pulse and shifted out on the trailing edge (falling edge) of the clock pulse</li>
</ul>
</li>
<li><b>Mode 1</b>: CPOL=0, CPHA=1<ul>
<li>CPOL=0: The clock is idle when low</li>
<li>CPHA=1: Data is sampled on the trailing edge (falling edge) of the clock pulse and shifted out on the leading edge (rising edge) of the next cycle clock pulse</li>
</ul>
</li>
<li><b>Mode 2</b>: CPOL=1, CPHA=0<ul>
<li>CPOL=1: The clock is idle when high</li>
<li>CPHA=0: Data is sampled on the leading edge (falling edge) of the clock pulse and shifted out on the trailing edge (rising edge) of the clock pulse</li>
</ul>
</li>
<li><b>Mode 3</b>: CPOL=1, CPHA=1<ul>
<li>CPOL=1: The clock is idle when high</li>
<li>CPHA=1: Data is sampled on the trailing edge (rising edge) of the clock pulse and shifted out on the leading edge (falling edge) of the next cycle clock pulse <div class="image">
<img src="../../spi_mode_introduction.png" alt=""/>
<div class="caption">
Figure 1-2. SPI Mode Introduction.</div></div>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="doc_perihperals_amba_spi"></a>
2 Ambarella SPI</h1>
<p >CV2x chips provide four SPI masters, provding up to fourteen devices in total, and one decicated slave. While, CV5x chips provide six SPI masters, providing up to sixteen devices in total, and one decicated slave. The SPI interface provides interrupt capability, various transfer modes, and serial master operations. They both provide Motorola interface capability.<br  />
 This chapter describes the setup process of the SPI master and slave on Ambarella systems on chip (SoCs). An Ambarella SoC and one microcontroller unit (MCU) are used for this demo case. The user can also use two Ambarella SoCs to perform such a test by directly connecting their SPI interfaces.</p>
<h2><a class="anchor" id="doc_perihperals_spi_master_setup"></a>
2.1 SPI Master</h2>
<p >The baud rate of the SPI master can reach up to 20 MHz. The SPI master can be used to transfer data in full-duplex or half-full duplex mode. Ambarella recommends that users use the SPI mode 3 to transfer data between SPI devices, because SPI mode 3 is fully tested by Ambarella.<br  />
</p>
<p >To set up the SPI master, follow the steps below:<br  />
</p><ol type="1">
<li>Modify <code>ambarella/boards/&lt;board_name&gt;/bsp/&lt;board_name&gt;.dts</code> to enable the SPI master.<br  />
 Use cv25_bigeye for example: <div class="fragment"><div class="line">spi3: spi@e0014000 {</div>
<div class="line">  status = <span class="stringliteral">&quot;ok&quot;</span>;</div>
<div class="line">  cs-gpios = &lt;&amp;gpio 16 0&gt;;</div>
<div class="line"> </div>
<div class="line">  spidev@0 {</div>
<div class="line">    compatible = <span class="stringliteral">&quot;ambarella,spidev&quot;</span>;</div>
<div class="line">    reg = &lt;0&gt;;</div>
<div class="line">    spi-max-frequency = &lt;20000000&gt;;</div>
<div class="line">    spi-cpha;</div>
<div class="line">    spi-cpol;</div>
<div class="line">  };</div>
<div class="line">};</div>
</div><!-- fragment --></li>
<li><p class="startli">Add Ambarella SPI driver support in the kernel.</p>
<dl class="section user"><dt>For CV2x SDK 3.0 Amba Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    [*] SPI support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Controller</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Slave Controller</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper Amba and Yocto Build:</dt><dd><div class="fragment"><div class="line">build $ make linux_menuconfig</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    [*] SPI support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Controller</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Slave Controller</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Add the SPI test application into the root file system (Rootfs). <dl class="section user"><dt>For CV2x SDK 3.0 Amba Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">    [*]   Ambarella Public Linux Unit test configs  ---&gt;</div>
<div class="line">      [*]   Build Ambarella Public Linux Misc unit tests</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper Amba Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  unit_test ---&gt;</div>
<div class="line">    linux ---&gt;</div>
<div class="line">      [*] mistools (unit_test/linux/misc)</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>For Cooper Yocto Build:</dt><dd><div class="fragment"><div class="line">build $ make menuconfig</div>
<div class="line">  meta-ambaapp ---&gt;</div>
<div class="line">    recipes-linuxtest ---&gt;</div>
<div class="line">      [*] mistools (meta-ambaapp/recipes-linuxtest/misctools)</div>
</div><!-- fragment --></dd></dl>
</li>
<li><p class="startli">Perform the SPI master test.</p><ul>
<li>Run the SPI slave test application first on the MCU side. <div class="fragment"><div class="line">MCU # spi_slave_transfer_data 64</div>
<div class="line">fill data [64] cheksum: 0x7a1</div>
<div class="line">frame <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a03c83e0884e2e3a1783db79f2d67101f">length</a>: 64</div>
<div class="line">Data received, loop: 1</div>
<div class="line">0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0a</div>
<div class="line">0x0b 0x0c 0x0d 0x0e 0x0f 0x10 0x11 0x12 0x13 0x14</div>
<div class="line">0x15 0x16 0x17 0x18 0x19 0x1a 0x1b 0x1c 0x1d 0x1e</div>
<div class="line">0x1f 0x20 0x21 0x22 0x23 0x24 0x25 0x26 0x27 0x28</div>
<div class="line">0x29 0x2a 0x2b 0x2c 0x2d 0x2e 0x2f 0x30 0x31 0x32</div>
<div class="line">0x33 0x34 0x35 0x36 0x37 0x38 0x39 0x3a 0x3b 0x3c</div>
<div class="line">0x3d 0x3e 0xa1 0x07</div>
<div class="ttc" id="acJSON_8h_html_a03c83e0884e2e3a1783db79f2d67101f"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a03c83e0884e2e3a1783db79f2d67101f">length</a></div><div class="ttdeci">char const int length</div></div>
</div><!-- fragment --></li>
<li>Then, load the SPI master driver and run the SPI master test application on the Ambarella SoC side. <div class="fragment"><div class="line">board # modprobe spi-ambarella</div>
<div class="line">board # test_spi -m 3 -s 12000000 -l64 -c 1 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 8 -g 106 /dev/spidev3.0</div>
<div class="line">fill data [64] cheksum: 0x7a1</div>
<div class="line">0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08</div>
<div class="line">0x09 0x0a 0x0b 0x0c 0x0d 0x0e 0x0f 0x10</div>
<div class="line">0x11 0x12 0x13 0x14 0x15 0x16 0x17 0x18</div>
<div class="line">0x19 0x1a 0x1b 0x1c 0x1d 0x1e 0x1f 0x20</div>
<div class="line">0x21 0x22 0x23 0x24 0x25 0x26 0x27 0x28</div>
<div class="line">0x29 0x2a 0x2b 0x2c 0x2d 0x2e 0x2f 0x30</div>
<div class="line">0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38</div>
<div class="line">0x39 0x3a 0x3b 0x3c 0x3d 0x3e 0xa1 0x07</div>
<div class="line">check point: [0]</div>
<div class="ttc" id="acJSON_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div></div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>When using the option <code>-g</code>, the SPI master test application can run first because it can wait for the SPI slave device to be ready to transfer data.</dd></dl>
</li>
</ol>
<h2><a class="anchor" id="doc_perihperals_spi_slave_setup"></a>
2.2 SPI Slave</h2>
<p >According to the SPI slave Linux driver designed by Ambarella, there are two main points of which users must be aware when using the SPI slave.</p>
<ul>
<li>One extra general purpose input / output (GPIO) is introduced to inform the SPI master that the SPI slave is ready and the transfer can be performed, according to the design of the SPI slave Linux driver.</li>
<li>The maximum clock frequency supported by the SPI slave is 8 MHz. The user cannot set the clock higher than 8 MHz.<br  />
</li>
</ul>
<p >The actual transmission speed primarily depends on the size of the SPI transfer buffer and the length of the data being transmitted. The longer the data being transmitted is, within certain limits, the better.<br  />
</p>
<p >To set up the SPI slave, follow the steps below:<br  />
</p><ol type="1">
<li><p class="startli">Modify <code>ambarella/boards/&lt;board_name&gt;/bsp/&lt;board_name&gt;.dts</code> to enable the SPI slave.<br  />
 Take cv25_bigeye for example: </p><div class="fragment"><div class="line">spi_slave@e0010000 {</div>
<div class="line">  status = <span class="stringliteral">&quot;ok&quot;</span>;</div>
<div class="line">  notify-gpio = &lt;&amp;gpio 106 0x1&gt;;</div>
<div class="line">  amb,dma-buf-size = &lt;2048&gt;;</div>
<div class="line">};</div>
<div class="line">spi3: spi@e0014000 {</div>
<div class="line">  status = <span class="stringliteral">&quot;disabled&quot;</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The <code>spi3</code> above should be disabled, because <code>spi3</code> and <code>spi slave</code> share the same interfaces according to the cv25_bigeye schematic diagram.</dd></dl>
</li>
<li>Add Ambarella SPI slave driver support in the kernel. <div class="fragment"><div class="line">For CV2x SDK 3.0 Amba Build:</div>
<div class="line">build $ make menuconfig_public_linux</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    [*] SPI support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Slave Controller</div>
</div><!-- fragment --> <div class="fragment"><div class="line">For Cooper Amba Build:</div>
<div class="line">build $ make linux_menuconfig</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    [*] SPI support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Slave Controller</div>
</div><!-- fragment --> <div class="fragment"><div class="line">For Cooper Yocto Build:</div>
<div class="line">build $ make linux_menuconfig</div>
<div class="line">  Device Drivers  ---&gt;</div>
<div class="line">    [*] SPI support  ---&gt;</div>
<div class="line">      &lt;M&gt;   Ambarella SPI Slave Controller</div>
</div><!-- fragment --></li>
<li>Add the SPI test application into Rootfs.<br  />
 The SPI slave shares the same test application with the SPI master. <div class="fragment"><div class="line">For CV2x SDK 3.0 Amba Build:</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  [*] Ambarella Unit Test Configuration  ---&gt;</div>
<div class="line">    [*]   Ambarella Public Linux Unit test configs  ---&gt;</div>
<div class="line">      [*]   Build Ambarella Public Linux Misc unit tests</div>
</div><!-- fragment --> <div class="fragment"><div class="line">For Cooper Amba Build:</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  unit_test ---&gt;</div>
<div class="line">    linux ---&gt;</div>
<div class="line">      [*] mistools (unit_test/linux/misc)</div>
</div><!-- fragment --> <div class="fragment"><div class="line">For Cooper Yocto Build:</div>
<div class="line">build $ make menuconfig</div>
<div class="line">  meta-ambaapp ---&gt;</div>
<div class="line">    recipes-linuxtest ---&gt;</div>
<div class="line">      [*] mistools (meta-ambaapp/recipes-linuxtest/misctools)</div>
</div><!-- fragment --></li>
<li><p class="startli">Perform the SPI slave test.</p><ul>
<li>Configure the SPI master to be triggered by the <code>notify-gpio</code> rising edge on the MCU side.<br  />
 MCU setup is not described in detail in this document.<br  />
 By detecting the <code>notify-gpio</code> rising edge, the MCU SPI master will start the transfer automatically whenever the SPI slave is ready. <div class="fragment"><div class="line">MCU # spi_transfer_len 64</div>
<div class="line">fill data [64] cheksum: 0x7a1</div>
<div class="line"> </div>
<div class="line">received len: 64</div>
<div class="line">01 02 03 04 05 06 07 08 09 0a</div>
<div class="line">0<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 0c 0d 0e 0f 10 11 12 13 14</div>
<div class="line">15 16 17 18 19 1a 1<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 1c 1d 1e</div>
<div class="line">1f 20 21 22 23 24 25 26 27 28</div>
<div class="line">29 2a 2<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 2c 2d 2e 2f 30 31 32</div>
<div class="line">33 34 35 36 37 38 39 3a 3<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 3c</div>
<div class="line">3d 3e a1 07</div>
</div><!-- fragment --></li>
<li>Load the SPI slave driver and run the SPI slave test application on the Ambarella SoC side. <div class="fragment"><div class="line">board # modprobe spi-slave-ambarella</div>
<div class="line">[   49.913929] ambarella-spi-slave e0010000.spi_slave: probed</div>
<div class="line">board # test_spi -m 3 -l 64 -c 1 -s 8000000 -<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a> 8 /dev/slavespi</div>
<div class="line">fill data [64] cheksum: 0x7a1</div>
<div class="line">0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08</div>
<div class="line">0x09 0x0a 0x0b 0x0c 0x0d 0x0e 0x0f 0x10</div>
<div class="line">0x11 0x12 0x13 0x14 0x15 0x16 0x17 0x18</div>
<div class="line">0x19 0x1a 0x1b 0x1c 0x1d 0x1e 0x1f 0x20</div>
<div class="line">0x21 0x22 0x23 0x24 0x25 0x26 0x27 0x28</div>
<div class="line">0x29 0x2a 0x2b 0x2c 0x2d 0x2e 0x2f 0x30</div>
<div class="line">0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38</div>
<div class="line">0x39 0x3a 0x3b 0x3c 0x3d 0x3e 0xa1 0x07</div>
<div class="line">check point: [0]</div>
</div><!-- fragment --></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The example above is a demo case. Users can run the SPI slave test application first, and then run the SPI master test application according to their demands. </dd></dl>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
