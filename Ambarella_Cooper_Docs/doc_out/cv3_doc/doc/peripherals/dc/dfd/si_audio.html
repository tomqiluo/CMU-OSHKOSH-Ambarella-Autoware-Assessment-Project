<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Peripherals: Audio</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Peripherals"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-ambarella.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Ambarella.png"/></td>
  <td id="projectalign">
   <div id="projectname">Peripherals<span id="projectnumber">&#160;Cooper_1.6.0 (CV72 &amp; CV3) @ 2024.07.10 14:12:44</span>
   </div>
   <div id="projectbrief">placeholder</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/dfd/si_audio.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Audio </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="audio_arch"></a>
1. Audio Architecture</h1>
<h2><a class="anchor" id="audio_codec_block_diagram"></a>
1.1 Audio Codec Block Diagram</h2>
<p >CV series SoC supports the external codec. The figure below shows the audio subsystem architecture for CV2 and CV22. </p><div class="image">
<img src="../../audio_codec_simple.png" alt=""/>
<div class="caption">
Figure 1-1. Audio Codec Block Diagram for CV2 and CV22</div></div>
<p >The figure below shows the audio subsystem architecture for CV25, CV5, CV52, CV72 and CV3. </p><div class="image">
<img src="../../audio_codec_complex.png" alt=""/>
<div class="caption">
Figure 1-2. Audio Codec Block Diagram for CV25 / CV5x / CV72 / CV3</div></div>
<h2><a class="anchor" id="si_alsa_architecture"></a>
1.2 Advanced Linux Sound Architecture (ALSA)</h2>
<p >The CV series SoC audio function is implemented through the ALSA architecture. Visit <a href="http://www.alsa-project.org">http://www.alsa-project.org</a> for information about ALSA. </p><div class="image">
<img src="../../audio_alsa_architecture.png" alt=""/>
<div class="caption">
Figure 1-3. ALSA Architecture</div></div>
<p >The figure above describes the general software architecture for the audio. The ALSA driver has been implemented by Ambarella, while the ALSA core and ALSA library are provided by the ALSA open source project. This enables flexibility for developers to implement applications following the pipeline. </p><dl class="section note"><dt>Note</dt><dd>Currently, the Ambarella ALSA driver exclusively supports 16-bit PCM raw data. However, it can encode or decode operations in customized applications to support AAC or different audio encoding formats. <code>test_audio</code> provides an example on how to use the ALSA driver.</dd></dl>
<h2><a class="anchor" id="aplay_arecord"></a>
1.3 aplay / arecord</h2>
<p ><code>"arecord / aplay"</code> are ALSA utility tools for controlling the sound card, it belongs to GNU general public license version 2 (GPLv2).</p>
<ol type="1">
<li>arecord / aplay: Description<ul>
<li>arecord is a command-line soundfile recorder for the ALSA soundcard driver. It supports several file formats.</li>
<li>aplay is similar to arecord, but it plays instead of recording. For the supported soundfile formats, the sampling rate, bit depth, and other details can be automatically determined from the soundfile header.</li>
</ul>
</li>
<li>arecord / aplay: Usage<ul>
<li>Prepare the hardware. Read the hardware design schematics to verify that the audio jumpers have been configured correctly on the platform.</li>
<li><p class="startli">Compile ALSA-Lib and ALSA-Utils, and then load the audio ALSA driver. For details on how to compile ALSA, refer to <a class="el" href="../../dc/dfd/si_audio.html#install_alsa_dri_ver">2.1 Install ALSA Driver</a>.</p>
<p class="startli">The audio ALSA driver will be loaded automatically by a script when the platform has been booted. The script is named <code>S13load-private-driver</code>, and it is located in <code>ambarella/boards/cvx_board/rootfs/default/etc/init.d/S13load-private-driver</code>. It can be modified per user requirements. After the platform boots up, type <code>"lsmod | grep snd_soc"</code> to check whether <code>snd_soc_ak4951_amb</code> exists. If it does not exist, use: </p><div class="fragment"><div class="line">board # modprobe snd_soc_ak4951_amb</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Set the codec controller.<ul>
<li>Use the alsamixer to set the codec controller.</li>
<li>Type <code>alsamixer</code> and then <code>"S"</code> to select the sound card. <div class="image">
<img src="../../audio_sound_card_selection.png" alt=""/>
<div class="caption">
Figure 1-4. Sound Card Selection</div></div>
</li>
<li>Press <b>Left</b> or <b>Right</b> Key to select the Item and <b>Up</b> or <b>Down</b> Key to select the value. <div class="image">
<img src="../../audio_select_the_value_of_card_selection.png" alt=""/>
<div class="caption">
Figure 1-5. Select the Value of Card Selection</div></div>
</li>
<li>Press <b>"ESC"</b> to save and exit.</li>
<li>Run <code>arecord / aplay</code> <div class="fragment"><div class="line">board # arecord -f dat -t wav test.wav</div>
<div class="line">board # aplay -f dat test.wav</div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<hr  />
<h1><a class="anchor" id="audio_alsa"></a>
2. ALSA Library</h1>
<p >This section introduces how to use and configure ALSA in Linux, and explains ALSA basic concepts such as development methods for the audio application. The ALSA provides audio functionality to the Linux operating system. ALSA has the following significant features:</p><ul>
<li>Modularized sound drivers.</li>
<li>SMP and thread-safe design.</li>
<li>User space library (alsa-lib) to simplify application programming and provide a higher level functionality.</li>
<li>Support for the older open sound system (OSS) API, providing binary compatibility for most OSS programs. ALSA comes with a kernel API and a library API. Application programmers should use the library API rather than the kernel API. The library offers 100% of the functionality of the kernel API, but adds major improvements in usability, improving the application code.</li>
</ul>
<h2><a class="anchor" id="install_alsa_dri_ver"></a>
2.1 Install ALSA Driver</h2>
<ol type="1">
<li>Install ALSA driver: Install alsa-utils All <b>alsa-utils</b> require the <b>ncurse library</b>. Configuring without the <b>ncurse library</b> will cause the system failure.<ul>
<li>To cross-compile the ncurse library: <div class="fragment"><div class="line">build $ CC=arm-linux-gcc ./configure --build=i686-linux --host=arm-linux --prefix=/tmp/ncurse;</div>
<div class="line">make;</div>
<div class="line">make install</div>
</div><!-- fragment --> <b>ncurse library</b> can be found in <code>/tmp/ncurse</code>.</li>
<li>Download <b>alsa-utils-1.0.26.tar.bz2</b> from the site www.alsa-project.org.</li>
<li>Compile and install alsa-utils (see below): <div class="fragment"><div class="line">build $ CC=arm-linux-gcc; LDFLAGS+=<span class="stringliteral">&quot;-L/tmp/ncurse/lib -lpthread -lm -lc&quot;</span>;</div>
<div class="line">CFLAGS+=<span class="stringliteral">&quot;-I/tmp/ncurse/include -I/tmp/ncurse/include/ncurses&quot;</span>;</div>
<div class="line">./configure --build=i686-linux --host=arm-linux --prefix=/tmp/alsa/utils</div>
<div class="line">--with-alsa-prefix=/tmp/alsa-lib/lib --with-alsa-inc-prefix=/tmp/alsa-lib/include;</div>
<div class="line">make; make install</div>
</div><!-- fragment --> The <b>alsa-utils</b> is in <code>/tmp/alsa/utils</code>. <dl class="section note"><dt>Note</dt><dd>The alsa-utils will be built as a dynamic library by default. To build the alsa-utils as static binaries, remove the dynamic library (<code>/tmp/alsa-lib/lib/libasound.so*</code>).<br  />
</dd></dl>
</li>
</ul>
</li>
<li>Install the ALSA Driver: Test the Hardware and the ALSA Driver<ul>
<li>Boot the platform with the Linux kernel support.</li>
<li>Make the node for PCM capture and playback. <div class="fragment"><div class="line">board # mkdir -p /dev/snd</div>
<div class="line">board # mknod /dev/snd/controlC0 c 116 0</div>
<div class="line">board # mknod /dev/snd/pcmC0D0c c 116 24</div>
<div class="line">board # mknod /dev/snd/pcmC0D0p c 116 16</div>
</div><!-- fragment --></li>
<li>Copy <code>*.conf</code> files needed by alsa-utils to <code>/usr/share/alsa</code> on the platform.<br  />
 The <code>*.conf</code> files are created and installed after installing <code>alsa-lib</code> and placed in the directory indicated by <code>--with-configdir</code> option.<br  />
 <b>alsa-utils</b> just need 3 <code>*.conf</code> files, which are <code>alsa.conf, cards/aliases.conf and pcm/default.conf.</code></li>
<li><b>aplay</b> and <b>arecord</b> are provided in alsa-utils. <b>Arecord</b> is a link to <b>aplay</b> and used to capture sound.<br  />
 For capture: <div class="fragment"><div class="line">board # arecord -fdat test.wav</div>
<div class="line">board # arecord -vv -r 8000 -c 2 -f mu_law -t au test.au</div>
<div class="line">board # arecord -vv -r 8000 0c -f a_law -t <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a> test.raw</div>
<div class="ttc" id="acJSON_8h_html_a788db922597cf2fb6389e278f822e59f"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a788db922597cf2fb6389e278f822e59f">raw</a></div><div class="ttdeci">const char *const const char *const raw</div></div>
</div><!-- fragment --> For playback: (A-law needs to specify the format). <div class="fragment"><div class="line">board # aplay –vv test.au</div>
</div><!-- fragment --></li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="develop_alsa_applications"></a>
2.2 Develop ALSA Applications</h2>
<p >This section introduces basic concepts and guidelines for developing the audio application using ALSA and does not provide a complete reference manual for the <b>alsa-lib</b> API.<br  />
 Most of the contents mentioned in this section can also be found in www.alsa-project.org.</p>
<p ><b>Reference Documents:</b></p><ul>
<li>ALSA-lib API document: <a href="http://www.alsa-project.org/alsa-doc/alsa-lib">http://www.alsa-project.org/alsa-doc/alsa-lib</a></li>
<li>A tutorial on using the ALSA Audio API: <a href="http://equalarea.com/paul/alsa-audio.html">http://equalarea.com/paul/alsa-audio.html</a></li>
<li>ALSA 0.9.0 HOW TO: <a href="http://www.suse.de/~mana/alsa090_howto.html">http://www.suse.de/~mana/alsa090_howto.html</a><br  />
 <b>Reference Code:</b> <code>play.c, latency.c, pcm.c, pcm_min.c</code></li>
</ul>
<p ><b>Basic Concepts</b></p><ul>
<li><b>Capture:</b> Receiving data from the outside world (which is different from <b>arecord</b>, as it implies data storage). It is not part of the ALSA APIs.</li>
<li><b>Playback:</b> Delivering data to the outside world, presumably, though unnecessarily, it can be heard.</li>
<li><b>Duplex:</b> Duplex shows a situation when the capture and playback can occur simultaneously on the same interface.</li>
<li><b>PCM:</b> Pulse code modulation (PCM) describes a method that represents an analog signal in a digital form. It is used by all computer audio interfaces, and in the ALSA API as a shorthand for "audio".</li>
<li><b>Channel:</b> 1 for mono, 2 for stereo.</li>
<li><b>Sample:</b> A single value refers to the amplitude of the audio signal at a single point in time on a single channel.</li>
<li><b>Frame:</b> When working with the digital audio, users often discuss the data that represents all channels at a single point in time. This is a collection of samples, one per channel, and is generally called a frame. In other words, a frame = sample * channel.</li>
<li><b>Sample format:</b> This indicates the sample format used to transfer data to or from the interface. It may or may not correspond with a format directly supported by the hardware.</li>
<li><b>Rate:</b> For fully digital interfaces, the rate indicates the speed of the clock that is used to move digital audio data to or from the outside world.</li>
<li><b>Interleaved:</b> A data layout arrangement, samples of each channel is played at the same time so that they can follow each other sequentially. See the following section: non-interleaved.</li>
<li><b>Non-interleaved:</b> A data layout where the samples for a single channel follow each other sequentially; samples for another channel are either in another buffer or another part of this buffer. In contrast with the interleaved concept, it responds with a format supported by the hardware.</li>
<li><b>Chunk size:</b> The number of frames used when transferring data to / from the device hardware buffer.</li>
<li><b>Chunk byte:</b> Chunk byte = chunk size * channel.</li>
<li><b>Period:</b> The number of frames processed every time.</li>
<li><b>Buffer size:</b> The size of buffer used to store the sound data per period.</li>
</ul>
<dl class="section user"><dt>ALSA Architecture</dt><dd>Application developers should focus more on the application logic and less on the implementation of the ALSA core and ALSA driver. Furthermore, developers must use the API functions in the ALSA-lib to achieve native ALSA support for applications.</dd></dl>
<p>The <b>ALSA-lib</b> documentation tutorial is a valuable developer reference to the available functions.<br  />
 A typical audio application uses the following routine: </p><div class="fragment"><div class="line">open_the_device();</div>
<div class="line">set_the_parameters_of_the_device();</div>
<div class="line"><span class="keywordflow">while</span> (!done) {</div>
<div class="line">    receive_audio_data_from_the_device();</div>
<div class="line">    deliver_audio_data_to_the_device();</div>
<div class="line">    }</div>
<div class="line">close the device</div>
</div><!-- fragment --><ol type="1">
<li><p class="startli">Open the device<br  />
 The currently designed interfaces are listed below:</p><ul>
<li>Information interface (<code>/proc/asound</code>)</li>
<li>Control interface (<code>/dev/snd/controlC0</code>)</li>
<li>PCM capture interface (<code>/dev/snd/pcmC0D0c</code>)</li>
<li>PCM playback interface (<code>/dev/snd/pcmC0D0p</code>)</li>
</ul>
<p class="startli">ALSA does not directly operate with the interfaces listed above; the most important ALSA interfaces to the PCM devices are the default, plughw: 0, 0 and HW: 0, 0 interface.<br  />
 Only HW: 0, 0 will interact with the <code>/dev/snd/controlC0, /dev/snd/pcmC0D0c,</code> and <code>/dev/snd/pcmC0D0p</code>, because HW: 0, 0 is the lowest layer interface. However, plughw: 0, 0 and default only interacts with HW: 0, 0.<br  />
 If the plughw or default interface is used, the sound hardware is not important. If the sound device does not support the sample rate you specify, your data will be automatically converted. This also applies to the sample format, the access type, and the number of channels.<br  />
 For the hardware interface, users must check if their hardware supports the desired configuration. If the desired configuration is not supported, then the application using the hardware will fail, but the applications using plughw or default will still be successful because of its convertible capability.</p>
<dl class="section note"><dt>Note</dt><dd>The default interface fits the requirement of most applications In addition, ALSA provides many PCM plugins, e.g., <code>plugin: copy, plugin: rate, plugin: file</code> and etc. Please see <code>alsa-lib</code> API document for details. Users can use the function named <b>snd_pcm_open()</b> to open the PCM device. <div class="fragment"><div class="line">snd_pcm_t * capture;</div>
<div class="line">snd_pcm_t * playback;</div>
<div class="line">snd_pcm_open(&amp;capture,<span class="stringliteral">&quot;default&quot;</span>,SND_PCM_STREAM_CAPTURE, 0);</div>
<div class="line">snd_pcm_open(&amp;playback,<span class="stringliteral">&quot;default&quot;</span>,SND_PCM_STREAM_PLAYBACK, 0);</div>
</div><!-- fragment --> Because using one PCM handle for both playback and capture is not possible, users must configure two handles for full-duplex&ndash;the sound device can be opened in the capture mode and the playback mode simultaneously (they are independent).</dd></dl>
</li>
<li><p class="startli">Set Parameters<br  />
 Users must correctly set the parameters before writing / reading PCM data to / from the sound device.<br  />
 Parameters are as follows:</p><ul>
<li>Access type</li>
<li>Sample format</li>
<li>Sample rate</li>
<li>Number of channels</li>
<li>Number of periods</li>
<li>Period size</li>
</ul>
<p class="startli">Allocate the hardware parameter structure: </p><div class="fragment"><div class="line">snd_pcm_hw_params_t *hwparams_c;</div>
<div class="line">snd_pcm_hw_params_alloca(&amp;hwparams_c);</div>
<div class="line">snd_pcm_hw_params_t *hwparams_p;</div>
<div class="line">snd_pcm_hw_params_alloca(&amp;hwparams_p);</div>
</div><!-- fragment --><p> Initialize the hardware parameter structure with the full configuration space of the soundcard: </p><div class="fragment"><div class="line">snd_pcm_hw_params_any(capture, hwparams_c);</div>
<div class="line">snd_pcm_hw_params_any(playback, hwparams_p);</div>
</div><!-- fragment --><p> Restrict the configuration space to a certain configuration with a set of functions named as follows: </p><div class="fragment"><div class="line">snd_pcm_hw_params_set_&lt;parameter&gt;(capture, hwparams_c, …);</div>
<div class="line">snd_pcm_hw_params_set_&lt;parameter&gt;(playback, hwparams_p, …);</div>
</div><!-- fragment --><p> If the hardware interface is used, calls to these functions may fail if the sound device does not support the parameters you specify.<br  />
 Apply the configuration to the PCM device pointed to by capture or playback. This will also prepare the PCM device. </p><div class="fragment"><div class="line">snd_pcm_hw_params(capture, hwparams_c);</div>
<div class="line">snd_pcm_hw_params(playback, hwparams_p);</div>
</div><!-- fragment --></li>
<li>Read / Write Sound Data For the interleaved access type: <div class="fragment"><div class="line">snd_pcm_readi(capture, data_c, num_frames_c);</div>
<div class="line">snd_pcm_writei(playback, data_p, num_frames_p);</div>
</div><!-- fragment --> For the non-interleaved access type, <div class="fragment"><div class="line">snd_pcm_readn(capture, data_c, num_frames_c);</div>
<div class="line">snd_pcm_writen(playback, data_p, num_frames_p);</div>
</div><!-- fragment --> Xrun (underrun / overrun):<br  />
 After the audio interface begins, it continues running until it is instructed to stop. It will continue to generate data for the computer to use and / or send data from the computer to the outside world. The reasons listed below explain why the user’s program might not keep up with it.<br  />
 For playback, this can lead to a situation where the interface requires new data from the computer; however, because no new data exists, the interface uses old data left in the hardware buffer. This is called an "underrun".<br  />
 For capture, the interface may have data to deliver to the computer, but nowhere to store it, so it has to overwrite part of the hardware buffer that contains data the computer has not received. This is called an "overrun".<br  />
 For simplicity, ALSA uses the term "xrun" to refer to either of these conditions (underrun or overrun).<br  />
 If xrun occurs, the following function should be called: <div class="fragment"><div class="line">snd_pcm_prepare(capture);</div>
<div class="line">snd_pcm_prepare(playback);</div>
</div><!-- fragment --></li>
</ol>
<hr  />
<h1><a class="anchor" id="audio_aac_enc"></a>
3. AAC Encode Library</h1>
<p >snd_pcm_prepare(capture); snd_pcm_prepare(playback);</p>
<h2><a class="anchor" id="data_structure"></a>
3.1 Data Structure</h2>
<p >This section includes <code>aac_audio_enc.h</code>. Do not change the parameter order.</p>
<ul>
<li><b>Structure name</b>: <code>au_aacenc_config_s</code> <a class="anchor" id="table_vsrc_lua"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th><div style="width:240px"><b>Parameter</b></div> </th><th><div style="width:240px"><b>Description</b></div> </th></tr>
<tr>
<td>u32 sample_freq </td><td>Specifies the sampling rate </td></tr>
<tr>
<td>u32 coreSampleRate </td><td>Specifies the sampling rate for AAC+ </td></tr>
<tr>
<td>s32 Src_numCh </td><td>Specifies the input channel number </td></tr>
<tr>
<td>s32 Out_numCh </td><td>Specifies the output channel number </td></tr>
<tr>
<td>u32 bitRate </td><td>Specifies the bitrate of encoding bitstream </td></tr>
<tr>
<td>u8 ena_adjbr </td><td>Specifies the adjusting bitrate mode </td></tr>
<tr>
<td>u32 adj_bitRate </td><td>Specifies the adjusting bitrate when encoding </td></tr>
<tr>
<td>u32 quantizerQuality </td><td>Specifies the quantizer quality </td></tr>
<tr>
<td>u32 tns </td><td>Specifies the TNS function on/off </td></tr>
<tr>
<td>s8 ffType </td><td>Specifies the file format (ADTS, ADIF, LOAS, RAW) </td></tr>
<tr>
<td>s32 enc_mode </td><td>Specifies the encode mode (AAC, AAC+, AAC++) </td></tr>
<tr>
<td>u32 frameCounter </td><td>Specifies the encode frame counter </td></tr>
<tr>
<td>u32 ErrorStatus </td><td>Specifies the error status of encode </td></tr>
<tr>
<td>u32 nBitsInRawDataBlock </td><td>Specifies the all bit number of encoding a frame </td></tr>
<tr>
<td>u8* enc_wptr </td><td>Specifies the write pointer of output bit stream </td></tr>
<tr>
<td>s32* enc_rptr </td><td>Specifies the read pointer of input source data </td></tr>
<tr>
<td>u32* codec_lib_mem_adr </td><td>Specifies the address of library working memory </td></tr>
<tr>
<td>audio_lib_info_t lib_info </td><td>Specifies the SVN revision of audio library </td></tr>
<tr>
<td>u32 calibre_proc_on </td><td>Specifies the calibration process on/off </td></tr>
<tr>
<td>u32 calibre_proc_mode </td><td>Specifies the calibration process mode </td></tr>
<tr>
<td>u32 calibre_apply </td><td>Specifies the calibration apply on/off </td></tr>
<tr>
<td>s8* calibre_curve_addr </td><td>Specifies the address of calibration curve </td></tr>
</table>
<br  />
</li>
<li><p class="startli">Parameter values - sample_freq Supported options: </p><div class="fragment"><div class="line"><span class="preprocessor">#define AUDIO_FS_48000 48000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_44100 44100</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_32000 32000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_24000 24000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_22050 22050</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_16000 16000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_12000 12000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_11025 11025</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_8000 8000</span></div>
</div><!-- fragment --><p class="startli">Limitation: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (enc_mode == AACPLAIN)</div>
<div class="line"><span class="comment">// support all sample_freq (48000, 44100, 32000, 24000, 22050,</span></div>
<div class="line"><span class="comment">// 16000, 12000, 11025, 8000) else if (enc_mode == AACPLUS || enc_mode == AACPLUS_PS)</span></div>
<div class="line"><span class="comment">// only support sample_freq (32000, 44100, 48000)</span></div>
</div><!-- fragment --><p class="startli">Example:<br  />
 If the input audio signal source is 48 KHz, the parameter is set as follows. </p><div class="fragment"><div class="line">sample_freq = define AUDIO_FS_48000;</div>
</div><!-- fragment --></li>
<li>Parameter values - coreSampleRate<br  />
 Supported options:<br  />
 Obsolete, this parameter is automatically set by <code>sample_freq</code> and <code>enc_mode</code>.</li>
<li>Parameter values - Src_numCh<br  />
 Supported options: <div class="fragment"><div class="line"><span class="preprocessor">#define AUDIO_MONO 1</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_STEREO 2</span></div>
</div><!-- fragment --> Example: If the input audio source is stereo, the parameter is set as follows. <div class="fragment"><div class="line">Src_numCh = AUDIO_STEREO;</div>
</div><!-- fragment --></li>
<li>Parameter values - Out_numCh<br  />
 Supported options:<br  />
 Obsolete, this parameter is auto-set by <code>Src_numCh</code> and <code>enc_mode</code>.</li>
<li>Parameter values - BitRate<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keywordflow">if</span> (enc_mode == AACPLAIN ) {</div>
<div class="line"><span class="keywordflow">if</span> (sample_freq == 32000 || sample_freq == 44100 || sample_freq == 48000) {</div>
<div class="line">min.bitRate = numChannels * 16000;</div>
<div class="line">max.bitRate = numChannels * 160000;</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sample_freq == 16000 || sample_freq == 22050 || sample_freq == 24000)</div>
<div class="line">{</div>
<div class="line">min.bitRate = numChannels * 16000;</div>
<div class="line">max.bitRate = numChannels * 80000;</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sample_freq == 11025 || sample_freq == 12000) {</div>
<div class="line">min.bitRate = numChannels * 8000;</div>
<div class="line">max.bitRate = numChannels * 40000;</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sample_freq == 8000 ) {</div>
<div class="line">min.bitRate = numChannels * 8000;</div>
<div class="line">max.bitRate = numChannels * 12000;</div>
<div class="line">}</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enc_mode == AACPLUS) {</div>
<div class="line">min.bitRate = numChannels * 14000;</div>
<div class="line">max.bitRate = numChannels * 64000;</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enc_mode == AACPLUS_PS) {</div>
<div class="line">min.bitRate = 16000;</div>
<div class="line">max.bitRate = 64000;</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Parameter values - ena_adjbr<br  />
 Support options:<br  />
 Obsolete.</li>
<li>Parameter values - adj_bitRate<br  />
 Supported options:<br  />
 The same as bitRate.<br  />
 This parameter is changeable after calling aacenc_setup function.<br  />
 Example:<br  />
 Set the initial bit rate (bitRate). Change the AAC bitrate (adj_bitRate).<br  />
 Set <code>adj_bitRate = bitRate</code> in aacenc_setup function to avoid <code>NULL</code> value.</li>
<li>Parameter values - QuantizerQuality<br  />
 Supported options:<br  />
 The parameter is related the quantizer quality, 0 (low), 1 (high), 2 (highest).<br  />
 Example:<br  />
 The highest value brings in the best encoding quality but the computation is the most complex. Recommend <code>quantizerQuanlity = 1</code>.</li>
<li>Parameter values - Tns<br  />
 Supported options:<br  />
 The parameter switches TNS on or off, 0 (Off), 1 (On).<br  />
 Example: <div class="fragment"><div class="line">tns = 1;</div>
</div><!-- fragment --></li>
<li>Parameter values - FfType<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keywordtype">char</span> AAC_BS_TYPE[4] = { <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;l&#39;</span> };</div>
<div class="line">r: RAW</div>
<div class="line">a: ADIF</div>
<div class="line">t: ADTS</div>
<div class="line">l: LOAS</div>
</div><!-- fragment --> Example:<br  />
 To obtain the raw AAC bit stream (without any MPEG defined header information), <div class="fragment"><div class="line">ffType = <span class="charliteral">&#39;r&#39;</span>;</div>
</div><!-- fragment --> For normal recording, generate the AAC bitstream with the ADTS header. <div class="fragment"><div class="line">ffType = <span class="charliteral">&#39;t&#39;</span>;</div>
</div><!-- fragment --></li>
<li>Parameter values - enc_mode<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">AACPLAIN,         <span class="comment">// aac encoding low complexity</span></div>
<div class="line">AACPLUS,          <span class="comment">// aacPlus encoding</span></div>
<div class="line">AACPLUS_SPEECH,   <span class="comment">// Not supported</span></div>
<div class="line">AACPLUS_PS,       <span class="comment">// aacPlus encoding with parametric stereo</span></div>
<div class="line">AACPLUS_SPEECH_PS <span class="comment">// Not supported</span></div>
<div class="line">} AAC_MODE;</div>
</div><!-- fragment --> Limitation:<br  />
 Currently, only <code>AACPLAIN, AACPLUS</code> and <code>AACPLUS_PS</code> are supported.<br  />
 Example:<br  />
 Encode the input audio source to the plain AAC. <div class="fragment"><div class="line">enc_mode = AACPLAIN;</div>
</div><!-- fragment --></li>
<li>Parameter values - FrameCounter<br  />
 Obsolete.</li>
<li>Parameter values - ErrorStatus<br  />
 Supported options:<br  />
 The upper layer must check the ErrorStatus when it calls the AAC encode APIs. <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">ENCODE_OK,                      <span class="comment">// No error</span></div>
<div class="line">ENCODE_INVALID_POINTER,         <span class="comment">// Pointer invalid</span></div>
<div class="line">ENCODE_FAILED,                  <span class="comment">// Encoding failed</span></div>
<div class="line">ENCODE_UNSUPPORTED_SAMPLE_RATE, <span class="comment">// Given sample rate not supported</span></div>
<div class="line">ENCODE_UNSUPPORTED_CH_CFG,      <span class="comment">// Given channel not supported</span></div>
<div class="line">ENCODE_UNSUPPORTED_BIT_RATE,    <span class="comment">// Given bitrate not supported</span></div>
<div class="line">ENCODE_UNSUPPORTED_MODE         <span class="comment">// Given mode not supported</span></div>
<div class="line">} AACPLUS_ERROR;</div>
</div><!-- fragment --></li>
<li>Parameter values - NBitsInRawDataBlock<br  />
 Supported options:<br  />
 This parameter records all the bit numbers that go into encoding a frame.</li>
<li>Parameter values - enc_wptr<br  />
 Supported options:<br  />
 This parameter is the write pointer of the encoding bitstream. A memory address must be assigned to this parameter.</li>
<li>Parameter values - enc_rptr<br  />
 Supported options:<br  />
 This parameter is the read pointer of the input source data. The address of the input source address must be assigned to this parameter. The source PCM format is 16 bits resolution. If the input audio source is stereo, the PCM data is interleaved. <div class="fragment"><div class="line">Stereo: L(16bit) R(16bit) L(16bit) R(16bit) ...</div>
<div class="line">Mono: L(16bit) L(16bit) L(16bit) L(16bit) ...</div>
</div><!-- fragment --></li>
<li>Parameter values - codec_lib_mem_adr<br  />
 Supported options:<br  />
 This parameter is the address of the library’s working memory. A memory address must be assigned to this parameter. The memory is at least 106K bytes.</li>
<li>Parameter values - lib_info <div class="fragment"><div class="line">calibre_proc_on</div>
<div class="line">calibre_proc_mode</div>
<div class="line">calibre_apply</div>
<div class="line">calibre_curve_addr Obsolete.</div>
<div class="line">Set calibre_proc_on = 0 and calibre_apply = 0.</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="apis"></a>
3.2 APIs</h2>
<p >For parameters, refer to <a class="el" href="../../dc/dfd/si_audio.html#audio_codec_block_diagram">1.1 Audio Codec Block Diagram</a>.</p>
<ul>
<li>aacenc_setup<br  />
 Description:<br  />
 Initialize the AAC library. Assign the AAC data control structures to the internal operation variables. Confirm that the configurations are correct.<br  />
 Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacenc_setup(au_aacenc_config_t *pau_aacenc_config)</div>
</div><!-- fragment --></li>
<li>aacenc_open<br  />
 Description:<br  />
 Allocate the memory required for the AAC encode library. This function must be called before starting the AAC encoding.<br  />
 Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacenc_encode(au_aacenc_config_t *pau_aacenc_config)</div>
</div><!-- fragment --></li>
<li>aacenc_encode<br  />
 Description:<br  />
 Performs AAC encoding. One frame audio bit stream will be generated. This function must be called after the aac_setup and aac_open.<br  />
 Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacenc_encode(au_aacenc_config_t *pau_aacenc_config)</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="sample_code"></a>
3.3 Sample Code</h2>
<p >Sample app: <code>test_aacenc.c</code><br  />
 The following is an AAC encode operation example. </p><div class="fragment"><div class="line"><span class="comment">// pseudo code</span></div>
<div class="line">au_aacenc_config_t au_aacenc_config;</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#ga0ce6887c26c1c49ad3be5710dd42bfd6">s32</a>     inputBuffer[1024*2]</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#gaed742c436da53c1080638ce6ef7d13de">u8</a>      outputBuffer[(6144/8)*2+100];</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#gaed742c436da53c1080638ce6ef7d13de">u8</a>      enc_work_buf[106000];</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Set AAC encode control parameters</span></div>
<div class="line">    au_aacenc_config.sample_freq = 48000;</div>
<div class="line">    au_aacenc_config.Src_numCh = 2;</div>
<div class="line">    au_aacenc_config.bitRate = 128000;</div>
<div class="line">    au_aacenc_config.quantizerQuality = 1;</div>
<div class="line">    au_aacenc_config.tns = 1;</div>
<div class="line">    au_aacenc_config.ffType = <span class="charliteral">&#39;t&#39;</span>;</div>
<div class="line">    au_aacenc_config.enc_mode = AACPLAIN;</div>
<div class="line">   </div>
<div class="line">    au_aacenc_config.codec_lib_mem_adr = (<a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#ga10e94b422ef0c20dcdec20d31a1f5049">u32</a>*)enc_work_buf;</div>
<div class="line">    au_aacenc_config.calibre_proc_on = 0;</div>
<div class="line">    au_aacenc_config.calibre_apply = 0;</div>
<div class="line">    aacenc_setup(&amp;au_aacenc_config);</div>
<div class="line">    aacenc_open(&amp;au_aacenc_config);</div>
<div class="line">   </div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="comment">// step 1: read source pcm data to inputBuffer</span></div>
<div class="line">        <span class="comment">// step 2: assign enc_rptr and enc_wptr</span></div>
<div class="line">        au_aacenc_config.enc_rptr = inputBuffer;</div>
<div class="line">        au_aacenc_config.enc_wptr = outputBuffer;</div>
<div class="line">       </div>
<div class="line">        <span class="comment">// step 3: AAC encode one frame</span></div>
<div class="line">        aacenc_encode(&amp;au_aacenc_config);</div>
<div class="line">       </div>
<div class="line">        encoded_byte = (au_aacenc_config-&gt;nBitsInRawDataBlock + 7) &gt;&gt; 3;</div>
<div class="line">        <span class="comment">// step 4: write output the encode bitstream byte</span></div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-typedef_html_ga0ce6887c26c1c49ad3be5710dd42bfd6"><div class="ttname"><a href="../../../driver/d0/dfa/group__iav-typedef.html#ga0ce6887c26c1c49ad3be5710dd42bfd6">s32</a></div><div class="ttdeci">signed int s32</div></div>
<div class="ttc" id="agroup__iav-typedef_html_ga10e94b422ef0c20dcdec20d31a1f5049"><div class="ttname"><a href="../../../driver/d0/dfa/group__iav-typedef.html#ga10e94b422ef0c20dcdec20d31a1f5049">u32</a></div><div class="ttdeci">unsigned int u32</div></div>
<div class="ttc" id="agroup__iav-typedef_html_gaed742c436da53c1080638ce6ef7d13de"><div class="ttname"><a href="../../../driver/d0/dfa/group__iav-typedef.html#gaed742c436da53c1080638ce6ef7d13de">u8</a></div><div class="ttdeci">unsigned char u8</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="audio_aac_dec"></a>
4. AAC Decode Library</h1>
<p >This section describes the data structure and APIs of the AAC decode library.</p>
<h2><a class="anchor" id="decode_data_structure"></a>
4.1 Data Structure</h2>
<ul>
<li>Structure name：<code>au_aacdec_config_s</code> <a class="anchor" id="table_vsrc_lua"></a>
<table class="doxtable">
<caption></caption>
<tr>
<th><div style="width:240px"><b>Parameter</b></div> </th><th><div style="width:240px"><b>Description</b></div> </th></tr>
<tr>
<td>u32 sample_freq </td><td>Specifies the sample frequency </td></tr>
<tr>
<td>s8 syncState </td><td>Specifies the sync status </td></tr>
<tr>
<td>s8 channelMode </td><td>Specifies the channel mode </td></tr>
<tr>
<td>s32 bsFormat </td><td>Specifies the bitstream format (adif,adts,loas) </td></tr>
<tr>
<td>s32 streamType </td><td>Specifies the stream type </td></tr>
<tr>
<td>s32 objtype </td><td>Specifies the audio object type </td></tr>
<tr>
<td>s32 profile </td><td>Specifies the bitstream profile </td></tr>
<tr>
<td>s32 useHqSbr </td><td>Specifies the high quality SBR </td></tr>
<tr>
<td>s32 dec_mode </td><td>Specifies the decode mode (AAC, AAC+, AAC++) </td></tr>
<tr>
<td>s32 frameSize </td><td>Specifies the frame size </td></tr>
<tr>
<td>s32 Src_numCh </td><td>Specifies the input channel number </td></tr>
<tr>
<td>s32 Out_numCh </td><td>Specifies the output channel number </td></tr>
<tr>
<td>s32 averageBitrate </td><td>Specifies the average bit rate </td></tr>
<tr>
<td>s32 numberOfRawDataBlocks </td><td>Specifies the number of raw data blocks in frames </td></tr>
<tr>
<td>s32 bBitstreamDownMix </td><td>Specifies the stereo to mono down mix flag </td></tr>
<tr>
<td>s32 externalBitrate </td><td>Specifies the external bitrate for loading the input buffer </td></tr>
<tr>
<td>s32 externalSamplingRate </td><td>Specifies the external sampling rate for raw decoding </td></tr>
<tr>
<td>s32 ErrorStatus </td><td>Specifies the error status of decode process </td></tr>
<tr>
<td>s32 fs_out </td><td>Specifies the sample frequency of bitstream </td></tr>
<tr>
<td>s32 fs_out </td><td>Specifies the sample frequency of bitstream </td></tr>
<tr>
<td>s32 fs_core </td><td>Specifies the core sample frequency for AAC+ bitstream </td></tr>
<tr>
<td>s32 frameCounter </td><td>Specifies the frame counter of decode </td></tr>
<tr>
<td>s32 errorcounter </td><td>Specifies the error counter of decode </td></tr>
<tr>
<td>s32 errorcounter </td><td>Specifies the error counter of decode </td></tr>
<tr>
<td>s8 bDownSample </td><td>Specifies the down sampled SBR flag </td></tr>
<tr>
<td>u32 consumed_byte </td><td>Specifies the consumed byte of decoding one frame </td></tr>
<tr>
<td>u32 interbufsize </td><td>Specifies the internal buffer size </td></tr>
<tr>
<td>u32 interbufsize </td><td>Specifies the internal buffer size </td></tr>
<tr>
<td>s32* dec_wptr </td><td>Specifies the write pointer of output data </td></tr>
<tr>
<td>u8* dec_rptr </td><td>Specifies the read pointer of input bitstream </td></tr>
<tr>
<td>u8 has_dec_out </td><td>Specifies the decode output flag </td></tr>
<tr>
<td>u32* codec_lib_mem_adr </td><td>Specifies the address of library working memory </td></tr>
<tr>
<td>u8* codec_lib_backup_adr </td><td>Specifies the address of library backup memory </td></tr>
<tr>
<td>u16 codec_lib_backup_size </td><td>Specifies the size of library backup memory </td></tr>
<tr>
<td>u8 need_more </td><td>Specifies the need for more flags </td></tr>
<tr>
<td>audio_lib_info_t lib_info </td><td>Specifies the svn revision information of audio library </td></tr>
</table>
<br  />
</li>
<li>Parameter value - sample_freq<br  />
 Obsolete.</li>
<li>Parameter value - syncState<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">syncState_SyncWordSearch = 0, <span class="comment">// start sync search</span></div>
<div class="line">syncState_SyncWordFound, <span class="comment">// sync found, search of super frame forbidden</span></div>
<div class="line">syncState_SuperFrameSearch, <span class="comment">// sync found, search of super frame allowed</span></div>
<div class="line">syncState_SuperFrameFound, <span class="comment">// sync found, super frame found</span></div>
<div class="line">syncState_SyncFinished <span class="comment">// sync search finished</span></div>
<div class="line">} AAC_DEC_SYNC_STATUS;</div>
</div><!-- fragment --></li>
<li>Parameter value - channelMode<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">Mono=0x0,</div>
<div class="line">Stereo,</div>
<div class="line">DualMono,</div>
<div class="line">ParametricStereo,</div>
<div class="line">unkown_channel_mode = 0xf</div>
<div class="line">} AAC_DEC_Channel_Mode</div>
</div><!-- fragment --></li>
<li>Parameter value - bsFormat<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">enum</span> aac_bsformat {</div>
<div class="line">RAW_BSFORMAT = 0x0,</div>
<div class="line">ADIF_BSFORMAT,</div>
<div class="line">ADTS_BSFORMAT,</div>
<div class="line">LOAS_BSFORMAT, };</div>
</div><!-- fragment --> Example: To decode a AAC bitstream with ADTS header, <div class="fragment"><div class="line">bsFormat = ADTS_BSFORMAT.</div>
</div><!-- fragment --></li>
<li>Parameter value - streamType<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">MPEG4_BSFORMAT=0x0,</div>
<div class="line">MPEG2_BSFORMAT</div>
<div class="line">} AAC_DEC_MPEG_FMT;</div>
</div><!-- fragment --></li>
<li>Parameter value - objtype<br  />
 Supported options: Reports the audio object type for LOAS bitstream.<br  />
</li>
<li>Parameter value - profile<br  />
 Supported options: Reports the AAC profile of decoding bitstream.</li>
<li>Parameter value - useHqSbr<br  />
 Supported options: Set by the AAC decode library. This parameter is set to "1" with decoding one channel AAC+ bitstream and "0" with decoding two channel AAC+ bitstream in the library.<br  />
 1 (high quality sbr on), 0 (low power on).</li>
<li>Parameter value - dec_mode<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">AACPLAIN, <span class="comment">// aac encoding low complexity</span></div>
<div class="line">AACPLUS, <span class="comment">// aacPlus encoding</span></div>
<div class="line">AACPLUS_SPEECH, <span class="comment">// Not support</span></div>
<div class="line">AACPLUS_PS, <span class="comment">// aacPlus encoding with parametric stereo</span></div>
<div class="line">AACPLUS_SPEECH_PS <span class="comment">// Not support</span></div>
<div class="line">} AAC_MODE;</div>
</div><!-- fragment --></li>
<li>Parameter value - frameSize<br  />
 Supported options: <div class="fragment"><div class="line">1024 (AACPLAIN)</div>
<div class="line">2048 (AACPLUS or AACPLUS_PS)</div>
</div><!-- fragment --></li>
<li>Parameter value - Src_numCh<br  />
 Supported options: <div class="fragment"><div class="line">1 (MONO)</div>
<div class="line">2(STEREO)</div>
</div><!-- fragment --></li>
<li>Parameter value - Out_numCh<br  />
 Supported options: Obsolete. <div class="fragment"><div class="line">1 (MONO), 2(STEREO)</div>
</div><!-- fragment --></li>
<li>Parameter value - averageBitrate<br  />
 Supported options: Set by users with the input buffer size.</li>
<li>Parameter value - numberOfRawDataBlocks<br  />
 Supported options: Reports the number of RAW data blocks in frames.</li>
<li>Parameter value - BitstreamDownMix<br  />
 Supported options: Sets by the AAC decoder library with "0". <div class="fragment"><div class="line">1 (Stereo to mono downmix on), 0 (Stereo to mono downmix off)</div>
</div><!-- fragment --></li>
<li>Parameter value - externalBitrate<br  />
 Obsolete.</li>
<li>Parameter value - externalSamplingRate<br  />
 Supported options: <div class="fragment"><div class="line"><span class="preprocessor">#define AUDIO_FS_48000 48000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_44100 44100</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_32000 32000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_24000 24000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_22050 22050</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_16000 16000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_12000 12000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_11025 11025</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_8000 8000</span></div>
</div><!-- fragment --> Limitation: This parameter must be set if the decoding bitstream is RAW.</li>
<li>Parameter value - ErrorStatus<br  />
 Supported options: <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">AAC_DEC_OK = 0x0,</div>
<div class="line">AAC_DEC_ADTS_SYNC_ERROR = 0x1000,</div>
<div class="line">AAC_DEC_LOAS_SYNC_ERROR,</div>
<div class="line">AAC_DEC_ADTS_SYNCWORD_ERROR,</div>
<div class="line">AAC_DEC_LOAS_SYNCWORD_ERROR,</div>
<div class="line">AAC_DEC_ADIF_SYNCWORD_ERROR,</div>
<div class="line">AAC_DEC_UNSUPPORTED_FORMAT,</div>
<div class="line">AAC_DEC_DECODE_FRAME_ERROR,</div>
<div class="line">AAC_DEC_CRC_CHECK_ERROR,</div>
<div class="line">AAC_DEC_INVALID_CODE_BOOK,</div>
<div class="line">AAC_DEC_UNSUPPORTED_WINOW_SHAPE,</div>
<div class="line">AAC_DEC_PREDICTION_NOT_SUPPORTED_IN_LC_AAC,</div>
<div class="line">AAC_DEC_UNIMPLEMENTED_CCE,</div>
<div class="line">AAC_DEC_UNIMPLEMENTED_GAIN_CONTROL_DATA,</div>
<div class="line">AAC_DEC_UNIMPLEMENTED_EP_SPECIFIC_CONFIG_PARSE,</div>
<div class="line">AAC_DEC_UNIMPLEMENTED_CELP_SPECIFIC_CONFIG_PARSE,</div>
<div class="line">AAC_DEC_UNIMPLEMENTED_HVXC_SPECIFIC_CONFIG_PARSE,</div>
<div class="line">AAC_DEC_OVERWRITE_BITS_IN_INPUT_BUFFER,</div>
<div class="line">AAC_DEC_CANNOT_REACH_BUFFER_FULLNESS,</div>
<div class="line">AAC_DEC_TNS_RANGE_ERROR,</div>
<div class="line">AAC_DEC_NEED_MORE_DATA,</div>
<div class="line">AAC_DEC_INSUFFICIENT_BACKUP_MEMORY</div>
<div class="line">} AAC_DEC_Status;</div>
</div><!-- fragment --></li>
<li>Parameter value - fs_out<br  />
 Supported options: This is the same as the externalSamplingRate supported option.</li>
<li>Parameter value - fs_core<br  />
 Supported options: <div class="fragment"><div class="line"><span class="preprocessor">#define AUDIO_FS_24000 24000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_22050 22050</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_16000 16000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_12000 12000</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_11025 11025</span></div>
<div class="line"><span class="preprocessor">#define AUDIO_FS_8000 8000</span></div>
</div><!-- fragment --></li>
<li>Parameter value - frameCounter<br  />
 Supported options: Reports the frame counter.</li>
<li>Parameter value - errorcounter<br  />
 Supported options: Reports the error counter.</li>
<li>Parameter value - DownSample<br  />
 Supported options: Set by the AAC decode library with "0". <div class="fragment"><div class="line">0(downsampled sbr off), 1(downsampled sbr on)</div>
</div><!-- fragment --></li>
<li>Parameter value - consumed_byte<br  />
 Supported options: Reports the consumed byte when calling decoding APIs.</li>
<li>Parameter value - interbufsize<br  />
 Supported options: Set by users with the internal buffer size.</li>
<li>Parameter value - dec_wptr<br  />
 Supported options: This parameter is the write pointer of decoding bitstream. A memory address must be assigned to this parameter. The decoding output PCM format is 32 bits resolution. <div class="fragment"><div class="line">Stereo: L(32bit) R(32bit) L(32bit) R(32bit) ...</div>
<div class="line">Mono: L(32bit) L(32bit) L(32bit) L(32bit) ...</div>
</div><!-- fragment --></li>
<li>Parameter value - dec_rptr<br  />
 Supported options: This parameter is the read pointer of decoding bitstream. A memory address must be assigned to this parameter.</li>
<li>Parameter value - has_dec_out<br  />
 Supported options: The AAC decode library will set has_dec_out=1 when AAC decoding is successful.</li>
<li>Parameter value - codec_lib_mem_adr<br  />
 Supported options: This parameter is the address of the library’s working memory. A memory address must be assigned to this parameter. The memory is at least 106K bytes.</li>
<li>Parameter value - codec_lib_backup_adr<br  />
 Supported options: This parameter is the address of the library’s backup memory. A memory address must be assigned to this parameter. The memory is at least 252K bytes.</li>
<li>Parameter value - codec_lib_backup_size<br  />
 Supported options: This is necessary if two bitstreams are being decoded simultaneously. The backup size is at least 252K bytes.</li>
<li>Parameter value - need_more<br  />
 Supported options: The AAC decode library will report the need for more flags if the decoding buffer is not enough.</li>
<li>Parameter value - lib_info<br  />
 Obsolete.</li>
</ul>
<h2><a class="anchor" id="decode_apis"></a>
4.2 APIs</h2>
<ul>
<li>aacdec_setup<br  />
 Description:<br  />
 Initialize the AAC library. Assign the AAC decode data structures to the internal operation variables. Confirm that the configurations are correct. This function must be called as the first one. Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacdec_setup(au_aacdec_config_t *pau_aacdec_config)</div>
</div><!-- fragment --> Parameters: Please refer to Section <a class="el" href="../../dc/dfd/si_audio.html#decode_data_structure">4.1 Data Structure</a> 4.1 Data Structure.</li>
<li>aacdec_open<br  />
 Description:<br  />
 Allocate the memory required for the AAC decode library. This function must be called before starting the AAC decoding. Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacdec_open(au_aacdec_config_t *pau_aacdec_config)</div>
</div><!-- fragment --> Parameters: Please refer to Section <a class="el" href="../../dc/dfd/si_audio.html#decode_data_structure">4.1 Data Structure</a> 4.1 Data Structure.</li>
<li>aacdec_set_bitstream_rp<br  />
 Description:<br  />
 Initialize the internal bit stream buffer. This function must be called after <b>aacdec_setup</b> and <b>aacdec_open</b>. Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacdec_set_bitstream_rp(au_aacdec_config_t *pau_aacdec_config)</div>
</div><!-- fragment --> Parameters: Please refer to Section <a class="el" href="../../dc/dfd/si_audio.html#decode_data_structure">4.1 Data Structure</a> 4.1 Data Structure.</li>
<li>aacenc_decode<br  />
 Description:<br  />
 Perform AAC encoding and one frame audio sample will be generated. This function must be called after the <b>aacdec_setup, aacdec_open</b> and <b>aacdec_set_bitstream_rp</b> functions. Syntax: <div class="fragment"><div class="line"><span class="keywordtype">void</span> aacdec_decode(au_aacdec_config_t *pau_aacdec_config)</div>
</div><!-- fragment --> Parameters: Please refer to Section <a class="el" href="../../dc/dfd/si_audio.html#decode_data_structure">4.1 Data Structure</a> 4.1 Data Structure.</li>
</ul>
<h2><a class="anchor" id="decode_sample_code"></a>
4.3 Sample Code</h2>
<p >Sample app: <code>test_aacdec.c</code><br  />
 The following is an example of the AAC decode operation. </p><div class="fragment"><div class="line"><span class="comment">// pseudo code</span></div>
<div class="line">au_aacdec_config_t au_aacdec_config;</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#gaed742c436da53c1080638ce6ef7d13de">u8</a> input_Buffer[16384];</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#ga10e94b422ef0c20dcdec20d31a1f5049">u32</a> dec_work_buf[106000];</div>
<div class="line"><a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#gaed742c436da53c1080638ce6ef7d13de">u8</a> dec_backup_buf[252];</div>
<div class="line">{</div>
<div class="line"><span class="comment">// Set AAC decode control parameters</span></div>
<div class="line">au_aacdec_config.externalSamplingRate = 48000;</div>
<div class="line">au_aacdec_config.bsFormat = ADTS_BSFORMAT;</div>
<div class="line">au_aacdec_config.Out_numCh = 2;</div>
<div class="line">au_aacdec_config.externalBitrate = 0;</div>
<div class="line">au_aacdec_config.frameCounter = 0;</div>
<div class="line">au_aacdec_config.errorcounter = 0;</div>
<div class="line">au_aacdec_config.interbufsize = 0;</div>
<div class="line">au_aacdec_config.codec_lib_mem_adr = dec_work_buf;</div>
<div class="line">au_aacdec_config.codec_lib_backup_adr = dec_backup_buf;</div>
<div class="line">au_aacdec_config.codec_lib_backup_size = 0;</div>
<div class="line">au_aacdec_config.dec_rptr = input_Buffer;</div>
<div class="line"> </div>
<div class="line">aacdec_setup(&amp;au_aacdec_config);</div>
<div class="line">aacdec_open(&amp;au_aacdec_config);</div>
<div class="line"> </div>
<div class="line">aacdec_set_bitstream_rp(&amp;au_aacdec_config);</div>
<div class="line"><span class="keywordflow">do</span> {</div>
<div class="line">    <span class="comment">// step 1: read bitstream to input Buffer</span></div>
<div class="line">   </div>
<div class="line">    <span class="comment">// step 2: initialize the internal bit stream buffer</span></div>
<div class="line">    aacdec_set_bitstream_rp(&amp;au_aacdec_config);</div>
<div class="line">   </div>
<div class="line">    <span class="comment">// step 3: AAC decode one frame</span></div>
<div class="line">    aacdec_decode(&amp;au_aacdec_config);</div>
<div class="line">    <span class="keywordflow">if</span> (au_aacdec_config.ErrorStatus)</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="comment">// step 4 : write audio channels sample to pcm file</span></div>
<div class="line">    <span class="keywordflow">if</span> (au_aacdec_config.frameCounter&gt;0) {</div>
<div class="line">        fwrite(&amp;buff[0], <span class="keyword">sizeof</span>(<a class="code hl_typedefRef" href="../../../driver/d0/dfa/group__iav-typedef.html#ga5ffa4f640862b25ba6d4f635b78bdbe1">s16</a>),</div>
<div class="line">                * au_aacdec_config.frameSize * au_aacdec_config.Src_numCh,</div>
<div class="line">                pOutputFile);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">while</span> (!au_aacdec_config.ErrorStatus);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__iav-typedef_html_ga5ffa4f640862b25ba6d4f635b78bdbe1"><div class="ttname"><a href="../../../driver/d0/dfa/group__iav-typedef.html#ga5ffa4f640862b25ba6d4f635b78bdbe1">s16</a></div><div class="ttdeci">signed short s16</div></div>
</div><!-- fragment --> <hr  />
<h1><a class="anchor" id="audio_mic_sup"></a>
5. CV5x EVK with Analog and Digital MIC Support</h1>
<p >This section describes how to enable nau8810(analog MIC) and DMIC(digital MIC) on CV5x EVK board.</p>
<h2><a class="anchor" id="cv52_zr_and_cv5_Timn"></a>
5.1 CV52_Zr/CV5_Timn</h2>
<p >On CV5x EVK board, the nau8810 and DMIC cannot be enabled at the same time. By default, nau8810 is enabled. If users want to enable DMIC, they can refer to the following steps. </p><dl class="section note"><dt>Note</dt><dd>CV52_Zr board and CV5_Timn board are similar in this section.</dd></dl>
<ul>
<li>Activate the option under menuconfig_public_linux<br  />
 Users need to enable "Ambarella DMIC" in "menuconfig_public_linux" to compile it. <div class="fragment"><div class="line">build $ make menuconfig_public_linux</div>
<div class="line"> </div>
<div class="line">Device Drivers  ---&gt;</div>
<div class="line">  &lt;M&gt; Sound card support  ---&gt;</div>
<div class="line">    &lt;M&gt;   Advanced Linux Sound Architecture  ---&gt;</div>
<div class="line">      &lt;M&gt;   ALSA <span class="keywordflow">for</span> SoC audio support  ---&gt;</div>
<div class="line">        &lt;M&gt;   Select Codec <span class="keywordflow">for</span> Ambarella Platform  ---&gt;</div>
<div class="line">          &lt;M&gt;   Ambarella DMIC</div>
</div><!-- fragment --></li>
<li>Make some modifications on SDK 1.0<br  />
 <b>CV52_Zr board</b>: Modify <code>ambarella/boards/cv52_zr/bsp/cv52_zr.dts</code><br  />
 <b>CV5_Timn board</b>: Modify <code>ambarella/boards/cv5_timn/bsp/cv5_timn.dts</code><br  />
 Both modifications are the same, and CV52_Zr board is taken as an example below. <div class="fragment"><div class="line">@@ -52,17 +52,9 @@</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">sound {</div>
<div class="line">-               compatible = <span class="stringliteral">&quot;ambarella,audio-board&quot;</span>;</div>
<div class="line">-               simple-audio-card,<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a> = <span class="stringliteral">&quot;nau8810 @ AMBEVK&quot;</span>;</div>
<div class="line">+               compatible = <span class="stringliteral">&quot;simple-audio-card&quot;</span>;</div>
<div class="line">+               simple-audio-card,<a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a> = <span class="stringliteral">&quot;Direct @ AMBEVK&quot;</span>;</div>
<div class="line">                simple-audio-card,mclk-fs = &lt;256&gt;;</div>
<div class="line">-               simple-audio-card,widgets =</div>
<div class="line">-               <span class="stringliteral">&quot;Speaker&quot;</span>, <span class="stringliteral">&quot;Speaker&quot;</span>,</div>
<div class="line">-               <span class="stringliteral">&quot;Microphone&quot;</span>, <span class="stringliteral">&quot;Mic Internal&quot;</span>;</div>
<div class="line">-               simple-audio-card,routing =</div>
<div class="line">-               <span class="stringliteral">&quot;MICP&quot;</span>, <span class="stringliteral">&quot;Mic Internal&quot;</span>,</div>
<div class="line">-               <span class="stringliteral">&quot;MICN&quot;</span>, <span class="stringliteral">&quot;Mic Internal&quot;</span>,</div>
<div class="line">-               <span class="stringliteral">&quot;Speaker&quot;</span>, <span class="stringliteral">&quot;SPKOUTP&quot;</span>,</div>
<div class="line">-               <span class="stringliteral">&quot;Speaker&quot;</span>, <span class="stringliteral">&quot;SPKOUTN&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                simple-audio-card,dai-link@0 {</div>
<div class="line">                  <a class="code hl_variableRef" href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a> = <span class="stringliteral">&quot;i2s&quot;</span>;</div>
<div class="line"> </div>
<div class="line">@@ -72,7 +64,7 @@</div>
<div class="line">                        };</div>
<div class="line"> </div>
<div class="line">                        codec {</div>
<div class="line">-                               sound-dai = &lt;&amp;nau8810&gt;;</div>
<div class="line">+                               sound-dai = &lt;&amp;dmic&gt;;</div>
<div class="line">                        };</div>
<div class="line">                };</div>
<div class="line"> </div>
<div class="line">@@ -98,7 +90,7 @@</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(CONFIG_CV52_ZR_SELECT_IDC1_VSYNC)</span></div>
<div class="line">                        pinctrl-names = <span class="stringliteral">&quot;default&quot;</span>;</div>
<div class="line">-                       pinctrl-0 = &lt;&amp;vsync_dly_pins&gt;;</div>
<div class="line">+                       <span class="comment">//pinctrl-0 = &lt;&amp;vsync_dly_pins&gt;;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">                        clocks = &lt;&amp;gclk_so2&gt;;</div>
<div class="line">                };</div>
<div class="line">@@ -340,6 +332,7 @@</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">};</div>
<div class="line">&amp;i2s0 {</div>
<div class="line">+       pinctrl-0 = &lt;&amp;dmic0_pins_c&gt;;</div>
<div class="line">        status = <span class="stringliteral">&quot;ok&quot;</span>;</div>
<div class="line">};</div>
<div class="ttc" id="acJSON_8h_html_a25d22ecc7e656d2c59332072684e8766"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#a25d22ecc7e656d2c59332072684e8766">name</a></div><div class="ttdeci">const char *const name</div></div>
<div class="ttc" id="acJSON_8h_html_adb411a44855a4c49231d72a0fc9a3b3b"><div class="ttname"><a href="../../../library/d1/d82/cJSON_8h.html#adb411a44855a4c49231d72a0fc9a3b3b">format</a></div><div class="ttdeci">char const int const cJSON_bool format</div></div>
</div><!-- fragment --></li>
<li>HSYNC_DMIC_SEL pull high Set switch <b>1</b> to <b>ON</b> at DIP SW1. <div class="image">
<img src="../../DIP_SW1_diagram.jpg" alt=""/>
<div class="caption">
Figure 5-1. Diagram of DIP_SW1</div></div>
 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
